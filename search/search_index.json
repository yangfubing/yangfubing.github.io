{"config":{"lang":["ja"],"separator":"[\\s\\-\uff0c\u3002]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u4ecb\u7ecd","text":"<p>Kubernetes \u662f Google \u57fa\u4e8e Borg \u5f00\u6e90\u7684\u5bb9\u5668\u7f16\u6392\u8c03\u5ea6\u5f15\u64ce\uff0c\u4f5c\u4e3a CNCF\uff08Cloud Native Computing Foundation\uff09\u6700\u91cd\u8981\u7684\u7ec4\u4ef6\u4e4b\u4e00\uff0c\u5b83\u7684\u76ee\u6807\u4e0d\u4ec5\u4ec5\u662f\u4e00\u4e2a\u7f16\u6392\u7cfb\u7edf\uff0c\u800c\u662f\u63d0\u4f9b\u4e00\u4e2a\u89c4\u8303\uff0c\u53ef\u4ee5\u8ba9\u4f60\u6765\u63cf\u8ff0\u96c6\u7fa4\u7684\u67b6\u6784\uff0c\u5b9a\u4e49\u670d\u52a1\u7684\u6700\u7ec8\u72b6\u6001\uff0cKubernetes \u53ef\u4ee5\u5e2e\u4f60\u5c06\u7cfb\u7edf\u81ea\u52a8\u5730\u8fbe\u5230\u548c\u7ef4\u6301\u5728\u8fd9\u4e2a\u72b6\u6001\u3002Kubernetes \u4f5c\u4e3a\u4e91\u539f\u751f\u5e94\u7528\u7684\u57fa\u77f3\uff0c\u76f8\u5f53\u4e8e\u4e00\u4e2a\u4e91\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5176\u91cd\u8981\u6027\u4e0d\u8a00\u800c\u55bb\u3002</p> <p>\u5982\u679c\u5927\u5bb6\u89c9\u5f97\u90a3\u91cc\u5199\u7684\u4e0d\u5408\u9002\u7684\u53ef\u4ee5\u7ed9\u6211\u63d0 Issue</p> <p> </p>"},{"location":"#_2","title":"\u6350\u8d60","text":"<p>\u5982\u679c\u4f60\u89c9\u5f97\u8fd9\u5199\u6587\u7ae0\u80fd\u5e2e\u52a9\u5230\u4e86\u4f60\uff0c\u4f60\u53ef\u4ee5\u5e2e\u4f5c\u8005\u4e70\u4e00\u676f\u679c\u6c41\u8868\u793a\u9f13\u52b1 </p> <p>Paypal Me</p>"},{"location":"docker/basic/","title":"\u57fa\u672c\u64cd\u4f5c","text":""},{"location":"docker/basic/#_1","title":"\u57fa\u672c\u64cd\u4f5c","text":"<p>\u955c\u50cf\u548c\u5bb9\u5668\u7684\u5e38\u7528\u64cd\u4f5c</p> <p>Docker \u7684\u57fa\u672c\u539f\u7406\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u4e86\uff0c\u4e5f\u5df2\u7ecf\u5b89\u88c5\u4e0a\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u4e00\u8d77\u6765\u5b66\u4e60\u4e0b Docker \u7684\u5e38\u7528\u64cd\u4f5c\uff0c\u5b9e\u9645\u4e0a\u4e3b\u8981\u5c31\u662f Docker CLI \u7684\u4e00\u4e9b\u5e38\u7528\u547d\u4ee4\u4f7f\u7528\u3002</p> <p></p>"},{"location":"docker/basic/#_2","title":"\u955c\u50cf\u64cd\u4f5c","text":"<p>\u4e4b\u524d\u6211\u4eec\u63d0\u5230\u8fc7 Docker \u5b98\u65b9\u63d0\u4f9b\u4e86\u4e00\u4e2a\u516c\u5171\u7684\u955c\u50cf\u4ed3\u5e93\uff1aDocker Hub\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4ece\u8fd9\u4e0a\u9762\u83b7\u53d6\u955c\u50cf\uff0c\u83b7\u53d6\u955c\u50cf\u7684\u547d\u4ee4\uff1a<code>docker pull</code>\uff0c\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>$ docker pull [\u9009\u9879] [Docker Registry \u5730\u5740[:\u7aef\u53e3]/]\u4ed3\u5e93\u540d[:\u6807\u7b7e]\n</code></pre> <ul> <li>Docker \u955c\u50cf\u4ed3\u5e93\u5730\u5740\uff1a\u5730\u5740\u7684\u683c\u5f0f\u4e00\u822c\u662f <code>&lt;\u57df\u540d/IP&gt;[:\u7aef\u53e3\u53f7]</code>\uff0c\u9ed8\u8ba4\u5730\u5740\u662f Docker Hub \u5b98\u65b9\u5730\u5740\u3002</li> <li>\u4ed3\u5e93\u540d\uff1a\u8fd9\u91cc\u7684\u4ed3\u5e93\u540d\u662f\u4e24\u6bb5\u5f0f\u540d\u79f0\uff0c\u5373 <code>&lt;\u7528\u6237\u540d&gt;/&lt;\u8f6f\u4ef6\u540d&gt;</code>\u3002\u5bf9\u4e8e Docker Hub\uff0c\u5982\u679c\u4e0d\u7ed9\u51fa\u7528\u6237\u540d\uff0c\u5219\u9ed8\u8ba4\u4e3a library\uff0c\u4e5f\u5c31\u662f\u5b98\u65b9\u955c\u50cf\u3002\u6bd4\u5982\uff1a</li> </ul> <pre><code>$ docker pull ubuntu:04\n04: Pulling from library/ubuntu\n7ddbc47eeb70: Pull complete\nc1bbdc448b72: Pull complete\n8c3b70e39044: Pull complete\n45d437916d57: Pull complete\nDigest: sha256:6e9f67fa63b0323e9a1e587fd71c561ba48a034504fb804fd26fd8800039835d\nStatus: Downloaded newer image for ubuntu:04\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4e2d\u6ca1\u6709\u7ed9\u51fa Docker \u955c\u50cf\u4ed3\u5e93\u5730\u5740\uff0c\u56e0\u6b64\u5c06\u4f1a\u4ece Docker Hub \u83b7\u53d6\u955c\u50cf\u3002\u800c\u955c\u50cf\u540d\u79f0\u662f ubuntu:18.04\uff0c\u56e0\u6b64\u5c06\u4f1a\u83b7\u53d6\u5b98\u65b9\u955c\u50cf <code>library/ubuntu</code> \u4ed3\u5e93\u4e2d\u6807\u7b7e\u4e3a 18.04 \u7684\u955c\u50cf\u3002\u4ece\u4e0b\u8f7d\u8fc7\u7a0b\u4e2d\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u4e4b\u524d\u63d0\u53ca\u7684\u5206\u5c42\u5b58\u50a8\u7684\u6982\u5ff5\uff0c\u955c\u50cf\u662f\u7531\u591a\u5c42\u5b58\u50a8\u6240\u6784\u6210\u3002\u4e0b\u8f7d\u4e5f\u662f\u4e00\u5c42\u5c42\u7684\u53bb\u4e0b\u8f7d\uff0c\u5e76\u975e\u5355\u4e00\u6587\u4ef6\u3002\u4e0b\u8f7d\u8fc7\u7a0b\u4e2d\u7ed9\u51fa\u4e86\u6bcf\u4e00\u5c42\u7684 ID \u7684\u524d 12 \u4f4d\u3002\u5e76\u4e14\u4e0b\u8f7d\u7ed3\u675f\u540e\uff0c\u7ed9\u51fa\u8be5\u955c\u50cf\u5b8c\u6574\u7684sha256 \u7684\u6458\u8981\uff0c\u4ee5\u786e\u4fdd\u4e0b\u8f7d\u4e00\u81f4\u6027\u3002</p> <p>\u7136\u540e\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u67e5\u770b\u7cfb\u7edf\u4e2d\u5df2\u6709\u7684\u955c\u50cf\uff1a</p> <pre><code>$ docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              04               775349758637        19 hours ago        2MB\nbusybox             latest              020584afccce        42 hours ago        22MB\nhello-world         latest              fce289e99eb9        10 months ago       84kB\n</code></pre> <p>\u5217\u8868\u5305\u542b\u4e86\u4ed3\u5e93\u540d\u3001\u6807\u7b7e\u3001\u955c\u50cf ID\u3001\u521b\u5efa\u65f6\u95f4\u4ee5\u53ca\u6240\u5360\u7528\u7684\u7a7a\u95f4\u3002\u955c\u50cf ID \u5219\u662f\u955c\u50cf\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u4e00\u4e2a\u955c\u50cf\u53ef\u4ee5\u5bf9\u5e94\u591a\u4e2a\u6807\u7b7e\u3002</p> <p>\u5982\u679c\u67d0\u4e2a\u955c\u50cf\u4e0d\u9700\u8981\u4e86\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u9762\u547d\u4ee4\u5220\u9664\u955c\u50cf\uff1a</p> <pre><code># \u6839\u636e\u955c\u50cf\u540d\u6216\u8005\u955c\u50cfID\u5220\u9664\u90fd\u53ef\u4ee5\n$ docker rmi -f hello-world\nUntagged: hello-world:latest\nUntagged: hello-world@sha256:c3b4ada4687bbaa170745b3e4dd8ac3f194ca95b2d0518b417fb47e5879d9b5f\nDeleted: sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e\n</code></pre> <p>\u8fd8\u53ef\u4ee5\u7ed9\u955c\u50cf\u91cd\u65b0\u6253\u4e0a\u4e00\u4e2a tag\uff1a</p> <pre><code>$ docker tag nginx nginx:test\n</code></pre> <p>\u53e6\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u5c06\u955c\u50cf\u5bfc\u51fa\u6210\u4e00\u4e2a\u72ec\u7acb\u7684\u6587\u4ef6\uff1a</p> <pre><code>$ docker save nginx &gt;/tmp/nginx.tar.gz\n$ ls -la /tmp/nginx.tar.gz\n-rw-r--r--. 1 root root 130066944 Nov  2 02:58 /tmp/nginx.tar.gz\n</code></pre> <p>\u5bf9\u4e8e\u65e0\u6cd5\u8bbf\u95ee\u5916\u7f51\u7684\u8bf7\u60c5\u51b5\u4e0b\u4f1a\u7ecf\u5e38\u4f7f\u7528\u8fd9\u79cd\u65b9\u6cd5\u5bfc\u51fa\u955c\u50cf\uff0c\u7136\u540e\u4f7f\u7528 load \u547d\u4ee4\u5bfc\u5165\u955c\u50cf\uff1a</p> <pre><code>$ docker load &lt;/tmp/nginx.tar.gz\n</code></pre>"},{"location":"docker/basic/#_3","title":"\u8fd0\u884c\u5bb9\u5668","text":"<p>\u6709\u4e86\u955c\u50cf\u540e\uff0c\u6211\u4eec\u5c31\u80fd\u591f\u4ee5\u8fd9\u4e2a\u955c\u50cf\u4e3a\u57fa\u7840\u8fd0\u884c\u4e00\u4e2a\u5bb9\u5668\u3002\u4ee5\u4e0a\u9762\u7684 ubuntu:18.04 \u4e3a\u4f8b\uff0c\u5982\u679c\u6211\u4eec\u6253\u7b97\u542f\u52a8\u91cc\u9762\u7684 bash \u5e76\u4e14\u8fdb\u884c\u4ea4\u4e92\u5f0f\u64cd\u4f5c\u7684\u8bdd\uff0c\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ docker run -it --rm \\\\\n    ubuntu:04 \\\\\n    /bin/bash\n\nroot@ec125fc290ca:/# cat /etc/os-release\nNAME=\"Ubuntu\"\nVERSION=\"3 LTS (Bionic Beaver)\"\nID=ubuntu\nID_LIKE=debian\nPRETTY_NAME=\"Ubuntu 3 LTS\"\nVERSION_ID=\"04\"\nHOME_URL=\"https://www.ubuntu.com/\"\nSUPPORT_URL=\"https://help.ubuntu.com/\"\nBUG_REPORT_URL=\"https://bugs.launchpad.net/ubuntu/\"\nPRIVACY_POLICY_URL=\"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy\"\nVERSION_CODENAME=bionic\nUBUNTU_CODENAME=bionic\n</code></pre> <p><code>docker run</code>\u5c31\u662f\u8fd0\u884c\u5bb9\u5668\u7684\u547d\u4ee4\uff0c\u6211\u4eec\u8fd9\u91cc\u7b80\u8981\u7684\u8bf4\u660e\u4e00\u4e0b\u4e0a\u9762\u7528\u5230\u7684\u53c2\u6570:</p> <ul> <li>-it\uff1a\u8fd9\u662f\u4e24\u4e2a\u53c2\u6570\uff0c\u4e00\u4e2a\u662f <code>-i</code> \u4ea4\u4e92\u5f0f\u64cd\u4f5c\uff0c\u4e00\u4e2a\u662f <code>-t</code> \u7ec8\u7aef\u3002\u6211\u4eec\u8fd9\u91cc\u6253\u7b97\u8fdb\u5165 bash \u6267\u884c\u4e00\u4e9b\u547d\u4ee4\u5e76\u67e5\u770b\u8fd4\u56de\u7ed3\u679c\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u4ea4\u4e92\u5f0f\u7ec8\u7aef\u3002</li> <li>--rm\uff1a\u8fd9\u4e2a\u53c2\u6570\u662f\u8bf4\u5bb9\u5668\u9000\u51fa\u540e\u968f\u4e4b\u5c06\u5176\u5220\u9664\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u9000\u51fa\u7684\u5bb9\u5668\u5e76\u4e0d\u4f1a\u7acb\u5373\u5220\u9664\uff0c\u9664\u975e\u624b\u52a8 docker rm\u3002\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u6267\u884c\u4e2a\u547d\u4ee4\uff0c\u770b\u770b\u7ed3\u679c\uff0c\u4e0d\u9700\u8981\u4fdd\u7559\u7ed3\u679c\uff0c\u56e0\u6b64\u4f7f\u7528<code>--rm</code>\u53ef\u4ee5\u907f\u514d\u6d6a\u8d39\u7a7a\u95f4\u3002</li> <li>ubuntu:18.04\uff1a\u8fd9\u662f\u6307\u7528 ubuntu:18.04 \u955c\u50cf\u4e3a\u57fa\u7840\u6765\u542f\u52a8\u5bb9\u5668\u3002</li> <li>bash\uff1a\u653e\u5728\u955c\u50cf\u540d\u540e\u7684\u662f\u547d\u4ee4\uff0c\u8fd9\u91cc\u6211\u4eec\u5e0c\u671b\u6709\u4e2a\u4ea4\u4e92\u5f0f Shell\uff0c\u56e0\u6b64\u7528\u7684\u662f bash\u3002</li> </ul> <p>\u8fdb\u5165\u5bb9\u5668\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 Shell \u4e0b\u64cd\u4f5c\uff0c\u6267\u884c\u4efb\u4f55\u6240\u9700\u7684\u547d\u4ee4\u3002\u8fd9\u91cc\uff0c\u6211\u4eec\u6267\u884c\u4e86<code>cat /etc/os-release</code>\uff0c\u8fd9\u662f Linux \u5e38\u7528\u7684\u67e5\u770b\u5f53\u524d\u7cfb\u7edf\u7248\u672c\u7684\u547d\u4ee4\uff0c\u4ece\u8fd4\u56de\u7684\u7ed3\u679c\u53ef\u4ee5\u770b\u5230\u5bb9\u5668\u5185\u662f Ubuntu 16.04.4 LTS \u7cfb\u7edf\u3002\u6700\u540e\u6211\u4eec\u901a\u8fc7 exit \u9000\u51fa\u4e86\u8fd9\u4e2a\u5bb9\u5668\u3002</p> <p>\u5f53\u5229\u7528<code>docker run</code>\u6765\u521b\u5efa\u5bb9\u5668\u65f6\uff0cDocker \u5728\u540e\u53f0\u8fd0\u884c\u7684\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li>\u68c0\u67e5\u672c\u5730\u662f\u5426\u5b58\u5728\u6307\u5b9a\u7684\u955c\u50cf\uff0c\u4e0d\u5b58\u5728\u5c31\u4ece\u516c\u6709\u4ed3\u5e93\u4e0b\u8f7d</li> <li>\u5229\u7528\u955c\u50cf\u521b\u5efa\u5e76\u542f\u52a8\u4e00\u4e2a\u5bb9\u5668</li> <li>\u5206\u914d\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff0c\u5e76\u5728\u53ea\u8bfb\u7684\u955c\u50cf\u5c42\u5916\u9762\u6302\u8f7d\u4e00\u5c42\u53ef\u8bfb\u5199\u5c42</li> <li>\u4ece\u5bbf\u4e3b\u4e3b\u673a\u914d\u7f6e\u7684\u7f51\u6865\u63a5\u53e3\u4e2d\u6865\u63a5\u4e00\u4e2a\u865a\u62df\u63a5\u53e3\u5230\u5bb9\u5668\u4e2d\u53bb</li> <li>\u4ece\u5730\u5740\u6c60\u914d\u7f6e\u4e00\u4e2a ip \u5730\u5740\u7ed9\u5bb9\u5668</li> <li>\u6267\u884c\u7528\u6237\u6307\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f</li> <li>\u6267\u884c\u5b8c\u6bd5\u540e\u5bb9\u5668\u88ab\u7ec8\u6b62</li> </ul> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u5bb9\u5668\u7ba1\u7406\u7684\u6838\u5fc3\u662f\u5bb9\u5668\u6267\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\u8fd9\u4e2a\u8fdb\u7a0b\uff0c\u6240\u4ee5\u5982\u679c\u8fd9\u4e2a\u8fdb\u7a0b\u4e0d\u662f\u5e38\u9a7b\u524d\u53f0\u7684\u8bdd\u5219\u6267\u884c\u540e\u5bb9\u5668\u5c31\u4f1a\u9000\u51fa\u4e86\uff0c\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u662f\u6267\u884c\u7684 <code>/bin/bash</code> \u8fd9\u4e2a\u7a0b\u5e8f\uff0c\u8fd9\u4e2a\u7a0b\u5e8f\u4f1a\u5e38\u9a7b\u524d\u53f0\uff0c\u6240\u4ee5\u5bb9\u5668\u4f1a\u4e00\u76f4\u5b58\u5728\uff0c\u800c\u4e14\u8fd9\u4e2a\u8fd9\u4e2a\u7a0b\u5e8f\u5728\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0bID=1\uff1a</p> <pre><code>root@6bc39e8cd11c:/# ps\n  PID TTY          TIME CMD\n    1 pts/0    00:00:00 bash\n   11 pts/0    00:00:00 ps\n</code></pre> <p>\u4f46\u662f\u5982\u679c\u6211\u4eec\u8fd0\u884c\u4e00\u4e2a\u666e\u901a\u7684\u547d\u4ee4\u5462\uff1a</p> <pre><code>$ docker run -it ubuntu:04 ls\nbin   dev  home  lib64  mnt  proc  run   srv  tmp  var\nboot  etc  lib   media  opt  root  sbin  sys  usr\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd0\u884c\u540e\u5c31\u5bb9\u5668\u5c31\u76f4\u63a5\u9000\u51fa\u4e86\uff0c\u8fd9\u70b9\u975e\u5e38\u91cd\u8981\uff0c\u6240\u4ee5\u5982\u679c\u8981\u5728\u5bb9\u5668\u4e2d\u6267\u884c nginx \u7a0b\u5e8f\u7684\u8bdd\u8981\u8bb0\u4f4f\u4e0d\u8981\u7528 daemon \u6a21\u5f0f\u4e86\uff0c\u56e0\u4e3a\u6267\u884c\u540e\u5c31\u9000\u51fa\u5230\u540e\u53f0\u53bb\u4e86\uff0cDocker \u5c31\u6ca1\u529e\u6cd5\u7ba1\u7406\u4e86\uff0c\u5c31\u4f1a\u9000\u51fa\u5bb9\u5668\u4e86\u3002</p>"},{"location":"docker/basic/#_4","title":"\u5217\u51fa\u5bb9\u5668","text":"<p>\u5982\u679c\u8981\u67e5\u770b\u5f53\u524d\u7cfb\u7edf\u4e2d\u5df2\u7ecf\u8fd0\u884c\u7684\u5bb9\u5668\uff0c\u53ef\u4ee5\u7528\u5982\u4e0b\u547d\u4ee4\uff1a</p> <p><code>$ docker ps</code></p> <p>\u5982\u679c\u628a\u5df2\u7ecf\u9000\u51fa\u7684\u5bb9\u5668\u4e5f\u5217\u51fa\u6765\u53ef\u4ee5\u52a0\u4e0a <code>-a</code> \u53c2\u6570\uff1a</p> <pre><code>$ docker ps -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                         PORTS               NAMES\n2275424275b6        ubuntu:04        \"ls\"                3 minutes ago       Exited (0) 3 minutes ago                           ecstatic_gates\n6e4a54862340        fce289e99eb9        \"/hello\"            About an hour ago   Exited (0) About an hour ago                       jovial_khayyam\n</code></pre>"},{"location":"docker/basic/#_5","title":"\u5220\u9664\u5bb9\u5668","text":"<p>\u5982\u679c\u8981\u5220\u9664\u6216\u5f3a\u5236\u5220\u9664\u4e00\u4e2a\u5bb9\u5668\uff08\u5305\u62ec\u5df2\u9000\u51fa\u7684\uff09\u5219\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code># \u6839\u636e\u5bb9\u5668ID\u5f3a\u5236\u5220\u9664\u5bb9\u5668\n$ docker rm -f 2275424275b6\n</code></pre>"},{"location":"docker/basic/#_6","title":"\u540e\u53f0\u8fd0\u884c","text":"<p>\u66f4\u591a\u7684\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u8ba9 Docker \u5728\u540e\u53f0\u8fd0\u884c\u800c\u4e0d\u662f\u76f4\u63a5\u628a\u6267\u884c\u547d\u4ee4\u7684\u7ed3\u679c\u8f93\u51fa\u5728\u5f53\u524d\u5bbf\u4e3b\u673a\u4e0b\u3002\u6b64\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0<code>-d</code>\u53c2\u6570\u6765\u5b9e\u73b0\u3002\u5982\u679c\u4e0d\u4f7f\u7528<code>-d</code>\u53c2\u6570\u8fd0\u884c\u5bb9\u5668\uff1a</p> <pre><code>$ docker run ubuntu:04 /bin/sh -c \"while true; do echo hello world; sleep 1; done\"\nhello world\nhello world\nhello world\nhello world\n</code></pre> <p>\u5bb9\u5668\u4f1a\u628a\u8f93\u51fa\u7684\u7ed3\u679c (STDOUT) \u6253\u5370\u5230\u5bbf\u4e3b\u673a\u4e0a\u9762\u3002\u5982\u679c\u4f7f\u7528\u4e86<code>-d</code>\u53c2\u6570\u8fd0\u884c\u5bb9\u5668\uff1a</p> <pre><code>$ docker run -d ubuntu:04 /bin/sh -c \"while true; do echo hello world; sleep 1; done\"\n501f4d9538a0b01f0ac422089258ad71fa88c016f2662c1120c1499b5fbc930f\n</code></pre> <p>\u6b64\u65f6\u5bb9\u5668\u4f1a\u5728\u540e\u53f0\u8fd0\u884c\u5e76\u4e0d\u4f1a\u628a\u8f93\u51fa\u7684\u7ed3\u679c (STDOUT) \u6253\u5370\u5230\u5bbf\u4e3b\u673a\u4e0a\u9762(\u8f93\u51fa\u7ed3\u679c\u53ef\u4ee5\u7528 docker logs \u67e5\u770b)\uff1a</p> <pre><code># docker logs -f [container ID or NAMES]\n$ docker logs -f 501f4d9538a0b01f0ac422089258ad71fa88c016f2662c1120c1499b5fbc930f\nhello world\nhello world\nhello world\n</code></pre> <p>\u6ce8\uff1a\u5bb9\u5668\u662f\u5426\u4f1a\u957f\u4e45\u8fd0\u884c\uff0c\u662f\u548c docker run \u6307\u5b9a\u7684\u547d\u4ee4\u6709\u5173\uff0c\u548c -d \u53c2\u6570\u65e0\u5173\u3002</p> <p>\u4f7f\u7528 <code>-d</code> \u53c2\u6570\u542f\u52a8\u540e\u4f1a\u8fd4\u56de\u4e00\u4e2a\u552f\u4e00\u7684\u5bb9\u5668 id\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u901a\u8fc7<code>docker ps</code>\u547d\u4ee4\u6765\u67e5\u770b\u5bb9\u5668\u4fe1\u606f\u3002</p>"},{"location":"docker/basic/#_7","title":"\u7ec8\u6b62\u5bb9\u5668","text":"<p>\u53e6\u5916\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528</p> <pre><code>docker stop [container ID or NAMES]\n</code></pre> <p>\u6765\u7ec8\u6b62\u4e00\u4e2a\u8fd0\u884c\u4e2d\u7684\u5bb9\u5668\u3002\u6b64\u5916\uff0c\u5f53 Docker \u5bb9\u5668\u4e2d\u6307\u5b9a\u7684\u5e94\u7528\u7ec8\u7ed3\u65f6\uff0c\u5bb9\u5668\u4e5f\u81ea\u52a8\u7ec8\u6b62\u3002\u4f8b\u5982\u524d\u9762\u53ea\u542f\u52a8\u4e86\u4e00\u4e2a\u7ec8\u7aef\u7684\u5bb9\u5668\uff0c\u7528\u6237\u901a\u8fc7 exit \u547d\u4ee4\u6216 Ctrl+d \u6765\u9000\u51fa\u7ec8\u7aef\u65f6\uff0c\u6240\u521b\u5efa\u7684\u5bb9\u5668\u7acb\u523b\u7ec8\u6b62\u3002\u7ec8\u6b62\u72b6\u6001\u7684\u5bb9\u5668\u53ef\u4ee5\u7528<code>docker ps -a</code> \u547d\u4ee4\u770b\u5230\uff1a</p> <pre><code>$ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS               NAMES\n501f4d9538a0        ubuntu:04        \"/bin/sh -c 'while t\u2026\"   About a minute ago   Up About a minute                       nervous_ganguly\n$ docker stop 501f4d9538a0\n501f4d9538a0\n$ docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n</code></pre> <p>\u540c\u6837\u53ef\u4ee5\u7528</p> <pre><code>docker start [container ID or NAMES]\n</code></pre> <p>\u547d\u4ee4\u6765\u542f\u52a8\u4e00\u4e2a\u7ec8\u6b62\u7684\u5bb9\u5668\uff1a</p> <pre><code>$ docker start 501f4d9538a0\n501f4d9538a0\n$ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\n501f4d9538a0        ubuntu:04        \"/bin/sh -c 'while t\u2026\"   5 minutes ago       Up 2 seconds                            nervous_ganguly\n</code></pre>"},{"location":"docker/basic/#_8","title":"\u7f51\u7edc","text":""},{"location":"docker/basic/#_9","title":"\u7aef\u53e3\u66b4\u9732","text":"<p>Docker \u5bb9\u5668\u66f4\u591a\u60c5\u51b5\u4e0b\u662f\u7528\u6765\u8fd0\u884c Web \u5e94\u7528\u7684\uff0c\u6240\u4ee5\u8981\u5982\u4f55\u8bbf\u95ee\u5230\u5bb9\u5668\u4e2d\u7684 Web \u670d\u52a1\u5462\uff1f\u6bd4\u5982\u6211\u4eec\u73b0\u5728\u8fd0\u884c\u4e00\u4e2a nginx \u5bb9\u5668\u670d\u52a1\uff1a</p> <pre><code>$ docker run --name webserver -d nginx\nUnable to find image 'nginx:latest' locally\nlatest: Pulling from library/nginx\n8d691f585fa8: Pull complete\n5b07f4e08ad0: Pull complete\nabc291867bca: Pull complete\nDigest: sha256:922c815aa4df050d4df476e92daed4231f466acc8ee90e0e774951b0fd7195a4\nStatus: Downloaded newer image for nginx:latest\ne8b034c01f4024162cefc45006738fce85b3fa1b717a6ff24520c0fcfabaf5b6\n</code></pre> <p>nginx \u955c\u50cf\u6ca1\u6709\u6307\u5b9a tag \u6807\u7b7e\uff0c\u5219\u9ed8\u8ba4\u5c31\u662f\u62c9\u53d6<code>nginx:latest</code>\u955c\u50cf\uff1b\u5176\u4e2d<code>--name</code>\u53c2\u6570\u6307\u5b9a\u5bb9\u5668\u7684\u540d\u79f0\uff0c\u4e0d\u6307\u5b9a\u5219\u662f\u968f\u673a\u7684\u5bb9\u5668\u540d\uff0c\u8fd0\u884c\u6210\u529f\u540e\u53ef\u4ee5\u901a\u8fc7<code>docker ps</code>\u547d\u4ee4\u67e5\u770b\u5bb9\u5668\u4fe1\u606f\uff1a</p> <pre><code>$ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS               NAMES\ne8b034c01f40        nginx               \"nginx -g 'daemon of\u2026\"   About a minute ago   Up About a minute   80/tcp              webserver\n</code></pre> <p>\u4f46\u662f\u6211\u4eec\u8981\u600e\u4e48\u53bb\u8bbf\u95ee\u8fd9\u4e2a nginx \u670d\u52a1\u5462\uff1f\u5b9e\u9645\u4e0a\u5728\u6211\u4eec\u542f\u52a8\u5bb9\u5668\u7684\u65f6\u5019\uff0cDocker \u5c31\u4f1a\u4e3a\u6211\u4eec\u7684\u5bb9\u5668\u5206\u914d\u4e00\u4e2a IP \u5730\u5740\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u6765\u83b7\u53d6\u5bb9\u5668\u7684 IP \u5730\u5740\uff1a</p> <pre><code>$ docker inspect webserver |grep IPAddress\n            \"SecondaryIPAddresses\": null,\n            \"IPAddress\": \"14\",\n                    \"IPAddress\": \"14\",\n</code></pre> <p>\u5176\u4e2d\u7684 <code>172.17.0.4</code>\u5c31\u662f\u5bb9\u5668 webserver \u7684\u5730\u5740\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8be5\u5730\u5740\u8bbf\u95ee\u5230 nginx \u670d\u52a1\uff1a</p> <pre><code>$ curl http://14\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u4f46\u662f\u8fd9\u6837\u4e0d\u591f\u65b9\u4fbf\uff0c\u56e0\u4e3a\u542f\u52a8\u5bb9\u5668\u7684\u4ee3\u4ef7\u5f88\u5c0f\uff0c\u6240\u4ee5\u5bb9\u5668\u7684 IP \u8fd9\u4e9b\u7ecf\u5e38\u53d8\u52a8\uff0c\u662f\u5426\u80fd\u591f\u901a\u8fc7\u5bbf\u4e3b\u673a\u7684\u65b9\u5f0f\u53bb\u8bbf\u95ee\u5462\uff1f\u5b9e\u9645\u4e0a\u662f\u53ef\u4ee5\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u91cd\u65b0\u542f\u52a8\u4e00\u4e2a\u65b0\u7684\u5bb9\u5668\uff1a</p> <pre><code>$ docker rm -f webserver\n$ docker run --name webserver -d -p 80:80 nginx\n</code></pre> <p>\u6211\u4eec\u5728\u542f\u52a8\u5bb9\u5668\u7684\u65f6\u5019\u6dfb\u52a0\u4e86\u4e00\u4e2a\u65b0\u7684\u53c2\u6570<code>-p 8080:80</code>\uff0c\u8fd9\u4e2a\u53c2\u6570\u7684\u610f\u601d\u662f\u5c06\u5bbf\u4e3b\u673a\u7684 8080 \u7aef\u53e3\u548c\u5bb9\u5668\u7684 80 \u7aef\u53e3\u8fdb\u884c\u7ed1\u5b9a\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u5bbf\u4e3b\u673a\u7684 8080 \u7aef\u53e3\u6765\u8bbf\u95ee\u5bb9\u5668\u670d\u52a1\u4e86\u3002</p> <pre><code>$ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                NAMES\n89e105d56215        nginx               \"nginx -g 'daemon of\u2026\"   About a minute ago   Up About a minute   0:8080-&gt;80/tcp   webserver\n$ curl http://localhost:8080\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>"},{"location":"docker/basic/#bridge","title":"Bridge \u6a21\u5f0f","text":"<p>\u5f53 Docker \u8fdb\u7a0b\u542f\u52a8\u65f6\uff0c\u4f1a\u5728\u4e3b\u673a\u4e0a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a<code>docker0</code>\u7684\u865a\u62df\u7f51\u6865\uff0c\u6b64\u4e3b\u673a\u4e0a\u542f\u52a8\u7684 Docker \u5bb9\u5668\u4f1a\u8fde\u63a5\u5230\u8fd9\u4e2a\u865a\u62df\u7f51\u6865\u4e0a\u3002\u865a\u62df\u7f51\u6865\u7684\u5de5\u4f5c\u65b9\u5f0f\u548c\u7269\u7406\u4ea4\u6362\u673a\u7c7b\u4f3c\uff0c\u8fd9\u6837\u4e3b\u673a\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u5c31\u901a\u8fc7\u4ea4\u6362\u673a\u8fde\u5728\u4e86\u4e00\u4e2a\u4e8c\u5c42\u7f51\u7edc\u4e2d\u3002\u4ece docker0 \u5b50\u7f51\u4e2d\u5206\u914d\u4e00\u4e2a IP \u7ed9\u5bb9\u5668\u4f7f\u7528\uff0c\u5e76\u8bbe\u7f6e docker0 \u7684 IP \u5730\u5740\u4e3a\u5bb9\u5668\u7684\u9ed8\u8ba4\u7f51\u5173\u3002\u5728\u4e3b\u673a\u4e0a\u521b\u5efa\u4e00\u5bf9\u865a\u62df\u7f51\u5361<code>veth pair</code>\u8bbe\u5907\uff0cDocker \u5c06 veth pair \u8bbe\u5907\u7684\u4e00\u7aef\u653e\u5728\u65b0\u521b\u5efa\u7684\u5bb9\u5668\u4e2d\uff0c\u5e76\u547d\u540d\u4e3a eth0\uff08\u5bb9\u5668\u7684\u7f51\u5361\uff09\uff0c\u53e6\u4e00\u7aef\u653e\u5728\u4e3b\u673a\u4e2d\uff0c\u4ee5<code>vethxxx</code>\u8fd9\u6837\u7c7b\u4f3c\u7684\u540d\u5b57\u547d\u540d\uff0c\u5e76\u5c06\u8fd9\u4e2a\u7f51\u7edc\u8bbe\u5907\u52a0\u5165\u5230 docker0 \u7f51\u6865\u4e2d\u3002\u53ef\u4ee5\u901a\u8fc7<code>brctl show</code>\u547d\u4ee4\u67e5\u770b\uff1a</p> <pre><code>$ brctl show\nbridge name bridge id       STP enabled interfaces\ndocker0     80024286df8f39   no      veth1040b0a\n                            veth5a2ba56\n                            veth7aa7e71\n</code></pre> <p>bridge \u6a21\u5f0f\u662f docker \u7684\u9ed8\u8ba4\u7f51\u7edc\u6a21\u5f0f\uff0c\u4f7f\u7528<code>docker run -p</code>\u65f6\uff0c\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7 iptables \u505a\u4e86<code>DNAT</code>\u89c4\u5219\uff0c\u5b9e\u73b0\u7aef\u53e3\u8f6c\u53d1\u529f\u80fd\u3002\u53ef\u4ee5\u4f7f\u7528iptables -t nat -vnL\u67e5\u770b\u3002bridge\u6a21\u5f0f\u5982\u4e0b\u56fe\u6240\u793a\uff1a\u200b\u200b</p> <p></p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u8fd0\u884c\u4e00\u4e2a busybox \u5bb9\u5668\uff1a</p> <pre><code>$ docker run -tid --net=bridge --name docker_bri busybox top\n$ brctl show\nbrctl show\nbridge name bridge id       STP enabled interfaces\ndocker0     80024286df8f39   no      veth1040b0a\n                            veth27bc18a\n                            veth5a2ba56\n                            veth7aa7e71\n</code></pre> <p>\u7136\u540e\u8fdb\u5165\u5230\u5bb9\u5668\u5185\u90e8\u53bb\u67e5\u770b\u7f51\u7edc\u60c5\u51b5\uff0c\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u4f7f\u7528\u5230\u4e00\u4e2a\u65b0\u7684\u547d\u4ee4<code>docker exec</code>\uff0c\u7528\u6765\u8fdb\u5165\u5bb9\u5668\u5185\u90e8\uff0c\u8981\u8bb0\u4f4f\u6211\u4eec\u8981\u8fdb\u884c\u7ec8\u7aef\u4ea4\u4e92\uff0c\u6240\u4ee5\u8981\u5e26\u4e0a<code>-it</code>\u4e24\u4e2a\u53c2\u6570\uff1a</p> <pre><code>$ docker exec -it docker_bri /bin/sh\n/ # ifconfig -a\neth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:05\n          inet addr:15  Bcast:12255  Mask:220\n          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n          RX packets:8 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:648 (60 B)  TX bytes:0 (0 B)\n\nlo        Link encap:Local Loopback\n          inet addr:11  Mask:20\n          UP LOOPBACK RUNNING  MTU:65536  Metric:1\n          RX packets:0 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:0 (0 B)  TX bytes:0 (0 B)\n\n/ # route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0         11      0         UG    0      0        0 eth0\n10      0         220     U     0      0        0 eth0\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7<code>ip link show</code>\u547d\u4ee4\u67e5\u770b\u5230\u5bf9\u5e94\u7684 veth pair \u5bf9\u540d\u79f0\u3002</p> <p>\u901a\u8fc7\u4e0a\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u9a8c\u8bc1\u6211\u4eec\u524d\u9762\u63d0\u5230\u7684 bridge \u6a21\u5f0f\u539f\u7406\u3002</p>"},{"location":"docker/basic/#_10","title":"\u81ea\u5b9a\u4e49\u7f51\u7edc","text":"<p>\u53e6\u5916\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49\u7684 Docker \u7f51\u7edc\u6765\u8fde\u63a5\u591a\u4e2a\u5bb9\u5668\uff0c\u800c\u4e0d\u662f\u4f7f\u7528<code>--link</code>\u547d\u4ee4\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6709\u4e00\u4e2a\u65b0\u7684\u5bb9\u5668\u60f3\u8981\u548c\u4e0a\u9762\u7684 docker_bri \u5bb9\u5668\u5efa\u7acb\u4e92\u8fde\u5173\u7cfb\uff0c\u4e4b\u524d\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>--link</code> \u547d\u4ee4\uff1a</p> <pre><code>$ docker run -tid --link docker_bri --name docker_bri1 busybox top\n2cba17dd1326c2c82d8fa415588a0169e7291d1a44d2accaff25d50216830777\n$ docker exec -it docker_bri1 /bin/sh\n/ # ping docker_bri\nPING docker_bri (15): 56 data bytes\n64 bytes from 15: seq=0 ttl=64 time=194 ms\n64 bytes from 15: seq=1 ttl=64 time=156 ms\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5728\u65b0\u521b\u5efa\u7684\u5bb9\u5668\u4e0a\u53ef\u4ee5\u8bbf\u95ee\u5230\u6211\u4eec\u8fde\u63a5\u7684\u5bb9\u5668\uff0c\u4f46\u662f\u53cd\u8fc7\u6765\u5374\u4e0d\u884c\u4e86\uff0c\u56e0\u4e3a<code>--link</code>\u662f\u5355\u65b9\u9762\u7684\uff1a</p> <pre><code>$ docker exec -it docker_bri /bin/sh\n/ # ping docker_bri1\nping: bad address 'docker_bri1'\n/ #\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49\u7f51\u7edc\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\u4e92\u8054\u4e92\u901a\uff0c\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684\u7f51\u7edc\uff1a</p> <pre><code>$ docker network create -d bridge my-net\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u7f51\u7edc\u8fd0\u884c\u4e00\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>$ docker run -it --rm --name busybox1 --network my-net busybox sh\n</code></pre> <p>\u6253\u5f00\u7ec8\u7aef\u518d\u8fd0\u884c\u4e00\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>$ docker run -it --rm --name busybox2 --network my-net busybox sh\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u901a\u8fc7 ping \u6765\u8bc1\u660e busybox1 \u5bb9\u5668\u548c busybox2 \u5bb9\u5668\u5efa\u7acb\u4e86\u4e92\u8054\u5173\u7cfb\u3002 \u5728 busybox1 \u5bb9\u5668\u8f93\u5165\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>/ # ping busybox2\nPING busybox2 (13): 56 data bytes\n64 bytes from 13: seq=0 ttl=64 time=072 ms\n64 bytes from 13: seq=1 ttl=64 time=118 ms\n</code></pre> <p>\u7528 ping \u6765\u6d4b\u8bd5\u8fde\u63a5 busybox2 \u5bb9\u5668\uff0c\u5b83\u4f1a\u89e3\u6790\u6210 172.19.0.3\u3002 \u540c\u7406\u5728 busybox2 \u5bb9\u5668\u6267\u884c ping busybox1\uff0c\u4e5f\u4f1a\u6210\u529f\u8fde\u63a5\u5230\uff1a</p> <pre><code>/ # ping busybox1\nPING busybox1 (12): 56 data bytes\n64 bytes from 12: seq=0 ttl=64 time=064 ms\n64 bytes from 12: seq=1 ttl=64 time=143 ms\n</code></pre> <p>\u8fd9\u6837\uff0cbusybox1 \u5bb9\u5668\u548c busybox2 \u5bb9\u5668\u5efa\u7acb\u4e86\u4e92\u8054\u5173\u7cfb\uff0c\u5982\u679c\u4f60\u6709\u591a\u4e2a\u5bb9\u5668\u4e4b\u95f4\u9700\u8981\u4e92\u76f8\u8fde\u63a5\uff0c\u63a8\u8350\u4f7f\u7528\u540e\u9762\u7684 Docker Compose\u3002</p>"},{"location":"docker/basic/#host","title":"Host \u6a21\u5f0f","text":"<p>\u5982\u679c\u542f\u52a8\u5bb9\u5668\u7684\u65f6\u5019\u4f7f\u7528 host \u6a21\u5f0f\uff0c\u90a3\u4e48\u8fd9\u4e2a\u5bb9\u5668\u5c06\u4e0d\u4f1a\u83b7\u5f97\u4e00\u4e2a\u72ec\u7acb\u7684<code>Network Namespace</code>\uff0c\u800c\u662f\u548c\u5bbf\u4e3b\u673a\u5171\u7528\u4e00\u4e2a Network Namespace\u3002\u5bb9\u5668\u5c06\u4e0d\u4f1a\u865a\u62df\u51fa\u81ea\u5df1\u7684\u7f51\u5361\uff0c\u914d\u7f6e\u81ea\u5df1\u7684 IP \u7b49\uff0c\u800c\u662f\u4f7f\u7528\u5bbf\u4e3b\u673a\u7684 IP \u548c\u7aef\u53e3\u3002\u4f46\u662f\uff0c\u5bb9\u5668\u7684\u5176\u4ed6\u65b9\u9762\uff0c\u5982\u6587\u4ef6\u7cfb\u7edf\u3001\u8fdb\u7a0b\u5217\u8868\u7b49\u8fd8\u662f\u548c\u5bbf\u4e3b\u673a\u9694\u79bb\u7684\u3002 Host\u6a21\u5f0f\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p>\u200b\u200b</p> <p>\u4f7f\u7528 host \u6a21\u5f0f\u4e5f\u5f88\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5728\u8fd0\u884c\u5bb9\u5668\u7684\u65f6\u5019\u6307\u5b9a <code>--net=host</code> \u5373\u53ef\u3002</p>"},{"location":"docker/basic/#container","title":"Container \u6a21\u5f0f","text":"<p>\u8fd9\u4e2a\u6a21\u5f0f\u6307\u5b9a\u65b0\u521b\u5efa\u7684\u5bb9\u5668\u548c\u5df2\u7ecf\u5b58\u5728\u7684\u4e00\u4e2a\u5bb9\u5668\u5171\u4eab\u4e00\u4e2a Network Namespace\uff0c\u800c\u4e0d\u662f\u548c\u5bbf\u4e3b\u673a\u5171\u4eab\u3002\u65b0\u521b\u5efa\u7684\u5bb9\u5668\u4e0d\u4f1a\u521b\u5efa\u81ea\u5df1\u7684\u7f51\u5361\uff0c\u914d\u7f6e\u81ea\u5df1\u7684 IP\uff0c\u800c\u662f\u548c\u4e00\u4e2a\u6307\u5b9a\u7684\u5bb9\u5668\u5171\u4eab IP\u3001\u7aef\u53e3\u8303\u56f4\u7b49\u3002\u540c\u6837\uff0c\u4e24\u4e2a\u5bb9\u5668\u9664\u4e86\u7f51\u7edc\u65b9\u9762\uff0c\u5176\u4ed6\u7684\u5982\u6587\u4ef6\u7cfb\u7edf\u3001\u8fdb\u7a0b\u5217\u8868\u7b49\u8fd8\u662f\u9694\u79bb\u7684\u3002\u4e24\u4e2a\u5bb9\u5668\u7684\u8fdb\u7a0b\u53ef\u4ee5\u901a\u8fc7 lo \u7f51\u5361\u8bbe\u5907\u901a\u4fe1\u3002 Container \u6a21\u5f0f\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u5728\u8fd0\u884c\u5bb9\u5668\u7684\u65f6\u5019\u6307\u5b9a </p> <pre><code>--net=container:\u76ee\u6807\u5bb9\u5668\u540d\n</code></pre> <p>\u5373\u53ef\u3002\u5b9e\u9645\u4e0a\u6211\u4eec\u540e\u9762\u8981\u5b66\u4e60\u7684 Kubernetes \u91cc\u9762\u7684 Pod \u4e2d\u5bb9\u5668\u4e4b\u95f4\u5c31\u662f\u901a\u8fc7 Container \u6a21\u5f0f\u94fe\u63a5\u5230 pause \u5bb9\u5668\u4e0a\u9762\u7684\uff0c\u6240\u4ee5\u5bb9\u5668\u76f4\u63a5\u53ef\u4ee5\u901a\u8fc7 localhost \u6765\u8fdb\u884c\u8bbf\u95ee\u3002</p>"},{"location":"docker/basic/#none","title":"None \u6a21\u5f0f","text":"<p>\u4f7f\u7528 non e\u6a21\u5f0f\uff0cDocker \u5bb9\u5668\u62e5\u6709\u81ea\u5df1\u7684 Network Namespace\uff0c\u4f46\u662f\u5e76\u4e0d\u4e3aDocker \u5bb9\u5668\u8fdb\u884c\u4efb\u4f55\u7f51\u7edc\u914d\u7f6e\u3002\u4e5f\u5c31\u662f\u8bf4\u8fd9\u4e2a Docker \u5bb9\u5668\u6ca1\u6709\u7f51\u5361\u3001IP\u3001\u8def\u7531\u7b49\u4fe1\u606f\u3002\u9700\u8981\u6211\u4eec\u81ea\u5df1\u4e3a Docker \u5bb9\u5668\u6dfb\u52a0\u7f51\u5361\u3001\u914d\u7f6e IP \u7b49\u3002 None\u6a21\u5f0f\u793a\u610f\u56fe\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u9009\u62e9\u8fd9\u79cd\u6a21\u5f0f\uff0c\u4e00\u822c\u662f\u7528\u6237\u5bf9\u7f51\u7edc\u6709\u81ea\u5df1\u7279\u6b8a\u7684\u9700\u6c42\uff0c\u4e0d\u5e0c\u671b docker \u9884\u8bbe\u7f6e\u592a\u591a\u7684\u4e1c\u897f\u3002</p>"},{"location":"docker/basic/#_11","title":"\u6570\u636e\u5171\u4eab\u4e0e\u6301\u4e45\u5316","text":"<p>\u63a5\u4e0b\u6765\u4ecb\u7ecd\u5982\u4f55\u5728 Docker \u5185\u90e8\u4ee5\u53ca\u5bb9\u5668\u4e4b\u95f4\u7ba1\u7406\u6570\u636e\uff0c\u5728\u5bb9\u5668\u4e2d\u7ba1\u7406\u6570\u636e\u4e3b\u8981\u6709\u4e24\u79cd\u65b9\u5f0f\uff1a</p> <ul> <li>\u6570\u636e\u5377\uff08Data Volumes\uff09</li> <li>\u6302\u8f7d\u4e3b\u673a\u76ee\u5f55 (Bind mounts)</li> </ul>"},{"location":"docker/basic/#_12","title":"\u6570\u636e\u5377","text":"<p><code>\u6570\u636e\u5377</code>\u662f\u4e00\u4e2a\u53ef\u4f9b\u4e00\u4e2a\u6216\u591a\u4e2a\u5bb9\u5668\u4f7f\u7528\u7684\u7279\u6b8a\u76ee\u5f55\uff0c\u5b83\u7ed5\u8fc7 UFS\uff0c\u53ef\u4ee5\u63d0\u4f9b\u5f88\u591a\u6709\u7528\u7684\u7279\u6027\uff1a</p> <ul> <li>\u6570\u636e\u5377\u53ef\u4ee5\u5728\u5bb9\u5668\u4e4b\u95f4\u5171\u4eab\u548c\u91cd\u7528</li> <li>\u5bf9\u6570\u636e\u5377\u7684\u4fee\u6539\u4f1a\u7acb\u9a6c\u751f\u6548</li> <li>\u5bf9\u6570\u636e\u5377\u7684\u66f4\u65b0\uff0c\u4e0d\u4f1a\u5f71\u54cd\u955c\u50cf</li> <li>\u6570\u636e\u5377\u9ed8\u8ba4\u4f1a\u4e00\u76f4\u5b58\u5728\uff0c\u5373\u4f7f\u5bb9\u5668\u88ab\u5220\u9664</li> </ul> <p>\u6570\u636e\u5377</p> <p>\u6ce8\u610f\uff1a\u6570\u636e\u5377 \u7684\u4f7f\u7528\uff0c\u7c7b\u4f3c\u4e8e Linux \u4e0b\u5bf9\u76ee\u5f55\u6216\u6587\u4ef6\u8fdb\u884c mount\uff0c\u955c\u50cf\u4e2d\u7684\u88ab\u6307\u5b9a\u4e3a\u6302\u8f7d\u70b9\u7684\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u4f1a\u9690\u85cf\u6389\uff0c\u663e\u793a\u7684\u662f\u6302\u8f7d\u7684 \u6570\u636e\u5377\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a\u6570\u636e\u5377\uff1a</p> <pre><code>$ docker volume create my-vol\n</code></pre> <p>\u67e5\u770b\u6570\u636e\u5377\uff1a</p> <pre><code>$ docker volume ls\nlocal               my-vol\n</code></pre> <p>\u540c\u6837\u53ef\u4ee5\u901a\u8fc7 inspect \u547d\u4ee4\u67e5\u770b\u6570\u636e\u5377\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ docker volume inspect my-vol\n[\n    {\n        \"CreatedAt\": \"2019-11-02T03:08:02+08:00\",\n        \"Driver\": \"local\",\n        \"Labels\": {},\n        \"Mountpoint\": \"/data/docker/volumes/my-vol/_data\",\n        \"Name\": \"my-vol\",\n        \"Options\": {},\n        \"Scope\": \"local\"\n    }\n]\n</code></pre> <p>\u542f\u52a8\u4e00\u4e2a\u6302\u8f7d\u6570\u636e\u5377\u7684\u5bb9\u5668\uff1a\u5728\u7528<code>docker run</code>\u547d\u4ee4\u7684\u65f6\u5019\uff0c\u4f7f\u7528<code>--mount</code>\u6216\u8005<code>-v</code>\u6807\u8bb0\u6765\u5c06<code>\u6570\u636e\u5377</code>\u6302\u8f7d\u5230\u5bb9\u5668\u91cc\u3002\u4e0b\u9762\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a web \u7684\u5bb9\u5668\uff0c\u5e76\u52a0\u8f7d\u4e00\u4e2a\u6570\u636e\u5377\u5230\u5bb9\u5668\u7684 /usr/share/nginx/html \u76ee\u5f55\uff1a</p> <pre><code># -v my-vol:/xxxx\n# --mount source=my-vol,target=/xxxx\n$ docker run -d -p 8080:80 --name web -v my-vol:/usr/share/nginx/html nginx\n</code></pre> <p>\u8fd0\u884c\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u67e5\u770b\u6570\u636e\u5377\u76ee\u5f55\u4e0b\u9762\u5df2\u7ecf\u6709\u6587\u4ef6\u4e86\uff1a</p> <pre><code>$ ls /data/docker/volumes/my-vol/_data/\n50x.html  index.html\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>localhost:8080</code>\u8bbf\u95ee\u5bb9\u5668\u670d\u52a1\uff1a</p> <pre><code>$ curl http://localhost:8080\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u628a\u6570\u636e\u4e0b\u9762\u7684 index.html \u6587\u4ef6\u5185\u5bb9\u53d8\u66f4\u4e0b\uff1a</p> <pre><code>$ echo \"Hello Docker\" &gt; /data/docker/volumes/my-vol/_data/index.html\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u91cd\u65b0\u8bbf\u95ee\u5c31\u53ef\u4ee5\u770b\u5230\u5185\u5bb9\u5df2\u7ecf\u53d8\u5316\u4e86\uff1a</p> <pre><code>$ curl http://localhost:8080\nHello Docker\n</code></pre> <p>\u6570\u636e\u5377\u662f\u88ab\u8bbe\u8ba1\u7528\u6765\u6301\u4e45\u5316\u6570\u636e\u7684\uff0c\u5b83\u7684\u751f\u547d\u5468\u671f\u72ec\u7acb\u4e8e\u5bb9\u5668\uff0cDocker \u4e0d\u4f1a\u5728\u5bb9\u5668\u88ab\u5220\u9664\u540e\u81ea\u52a8\u5220\u9664 \u6570\u636e\u5377\uff0c\u5e76\u4e14\u4e5f\u4e0d\u5b58\u5728\u5783\u573e\u56de\u6536\u8fd9\u6837\u7684\u673a\u5236\u6765\u5904\u7406\u6ca1\u6709\u4efb\u4f55\u5bb9\u5668\u5f15\u7528\u7684\u6570\u636e\u5377\u3002\u5982\u679c\u9700\u8981\u5728\u5220\u9664\u5bb9\u5668\u7684\u540c\u65f6\u79fb\u9664\u6570\u636e\u5377\u3002\u53ef\u4ee5\u5728\u5220\u9664\u5bb9\u5668\u7684\u65f6\u5019\u4f7f\u7528<code>docker rm -v</code>\u8fd9\u4e2a\u547d\u4ee4\u3002 \u65e0\u4e3b\u7684\u6570\u636e\u5377\u53ef\u80fd\u4f1a\u5360\u636e\u5f88\u591a\u7a7a\u95f4\uff0c\u8981\u6e05\u7406\u8bf7\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ docker volume prune\n</code></pre>"},{"location":"docker/basic/#_13","title":"\u6302\u8f7d\u4e3b\u673a\u76ee\u5f55","text":"<p>Docker \u540c\u6837\u652f\u6301\u628a\u5bbf\u4e3b\u673a\u4e0a\u7684\u76ee\u5f55\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\uff0c\u540c\u6837\u53ef\u4ee5\u4f7f\u7528 <code>-v</code> \u6216\u8005 <code>--mount</code> \u53c2\u6570\u6765\u8fdb\u884c\u6302\u8f7d\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u628a\u5bbf\u4e3b\u673a\u7684 <code>/tmp</code> \u76ee\u5f55\u6302\u8f7d\u5230\u4e00\u4e2a\u5bb9\u5668\u4e2d\uff1a</p> <pre><code>$ ls /tmp/\nnginx.tar.gz  yum_save_tx.2019-11-23-ux9w_yumtx\n$ ls /tmp/nginx.tar.gz\n/tmp/nginx.tar.gz\n$ docker run -it -v /tmp:/usr/tmp busybox /bin/sh\n/ # ls /usr/tmp/\nnginx.tar.gz                               yum_save_tx.2019-11-23-ux9w_yumtx\n</code></pre> <p>\u901a\u8fc7<code>-v</code>\u53c2\u6570\uff0c\u5192\u53f7\u524d\u4e3a<code>\u5bbf\u4e3b\u673a</code>\u76ee\u5f55\uff0c\u5fc5\u987b\u4e3a<code>\u7edd\u5bf9\u8def\u5f84</code>\uff0c\u5192\u53f7\u540e\u4e3a\u5bb9\u5668\u5185\u6302\u8f7d\u7684\u8def\u5f84\u3002\u8fd9\u6837\u5bb9\u5668\u5185\u5c31\u53ef\u4ee5\u5171\u4eab\u5bbf\u4e3b\u673a\u91cc\u7684\u6587\u4ef6\u4e86\u3002</p> <p>\u6302\u8f7d\u6743\u9650</p> <p>\u9ed8\u8ba4\u6302\u8f7d\u7684\u8def\u5f84\u6743\u9650\u4e3a\u8bfb\u5199\u3002\u5982\u679c\u6307\u5b9a\u4e3a\u53ea\u8bfb\u53ef\u4ee5\u7528\uff1a<code>ro</code>\uff0c\u5982\uff1a<code>-v /tmp:/usr/tmp:ro</code>\u3002</p> <p>\u2013 \u5bb9\u5668\u76ee\u5f55\u4e0d\u53ef\u4ee5\u4e3a\u76f8\u5bf9\u8def\u5f84</p> <p>\u2013 \u5bbf\u4e3b\u673a\u76ee\u5f55\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u4f1a\u81ea\u52a8\u751f\u6210</p> <p>\u2013 \u6302\u8f7d\u5bbf\u4e3b\u673a\u5df2\u5b58\u5728\u76ee\u5f55\u540e\uff0c\u5728\u5bb9\u5668\u5185\u5bf9\u5176\u8fdb\u884c\u64cd\u4f5c\uff0c\u62a5Permission denied\u3002\u53ef\u901a\u8fc7\u4e24\u79cd\u65b9\u5f0f\u89e3\u51b3\uff1a</p> <pre><code>* 1&gt; \u5173\u95edselinux\u3002\n\n    \u4e34\u65f6\u5173\u95ed\uff1a`# setenforce 0`\n    \u6c38\u4e45\u5173\u95ed\uff1a\u4fee\u6539`/etc/sysconfig/selinux`\u6587\u4ef6\uff0c\u5c06 SELINUX \u7684\u503c\u8bbe\u7f6e\u4e3adisabled\u3002\n\n* 2&gt; \u4ee5\u7279\u6743\u65b9\u5f0f\u542f\u52a8\u5bb9\u5668\n\n    \u6307\u5b9a`--privileged`\u53c2\u6570\uff0c\u5982\uff1a\n    `# docker run -it --privileged=true -v /test:/soft centos /bin/bash`\n</code></pre> <p><code>bind mount</code> \u548c volume \u5176\u5b9e\u90fd\u662f\u5229\u7528\u5bbf\u4e3b\u673a\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e volume \u662f docker \u81ea\u8eab\u7ba1\u7406\u7684\u76ee\u5f55\u4e2d\u7684\u5b50\u76ee\u5f55\uff0c\u6240\u4ee5\u4e0d\u5b58\u5728\u6743\u9650\u5f15\u53d1\u7684\u6302\u8f7d\u7684\u95ee\u9898\uff0c\u5e76\u4e14\u76ee\u5f55\u8def\u5f84\u662f docker \u81ea\u8eab\u7ba1\u7406\u7684\uff0c\u6240\u4ee5\u4e5f\u4e0d\u9700\u8981\u5728\u4e0d\u540c\u7684\u670d\u52a1\u5668\u4e0a\u6307\u5b9a\u4e0d\u540c\u7684\u8def\u5f84\uff0c\u4f60\u4e0d\u9700\u8981\u5173\u5fc3\u8def\u5f84\u3002\u5b83\u4eec\u4e4b\u95f4\u7684\u4e3b\u8981\u533a\u522b\u6709\u5982\u4e0b\u51e0\u70b9\uff1a</p> <ul> <li>volume \u4f1a\u5f15\u8d77 docker \u76ee\u5f55\u81a8\u80c0\uff0c\u56e0\u4e3a\u65e2\u8981\u5b58\u955c\u50cf\uff0c\u53c8\u8981\u5b58 volume\uff0c\u6700\u597d\u4e0d\u8981\u653e\u5728\u7cfb\u7edf\u76d8\uff0c\u5c06 docker \u7684\u5b89\u88c5\u76ee\u5f55\u914d\u7f6e\u5230\u5176\u4ed6\u66f4\u5927\u7684\u6302\u8f7d\u76d8</li> <li>\u4e24\u8005\u6709\u4e00\u4e2a\u4e0d\u540c\u7684\u884c\u4e3a\uff1a\u5f53\u5bb9\u5668\u5916\u7684\u5bf9\u5e94\u76ee\u5f55\u662f\u7a7a\u7684\uff0cvolume \u4f1a\u5148\u5c06\u5bb9\u5668\u5185\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u5bb9\u5668\u5916\u76ee\u5f55\uff0c\u800c mount \u4f1a\u5c06\u5916\u90e8\u7684\u76ee\u5f55\u8986\u76d6\u5bb9\u5668\u5185\u90e8\u76ee\u5f55</li> <li>volume \u8fd8\u6709\u4e00\u4e2a\u4e0d\u5982 <code>bind mount</code> \u7684\u5730\u65b9\uff0c\u4e0d\u80fd\u76f4\u63a5\u6302\u8f7d\u6587\u4ef6\uff0c\u4f8b\u5982\u6302\u8f7d nginx \u5bb9\u5668\u7684\u914d\u7f6e\u6587\u4ef6\uff1anginx.conf</li> </ul>"},{"location":"docker/dockerfile_practice/","title":"Dockerfile\u5b9e\u8df5","text":""},{"location":"docker/dockerfile_practice/#dockerfile","title":"Dockerfile \u5b9e\u8df5","text":"<p>\u4f7f\u7528 Dockerfile \u7684\u4e00\u4e9b\u6700\u4f73\u5b9e\u8df5</p> <p>\u5728\u524d\u6587\u4e2d\u6211\u4eec\u4e86\u89e3\u5230\u4e86\u7528\u4e8e\u6784\u5efa Dockerfile \u7684\u57fa\u672c\u65b9\u6cd5\uff0c\u4f46\u662f\u7531\u4e8e\u5728\u7f16\u5199 Dockerfile \u7684\u65f6\u5019\u5e76\u6ca1\u6709\u4e00\u4e9b\u5f3a\u5236\u8981\u6c42\uff0c\u5bfc\u81f4\u5f88\u591a\u6784\u5efa\u7684\u955c\u50cf\u4e0d\u7b26\u5408\u4e00\u4e9b\u6700\u4f73\u5b9e\u8df5\uff0c\u5178\u578b\u7684\u5c31\u662f\u955c\u50cf\u6784\u5efa\u7684\u5c42\u6570\u975e\u5e38\u591a\uff0c\u5bf9\u4e00\u4e9b\u57fa\u672c\u6307\u4ee4\u7684\u533a\u522b\u4e0d\u662f\u5f88\u6e05\u695a\u3002\u672c\u8282\u4e3b\u8981\u4ecb\u7ecd Dockerfile \u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\u7684\u4e00\u4e9b\u6700\u4f73\u7684\u5b9e\u8df5\u65b9\u5f0f\u3002</p> <p>\u7b2c\u4e00\u4e2a\u662f\u524d\u9762\u91cd\u70b9\u63d0\u5230\u7684\u6784\u5efa\u4e0a\u4e0b\u6587\uff0c\u8fd9\u4e2a\u4e00\u5b9a\u9700\u8981\u7406\u89e3\uff0c\u7136\u540e\u662f\u5bf9\u4e8e\u4e00\u4e9b\u4e0d\u9700\u8981\u63d0\u4ea4\u6784\u5efa\u7684\u6587\u4ef6\u7528<code>.dockerignore</code>\u6765\u8fdb\u884c\u5ffd\u7565\u3002</p>"},{"location":"docker/dockerfile_practice/#_1","title":"\u6784\u5efa\u7f13\u5b58","text":"<p>\u5728\u955c\u50cf\u7684\u6784\u5efa\u8fc7\u7a0b\u4e2d\uff0cDocker \u6839\u636e Dockerfile \u6307\u5b9a\u7684\u987a\u5e8f\u6267\u884c\u6bcf\u4e2a\u6307\u4ee4\u3002\u5728\u6267\u884c\u6bcf\u6761\u6307\u4ee4\u4e4b\u524d\uff0cDocker \u90fd\u4f1a\u5728\u7f13\u5b58\u4e2d\u67e5\u627e\u662f\u5426\u5df2\u7ecf\u5b58\u5728\u53ef\u91cd\u7528\u7684\u955c\u50cf\uff0c\u5982\u679c\u6709\u5c31\u4f7f\u7528\u73b0\u5b58\u7684\u955c\u50cf\uff0c\u4e0d\u518d\u91cd\u590d\u521b\u5efa\u3002\u5f53\u7136\u5982\u679c\u4f60\u4e0d\u60f3\u5728\u6784\u5efa\u8fc7\u7a0b\u4e2d\u4f7f\u7528\u7f13\u5b58\uff0c\u4f60\u53ef\u4ee5\u5728 <code>docker build</code> \u547d\u4ee4\u4e2d\u4f7f\u7528 <code>--no-cache=true</code> \u9009\u9879\u3002Docker \u4e2d\u6784\u5efa\u7f13\u5b58\u9075\u5faa\u7684\u57fa\u672c\u89c4\u5219\u5982\u4e0b\uff1a</p> <ul> <li>\u4ece\u4e00\u4e2a\u57fa\u7840\u955c\u50cf\u5f00\u59cb\uff08FROM \u6307\u4ee4\u6307\u5b9a\uff09\uff0c\u4e0b\u4e00\u6761\u6307\u4ee4\u5c06\u548c\u8be5\u57fa\u7840\u955c\u50cf\u7684\u6240\u6709\u5b50\u955c\u50cf\u8fdb\u884c\u5339\u914d\uff0c\u68c0\u67e5\u8fd9\u4e9b\u5b50\u955c\u50cf\u88ab\u521b\u5efa\u65f6\u4f7f\u7528\u7684\u6307\u4ee4\u662f\u5426\u548c\u88ab\u68c0\u67e5\u7684\u6307\u4ee4\u5b8c\u5168\u4e00\u6837\u3002\u5982\u679c\u4e0d\u662f\uff0c\u5219\u7f13\u5b58\u5931\u6548\u3002</li> <li>\u5bf9\u4e8e ADD \u548c COPY \u6307\u4ee4\uff0c\u955c\u50cf\u4e2d\u5bf9\u5e94\u6587\u4ef6\u7684\u5185\u5bb9\u4e5f\u4f1a\u88ab\u68c0\u67e5\uff0c\u6bcf\u4e2a\u6587\u4ef6\u90fd\u4f1a\u8ba1\u7b97\u51fa\u4e00\u4e2a\u6821\u9a8c\u503c\u3002\u5728\u7f13\u5b58\u7684\u67e5\u627e\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u5c06\u8fd9\u4e9b\u6821\u9a8c\u548c\u5df2\u5b58\u5728\u955c\u50cf\u4e2d\u7684\u6587\u4ef6\u6821\u9a8c\u503c\u8fdb\u884c\u5bf9\u6bd4\u3002\u5982\u679c\u6587\u4ef6\u6709\u4efb\u4f55\u6539\u53d8\uff0c\u5219\u7f13\u5b58\u5931\u6548\u3002</li> <li> <p>\u9664\u4e86 ADD \u548c COPY \u6307\u4ee4\uff0c\u7f13\u5b58\u5339\u914d\u8fc7\u7a0b\u4e0d\u4f1a\u67e5\u770b\u4e34\u65f6\u5bb9\u5668\u4e2d\u7684\u6587\u4ef6\u6765\u51b3\u5b9a\u7f13\u5b58\u662f\u5426\u5339\u914d\u3002\u4f8b\u5982\uff0c\u5f53\u6267\u884c\u5b8c </p> <pre><code>RUN apt-get -y update\n</code></pre> <p>\u6307\u4ee4\u540e\uff0c\u5bb9\u5668\u4e2d\u4e00\u4e9b\u6587\u4ef6\u88ab\u66f4\u65b0\uff0c\u4f46 Docker \u4e0d\u4f1a\u68c0\u67e5\u8fd9\u4e9b\u6587\u4ef6\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ea\u6709<code>\u6307\u4ee4\u5b57\u7b26\u4e32\u672c\u8eab</code>\u88ab\u7528\u6765\u5339\u914d\u7f13\u5b58\u3002 *   \u4e00\u65e6\u7f13\u5b58\u5931\u6548\uff0c\u6240\u6709\u540e\u7eed\u7684 Dockerfile \u6307\u4ee4\u90fd\u5c06\u4ea7\u751f\u65b0\u7684\u955c\u50cf\uff0c\u7f13\u5b58\u4e0d\u4f1a\u88ab\u4f7f\u7528\u3002</p> </li> </ul>"},{"location":"docker/dockerfile_practice/#_2","title":"\u4f7f\u7528\u591a\u9636\u6bb5\u6784\u5efa","text":"<p>\u591a\u9636\u6bb5\u6784\u5efa\u53ef\u4ee5\u8ba9\u6211\u4eec\u5927\u5e45\u5ea6\u51cf\u5c0f\u6700\u7ec8\u7684\u955c\u50cf\u5927\u5c0f\uff0c\u800c\u4e0d\u9700\u8981\u53bb\u60f3\u529e\u6cd5\u51cf\u5c11\u4e2d\u95f4\u5c42\u548c\u6587\u4ef6\u7684\u6570\u91cf\u3002\u56e0\u4e3a\u955c\u50cf\u662f\u5728\u751f\u6210\u8fc7\u7a0b\u7684\u6700\u540e\u9636\u6bb5\u751f\u6210\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u5229\u7528\u751f\u6210\u7f13\u5b58\u6765\u6700\u5c0f\u5316\u955c\u50cf\u5c42\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u7684\u6784\u5efa\u5305\u542b\u591a\u4e2a\u5c42\uff0c\u5219\u53ef\u4ee5\u5c06\u5b83\u4eec\u4ece\u53d8\u5316\u9891\u7387\u8f83\u4f4e\uff08\u4ee5\u786e\u4fdd\u751f\u6210\u7f13\u5b58\u53ef\u91cd\u7528\uff09\u5230\u53d8\u5316\u9891\u7387\u8f83\u9ad8\u7684\u987a\u5e8f\u6392\u5e8f\uff1a</p> <ul> <li>\u5b89\u88c5\u6784\u5efa\u5e94\u7528\u7a0b\u5e8f\u6240\u9700\u7684\u4f9d\u8d56\u5de5\u5177</li> <li>\u5b89\u88c5\u6216\u66f4\u65b0\u4f9d\u8d56\u9879</li> <li>\u6784\u5efa\u4f60\u7684\u5e94\u7528</li> </ul> <p>\u6bd4\u5982\u6211\u4eec\u6784\u5efa\u4e00\u4e2a Go \u5e94\u7528\u7a0b\u5e8f\u7684 Dockerfile \u53ef\u80fd\u7c7b\u4f3c\u4e8e\u8fd9\u6837\uff1a</p> <pre><code>FROM golang:11-alpine AS build\n\n# \u5b89\u88c5\u9879\u76ee\u9700\u8981\u7684\u5de5\u5177\n# \u8fd0\u884c `docker build --no-cache .` \u6765\u66f4\u65b0\u4f9d\u8d56\nRUN apk add --no-cache git\nRUN go get github.com/golang/dep/cmd/dep\n\n# \u901a\u8fc7 Gopkg.toml \u548c Gopkg.lock \u83b7\u53d6\u9879\u76ee\u7684\u4f9d\u8d56\n# \u4ec5\u5728\u66f4\u65b0 Gopkg \u6587\u4ef6\u65f6\u624d\u91cd\u65b0\u6784\u5efa\u8fd9\u4e9b\u5c42\nCOPY Gopkg.lock Gopkg.toml /go/src/project/\nWORKDIR /go/src/project/\n# \u5b89\u88c5\u4f9d\u8d56\u5e93\nRUN dep ensure -vendor-only\n\n# \u62f7\u8d1d\u6574\u4e2a\u9879\u76ee\u8fdb\u884c\u6784\u5efa\n# \u5f53\u9879\u76ee\u4e0b\u9762\u6709\u6587\u4ef6\u53d8\u5316\u7684\u65f6\u5019\u8be5\u5c42\u624d\u4f1a\u91cd\u65b0\u6784\u5efa\nCOPY . /go/src/project/\nRUN go build -o /bin/project\n\n# \u5c06\u6253\u5305\u540e\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u62f7\u8d1d\u5230 scratch \u955c\u50cf\u4e0b\u9762\uff0c\u5c06\u955c\u50cf\u5927\u5c0f\u964d\u5230\u6700\u4f4e\nFROM scratch\nCOPY --from=build /bin/project /bin/project\nENTRYPOINT [\"/bin/project\"]\nCMD [\"--help\"]\n</code></pre>"},{"location":"docker/dockerfile_practice/#_3","title":"\u907f\u514d\u5b89\u88c5\u4e0d\u5fc5\u8981\u7684\u5305","text":"<p>\u4e3a\u4e86\u964d\u4f4e\u590d\u6742\u6027\u3001\u51cf\u5c11\u4f9d\u8d56\u3001\u51cf\u5c0f\u6587\u4ef6\u5927\u5c0f\u548c\u6784\u5efa\u65f6\u95f4\uff0c\u5e94\u8be5\u907f\u514d\u5b89\u88c5\u989d\u5916\u7684\u6216\u8005\u4e0d\u5fc5\u8981\u7684\u8f6f\u4ef6\u5305\u3002\u4f8b\u5982\uff0c\u4e0d\u8981\u5728\u6570\u636e\u5e93\u955c\u50cf\u4e2d\u5305\u542b\u4e00\u4e2a\u6587\u672c\u7f16\u8f91\u5668\u3002</p>"},{"location":"docker/dockerfile_practice/#_4","title":"\u5e94\u7528\u89e3\u8026","text":"<p>\u6bcf\u4e2a\u5bb9\u5668\u5e94\u7528\u53ea\u5173\u5fc3\u4e00\u4e2a\u65b9\u9762\u7684\u4e8b\u60c5\u3002\u5c06\u591a\u4e2a\u5e94\u7528\u89e3\u8026\u5230\u4e0d\u540c\u5bb9\u5668\u4e2d\uff0c\u53ef\u4ee5\u66f4\u8f7b\u677e\u5730\u4fdd\u8bc1\u5bb9\u5668\u7684\u6a2a\u5411\u6269\u5c55\u548c\u590d\u7528\u3002\u4f8b\u5982\u4e00\u4e2a web \u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u5305\u542b\u4e09\u4e2a\u72ec\u7acb\u7684\u5bb9\u5668\uff1aweb\u5e94\u7528\u3001\u6570\u636e\u5e93\u3001\u7f13\u5b58\uff0c\u6bcf\u4e2a\u5bb9\u5668\u90fd\u662f\u72ec\u7acb\u7684\u955c\u50cf\uff0c\u5206\u5f00\u8fd0\u884c\u3002\u4f46\u8fd9\u5e76\u4e0d\u662f\u8bf4\u4e00\u4e2a\u5bb9\u5668\u5c31\u53ea\u80fd\u8dd1\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u56e0\u4e3a\u6709\u7684\u7a0b\u5e8f\u53ef\u80fd\u4f1a\u81ea\u884c\u4ea7\u751f\u5176\u4ed6\u8fdb\u7a0b\uff0c\u6bd4\u5982 Celery \u5c31\u53ef\u4ee5\u6709\u5f88\u591a\u4e2a\u5de5\u4f5c\u8fdb\u7a0b\u3002\u867d\u7136<code>\u6bcf\u4e2a\u5bb9\u5668\u8dd1\u4e00\u4e2a\u8fdb\u7a0b</code>\u662f\u4e00\u6761\u5f88\u597d\u7684\u6cd5\u5219\uff0c\u4f46\u8fd9\u5e76\u4e0d\u662f\u4e00\u6761\u786c\u6027\u7684\u89c4\u5b9a\u3002\u6211\u4eec\u4e3b\u8981\u662f\u5e0c\u671b\u4e00\u4e2a\u5bb9\u5668\u53ea\u5173\u6ce8\u4e00\u4ef6\u4e8b\u60c5\uff0c\u5c3d\u91cf\u4fdd\u6301\u5e72\u51c0\u548c\u6a21\u5757\u5316\u3002</p> <p>\u5982\u679c\u5bb9\u5668\u4e92\u76f8\u4f9d\u8d56\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 Docker \u5bb9\u5668\u7f51\u7edc \u6765\u628a\u8fd9\u4e9b\u5bb9\u5668\u8fde\u63a5\u8d77\u6765\uff0c\u6211\u4eec\u524d\u9762\u5df2\u7ecf\u8ddf\u5927\u5bb6\u8bb2\u89e3\u8fc7 Docker \u7684\u5bb9\u5668\u7f51\u7edc\u6a21\u5f0f\u3002</p>"},{"location":"docker/dockerfile_practice/#_5","title":"\u6700\u5c0f\u5316\u955c\u50cf\u5c42\u6570","text":"<p>\u5728\u5f88\u65e9\u4e4b\u524d\u7684\u7248\u672c\u4e2d\u5c3d\u91cf\u51cf\u5c11\u955c\u50cf\u5c42\u6570\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4e0d\u8fc7\u73b0\u5728\u7684\u7248\u672c\u5df2\u7ecf\u6709\u4e86\u4e00\u5b9a\u7684\u6539\u5584\u4e86\uff1a</p> <ul> <li>\u53ea\u6709 RUN\u3001COPY \u548c ADD \u6307\u4ee4\u4f1a\u521b\u5efa\u5c42\uff0c\u5176\u4ed6\u6307\u4ee4\u4f1a\u521b\u5efa\u4e34\u65f6\u7684\u4e2d\u95f4\u955c\u50cf\uff0c\u4f46\u662f\u4e0d\u4f1a\u76f4\u63a5\u589e\u52a0\u6784\u5efa\u7684\u955c\u50cf\u5927\u5c0f\u4e86\u3002</li> <li>\u591a\u9636\u6bb5\u6784\u5efa\u7684\u652f\u6301\uff0c\u5141\u8bb8\u6211\u4eec\u628a\u9700\u8981\u7684\u6570\u636e\u76f4\u63a5\u590d\u5236\u5230\u6700\u7ec8\u7684\u955c\u50cf\u4e2d\uff0c\u8fd9\u5c31\u5141\u8bb8\u6211\u4eec\u5728\u4e2d\u95f4\u9636\u6bb5\u5305\u542b\u4e00\u4e9b\u5de5\u5177\u6216\u8005\u8c03\u8bd5\u4fe1\u606f\u4e86\uff0c\u800c\u4e14\u4e0d\u4f1a\u589e\u52a0\u6700\u7ec8\u7684\u955c\u50cf\u5927\u5c0f\u3002</li> </ul>"},{"location":"docker/dockerfile_practice/#_6","title":"\u5bf9\u591a\u884c\u53c2\u6570\u6392\u5e8f","text":"<p>\u53ea\u8981\u6709\u53ef\u80fd\uff0c\u5c31\u5c06\u591a\u884c\u53c2\u6570\u6309\u5b57\u6bcd\u987a\u5e8f\u6392\u5e8f\u3002\u8fd9\u53ef\u4ee5\u5e2e\u52a9\u4f60\u907f\u514d\u91cd\u590d\u5305\u542b\u540c\u4e00\u4e2a\u5305\uff0c\u66f4\u65b0\u5305\u5217\u8868\u65f6\u4e5f\u66f4\u5bb9\u6613\uff0c\u4e5f\u66f4\u5bb9\u6613\u9605\u8bfb\u548c\u5ba1\u67e5\u3002\u5efa\u8bae\u5728\u53cd\u659c\u6760\u7b26\u53f7 <code>\\</code> \u4e4b\u524d\u6dfb\u52a0\u4e00\u4e2a\u7a7a\u683c\uff0c\u53ef\u4ee5\u589e\u52a0\u53ef\u8bfb\u6027\u3002\u6bd4\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\uff1a</p> <pre><code>RUN apt-get update &amp;&amp; apt-get install -y \\\\\n  bzr \\\\\n  cvs \\\\\n  git \\\\\n  mercurial \\\\\n  subversion\n</code></pre>"},{"location":"docker/dockerfile_practice/#dockerfile_1","title":"Dockerfile \u6307\u4ee4","text":"<p>\u5173\u4e8e\u8fd9\u4e9b\u6307\u4ee4\u7684\u4f7f\u7528\u5efa\u8bae\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u521b\u5efa\u9ad8\u6548\u4e14\u53ef\u7ef4\u62a4\u7684 Dockerfile\u3002</p>"},{"location":"docker/dockerfile_practice/#from","title":"FROM \u6307\u4ee4","text":"<p>\u524d\u9762\u5df2\u7ecf\u4ecb\u7ecd\u8fc7\uff0c\u5c3d\u53ef\u80fd\u4f7f\u7528\u5f53\u524d\u7684\u5b98\u65b9\u955c\u50cf\u4f5c\u4e3a\u57fa\u7840\u955c\u50cf\u3002\u6211\u4eec\u5efa\u8bae\u4f7f\u7528<code>Alpine</code>\u6620\u50cf\uff0c\u56e0\u4e3a\u5b83\u53d7\u5230\u4e25\u683c\u63a7\u5236\u4e14\u8f83\u5c0f\uff08\u5f53\u524d\u5c0f\u4e8e5 MB\uff09\uff0c\u540c\u65f6\u4ecd\u662f\u5b8c\u6574\u7684 Linux \u53d1\u884c\u7248\u3002</p>"},{"location":"docker/dockerfile_practice/#label","title":"LABEL \u6807\u7b7e","text":"<p>\u4f60\u53ef\u4ee5\u7ed9\u955c\u50cf\u6dfb\u52a0\u6807\u7b7e\u6765\u5e2e\u52a9\u7ec4\u7ec7\u955c\u50cf\u3001\u8bb0\u5f55\u8bb8\u53ef\u4fe1\u606f\u3001\u8f85\u52a9\u81ea\u52a8\u5316\u6784\u5efa\u7b49\u3002\u6bcf\u4e2a\u6807\u7b7e\u4e00\u884c\uff0c\u7531 LABEL \u5f00\u5934\u52a0\u4e0a\u4e00\u4e2a\u6216\u591a\u4e2a\u6807\u7b7e\u5bf9\u3002</p> <p>\u4e0b\u9762\u7684\u793a\u4f8b\u5c55\u793a\u4e86\u5404\u79cd\u4e0d\u540c\u7684\u53ef\u80fd\u683c\u5f0f\u3002<code>#</code>\u5f00\u5934\u7684\u884c\u662f\u6ce8\u91ca\u5185\u5bb9\u3002</p> <p>\u6ce8\u610f</p> <p>\u5982\u679c\u4f60\u7684\u5b57\u7b26\u4e32\u5305\u542b\u7a7a\u683c\uff0c\u90a3\u4e48\u5b83\u5fc5\u987b\u88ab\u5f15\u7528\u6216\u8005\u7a7a\u683c\u5fc5\u987b\u88ab\u8f6c\u4e49\u3002\u5982\u679c\u60a8\u7684\u5b57\u7b26\u4e32\u5305\u542b\u5185\u90e8\u5f15\u53f7\u5b57\u7b26\uff08\"\uff09\uff0c\u5219\u4e5f\u53ef\u4ee5\u5c06\u5176\u8f6c\u4e49\u3002</p> <pre><code># Set one or more individual labels\nLABEL com.example.version=\"1-beta\"\nLABEL vendor=\"ACME Incorporated\"\nLABEL com.example.release-date=\"2015-02-12\"\nLABEL com.example.version.is-production=\"\"\n</code></pre> <p>\u4e00\u4e2a\u955c\u50cf\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u6807\u7b7e\uff0c\u5f53\u7136\u4ee5\u4e0a\u5185\u5bb9\u4e5f\u53ef\u4ee5\u5199\u6210\u4e0b\u9762\u8fd9\u6837\uff0c\u4f46\u662f\u4e0d\u662f\u5fc5\u987b\u7684\uff1a</p> <pre><code># Set multiple labels at once, using line-continuation characters to break long lines\nLABEL vendor=ACME\\\\ Incorporated \\\\\n      com.example.is-production=\"\" \\\\\n      com.example.version=\"1-beta\" \\\\\n      com.example.release-date=\"2015-02-12\"\n</code></pre>"},{"location":"docker/dockerfile_practice/#run","title":"RUN \u6307\u4ee4","text":"<p>\u4e3a\u4e86\u4fdd\u6301 Dockerfile \u6587\u4ef6\u7684\u53ef\u8bfb\u6027\uff0c\u4ee5\u53ca\u53ef\u7ef4\u62a4\u6027\uff0c\u5efa\u8bae\u5c06\u957f\u7684\u6216\u590d\u6742\u7684 RUN \u6307\u4ee4\u7528\u53cd\u659c\u6760<code>\\</code>\u5206\u5272\u6210\u591a\u884c\u3002</p> <p>RUN \u6307\u4ee4\u6700\u5e38\u89c1\u7684\u7528\u6cd5\u662f\u5b89\u88c5\u5305\u7528\u7684 apt-get\u3002\u56e0\u4e3a<code>RUN apt-get</code>\u6307\u4ee4\u4f1a\u5b89\u88c5\u5305\uff0c\u6240\u4ee5\u6709\u51e0\u4e2a\u95ee\u9898\u9700\u8981\u6ce8\u610f\u3002</p> <ul> <li>\u4e0d\u8981\u4f7f\u7528 RUN apt-get upgrade \u6216 dist-upgrade\uff0c\u5982\u679c\u57fa\u7840\u955c\u50cf\u4e2d\u7684\u67d0\u4e2a\u5305\u8fc7\u65f6\u4e86\uff0c\u4f60\u5e94\u8be5\u8054\u7cfb\u5b83\u7684\u7ef4\u62a4\u8005\u3002\u5982\u679c\u4f60\u786e\u5b9a\u67d0\u4e2a\u7279\u5b9a\u7684\u5305\uff0c\u6bd4\u5982 foo\uff0c\u9700\u8981\u5347\u7ea7\uff0c\u4f7f\u7528 apt-get install -y foo \u5c31\u884c\uff0c\u8be5\u6307\u4ee4\u4f1a\u81ea\u52a8\u5347\u7ea7 foo \u5305\u3002</li> <li> <p>\u6c38\u8fdc\u5c06 RUN apt-get update \u548c apt-get install \u7ec4\u5408\u6210\u4e00\u6761 RUN \u58f0\u660e\uff0c\u4f8b\u5982\uff1a</p> <pre><code>RUN apt-get update &amp;&amp; apt-get install -y \\\\\n      package-bar \\\\\n      package-baz \\\\\n      package-foo\n</code></pre> </li> </ul> <p>\u5c06 apt-get update \u653e\u5728\u4e00\u6761\u5355\u72ec\u7684 RUN \u58f0\u660e\u4e2d\u4f1a\u5bfc\u81f4\u7f13\u5b58\u95ee\u9898\u4ee5\u53ca\u540e\u7eed\u7684 apt-get install \u5931\u8d25\u3002\u6bd4\u5982\uff0c\u5047\u8bbe\u4f60\u6709\u4e00\u4e2a Dockerfile \u6587\u4ef6\uff1a</p> <pre><code>FROM ubuntu:04\nRUN apt-get update\nRUN apt-get install -y curl\n</code></pre> <p>\u6784\u5efa\u955c\u50cf\u540e\uff0c\u6240\u6709\u7684\u5c42\u90fd\u5728 Docker \u7684\u7f13\u5b58\u4e2d\u3002\u5047\u8bbe\u4f60\u540e\u6765\u53c8\u4fee\u6539\u4e86\u5176\u4e2d\u7684 apt-get install \u6dfb\u52a0\u4e86\u4e00\u4e2a\u5305\uff1a</p> <pre><code>FROM ubuntu:04\nRUN apt-get update\nRUN apt-get install -y curl nginx\n</code></pre> <p>Docker \u53d1\u73b0\u4fee\u6539\u540e\u7684 RUN apt-get update \u6307\u4ee4\u548c\u4e4b\u524d\u7684\u5b8c\u5168\u4e00\u6837\u3002\u6240\u4ee5\uff0capt-get update \u4e0d\u4f1a\u6267\u884c\uff0c\u800c\u662f\u4f7f\u7528\u4e4b\u524d\u7684\u7f13\u5b58\u955c\u50cf\u3002\u56e0\u4e3a apt-get update \u6ca1\u6709\u8fd0\u884c\uff0c\u540e\u9762\u7684 apt-get install \u53ef\u80fd\u5b89\u88c5\u7684\u662f\u8fc7\u65f6\u7684 curl \u548c nginx \u7248\u672c\u3002</p> <p>\u4f7f\u7528</p> <pre><code>RUN apt-get update &amp;&amp; apt-get install -y\n</code></pre> <p>\u53ef\u4ee5\u786e\u4fdd\u4f60\u7684 Dockerfiles \u6bcf\u6b21\u5b89\u88c5\u7684\u90fd\u662f\u5305\u7684\u6700\u65b0\u7684\u7248\u672c\uff0c\u800c\u4e14\u8fd9\u4e2a\u8fc7\u7a0b\u4e0d\u9700\u8981\u8fdb\u4e00\u6b65\u7684\u7f16\u7801\u6216\u989d\u5916\u5e72\u9884\u3002\u8fd9\u9879\u6280\u672f\u53eb\u4f5c<code>cache busting(\u7f13\u5b58\u7834\u574f)</code>\u3002</p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a RUN \u6307\u4ee4\u7684\u793a\u4f8b\u6a21\u677f\uff0c\u5c55\u793a\u4e86\u6240\u6709\u5173\u4e8e apt-get \u7684\u5efa\u8bae\uff1a</p> <pre><code>RUN apt-get update &amp;&amp; apt-get install -y \\\\\n    aufs-tools \\\\\n    automake \\\\\n    build-essential \\\\\n    curl \\\\\n    dpkg-sig \\\\\n    libcap-dev \\\\\n    libsqlite3-dev \\\\\n    mercurial \\\\\n    reprepro \\\\\n    ruby1 \\\\\n    ruby1-dev \\\\\n    s3cmd=* \\\\\n # \u5176\u4ed6\u64cd\u4f5c\n &amp;&amp; rm -rf /var/lib/apt/lists/*\n</code></pre> <p>\u5176\u4e2d s3cmd \u6307\u4ee4\u6307\u5b9a\u4e86\u4e00\u4e2a\u7248\u672c\u53f7 1.1.*\u3002\u5982\u679c\u4e4b\u524d\u7684\u955c\u50cf\u4f7f\u7528\u7684\u662f\u66f4\u65e7\u7684\u7248\u672c\uff0c\u6307\u5b9a\u65b0\u7684\u7248\u672c\u4f1a\u5bfc\u81f4 apt-get udpate \u7f13\u5b58\u5931\u6548\u5e76\u786e\u4fdd\u5b89\u88c5\u7684\u662f\u65b0\u7248\u672c\u3002 \u53e6\u5916\uff0c\u6e05\u7406\u6389 apt \u7f13\u5b58 var/lib/apt/lists \u53ef\u4ee5\u51cf\u5c0f\u955c\u50cf\u5927\u5c0f\u3002\u56e0\u4e3a RUN \u6307\u4ee4\u7684\u5f00\u5934\u4e3a apt-get udpate\uff0c\u5305\u7f13\u5b58\u603b\u662f\u4f1a\u5728 apt-get install \u4e4b\u524d\u5237\u65b0\u3002</p>"},{"location":"docker/dockerfile_practice/#expose","title":"EXPOSE \u6307\u4ee4","text":"<p><code>EXPOSE</code> \u6307\u4ee4\u7528\u4e8e\u6307\u5b9a\u5bb9\u5668\u5c06\u8981\u76d1\u542c\u7684\u7aef\u53e3\u3002\u56e0\u6b64\uff0c\u4f60\u5e94\u8be5\u4e3a\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\u5e38\u89c1\u7684\u7aef\u53e3\u3002</p> <p>\u4f8b\u5982\uff0c\u63d0\u4f9b Apache web \u670d\u52a1\u7684\u955c\u50cf\u5e94\u8be5\u4f7f\u7528 EXPOSE 80\uff0c\u800c\u63d0\u4f9b MongoDB \u670d\u52a1\u7684\u955c\u50cf\u4f7f\u7528 EXPOSE 27017\u3002</p> <p>\u5bf9\u4e8e\u5916\u90e8\u8bbf\u95ee\uff0c\u7528\u6237\u53ef\u4ee5\u5728\u6267\u884c docker run \u65f6\u4f7f\u7528\u4e00\u4e2a <code>-p</code> \u53c2\u6570\u6765\u6307\u793a\u5982\u4f55\u5c06\u6307\u5b9a\u7684\u7aef\u53e3\u6620\u5c04\u5230\u6240\u9009\u62e9\u7684\u7aef\u53e3\u3002</p>"},{"location":"docker/dockerfile_practice/#env","title":"ENV \u6307\u4ee4","text":"<p>\u4e3a\u4e86\u65b9\u4fbf\u65b0\u7a0b\u5e8f\u8fd0\u884c\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>ENV</code> \u6307\u4ee4\u6765\u4e3a\u5bb9\u5668\u4e2d\u5b89\u88c5\u7684\u7a0b\u5e8f\u66f4\u65b0 PATH \u73af\u5883\u53d8\u91cf\u3002\u4f8b\u5982\u4f7f\u7528</p> <pre><code>ENV PATH /usr/local/nginx/bin:$PATH\n</code></pre> <p>\u6765\u786e\u4fdd<code>CMD [\"nginx\"]</code>\u80fd\u6b63\u786e\u8fd0\u884c\u3002</p> <p>ENV \u6307\u4ee4\u4e5f\u53ef\u7528\u4e8e\u4e3a\u4f60\u60f3\u8981\u5bb9\u5668\u5316\u7684\u670d\u52a1\u63d0\u4f9b\u5fc5\u8981\u7684\u73af\u5883\u53d8\u91cf\uff0c\u6bd4\u5982 Postgres \u9700\u8981\u7684 PGDATA\u3002 \u6700\u540e\uff0cENV \u4e5f\u80fd\u7528\u4e8e\u8bbe\u7f6e\u5e38\u89c1\u7684\u7248\u672c\u53f7\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u793a\u4f8b\uff1a</p> <pre><code>ENV PG_MAJOR 3\nENV PG_VERSION 4\nRUN curl -SL http://example.com/postgres-$PG_VERSION.tar.xz | tar -xJC /usr/src/postgress &amp;&amp; \u2026\nENV PATH /usr/local/postgres-$PG_MAJOR/bin:$PATH\n</code></pre> <p>\u7c7b\u4f3c\u4e8e\u7a0b\u5e8f\u4e2d\u7684\u5e38\u91cf\uff0c\u8fd9\u79cd\u65b9\u6cd5\u53ef\u4ee5\u8ba9\u4f60\u53ea\u9700\u6539\u53d8 ENV \u6307\u4ee4\u6765\u81ea\u52a8\u7684\u6539\u53d8\u5bb9\u5668\u4e2d\u7684\u8f6f\u4ef6\u7248\u672c\u3002</p>"},{"location":"docker/dockerfile_practice/#volume","title":"VOLUME \u6307\u4ee4","text":"<p><code>VOLUME</code> \u6307\u4ee4\u7528\u4e8e\u66b4\u9732\u4efb\u4f55\u6570\u636e\u5e93\u5b58\u50a8\u6587\u4ef6\uff0c\u914d\u7f6e\u6587\u4ef6\uff0c\u6216\u5bb9\u5668\u521b\u5efa\u7684\u6587\u4ef6\u548c\u76ee\u5f55\u3002\u5f3a\u70c8\u5efa\u8bae\u4f7f\u7528 <code>VOLUME</code> \u6765\u7ba1\u7406\u955c\u50cf\u4e2d\u7684\u53ef\u53d8\u90e8\u5206\u548c\u7528\u6237\u53ef\u4ee5\u6539\u53d8\u7684\u90e8\u5206\u3002</p>"},{"location":"docker/dockerfile_practice/#user","title":"USER \u6307\u4ee4","text":"<p>\u5982\u679c\u67d0\u4e2a\u670d\u52a1\u4e0d\u9700\u8981\u7279\u6743\u6267\u884c\uff0c\u5efa\u8bae\u4f7f\u7528 USER \u6307\u4ee4\u5207\u6362\u5230\u975e root \u7528\u6237\u3002\u5148\u5728 Dockerfile \u4e2d\u4f7f\u7528\u7c7b\u4f3c </p> <pre><code>RUN groupadd -r postgres &amp;&amp; useradd -r -g postgres postgres\n</code></pre> <p>\u7684\u6307\u4ee4\u521b\u5efa\u7528\u6237\u548c\u7528\u6237\u7ec4\u3002</p> <p>\u6ce8\u610f</p> <p>\u5728\u955c\u50cf\u4e2d\uff0c\u7528\u6237\u548c\u7528\u6237\u7ec4\u6bcf\u6b21\u88ab\u5206\u914d\u7684 UID/GID \u90fd\u662f\u4e0d\u786e\u5b9a\u7684\uff0c\u4e0b\u6b21\u91cd\u65b0\u6784\u5efa\u955c\u50cf\u65f6\u88ab\u5206\u914d\u5230\u7684 UID/GID \u53ef\u80fd\u4f1a\u4e0d\u4e00\u6837\u3002\u5982\u679c\u8981\u4f9d\u8d56\u786e\u5b9a\u7684 UID/GID\uff0c\u4f60\u5e94\u8be5\u663e\u793a\u7684\u6307\u5b9a\u4e00\u4e2a UID/GID\u3002</p> <p>\u4f60\u5e94\u8be5\u907f\u514d\u4f7f\u7528 sudo\uff0c\u56e0\u4e3a\u5b83\u4e0d\u53ef\u9884\u671f\u7684 TTY \u548c\u4fe1\u53f7\u8f6c\u53d1\u884c\u4e3a\u53ef\u80fd\u9020\u6210\u7684\u95ee\u9898\u6bd4\u5b83\u80fd\u89e3\u51b3\u7684\u95ee\u9898\u8fd8\u591a\u3002\u5982\u679c\u4f60\u771f\u7684\u9700\u8981\u548c sudo \u7c7b\u4f3c\u7684\u529f\u80fd\uff08\u4f8b\u5982\uff0c\u4ee5 root \u6743\u9650\u521d\u59cb\u5316\u67d0\u4e2a\u5b88\u62a4\u8fdb\u7a0b\uff0c\u4ee5\u975e root \u6743\u9650\u6267\u884c\u5b83\uff09\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>gosu</code>\u3002\u6211\u4eec\u53ef\u4ee5\u53bb\u67e5\u770b\u5b98\u65b9\u7684\u4e00\u4e9b\u955c\u50cf\uff0c\u5f88\u591a\u90fd\u662f\u4f7f\u7528\u7684 <code>gosu</code>\u3002</p> <p>\u4e3a\u4e86\u51cf\u5c11\u5c42\u6570\u548c\u590d\u6742\u5ea6\uff0c\u907f\u514d\u9891\u7e41\u5730\u4f7f\u7528 USER \u6765\u56de\u5207\u6362\u7528\u6237\u3002</p>"},{"location":"docker/dockerfile_practice/#workdir","title":"WORKDIR \u6307\u4ee4","text":"<p>\u4e3a\u4e86\u6e05\u6670\u6027\u548c\u53ef\u9760\u6027\uff0c\u4f60\u5e94\u8be5\u603b\u662f\u5728 <code>WORKDIR</code> \u4e2d\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\u3002\u53e6\u5916\uff0c\u4f60\u5e94\u8be5\u4f7f\u7528 WORKDIR \u6765\u66ff\u4ee3\u7c7b\u4f3c\u4e8e </p> <pre><code>RUN cd ... &amp;&amp; do-something\n</code></pre> <p>\u7684\u6307\u4ee4\uff0c\u540e\u8005\u96be\u4ee5\u9605\u8bfb\u3001\u6392\u9519\u548c\u7ef4\u62a4\u3002</p>"},{"location":"docker/dockerfile_practice/#copy_add","title":"COPY \u548c ADD \u6307\u4ee4","text":"<p>\u867d\u7136 <code>ADD</code> \u548c <code>COPY</code> \u529f\u80fd\u7c7b\u4f3c\uff0c\u4f46\u4e00\u822c\u4f18\u5148\u4f7f\u7528 <code>COPY</code>\u3002\u56e0\u4e3a\u5b83\u6bd4 <code>ADD</code> \u66f4\u900f\u660e\u3002COPY \u53ea\u652f\u6301\u7b80\u5355\u5c06\u672c\u5730\u6587\u4ef6\u62f7\u8d1d\u5230\u5bb9\u5668\u4e2d\uff0c\u800c ADD \u6709\u4e00\u4e9b\u5e76\u4e0d\u660e\u663e\u7684\u529f\u80fd\uff08\u6bd4\u5982\u672c\u5730 tar \u63d0\u53d6\u548c\u8fdc\u7a0b URL \u652f\u6301\uff09\u3002\u56e0\u6b64\uff0cADD \u7684\u6700\u4f73\u7528\u4f8b\u662f\u5c06\u672c\u5730 tar \u6587\u4ef6\u81ea\u52a8\u63d0\u53d6\u5230\u955c\u50cf\u4e2d\uff0c\u4f8b\u5982<code>ADD rootfs.tar.xz</code>\u3002</p> <p>\u5982\u679c\u4f60\u7684 Dockerfile \u6709\u591a\u4e2a\u6b65\u9aa4\u9700\u8981\u4f7f\u7528\u4e0a\u4e0b\u6587\u4e2d\u4e0d\u540c\u7684\u6587\u4ef6\u3002\u5355\u72ec COPY \u6bcf\u4e2a\u6587\u4ef6\uff0c\u800c\u4e0d\u662f\u4e00\u6b21\u6027\u7684 COPY \u6240\u6709\u6587\u4ef6\uff0c\u8fd9\u5c06\u4fdd\u8bc1\u6bcf\u4e2a\u6b65\u9aa4\u7684\u6784\u5efa\u7f13\u5b58\u53ea\u5728\u7279\u5b9a\u7684\u6587\u4ef6\u53d8\u5316\u65f6\u5931\u6548\u3002\u4f8b\u5982\uff1a</p> <pre><code>COPY requirements.txt /tmp/\nRUN pip install --requirement /tmp/requirements.txt\nCOPY . /tmp/\n</code></pre> <p>\u5982\u679c\u5c06COPY . /tmp/\u653e\u7f6e\u5728 RUN \u6307\u4ee4\u4e4b\u524d\uff0c\u53ea\u8981 . \u76ee\u5f55\u4e2d\u4efb\u4f55\u4e00\u4e2a\u6587\u4ef6\u53d8\u5316\uff0c\u90fd\u4f1a\u5bfc\u81f4\u540e\u7eed\u6307\u4ee4\u7684\u7f13\u5b58\u5931\u6548\u3002</p> <p>\u4e3a\u4e86\u8ba9\u955c\u50cf\u5c3d\u91cf\u5c0f\uff0c\u6700\u597d\u4e0d\u8981\u4f7f\u7528 ADD \u6307\u4ee4\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u5305\uff0c\u800c\u662f\u4f7f\u7528 curl \u548c wget\u3002\u8fd9\u6837\u4f60\u53ef\u4ee5\u5728\u6587\u4ef6\u63d0\u53d6\u5b8c\u4e4b\u540e\u5220\u6389\u4e0d\u518d\u9700\u8981\u7684\u6587\u4ef6\u6765\u907f\u514d\u5728\u955c\u50cf\u4e2d\u989d\u5916\u6dfb\u52a0\u4e00\u5c42\u3002\u6bd4\u5982\u5c3d\u91cf\u907f\u514d\u4e0b\u9762\u7684\u7528\u6cd5\uff1a</p> <pre><code>ADD http://example.com/big.tar.xz /usr/src/things/\nRUN tar -xJf /usr/src/things/big.tar.xz -C /usr/src/things\nRUN make -C /usr/src/things all\n</code></pre> <p>\u800c\u662f\u5e94\u8be5\u4f7f\u7528\u4e0b\u9762\u8fd9\u79cd\u65b9\u6cd5\uff1a</p> <pre><code>RUN mkdir -p /usr/src/things \\\\\n    &amp;&amp; curl -SL http://example.com/big.tar.xz \\\\\n    | tar -xJC /usr/src/things \\\\\n    &amp;&amp; make -C /usr/src/things all\n</code></pre> <p>\u4e0a\u9762\u4f7f\u7528\u7684\u7ba1\u9053\u64cd\u4f5c\uff0c\u6240\u4ee5\u6ca1\u6709\u4e2d\u95f4\u6587\u4ef6\u9700\u8981\u5220\u9664\u3002\u5bf9\u4e8e\u5176\u4ed6\u4e0d\u9700\u8981 ADD \u7684\u81ea\u52a8\u63d0\u53d6\u529f\u80fd\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u4f60\u5e94\u8be5\u4f7f\u7528 COPY\u3002</p>"},{"location":"docker/dockerfile_practice/#cmd_entrypoint","title":"CMD \u4e0e ENTRYPOINT \u6307\u4ee4","text":"<p>\u5c3d\u7ba1 ENTRYPOINT \u548c CMD \u90fd\u662f\u5728\u5bb9\u5668\u91cc\u6267\u884c\u4e00\u6761\u547d\u4ee4, \u4f46\u662f\u4ed6\u4eec\u6709\u4e00\u4e9b\u5fae\u5999\u7684\u533a\u522b\uff0c\u5728\u7edd\u5927\u591a\u6570\u60c5\u51b5\u4e0b, \u4f60\u53ea\u8981\u5728\u8fd92\u8005\u4e4b\u95f4\u9009\u62e9\u4e00\u4e2a\u8c03\u7528\u5c31\u53ef\u4ee5\uff0c\u4f46\u662f\u6211\u4eec\u8fd8\u662f\u975e\u5e38\u6709\u5fc5\u8981\u6765\u8ba4\u771f\u4e86\u89e3\u4e0b\u4e8c\u8005\u7684\u533a\u522b\u3002</p>"},{"location":"docker/dockerfile_practice/#cmd","title":"CMD \u6307\u4ee4","text":"<p><code>CMD</code> \u6307\u4ee4\u662f\u5bb9\u5668\u542f\u52a8\u4ee5\u540e\uff0c<code>\u9ed8\u8ba4</code>\u7684\u6267\u884c\u547d\u4ee4\uff0c\u9700\u8981\u91cd\u70b9\u7406\u89e3\u4e0b\u8fd9\u4e2a\u9ed8\u8ba4\u7684\u542b\u4e49\uff0c\u610f\u601d\u5c31\u662f\u5982\u679c\u6211\u4eec\u6267\u884c <code>docker run</code> \u6ca1\u6709\u6307\u5b9a\u4efb\u4f55\u7684\u6267\u884c\u547d\u4ee4\u6216\u8005 Dockerfile \u91cc\u9762\u4e5f\u6ca1\u6709\u6307\u5b9a ENTRYPOINT\uff0c\u90a3\u4e48\u5c31\u4f1a\u4f7f\u7528 CMD \u6307\u5b9a\u7684\u6267\u884c\u547d\u4ee4\u6267\u884c\u4e86\u3002\u8fd9\u4e5f\u8bf4\u660e\u4e86 ENTRYPOINT \u624d\u662f\u5bb9\u5668\u542f\u52a8\u4ee5\u540e\u771f\u6b63\u8981\u6267\u884c\u7684\u547d\u4ee4\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u7ecf\u5e38\u9047\u5230 <code>CMD \u4f1a\u88ab\u8986\u76d6</code> \u7684\u60c5\u51b5\uff0c\u4e3a\u4ec0\u4e48\u4f1a\u88ab\u8986\u76d6\u5462\uff1f\u4e3b\u8981\u8fd8\u662f\u56e0\u4e3a CMD \u7684\u5b9a\u4f4d\u5c31\u662f\u9ed8\u8ba4\uff0c\u5982\u679c\u4e0d\u989d\u5916\u6307\u5b9a\uff0c\u90a3\u4e48\u624d\u4f1a\u6267\u884c CMD \u547d\u4ee4\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u6307\u5b9a\u4e86\u7684\u8bdd\u90a3\u5c31\u4e0d\u4f1a\u6267\u884c CMD \u547d\u4ee4\u4e86\uff0c\u4e5f\u5c31\u662f\u8bf4 CMD \u4f1a\u88ab\u8986\u76d6\u3002</p> <p>CMD \u603b\u5171\u6709\u4e09\u79cd\u7528\u6cd5\uff1a</p> <pre><code>CMD [\"executable\", \"param1\", \"param2\"]  # exec \u5f62\u5f0f\nCMD [\"param1\", \"param2\"] # \u4f5c\u4e3a ENTRYPOINT \u7684\u9ed8\u8ba4\u53c2\u6570\nCMD command param1 param2  # shell \u5f62\u5f0f\n</code></pre> <p>\u5176\u4e2d shell \u5f62\u5f0f\uff0c\u5c31\u662f\u6ca1\u6709\u4e2d\u62ec\u53f7\u7684\u5f62\u5f0f\uff0c\u547d\u4ee4 command \u9ed8\u8ba4\u662f\u5728<code>/bin/sh -c</code>\u4e0b\u6267\u884c\u7684\uff0c\u6bd4\u5982\uff1a</p> <pre><code>FROM busybox\n\nCMD echo \"hello cmd shell form!\"\n</code></pre> <p>\u6211\u4eec\u5c06\u4e0a\u9762\u7684 Dockerfile \u6253\u5305\u6210 cmdshell \u955c\u50cf\uff0c\u7136\u540e\u76f4\u63a5\u542f\u52a8\u4e00\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>$ docker build -t cmdshell .\nSending build context to Docker daemon  048kB\nStep 1/2 : FROM busybox\n ---&gt; 020584afccce\nStep 2/2 : CMD echo \"hello cmd shell form!\"\n ---&gt; Running in 651afaddb83d\nRemoving intermediate container 651afaddb83d\n ---&gt; d26e4d6d9cdf\nSuccessfully built d26e4d6d9cdf\nSuccessfully tagged cmdshell:latest\n$ docker run cmdshell\nhello cmd shell form!\n</code></pre> <p>\u5bf9\u4e8e\u5e26\u6709\u4e2d\u62ec\u53f7\u7684 exec \u5f62\u5f0f\uff0c\u547d\u4ee4\u6ca1\u6709\u5728\u4efb\u4f55 shell \u7ec8\u7aef\u73af\u5883\u4e0b\uff0c\u5982\u679c\u6211\u4eec\u8981\u6267\u884c shell\uff0c\u5fc5\u987b\u628a shell \u52a0\u5165\u5230\u4e2d\u62ec\u53f7\u7684\u53c2\u6570\u4e2d\u3002\u5c06\u4e0a\u9762\u7684\u4f8b\u5b50\u4fee\u6539\u4e3a\uff1a</p> <pre><code>FROM busybox\n\nCMD [\"/bin/sh\", \"-c\", \"echo 'hello cmd exec form!'\"]\n</code></pre> <p>\u540c\u6837\u5c06\u4e0a\u9762\u7684 Dockerfile \u6253\u5305\u6210 cmdexec \u955c\u50cf\uff0c\u7136\u540e\u76f4\u63a5\u542f\u52a8\u4e00\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>$ docker build -t cmdexec .\nSending build context to Docker daemon  048kB\nStep 1/2 : FROM busybox\n ---&gt; 020584afccce\nStep 2/2 : CMD [\"/bin/sh\", \"-c\", \"echo 'hello cmd exec form!'\"]\n ---&gt; Running in 8c72d5e2ce35\nRemoving intermediate container 8c72d5e2ce35\n ---&gt; c393bd1ab3c1\nSuccessfully built c393bd1ab3c1\nSuccessfully tagged cmdexec:latest\n$ docker run cmdexec\nhello cmd exec form!\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\uff0c\u91c7\u7528 exec \u5f62\u5f0f\uff0c\u7b2c\u4e00\u4e2a\u53c2\u6570\u5fc5\u987b\u662f\u547d\u4ee4\u7684<code>\u5168\u8def\u5f84</code>\u624d\u884c\u3002\u4e00\u4e2a Dockerfile \u5982\u679c\u6709\u591a\u4e2a CMD\uff0c\u53ea\u6709\u6700\u540e\u4e00\u4e2a\u751f\u6548\uff0c\u5b98\u7f51\u63a8\u8350\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002</p> <p>\u5f53\u7136\uff0c\u4ee5\u4e0a\u90fd\u662f\u4f53\u73b0\u4e86 CMD \u7684 <code>\u9ed8\u8ba4</code> \u884c\u4e3a\u3002\u5982\u679c\u6211\u4eec\u5728 run \u65f6\u6307\u5b9a\u4e86\u547d\u4ee4\u6216\u8005\u6709 ENTRYPOINT CMD \u5c31\u4f1a\u88ab\u8986\u76d6\u3002\u6bd4\u5982\u540c\u6837\u7528\u4e0a\u9762\u4e24\u4e2a\u955c\u50cf\uff0c\u5728\u8fd0\u884c\u7684\u65f6\u5019\u6307\u5b9a\u4e00\u4e2a\u547d\u4ee4\uff1a</p> <pre><code>$ docker run cmdexec echo 'hello docker'\nhello docker\n$ docker run cmdshell echo 'hello docker'\nhello docker\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6700\u7ec8\u5bb9\u5668\u91cc\u9762\u6267\u884c\u7684\u662f run \u547d\u4ee4\u540e\u9762\u7684\u547d\u4ee4\uff0c\u800c\u4e0d\u662f CMD \u91cc\u9762\u5b9a\u4e49\u7684\u3002</p>"},{"location":"docker/dockerfile_practice/#entrypoint","title":"ENTRYPOINT \u6307\u4ee4","text":"<p>\u6839\u636e\u5b98\u65b9\u5b9a\u4e49\u6765\u8bf4 <code>ENTRYPOINT</code> \u624d\u662f\u7528\u4e8e\u5b9a\u4e49\u5bb9\u5668\u542f\u52a8\u4ee5\u540e\u7684\u6267\u884c\u7a0b\u5e8f\u7684\uff0c\u5141\u8bb8\u5c06\u955c\u50cf\u5f53\u6210\u547d\u4ee4\u672c\u8eab\u6765\u8fd0\u884c\uff08\u7528 CMD \u63d0\u4f9b\u9ed8\u8ba4\u9009\u9879\uff09\uff0c\u4ece\u540d\u5b57\u4e5f\u53ef\u4ee5\u7406\u89e3\uff0c\u662f\u5bb9\u5668\u7684<code>\u5165\u53e3</code>\u3002ENTRYPOINT \u4e00\u5171\u6709\u4e24\u79cd\u7528\u6cd5\uff1a</p> <pre><code>ENTRYPOINT [\"executable\", \"param1\", \"param2\"] (exec \u5f62\u5f0f)\nENTRYPOINT command param1 param2 (shell \u5f62\u5f0f)\n</code></pre> <p>\u5bf9\u5e94\u547d\u4ee4\u884c exec \u6a21\u5f0f\uff0c\u4e5f\u5c31\u662f\u5e26\u4e2d\u62ec\u53f7\u7684\u3002\u548c CMD \u7684\u4e2d\u62ec\u53f7\u5f62\u5f0f\u662f\u4e00\u81f4\u7684\uff0c\u4f46\u662f\u8fd9\u91cc\u8c8c\u4f3c\u662f\u5728shell\u7684\u73af\u5883\u4e0b\u6267\u884c\u7684\uff0c\u4e0ecmd\u6709\u533a\u522b\u3002\u5982\u679c run \u547d\u4ee4\u540e\u9762\u6709\u6267\u884c\u547d\u4ee4\uff0c\u90a3\u4e48\u540e\u9762\u7684\u5168\u90e8\u90fd\u4f1a\u4f5c\u4e3a ENTRYPOINT \u7684\u53c2\u6570\u3002\u5982\u679c run \u540e\u9762\u6ca1\u6709\u989d\u5916\u7684\u547d\u4ee4\uff0c\u4f46\u662f\u5b9a\u4e49\u4e86 CMD\uff0c\u90a3\u4e48 CMD \u7684\u5168\u90e8\u5185\u5bb9\u5c31\u4f1a\u4f5c\u4e3a ENTRYPOINT \u7684\u53c2\u6570\uff0c\u8fd9\u540c\u65f6\u662f\u4e0a\u9762\u6211\u4eec\u63d0\u5230\u7684 CMD \u7684\u7b2c\u4e8c\u79cd\u7528\u6cd5\u3002\u6240\u4ee5\u8bf4 ENTRYPOINT \u4e0d\u4f1a\u88ab\u8986\u76d6\u3002\u5f53\u7136\u5982\u679c\u8981\u5728 run \u91cc\u9762\u8986\u76d6\uff0c\u4e5f\u662f\u6709\u529e\u6cd5\u7684\uff0c\u4f7f\u7528<code>--entrypoint</code>\u53c2\u6570\u5373\u53ef\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u5b9a\u4e49\u5982\u4e0b\u7684 Dockerfile\uff1a</p> <pre><code>FROM busybox\n\nCMD [\"I am in cmd exec form\"]\nENTRYPOINT [\"echo\"]\n</code></pre> <p>\u5c06\u4e0a\u9762\u7684 Dockerfile \u6253\u5305\u6210\u955c\u50cf entrypointest\uff0c\u7136\u540e\u76f4\u63a5\u8fd0\u884c\uff0c\u4e0d\u5e26\u4efb\u4f55\u53c2\u6570\uff1a</p> <pre><code>$ docker build -t entrypointest .\nSending build context to Docker daemon  048kB\nStep 1/3 : FROM busybox\n ---&gt; 020584afccce\nStep 2/3 : CMD [\"I am in cmd exec form\"]\n ---&gt; Running in 2d7b13b0dfe7\nRemoving intermediate container 2d7b13b0dfe7\n ---&gt; 903d739ead9a\nStep 3/3 : ENTRYPOINT [\"echo\"]\n ---&gt; Running in c61682ea476e\nRemoving intermediate container c61682ea476e\n ---&gt; 00b09a578d48\nSuccessfully built 00b09a578d48\nSuccessfully tagged entrypointest:latest\n$ docker run entrypointest\nI am in cmd exec form\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6253\u5370\u7684\u7ed3\u679c\u662f CMD \u91cc\u9762\u6307\u5b9a\u7684\u5185\u5bb9\uff0c\u4e5f\u5c31\u662f\u9ed8\u8ba4\u60c5\u51b5\u5c06 CMD \u90e8\u5206\u4f5c\u4e3a ENTRYPOINT \u7684\u53c2\u6570\u4e86\u3002\u4f46\u662f\u5982\u679c\u6211\u4eec\u5728\u8fd0\u884c\u5bb9\u5668\u7684\u65f6\u5019\u5982\u679c\u6307\u5b9a\u4e86\u8fd0\u884c\u53c2\u6570\u5462\uff1a</p> <pre><code>$ docker run entrypointest I am in run section\nI am in run section\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd0\u884c\u65f6\u6307\u5b9a\u7684\u53c2\u6570\u4f1a\u8986\u76d6\u6389 CMD \u63d0\u4f9b\u7684\u9ed8\u8ba4\u53c2\u6570\uff0c\u4f46\u662f\u9ed8\u8ba4\u90fd\u662f\u6267\u884c\u7684 ENTRYPOINT \u91cc\u9762\u7684\u547d\u4ee4\u3002</p> <p>\u5bf9\u4e8e shell \u6a21\u5f0f\u7684\uff0c\u4efb\u4f55 run \u548c CMD \u7684\u53c2\u6570\u90fd\u65e0\u6cd5\u88ab\u4f20\u5165\u5230 ENTRYPOINT \u91cc\u3002\u5b98\u7f51\u63a8\u8350\u7528\u4e0a\u9762\u4e00\u79cd\u7528\u6cd5\u3002\u6bd4\u5982\u6211\u4eec\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u4e00\u4e2a Dockerfile \u5982\u4e0b\uff1a</p> <pre><code>FROM busybox\n\nCMD [\"I am in cmd exec form and entrypoint shell form\"]\nENTRYPOINT echo\n</code></pre> <p>\u5c06\u4e0a\u9762 Dockerfile \u6253\u5305\u6210\u955c\u50cf entrypointshell\uff0c\u7136\u540e\u76f4\u63a5\u8fd0\u884c\uff1a</p> <pre><code>$ docker build -t entrypointshell .\nSending build context to Docker daemon  048kB\nStep 1/3 : FROM busybox\n ---&gt; 020584afccce\nStep 2/3 : CMD [\"I am in cmd exec form and entrypoint shell form\"]\n ---&gt; Running in 2aee7326f4cd\nRemoving intermediate container 2aee7326f4cd\n ---&gt; e89cadeeecd3\nStep 3/3 : ENTRYPOINT echo\n ---&gt; Running in f359c8bb5025\nRemoving intermediate container f359c8bb5025\n ---&gt; f9d4e1d1b0a0\nSuccessfully built f9d4e1d1b0a0\nSuccessfully tagged entrypointshell:latest\n$ docker run entrypointshell\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 CMD \u7684\u53c2\u6570\u5e76\u6ca1\u6709\u88ab\u6253\u5370\u51fa\u6765\uff0c\u5982\u679c\u5728\u8fd0\u884c\u7684\u65f6\u5019\u6dfb\u52a0\u4e0a\u53c2\u6570\u5462\uff1a</p> <pre><code>$ docker run entrypointshell I am in run section\n$\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u4e5f\u6ca1\u6709\u5c06 run \u547d\u4ee4\u540e\u9762\u7684\u53c2\u6570\u6253\u5370\u51fa\u6765\u3002\u6240\u4ee5\u4e00\u822c\u60c5\u51b5\u4e0b\u5bf9\u4e8e ENTRYPOINT \u6765\u8bf4\u4f7f\u7528\u4e2d\u62ec\u53f7\u7684 exec \u5f62\u5f0f\u66f4\u597d\u3002</p> <p>\u603b\u7ed3</p> <p>\u4e00\u822c\u4f1a\u7528 ENTRYPOINT \u7684\u4e2d\u62ec\u53f7\u5f62\u5f0f\u4f5c\u4e3a Docker \u5bb9\u5668\u542f\u52a8\u4ee5\u540e\u7684\u9ed8\u8ba4\u6267\u884c\u547d\u4ee4\uff0c\u91cc\u9762\u653e\u7684\u662f\u4e0d\u53d8\u7684\u90e8\u5206\uff0c\u53ef\u53d8\u90e8\u5206\u6bd4\u5982\u547d\u4ee4\u53c2\u6570\u53ef\u4ee5\u4f7f\u7528 CMD \u7684\u5f62\u5f0f\u63d0\u4f9b\u9ed8\u8ba4\u7248\u672c\uff0c\u4e5f\u5c31\u662f run \u91cc\u9762\u6ca1\u6709\u4efb\u4f55\u53c2\u6570\u65f6\u4f7f\u7528\u7684\u9ed8\u8ba4\u53c2\u6570\u3002\u5982\u679c\u6211\u4eec\u60f3\u7528\u9ed8\u8ba4\u53c2\u6570\uff0c\u5c31\u76f4\u63a5 run\uff0c\u5426\u5219\u60f3\u7528\u5176\u4ed6\u53c2\u6570\uff0c\u5c31 run \u91cc\u9762\u52a0\u4e0a\u53c2\u6570\u3002</p>"},{"location":"docker/dockerfile_practice/#_7","title":"\u5b98\u65b9\u4ed3\u5e93\u793a\u4f8b","text":"<p>\u8fd9\u4e9b\u5b98\u65b9\u4ed3\u5e93\u7684 Dockerfile \u90fd\u662f\u53c2\u8003\u5178\u8303\uff1ahttps://github.com/docker-library/docs\u3002</p>"},{"location":"docker/dockerfile_practice/#wordpress","title":"Wordpress \u793a\u4f8b","text":"<p>\u8fd9\u91cc\u6211\u4eec\u4ee5\u521b\u5efa\u4e00\u4e2a Wordpress \u955c\u50cf\u4e3a\u4f8b\uff0c\u6211\u4eec\u77e5\u9053\u9ed8\u8ba4\u60c5\u51b5\u4e0b Wordpress \u662f\u4f7f\u7528 MySQL \u6570\u636e\u5e93\u7684\uff0c\u5982\u679c\u4f7f\u7528 MySQL \u6570\u636e\u5e93\u7684\u4e0d\u5229\u4e8e\u6211\u4eec\u8fd9\u91cc\u7684\u6f14\u793a\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u7528 Sqlite \u6765\u4f5c\u4e3a Wordpress \u7684\u5b58\u50a8\u6570\u636e\u5e93\uff0c\u8981\u7f16\u5199\u4e00\u4e2a\u4f7f\u7528 Sqlite \u6570\u636e\u5e93\u7684 Wordpress \u955c\u50cf\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u660e\u767d\u5982\u679c\u4e0d\u4f7f\u7528\u955c\u50cf\u5e94\u8be5\u600e\u4e48\u6765\u90e8\u7f72\u8fd9\u6837\u7684\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u5426\u5219\u662f\u4e0d\u53ef\u80fd\u7f16\u5199\u51fa Dockerfile \u7684\u3002</p>"},{"location":"docker/dockerfile_practice/#wordpress_1","title":"\u83b7\u53d6 Wordpress","text":"<p>\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u83b7\u53d6\u5230 Wordpress \u7684\u7a0b\u5e8f\u5b89\u88c5\u5305\uff0c\u5730\u5740\uff1ahttps://wordpress.org/download/\uff0c\u4e0b\u8f7d\u6700\u65b0\u7684 Wordpress \u5b89\u88c5\u5305\u3002</p>"},{"location":"docker/dockerfile_practice/#sqlite","title":"\u83b7\u53d6 SQLite \u63d2\u4ef6","text":"<p>\u7531\u4e8e Wordpress \u9ed8\u8ba4\u4f7f\u7528\u7684\u662f MySQL \u6570\u636e\u5e93\uff0c\u5982\u679c\u8981\u4f7f\u7528 SQLite \u6570\u636e\u5e93\u7684\u8bdd\u9700\u8981\u4f7f\u7528 SQLite \u63d2\u4ef6\uff0c\u5730\u5740\uff1ahttps://wordpress.org/plugins/sqlite-integration/</p>"},{"location":"docker/dockerfile_practice/#_8","title":"\u5b89\u88c5\u6fc0\u6d3b\u63d2\u4ef6","text":"<p>\u5c06 SQLite \u63d2\u4ef6\u89e3\u538b\u653e\u7f6e\u5230 Wordpress \u6e90\u7801\u76ee\u5f55 <code>wp-content/plugins</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u7136\u540e\u62f7\u8d1d sqlite-integration \u76ee\u5f55\u4e0b\u9762\u7684 <code>db.php</code> \u6587\u4ef6\u5230 Wordpress \u7684 <code>wordpress/wp-content</code> \u76ee\u5f55\u4e0b\u9762\u3002</p> <p>\u7136\u540e\u91cd\u65b0\u5c06 </p> <pre><code>wordpress/wp-config-sample.php\n</code></pre> <p>\u91cd\u547d\u540d\u4e3a </p> <pre><code>wordpress/wp-config.php\n</code></pre> <p>\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5\u6587\u4ef6\u91cc\u9762\u7684\u4e00\u4e9b\u53c2\u6570\u6765\u914d\u7f6e\u6570\u636e\u5e93\u7684\u540d\u79f0\u548c\u4f4d\u7f6e\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6570\u636e\u5e93\u540d\u4e3a<code>.ht.sqlite</code>\uff0c\u5b58\u50a8\u5728 <code>wp-content/database/</code> \u76ee\u5f55\u4e2d\u3002</p> <p>\u7136\u540e\u5b89\u88c5\u4e0a Wordpress \u8fd0\u884c\u7684\u4e00\u4e9b\u73af\u5883\u6bd4\u8f83 PHP\u3001Nginx \u5c31\u53ef\u4ee5\u8fd0\u884c\u4e86\uff0c\u6700\u7ec8\u7684 Dockerfile \u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>FROM nginx:latest\n\nLABEL version=\"0\"\nLABEL author=\"\u9633\u660e &lt;icnych@gmail.com&gt;\"\n\n# \u8bbe\u7f6e\u6210\u975e\u4ea4\u4e92\u5f0f\u7684\nENV DEBIAN_FRONTEND noninteractive\nENV DOCUMENT_ROOT /usr/share/nginx/html\n\n# \u5b89\u88c5 nginx php-fpm php-pdo unzip curl\nRUN apt-get update &amp;&amp; apt-get -y install \\\\\n    apt-utils \\\\\n    curl \\\\\n    php-fpm \\\\\n    php-sqlite3 \\\\\n    unzip\n\nCOPY wordpress-tar.gz .\n\nRUN rm -rf ${DOCUMENT_ROOT}/* &amp;&amp; \\\\\n    tar -xzvf wordpress-tar.gz --strip-components=1 --directory ${DOCUMENT_ROOT} &amp;&amp; \\\\\n    rm -rf wordpress-tar.gz\n# RUN rm -rf ${DOCUMENT_ROOT}/* &amp;&amp; \\\\\n#     curl -o wordpress.tar.gz https://wordpress.org/latest.tar.gz &amp;&amp; \\\\\n#     tar -xzvf /wordpress.tar.gz --strip-components=1 --directory ${DOCUMENT_ROOT}\n\nCOPY sqlite-integration.zip .\nRUN unzip sqlite-integration.zip -d ${DOCUMENT_ROOT}/wp-content/plugins/ &amp;&amp; \\\\\n    rm -rf sqlite-integration.zip\n# RUN curl -o sqlite-plugin.zip https://downloads.wordpress.org/plugin/sqlite-integration.zip &amp;&amp; \\\\\n    # unzip sqlite-plugin.zip -d ${DOCUMENT_ROOT}/wp-content/plugins/ &amp;&amp; \\\\\n    # rm sqlite-plugin.zip &amp;&amp; \\\\\n\nRUN cp ${DOCUMENT_ROOT}/wp-content/plugins/sqlite-integration/db.php ${DOCUMENT_ROOT}/wp-content &amp;&amp; \\\\\n    cp ${DOCUMENT_ROOT}/wp-config-sample.php ${DOCUMENT_ROOT}/wp-config.php\n\n# nginx \u914d\u7f6e\nRUN sed -i -e\"s/keepalive_timeout\\\\s*65/keepalive_timeout 2/\" /etc/nginx/nginx.conf \\\\\n    &amp;&amp; sed -i -e\"s/keepalive_timeout 2/keepalive_timeout 2;\\\\n\\\\tclient_max_body_size 10m/\" /etc/nginx/nginx.conf \\\\\n    &amp;&amp; sed -i -e \"s|include /etc/nginx/conf.d/\\\\*.conf|include /etc/nginx/sites-enabled/\\\\*|g\" /etc/nginx/nginx.conf \\\\\n    &amp;&amp; echo \"daemon off;\" &gt;&gt; /etc/nginx/nginx.conf\n\n# php-fpm \u914d\u7f6e\n# RUN php --ini  # \u627e\u5230fpm\u914d\u7f6e\nRUN sed -i -e \"s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/g\" /etc/php/3/fpm/php.ini \\\\\n    &amp;&amp; sed -i -e \"s/upload_max_filesize\\\\s*=\\\\s*2M/upload_max_filesize = 10M/g\" /etc/php/3/fpm/php.ini \\\\\n    &amp;&amp; sed -i -e \"s/post_max_size\\\\s*=\\\\s*8M/post_max_size = 10M/g\" /etc/php/3/fpm/php.ini \\\\\n    &amp;&amp; sed -i -e \"s/;catch_workers_output\\\\s*=\\\\s*yes/catch_workers_output = yes/g\" /etc/php/3/fpm/pool.d/www.conf \\\\\n    &amp;&amp; sed -i -e \"s/;listen.mode = 0660/listen.mode = 0666/g\" /etc/php/3/fpm/pool.d/www.conf\n\nCOPY nginx.conf /etc/nginx/sites-available/default\nRUN chown -R www-data.www-data ${DOCUMENT_ROOT} \\\\\n    &amp;&amp; mkdir -p /etc/nginx/sites-enabled \\\\\n    &amp;&amp; ln -s /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default \\\\\n    &amp;&amp; apt-get purge -y --auto-remove curl unzip\n\nEXPOSE 80\nEXPOSE 443\n\nCMD service php3-fpm start &amp;&amp; nginx\n</code></pre> <p>\u7531\u4e8e\u4e00\u4e9b\u7f51\u7edc\u539f\u56e0\uff0c\u6211\u4eec\u8fd9\u91cc\u5c06\u5b89\u88c5\u5305\u90fd\u653e\u7f6e\u5230\u4e86 Dockerfile \u76ee\u5f55\u4e0b\u9762\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u6765\u6784\u5efa\u955c\u50cf\uff1a</p> <pre><code>$ docker build -t cnych/wordpress:sqlite .\n</code></pre> <p>\u7136\u540e\u7528\u8be5\u955c\u50cf\u6765\u8fd0\u884c\u4e00\u4e2a Wordpress \u5bb9\u5668\uff1a</p> <pre><code>$ docker run -d --name wordpress -p 8888:80 cnych/wordpress:sqlite\n</code></pre> <p>\u8fd0\u884c\u6210\u529f\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 8888 \u7aef\u53e3\u6765\u8bbf\u95ee Wordpress \u5e94\u7528\u4e86\uff0c\u800c\u4e14\u6211\u4eec\u6ca1\u6709 MySQL \u76f8\u5173\u7684\u914d\u7f6e\uff0c\u901a\u8fc7\u4e00\u4e9b\u914d\u7f6e\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230\u5e94\u7528\u4e86\u3002</p> <p></p>"},{"location":"docker/dockerfile_usage/","title":"Dockerfile","text":""},{"location":"docker/dockerfile_usage/#dockerfile","title":"Dockerfile","text":"<p>\u4f7f\u7528 Dockerfile \u5b9a\u5236\u955c\u50cf</p> <p></p> <p>\u955c\u50cf\u7684\u5b9a\u5236\u5b9e\u9645\u4e0a\u5c31\u662f\u5b9a\u5236\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u6240\u6dfb\u52a0\u7684\u914d\u7f6e\u3001\u6587\u4ef6\u7b49\u4fe1\u606f\uff0c\u5b9e\u9645\u4e0a\u5f53\u6211\u4eec\u5728\u4e00\u4e2a\u5bb9\u5668\u4e2d\u6dfb\u52a0\u6216\u8005\u4fee\u6539\u4e86\u4e00\u4e9b\u6587\u4ef6\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>docker commit</code>\u547d\u4ee4\u6765\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\uff0c\u4f46\u662f\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u591f\u76f4\u89c2\uff0c\u6ca1\u529e\u6cd5\u8ffd\u6eaf\u6211\u4eec\u955c\u50cf\u91cc\u9762\u5230\u5e95\u6709\u54ea\u4e9b\u5185\u5bb9\uff0c\u6240\u4ee5\u5b9e\u9645\u5b9a\u5236\u955c\u50cf\u7684\u8fc7\u7a0b\u6211\u4eec\u5f88\u5c11\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002\u800c\u662f\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a <code>Dockerfile</code> \u7684\u6587\u672c\u6587\u4ef6\u6765\u8fdb\u884c\u955c\u50cf\u5b9a\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u4fee\u6539\u3001\u5b89\u88c5\u3001\u6784\u5efa\u3001\u64cd\u4f5c\u7684\u547d\u4ee4\u90fd\u5199\u5165\u5230\u8fd9\u4e2a\u6587\u4ef6\u4e2d\uff0c\u4e00\u884c\u5c31\u5bf9\u5e94\u955c\u50cf\u7684\u4e00\u5c42\uff0c\u8fd9\u79cd\u65b9\u6cd5\u663e\u7136\u8981\u66f4\u9ad8\u7ea7\uff0c\u56e0\u4e3a\u6211\u4eec\u6709\u4e00\u4e2a\u6587\u4ef6\u6765\u76f4\u89c2\u53cd\u6620\u6211\u4eec\u7684\u955c\u50cf\u5185\u5bb9\uff0c\u8fd8\u53ef\u4ee5\u4f5c\u4e3a\u7248\u672c\u8bb0\u5f55\u8fdb\u884c\u8ddf\u8e2a\u3002</p>"},{"location":"docker/dockerfile_usage/#_1","title":"\u5b9a\u5236\u955c\u50cf","text":"<p>\u4ee5\u6211\u4eec\u4e4b\u524d\u7684 nginx \u955c\u50cf\u4e3a\u4f8b\uff0c\u6211\u4eec\u73b0\u5728\u6765\u5b9a\u5236\u4e00\u4e2a nginx \u955c\u50cf\uff0c\u8981\u6c42\u9ed8\u8ba4\u7684\u5e94\u7528\u9875\u9762\u8bbf\u95ee\u7684\u5185\u5bb9\u662f <code>Hello Docker</code>\u3002</p> <p>\u9996\u5148\u6211\u4eec\u65b0\u5efa\u4e00\u4e2a\u76ee\u5f55 testnginx\uff0c\u7136\u540e\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a<code>Dockerfile</code>\u7684\u7a7a\u767d\u6587\u672c\u6587\u4ef6\uff1a</p> <pre><code>$ mkdir -p testnginx &amp;&amp; cd testnginx &amp;&amp; touch Dockerfile\n</code></pre> <p>\u7136\u540e\u5411<code>Dockerfile</code>\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>FROM nginx\nRUN echo 'Hello Docker!' &gt; /user/share/nginx/html/index.html\n</code></pre> <p>\u8fd9\u4e2a\u6587\u4ef6\u5f88\u7b80\u5355\uff0c\u4e00\u5171\u5c31\u4e24\u884c\uff0c\u5176\u4e2d\u5305\u542b\u4e24\u6761\u6307\u4ee4\uff0c<code>FROM</code> \u548c <code>RUN</code>\u3002</p>"},{"location":"docker/dockerfile_usage/#from","title":"FROM \u6307\u4ee4","text":"<p>\u5b9a\u5236\u955c\u50cf\uff0c\u90a3\u4e48\u80af\u5b9a\u662f\u4e00\u4e2a\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u5728\u5176\u57fa\u7840\u4e0a\u8fdb\u884c\u5b9a\u5236\uff0c\u800c <code>FROM</code> \u8fd9\u4e2a\u6307\u4ee4\u5c31\u662f\u6765\u6307\u5b9a\u57fa\u7840\u955c\u50cf\u7684\uff0c\u6240\u4ee5\u5728\u4e00\u4e2a <code>Dockerfile</code> \u6587\u4ef6\u4e2d <code>FROM</code> \u6307\u4ee4\u662f\u5fc5\u5907\u7684\uff0c\u5e76\u4e14\u5fc5\u987b\u662f\u7b2c\u4e00\u6761\u6307\u4ee4\u3002</p> <p>\u5728 Docker Hub \u4e0a\u6709\u975e\u5e38\u591a\u7684\u9ad8\u8d28\u91cf\u7684\u5b98\u65b9\u955c\u50cf\uff0c\u6709\u4e00\u4e9b\u53ef\u4ee5\u76f4\u63a5\u62ff\u6765\u4f7f\u7528\u7684\u670d\u52a1\u7c7b\u7684\u955c\u50cf\uff0c\u5982 nginx\u3001redis\u3001mongo\u3001mysql\u3001httpd\u3001php\u3001tomcat \u7b49\uff1b\u4e5f\u6709\u4e00\u4e9b\u65b9\u4fbf\u5f00\u53d1\u3001\u6784\u5efa\u3001\u8fd0\u884c\u5404\u79cd\u8bed\u8a00\u5e94\u7528\u7684\u955c\u50cf\uff0c\u5982 node\u3001openjdk\u3001python\u3001ruby\u3001golang \u7b49\u3002\u53ef\u4ee5\u5728\u5176\u4e2d\u5bfb\u627e\u4e00\u4e2a\u6700\u7b26\u5408\u6211\u4eec\u6700\u7ec8\u76ee\u6807\u7684\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u8fdb\u884c\u5b9a\u5236\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u627e\u5230\u5408\u9002\u7684\u57fa\u7840\u955c\u50cf\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e9b\u66f4\u4e3a\u57fa\u7840\u7684\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\uff0c\u6bd4\u5982 ubuntu\u3001debian\u3001centos\u3001alpine \u7b49\uff0c\u8fd9\u4e9b\u57fa\u7840\u955c\u50cf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u5927\u7684\u6269\u5c55\u7a7a\u95f4\uff0c\u5c31\u7c7b\u4f3c\u4e8e\u5e73\u65f6\u6211\u4eec\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u9762\u90e8\u7f72\u81ea\u5df1\u7684\u670d\u52a1\u4e00\u6837\u7684\u64cd\u4f5c\u3002</p> <p>\u9664\u4e86\u9009\u62e9\u73b0\u6709\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u5916\uff0cDocker \u8fd8\u5b58\u5728\u4e00\u4e2a\u7279\u6b8a\u7684\u955c\u50cf\uff0c\u540d\u4e3a <code>scratch</code>\uff0c\u8fd9\u4e2a\u955c\u50cf\u662f\u4e00\u4e2a\u865a\u62df\u7684\u955c\u50cf\uff0c\u5e76\u4e0d\u5b9e\u9645\u5b58\u5728\uff0c\u8868\u793a\u4e00\u4e2a\u7a7a\u767d\u7684\u955c\u50cf\uff1a</p> <p><code>FROM scratch ...</code></p> <p>\u5982\u679c\u4f60\u4ee5 <code>scratch</code> \u4e3a\u57fa\u7840\u955c\u50cf\u7684\u8bdd\uff0c\u610f\u5473\u7740\u4f60\u4e0d\u4ee5\u4efb\u4f55\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u63a5\u4e0b\u6765\u6240\u5199\u7684\u6307\u4ee4\u5c06\u4f5c\u4e3a\u955c\u50cf\u7b2c\u4e00\u5c42\u5f00\u59cb\u5b58\u5728\u3002\u6709\u7684\u540c\u5b66\u53ef\u80fd\u611f\u89c9\u5f88\u5947\u602a\uff0c\u6ca1\u6709\u4efb\u4f55\u57fa\u7840\u955c\u50cf\uff0c\u6211\u600e\u4e48\u53bb\u6267\u884c\u6211\u7684\u7a0b\u5e8f\u5462\uff0c\u5176\u5b9e\u5bf9\u4e8e Linux \u4e0b\u9759\u6001\u7f16\u8bd1\u7684\u7a0b\u5e8f\u6765\u8bf4\uff0c\u5e76\u4e0d\u9700\u8981\u6709\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u8fd0\u884c\u65f6\u652f\u6301\uff0c\u6240\u9700\u7684\u4e00\u5207\u5e93\u90fd\u5df2\u7ecf\u5728\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u4e86\uff0c\u56e0\u6b64\u76f4\u63a5<code>FROM scratch</code>\u4f1a\u8ba9\u955c\u50cf\u4f53\u79ef\u66f4\u52a0\u5c0f\u5de7\u3002\u4f7f\u7528 Go \u8bed\u8a00 \u5f00\u53d1\u7684\u5e94\u7528\u5f88\u591a\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u5236\u4f5c\u955c\u50cf\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6709\u5f88\u591a\u89c2\u70b9\u8ba4\u4e3a Go \u662f\u7279\u522b\u9002\u5408\u5bb9\u5668\u5fae\u670d\u52a1\u67b6\u6784\u7684\u8bed\u8a00\u7684\u539f\u56e0\u4e4b\u4e00\u3002</p>"},{"location":"docker/dockerfile_usage/#run","title":"RUN \u6307\u4ee4","text":"<p><code>RUN</code> \u6307\u4ee4\u662f\u7528\u6765\u6267\u884c\u547d\u4ee4\u884c\u547d\u4ee4\u7684\u3002\u7531\u4e8e\u547d\u4ee4\u884c\u7684\u5f3a\u5927\u80fd\u529b\uff0c\u6240\u4ee5 <code>RUN</code> \u6307\u4ee4\u662f\u5b9a\u5236\u955c\u50cf\u65f6\u662f\u6700\u5e38\u7528\u7684\u6307\u4ee4\u4e4b\u4e00\u3002\u5176\u683c\u5f0f\u6709\u4e24\u79cd\uff1a</p> <ul> <li> <p>shell \u683c\u5f0f\uff1a<code>RUN &lt;\u547d\u4ee4&gt;</code>\uff0c\u5c31\u50cf\u76f4\u63a5\u5728\u547d\u4ee4\u884c\u4e2d\u8f93\u5165\u7684\u547d\u4ee4\u4e00\u6837\u3002\u521a\u624d\u5199\u7684 Dockerfile \u4e2d\u7684 RUN \u6307\u4ee4\u5c31\u662f\u8fd9\u79cd\u683c\u5f0f\uff1a</p> <pre><code>RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n</code></pre> </li> <li> <p>exec \u683c\u5f0f\uff1a</p> <pre><code>RUN [\"\u53ef\u6267\u884c\u6587\u4ef6\", \"\u53c2\u65701\", \"\u53c2\u65702\"]\n</code></pre> <p>\uff0c\u8fd9\u66f4\u50cf\u662f\u51fd\u6570\u8c03\u7528\u4e2d\u7684\u683c\u5f0f\u3002\u65e2\u7136 RUN \u5c31\u50cf Shell \u811a\u672c\u4e00\u6837\u53ef\u4ee5\u6267\u884c\u547d\u4ee4\uff0c\u90a3\u4e48\u6211\u4eec\u662f\u5426\u5c31\u53ef\u4ee5\u50cf Shell \u811a\u672c\u4e00\u6837\u628a\u6bcf\u4e2a\u547d\u4ee4\u5bf9\u5e94\u4e00\u4e2a RUN \u5462\uff1f\u6bd4\u5982\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN apt-get update\nRUN apt-get install -y gcc libc6-dev make wget\nRUN wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\"\nRUN mkdir -p /usr/src/redis\nRUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1\nRUN make -C /usr/src/redis\nRUN make -C /usr/src/redis install\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> </li> </ul> <p>\u4e4b\u524d\u8bf4\u8fc7\uff0cDockerfile \u4e2d\u6bcf\u4e00\u4e2a\u6307\u4ee4\u90fd\u4f1a\u5efa\u7acb\u4e00\u5c42\uff0cRUN \u4e5f\u4e0d\u4f8b\u5916\u3002\u6bcf\u4e00\u4e2a RUN \u5c31\u4f1a\u65b0\u5efa\u7acb\u4e00\u5c42\uff0c\u5728\u5176\u4e0a\u6267\u884c\u8fd9\u4e9b\u547d\u4ee4\uff0c\u6267\u884c\u7ed3\u675f\u540e\uff0ccommit \u8fd9\u4e00\u5c42\u7684\u4fee\u6539\uff0c\u6784\u6210\u65b0\u7684\u955c\u50cf\u3002</p> <p>\u800c\u4e0a\u9762\u7684\u8fd9\u79cd\u5199\u6cd5\uff0c\u521b\u5efa\u4e86 7 \u5c42\u955c\u50cf\u3002\u8fd9\u662f\u5b8c\u5168\u6ca1\u6709\u5fc5\u8981\u7684\uff0c\u800c\u4e14\u5f88\u591a\u8fd0\u884c\u65f6\u4e0d\u9700\u8981\u7684\u4e1c\u897f\uff0c\u90fd\u88ab\u88c5\u8fdb\u4e86\u955c\u50cf\u91cc\uff0c\u6bd4\u5982\u7f16\u8bd1\u73af\u5883\u3001\u66f4\u65b0\u7684\u8f6f\u4ef6\u5305\u7b49\u7b49\u3002\u7ed3\u679c\u5c31\u662f\u4ea7\u751f\u975e\u5e38\u81c3\u80bf\u3001\u975e\u5e38\u591a\u5c42\u7684\u955c\u50cf\uff0c\u4e0d\u4ec5\u4ec5\u589e\u52a0\u4e86\u6784\u5efa\u90e8\u7f72\u7684\u65f6\u95f4\uff0c\u4e5f\u5f88\u5bb9\u6613\u51fa\u9519\u3002 \u8fd9\u662f\u5f88\u591a\u521d\u5b66 Docker \u7684\u4eba\u5e38\u72af\u7684\u4e00\u4e2a\u9519\u8bef\u3002</p> <p>UnionFS \u5c42\u9650\u5236</p> <p>UnionFS \u5b9e\u9645\u4e0a\u662f\u6709\u6700\u5927\u5c42\u6570\u9650\u5236\u7684\uff0c\u6bd4\u5982 AUFS\uff0c\u66fe\u7ecf\u662f\u6700\u5927\u4e0d\u5f97\u8d85\u8fc7 42 \u5c42\uff0c\u73b0\u5728\u662f\u4e0d\u5f97\u8d85\u8fc7 127 \u5c42\u3002</p> <p>\u4e0a\u9762\u7684 Dockerfile \u6b63\u786e\u7684\u5199\u6cd5\u5e94\u8be5\u662f\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN buildDeps='gcc libc6-dev make wget' \\\\\n    &amp;&amp; apt-get update \\\\\n    &amp;&amp; apt-get install -y $buildDeps \\\\\n    &amp;&amp; wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\" \\\\\n    &amp;&amp; mkdir -p /usr/src/redis \\\\\n    &amp;&amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\\\\n    &amp;&amp; make -C /usr/src/redis \\\\\n    &amp;&amp; make -C /usr/src/redis install \\\\\n    &amp;&amp; rm -rf /var/lib/apt/lists/* \\\\\n    &amp;&amp; rm redis.tar.gz \\\\\n    &amp;&amp; rm -r /usr/src/redis \\\\\n    &amp;&amp; apt-get purge -y --auto-remove $buildDeps\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> <p>\u9996\u5148\uff0c\u4e4b\u524d\u6240\u6709\u7684\u547d\u4ee4\u53ea\u6709\u4e00\u4e2a\u76ee\u7684\uff0c\u5c31\u662f\u7f16\u8bd1\u3001\u5b89\u88c5 redis \u53ef\u6267\u884c\u6587\u4ef6\u3002\u56e0\u6b64\u6ca1\u6709\u5fc5\u8981\u5efa\u7acb\u5f88\u591a\u5c42\uff0c\u8fd9\u53ea\u662f\u4e00\u5c42\u7684\u4e8b\u60c5\u3002\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\u4f7f\u7528\u5f88\u591a\u4e2a RUN \u6307\u4ee4\u6765\u5bf9\u5e94\u4e0d\u540c\u7684\u547d\u4ee4\uff0c\u800c\u662f\u4ec5\u4ec5\u4f7f\u7528\u4e00\u4e2a RUN \u6307\u4ee4\uff0c\u5e76\u4f7f\u7528<code>&amp;&amp;</code>\u5c06\u5404\u4e2a\u6240\u9700\u547d\u4ee4\u4e32\u8054\u8d77\u6765\u3002\u5c06\u4e4b\u524d\u7684 7 \u5c42\uff0c\u7b80\u5316\u4e3a\u4e86 1 \u5c42\u3002\u5728\u64b0\u5199 Dockerfile \u7684\u65f6\u5019\uff0c\u8981\u7ecf\u5e38\u63d0\u9192\u81ea\u5df1\uff0c\u8fd9\u5e76\u4e0d\u662f\u5728\u5199 Shell \u811a\u672c\uff0c\u800c\u662f\u5728\u5b9a\u4e49\u6bcf\u4e00\u5c42\u8be5\u5982\u4f55\u6784\u5efa\u3002</p> <p>\u5e76\u4e14\uff0c\u8fd9\u91cc\u4e3a\u4e86\u683c\u5f0f\u5316\u8fd8\u8fdb\u884c\u4e86\u6362\u884c\u3002Dockerfile \u652f\u6301 Shell \u7c7b\u7684\u884c\u5c3e\u6dfb\u52a0<code>\\</code>\u7684\u547d\u4ee4\u6362\u884c\u65b9\u5f0f\uff0c\u4ee5\u53ca\u884c\u9996<code>#</code>\u8fdb\u884c\u6ce8\u91ca\u7684\u683c\u5f0f\u3002\u826f\u597d\u7684\u683c\u5f0f\uff0c\u6bd4\u5982<code>\u6362\u884c\u3001\u7f29\u8fdb\u3001\u6ce8\u91ca</code>\u7b49\uff0c\u4f1a\u8ba9\u7ef4\u62a4\u3001\u6392\u969c\u66f4\u4e3a\u5bb9\u6613\uff0c\u8fd9\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u4e60\u60ef\u3002</p> <p>\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u770b\u5230\u8fd9\u4e00\u7ec4\u547d\u4ee4\u7684\u6700\u540e\u6dfb\u52a0\u4e86\u6e05\u7406\u5de5\u4f5c\u7684\u547d\u4ee4\uff0c\u5220\u9664\u4e86\u4e3a\u4e86\u7f16\u8bd1\u6784\u5efa\u4e0b\u8f7d\u7684\u8f6f\u4ef6\uff0c\u6e05\u7406\u4e86\u6240\u6709\u4e0b\u8f7d\u3001\u5c55\u5f00\u7684\u6587\u4ef6\uff0c\u5e76\u4e14\u8fd8\u6e05\u7406\u4e86 apt \u7f13\u5b58\u6587\u4ef6\u3002\u8fd9\u662f\u5f88\u91cd\u8981\u7684\u4e00\u6b65\uff0c\u6211\u4eec\u4e4b\u524d\u8bf4\u8fc7\uff0c\u955c\u50cf\u662f\u591a\u5c42\u5b58\u50a8\uff0c\u6bcf\u4e00\u5c42\u7684\u4e1c\u897f\u5e76\u4e0d\u4f1a\u5728\u4e0b\u4e00\u5c42\u88ab\u5220\u9664\uff0c\u4f1a\u4e00\u76f4\u8ddf\u968f\u7740\u955c\u50cf\u3002\u56e0\u6b64\u955c\u50cf\u6784\u5efa\u65f6\uff0c\u4e00\u5b9a\u8981\u786e\u4fdd\u6bcf\u4e00\u5c42\u53ea\u6dfb\u52a0\u771f\u6b63\u9700\u8981\u6dfb\u52a0\u7684\u4e1c\u897f\uff0c\u4efb\u4f55\u65e0\u5173\u7684\u4e1c\u897f\u90fd\u5e94\u8be5\u6e05\u7406\u6389\u3002 \u5f88\u591a\u4eba\u521d\u5b66 Docker \u5236\u4f5c\u51fa\u4e86\u5f88\u81c3\u80bf\u7684\u955c\u50cf\u7684\u539f\u56e0\u4e4b\u4e00\uff0c\u5c31\u662f\u5fd8\u8bb0\u4e86\u6bcf\u4e00\u5c42\u6784\u5efa\u7684\u6700\u540e\u4e00\u5b9a\u8981\u6e05\u7406\u6389\u65e0\u5173\u6587\u4ef6\u3002</p>"},{"location":"docker/dockerfile_usage/#workdir","title":"WORKDIR \u6307\u4ee4","text":"<p><code>WORKDIR</code> \u6307\u4ee4\u8bbe\u7f6e Dockerfile \u4e2d\u7684\u4efb\u4f55 RUN\uff0cCMD\uff0cENTRPOINT\uff0cCOPY \u548c ADD \u6307\u4ee4\u7684\u5de5\u4f5c\u76ee\u5f55\u3002\u5982\u679c WORKDIR \u6307\u5b9a\u7684\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u5373\u4f7f\u968f\u540e\u7684\u6307\u4ee4\u6ca1\u6709\u7528\u5230\u8fd9\u4e2a\u76ee\u5f55\uff0c\u90fd\u4f1a\u521b\u5efa\u8be5\u76ee\u5f55\u3002</p> <p>\u683c\u5f0f\uff1a </p> <pre><code>WORKDIR /path/to/workdir\n</code></pre> <p>\u4e3a\u4e86\u6e05\u6670\u6027\u548c\u53ef\u9760\u6027\uff0c\u4f60\u5e94\u8be5\u603b\u662f\u5728 WORKDIR \u4e2d\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\uff0c\u800c\u4e14\u5355\u4e2a Dockerfile \u53ef\u4ee5\u4f7f\u7528\u591a\u6b21WORKDIR\u3002\u53e6\u5916\uff0c\u6211\u4eec\u5e94\u8be5\u4f7f\u7528 WORKDIR \u6765\u66ff\u4ee3\u7c7b\u4f3c\u4e8e </p> <pre><code>RUN cd ... &amp;&amp; do-something\n</code></pre> <p>\u7684\u6307\u4ee4\uff0c\u540e\u8005\u96be\u4ee5\u9605\u8bfb\u3001\u6392\u9519\u548c\u7ef4\u62a4\u3002</p>"},{"location":"docker/dockerfile_usage/#add_copy","title":"ADD &amp; COPY \u6307\u4ee4","text":"<p>Dockerfile \u4e2d\u7684 <code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u90fd\u53ef\u4ee5\u5c06\u4e3b\u673a\u4e0a\u7684\u8d44\u6e90\u590d\u5236\u6216\u52a0\u5165\u5230\u5bb9\u5668\u955c\u50cf\u4e2d\uff0c\u90fd\u662f\u5728\u6784\u5efa\u955c\u50cf\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\u3002</p> <p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u7684\u552f\u4e00\u533a\u522b\u5728\u4e8e<code>\u662f\u5426\u652f\u6301\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90</code>\u3002<code>COPY</code> \u6307\u4ee4\u53ea\u80fd\u4ece\u6267\u884c<code>docker build</code>\u6240\u5728\u7684\u4e3b\u673a\u4e0a\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002\u800c <code>ADD</code> \u6307\u4ee4\u8fd8\u652f\u6301\u901a\u8fc7 URL \u4ece\u8fdc\u7a0b\u670d\u52a1\u5668\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\u6ee1\u8db3\u540c\u7b49\u529f\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u63a8\u8350\u4f7f\u7528COPY\u6307\u4ee4\u3002<code>ADD</code> \u6307\u4ee4\u66f4\u64c5\u957f\u8bfb\u53d6\u672c\u5730 tar \u6587\u4ef6\u5e76\u89e3\u538b\u7f29\u3002</p>"},{"location":"docker/dockerfile_usage/#copy","title":"COPY \u6307\u4ee4","text":"<p><code>COPY</code> \u6307\u4ee4\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002COPY \u6307\u4ee4\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\uff1a</p> <ul> <li> <p>exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>COPY [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5\u3002</p> </li> <li> <p>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>COPY &lt;src&gt;... &lt;dest&gt;</code></p> </li> </ul>"},{"location":"docker/dockerfile_usage/#add","title":"ADD \u6307\u4ee4","text":"<p><code>ADD</code> \u6307\u4ee4\u4e0d\u4ec5\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u800c\u4e14\u80fd\u591f\u5c06\u8fdc\u7a0b URL \u6240\u5bf9\u5e94\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u4f5c\u4e3a\u8d44\u6e90\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002\u6240\u4ee5\uff0c\u53ef\u4ee5\u8ba4\u4e3a <code>ADD</code> \u662f\u589e\u5f3a\u7248\u7684 <code>COPY</code>\uff0c\u652f\u6301\u5c06\u8fdc\u7a0b URL \u7684\u8d44\u6e90\u52a0\u5165\u5230\u955c\u50cf\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\u7528\u6cd5\uff1a \u00a0 * exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>ADD [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5</p> <ul> <li>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>ADD &lt;src&gt;... &lt;dest&gt;</code></li> </ul> <p>\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD http://foo.com/bar.go /tmp/main.go\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5bf9\u4e8e\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\u7684\u60c5\u51b5\uff0c\u7531\u4e8e ADD \u6307\u4ee4\u4e0d\u652f\u6301\u8ba4\u8bc1\uff0c\u5982\u679c\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\u9700\u8981\u8ba4\u8bc1\uff0c\u5219\u53ea\u80fd\u4f7f\u7528<code>RUN wget</code> \u6216 <code>RUN curl</code> \u66ff\u4ee3\u4e86\u3002</p> <p>\u6709\u80fd\u529b\u81ea\u52a8\u89e3\u538b\u6587\u4ef6\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD /foo.tar.gz /tmp/\n</code></pre> <p>\u4e0a\u8ff0\u6307\u4ee4\u4f1a\u4f7f foo.tar.gz \u538b\u7f29\u6587\u4ef6\u89e3\u538b\u5230\u5bb9\u5668\u7684 /tmp \u76ee\u5f55\u3002</p> <p>\u4e0d\u8fc7\u4e00\u822c\u6765\u8bf4\u867d\u7136 ADD \u6307\u4ee4\u652f\u6301\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\uff0c\u4f46\u662f\u5e76\u4e0d\u63a8\u8350\u4f7f\u7528\uff0c\u800c\u662f\u5efa\u8bae\u4f7f\u7528 RUN \u6307\u4ee4\u53bb\u6267\u884c wget \u6216 curl \u547d\u4ee4\u3002</p> <p>\u6bd4\u5982\u524d\u9762\u6211\u4eec\u5b9a\u5236\u7684 nginx \u955c\u50cf\uff0c\u53ef\u4ee5\u6539\u6210\u4e0b\u9762\u7684\u5f62\u5f0f\uff1a</p> <pre><code>$ echo 'Hello Docker!' &gt; index.html\n</code></pre> <p>\u7136\u540e\u4fee\u6539 Dockerfile\uff1a</p> <pre><code>FROM nginx\n# COPY\u6216\u8005ADD\u6307\u4ee4\u90fd\u53ef\u4ee5\nCOPY index.html /user/share/nginx/html/index.html\n</code></pre>"},{"location":"docker/dockerfile_usage/#_2","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code>\u6307\u4ee4\u7684\u7528\u6cd5\u975e\u5e38\u76f8\u4f3c\uff0c\u5177\u4f53\u6ce8\u610f\u4e8b\u9879\u5982\u4e0b\uff1a</p> <ul> <li>\u6e90\u8def\u5f84\u53ef\u4ee5\u6709\u591a\u4e2a</li> <li>\u6e90\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u6267\u884c build \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u672c\u5730\u8def\u5f84\uff0c\u5fc5\u987b\u662f\u6784\u5efa\u4e0a\u4e0b\u6587\u4e2d\u7684\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c\u5219\u8be5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u90fd\u5c06\u88ab\u52a0\u5165\u5230\u5bb9\u5668\uff0c\u4f46\u662f\u8be5\u76ee\u5f55\u672c\u8eab\u4e0d\u4f1a</li> <li>\u76ee\u6807\u8def\u5f84\u5fc5\u987b\u662f\u7edd\u5bf9\u8def\u5f84\uff0c\u6216\u76f8\u5bf9\u4e8e WORKDIR \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u4f1a\u521b\u5efa\u76f8\u5e94\u7684\u5b8c\u6574\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u662f\u4e00\u4e2a\u6587\u4ef6\uff0c\u5219\u5fc5\u987b\u4f7f\u7528/\u7ed3\u675f</li> <li>\u8def\u5f84\u4e2d\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26</li> </ul>"},{"location":"docker/dockerfile_usage/#_3","title":"\u6784\u5efa\u955c\u50cf","text":"<p>\u73b0\u5728\u8ba9\u6211\u4eec\u518d\u56de\u5230\u4e4b\u524d\u5b9a\u5236\u7684 nginx \u955c\u50cf\u7684 Dockerfile \u6765\u3002\u73b0\u5728\u6211\u4eec\u660e\u767d\u4e86\u8fd9\u4e2a Dockerfile \u7684\u5185\u5bb9\uff0c\u90a3\u4e48\u8ba9\u6211\u4eec\u6765\u6784\u5efa\u8fd9\u4e2a\u955c\u50cf\u5427\u3002\u5728 Dockerfile \u6587\u4ef6\u6240\u5728\u76ee\u5f55\u6267\u884c\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\nStep 1 : FROM nginx\n ---&gt; e43d811ce2f4\nStep 2 : RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n ---&gt; Running in 9cdc27646c7b\n ---&gt; 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c\n</code></pre> <p>\u4ece\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6e05\u6670\u7684\u770b\u5230\u955c\u50cf\u7684\u6784\u5efa\u8fc7\u7a0b\u3002\u5728 Step 2 \u4e2d\uff0c\u5982\u540c\u6211\u4eec\u4e4b\u524d\u6240\u8bf4\u7684\u90a3\u6837\uff0cRUN \u6307\u4ee4\u542f\u52a8\u4e86\u4e00\u4e2a\u5bb9\u5668 9cdc27646c7b\uff0c\u6267\u884c\u4e86\u6240\u8981\u6c42\u7684\u547d\u4ee4\uff0c\u5e76\u6700\u540e\u63d0\u4ea4\u4e86\u8fd9\u4e00\u5c42 44aa4490ce2c\uff0c\u968f\u540e\u5220\u9664\u4e86\u6240\u7528\u5230\u7684\u8fd9\u4e2a\u5bb9\u5668 9cdc27646c7b\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e86 <code>docker build</code> \u547d\u4ee4\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u3002\u5176\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>$ docker build [\u9009\u9879] &lt;\u4e0a\u4e0b\u6587\u8def\u5f84/URL/-&gt;\n</code></pre> <p>\u5728\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>-t</code> \u53c2\u6570\u6307\u5b9a\u4e86\u6700\u7ec8\u955c\u50cf\u7684\u540d\u79f0 <code>nginx:v1</code>\uff0c\u6784\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u955c\u50cf\u6765\u8fd0\u884c\u5bb9\u5668\u4e86\u3002</p>"},{"location":"docker/dockerfile_usage/#_4","title":"\u6784\u5efa\u4e0a\u4e0b\u6587","text":"<p>\u5982\u679c\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u7684\u8bdd\u4f1a\u770b\u5230 <code>docker build</code> \u547d\u4ee4\u6700\u540e\u6709\u4e00\u4e2a <code>.</code>\u3002<code>.</code> \u8868\u793a\u5f53\u524d\u76ee\u5f55\uff0c\u800c Dockerfile \u5c31\u5728\u5f53\u524d\u76ee\u5f55\uff0c\u56e0\u6b64\u4e0d\u5c11\u521d\u5b66\u8005\u4ee5\u4e3a\u8fd9\u4e2a\u8def\u5f84\u662f\u5728\u6307\u5b9a Dockerfile \u6240\u5728\u8def\u5f84\uff0c\u8fd9\u4e48\u7406\u89e3\u5176\u5b9e\u662f\u4e0d\u51c6\u786e\u7684\u3002\u5982\u679c\u5bf9\u5e94\u4e0a\u9762\u7684\u547d\u4ee4\u683c\u5f0f\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u8fd9\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u8def\u5f84\u3002\u90a3\u4e48\u4ec0\u4e48\u662f\u4e0a\u4e0b\u6587\u5462\uff1f</p> <p>\u9996\u5148\u6211\u4eec\u8981\u7406\u89e3 <code>docker build</code> \u7684\u5de5\u4f5c\u539f\u7406\u3002Docker \u5728\u8fd0\u884c\u65f6\u5206\u4e3a Docker Daemon \u548c\u5ba2\u6237\u7aef\u5de5\u5177\u3002Docker \u7684\u5f15\u64ce\u63d0\u4f9b\u4e86\u4e00\u7ec4 REST API\uff0c\u88ab\u79f0\u4e3a Docker Remote API\uff0c\u800c\u5982 docker \u547d\u4ee4\u8fd9\u6837\u7684\u5ba2\u6237\u7aef\u5de5\u5177\uff0c\u5219\u662f\u901a\u8fc7\u8fd9\u7ec4 API \u4e0e Docker \u5f15\u64ce\u4ea4\u4e92\uff0c\u4ece\u800c\u5b8c\u6210\u5404\u79cd\u529f\u80fd\u3002\u56e0\u6b64\uff0c\u867d\u7136\u8868\u9762\u4e0a\u6211\u4eec\u597d\u50cf\u662f\u5728\u672c\u673a\u6267\u884c\u5404\u79cd docker \u529f\u80fd\uff0c\u4f46\u5b9e\u9645\u4e0a\uff0c\u4e00\u5207\u90fd\u662f\u4f7f\u7528\u7684\u8fdc\u7a0b\u8c03\u7528\u5f62\u5f0f\u5728\u670d\u52a1\u7aef\uff08Docker \u5f15\u64ce\uff09\u5b8c\u6210\u3002\u4e5f\u56e0\u4e3a\u8fd9\u79cd C/S \u8bbe\u8ba1\uff0c\u8ba9\u6211\u4eec\u64cd\u4f5c\u8fdc\u7a0b\u670d\u52a1\u5668\u7684 Docker \u5f15\u64ce\u53d8\u5f97\u8f7b\u800c\u6613\u4e3e\u3002</p> <p>\u5f53\u6211\u4eec\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u7684\u65f6\u5019\uff0c\u5e76\u975e\u6240\u6709\u5b9a\u5236\u90fd\u4f1a\u901a\u8fc7 RUN \u6307\u4ee4\u5b8c\u6210\uff0c\u7ecf\u5e38\u4f1a\u9700\u8981\u5c06\u4e00\u4e9b\u672c\u5730\u6587\u4ef6\u590d\u5236\u8fdb\u955c\u50cf\uff0c\u6bd4\u5982\u901a\u8fc7 <code>COPY</code> \u6307\u4ee4\u3001<code>ADD</code> \u6307\u4ee4\u7b49\u3002\u800c <code>docker build</code> \u547d\u4ee4\u6784\u5efa\u955c\u50cf\uff0c\u5176\u5b9e\u5e76\u975e\u5728\u672c\u5730\u6784\u5efa\uff0c\u800c\u662f\u5728\u670d\u52a1\u7aef\uff0c\u4e5f\u5c31\u662f Docker \u5f15\u64ce\u4e2d\u6784\u5efa\u7684\u3002\u90a3\u4e48\u5728\u8fd9\u79cd<code>\u5ba2\u6237\u7aef/\u670d\u52a1\u7aef</code>\u7684\u67b6\u6784\u4e2d\uff0c\u5982\u4f55\u624d\u80fd\u8ba9\u670d\u52a1\u7aef\u83b7\u5f97\u672c\u5730\u6587\u4ef6\u5462\uff1f</p> <p>\u8fd9\u5c31\u5f15\u5165\u4e86<code>\u4e0a\u4e0b\u6587</code>\u7684\u6982\u5ff5\u3002\u5f53\u6784\u5efa\u7684\u65f6\u5019\uff0c\u7528\u6237\u4f1a\u6307\u5b9a\u6784\u5efa\u955c\u50cf\u4e0a\u4e0b\u6587\u7684\u8def\u5f84\uff0cdocker build \u547d\u4ee4\u5f97\u77e5\u8fd9\u4e2a\u8def\u5f84\u540e\uff0c\u4f1a\u5c06\u8def\u5f84\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u6253\u5305\uff0c\u7136\u540e\u4e0a\u4f20\u7ed9 Docker \u5f15\u64ce\u3002\u8fd9\u6837 Docker \u5f15\u64ce\u6536\u5230\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u5305\u540e\uff0c\u5c55\u5f00\u5c31\u4f1a\u83b7\u5f97\u6784\u5efa\u955c\u50cf\u6240\u9700\u7684\u4e00\u5207\u6587\u4ef6\u3002\u5982\u679c\u5728 Dockerfile \u4e2d\u8fd9\u4e48\u5199\uff1a</p> <pre><code>COPY ./package.json /app/\n</code></pre> <p>\u8fd9\u5e76\u4e0d\u662f\u8981\u590d\u5236\u6267\u884c docker build \u547d\u4ee4\u6240\u5728\u7684\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u4e5f\u4e0d\u662f\u590d\u5236 Dockerfile \u6240\u5728\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u800c\u662f\u590d\u5236 <code>\u4e0a\u4e0b\u6587\uff08context\uff09</code> \u76ee\u5f55\u4e0b\u7684 package.json\u3002</p> <p>\u56e0\u6b64\uff0c<code>COPY</code> \u8fd9\u7c7b\u6307\u4ee4\u4e2d\u7684\u6e90\u6587\u4ef6\u7684\u8def\u5f84\u90fd\u662f<code>\u76f8\u5bf9\u8def\u5f84</code>\u3002\u8fd9\u4e5f\u662f\u521d\u5b66\u8005\u7ecf\u5e38\u4f1a\u95ee\u7684\u4e3a\u4ec0\u4e48 </p> <pre><code>COPY ../package.json /app\n</code></pre> <p>\u6216\u8005 <code>COPY /opt/xxxx /app</code> \u65e0\u6cd5\u5de5\u4f5c\u7684\u539f\u56e0\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u8def\u5f84\u5df2\u7ecf\u8d85\u51fa\u4e86\u4e0a\u4e0b\u6587\u7684\u8303\u56f4\uff0cDocker \u5f15\u64ce\u65e0\u6cd5\u83b7\u5f97\u8fd9\u4e9b\u4f4d\u7f6e\u7684\u6587\u4ef6\u3002\u5982\u679c\u771f\u7684\u9700\u8981\u90a3\u4e9b\u6587\u4ef6\uff0c\u5e94\u8be5\u5c06\u5b83\u4eec\u590d\u5236\u5230\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u53bb\u3002</p> <p>\u73b0\u5728\u5c31\u53ef\u4ee5\u7406\u89e3\u521a\u624d\u7684\u547d\u4ee4</p> <pre><code>docker build -t nginx:v1 .\n</code></pre> <p>\u4e2d\u7684\u8fd9\u4e2a<code>.</code>\uff0c\u5b9e\u9645\u4e0a\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u7684\u76ee\u5f55\uff0cdocker build \u547d\u4ee4\u4f1a\u5c06\u8be5\u76ee\u5f55\u4e0b\u7684\u5185\u5bb9\u6253\u5305\u4ea4\u7ed9 Docker \u5f15\u64ce\u4ee5\u5e2e\u52a9\u6784\u5efa\u955c\u50cf\u3002</p> <p>\u5982\u679c\u89c2\u5bdf docker build \u8f93\u51fa\uff0c\u6211\u4eec\u5176\u5b9e\u5df2\u7ecf\u770b\u5230\u4e86\u8fd9\u4e2a\u53d1\u9001\u4e0a\u4e0b\u6587\u7684\u8fc7\u7a0b\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\n...\n</code></pre> <p>\u7406\u89e3\u6784\u5efa\u4e0a\u4e0b\u6587\u5bf9\u4e8e\u955c\u50cf\u6784\u5efa\u662f\u5f88\u91cd\u8981\u7684\uff0c\u53ef\u4ee5\u907f\u514d\u72af\u4e00\u4e9b\u4e0d\u5e94\u8be5\u7684\u9519\u8bef\u3002\u6bd4\u5982\u6709\u4e9b\u521d\u5b66\u8005\u5728\u53d1\u73b0 COPY /opt/xxxx /app \u4e0d\u5de5\u4f5c\u540e\uff0c\u4e8e\u662f\u5e72\u8106\u5c06 Dockerfile \u653e\u5230\u4e86\u786c\u76d8\u6839\u76ee\u5f55\u53bb\u6784\u5efa\uff0c\u7ed3\u679c\u53d1\u73b0 docker build \u6267\u884c\u65f6\u53d1\u9001\u4e00\u4e2a\u51e0\u5341 GB \u7684\u4e1c\u897f\uff0c\u6781\u4e3a\u7f13\u6162\u800c\u4e14\u5f88\u5bb9\u6613\u6784\u5efa\u5931\u8d25\u3002\u90a3\u662f\u56e0\u4e3a\u8fd9\u79cd\u505a\u6cd5\u662f\u5728\u8ba9 docker build \u6253\u5305\u6574\u4e2a\u786c\u76d8\uff0c\u8fd9\u663e\u7136\u662f\u4f7f\u7528\u9519\u8bef\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u5e94\u8be5\u4f1a\u5c06 Dockerfile \u7f6e\u4e8e\u4e00\u4e2a\u7a7a\u76ee\u5f55\u4e0b\uff0c\u6216\u8005\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u3002\u5982\u679c\u8be5\u76ee\u5f55\u4e0b\u6ca1\u6709\u6240\u9700\u6587\u4ef6\uff0c\u90a3\u4e48\u5e94\u8be5\u628a\u6240\u9700\u6587\u4ef6\u590d\u5236\u4e00\u4efd\u8fc7\u6765\u3002\u5982\u679c\u76ee\u5f55\u4e0b\u6709\u4e9b\u4e1c\u897f\u786e\u5b9e\u4e0d\u5e0c\u671b\u6784\u5efa\u65f6\u4f20\u7ed9 Docker \u5f15\u64ce\uff0c\u90a3\u4e48\u53ef\u4ee5\u7528 .gitignore \u4e00\u6837\u7684\u8bed\u6cd5\u5199\u4e00\u4e2a <code>.dockerignore</code>\uff0c\u8be5\u6587\u4ef6\u662f\u7528\u4e8e\u5254\u9664\u4e0d\u9700\u8981\u4f5c\u4e3a\u4e0a\u4e0b\u6587\u4f20\u9012\u7ed9 Docker \u5f15\u64ce\u7684\u3002</p> <p>\u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u6709\u4eba\u8bef\u4ee5\u4e3a <code>.</code> \u662f\u6307\u5b9a Dockerfile \u6240\u5728\u76ee\u5f55\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4e0d\u989d\u5916\u6307\u5b9a Dockerfile \u7684\u8bdd\uff0c\u4f1a\u5c06\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e0b\u7684\u540d\u4e3a Dockerfile \u7684\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002\u8fd9\u53ea\u662f\u9ed8\u8ba4\u884c\u4e3a\uff0c\u5b9e\u9645\u4e0a Dockerfile \u7684\u6587\u4ef6\u540d\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4e3a Dockerfile\uff0c\u800c\u4e14\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4f4d\u4e8e\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\uff0c\u6bd4\u5982\u53ef\u4ee5\u7528<code>-f ../Dockerfile.Dev</code>\u53c2\u6570\u6307\u5b9a\u67d0\u4e2a\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002</p> <p>\u5f53\u7136\uff0c\u4e00\u822c\u5927\u5bb6\u4e60\u60ef\u6027\u7684\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u7684\u6587\u4ef6\u540d Dockerfile\uff0c\u4ee5\u53ca\u4f1a\u5c06\u5176\u7f6e\u4e8e\u955c\u50cf\u6784\u5efa\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u3002</p>"},{"location":"docker/dockerfile_usage/#_5","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bb2\u5230\u4e86 Dockerfile \u7684\u57fa\u672c\u5199\u6cd5\u4ee5\u53ca\u6784\u5efa\u955c\u50cf\u7684\u65f6\u5019\u4e00\u4e9b\u6ce8\u610f\u4e8b\u9879\uff0c\u90a3\u4e48\u955c\u50cf\u6784\u5efa\u5b8c\u6210\u540e\uff0c\u5982\u4f55\u628a\u6211\u4eec\u7684\u955c\u50cf\u7ed9\u5230\u522b\u4eba\u4f7f\u7528\u5462\uff1f\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5229\u7528 Docker \u5b98\u65b9\u63d0\u4f9b\u7684\u516c\u5171\u7684 Docker Hub \u4ed3\u5e93\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u955c\u50cf\u63a8\u9001\u4e0a\u53bb\uff0c\u7136\u540e\u522b\u4eba\u5c31\u53ef\u4ee5\u76f4\u63a5\u62c9\u53d6\u955c\u50cf\u3002</p>"},{"location":"docker/dockerfile_usage/#_6","title":"\u6ce8\u518c","text":"<p>\u9996\u5148\u9700\u8981 https://cloud.docker.com \u514d\u8d39\u6ce8\u518c\u4e00\u4e2a Docker \u8d26\u53f7\u3002</p>"},{"location":"docker/dockerfile_usage/#_7","title":"\u767b\u5f55","text":"<p>\u7136\u540e\u901a\u8fc7\u6267\u884c<code>docker login</code>\u547d\u4ee4\u4ea4\u4e92\u5f0f\u7684\u8f93\u5165\u7528\u6237\u540d\u53ca\u5bc6\u7801\u6765\u5b8c\u6210\u5728\u547d\u4ee4\u884c\u754c\u9762\u767b\u5f55 Docker Hub\u3002</p> <pre><code>$ docker login\nLogin with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.\nUsername: cnych\nPassword:\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n</code></pre>"},{"location":"docker/dockerfile_usage/#_8","title":"\u6ce8\u9500","text":"<p>\u4f60\u53ef\u4ee5\u901a\u8fc7<code>docker logout</code>\u9000\u51fa\u767b\u5f55\u3002</p>"},{"location":"docker/dockerfile_usage/#_9","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u7528\u6237\u5728\u767b\u5f55\u540e\u53ef\u4ee5\u901a\u8fc7<code>docker push</code>\u547d\u4ee4\u6765\u5c06\u81ea\u5df1\u7684\u955c\u50cf\u63a8\u9001\u5230 Docker Hub\u3002\u4ee5\u4e0b\u547d\u4ee4\u4e2d\u7684 username \u8bf7\u66ff\u6362\u4e3a\u4f60\u7684 Docker \u8d26\u53f7\u7528\u6237\u540d\u3002</p> <pre><code>$ docker tag ubuntu:10 username/ubuntu:10\n$ docker image ls\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   10                  275d79972a86        6 days ago          6MB\nusername/ubuntu                                          10                  275d79972a86        6 days ago          6MB\n$ docker push username/ubuntu:10\n</code></pre>"},{"location":"docker/dockerfile_usage/#_10","title":"\u79c1\u6709\u4ed3\u5e93","text":"<p>\u6709\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u5e0c\u671b\u6211\u4eec\u7684\u955c\u50cf\u53ea\u5728\u5c40\u57df\u7f51\u8303\u56f4\u5185\u4f7f\u7528\uff0c\u4e0d\u5e0c\u671b\u63a8\u9001\u5230 Docker Hub \u8fd9\u6837\u7684\u516c\u5171\u4ed3\u5e93\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u672c\u5730\u4ed3\u5e93\u4f9b\u79c1\u4eba\u4f7f\u7528\u3002</p> <p><code>docker-registry</code> \u5c31\u662f\u662f\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u79c1\u6709\u4ed3\u5e93\u5de5\u5177\uff0c\u53ef\u4ee5\u7528\u4e8e\u5b58\u50a8\u79c1\u6709\u7684\u955c\u50cf\u4ed3\u5e93\u3002\u540c\u6837\u7684\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u83b7\u53d6\u5b98\u65b9 registry \u955c\u50cf\u6765\u76f4\u63a5\u8fd0\u884c\uff1a</p> <pre><code>$ docker run -d -p 5000:5000 --name registry registry:2\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u4f7f\u7528\u5b98\u65b9\u7684 registry \u955c\u50cf\u6765\u542f\u52a8\u79c1\u6709\u4ed3\u5e93\u5bb9\u5668\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4ed3\u5e93\u4f1a\u88ab\u521b\u5efa\u5728\u5bb9\u5668\u7684<code>/var/lib/registry</code>\u76ee\u5f55\u4e0b\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7 <code>-v</code> \u53c2\u6570\u6765\u5c06\u955c\u50cf\u6587\u4ef6\u5b58\u653e\u5728\u672c\u5730\u7684\u6307\u5b9a\u8def\u5f84\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\u5c06\u4e0a\u4f20\u7684\u955c\u50cf\u653e\u5230\u672c\u5730\u7684 <code>/opt/data/registry</code> \u76ee\u5f55:</p> <pre><code>$ docker run -d \\\\\n    -p 5000:5000 \\\\\n    -v /opt/data/registry:/var/lib/registry \\\\\n    registry:2\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u8fd0\u884c\u4e86\u4e00\u4e2a\u6570\u636e\u6301\u4e45\u5316\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u3002</p> <p>\u521b\u5efa\u597d\u79c1\u6709\u4ed3\u5e93\u4e4b\u540e\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528<code>docker tag</code>\u6765\u6807\u8bb0\u4e00\u4e2a\u955c\u50cf\uff0c\u7136\u540e\u63a8\u9001\u5b83\u5230\u4ed3\u5e93\u3002\u6bd4\u5982\u79c1\u6709\u4ed3\u5e93\u5730\u5740\u4e3a<code>127.0.0.1:5000</code>\u3002\u5148\u5728\u672c\u673a\u67e5\u770b\u5df2\u6709\u7684\u955c\u50cf\u3002</p> <pre><code>$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u4f7f\u7528<code>docker tag</code>\u5c06 ubuntu:latest \u8fd9\u4e2a\u955c\u50cf\u6807\u8bb0\u4e3a </p> <pre><code>11:5000/ubuntu:latest\n</code></pre> <p>:</p> <pre><code>$ docker tag ubuntu:latest 11:5000/ubuntu:latest\n$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n11:5000/ubuntu:latest      latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528<code>docker push</code>\u4e0a\u4f20\u6807\u8bb0\u7684\u955c\u50cf:</p> <pre><code>$ docker push 11:5000/ubuntu:latest\nThe push refers to repository [11:5000/ubuntu]\n373a30c24545: Pushed\na9148f5200b0: Pushed\ncdd3de0940ab: Pushedfc56279bbb33: Pushed\nb38367233d37: Pushed\n2aebd096e0e2: Pushed\nlatest: digest: sha256:fe4277621f10b5026266932ddf760f5a756d2facd505a94d2da12f4f52f71f5a size: 1568\n</code></pre> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 registry \u4ed3\u5e93\u63d0\u4f9b\u7684 API \u6765\u67e5\u770b\u4ed3\u5e93\u4e2d\u7684\u955c\u50cf\uff1a</p> <pre><code>$ curl 11:5000/v2/_catalog\n{\"repositories\":[\"ubuntu\"]}\n</code></pre> <p>\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230 {\"repositories\":[\"ubuntu\"]}\uff0c\u8868\u660e\u955c\u50cf\u5df2\u7ecf\u88ab\u6210\u529f\u4e0a\u4f20\u4e86\u3002</p> <p>\u5148\u5220\u9664\u5df2\u6709\u955c\u50cf\uff0c\u518d\u5c1d\u8bd5\u4ece\u79c1\u6709\u4ed3\u5e93\u4e2d\u4e0b\u8f7d\u8fd9\u4e2a\u955c\u50cf\u3002</p> <pre><code>$ docker image rm 11:5000/ubuntu:latest\n$ docker pull 11:5000/ubuntu:latest\nPulling repository 11:5000/ubuntu:latest\nba5877dc9bec: Download complete\n511136ea3c5a: Download complete\n9bad880da3d2: Download complete\n25f11f5fb0cb: Download complete\nebc34468f71d: Download complete\n2318d26665ef: Download complete\n$ docker image ls\nREPOSITORY                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\n11:5000/ubuntu:latest       latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u628a\u955c\u50cf\u4e0a\u4f20\u5230\u4e86\u79c1\u6709\u4ed3\u5e93\u4e2d\u7684\u5b8c\u6574\u8fc7\u7a0b\u3002</p>"},{"location":"docker/dockerfile_usage/#_11","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528 <code>127.0.0.1:5000</code> \u4f5c\u4e3a\u4ed3\u5e93\u5730\u5740\uff0c\u6bd4\u5982\u60f3\u8ba9\u672c\u7f51\u6bb5\u7684\u5176\u4ed6\u4e3b\u673a\u4e5f\u80fd\u628a\u955c\u50cf\u63a8\u9001\u5230\u79c1\u6709\u4ed3\u5e93\u3002\u4f60\u5c31\u5f97\u628a\u4f8b\u5982 <code>192.168.199.100:5000</code> \u8fd9\u6837\u7684\u5185\u7f51\u5730\u5740\u4f5c\u4e3a\u79c1\u6709\u4ed3\u5e93\u5730\u5740\uff0c\u8fd9\u65f6\u4f60\u4f1a\u53d1\u73b0\u65e0\u6cd5\u6210\u529f\u63a8\u9001\u955c\u50cf\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a Docker \u9ed8\u8ba4\u4e0d\u5141\u8bb8\u975e HTTPS \u65b9\u5f0f\u63a8\u9001\u955c\u50cf\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Docker \u7684\u914d\u7f6e\u9009\u9879\u6765\u53d6\u6d88\u8fd9\u4e2a\u9650\u5236\uff0c\u6211\u4eec\u8fd9\u91cc\u662f CentOS 7 \u7cfb\u7edf\uff0c\u540c\u6837\u8fd8\u662f\u7f16\u8f91\u6587\u4ef6</p> <pre><code>/etc/docker/daemon.json\n</code></pre> <p>\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>{\n  \"registry-mirror\": [\n    \"https://registry.docker-cn.com\"\n  ],\n  \"insecure-registries\": [\n    \"111100:5000\"\n  ]\n}\n</code></pre> <p>\u5176\u4e2d\u7684<code>insecure-registries</code>\u5c31\u662f\u6211\u4eec\u6dfb\u52a0\u7684\u5185\u5bb9\uff0c\u7136\u540e\u91cd\u542f Docker \u4e4b\u540e\u5c31\u53ef\u4ee5\u5728\u5c40\u57df\u7f51\u5185\u4f7f\u7528\u6211\u4eec\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u4e86\u3002</p> <p>\u9ed8\u8ba4\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u5f88\u591a\u9700\u6c42\uff0c\u4f46\u662f\u5f80\u5f80\u5728\u4f01\u4e1a\u4e2d\u4f7f\u7528\u7684\u8bdd\u8fd8\u6709\u5f88\u5b89\u5168\u6027\u65b9\u9762\u7684\u529f\u80fd\u7684\u7f3a\u5931\uff0c\u6bd4\u5982\u6743\u9650\u7ba1\u7406\u4e4b\u7c7b\u7684\uff0c\u8fd9\u5bf9\u4e8e\u4f01\u4e1a\u6765\u8bf4\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4e0d\u8fc7 registry \u5bf9\u4e8e\u6743\u9650\u7ba1\u7406\u8fd9\u4e00\u5757\u505a\u4e86\u4e00\u4e2a\u5bf9\u5916\u66b4\u9732\u7684\u63a5\u53e3\uff0c\u53ea\u8981\u6211\u4eec\u5b9e\u73b0\u4ed6\u66b4\u9732\u7684\u5b89\u5168\u63a5\u53e3\u5c31\u53ef\u4ee5\u6765\u5b9e\u73b0\u6743\u9650\u7ba1\u7406\u76f8\u5173\u7684\u63a5\u53e3\uff0c\u5176\u4e2d\u6ce8\u660e\u7684\u5f00\u6e90\u955c\u50cf\u7ba1\u7406\u8f6f\u4ef6 Harbor \u5c31\u662f\u8fd9\u7c7b\u5e94\u7528\u7684\u4f7c\u4f7c\u8005\uff0c\u6211\u4eec\u8fd8\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u548c\u5927\u5bb6\u5b66\u4e60 Harbor \u7684\u4e00\u4e2a\u4f7f\u7528\u3002</p>"},{"location":"docker/install/","title":"\u5b89\u88c5","text":""},{"location":"docker/install/#_1","title":"\u5b89\u88c5","text":"<p>\u8981\u5b89\u88c5 Docker CE\uff08\u793e\u533a\uff09\u7248\u672c\uff0c\u63a8\u8350\u4f7f\u7528 CentOS 7\uff0c\u4f7f\u7528 <code>overlay2</code> \u5b58\u50a8\u9a71\u52a8\u7a0b\u5e8f\u3002</p>"},{"location":"docker/install/#_2","title":"\u5378\u8f7d\u65e7\u7248\u672c","text":"<p>\u65e7\u7248\u672c\u7684 Docker \u53eb <code>docker</code> \u6216\u8005 <code>docker-engine</code>\uff0c\u73b0\u5728\u7684\u7248\u672c\u88ab\u79f0\u4e3a<code>docker-ce</code>\uff0c\u5982\u679c\u4e4b\u524d\u5b89\u88c5\u8fc7\uff0c\u5219\u5148\u5378\u8f7d\u6389\u4e4b\u524d\u7684\u7248\u672c\uff1a</p> <pre><code>$ sudo yum remove docker \\\\\n                  docker-client \\\\\n                  docker-client-latest \\\\\n                  docker-common \\\\\n                  docker-latest \\\\\n                  docker-latest-logrotate \\\\\n                  docker-logrotate \\\\\n                  docker-engine\n</code></pre>"},{"location":"docker/install/#docker-ce","title":"\u5b89\u88c5 Docker-CE","text":"<p>\u8981\u5b89\u88c5 Docker \u6709\u591a\u79cd\u65b9\u6cd5\uff0c\u5927\u591a\u6570\u7528\u6237\u4f1a\u8bbe\u7f6e Docker \u7684\u5b58\u50a8\u4ed3\u5e93\u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u7b80\u5316\u6211\u4eec\u7684\u5b89\u88c5\u548c\u5347\u7ea7\uff0c\u5f53\u7136\u4e5f\u63a8\u8350\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002</p> <p>\u4f46\u662f\u5982\u679c\u4f60\u7684\u670d\u52a1\u5668\u65e0\u6cd5\u8bbf\u95ee\u4e92\u8054\u7f51\u5219\u53ef\u4ee5\u4f7f\u7528\u624b\u52a8\u4e0b\u8f7d RPM \u5b89\u88c5\u5305\u8fdb\u884c\u5b89\u88c5\uff0c\u5982\u679c\u4f60\u8981\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u5b89\u88c5\uff0c\u53ef\u4ee5\u5728\u9875\u9762 https://download.docker.com/linux/centos/7/x86_64/stable/Packages/ \u4e0b\u8f7d\u81ea\u5df1\u60f3\u8981\u5b89\u88c5\u7684 <code>.rpm</code> \u6587\u4ef6\u7136\u540e\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u901a\u8fc7\u5728\u7ebf\u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\uff0c\u9996\u5148\u5b89\u88c5\u4ed3\u5e93\uff0c\u5148\u5b89\u88c5\u4e00\u4e9b\u4f9d\u8d56\u5305\uff0c\u5176\u4e2d<code>yum-utils</code>\u63d0\u4f9b\u4e86<code>yum-config-manager</code>\u7684\u4e00\u4e9b\u5b9e\u7528\u7684\u529f\u80fd\uff1a</p> <pre><code>$ sudo yum install -y yum-utils\n</code></pre> <p>\u7136\u540e\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6dfb\u52a0 <code>stable</code> \u7248\u672c\u7684 docker \u4ed3\u5e93\uff1a</p> <pre><code>$ sudo yum-config-manager \\\\\n    --add-repo \\\\\n    https://download.docker.com/linux/centos/docker-ce.repo\n</code></pre> <p>\u6dfb\u52a0\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u5b89\u88c5\u4e86\uff0c\u5982\u679c\u8981\u5b89\u88c5\u6700\u65b0\u7248\u672c\uff0c\u76f4\u63a5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ yum install docker-ce docker-ce-cli containerd.io\n</code></pre> <p>\u5982\u679c\u8981\u5b89\u88c5\u6307\u5b9a\u7684\u7248\u672c\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u6765\u83b7\u53d6\u53ef\u5b89\u88c5\u7684\u7248\u672c\uff1a</p> <pre><code>$ yum list docker-ce --showduplicates | sort -r\n * updates: mirrors.tuna.tsinghua.edu.cn\nLoading mirror speeds from cached hostfile\nLoaded plugins: fastestmirror, langpacks\n * extras: mirrors.huaweicloud.com\ndocker-ce.x86_64            3:4-el7                     docker-ce-stable\n......\ndocker-ce.x86_64            3:9-el7                     docker-ce-stable\ndocker-ce.x86_64            3:8-el7                     docker-ce-stable\ndocker-ce.x86_64            3:7-el7                     docker-ce-stable\ndocker-ce.x86_64            3:6-el7                     docker-ce-stable\n......\ndocker-ce.x86_64            ce-el7                    docker-ce-stable\n</code></pre> <p>\u8be5\u8f6f\u4ef6\u5305\u540d\u79f0\u662f\u8f6f\u4ef6\u5305\u540d\u79f0\uff08docker-ce\uff09\u52a0\u4e0a\u7248\u672c\u5b57\u7b26\u4e32\uff08\u7b2c\u4e8c\u5217\uff09\uff0c\u4ece\u7b2c\u4e00\u4e2a\u5192\u53f7\uff08:\uff09\u5f00\u59cb\uff0c\u76f4\u81f3\u7b2c\u4e00\u4e2a\u8fde\u5b57\u7b26\uff0c\u5e76\u7528\u8fde\u5b57\u7b26\uff08-\uff09\u5206\u9694 \uff09\u3002 \u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u6765\u5b89\u88c5 docker-ce-18.09.9 \u7248\u672c\uff1a</p> <pre><code>$ sudo yum install docker-ce-9 docker-ce-cli-9 containerd.io -y\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\uff0c\u4f46\u662f\u8fd8\u6ca1\u6709\u542f\u52a8\uff0c\u7531\u4e8e\u6211\u8fd9\u91cc\u7684\u78c1\u76d8\u7a7a\u95f4\u4e0d\u5927\uff0c\u6240\u4ee5\u9700\u8981\u66f4\u6539\u4e0b Docker \u7684\u6839\u76ee\u5f55\uff0c\u5c06\u9ed8\u8ba4\u7684 <code>/var/lib/docker</code> \u66f4\u6539\u4e3a <code>/data/docker</code> \u76ee\u5f55\uff0c\u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>$ mkdir -p /etc/docker\n$ vi /etc/docker/daemon.json\n{\n  \"registry-mirrors\" : [\n    \"https://ot2k4dmirror.aliyuncs.com/\"\n  ],\n  \"graph\": \"/data/docker\"\n}\n</code></pre> <p>\u955c\u50cf\u52a0\u901f\u5668</p> <p>\u4f7f\u7528\u52a0\u901f\u5668\u53ef\u4ee5\u63d0\u5347\u83b7\u53d6 Docker \u5b98\u65b9\u955c\u50cf\u7684\u901f\u5ea6\uff0c\u5efa\u8bae\u6ce8\u518c\u963f\u91cc\u4e91\u5e10\u53f7\uff0c\u4f7f\u7528\u963f\u91cc\u4e91\u63d0\u4f9b\u7684\u955c\u50cf\u52a0\u901f\u670d\u52a1\uff0c\u5730\u5740\uff1ahttps://cr.console.aliyun.com/cn-beijing/instances/mirrors\u3002</p> <p>\u7136\u540e\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u542f\u52a8 docker\uff1a</p> <pre><code># \u8bbe\u7f6e\u4e3a\u5f00\u673a\u542f\u52a8\n$ systemctl enable docker  \n$ systemctl daemon-reload\n# \u542f\u52a8 docker\n$ systemctl start docker\n</code></pre> <p>\u542f\u52a8\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u67e5\u770b Docker \u76f8\u5173\u4fe1\u606f\uff1a</p> <pre><code>$ docker info\ndocker info\nContainers: 0\n Running: 0\n Paused: 0\n Stopped: 0\nImages: 0\nServer Version: 9\nStorage Driver: overlay2\n Backing Filesystem: extfs\n Supports d_type: true\n Native Overlay Diff: false\nLogging Driver: json-file\nCgroup Driver: cgroupfs\nPlugins:\n Volume: local\n Network: bridge host macvlan null overlay\n Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog\nSwarm: inactive\nRuntimes: runc\nDefault Runtime: runc\nInit Binary: docker-init\ncontainerd version: b34a5c8af56e510852c35414db4c1f4fa6172339\nrunc version: 3e425f80a8c931f88e6d94a8c831b9d5aa481657\ninit version: fec3683\nSecurity Options:\n seccomp\n  Profile: default\nKernel Version: 0-3elx86_64\nOperating System: CentOS Linux 7 (Core)\nOSType: linux\nArchitecture: x86_64\nCPUs: 4\nTotal Memory: 64GiB\nName: pnhmltdr\nID: VIBG:JCTE:KBVO:ETXD:OZH4:SXCH:MA7Y:YFFB:KQEX:OLAM:I25P:F2TM\nDocker Root Dir: /data/docker\nDebug Mode (client): false\nDebug Mode (server): false\nRegistry: https://index.docker.io/v1/\nLabels:\nExperimental: false\nInsecure Registries:\n 10/8\nRegistry Mirrors:\n https://ot2k4dmirror.aliyuncs.com/\nLive Restore Enabled: false\nProduct License: Community Engine\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5b89\u88c5\u7684\u7248\u672c\u662f 18.09.9\uff0c\u9ed8\u8ba4\u7684\u5b58\u50a8\u9a71\u52a8\u7a0b\u5e8f\u662f <code>overlay2</code>\uff0c\u800c\u4e14 <code>Root Dir</code> \u4e5f\u5df2\u7ecf\u662f\u6211\u4eec\u66f4\u6539\u540e\u7684\u76ee\u5f55\u4e86\u3002</p>"},{"location":"docker/install/#_3","title":"\u6d4b\u8bd5","text":"<p>Docker \u542f\u52a8\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u8fd0\u884c\u4e00\u4e2a\u6d4b\u8bd5\u5bb9\u5668\uff1a</p> <pre><code>$ docker run hello-world\nUnable to find image 'hello-world:latest' locally\nlatest: Pulling from library/hello-world\n1b930d010525: Pull complete\nDigest: sha256:c3b4ada4687bbaa170745b3e4dd8ac3f194ca95b2d0518b417fb47e5879d9b5f\nStatus: Downloaded newer image for hello-world:latest\n\nHello from Docker!\nThis message shows that your installation appears to be working correctly.\n\nTo generate this message, Docker took the following steps:\n  The Docker client contacted the Docker daemon.\n  The Docker daemon pulled the \"hello-world\" image from the Docker Hub.\n    (amd64)\n  The Docker daemon created a new container from that image which runs the\n    executable that produces the output you are currently reading.\n  The Docker daemon streamed that output to the Docker client, which sent it\n    to your terminal.\n\nTo try something more ambitious, you can run an Ubuntu container with:\n $ docker run -it ubuntu bash\n\nShare images, automate workflows, and more with a free Docker ID:\n https://hub.docker.com/\n\nFor more examples and ideas, visit:\n https://docs.docker.com/get-started/\n</code></pre> <p>\u770b\u5230\u5982\u4e0a\u7684\u4e00\u4e9b\u4fe1\u606f\u6253\u5370\u51fa\u6765\u8bc1\u660e\u6211\u4eec\u7684 Docker \u5c31\u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\u3002</p>"},{"location":"docker/overview/","title":"\u7b80\u4ecb","text":""},{"location":"docker/overview/#_1","title":"\u7b80\u4ecb","text":"<p>\u4f60\u9700\u8981\u4e86\u89e3\u7684 Docker</p> <p>\u5728\u4e86\u89e3\u5b66\u4e60 Docker \u4e4b\u524d\u6211\u4eec\u5c31\u975e\u5e38\u6709\u5fc5\u8981\u4ecb\u7ecd\u4e0b Docker \u7684\u524d\u751f LXC\uff08Linux Container\uff09\u3002</p> <p></p>"},{"location":"docker/overview/#lxc","title":"LXC \u4ecb\u7ecd","text":"<p>LXC \u53ef\u4ee5\u63d0\u4f9b\u8f7b\u91cf\u7ea7\u7684\u865a\u62df\u5316\uff0c\u7528\u6765\u9694\u79bb\u8fdb\u7a0b\u548c\u8d44\u6e90\uff0c\u548c\u6211\u4eec\u4f20\u7edf\u89c2\u5ff5\u4e2d\u7684\u5168\u865a\u62df\u5316\u5b8c\u5168\u4e0d\u4e00\u6837\uff0c\u975e\u5e38\u8f7b\u91cf\u7ea7\u3002LXC \u53ef\u4ee5\u5c06\u5355\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u7ba1\u7406\u7684\u8d44\u6e90\u5212\u5206\u5230\u72ec\u7acb\u7684\u7ec4\u4e2d\uff0c\u548c\u4f20\u7edf\u7684\u865a\u62df\u5316\u6280\u672f\u76f8\u6bd4\uff0cLXC \u6709\u5982\u4e0b\u4e00\u4e9b\u4f18\u52bf\uff1a</p> <ul> <li>\u548c\u5bbf\u4e3b\u673a\u4f7f\u7528\u540c\u4e00\u4e2a\u5185\u6838\uff0c\u6240\u4ee5\u6027\u80fd\u635f\u8017\u5c0f</li> <li>\u4e0d\u9700\u8981\u6307\u4ee4\u7ea7\u6a21\u62df</li> <li>\u4e0d\u9700\u8981\u5373\u65f6\u7f16\u8bd1</li> <li>\u5bb9\u5668\u53ef\u4ee5\u5728 CPU \u6838\u5fc3\u7684\u672c\u5730\u8fd0\u884c\u6307\u4ee4\uff0c\u4e0d\u9700\u8981\u4efb\u4f55\u4e13\u95e8\u7684\u89e3\u91ca\u673a\u5236</li> <li>\u907f\u514d\u4e86\u865a\u62df\u5316\u548c\u7cfb\u7edf\u8c03\u7528\u4e2d\u7684\u590d\u6742\u6027</li> <li>\u8f7b\u91cf\u7ea7\u9694\u79bb\uff0c\u9694\u79bb\u7684\u540c\u65f6\u8fd8\u53ef\u4ee5\u548c\u5bbf\u4e3b\u673a\u5171\u4eab\u8d44\u6e90</li> </ul> <p>LXC \u6709\u70b9\u50cf chroot\uff0c\u63d0\u4f9b\u4e86\u4e00\u4e2a\u62e5\u6709\u81ea\u5df1\u8fdb\u7a0b\u548c\u7f51\u7edc\u7a7a\u95f4\u7684\u865a\u62df\u73af\u5883\uff0c\u4f46\u662f\u548c\u865a\u62df\u673a\u53c8\u4e0d\u4e00\u6837\uff0c\u56e0\u4e3a LXC \u662f\u4e00\u79cd\u64cd\u4f5c\u7cfb\u7edf\u5c42\u9762\u4e0a\u7684\u8d44\u6e90\u7684\u865a\u62df\u5316\u3002</p> <p>chroot \u7b80\u4ecb</p> <p>chroot\uff08change root\uff09\uff0c\u5728 Linux \u7cfb\u7edf\u4e2d\uff0c\u7cfb\u7edf\u9ed8\u8ba4\u7684\u76ee\u5f55\u5c31\u90fd\u662f\u4ee5 <code>/</code> \u4e5f\u5c31\u662f\u6839\u76ee\u5f55\u5f00\u5934\u7684\uff0cchroot \u7684\u4f7f\u7528\u80fd\u591f\u6539\u53d8\u5f53\u524d\u7684\u7cfb\u7edf\u6839\u76ee\u5f55\u7ed3\u6784\uff0c\u901a\u8fc7\u6539\u53d8\u5f53\u524d\u7cfb\u7edf\u7684\u6839\u76ee\u5f55\uff0c\u6211\u4eec\u80fd\u591f\u9650\u5236\u7528\u6237\u7684\u6743\u5229\uff0c\u5728\u65b0\u7684\u6839\u76ee\u5f55\u4e0b\u5e76\u4e0d\u80fd\u591f\u8bbf\u95ee\u65e7\u7cfb\u7edf\u6839\u76ee\u5f55\u7684\u7ed3\u6784\u4e2a\u6587\u4ef6\uff0c\u4e5f\u5c31\u5efa\u7acb\u4e86\u4e00\u4e2a\u4e0e\u539f\u7cfb\u7edf\u5b8c\u5168\u9694\u79bb\u7684\u76ee\u5f55\u7ed3\u6784\u3002</p> <p>\u66f4\u591a\u5173\u4e8e chroot \u7684\u4ecb\u7ecd\uff0c\u53ef\u4ee5\u67e5\u770b \u7406\u89e3 chroot \u4e00\u6587\u3002</p>"},{"location":"docker/overview/#docker","title":"\u4ec0\u4e48\u662f Docker","text":"<p>Docker \u5e76\u4e0d\u662f LXC \u66ff\u4ee3\u54c1\uff0cDocker \u5e95\u5c42\u5c31\u662f\u4f7f\u7528\u7684 LXC \u6765\u5b9e\u73b0\uff0cLXC \u5c06 Linux \u8fdb\u7a0b\u6c99\u76d2\u5316\uff0c\u4f7f\u5f97\u8fdb\u7a0b\u4e4b\u95f4\u76f8\u4e92\u9694\u79bb\uff0c\u8fd8\u53ef\u4ee5\u5171\u4eab\u5bbf\u4e3b\u673a\u7684\u8d44\u6e90\u3002\u5728 LXC \u7684\u57fa\u7840\u4e0a\uff0cDocker \u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u66f4\u52a0\u5f3a\u5927\u65b9\u4fbf\u7684\u529f\u80fd\uff0c\u4f7f\u5f97 Docker \u6210\u4e3a\u4e86\u73b0\u5728\u6700\u706b\u7684\u865a\u62df\u5316\u6280\u672f\u3002</p> <p>\u7531\u4e8e\u4e4b\u524d\u6211\u4eec\u7684\u540e\u53f0\u5728\u5f00\u53d1\u548c\u8fd0\u7ef4\u9636\u6bb5\u7684\u73af\u5883\u662f\u4e0d\u4e00\u81f4\u7684\uff0c\u8fd9\u5c31\u5bfc\u81f4\u4e86 Docker \u7684\u51fa\u73b0\uff0c\u56e0\u4e3a\u6211\u4eec\u901a\u8fc7 Docker \u53ef\u4ee5\u5c06\u7a0b\u5e8f\u8fd0\u884c\u7684\u73af\u5883\u4e5f\u4e00\u8d77\u6253\u5305\u5230\u7248\u672c\u63a7\u5236\u53bb\u4e86\uff0c\u8fd9\u6837\u5c31\u6392\u9664\u4e86\u56e0\u4e3a\u73af\u5883\u4e0d\u540c\u9020\u6210\u7684\u5404\u79cd\u9ebb\u70e6\u4e8b\u60c5\u4e86\uff0c\u4e5f\u4e0d\u4f1a\u51fa\u73b0\u5728\u672c\u5730\u53ef\u4ee5\u5728\u7ebf\u4e0a\u5374\u4e0d\u884c\u8fd9\u6837\u7684\u7a98\u5883\u4e86\u3002</p> <p>Docker \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u5e94\u7528\u5bb9\u5668\u5f15\u64ce\uff0c\u57fa\u4e8e go \u8bed\u8a00\u5f00\u53d1\uff0c\u53ef\u4ee5\u8ba9\u5f00\u53d1\u8005\u6253\u5305\u4ed6\u4eec\u7684\u5e94\u7528\u4ee5\u53ca\u4f9d\u8d56\u5305\u5230\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u3001\u53ef\u79fb\u690d\u7684\u5bb9\u5668\u4e2d\uff0c\u7136\u540e\u53d1\u5e03\u5230\u4efb\u4f55\u6d41\u884c\u7684 Linux \u670d\u52a1\u5668\u3002\u5bb9\u5668\u662f\u4e00\u4e2a\u6c99\u7bb1\u673a\u5236\uff0c\u76f8\u4e92\u4e4b\u95f4\u4e0d\u4f1a\u6709\u5f71\u54cd\uff08\u7c7b\u4f3c\u4e8e\u6211\u4eec\u624b\u673a\u4e0a\u8fd0\u884c\u7684 app\uff09\uff0c\u5e76\u4e14\u5bb9\u5668\u5f00\u9500\u662f\u5f88\u4f4e\u7684\u3002</p> <p>\u7528\u5b98\u65b9\u7684\u8bdd\u6765\u8bf4\uff0cDocker \u53d7\u6b22\u8fce\uff0c\u662f\u56e0\u4e3a\u4ee5\u4e0b\u51e0\u4e2a\u7279\u70b9\uff1a</p> <ul> <li>\u7075\u6d3b\u6027\uff1a\u5373\u4f7f\u662f\u6700\u590d\u6742\u7684\u5e94\u7528\u4e5f\u53ef\u4ee5\u96c6\u88c5\u7bb1\u5316</li> <li>\u8f7b\u91cf\u7ea7\uff1a\u5bb9\u5668\u5229\u7528\u5e76\u5171\u4eab\u4e3b\u673a\u5185\u6838</li> <li>\u53ef\u4e92\u6362\uff1a\u60a8\u53ef\u4ee5\u5373\u65f6\u90e8\u7f72\u66f4\u65b0\u548c\u5347\u7ea7</li> <li>\u4fbf\u643a\u5f0f\uff1a\u60a8\u53ef\u4ee5\u5728\u672c\u5730\u6784\u5efa\uff0c\u90e8\u7f72\u5230\u4e91\uff0c\u5e76\u5728\u4efb\u4f55\u5730\u65b9\u8fd0\u884c</li> <li>\u53ef\u6269\u5c55\uff1a\u60a8\u53ef\u4ee5\u589e\u52a0\u5e76\u81ea\u52a8\u5206\u53d1\u5bb9\u5668\u526f\u672c</li> <li>\u53ef\u5806\u53e0\uff1a\u60a8\u53ef\u4ee5\u5782\u76f4\u548c\u5373\u65f6\u5806\u53e0\u670d\u52a1</li> </ul>"},{"location":"docker/overview/#docker_1","title":"Docker \u51e0\u4e2a\u91cd\u8981\u6982\u5ff5","text":"<p>\u5728\u4e86\u89e3\u4e86 Docker \u662f\u4ec0\u4e48\u4e4b\u540e\uff0c\u6211\u4eec\u9700\u8981\u5148\u4e86\u89e3\u4e0b Docker \u4e2d\u6700\u91cd\u8981\u76843\u4e2a\u6982\u5ff5\uff1a\u955c\u50cf\u3001\u5bb9\u5668\u548c\u4ed3\u5e93\u3002</p> <p><code>\u955c\u50cf</code> \u662f\u4e00\u4e2a\u53ea\u8bfb\u6a21\u677f\uff0c\u5e26\u6709\u521b\u5efa Docker \u5bb9\u5668\u7684\u8bf4\u660e\uff0c\u4e00\u822c\u6765\u8bf4\u7684\uff0c\u955c\u50cf\u4f1a\u57fa\u4e8e\u53e6\u5916\u7684\u4e00\u4e9b\u57fa\u7840\u955c\u50cf\u5e76\u52a0\u4e0a\u4e00\u4e9b\u989d\u5916\u7684\u81ea\u5b9a\u4e49\u529f\u80fd\u6765\u7ec4\u6210\u3002\u6bd4\u5982\uff0c\u4f60\u53ef\u4ee5\u6784\u5efa\u4e00\u4e2a\u57fa\u4e8e Centos \u7684\u955c\u50cf\uff0c\u7136\u540e\u5728\u8fd9\u4e2a\u57fa\u7840\u955c\u50cf\u4e0a\u9762\u5b89\u88c5\u4e00\u4e2a Nginx \u670d\u52a1\u5668\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u6784\u6210\u4e00\u4e2a\u5c5e\u4e8e\u6211\u4eec\u81ea\u5df1\u7684\u955c\u50cf\u4e86\u3002</p> <p><code>\u5bb9\u5668</code> \u662f\u4e00\u4e2a\u955c\u50cf\u7684\u53ef\u8fd0\u884c\u7684\u5b9e\u4f8b\uff0c\u53ef\u4ee5\u4f7f\u7528 Docker REST API \u6216\u8005 CLI \u547d\u4ee4\u884c\u5de5\u5177\u6765\u64cd\u4f5c\u5bb9\u5668\uff0c\u5bb9\u5668\u7684\u672c\u8d28\u662f\u8fdb\u7a0b\uff0c\u4f46\u4e0e\u76f4\u63a5\u5728\u5bbf\u4e3b\u6267\u884c\u7684\u8fdb\u7a0b\u4e0d\u540c\uff0c\u5bb9\u5668\u8fdb\u7a0b\u8fd0\u884c\u4e8e\u5c5e\u4e8e\u81ea\u5df1\u7684\u72ec\u7acb\u7684\u547d\u540d\u7a7a\u95f4\u3002\u56e0\u6b64\u5bb9\u5668\u53ef\u4ee5\u62e5\u6709\u81ea\u5df1\u7684 root \u6587\u4ef6\u7cfb\u7edf\u3001\u81ea\u5df1\u7684\u7f51\u7edc\u914d\u7f6e\u3001\u81ea\u5df1\u7684\u8fdb\u7a0b\u7a7a\u95f4\uff0c\u751a\u81f3\u81ea\u5df1\u7684\u7528\u6237 ID \u7a7a\u95f4\u3002\u5bb9\u5668\u5185\u7684\u8fdb\u7a0b\u662f\u8fd0\u884c\u5728\u4e00\u4e2a\u9694\u79bb\u7684\u73af\u5883\u91cc\uff0c\u4f7f\u7528\u8d77\u6765\uff0c\u5c31\u597d\u50cf\u662f\u5728\u4e00\u4e2a\u72ec\u7acb\u4e8e\u5bbf\u4e3b\u7684\u7cfb\u7edf\u4e0b\u64cd\u4f5c\u4e00\u6837\u3002\u8fd9\u79cd\u7279\u6027\u4f7f\u5f97\u5bb9\u5668\u5c01\u88c5\u7684\u5e94\u7528\u6bd4\u76f4\u63a5\u5728\u5bbf\u4e3b\u8fd0\u884c\u66f4\u52a0\u5b89\u5168\u3002</p> <p><code>registry</code> \u662f\u7528\u6765\u5b58\u50a8 Docker \u955c\u50cf\u7684\u4ed3\u5e93\uff0cDocker Hub \u662f Docker \u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u516c\u5171\u4ed3\u5e93\uff0c\u800c\u4e14 Docker \u9ed8\u8ba4\u4e5f\u662f\u4ece Docker Hub \u4e0a\u67e5\u627e\u955c\u50cf\u7684\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u8fd0\u884c\u4e00\u4e2a\u79c1\u6709\u4ed3\u5e93\uff0c\u5f53\u6211\u4eec\u4f7f\u7528 <code>docker pull</code> \u6216\u8005 <code>docker run</code> \u547d\u4ee4\u65f6\uff0c\u5c31\u4f1a\u4ece\u6211\u4eec\u914d\u7f6e\u7684 Docker \u955c\u50cf\u4ed3\u5e93\u4e2d\u53bb\u62c9\u53d6\u955c\u50cf\uff0c\u4f7f\u7528 <code>docker push</code> \u547d\u4ee4\u65f6\uff0c\u4f1a\u5c06\u6211\u4eec\u6784\u5efa\u7684\u955c\u50cf\u63a8\u9001\u5230\u5bf9\u5e94\u7684\u955c\u50cf\u4ed3\u5e93\u4e2d\uff0cregistry \u53ef\u4ee5\u7406\u89e3\u4e3a\u7528\u4e8e\u955c\u50cf\u7684 github \u8fd9\u6837\u7684\u6258\u7ba1\u670d\u52a1\u3002</p>"},{"location":"docker/overview/#_2","title":"\u5bb9\u5668\u548c\u865a\u62df\u673a","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bf4\u5230\u4e86\u5bb9\u5668\u662f\u5728 Linux \u4e0a\u672c\u673a\u8fd0\u884c\uff0c\u5e76\u4e0e\u5176\u4ed6\u5bb9\u5668\u5171\u4eab\u4e3b\u673a\u7684\u5185\u6838\uff0c\u5b83\u8fd0\u884c\u4e00\u4e2a\u72ec\u7acb\u7684\u8fdb\u7a0b\uff0c\u4e0d\u5360\u7528\u5176\u4ed6\u4efb\u4f55\u53ef\u6267\u884c\u6587\u4ef6\u7684\u5185\u5b58\uff0c\u975e\u5e38\u8f7b\u91cf\u3002</p> <p>\u800c\u865a\u62df\u673a\u8fd0\u884c\u7684\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u901a\u8fc7\u865a\u62df\u673a\u7ba1\u7406\u7a0b\u5e8f\u5bf9\u4e3b\u673a\u8d44\u6e90\u8fdb\u884c\u865a\u62df\u8bbf\u95ee\uff0c\u76f8\u6bd4\u4e4b\u4e0b\u9700\u8981\u7684\u8d44\u6e90\u9700\u8981\u66f4\u591a\uff0c\u4f46\u662f\u975e\u5e38\u5b89\u5168\uff0c\u56e0\u4e3a\u662f\u72ec\u7acb\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u72ec\u7acb\u7684\u5185\u6838\u3002</p> <p></p>"},{"location":"docker/overview/#docker_2","title":"\u652f\u6301 Docker \u7684\u5e95\u5c42\u6280\u672f","text":"<p><code>Docker \u672c\u8d28\u5c31\u662f\u5bbf\u4e3b\u673a\u7684\u4e00\u4e2a\u7279\u6b8a\u8fdb\u7a0b</code>\uff0cDocker \u662f\u901a\u8fc7 <code>namespace</code> \u5b9e\u73b0\u8d44\u6e90\u9694\u79bb\uff0c\u901a\u8fc7<code>cgroup</code> \u5b9e\u73b0\u8d44\u6e90\u9650\u5236\uff0c\u901a\u8fc7\u5199\u65f6\u590d\u5236\u6280\u672f\uff08copy-on-write\uff09\u5b9e\u73b0\u4e86\u9ad8\u6548\u7684\u6587\u4ef6\u64cd\u4f5c\uff08\u7c7b\u4f3c\u865a\u62df\u673a\u7684\u78c1\u76d8\u6bd4\u5982\u5206\u914d 500g \u5e76\u4e0d\u662f\u5b9e\u9645\u5360\u7528\u7269\u7406\u78c1\u76d8 500g\uff09</p>"},{"location":"docker/overview/#namespaces","title":"Namespaces","text":"<p>\u547d\u540d\u7a7a\u95f4 (namespaces) \u662f Linux \u4e3a\u6211\u4eec\u63d0\u4f9b\u7684\u7528\u4e8e\u5206\u79bb\u8fdb\u7a0b\u6811\u3001\u7f51\u7edc\u63a5\u53e3\u3001\u6302\u8f7d\u70b9\u4ee5\u53ca\u8fdb\u7a0b\u95f4\u901a\u4fe1\u7b49\u8d44\u6e90\u7684\u65b9\u6cd5\u3002\u5728\u65e5\u5e38\u4f7f\u7528\u4e2a\u4eba PC \u65f6\uff0c\u6211\u4eec\u5e76\u6ca1\u6709\u8fd0\u884c\u591a\u4e2a\u5b8c\u5168\u5206\u79bb\u7684\u670d\u52a1\u5668\u7684\u9700\u6c42\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u5728\u670d\u52a1\u5668\u4e0a\u542f\u52a8\u4e86\u591a\u4e2a\u670d\u52a1\uff0c\u8fd9\u4e9b\u670d\u52a1\u5176\u5b9e\u4f1a\u76f8\u4e92\u5f71\u54cd\u7684\uff0c\u6bcf\u4e00\u4e2a\u670d\u52a1\u90fd\u80fd\u770b\u5230\u5176\u4ed6\u670d\u52a1\u7684\u8fdb\u7a0b\uff0c\u4e5f\u53ef\u4ee5\u8bbf\u95ee\u5bbf\u4e3b\u673a\u5668\u4e0a\u7684\u4efb\u610f\u6587\u4ef6\uff0c\u4e00\u65e6\u670d\u52a1\u5668\u4e0a\u7684\u67d0\u4e00\u4e2a\u670d\u52a1\u88ab\u5165\u4fb5\uff0c\u90a3\u4e48\u5165\u4fb5\u8005\u5c31\u80fd\u591f\u8bbf\u95ee\u5f53\u524d\u673a\u5668\u4e0a\u7684\u6240\u6709\u670d\u52a1\u548c\u6587\u4ef6\uff0c\u8fd9\u662f\u6211\u4eec\u4e0d\u613f\u610f\u770b\u5230\u7684\uff0c\u6211\u4eec\u66f4\u5e0c\u671b\u8fd0\u884c\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\u7684\u4e0d\u540c\u670d\u52a1\u80fd\u505a\u5230\u5b8c\u5168\u9694\u79bb\uff0c\u5c31\u50cf\u8fd0\u884c\u5728\u591a\u53f0\u4e0d\u540c\u7684\u673a\u5668\u4e0a\u4e00\u6837\u3002\u800c Docker \u5176\u5b9e\u5c31\u901a\u8fc7 Linux \u7684 Namespaces \u6280\u672f\u6765\u5b9e\u73b0\u7684\u5bf9\u4e0d\u540c\u7684\u5bb9\u5668\u8fdb\u884c\u9694\u79bb\u3002</p> <p>\u5f53\u6211\u4eec\u8fd0\u884c\uff08docker run \u6216\u8005 docker start\uff09\u4e00\u4e2a Docker \u5bb9\u5668\u65f6\uff0cDocker \u4f1a\u4e3a\u8be5\u5bb9\u5668\u8bbe\u7f6e\u4e00\u7cfb\u5217\u7684 namespaces\uff0c\u8fd9\u4e9b namespaces \u63d0\u4f9b\u4e86\u4e00\u5c42\u9694\u79bb\uff0c\u5bb9\u5668\u7684\u5404\u4e2a\u65b9\u9762\u90fd\u5728\u5355\u72ec\u7684 namespace \u4e2d\u8fd0\u884c\uff0c\u5e76\u4e14\u5bf9\u5176\u7684\u8bbf\u95ee\u4ec5\u9650\u4e8e\u8be5 namespace\u3002</p> <p>Docker \u5728 Linux \u4e0a\u4f7f\u7528\u4ee5\u4e0b\u51e0\u4e2a\u547d\u540d\u7a7a\u95f4\uff08\u4e0a\u9762\u8bf4\u7684\u5404\u4e2a\u65b9\u9762\uff09\uff1a</p> <ul> <li>pid namespace\uff1a\u7528\u4e8e\u8fdb\u7a0b\u9694\u79bb\uff08PID\uff1a\u8fdb\u7a0bID\uff09</li> <li>net namespace\uff1a\u7ba1\u7406\u7f51\u7edc\u63a5\u53e3\uff08NET\uff1a\u7f51\u7edc\uff09</li> <li>ipc namespace\uff1a\u7ba1\u7406\u5bf9 IPC \u8d44\u6e90\u7684\u8bbf\u95ee\uff08IPC\uff1a\u8fdb\u7a0b\u95f4\u901a\u4fe1\uff08\u4fe1\u53f7\u91cf\u3001\u6d88\u606f\u961f\u5217\u548c\u5171\u4eab\u5185\u5b58\uff09\uff09</li> <li>mnt namespace\uff1a\u7ba1\u7406\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u70b9\uff08MNT\uff1a\u6302\u8f7d\uff09</li> <li>uts namespace\uff1a\u9694\u79bb\u4e3b\u673a\u540d\u548c\u57df\u540d</li> <li>user namespace\uff1a\u9694\u79bb\u7528\u6237\u548c\u7528\u6237\u7ec4\uff083.8\u4ee5\u540e\u7684\u5185\u6838\u624d\u652f\u6301\uff09</li> </ul>"},{"location":"docker/overview/#cgroups","title":"CGroups","text":"<p>\u6211\u4eec\u901a\u8fc7 Linux \u7684 namespaces \u6280\u672f\u4e3a\u65b0\u521b\u5efa\u7684\u8fdb\u7a0b\u9694\u79bb\u4e86\u6587\u4ef6\u7cfb\u7edf\u3001\u7f51\u7edc\u3001\u8fdb\u7a0b\u7b49\u8d44\u6e90\uff0c\u4f46\u662f namespaces \u5e76\u4e0d\u80fd\u591f\u4e3a\u6211\u4eec\u63d0\u4f9b\u7269\u7406\u8d44\u6e90\u4e0a\u7684\u9694\u79bb\uff0c\u6bd4\u5982 CPU\u3001\u5185\u5b58\u3001IO \u6216\u8005\u7f51\u7edc\u5e26\u5bbd\u7b49\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u8fd0\u884c\u591a\u4e2a\u5bb9\u5668\u7684\u8bdd\uff0c\u5219\u5bb9\u5668\u4e4b\u95f4\u5c31\u4f1a\u62a2\u5360\u8d44\u6e90\u4e92\u76f8\u5f71\u54cd\u4e86\uff0c\u6240\u4ee5\u5bf9\u5bb9\u5668\u8d44\u6e90\u7684\u4f7f\u7528\u8fdb\u884c\u9650\u5236\u5c31\u975e\u5e38\u91cd\u8981\u4e86\uff0c\u800c Control Groups\uff08CGroups\uff09\u6280\u672f\u5c31\u80fd\u591f\u9694\u79bb\u5bbf\u4e3b\u673a\u4e0a\u7684\u7269\u7406\u8d44\u6e90\u3002CGroups \u7531 7 \u4e2a\u4e3b\u8981\u7684\u5b50\u7cfb\u7edf\u7ec4\u6210\uff1a\u5206\u522b\u662f cpuset\u3001cpu\u3001cpuacct\u3001blkio\u3001devices\u3001freezer\u3001memory\uff0c\u4e0d\u540c\u7c7b\u578b\u8d44\u6e90\u7684\u5206\u914d\u548c\u7ba1\u7406\u662f\u7531\u5404\u4e2a CGroup \u5b50\u7cfb\u7edf\u8d1f\u8d23\u5b8c\u6210\u7684\u3002</p> <p>CGroup \u7b80\u4ecb</p> <p>\u5728 CGroup \u4e2d\uff0c\u6240\u6709\u7684\u4efb\u52a1\u5c31\u662f\u4e00\u4e2a\u7cfb\u7edf\u7684\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u800c CGroup \u5c31\u662f\u4e00\u7ec4\u6309\u7167\u67d0\u79cd\u6807\u51c6\u5212\u5206\u7684\u8fdb\u7a0b\uff0c\u5728 CGroup \u8fd9\u79cd\u673a\u5236\u4e2d\uff0c\u6240\u6709\u7684\u8d44\u6e90\u63a7\u5236\u90fd\u662f\u4ee5 CGroup \u4f5c\u4e3a\u5355\u4f4d\u5b9e\u73b0\u7684\uff0c\u6bcf\u4e00\u4e2a\u8fdb\u7a0b\u90fd\u53ef\u4ee5\u968f\u65f6\u52a0\u5165\u4e00\u4e2a CGroup \u4e5f\u53ef\u4ee5\u968f\u65f6\u9000\u51fa\u4e00\u4e2a CGroup\u3002</p> <p>\u2013 CGroup \u4ecb\u7ecd\u3001\u5e94\u7528\u5b9e\u4f8b\u53ca\u539f\u7406\u63cf\u8ff0</p> <p>\u2013 Docker \u80cc\u540e\u7684\u5185\u6838 Cgroups \u673a\u5236</p> <p>CGroup \u5177\u6709\u4ee5\u4e0b\u51e0\u4e2a\u7279\u70b9\uff1a</p> <ul> <li>CGroup \u7684 API \u4ee5\u4e00\u4e2a\u4f2a\u6587\u4ef6\u7cfb\u7edf\uff08/sys/fs/cgroup/\uff09\u7684\u5b9e\u73b0\u65b9\u5f0f\uff0c\u7528\u6237\u7684\u7a0b\u5e8f\u53ef\u4ee5\u901a\u8fc7\u6587\u4ef6\u7cfb\u7edf\u5b9e\u73b0 CGroup \u7684\u7ec4\u4ef6\u7ba1\u7406</li> <li>CGroup \u7684\u7ec4\u4ef6\u7ba1\u7406\u64cd\u4f5c\u5355\u5143\u53ef\u4ee5\u7ec6\u7c92\u5ea6\u5230\u7ebf\u7a0b\u7ea7\u522b\uff0c\u7528\u6237\u53ef\u4ee5\u521b\u5efa\u548c\u9500\u6bc1 CGroup\uff0c\u4ece\u800c\u5b9e\u73b0\u8d44\u6e90\u8f7d\u5206\u914d\u548c\u518d\u5229\u7528</li> <li>\u6240\u6709\u8d44\u6e90\u7ba1\u7406\u7684\u529f\u80fd\u90fd\u4ee5\u5b50\u7cfb\u7edf\uff08cpu\u3001cpuset \u8fd9\u4e9b\uff09\u7684\u65b9\u5f0f\u5b9e\u73b0\uff0c\u63a5\u53e3\u7edf\u4e00\u5b50\u4efb\u52a1\u521b\u5efa\u4e4b\u521d\u4e0e\u5176\u7236\u4efb\u52a1\u5904\u4e8e\u540c\u4e00\u4e2a CGroup \u7684\u63a7\u5236\u7ec4</li> </ul> <p>\u53e6\u5916 CGroup \u5177\u6709\u56db\u5927\u529f\u80fd\uff1a</p> <ul> <li>\u8d44\u6e90\u9650\u5236\uff1a\u53ef\u4ee5\u5bf9\u4efb\u52a1\u4f7f\u7528\u7684\u8d44\u6e90\u603b\u989d\u8fdb\u884c\u9650\u5236</li> <li>\u4f18\u5148\u7ea7\u5206\u914d\uff1a\u901a\u8fc7\u5206\u914d\u7684 cpu \u65f6\u95f4\u7247\u6570\u91cf\u4ee5\u53ca\u78c1\u76d8 IO \u5e26\u5bbd\u5927\u5c0f\u7b49\uff0c\u5b9e\u9645\u4e0a\u76f8\u5f53\u4e8e\u63a7\u5236\u4e86\u4efb\u52a1\u8fd0\u884c\u4f18\u5148\u7ea7</li> <li>\u8d44\u6e90\u7edf\u8ba1\uff1a\u53ef\u4ee5\u7edf\u8ba1\u7cfb\u7edf\u7684\u8d44\u6e90\u4f7f\u7528\u91cf\uff0c\u5982 cpu \u65f6\u957f\uff0c\u5185\u5b58\u7528\u91cf\u7b49</li> <li>\u4efb\u52a1\u63a7\u5236\uff1acgroup \u53ef\u4ee5\u5bf9\u4efb\u52a1\u6267\u884c\u6302\u8d77\u3001\u6062\u590d\u7b49\u64cd\u4f5c</li> </ul>"},{"location":"docker/overview/#unionfs","title":"UnionFS","text":"<p>Linux \u7684\u547d\u540d\u7a7a\u95f4\u548c\u63a7\u5236\u7ec4\u5206\u522b\u89e3\u51b3\u4e86\u4e0d\u540c\u8d44\u6e90\u9694\u79bb\u7684\u95ee\u9898\uff0c\u524d\u8005\u89e3\u51b3\u4e86\u8fdb\u7a0b\u3001\u7f51\u7edc\u4ee5\u53ca\u6587\u4ef6\u7cfb\u7edf\u7684\u9694\u79bb\uff0c\u540e\u8005\u5b9e\u73b0\u4e86 CPU\u3001\u5185\u5b58\u7b49\u8d44\u6e90\u7684\u9694\u79bb\uff0c\u4f46\u662f\u5728 Docker \u4e2d\u8fd8\u6709\u53e6\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u95ee\u9898\u9700\u8981\u89e3\u51b3 - \u4e5f\u5c31\u662f\u955c\u50cf\u3002</p> <p>\u955c\u50cf\u5230\u5e95\u662f\u4ec0\u4e48\uff0c\u5b83\u53c8\u662f\u5982\u4f55\u7ec4\u6210\u548c\u7ec4\u7ec7\u7684\u5462\uff1f\u800c\u8fd9\u5176\u4e2d\u6700\u91cd\u8981\u7684\u6982\u5ff5\u5c31\u662f\u955c\u50cf\u5c42(Layers)\uff08\u5982\u4e0b\u56fe\uff09\u7684\u6982\u5ff5\uff0c\u800c\u955c\u50cf\u5c42\u4f9d\u8d56\u4e8e\u4e00\u7cfb\u5217\u7684\u5e95\u5c42\u6280\u672f\uff0c\u6bd4\u5982\u6587\u4ef6\u7cfb\u7edf(filesystems)\u3001\u5199\u65f6\u590d\u5236(copy-on-write)\u3001\u8054\u5408\u6302\u8f7d(union mounts)\u7b49\u3002</p> <p></p> <p>Docker \u955c\u50cf\u662f\u7531\u4e00\u7cfb\u5217\u7684\u5c42\u7ec4\u6210\u7684\uff0c\u6bcf\u5c42\u4ee3\u8868 Dockerfile \u4e2d\u7684\u4e00\u6761\u6307\u4ee4\uff0c\u6bd4\u5982\u4e0b\u9762\u7684 Dockerfile \u6587\u4ef6\uff1a</p> <pre><code>FROM ubuntu:04\nCOPY . /app\nRUN make /app\nCMD python /app/app.py\n</code></pre> <p>Dockerfile \u4ecb\u7ecd</p> <p><code>Dockerfile</code> \u662f\u4e00\u4e2a\u6587\u672c\u6587\u4ef6\uff0c\u5176\u5185\u5305\u542b\u4e86\u4e00\u6761\u6761\u7684\u6307\u4ee4\uff0c\u6bcf\u4e00\u6761\u6307\u4ee4\u6784\u5efa\u4e00\u5c42\uff0c\u56e0\u6b64\u6bcf\u4e00\u6761\u6307\u4ee4\u7684\u5185\u5bb9\uff0c\u5c31\u662f\u63cf\u8ff0\u8be5\u5c42\u5e94\u5f53\u5982\u4f55\u6784\u5efa\u3002Dockerfile \u662f\u6211\u4eec\u7528\u6765\u6784\u5efa Docker \u955c\u50cf\u7684\u4e00\u4e2a\u8bf4\u660e\u6587\u6863\uff0c\u4e5f\u662f\u6211\u4eec\u5b66\u4e60\u7684\u91cd\u70b9\uff0c\u5fc5\u987b\u8981\u8981\u638c\u63e1\u5982\u4f55\u7f16\u5199 Dockerfile\u3002</p> <p>\u8fd9\u91cc\u7684 Dockerfile \u5305\u542b4\u6761\u547d\u4ee4\uff0c\u5176\u4e2d\u6bcf\u4e00\u884c\u5c31\u521b\u5efa\u4e86\u4e00\u5c42\uff0c<code>FROM</code> \u8bed\u53e5\u4ece <code>ubuntu:18.04</code> \u8fd9\u4e2a\u57fa\u7840\u955c\u50cf\u521b\u5efa\u4e00\u4e2a\u5c42\u5f00\u59cb\uff0c<code>COPY</code> \u547d\u4ee4\u4ece Docker \u5ba2\u6237\u7aef\u7684\u5f53\u524d\u76ee\u5f55\u6dfb\u52a0\u4e00\u4e9b\u65b0\u7684\u6587\u4ef6\uff0c<code>RUN</code> \u6307\u4ee4\u4f7f\u7528 make \u547d\u4ee4\u6784\u5efa\u5e94\u7528\uff0c\u6700\u540e\u4e00\u5c42\u6307\u5b9a\u5728\u5bb9\u5668\u4e2d\u8fd0\u884c\u4ec0\u4e48\u547d\u4ee4\u3002</p> <p>\u955c\u50cf\u5c31\u662f\u7531\u8fd9\u4e9b\u5c42\u4e00\u5c42\u4e00\u5c42\u5806\u53e0\u8d77\u6765\u7684\uff0c\u955c\u50cf\u4e2d\u7684\u8fd9\u4e9b\u5c42\u90fd\u662f\u53ea\u8bfb\u7684\uff0c\u5f53\u6211\u4eec\u8fd0\u884c\u5bb9\u5668\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u5728\u8fd9\u4e9b\u57fa\u7840\u5c42\u4e4b\u4e0a\u6dfb\u52a0\u65b0\u7684\u53ef\u5199\u5c42\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u901a\u5e38\u8bf4\u7684<code>\u5bb9\u5668\u5c42</code>\uff0c\u5bf9\u4e8e\u8fd0\u884c\u4e2d\u7684\u5bb9\u5668\u6240\u505a\u7684\u6240\u6709\u66f4\u6539\uff08\u6bd4\u5982\u5199\u5165\u65b0\u6587\u4ef6\u3001\u4fee\u6539\u73b0\u6709\u6587\u4ef6\u3001\u5220\u9664\u6587\u4ef6\uff09\u90fd\u5c06\u5199\u5165\u8fd9\u4e2a\u5bb9\u5668\u5c42\uff0c\u4e0b\u9762\u663e\u793a\u4e86\u57fa\u4e8e Ubuntu 15.04 \u955c\u50cf\u8fd0\u884c\u7684\u5bb9\u5668\u5c42\u7684\u7ed3\u6784\uff1a</p> <p></p> <p>\u5bb9\u5668\u548c\u955c\u50cf\u4e4b\u95f4\u7684\u4e3b\u8981\u533a\u522b\u5c31\u662f\u5bb9\u5668\u5728\u955c\u50cf\u9876\u90e8\u7531\u4e00\u4e2a\u53ef\u5199\u5c42\uff0c\u5728\u5bb9\u5668\u4e2d\u7684\u6240\u6709\u64cd\u4f5c\u90fd\u4f1a\u5b58\u50a8\u5728\u8fd9\u4e2a\u5bb9\u5668\u5c42\u4e2d\uff0c\u5220\u9664\u5bb9\u5668\u540e\uff0c\u5bb9\u5668\u5c42\u4e5f\u4f1a\u88ab\u5220\u9664\uff0c\u4f46\u662f\u955c\u50cf\u4e0d\u4f1a\u53d8\u5316\u3002\u6b63\u56e0\u4e3a\u6bcf\u4e2a\u5bb9\u5668\u90fd\u6709\u81ea\u5df1\u7684\u53ef\u5199\u5bb9\u5668\u5c42\uff0c\u6240\u6709\u66f4\u6539\u90fd\u5b58\u50a8\u5728\u81ea\u5df1\u7684\u5bb9\u5668\u5c42\u4e2d\uff0c\u6240\u4ee5\u591a\u4e2a\u5bb9\u5668\u4e4b\u95f4\u53ef\u4ee5\u5171\u4eab\u540c\u4e00\u57fa\u7840\u955c\u50cf\u7684\u8bbf\u95ee\uff0c\u4f46\u4ecd\u7136\u5177\u6709\u81ea\u5df1\u7684\u6570\u636e\u72b6\u6001\u3002\u5982\u4e0b\u56fe\u6f14\u793a\u4e86\u591a\u4e2a\u5bb9\u5668\u5171\u4eab\u540c\u4e00\u955c\u50cf\u7684\u8bf7\u60c5\u51b5\uff1a</p> <p></p> <p>Docker \u4f7f\u7528\u5b58\u50a8\u9a71\u52a8\u7a0b\u5e8f\u6765\u7ba1\u7406\u955c\u50cf\u5c42\u548c\u53ef\u5199\u5bb9\u5668\u5c42\u7684\u5185\u5bb9\uff0c\u6bcf\u4e2a\u5b58\u50a8\u9a71\u52a8\u7a0b\u5e8f\u7684\u5904\u7406\u65b9\u5f0f\u4e0d\u540c\uff0c\u4f46\u662f\u6240\u6709\u7684\u9a71\u52a8\u90fd\u4f7f\u7528\u53ef\u5806\u53e0\u7684\u955c\u50cf\u5c42\u548c\u5199\u65f6\u590d\u5236\uff08Cow\uff09\u7b56\u7565\uff0c\u8fd9\u4e9b\u9a71\u52a8\u7a0b\u5e8f\u7ba1\u7406\u7684\u8fd9\u4e9b\u5c42\u5176\u5b9e\u5c31\u662f UnionFS\uff08\u8054\u5408\u6587\u4ef6\u7cfb\u7edf\uff09\uff0c\u73b0\u5728 Docker \u4e3b\u8981\u652f\u6301\u7684\u5b58\u50a8\u9a71\u52a8\u6709 aufs\u3001devicemapper\u3001overlay\u3001overlay2\u3001zfs \u548c vfs \u7b49\u7b49\uff0c\u5728\u65b0\u7684 Docker \u7248\u672c\u4e2d\uff0coverlay2 \u53d6\u4ee3\u4e86 aufs \u6210\u4e3a\u4e86\u63a8\u8350\u7684\u5b58\u50a8\u9a71\u52a8\u3002</p> <p>Copy-on-write</p> <p>\u5199\u65f6\u590d\u5236\u662f\u4e00\u79cd\u5171\u4eab\u548c\u590d\u5236\u6587\u4ef6\u7684\u7b56\u7565\uff0c\u53ef\u4ee5\u6700\u5927\u7a0b\u5ea6\u5730\u63d0\u9ad8\u6548\u7387\uff0c\u5982\u679c\u6587\u4ef6\u6216\u76ee\u5f55\u4f4d\u4e8e\u955c\u50cf\u7684\u8f83\u4f4e\u5c42\u4e2d\uff0c\u800c\u53e6\u4e00\u5c42\uff08\u5305\u62ec\u53ef\u5199\u5c42\uff09\u9700\u8981\u5bf9\u5176\u8fdb\u884c\u8bfb\u53d6\u8bbf\u95ee\uff0c\u5219\u5b83\u76f4\u63a5\u4f7f\u7528\u73b0\u6709\u6587\u4ef6\u5373\u53ef\u3002\u53e6\u4e00\u5c42\u7b2c\u4e00\u6b21\u9700\u8981\u4fee\u6539\u6587\u4ef6\u65f6\uff08\u5728\u6784\u5efa\u955c\u50cf\u6216\u8fd0\u884c\u5bb9\u5668\u65f6\uff09\uff0c\u5c06\u6587\u4ef6\u590d\u5236\u5230\u8be5\u5c42\u5e76\u8fdb\u884c\u4fee\u6539\u3002\u8fd9\u6837\u53ef\u4ee5\u5c06 I/O \u548c\u6bcf\u4e2a\u540e\u7eed\u5c42\u7684\u5927\u5c0f\u6700\u5c0f\u5316\u3002</p> <p>\u9009\u62e9\u5b58\u50a8\u9a71\u52a8</p> <p>\u5bf9\u4e8e Docker \u5982\u4f55\u9009\u62e9\u4e00\u4e2a\u5408\u9002\u7684\u5b58\u50a8\u9a71\u52a8\u7a0b\u5e8f\uff0c\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863 Docker storage drivers\u3002</p>"},{"location":"docker/overview/#docker_3","title":"Docker \u67b6\u6784","text":"<p>Docker \u4f7f\u7528 C/S \uff08\u5ba2\u6237\u7aef/\u670d\u52a1\u5668\uff09\u4f53\u7cfb\u7684\u67b6\u6784\uff0cDocker \u5ba2\u6237\u7aef\u4e0e Docker \u5b88\u62a4\u8fdb\u7a0b\uff08Dockerd\uff09\u901a\u4fe1\uff0cDocker \u5b88\u62a4\u8fdb\u7a0b\u8d1f\u8d23\u6784\u5efa\uff0c\u8fd0\u884c\u548c\u5206\u53d1 Docker \u5bb9\u5668\u3002Docker \u5ba2\u6237\u7aef\u548c\u5b88\u62a4\u8fdb\u7a0b\u53ef\u4ee5\u5728\u540c\u4e00\u4e2a\u7cfb\u7edf\u4e0a\u8fd0\u884c\uff0c\u4e5f\u53ef\u4ee5\u5c06 Docker \u5ba2\u6237\u7aef\u8fde\u63a5\u5230\u8fdc\u7a0b Docker \u5b88\u62a4\u8fdb\u7a0b\u3002Docker \u5ba2\u6237\u7aef\u548c\u5b88\u62a4\u8fdb\u7a0b\u4f7f\u7528 REST API \u901a\u8fc7 UNIX \u5957\u63a5\u5b57\u6216\u7f51\u7edc\u63a5\u53e3\u8fdb\u884c\u901a\u4fe1\u3002</p> <p></p>"},{"location":"kubernetes_basic/install/","title":"\u5b89\u88c5","text":""},{"location":"kubernetes_basic/install/#_1","title":"\u5b89\u88c5","text":"<p>Kubernetes \u96c6\u7fa4\u73af\u5883\u5b89\u88c5</p> <p>\u4e3a\u4e86\u6839\u636e\u6700\u65b0\u7684\u96c6\u7fa4\u7279\u6027\uff0c\u6211\u4eec\u8fd9\u91cc\u5b89\u88c5\u76ee\u524d\u6700\u65b0\u7684\u7248\u672c v1.26.2\uff0c\u5982\u679c\u4f60\u662f\u5728\u751f\u4ea7\u73af\u5883\u4f7f\u7528\uff0c\u5efa\u8bae\u4f7f\u7528\u4e0a\u4e00\u4e2a\u7248\u672c\u4e2d\u6700\u5927\u7684\u4fee\u6b63\u7248\u672c\uff0c\u6bd4\u5982 v1.25.5\uff0c\u7531\u4e8e v1.26 \u7248\u672c\u548c\u4e4b\u524d\u7684\u7248\u672c\u6709\u5f88\u5927\u53d8\u5316\uff0c\u4e3b\u8981\u4f53\u73b0\u5728 APIVersion \u79fb\u9664\u4e86\u4e4b\u524d\u7684\u4e00\u4e9b\u7248\u672c\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u91c7\u7528\u6700\u65b0\u7684 v1.26.2 \u7684\u7248\u672c\u3002\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u4e3b\u8981\u76ee\u7684\u4e5f\u662f\u5b66\u4e60 Kubernetes \u7684\u4e00\u4e9b\u77e5\u8bc6\u70b9\uff0c\u6240\u4ee5\u91c7\u7528\u7684\u662f Kubeadm \u6765\u5feb\u901f\u642d\u5efa\u5355 Master \u7684\u96c6\u7fa4\uff0c\u5728\u540e\u9762\u5982\u6709\u9700\u8981\u6211\u4eec\u53ef\u4ee5\u5728\u5b66\u4e60\u4e86\u8fd9\u4e9b\u77e5\u8bc6\u70b9\u540e\u6765\u642d\u5efa\u9002\u5408\u751f\u4ea7\u73af\u5883\u4f7f\u7528\u7684\u96c6\u7fa4\u3002</p> <p></p>"},{"location":"kubernetes_basic/install/#_2","title":"\u73af\u5883\u51c6\u5907","text":"<p>3\u4e2a\u8282\u70b9\uff0c\u90fd\u662f Centos 7.6 \u7cfb\u7edf\uff0c\u5185\u6838\u7248\u672c\uff1a6.2.5-1.el7.elrepo.x86_64\uff0c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u6dfb\u52a0 hosts \u4fe1\u606f\uff1a</p> <pre><code>$ cat /etc/hosts\n192.168.3.21 k8s-master1\n192.168.3.22 k8s-worker1\n192.168.3.23 k8s-worker2\n</code></pre> <p>hostname</p> <p>\u8282\u70b9\u7684 hostname \u5fc5\u987b\u4f7f\u7528\u6807\u51c6\u7684 DNS \u547d\u540d\uff0c\u53e6\u5916\u5343\u4e07\u4e0d\u7528\u4ec0\u4e48\u9ed8\u8ba4\u7684 <code>localhost</code> \u7684 hostname\uff0c\u4f1a\u5bfc\u81f4\u5404\u79cd\u9519\u8bef\u51fa\u73b0\u7684\u3002\u5728 Kubernetes \u9879\u76ee\u91cc\uff0c\u673a\u5668\u7684\u540d\u5b57\u4ee5\u53ca\u4e00\u5207\u5b58\u50a8\u5728 Etcd \u4e2d\u7684 API \u5bf9\u8c61\uff0c\u90fd\u5fc5\u987b\u4f7f\u7528\u6807\u51c6\u7684 DNS \u547d\u540d\uff08RFC 1123\uff09\u3002\u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4 </p> <pre><code>hostnamectl set-hostname k8s-master1\nhostnamectl set-hostname k8s-worker1\nhostnamectl set-hostname k8s-worker2\n</code></pre> <p>\u6765\u4fee\u6539 hostname\u3002</p> <p>\u7981\u7528\u9632\u706b\u5899\uff1a</p> <pre><code>$ systemctl stop firewalld\n$ systemctl disable firewalld\n</code></pre> <p>\u7981\u7528SELINUX\uff1a</p> <pre><code>$ setenforce 0\n$ cat /etc/selinux/config\nSELINUX=disabled\n</code></pre> <p>\u7531\u4e8e\u5f00\u542f\u5185\u6838 ipv4 \u8f6c\u53d1\u9700\u8981\u52a0\u8f7d br_netfilter \u6a21\u5757\uff0c\u6240\u4ee5\u52a0\u8f7d\u4e0b\u8be5\u6a21\u5757\uff1a</p> <pre><code>$ modprobe br_netfilter\n</code></pre> <p>\u521b\u5efa</p> <pre><code>/etc/sysctl.d/k8s.conf\n</code></pre> <p>\u6587\u4ef6\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>net.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipvip_forward = 1\n</code></pre> <p>bridge-nf</p> <p>bridge-nf \u4f7f\u5f97 netfilter \u53ef\u4ee5\u5bf9 Linux \u7f51\u6865\u4e0a\u7684 IPv4/ARP/IPv6 \u5305\u8fc7\u6ee4\u3002\u6bd4\u5982\uff0c\u8bbe\u7f6e</p> <pre><code>net.bridge.bridge-nf-call-iptables\uff1d1\n</code></pre> <p>\u540e\uff0c\u4e8c\u5c42\u7684\u7f51\u6865\u5728\u8f6c\u53d1\u5305\u65f6\u4e5f\u4f1a\u88ab iptables\u7684 FORWARD \u89c4\u5219\u6240\u8fc7\u6ee4\u3002\u5e38\u7528\u7684\u9009\u9879\u5305\u62ec\uff1a</p> <ul> <li>net.bridge.bridge-nf-call-arptables\uff1a\u662f\u5426\u5728 arptables \u7684 FORWARD \u4e2d\u8fc7\u6ee4\u7f51\u6865\u7684 ARP \u5305</li> <li>net.bridge.bridge-nf-call-ip6tables\uff1a\u662f\u5426\u5728 ip6tables \u94fe\u4e2d\u8fc7\u6ee4 IPv6 \u5305</li> <li>net.bridge.bridge-nf-call-iptables\uff1a\u662f\u5426\u5728 iptables \u94fe\u4e2d\u8fc7\u6ee4 IPv4 \u5305</li> <li>net.bridge.bridge-nf-filter-vlan-tagged\uff1a\u662f\u5426\u5728 iptables/arptables \u4e2d\u8fc7\u6ee4\u6253\u4e86 vlan \u6807\u7b7e\u7684\u5305\u3002</li> </ul> <p>\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u4f7f\u4fee\u6539\u751f\u6548\uff1a</p> <pre><code>$ sysctl -p /etc/sysctl.d/k8s.conf\n</code></pre> <p>\u5b89\u88c5 ipvs\uff1a</p> <pre><code>$ cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF\n#!/bin/bash\nmodprobe -- ip_vs\nmodprobe -- ip_vs_rr\nmodprobe -- ip_vs_wrr\nmodprobe -- ip_vs_sh\nmodprobe -- nf_conntrack_ipv4\nEOF\n$ chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4\n</code></pre> <p>\u4e0a\u9762\u811a\u672c\u521b\u5efa\u4e86\u7684</p> <pre><code>/etc/sysconfig/modules/ipvs.modules\n</code></pre> <p>\u6587\u4ef6\uff0c\u4fdd\u8bc1\u5728\u8282\u70b9\u91cd\u542f\u540e\u80fd\u81ea\u52a8\u52a0\u8f7d\u6240\u9700\u6a21\u5757\u3002\u4f7f\u7528</p> <pre><code>lsmod | grep -e ip_vs -e nf_conntrack_ipv4\n</code></pre> <p>\u547d\u4ee4\u67e5\u770b\u662f\u5426\u5df2\u7ecf\u6b63\u786e\u52a0\u8f7d\u6240\u9700\u7684\u5185\u6838\u6a21\u5757\u3002</p> <p>\u63a5\u4e0b\u6765\u8fd8\u9700\u8981\u786e\u4fdd\u5404\u4e2a\u8282\u70b9\u4e0a\u5df2\u7ecf\u5b89\u88c5\u4e86 ipset \u8f6f\u4ef6\u5305\uff1a</p> <p><code>$ yum install ipset</code></p> <p>\u4e3a\u4e86\u4fbf\u4e8e\u67e5\u770b ipvs \u7684\u4ee3\u7406\u89c4\u5219\uff0c\u6700\u597d\u5b89\u88c5\u4e00\u4e0b\u7ba1\u7406\u5de5\u5177 ipvsadm\uff1a</p> <pre><code>$ yum install ipvsadm\n</code></pre> <p>\u540c\u6b65\u670d\u52a1\u5668\u65f6\u95f4</p> <pre><code>$ yum install chrony -y\n$ systemctl enable chronyd\n$ systemctl start chronyd\n$ chronyc sources\n210 Number of sources = 4\nMS Name/IP address         Stratum Poll Reach LastRx Last sample\n\n^+ svggsrv.de                  2   6    17    32   -823us[-1128us] +/-   98ms\n^- montreal.ca.logiplex.net      2   6    17    32    -17ms[  -17ms] +/-  179ms\n^- ntpflashdance.cx            2   6    17    32    -32ms[  -32ms] +/-  161ms\n^* 11184                2   6    33    32   +661us[ +357us] +/-   38ms\n$ date\nTue Aug 27 09:28:41 CST 2019\n</code></pre> <p>\u5173\u95ed swap \u5206\u533a\uff1a</p> <p><code>$ swapoff -a</code></p> <p>\u4fee\u6539<code>/etc/fstab</code>\u6587\u4ef6\uff0c\u6ce8\u91ca\u6389 SWAP \u7684\u81ea\u52a8\u6302\u8f7d\uff0c\u4f7f\u7528<code>free -m</code>\u786e\u8ba4 swap \u5df2\u7ecf\u5173\u95ed\u3002swappiness \u53c2\u6570\u8c03\u6574\uff0c\u4fee\u6539</p> <pre><code>/etc/sysctl.d/k8s.conf\n</code></pre> <p>\u6dfb\u52a0\u4e0b\u9762\u4e00\u884c\uff1a</p> <p><code>vm.swappiness=0</code></p> <p>\u6267\u884c</p> <pre><code>sysctl -p /etc/sysctl.d/k8s.conf\n</code></pre> <p>\u4f7f\u4fee\u6539\u751f\u6548\u3002</p> <p>\u63a5\u4e0b\u6765\u53ef\u4ee5\u5b89\u88c5 Docker:</p> <pre><code>$ yum install -y yum-utils \\\\\n  device-mapper-persistent-data \\\\\n  lvm2\n#\u4f7f\u7528\u963f\u91cc\u4e91\u5f00\u6e90\u8f6f\u4ef6\u955c\u50cf\u7ad9\u3002  \nwget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo\n#Docker\u5b89\u88c5\nyum -y install docker-ce\n</code></pre> <p>\u53ef\u4ee5\u9009\u62e9\u5b89\u88c5\u4e00\u4e2a\u7248\u672c\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5b89\u88c5\u6700\u65b0\u7248\u672c\uff1a</p> <pre><code># \u5efa\u8bae\u5b89\u88c509\u7248\u672c\uff0c\u662f\u6700\u65b0\u9a8c\u8bc1\u7684\u7248\u672c\n$ yum install docker-ce-9\n</code></pre> <p>\u914d\u7f6e Docker \u955c\u50cf\u52a0\u901f\u5668:</p> <pre><code>$ mkdir -p /etc/docker  # \u5982\u679c\u6ca1\u6709\u8fd9\u4e2a\u76ee\u5f55\u5148\u521b\u5efa\uff0c\u7136\u540e\u6dfb\u52a0 daemon.json \u6587\u4ef6\n$ vi /etc/docker/daemon.json\n{\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"registry-mirrors\" : [\n    \"https://ot2k4dmirror.aliyuncs.com/\"\n  ]\n}\n</code></pre> <p>cgroup \u9a71\u52a8</p> <p>\u7531\u4e8e\u9ed8\u8ba4\u60c5\u51b5\u4e0b kubelet \u4f7f\u7528\u7684 cgroupdriver \u662f systemd\uff0c\u6240\u4ee5\u9700\u8981\u4fdd\u6301 docker \u548ckubelet \u7684 cgroupdriver \u4e00\u81f4\uff0c\u6211\u4eec\u8fd9\u91cc\u4fee\u6539 docker \u7684 cgroupdriver=systemd\u3002\u5982\u679c\u4e0d\u4fee\u6539 docker \u5219\u9700\u8981\u4fee\u6539 kubelet \u7684\u542f\u52a8\u914d\u7f6e\uff0c\u9700\u8981\u4fdd\u8bc1\u4e24\u8005\u4e00\u81f4\u3002</p> <p>\u542f\u52a8 Docker\uff1a</p> <pre><code>$ systemctl start docker\n$ systemctl enable docker\n</code></pre> <p>\u5728\u786e\u4fdd Docker \u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u4e0a\u9762\u7684\u76f8\u5173\u73af\u5883\u914d\u7f6e\u4e5f\u5b8c\u6210\u4e86\uff0c\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u6765\u5b89\u88c5 Kubeadm \u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u662f\u901a\u8fc7\u6307\u5b9ayum \u6e90\u7684\u65b9\u5f0f\u6765\u8fdb\u884c\u5b89\u88c5\u7684\uff1a</p> <pre><code>cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg\n        https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg\nEOF\n</code></pre> <p>\u5f53\u7136\u4e86\uff0c\u4e0a\u9762\u7684 yum \u6e90\u662f\u9700\u8981\u79d1\u5b66\u4e0a\u7f51\u7684\uff0c\u5982\u679c\u4e0d\u80fd\u79d1\u5b66\u4e0a\u7f51\u7684\u8bdd\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u963f\u91cc\u4e91\u7684\u6e90\u8fdb\u884c\u5b89\u88c5\uff1a</p> <pre><code>cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg\n        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n</code></pre> <p>\u7136\u540e\u5b89\u88c5 kubeadm\u3001kubelet\u3001kubectl\uff1a</p> <pre><code># --disableexcludes \u7981\u6389\u9664\u4e86kubernetes\u4e4b\u5916\u7684\u522b\u7684\u4ed3\u5e93\n$ yum install -y kubelet-2 kubeadm-2 kubectl-2 --disableexcludes=kubernetes\n$ kubeadm version\nkubeadm version: &amp;version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v2\", GitCommit:\"c97fe5036ef3df2967d086711e6c0c405941e14b\", GitTreeState:\"clean\", BuildDate:\"2019-10-15T19:15:39Z\", GoVersion:\"go10\", Compiler:\"gc\", Platform:\"linux/amd64\"}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u8fd9\u91cc\u5b89\u88c5\u7684\u662f v1.26.2 \u7248\u672c\uff0c\u7136\u540e\u5c06 kubelet \u8bbe\u7f6e\u6210\u5f00\u673a\u542f\u52a8\uff1a</p> <pre><code>$ systemctl enable --now kubelet\n</code></pre> <p>\u5230\u8fd9\u91cc\u4e3a\u6b62\u4e0a\u9762\u6240\u6709\u7684\u64cd\u4f5c\u90fd\u9700\u8981\u5728\u6240\u6709\u8282\u70b9\u6267\u884c\u914d\u7f6e\u3002</p>"},{"location":"kubernetes_basic/install/#_3","title":"\u521d\u59cb\u5316\u96c6\u7fa4","text":"<p>\u7136\u540e\u63a5\u4e0b\u6765\u5728 master \u8282\u70b9\u914d\u7f6e kubeadm \u521d\u59cb\u5316\u6587\u4ef6\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u5bfc\u51fa\u9ed8\u8ba4\u7684\u521d\u59cb\u5316\u914d\u7f6e\uff1a</p> <pre><code>$ kubeadm config print init-defaults &gt; kubeadm.yaml\n</code></pre> <p>\u7136\u540e\u6839\u636e\u6211\u4eec\u81ea\u5df1\u7684\u9700\u6c42\u4fee\u6539\u914d\u7f6e\uff0c\u6bd4\u5982\u4fee\u6539 imageRepository \u7684\u503c\uff0ckube-proxy \u7684\u6a21\u5f0f\u4e3a ipvs\uff0c\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u662f\u51c6\u5907\u5b89\u88c5 flannel \u7f51\u7edc\u63d2\u4ef6\u7684\uff0c\u9700\u8981\u5c06 networking.podSubnet \u8bbe\u7f6e\u4e3a<code>10.244.0.0/16</code>\uff1a</p> <pre><code>apiVersion: kubeadm.k8s.io/v1beta2\nbootstrapTokens:\n- groups:\n  - system:bootstrappers:kubeadm:default-node-token\n  token: abcdef.0123456789abcdef\n  ttl: 24h0m0s\n  usages:\n  - signing\n  - authentication\nkind: InitConfiguration\nlocalAPIEndpoint:\n  advertiseAddress: 111  # apiserver \u8282\u70b9\u5185\u7f51IP\n  bindPort: 6443\nnodeRegistration:\n  criSocket: /var/run/dockershim.sock\n  name: ydzs-master  # \u9ed8\u8ba4\u8bfb\u53d6\u5f53\u524dmaster\u8282\u70b9\u7684hostname\n  taints:\n  - effect: NoSchedule\n    key: node-role.kubernetes.io/master\n---\napiServer:\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta2\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns:\n  type: CoreDNS\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: registry.aliyuncs.com/google_containers  # \u4fee\u6539\u6210\u963f\u91cc\u4e91\u955c\u50cf\u6e90\nkind: ClusterConfiguration\nkubernetesVersion: v2\nnetworking:\n  dnsDomain: cluster.local\n  podSubnet: 20/16  # Pod \u7f51\u6bb5\uff0cflannel\u63d2\u4ef6\u9700\u8981\u4f7f\u7528\u8fd9\u4e2a\u7f51\u6bb5\n  serviceSubnet: 0/12\nscheduler: {}\n---\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nkind: KubeProxyConfiguration\nmode: ipvs  # kube-proxy \u6a21\u5f0f\n</code></pre> <p>\u914d\u7f6e\u63d0\u793a</p> <p>\u5bf9\u4e8e\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u7684\u6587\u6863\u6bd4\u8f83\u6742\uff0c\u8981\u60f3\u5b8c\u6574\u4e86\u89e3\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5bf9\u5e94\u7684\u5c5e\u6027\uff0c\u53ef\u4ee5\u67e5\u770b\u5bf9\u5e94\u7684 godoc \u6587\u6863\uff0c\u5730\u5740: https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2\u3002</p> <p>\u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u521d\u59cb\u5316\uff1a</p> <pre><code>$ kubeadm init --config kubeadm.yaml\n[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`\nTo see the stack trace of this error execute with --v=5 or higher\n[init] Using Kubernetes version: v2\n[preflight] Running pre-flight checks\n[preflight] Pulling images required for setting up a Kubernetes cluster\n[preflight] This might take a minute or two, depending on the speed of your internet connection\n[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Activating the kubelet service\n[certs] Using certificateDir folder \"/etc/kubernetes/pki\"\n[certs] Generating \"ca\" certificate and key\nx[certs] Generating \"apiserver\" certificate and key\n[certs] apiserver serving cert is signed for DNS names [ydzs-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [1 111]\nxxx[certs] Generating \"apiserver-kubelet-client\" certificate and key\nx[certs] Generating \"front-proxy-ca\" certificate and key\n[certs] Generating \"front-proxy-client\" certificate and key\n[certs] Generating \"etcd/ca\" certificate and key\n[certs] Generating \"etcd/server\" certificate and key\n[certs] etcd/server serving cert is signed for DNS names [ydzs-master localhost] and IPs [111 11 ::1]\n[certs] Generating \"etcd/peer\" certificate and key\n[certs] etcd/peer serving cert is signed for DNS names [ydzs-master localhost] and IPs [111 11 ::1]\n[certs] Generating \"etcd/healthcheck-client\" certificate and key\n[certs] Generating \"apiserver-etcd-client\" certificate and key\n[certs] Generating \"sa\" key and public key\n[kubeconfig] Using kubeconfig folder \"/etc/kubernetes\"\n[kubeconfig] Writing \"admin.conf\" kubeconfig file\n[kubeconfig] Writing \"kubelet.conf\" kubeconfig file\n[kubeconfig] Writing \"controller-manager.conf\" kubeconfig file\n[kubeconfig] Writing \"scheduler.conf\" kubeconfig file\n[control-plane] Using manifest folder \"/etc/kubernetes/manifests\"\n[control-plane] Creating static Pod manifest for \"kube-apiserver\"\n[control-plane] Creating static Pod manifest for \"kube-controller-manager\"\n[control-plane] Creating static Pod manifest for \"kube-scheduler\"\n[etcd] Creating static Pod manifest for local etcd in \"/etc/kubernetes/manifests\"\n[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory \"/etc/kubernetes/manifests\". This can take up to 4m0s\n[apiclient] All control plane components are healthy after 504262 seconds\n[upload-config] Storing the configuration used in ConfigMap \"kubeadm-config\" in the \"kube-system\" Namespace\n[kubelet] Creating a ConfigMap \"kubelet-config-16\" in namespace kube-system with the configuration for the kubelets in the cluster\n[kubelet-check] Initial timeout of 40s passed.\n[upload-certs] Skipping phase. Please see --upload-certs\n[mark-control-plane] Marking the node ydzs-master as control-plane by adding the label \"node-role.kubernetes.io/master=''\"\n[mark-control-plane] Marking the node ydzs-master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]\n[bootstrap-token] Using token: abcdef.0123456789abcdef\n[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles\n[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials\n[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token\n[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster\n[bootstrap-token] Creating the \"cluster-info\" ConfigMap in the \"kube-public\" namespace\n[addons] Applied essential addon: CoreDNS\n[addons] Applied essential addon: kube-proxy\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 111:6443 --token abcdef.0123456789abcdef \\\\\n    --discovery-token-ca-cert-hash sha256:a292e66049e45264f848186d2fa3582dc360f3b5006cc160f137b5d436e078c2\n</code></pre> <p>\u62f7\u8d1d kubeconfig \u6587\u4ef6</p> <pre><code>$ mkdir -p $HOME/.kube\n$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n$ sudo chown $(id -u):$(id -g) $HOME/.kube/config\n</code></pre> <p><code>kubeadm init</code> \u547d\u4ee4\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p>"},{"location":"kubernetes_basic/install/#_4","title":"\u6dfb\u52a0\u8282\u70b9","text":"<p>\u8bb0\u4f4f\u521d\u59cb\u5316\u96c6\u7fa4\u4e0a\u9762\u7684\u914d\u7f6e\u548c\u64cd\u4f5c\u8981\u63d0\u524d\u505a\u597d\uff0c\u5c06 master \u8282\u70b9\u4e0a\u9762\u7684 $HOME/.kube/config \u6587\u4ef6\u62f7\u8d1d\u5230 node \u8282\u70b9\u5bf9\u5e94\u7684\u6587\u4ef6\u4e2d\uff0c\u5b89\u88c5 kubeadm\u3001kubelet\u3001kubectl\uff08\u53ef\u9009\uff09\uff0c\u7136\u540e\u6267\u884c\u4e0a\u9762\u521d\u59cb\u5316\u5b8c\u6210\u540e\u63d0\u793a\u7684 join \u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ kubeadm join 111:6443 --token abcdef.0123456789abcdef \\\\\n&gt;     --discovery-token-ca-cert-hash sha256:a292e66049e45264f848186d2fa3582dc360f3b5006cc160f137b5d436e078c2\n[preflight] Running pre-flight checks\n[preflight] Reading configuration from the cluster...\n[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'\n[kubelet-start] Downloading configuration for the kubelet from the \"kubelet-config-16\" ConfigMap in the kube-system namespace\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Activating the kubelet service\n[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...\n\nThis node has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun 'kubectl get nodes' on the control-plane to see this node join the cluster.\n</code></pre> <p>join \u547d\u4ee4</p> <p>\u5982\u679c\u5fd8\u8bb0\u4e86\u4e0a\u9762\u7684 join \u547d\u4ee4\u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4 </p> <pre><code>kubeadm token create --print-join-command\n</code></pre> <p>\u91cd\u65b0\u83b7\u53d6\u3002</p> <p><code>kubeadm join</code> \u547d\u4ee4\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u6267\u884c\u6210\u529f\u540e\u8fd0\u884c get nodes \u547d\u4ee4\uff1a</p> <pre><code>$ kubectl get nodes\nNAME          STATUS     ROLES    AGE    VERSION\nydzs-master   NotReady      master   39m    v3\nydzs-node1    NotReady   &lt;none&gt;   106s   v3\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u662f NotReady \u72b6\u6001\uff0c\u8fd9\u662f\u56e0\u4e3a\u8fd8\u6ca1\u6709\u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6\uff0c\u63a5\u4e0b\u6765\u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6\uff0c\u53ef\u4ee5\u5728\u6587\u6863 https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/ \u4e2d\u9009\u62e9\u6211\u4eec\u81ea\u5df1\u7684\u7f51\u7edc\u63d2\u4ef6\uff0c\u8fd9\u91cc\u6211\u4eec\u5b89\u88c5 flannel:</p> <pre><code>$ wget https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml\n# \u56e0\u4e3a\u6709\u8282\u70b9\u662f\u591a\u7f51\u5361\uff0c\u6240\u4ee5\u9700\u8981\u5728\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e2d\u6307\u5b9a\u5185\u7f51\u7f51\u5361\n# \u641c\u7d22\u5230\u540d\u4e3a kube-flannel-ds-amd64 \u7684 DaemonSet\uff0c\u5728kube-flannel\u5bb9\u5668\u4e0b\u9762\n$ vi kube-flannel.yml\n......\ncontainers:\n- name: kube-flannel\n  image: quay.io/coreos/flannel:v0-amd64\n  command:\n  - /opt/bin/flanneld\n  args:\n  - --ip-masq\n  - --kube-subnet-mgr\n  - --iface=eth0  # \u5982\u679c\u662f\u591a\u7f51\u5361\u7684\u8bdd\uff0c\u6307\u5b9a\u5185\u7f51\u7f51\u5361\u7684\u540d\u79f0\n......\n$ kubectl apply -f kube-flannel.yml  # \u5b89\u88c5 flannel \u7f51\u7edc\u63d2\u4ef6\n</code></pre> <p>\u9694\u4e00\u4f1a\u513f\u67e5\u770b Pod \u8fd0\u884c\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods -n kube-system\nNAME                                  READY   STATUS    RESTARTS   AGE\ncoredns-667f964f9b-wb5fn              1/1     Running   0          20m\ncoredns-667f964f9b-xmwn2              1/1     Running   0          20m\netcd-ydzs-master                      1/1     Running   0          19m\nkube-apiserver-ydzs-master            1/1     Running   0          19m\nkube-controller-manager-ydzs-master   1/1     Running   0          19m\nkube-flannel-ds-amd64-8l2wr           1/1     Running   0          12m\nkube-flannel-ds-amd64-vwhbh           1/1     Running   0          12m\nkube-proxy-8r4d2                      1/1     Running   0          17m\nkube-proxy-rbjv7                      1/1     Running   0          20m\nkube-scheduler-ydzs-master            1/1     Running   0          20m\n</code></pre> <p>Flannel \u7f51\u7edc\u63d2\u4ef6</p> <p>\u5f53\u6211\u4eec\u90e8\u7f72\u5b8c\u7f51\u7edc\u63d2\u4ef6\u540e\u6267\u884c ifconfig \u547d\u4ee4\uff0c\u6b63\u5e38\u4f1a\u770b\u5230\u65b0\u589e\u7684<code>cni0</code>\u4e0e<code>flannel1</code>\u8fd9\u4e24\u4e2a\u865a\u62df\u8bbe\u5907\uff0c\u4f46\u662f\u5982\u679c\u6ca1\u6709\u770b\u5230<code>cni0</code>\u8fd9\u4e2a\u8bbe\u5907\u4e5f\u4e0d\u7528\u592a\u62c5\u5fc3\uff0c\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf<code>/var/lib/cni</code>\u76ee\u5f55\u662f\u5426\u5b58\u5728\uff0c\u5982\u679c\u4e0d\u5b58\u5728\u5e76\u4e0d\u662f\u8bf4\u90e8\u7f72\u6709\u95ee\u9898\uff0c\u800c\u662f\u8be5\u8282\u70b9\u4e0a\u6682\u65f6\u8fd8\u6ca1\u6709\u5e94\u7528\u8fd0\u884c\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728\u8be5\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a Pod \u5c31\u53ef\u4ee5\u770b\u5230\u8be5\u76ee\u5f55\u4f1a\u88ab\u521b\u5efa\uff0c\u5e76\u4e14<code>cni0</code>\u8bbe\u5907\u4e5f\u4f1a\u88ab\u521b\u5efa\u51fa\u6765\u3002</p> <p>\u7f51\u7edc\u63d2\u4ef6\u8fd0\u884c\u6210\u529f\u4e86\uff0cnode \u72b6\u6001\u4e5f\u6b63\u5e38\u4e86\uff1a</p> <pre><code>$ kubectl get nodes\nNAME          STATUS   ROLES    AGE   VERSION\nydzs-master   Ready    master   21m   v2\nydzs-node1    Ready    &lt;none&gt;   18m   v2\n</code></pre> <p>\u7528\u540c\u6837\u7684\u65b9\u6cd5\u6dfb\u52a0\u53e6\u5916\u4e00\u4e2a\u8282\u70b9\u5373\u53ef\u3002</p>"},{"location":"kubernetes_basic/install/#dashboard","title":"Dashboard","text":"<p>v1.26.2 \u7248\u672c\u7684\u96c6\u7fa4\u9700\u8981\u5b89\u88c5\u6700\u65b0\u7684 2.0+ \u7248\u672c\u7684 Dashboard\uff1a</p> <pre><code># \u63a8\u8350\u4f7f\u7528\u4e0b\u9762\u8fd9\u79cd\u65b9\u5f0f\n$ wget https://raw.githubusercontent.com/kubernetes/dashboard/v0-beta5/aio/deploy/recommended.yaml\n$ vi recommended.yaml\n# \u4fee\u6539Service\u4e3aNodePort\u7c7b\u578b\n......\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard\n  namespace: kubernetes-dashboard\nspec:\n  ports:\n    - port: 443\n      targetPort: 8443\n  selector:\n    k8s-app: kubernetes-dashboard\n  type: NodePort  # \u52a0\u4e0atype=NodePort\u53d8\u6210NodePort\u7c7b\u578b\u7684\u670d\u52a1\n......\n</code></pre> <p>\u76d1\u63a7\u7ec4\u4ef6</p> <p>\u5728 YAML \u6587\u4ef6\u4e2d\u53ef\u4ee5\u770b\u5230\u65b0\u7248\u672c Dashboard \u96c6\u6210\u4e86\u4e00\u4e2a metrics-scraper \u7684\u7ec4\u4ef6\uff0c\u53ef\u4ee5\u901a\u8fc7 Kubernetes \u7684 Metrics API \u6536\u96c6\u4e00\u4e9b\u57fa\u7840\u8d44\u6e90\u7684\u76d1\u63a7\u4fe1\u606f\uff0c\u5e76\u5728 web \u9875\u9762\u4e0a\u5c55\u793a\uff0c\u6240\u4ee5\u8981\u60f3\u5728\u9875\u9762\u4e0a\u5c55\u793a\u76d1\u63a7\u4fe1\u606f\u5c31\u9700\u8981\u63d0\u4f9b Metrics API\uff0c\u6bd4\u5982\u5b89\u88c5 Metrics Server\u3002</p> <p>\u76f4\u63a5\u521b\u5efa\uff1a</p> <pre><code>$ kubectl apply -f recommended.yaml\n</code></pre> <p>\u65b0\u7248\u672c\u7684 Dashboard \u4f1a\u88ab\u9ed8\u8ba4\u5b89\u88c5\u5728 kubernetes-dashboard \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\uff1a</p> <pre><code>$ kubectl get pods -n kubernetes-dashboard -l k8s-app=kubernetes-dashboard\nNAME                                  READY   STATUS    RESTARTS   AGE\nkubernetes-dashboard-fcfb4cbc-t462n   1/1     Running   0          50m\n$ kubectl get svc -n kubernetes-dashboard\nNAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\ndashboard-metrics-scraper   ClusterIP   11146   &lt;none&gt;        8000/TCP       21s\nkubernetes-dashboard        NodePort    12187   &lt;none&gt;        443:30750/TCP   22s\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u7684 30750 \u7aef\u53e3\u53bb\u8bbf\u95ee Dashboard\uff0c\u8981\u8bb0\u4f4f\u4f7f\u7528 https\uff0cChrome \u4e0d\u751f\u6548\u53ef\u4ee5\u4f7f\u7528<code>Firefox</code> \u6d4b\u8bd5\uff0c\u5982\u679c\u6ca1\u6709 Firefox \u4e0b\u9762\u6253\u4e0d\u5f00\u9875\u9762\uff0c\u53ef\u4ee5\u70b9\u51fb\u4e0b\u9875\u9762\u4e2d\u7684<code>\u4fe1\u4efb\u8bc1\u4e66</code>\u5373\u53ef\uff1a</p> <p></p> <p>\u4fe1\u4efb\u540e\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230 Dashboard \u7684\u767b\u5f55\u9875\u9762\u4e86\uff1a</p> <p></p> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u5177\u6709\u5168\u5c40\u6240\u6709\u6743\u9650\u7684\u7528\u6237\u6765\u767b\u5f55Dashboard\uff1a(admin.yaml)</p> <pre><code>kind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: admin\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: \"true\"\nroleRef:\n  kind: ClusterRole\n  name: cluster-admin\n  apiGroup: rbac.authorization.k8s.io\nsubjects:\n- kind: ServiceAccount\n  name: admin\n  namespace: kubernetes-dashboard\n\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: admin\n  namespace: kubernetes-dashboard\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\uff1a</p> <pre><code>$ kubectl apply -f admin.yaml\n$ kubectl get secret -n kubernetes-dashboard|grep admin-token\nadmin-token-lwmmx                  kubernetes.io/service-account-token   3         1d\n$ kubectl get secret admin-token-lwmmx -o jsonpath={.data.token} -n kubernetes-dashboard |base64 -d# \u4f1a\u751f\u6210\u4e00\u4e32\u5f88\u957f\u7684base64\u540e\u7684\u5b57\u7b26\u4e32\n</code></pre> <p>\u7136\u540e\u7528\u4e0a\u9762\u7684 base64 \u89e3\u7801\u540e\u7684\u5b57\u7b26\u4e32\u4f5c\u4e3a token \u767b\u5f55 Dashboard \u5373\u53ef\uff0c\u65b0\u7248\u672c\u8fd8\u65b0\u589e\u4e86\u4e00\u4e2a\u6697\u9ed1\u6a21\u5f0f\uff1a</p> <p></p> <p>\u6700\u7ec8\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 kubeadm \u642d\u5efa v1.26.2 \u7248\u672c\u7684 kubernetes \u96c6\u7fa4\u3001coredns\u3001ipvs\u3001flannel\u3002</p>"},{"location":"kubernetes_basic/install/#_5","title":"\u6e05\u7406","text":"<p>\u5982\u679c\u4f60\u7684\u96c6\u7fa4\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u9047\u5230\u4e86\u5176\u4ed6\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u8fdb\u884c\u91cd\u7f6e\uff1a</p> <pre><code>$ kubeadm reset\n$ ifconfig cni0 down &amp;&amp; ip link delete cni0\n$ ifconfig flannel.1 down &amp;&amp; ip link delete flannel.1\n$ rm -rf /var/lib/cni/\n</code></pre>"},{"location":"kubernetes_basic/overview/","title":"\u7b80\u4ecb","text":""},{"location":"kubernetes_basic/overview/#_1","title":"\u7b80\u4ecb","text":"<p>Kubernetes \u57fa\u672c\u6982\u5ff5\u4e0e\u7ec4\u4ef6</p> <p>Kubernetes\uff08\u7b80\u79f0 K8S\uff09 \u7684\u51fa\u73b0\u662f\u5bb9\u5668\u5316\u6280\u672f\u53d1\u5c55\u7684\u5fc5\u7136\u7ed3\u679c\uff0c<code>\u5bb9\u5668\u5316</code>\u662f\u5e94\u7528\u7a0b\u5e8f\u7ea7\u522b\u7684\u865a\u62df\u5316\uff0c\u8fd0\u884c\u5355\u4e2a\u5185\u6838\u4e0a\u6709\u591a\u4e2a\u72ec\u7acb\u7684\u7528\u6237\u7a7a\u95f4\u5b9e\u4f8b\uff0c\u8fd9\u4e9b\u5b9e\u4f8b\u5c31\u662f\u5bb9\u5668\uff1b<code>\u5bb9\u5668</code>\u63d0\u4f9b\u4e86\u5c06\u5e94\u7528\u7a0b\u5e8f\u7684\u4ee3\u7801\u3001\u8fd0\u884c\u65f6\u3001\u7cfb\u7edf\u5de5\u5177\u3001\u7cfb\u7edf\u5e93\u548c\u914d\u7f6e\u6253\u5305\u5230\u4e00\u4e2a\u5b9e\u4f8b\u4e2d\u7684\u6807\u51c6\u65b9\u6cd5\uff0c\u800c\u4e14\u5bb9\u5668\u662f\u5171\u4eab\u4e00\u4e2a\u5185\u6838\u7684\uff1b\u7531\u4e8e\u5bb9\u5668\u6280\u672f\u7684\u5174\u8d77\uff0c\u5bfc\u81f4\u5927\u91cf\u7684\u5bb9\u5668\u5e94\u7528\u51fa\u73b0\uff0c\u6240\u4ee5\u5c31\u51fa\u73b0\u4e86\u4e00\u4e9b\u7528\u6765\u652f\u6301\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u5316\u90e8\u7f72\u548c\u7ec4\u7ec7\u7684<code>\u5bb9\u5668\u7f16\u6392</code>\u6280\u672f\uff0c\u4e00\u4e9b\u6d41\u884c\u7684\u5f00\u6e90\u5bb9\u5668\u7f16\u6392\u5de5\u5177\u6709 Docker Swarm\u3001Kubernetes \u7b49\uff0c\u4f46\u662f\u5728\u53d1\u5c55\u8fc7\u7a0b\u4e2d Kubernetes \u73b0\u5728\u5df2\u7ecf\u6210\u4e3a\u4e86\u5bb9\u5668\u7f16\u6392\u9886\u57df\u4e8b\u5b9e\u4e0a\u7684\u4e00\u4e2a\u6807\u51c6\u4e86\u3002</p> <p></p> <p>Kubernetes \u662f Google \u56e2\u961f\u53d1\u8d77\u7684\u4e00\u4e2a\u5f00\u6e90\u9879\u76ee\uff0c\u5b83\u7684\u76ee\u6807\u662f\u7ba1\u7406\u8de8\u591a\u4e2a\u4e3b\u673a\u7684\u5bb9\u5668\uff0c\u7528\u4e8e\u81ea\u52a8\u90e8\u7f72\u3001\u6269\u5c55\u548c\u7ba1\u7406\u5bb9\u5668\u5316\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e3b\u8981\u5b9e\u73b0\u8bed\u8a00\u4e3a Go \u8bed\u8a00\uff0c\u4ed6\u7684\u7406\u8bba\u57fa\u7840\u6765\u6e90\u4e0e Google \u5185\u90e8\u7684 Borg \u9879\u76ee\uff0c\u6240\u4ee5 Kubernetes \u9879\u76ee\u7684\u7406\u8bba\u57fa\u7840\u5c31\u6bd4\u5176\u4ed6\u5f00\u6e90\u9879\u76ee\u8981\u5148\u8fdb\u5f88\u591a\uff0c\u56e0\u4e3a Borg \u7cfb\u7edf\u4e00\u76f4\u4f9d\u8d56\u5c31\u88ab\u79f0\u4e3a Google \u516c\u53f8\u5185\u90e8\u6700\u5f3a\u5927\u7684\u79c1\u5bc6\u6b66\u5668\u3002</p>"},{"location":"kubernetes_basic/overview/#_2","title":"\u67b6\u6784","text":"<p>Kubernetes \u9879\u76ee\u4f9d\u6258\u7740 Borg \u9879\u76ee\u7684\u7406\u8bba\u4f18\u52bf\uff0c\u786e\u5b9a\u4e86\u4e00\u4e2a\u5982\u4e0b\u56fe\u6240\u793a\u7684\u5168\u5c40\u67b6\u6784\u56fe\uff1a</p> <p></p> <p>\u4ece\u4e0a\u9762\u6211\u4eec\u53ef\u4ee5\u770b\u51fa Kubernetes \u7531 Master \u548c Node \u4e24\u79cd\u8282\u70b9\u7ec4\u6210\uff0c\u8fd9\u4e24\u79cd\u89d2\u8272\u5206\u522b\u5bf9\u5e94\u7740\u63a7\u5236\u8282\u70b9\u548c\u5de5\u4f5c\u8282\u70b9\uff08\u53ef\u4ee5\u7406\u89e3\u4e3a\u8001\u677f\u548c\u5458\u5de5\uff09\u3002</p> <p>\u5176\u4e2d Master \u8282\u70b9\u7531\u4e09\u4e2a\u72ec\u7acb\u7684\u7ec4\u4ef6\u7ec4\u6210\uff0c\u5b83\u4eec\u5206\u522b\u662f\u8d1f\u8d23\u6574\u4e2a\u96c6\u7fa4\u901a\u4fe1\u7684 API \u670d\u52a1\u7684 <code>kube-apiserver</code>\u3001\u8d1f\u8d23\u5bb9\u5668\u8c03\u5ea6\u7684 <code>kube-scheduler</code> \u4ee5\u53ca\u8d1f\u8d23\u7ef4\u62a4\u96c6\u7fa4\u72b6\u6001\u7684 </p> <pre><code>kube-controller-manager\n</code></pre> <p>\u7ec4\u4ef6\u3002\u6574\u4e2a\u96c6\u7fa4\u7684\u6570\u636e\u90fd\u662f\u901a\u8fc7 kube-apiserver \u4fdd\u5b58\u5230 etcd \u6570\u636e\u5e93\u4e2d\u7684\uff0c\u800c\u5176\u4ed6\u6240\u6709\u7ec4\u4ef6\u7684\u901a\u4fe1\u4e5f\u90fd\u662f\u901a\u8fc7 kube-apiserver \u548c etcd \u6570\u636e\u5e93\u8fdb\u884c\u901a\u4fe1\u7684\uff0c\u90fd\u4e0d\u4f1a\u76f4\u63a5\u548c etcd \u8fdb\u884c\u901a\u4fe1\u3002</p> <p>\u5de5\u4f5c\u8282\u70b9\u4e0a\u6700\u6838\u5fc3\u7684\u7ec4\u4ef6\u5c31\u662f <code>kubelet</code>\uff0c\u5f53\u7136\u8fd8\u6709\u5e95\u5c42\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u6bd4\u5982 Docker\uff0c\u5176\u4e2d kubelet \u5c31\u662f\u4e3b\u8981\u6765\u5b9e\u73b0\u548c\u5e95\u5c42\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\u8fdb\u884c\u901a\u4fe1\u7684\uff0c\u8fd9\u4e2a\u901a\u4fe1\u7684\u8fc7\u7a0b\u4e5f\u88ab Kubernetes \u62bd\u8c61\u6210\u4e86\u4e00\u4e2a <code>CRI</code>\uff08Container Runtime Interface\uff09\u7684\u8fdc\u7a0b\u8c03\u7528\u63a5\u53e3\uff0c\u8fd9\u4e2a\u63a5\u53e3\u91cc\u9762\u5b9a\u4e49\u4e86\u5bb9\u5668\u8fd0\u884c\u65f6\u7684\u6240\u6709\u6807\u51c6\u64cd\u4f5c\uff0c\u6bd4\u5982\u521b\u5efa\u5bb9\u5668\u3001\u5220\u9664\u5bb9\u5668\u7b49\u7b49\uff0c\u53ea\u662f\u76ee\u524d kubelet \u91cc\u9762\u5185\u7f6e\u4e86 Docker \u5173\u4e8e\u8fd9\u4e2a CRI \u5b9e\u73b0\u7684\u4e00\u4e2a shim\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u5e95\u5c42\u662f Docker \u5bb9\u5668\u7684\u8bdd\u5c31\u4e0d\u9700\u8981\u5355\u72ec\u5b89\u88c5\u8fd9\u4e2a CRI \u7684\u5b9e\u73b0\u7684\u7ec4\u4ef6\u4e86\u3002\u5176\u4ed6\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\u662f\u9700\u8981\u63d0\u4f9b\u8fd9\u6837\u7684\u4e00\u4e2a\u63a5\u53e3\u5b9e\u73b0\u7ec4\u4ef6\u7684\u3002\u6240\u4ee5\u5bf9\u4e8e Kubernetes \u6765\u8bf4\u4ed6\u6839\u672c\u4e0d\u5173\u5fc3\u4f60\u90e8\u7f72\u7684\u5230\u5e95\u662f\u4ec0\u4e48\u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u53ea\u8981\u4f60\u8fd9\u4e2a\u5bb9\u5668\u8fd0\u884c\u65f6\u53ef\u4ee5\u5b9e\u73b0 CRI \u63a5\u53e3\u5c31\u53ef\u4ee5\u88ab Kubernetes \u6765\u7ba1\u7406\u3002</p> <p>kubelet \u7684\u53e6\u5916\u4e00\u4e2a\u91cd\u8981\u529f\u80fd\u5c31\u662f\u8c03\u7528\u7f51\u7edc\u63d2\u4ef6\uff08<code>CNI</code>\uff09\u548c\u5b58\u50a8\u63d2\u4ef6\uff08<code>CSI</code>\uff09\u4e3a\u5bb9\u5668\u914d\u7f6e\u7f51\u7edc\u548c\u5b58\u50a8\u529f\u80fd\uff0c\u540c\u6837\u7684 kubelet \u4e5f\u662f\u628a\u8fd9\u4e24\u4e2a\u91cd\u8981\u529f\u80fd\u901a\u8fc7\u63a5\u53e3\u66b4\u9732\u7ed9\u5916\u90e8\u4e86\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u60f3\u8981\u5b9e\u73b0\u81ea\u5df1\u7684\u7f51\u7edc\u63d2\u4ef6\uff0c\u53ea\u9700\u8981\u4f7f\u7528 CNI \u5c31\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u5bf9\u63a5\u5230 Kubernetes \u96c6\u7fa4\u5f53\u4e2d\u53bb\u3002</p> <p>\u53ef\u80fd\u4e0b\u9762\u7684\u67b6\u6784\u56fe\u770b\u4e0a\u53bb\u66f4\u6e05\u6670\u4e00\u4e9b\uff1a</p> <p></p>"},{"location":"kubernetes_basic/overview/#_3","title":"\u7ec4\u4ef6","text":"<p>\u4e0a\u9762\u6211\u4ecb\u7ecd\u4e86 Kubernetes \u96c6\u7fa4\u7684\u6574\u4f53\u67b6\u6784\uff0c\u4e0b\u9762\u6211\u4eec\u518d\u6765\u66f4\u52a0\u8be6\u7ec6\u7684\u4e86\u89e3\u4e0b\u8fd9\u4e9b\u7ec4\u4ef6\u7684\u529f\u80fd\u3002</p>"},{"location":"kubernetes_basic/overview/#kube-apiserver","title":"kube-apiserver","text":"<p>API Server \u63d0\u4f9b\u4e86\u8d44\u6e90\u5bf9\u8c61\u7684\u552f\u4e00\u64cd\u4f5c\u5165\u53e3\uff0c\u5176\u5b83\u6240\u6709\u7ec4\u4ef6\u90fd\u5fc5\u987b\u901a\u8fc7\u5b83\u63d0\u4f9b\u7684 API \u6765\u64cd\u4f5c\u8d44\u6e90\u6570\u636e\u3002<code>\u53ea\u6709 API Server \u4f1a\u4e0e etcd \u8fdb\u884c\u901a\u4fe1\uff0c\u5176\u5b83\u6a21\u5757\u90fd\u5fc5\u987b\u901a\u8fc7 API Server \u8bbf\u95ee\u96c6\u7fa4\u72b6\u6001</code>\u3002API Server \u4f5c\u4e3a Kubernetes \u7cfb\u7edf\u7684\u5165\u53e3\uff0c\u5c01\u88c5\u4e86\u6838\u5fc3\u5bf9\u8c61\u7684\u589e\u5220\u6539\u67e5\u64cd\u4f5c\u3002API Server \u4ee5 RESTFul \u63a5\u53e3\u65b9\u5f0f\u63d0\u4f9b\u7ed9\u5916\u90e8\u5ba2\u6237\u7aef\u548c\u5185\u90e8\u7ec4\u4ef6\u8c03\u7528\uff0cAPI Server \u518d\u5bf9\u76f8\u5173\u7684\u8d44\u6e90\u6570\u636e\uff08<code>\u5168\u91cf\u67e5\u8be2 + \u53d8\u5316\u76d1\u542c</code>\uff09\u8fdb\u884c\u64cd\u4f5c\uff0c\u4ee5\u8fbe\u5230\u5b9e\u65f6\u5b8c\u6210\u76f8\u5173\u7684\u4e1a\u52a1\u529f\u80fd\u3002\u4ee5 API Server \u4e3a Kubernetes \u5165\u53e3\u7684\u8bbe\u8ba1\u4e3b\u8981\u6709\u4ee5\u4e0b\u597d\u5904\uff1a</p> <ul> <li>\u4fdd\u8bc1\u4e86\u96c6\u7fa4\u72b6\u6001\u8bbf\u95ee\u7684\u5b89\u5168</li> <li>API Server \u9694\u79bb\u4e86\u96c6\u7fa4\u72b6\u6001\u8bbf\u95ee\u548c\u540e\u7aef\u5b58\u50a8\u5b9e\u73b0\uff0c\u8fd9\u6837 API Server \u72b6\u6001\u8bbf\u95ee\u7684\u65b9\u5f0f\u4e0d\u4f1a\u56e0\u4e3a\u540e\u7aef\u5b58\u50a8\u6280\u672f Etcd \u7684\u6539\u53d8\u800c\u6539\u53d8\uff0c\u8ba9\u540e\u7aef\u5b58\u50a8\u65b9\u5f0f\u9009\u62e9\u66f4\u52a0\u7075\u6d3b\uff0c\u65b9\u4fbf\u4e86\u6574\u4e2a\u67b6\u6784\u7684\u6269\u5c55</li> </ul>"},{"location":"kubernetes_basic/overview/#kube-controller-manager","title":"kube-controller-manager","text":"<p>Controller Manager \u7528\u4e8e\u5b9e\u73b0 Kubernetes \u96c6\u7fa4\u6545\u969c\u68c0\u6d4b\u548c\u6062\u590d\u7684\u81ea\u52a8\u5316\u5de5\u4f5c\u3002\u4e3b\u8981\u8d1f\u8d23\u6267\u884c\u5404\u79cd\u63a7\u5236\u5668\uff1a</p> <ul> <li>Replication Controller\uff1a\u4e3b\u8981\u662f\u5b9a\u671f\u5173\u8054 Replication Controller (RC) \u548c Pod\uff0c\u4ee5\u4fdd\u8bc1\u96c6\u7fa4\u4e2d\u4e00\u4e2a RC (\u4e00\u79cd\u8d44\u6e90\u5bf9\u8c61) \u6240\u5173\u8054\u7684 Pod \u526f\u672c\u6570\u59cb\u7ec8\u4fdd\u6301\u4e3a\u4e0e\u9884\u8bbe\u503c\u4e00\u81f4\u3002</li> <li>Node Controller\uff1aKubelet \u5728\u542f\u52a8\u65f6\u4f1a\u901a\u8fc7 API Server \u6ce8\u518c\u81ea\u8eab\u7684\u8282\u70b9\u4fe1\u606f\uff0c\u5e76\u5b9a\u65f6\u5411 API Server \u6c47\u62a5\u72b6\u6001\u4fe1\u606f\u3002API Server \u5728\u63a5\u6536\u5230\u4fe1\u606f\u540e\u5c06\u4fe1\u606f\u66f4\u65b0\u5230 Etcd \u4e2d\u3002Node Controller \u901a\u8fc7 API Server \u5b9e\u65f6\u83b7\u53d6 Node \u7684\u76f8\u5173\u4fe1\u606f\uff0c\u5b9e\u73b0\u7ba1\u7406\u548c\u76d1\u63a7\u96c6\u7fa4\u4e2d\u7684\u5404\u4e2a Node \u8282\u70b9\u7684\u76f8\u5173\u63a7\u5236\u529f\u80fd\u3002</li> <li>ResourceQuota Controller\uff1a\u8d44\u6e90\u914d\u989d\u7ba1\u7406\u63a7\u5236\u5668\u7528\u4e8e\u786e\u4fdd\u6307\u5b9a\u7684\u8d44\u6e90\u5bf9\u8c61\u5728\u4efb\u4f55\u65f6\u5019\u90fd\u4e0d\u4f1a\u8d85\u91cf\u5360\u7528\u7cfb\u7edf\u4e0a\u7269\u7406\u8d44\u6e90\u3002</li> <li>Namespace Controller\uff1a\u7528\u6237\u901a\u8fc7 API Server \u53ef\u4ee5\u521b\u5efa\u65b0\u7684 Namespace \u5e76\u4fdd\u5b58\u5728 Etcd \u4e2d\uff0cNamespace Controller \u5b9a\u65f6\u901a\u8fc7 API Server \u8bfb\u53d6\u8fd9\u4e9b Namespace \u4fe1\u606f\u6765\u64cd\u4f5c Namespace\u3002\u6bd4\u5982\uff1aNamespace \u88ab API \u6807\u8bb0\u4e3a\u4f18\u96c5\u5220\u9664\uff0c\u5219\u5c06\u8be5 Namespace \u72b6\u6001\u8bbe\u7f6e\u4e3a Terminating \u5e76\u4fdd\u5b58\u5230 Etcd \u4e2d\u3002\u540c\u65f6 Namespace Controller \u5220\u9664\u8be5 Namespace \u4e0b\u7684 ServiceAccount\u3001Deployment\u3001Pod \u7b49\u8d44\u6e90\u5bf9\u8c61\u3002</li> <li>Service Account Controller\uff1a\u670d\u52a1\u8d26\u53f7\u63a7\u5236\u5668\u4e3b\u8981\u5728\u547d\u540d\u7a7a\u95f4\u5185\u7ba1\u7406 ServiceAccount\uff0c\u4ee5\u4fdd\u8bc1\u540d\u4e3a default \u7684 ServiceAccount \u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u5b58\u5728\u3002</li> <li>Token Controller\uff1a\u4ee4\u724c\u63a7\u5236\u5668\u4f5c\u4e3a Controller Manager \u7684\u4e00\u90e8\u5206\uff0c\u4e3b\u8981\u7528\u4f5c\uff1a\u76d1\u542c serviceAccount \u7684\u521b\u5efa\u548c\u5220\u9664\u52a8\u4f5c\u4ee5\u53ca\u76d1\u542c secret \u7684\u6dfb\u52a0\u3001\u5220\u9664\u52a8\u4f5c\u3002</li> <li>Service Controller\uff1a\u670d\u52a1\u63a7\u5236\u5668\u4e3b\u8981\u7528\u4f5c\u76d1\u542c Service \u7684\u53d8\u5316\u3002\u6bd4\u5982\uff1a\u521b\u5efa\u7684\u662f\u4e00\u4e2a LoadBalancer \u7c7b\u578b\u7684 Service\uff0cService Controller \u5219\u8981\u786e\u4fdd\u5916\u90e8\u7684\u4e91\u5e73\u53f0\u4e0a\u5bf9\u8be5 Service \u5bf9\u5e94\u7684 LoadBalancer \u5b9e\u4f8b\u88ab\u521b\u5efa\u3001\u5220\u9664\u4ee5\u53ca\u76f8\u5e94\u7684\u8def\u7531\u8f6c\u53d1\u8868\u88ab\u66f4\u65b0\u3002</li> <li>Endpoint Controller\uff1aEndpoints \u8868\u793a\u4e86\u4e00\u4e2a Service \u5bf9\u5e94\u7684\u6240\u6709 Pod \u526f\u672c\u7684\u8bbf\u95ee\u5730\u5740\uff0c\u800c Endpoints Controller \u662f\u8d1f\u8d23\u751f\u6210\u548c\u7ef4\u62a4\u6240\u6709 Endpoints \u5bf9\u8c61\u7684\u63a7\u5236\u5668\u3002Endpoint Controller \u8d1f\u8d23\u76d1\u542c Service \u548c\u5bf9\u5e94\u7684 Pod \u526f\u672c\u7684\u53d8\u5316\u3002\u5b9a\u671f\u5173\u8054 Service \u548c Pod (\u5173\u8054\u4fe1\u606f\u7531 Endpoint \u5bf9\u8c61\u7ef4\u62a4)\uff0c\u4ee5\u4fdd\u8bc1 Service \u5230 Pod \u7684\u6620\u5c04\u603b\u662f\u6700\u65b0\u7684\u3002</li> </ul>"},{"location":"kubernetes_basic/overview/#kube-scheduler","title":"kube-scheduler","text":"<p>Scheduler \u662f\u8d1f\u8d23\u6574\u4e2a\u96c6\u7fa4\u7684\u8d44\u6e90\u8c03\u5ea6\u7684\uff0c\u4e3b\u8981\u7684\u804c\u8d23\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li>\u4e3b\u8981\u7528\u4e8e\u6536\u96c6\u548c\u5206\u6790\u5f53\u524d Kubernetes \u96c6\u7fa4\u4e2d\u6240\u6709 Node \u8282\u70b9\u7684\u8d44\u6e90 (\u5305\u62ec\u5185\u5b58\u3001CPU \u7b49) \u8d1f\u8f7d\u60c5\u51b5\uff0c\u7136\u540e\u4f9d\u636e\u8d44\u6e90\u5360\u7528\u60c5\u51b5\u5206\u53d1\u65b0\u5efa\u7684 Pod \u5230 Kubernetes \u96c6\u7fa4\u4e2d\u53ef\u7528\u7684\u8282\u70b9</li> <li>\u5b9e\u65f6\u76d1\u6d4b Kubernetes \u96c6\u7fa4\u4e2d\u672a\u5206\u53d1\u548c\u5df2\u5206\u53d1\u7684\u6240\u6709\u8fd0\u884c\u7684 Pod</li> <li>\u5b9e\u65f6\u76d1\u6d4b Node \u8282\u70b9\u4fe1\u606f\uff0c\u7531\u4e8e\u4f1a\u9891\u7e41\u67e5\u627e Node \u8282\u70b9\uff0c\u6240\u4ee5 Scheduler \u540c\u65f6\u4f1a\u7f13\u5b58\u4e00\u4efd\u6700\u65b0\u7684\u4fe1\u606f\u5728\u672c\u5730</li> <li>\u5728\u5206\u53d1 Pod \u5230\u6307\u5b9a\u7684 Node \u8282\u70b9\u540e\uff0c\u4f1a\u628a Pod \u76f8\u5173\u7684 Binding \u4fe1\u606f\u5199\u56de API Server\uff0c\u4ee5\u65b9\u4fbf\u5176\u5b83\u7ec4\u4ef6\u4f7f\u7528</li> </ul>"},{"location":"kubernetes_basic/overview/#kubelet","title":"kubelet","text":"<p>kubelet \u662f\u8d1f\u8d23\u5bb9\u5668\u771f\u6b63\u8fd0\u884c\u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u4e3b\u8981\u7684\u804c\u8d23\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li>\u8d1f\u8d23 Node \u8282\u70b9\u4e0a Pod \u7684\u521b\u5efa\u3001\u4fee\u6539\u3001\u76d1\u63a7\u3001\u5220\u9664\u7b49\u5168\u751f\u547d\u5468\u671f\u7684\u7ba1\u7406</li> <li>\u5b9a\u65f6\u4e0a\u62a5\u672c\u5730 Node \u7684\u72b6\u6001\u4fe1\u606f\u7ed9 API Server</li> <li>kubelet \u662f Master \u548c Node \u4e4b\u95f4\u7684\u6865\u6881\uff0c\u63a5\u6536 API Server \u5206\u914d\u7ed9\u5b83\u7684\u4efb\u52a1\u5e76\u6267\u884c</li> <li>kubelet \u901a\u8fc7 API Server \u95f4\u63a5\u4e0e Etcd \u96c6\u7fa4\u4ea4\u4e92\u6765\u8bfb\u53d6\u96c6\u7fa4\u914d\u7f6e\u4fe1\u606f</li> <li>kubelet \u5728 Node \u4e0a\u505a\u7684\u4e3b\u8981\u5de5\u4f5c\u5177\u4f53\u5982\u4e0b\uff1a<ol> <li>\u8bbe\u7f6e\u5bb9\u5668\u7684\u73af\u5883\u53d8\u91cf\u3001\u7ed9\u5bb9\u5668\u7ed1\u5b9a Volume\u3001\u7ed9\u5bb9\u5668\u7ed1\u5b9a Port\u3001\u6839\u636e\u6307\u5b9a\u7684 Pod \u8fd0\u884c\u4e00\u4e2a\u5355\u4e00\u5bb9\u5668\u3001\u7ed9\u6307\u5b9a\u7684 Pod \u521b\u5efa Network \u5bb9\u5668</li> <li>\u540c\u6b65 Pod \u7684\u72b6\u6001</li> <li>\u5728\u5bb9\u5668\u4e2d\u8fd0\u884c\u547d\u4ee4\u3001\u6740\u6b7b\u5bb9\u5668\u3001\u5220\u9664 Pod \u7684\u6240\u6709\u5bb9\u5668</li> </ol> </li> </ul> <p>\u6e90\u7801</p> <p>\u5bf9\u6e90\u7801\u611f\u5174\u8da3\u7684\u53ef\u4ee5\u67e5\u770b Kubelet \u6e90\u7801\u90e8\u5206\u7684\u89e3\u6790\uff1akubelet \u6e90\u7801\u6d45\u6790</p>"},{"location":"kubernetes_basic/overview/#kube-proxy","title":"kube-proxy","text":"<p>kube-proxy \u662f\u4e3a\u4e86\u89e3\u51b3\u5916\u90e8\u7f51\u7edc\u80fd\u591f\u8bbf\u95ee\u96c6\u7fa4\u4e2d\u5bb9\u5668\u63d0\u4f9b\u7684\u5e94\u7528\u670d\u52a1\u800c\u8bbe\u8ba1\u7684\uff0cProxy \u8fd0\u884c\u5728\u6bcf\u4e2aNode \u4e0a\u3002</p> <p>\u6bcf\u521b\u5efa\u4e00\u4e2a Service\uff0ckube-proxy \u5c31\u4f1a\u4ece API Server \u83b7\u53d6 Services \u548c Endpoints \u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u7136\u540e\u6839\u636e\u5176\u914d\u7f6e\u4fe1\u606f\u5728 Node \u4e0a\u542f\u52a8\u4e00\u4e2a Proxy \u7684\u8fdb\u7a0b\u5e76\u76d1\u542c\u76f8\u5e94\u7684\u670d\u52a1\u7aef\u53e3\u3002</p> <p>\u5f53\u63a5\u6536\u5230\u5916\u90e8\u8bf7\u6c42\u65f6\uff0ckube-proxy \u4f1a\u6839\u636e Load Balancer \u5c06\u8bf7\u6c42\u5206\u53d1\u5230\u540e\u7aef\u6b63\u786e\u7684\u5bb9\u5668\u5904\u7406\u3002</p> <p>kube-proxy \u4e0d\u4f46\u89e3\u51b3\u4e86\u540c\u4e00\u5bbf\u4e3b\u673a\u76f8\u540c\u670d\u52a1\u7aef\u53e3\u51b2\u7a81\u7684\u95ee\u9898\uff0c\u8fd8\u63d0\u4f9b\u4e86 Service \u8f6c\u53d1\u670d\u52a1\u7aef\u53e3\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u7684\u80fd\u529b\u3002</p> <p>kube-proxy \u540e\u7aef\u4f7f\u7528<code>\u968f\u673a\u3001\u8f6e\u5faa</code>\u7b49\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u8fdb\u884c\u8c03\u5ea6\u3002</p>"},{"location":"kubernetes_basic/overview/#kubectl","title":"kubectl","text":"<p>Kubectl \u662f Kubernetes \u7684\u96c6\u7fa4\u7ba1\u7406\u547d\u4ee4\u884c\u5ba2\u6237\u7aef\u5de5\u5177\u96c6\u3002\u901a\u8fc7 Kubectl \u547d\u4ee4\u5bf9 API Server \u8fdb\u884c\u64cd\u4f5c\uff0cAPI Server \u54cd\u5e94\u5e76\u8fd4\u56de\u5bf9\u5e94\u7684\u547d\u4ee4\u7ed3\u679c\uff0c\u4ece\u800c\u8fbe\u5230\u5bf9 Kubernetes \u96c6\u7fa4\u7684\u7ba1\u7406</p>"},{"location":"kubernetes_basic/overview/#_4","title":"\u6838\u5fc3\u8d44\u6e90\u5bf9\u8c61","text":"<p>\u4e0a\u9762\u6211\u4eec\u90fd\u662f\u5728\u67b6\u6784\u5c42\u9762\u4e86\u89e3 Kubernetes\uff0c\u4f46\u662f\u4f3c\u4e4e\u6ca1\u6709\u53d1\u73b0\u5173\u4e8e\u5bb9\u5668\u7684\u8bf4\u660e\uff0cKubernetes \u4f5c\u4e3a\u5bb9\u5668\u7f16\u6392\u5f15\u64ce\uff0c\u90a3\u4e48\u4ed6\u662f\u600e\u4e48\u53bb\u5bf9\u5bb9\u5668\u8fdb\u884c\u7f16\u6392\u7684\u5462\uff1f\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u62bd\u8c61\u4e86\u5f88\u591a\u96c6\u7fa4\u5185\u90e8\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u53bb\u64cd\u4f5c\u5bb9\u5668\u7684\u7f16\u6392\u5de5\u4f5c\u3002</p>"},{"location":"kubernetes_basic/overview/#pod","title":"Pod","text":"<p>Pod \u662f\u4e00\u7ec4\u7d27\u5bc6\u5173\u8054\u7684<code>\u5bb9\u5668\u96c6\u5408</code>\uff0c\u5b83\u4eec\u5171\u4eab PID\u3001IPC\u3001Network \u548c UTS namespace\uff0c\u662fKubernetes \u8c03\u5ea6\u7684<code>\u57fa\u672c\u5355\u4f4d</code>\u3002Pod \u7684\u8bbe\u8ba1\u7406\u5ff5\u662f\u652f\u6301\u591a\u4e2a\u5bb9\u5668\u5728\u4e00\u4e2a Pod \u4e2d\u5171\u4eab\u7f51\u7edc\u548c\u6587\u4ef6\u7cfb\u7edf\uff0c\u53ef\u4ee5\u901a\u8fc7\u8fdb\u7a0b\u95f4\u901a\u4fe1\u548c\u6587\u4ef6\u5171\u4eab\u8fd9\u79cd\u7b80\u5355\u9ad8\u6548\u7684\u65b9\u5f0f\u7ec4\u5408\u5b8c\u6210\u670d\u52a1\u3002\u6211\u4eec\u77e5\u9053\u5bb9\u5668\u672c\u8d28\u4e0a\u5c31\u662f\u8fdb\u7a0b\uff0c\u90a3\u4e48 Pod \u5b9e\u9645\u4e0a\u5c31\u662f\u8fdb\u7a0b\u7ec4\u4e86\uff0c\u53ea\u662f\u8fd9\u4e00\u7ec4\u8fdb\u7a0b\u662f\u4f5c\u4e3a\u4e00\u4e2a\u6574\u4f53\u6765\u8fdb\u884c\u8c03\u5ea6\u7684\u3002</p> <p></p> <p>\u5728 Kubernetes \u4e2d\uff0c\u6240\u6709\u8d44\u6e90\u5bf9\u8c61\u90fd\u4f7f\u7528\u8d44\u6e90\u6e05\u5355\uff08yaml\u6216json\uff09\u6765\u5b9a\u4e49\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a\u7b80\u5355\u7684 nginx \u670d\u52a1\uff0c\u5b83\u5305\u542b\u4e00\u4e2a\u955c\u50cf\u4e3a nginx \u7684\u5bb9\u5668\uff1a(nginx-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:  \n  name: nginx  \n  labels:    \n    app: nginx\nspec:  \n  containers:  \n  - name: nginx    \n    image: nginx    \n    ports:    \n    - containerPort: 80\n</code></pre> <p>\u5b9a\u4e49\u4e86\u8fd9\u6837\u4e00\u4e2a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528\u4e0a\u9762\u6211\u4eec\u63d0\u5230\u7684 Kubectl \u5de5\u5177\u5c06\u8fd9\u4e2a Pod \u521b\u5efa\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff1a</p> <pre><code>$ kubectl apply -f nginx-pod.yaml\n</code></pre> <p>Pod \u5728 Kubernetes \u96c6\u7fa4\u4e2d\u88ab\u521b\u5efa\u7684\u57fa\u672c\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <ul> <li>\u7528\u6237\u901a\u8fc7 REST API \u521b\u5efa\u4e00\u4e2a Pod</li> <li>apiserver \u5c06\u5176\u5199\u5165 etcd</li> <li>scheduluer \u68c0\u6d4b\u5230\u672a\u7ed1\u5b9a Node \u7684 Pod\uff0c\u5f00\u59cb\u8c03\u5ea6\u5e76\u66f4\u65b0 Pod \u7684 Node \u7ed1\u5b9a</li> <li>kubelet \u68c0\u6d4b\u5230\u6709\u65b0\u7684 Pod \u8c03\u5ea6\u8fc7\u6765\uff0c\u901a\u8fc7 container runtime \u8fd0\u884c\u8be5 Pod</li> <li>kubelet \u901a\u8fc7 container runtime \u53d6\u5230 Pod \u72b6\u6001\uff0c\u5e76\u66f4\u65b0\u5230 apiserver \u4e2d</li> </ul>"},{"location":"kubernetes_basic/overview/#label","title":"Label","text":"<p>Label \u6807\u7b7e\u5728 Kubernetes \u8d44\u6e90\u5bf9\u8c61\u4e2d\u4f7f\u7528\u5f88\u591a\uff0c\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u7684\u4e00\u4e2a\u5c5e\u6027\uff0cLabel \u662f\u8bc6\u522b Kubernetes \u5bf9\u8c61\u7684\u6807\u7b7e\uff0c\u4ee5 <code>key/value</code> \u7684\u65b9\u5f0f\u9644\u52a0\u5230\u5bf9\u8c61\u4e0a\uff08key\u6700\u957f\u4e0d\u80fd\u8d85\u8fc763\u5b57\u8282\uff0cvalue \u53ef\u4ee5\u4e3a\u7a7a\uff0c\u4e5f\u53ef\u4ee5\u662f\u4e0d\u8d85\u8fc7253\u5b57\u8282\u7684\u5b57\u7b26\u4e32\uff09\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u7684 Nginx \u7684 Pod \u5c31\u6dfb\u52a0\u4e86\u4e00\u4e2a <code>app=nginx</code> \u7684 Label \u6807\u7b7e\u3002Label \u4e0d\u63d0\u4f9b\u552f\u4e00\u6027\uff0c\u5e76\u4e14\u5b9e\u9645\u4e0a\u7ecf\u5e38\u662f\u5f88\u591a\u5bf9\u8c61\uff08\u5982Pods\uff09\u90fd\u4f7f\u7528\u76f8\u540c\u7684 Label \u6765\u6807\u5fd7\u5177\u4f53\u7684\u5e94\u7528\u3002Label \u5b9a\u4e49\u597d\u540e\u5176\u4ed6\u5bf9\u8c61\u53ef\u4ee5\u4f7f\u7528 <code>Label Selector</code> \u6765\u9009\u62e9\u4e00\u7ec4\u76f8\u540c Label \u7684\u5bf9\u8c61\uff08\u6bd4\u5982 Service \u7528 Label \u6765\u9009\u62e9\u4e00\u7ec4 Pod\uff09\u3002Label Selector \u652f\u6301\u4ee5\u4e0b\u51e0\u79cd\u65b9\u5f0f\uff1a</p> <ul> <li>\u7b49\u5f0f\uff0c\u5982 <code>app=nginx</code> \u548c <code>env!=production</code></li> <li> <p>\u96c6\u5408\uff0c\u5982 </p> <pre><code>env in (production, qa)\n</code></pre> </li> <li> <p>\u591a\u4e2a Label\uff08\u5b83\u4eec\u4e4b\u95f4\u662f<code>AND</code>\u5173\u7cfb\uff09\uff0c\u5982<code>app=nginx,env=test</code></p> </li> </ul>"},{"location":"kubernetes_basic/overview/#namespace","title":"Namespace","text":"<p>Namespace\uff08\u547d\u540d\u7a7a\u95f4\uff09\u662f\u5bf9\u4e00\u7ec4\u8d44\u6e90\u548c\u5bf9\u8c61\u7684\u62bd\u8c61\u96c6\u5408\uff0c\u6bd4\u5982\u53ef\u4ee5\u7528\u6765\u5c06\u7cfb\u7edf\u5185\u90e8\u7684\u5bf9\u8c61\u5212\u5206\u4e3a\u4e0d\u540c\u7684\u9879\u76ee\u7ec4\u6216\u7528\u6237\u7ec4\u3002\u5e38\u89c1\u7684 Pods\u3001Services\u3001Deployments \u7b49\u90fd\u662f\u5c5e\u4e8e\u67d0\u4e00\u4e2a Namespace \u7684\uff08\u9ed8\u8ba4\u662fdefault\uff09\uff0c\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u7684 Nginx Pod \u6ca1\u6709\u6307\u5b9a namespace\uff0c\u5219\u9ed8\u8ba4\u5c31\u5728 default \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\uff0c\u800c Node, PersistentVolumes \u7b49\u8d44\u6e90\u5219\u4e0d\u5c5e\u4e8e\u4efb\u4f55 Namespace\uff0c\u662f\u5168\u5c40\u7684\u3002</p> <p>\u6ce8\u610f\u5b83\u5e76\u4e0d\u662f Linux Namespace\uff0c\u4e8c\u8005\u6ca1\u6709\u4efb\u4f55\u5173\u7cfb\uff0c\u5b83\u53ea\u662f Kubernetes \u5212\u5206\u4e0d\u540c\u5de5\u4f5c\u7a7a\u95f4\u7684\u4e00\u4e2a\u903b\u8f91\u5355\u4f4d\u3002</p>"},{"location":"kubernetes_basic/overview/#deployment","title":"Deployment","text":"<p>\u6211\u4eec\u8bf4\u4e86 Pod \u662f Kubernetes \u96c6\u7fa4\u4e2d\u7684\u6700\u57fa\u672c\u7684\u8c03\u5ea6\u5355\u5143\uff0c\u4f46\u662f\u5982\u679c\u60f3\u8981\u521b\u5efa\u540c\u4e00\u4e2a\u5bb9\u5668\u7684\u591a\u4efd\u62f7\u8d1d\uff0c\u9700\u8981\u4e00\u4e2a\u4e00\u4e2a\u5206\u522b\u521b\u5efa\u51fa\u6765\u4e48\uff0c\u90a3\u4e48\u80fd\u5426\u5c06 Pods \u5212\u5230\u4e00\u4e2a\u903b\u8f91\u7ec4\u91cc\u9762\u5462\uff1fDeployment \u5c31\u662f\u6765\u7ba1\u7406 Pod \u7684\u8d44\u6e90\u5bf9\u8c61\u3002</p> <p>Deployment \u786e\u4fdd\u4efb\u610f\u65f6\u95f4\u90fd\u6709\u6307\u5b9a\u6570\u91cf\u7684 Pod\u526f\u672c\u5728\u8fd0\u884c\u3002\u5982\u679c\u4e3a\u67d0\u4e2a Pod \u521b\u5efa\u4e86 Deployment \u5e76\u4e14\u6307\u5b9a3\u4e2a\u526f\u672c\uff0c\u5b83\u4f1a\u521b\u5efa3\u4e2a Pod\uff0c\u5e76\u4e14\u6301\u7eed\u76d1\u63a7\u5b83\u4eec\u3002\u5982\u679c\u67d0\u4e2a Pod \u4e0d\u54cd\u5e94\uff0c\u90a3\u4e48 Deployment \u4f1a\u66ff\u6362\u5b83\uff0c\u59cb\u7ec8\u4fdd\u6301\u603b\u6570\u4e3a3\u3002</p> <p>\u5982\u679c\u4e4b\u524d\u4e0d\u54cd\u5e94\u7684 Pod \u6062\u590d\u4e86\uff0c\u73b0\u5728\u5c31\u67094\u4e2a Pod \u4e86\uff0c\u90a3\u4e48 Deployment \u4f1a\u5c06\u5176\u4e2d\u4e00\u4e2a\u7ec8\u6b62\u4fdd\u6301\u603b\u6570\u4e3a3\u3002\u5982\u679c\u5728\u8fd0\u884c\u4e2d\u5c06\u526f\u672c\u603b\u6570\u6539\u4e3a5\uff0cDeployment \u4f1a\u7acb\u523b\u542f\u52a82\u4e2a\u65b0 Pod\uff0c\u4fdd\u8bc1\u603b\u6570\u4e3a5\u3002\u6301\u56de\u6eda\u548c\u6eda\u52a8\u5347\u7ea7\u3002</p> <p>\u5f53\u521b\u5efa Deployment \u65f6\uff0c\u9700\u8981\u6307\u5b9a\u4e24\u4e2a\u4e1c\u897f\uff1a</p> <ul> <li>Pod \u6a21\u677f\uff1a\u7528\u6765\u521b\u5efa Pod \u526f\u672c\u7684\u6a21\u677f</li> <li>Label \u6807\u7b7e\uff1aDeployment \u9700\u8981\u76d1\u63a7\u7684 Pod \u7684\u6807\u7b7e\u3002</li> </ul> <p>\u73b0\u5728\u5df2\u7ecf\u521b\u5efa\u4e86 Pod \u7684\u4e00\u4e9b\u526f\u672c\uff0c\u90a3\u4e48\u8fd9\u4e9b\u526f\u672c\u4e0a\u5982\u4f55\u8fdb\u884c\u8d1f\u8f7d\u5462\uff1f\u5982\u4f55\u628a\u8fd9\u4e9b Pod \u66b4\u9732\u51fa\u53bb\u5462\uff1f\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u7528\u5230 Service \u8fd9\u79cd\u8d44\u6e90\u5bf9\u8c61\u4e86\u3002</p>"},{"location":"kubernetes_basic/overview/#service","title":"Service","text":"<p>Service \u662f\u5e94\u7528\u670d\u52a1\u7684\u62bd\u8c61\uff0c\u901a\u8fc7 Labels \u4e3a\u5e94\u7528\u63d0\u4f9b<code>\u8d1f\u8f7d\u5747\u8861\u548c\u670d\u52a1\u53d1\u73b0</code>\u3002\u5339\u914d Labels \u7684 Pod IP \u548c\u7aef\u53e3\u5217\u8868\u7ec4\u6210 Endpoints\uff0c\u7531 kube-proxy \u8d1f\u8d23\u5c06\u670d\u52a1 IP \u8d1f\u8f7d\u5747\u8861\u5230\u8fd9\u4e9b Endpoints \u4e0a\u3002</p> <p>\u6bcf\u4e2a Service \u90fd\u4f1a\u81ea\u52a8\u5206\u914d\u4e00\u4e2a cluster IP\uff08\u4ec5\u5728\u96c6\u7fa4\u5185\u90e8\u53ef\u8bbf\u95ee\u7684\u865a\u62df\u5730\u5740\uff09\u548c DNS \u540d\uff0c\u5176\u4ed6\u5bb9\u5668\u53ef\u4ee5\u901a\u8fc7\u8be5\u5730\u5740\u6216 DNS \u6765\u8bbf\u95ee\u670d\u52a1\uff0c\u800c\u4e0d\u9700\u8981\u4e86\u89e3\u540e\u7aef\u5bb9\u5668\u7684\u8fd0\u884c\u3002</p> <p></p> <p>\u8fc1\u79fb</p> <p>\u4e86\u89e3\u4e86\u4e0a\u9762\u7684\u51e0\u4e2a\u57fa\u672c\u6982\u5ff5\u540e\uff0c\u6211\u4eec\u5c31\u5b8c\u5168\u53ef\u4ee5\u628a\u6211\u4eec\u7684\u5bb9\u5668\u670d\u52a1\u8fc1\u79fb\u5230 Kubernetes \u96c6\u7fa4\u4e0a\u4e86\u3002\u5f53\u7136\u6211\u4eec\u8fd8\u5f97\u5148\u642d\u5efa\u597d\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\u73af\u5883\u3002</p>"},{"location":"kubernetes_basic/pod/","title":"Pod\u539f\u7406","text":""},{"location":"kubernetes_basic/pod/#pod","title":"Pod","text":"<p>Kubernetes \u6700\u57fa\u672c\u7684\u8c03\u5ea6\u5355\u5143</p> <p></p> <p>\u524d\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u4e86\u89e3\u4e86 Kubernetes \u7684\u57fa\u672c\u67b6\u6784\uff0c\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u8d44\u6e90\u6e05\u5355\u5728\u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e00\u4e2a\u5e94\u7528\u3002\u6211\u4eec\u4e5f\u4e86\u89e3\u5230\u4e86 Pod \u662f Kubernetes \u96c6\u7fa4\u4e2d\u6700\u57fa\u672c\u7684\u8c03\u5ea6\u5355\u5143\uff0c\u6211\u4eec\u5e73\u65f6\u5728\u96c6\u7fa4\u4e2d\u90e8\u7f72\u7684\u5e94\u7528\u90fd\u662f\u4ee5 Pod \u4e3a\u5355\u4f4d\u7684\uff0c\u800c\u5e76\u4e0d\u662f\u6211\u4eec\u719f\u77e5\u7684\u5bb9\u5668\uff0c\u8fd9\u6837\u8bbe\u8ba1\u7684\u76ee\u7684\u662f\u4ec0\u4e48\u5462\uff1f\u4e3a\u4f55\u4e0d\u76f4\u63a5\u4f7f\u7528\u5bb9\u5668\u5462\uff1f</p>"},{"location":"kubernetes_basic/pod/#pod_1","title":"\u4e3a\u4ec0\u4e48\u9700\u8981 Pod","text":"<p>\u5047\u8bbe Kubernetes \u4e2d\u8c03\u5ea6\u7684\u57fa\u672c\u5355\u5143\u5c31\u662f\u5bb9\u5668\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u5e94\u7528\u53ef\u4ee5\u76f4\u63a5\u88ab\u8c03\u5ea6\u76f4\u63a5\u4f7f\u7528\uff0c\u6ca1\u6709\u4ec0\u4e48\u95ee\u9898\uff0c\u4f46\u662f\u5f80\u5f80\u8fd8\u6709\u5f88\u591a\u5e94\u7528\u7a0b\u5e8f\u662f\u7531\u591a\u4e2a\u8fdb\u7a0b\u7ec4\u6210\u7684\uff0c\u6709\u7684\u540c\u5b66\u53ef\u80fd\u4f1a\u8bf4\u628a\u8fd9\u4e9b\u8fdb\u7a0b\u90fd\u6253\u5305\u5230\u4e00\u4e2a\u5bb9\u5668\u4e2d\u53bb\u4e0d\u5c31\u53ef\u4ee5\u4e86\u5417\uff1f\u7406\u8bba\u4e0a\u662f\u53ef\u4ee5\u5b9e\u73b0\u7684\uff0c\u4f46\u662f\u4e0d\u8981\u5fd8\u8bb0\u4e86 Docker \u7ba1\u7406\u7684\u8fdb\u7a0b\u662f pid=1 \u7684\u4e3b\u8fdb\u7a0b\uff0c\u5176\u4ed6\u8fdb\u7a0b\u6b7b\u6389\u4e86\u5c31\u4f1a\u6210\u4e3a\u50f5\u5c38\u8fdb\u7a0b\uff0c\u6ca1\u529e\u6cd5\u8fdb\u884c\u7ba1\u7406\u4e86\uff0c\u8fd9\u79cd\u65b9\u5f0f\u672c\u8eab\u4e5f\u4e0d\u662f\u5bb9\u5668\u63a8\u8350\u7684\u8fd0\u884c\u65b9\u5f0f\uff0c\u4e00\u4e2a\u5bb9\u5668\u6700\u597d<code>\u53ea\u5e72\u4e00\u4ef6\u4e8b\u60c5</code>\uff0c\u6240\u4ee5\u5728\u771f\u5b9e\u7684\u73af\u5883\u4e2d\u4e0d\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002</p> <p>\u90a3\u4e48\u6211\u4eec\u5c31\u628a\u8fd9\u4e2a\u5e94\u7528\u7684\u8fdb\u7a0b\u8fdb\u884c\u62c6\u5206\uff0c\u62c6\u5206\u6210\u4e00\u4e2a\u4e00\u4e2a\u7684\u5bb9\u5668\u603b\u53ef\u4ee5\u4e86\u5427\uff1f\u4f46\u662f\u4e0d\u8981\u5fd8\u8bb0\u4e00\u4e2a\u95ee\u9898\uff0c\u62c6\u5206\u6210\u4e00\u4e2a\u4e00\u4e2a\u7684\u5bb9\u5668\u540e\uff0c\u662f\u4e0d\u662f\u5c31\u6709\u53ef\u80fd\u51fa\u73b0\u4e00\u4e2a\u5e94\u7528\u4e0b\u9762\u7684\u67d0\u4e2a\u8fdb\u7a0b\u5bb9\u5668\u88ab\u8c03\u5ea6\u5230\u4e86\u4e0d\u540c\u7684\u8282\u70b9\u4e0a\u5440\uff1f\u5f80\u5f80\u6211\u4eec\u5e94\u7528\u5185\u90e8\u7684\u8fdb\u7a0b\u4e0e\u8fdb\u7a0b\u95f4\u901a\u4fe1\uff08\u901a\u8fc7 IPC \u6216\u8005\u5171\u4eab\u672c\u5730\u6587\u4ef6\u4e4b\u7c7b\uff09\u90fd\u662f\u8981\u6c42\u5728\u672c\u5730\u8fdb\u884c\u7684\uff0c\u4e5f\u5c31\u662f\u9700\u8981\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u66f4\u9ad8\u7ea7\u522b\u7684\u7ed3\u6784\u6765\u5c06\u8fd9\u4e9b\u5bb9\u5668\u7ed1\u5b9a\u5728\u4e00\u8d77\uff0c\u5e76\u5c06\u4ed6\u4eec\u4f5c\u4e3a\u4e00\u4e2a\u57fa\u672c\u7684\u8c03\u5ea6\u5355\u5143\u8fdb\u884c\u7ba1\u7406\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u8fd9\u4e9b\u5bb9\u5668\u59cb\u7ec8\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u9762\uff0c\u8fd9\u4e5f\u5c31\u662f Pod \u8bbe\u8ba1\u7684\u521d\u8877\u3002</p>"},{"location":"kubernetes_basic/pod/#pod_2","title":"Pod \u539f\u7406","text":"<p>\u5728\u4e00\u4e2a Pod \u4e0b\u9762\u8fd0\u884c\u51e0\u4e2a\u5173\u7cfb\u975e\u5e38\u5bc6\u5207\u7684\u5bb9\u5668\u8fdb\u7a0b\uff0c\u8fd9\u6837\u4e00\u6765\u8fd9\u4e9b\u8fdb\u7a0b\u672c\u8eab\u53c8\u53ef\u4ee5\u6536\u5230\u5bb9\u5668\u7684\u7ba1\u63a7\uff0c\u53c8\u5177\u6709\u51e0\u4e4e\u4e00\u81f4\u7684\u8fd0\u884c\u73af\u5883\uff0c\u4e5f\u5c31\u5b8c\u7f8e\u89e3\u51b3\u4e86\u4e0a\u9762\u63d0\u5230\u7684\u95ee\u9898\u3002</p> <p>\u5176\u5b9e Pod \u4e5f\u53ea\u662f\u4e00\u4e2a\u903b\u8f91\u6982\u5ff5\uff0c\u771f\u6b63\u8d77\u4f5c\u7528\u7684\u8fd8\u662f Linux \u5bb9\u5668\u7684 Namespace \u548c Cgroup \u8fd9\u4e24\u4e2a\u6700\u57fa\u672c\u7684\u6982\u5ff5\uff0cPod \u88ab\u521b\u5efa\u51fa\u6765\u5176\u5b9e\u662f\u4e00\u7ec4\u5171\u4eab\u4e86\u4e00\u4e9b\u8d44\u6e90\u7684\u5bb9\u5668\u800c\u5df2\u3002\u9996\u5148 Pod \u91cc\u9762\u7684\u6240\u6709\u5bb9\u5668\uff0c\u90fd\u662f\u5171\u4eab\u7684\u540c\u4e00\u4e2a Network Namespace\uff0c\u4f46\u662f\u6d89\u53ca\u5230\u6587\u4ef6\u7cfb\u7edf\u7684\u65f6\u5019\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b Pod \u91cc\u9762\u7684\u5bb9\u5668\u4e4b\u95f4\u7684\u6587\u4ef6\u7cfb\u7edf\u662f\u5b8c\u5168\u9694\u79bb\u7684\uff0c\u4f46\u662f\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u58f0\u660e\u6765\u5171\u4eab\u540c\u4e00\u4e2a Volume\u3002</p> <p>\u5bf9\u4e8e\u5171\u4eab\u540c\u4e00\u4e2a Network Namespace \u8fd9\u4e2a\u6982\u5ff5\u662f\u4e0d\u662f\u6bd4\u8f83\u719f\u6089\uff0c\u6211\u4eec\u4e4b\u524d\u5728 Docker \u7f51\u7edc\u6a21\u5f0f\u7684\u7ae0\u8282\u4e2d\u8bb2\u89e3\u4e86\u7f51\u7edc\u7684 Container \u6a21\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u65b0\u521b\u5efa\u7684\u5bb9\u5668\u548c\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684\u5bb9\u5668\u5171\u4eab\u4e00\u4e2a Network Namespace\uff0c\u5728\u8fd0\u884c\u5bb9\u5668\u7684\u65f6\u5019\u53ea\u9700\u8981\u6307\u5b9a </p> <pre><code>--net=container:\u76ee\u6807\u5bb9\u5668\u540d\n</code></pre> <p>\u8fd9\u4e2a\u53c2\u6570\u5c31\u53ef\u4ee5\u4e86\uff0c\u4f46\u662f\u8fd9\u79cd\u6a21\u5f0f\u6709\u4e00\u4e2a\u660e\u663e\u7684\u95ee\u9898\u90a3\u5c31\u662f\u5bb9\u5668\u7684\u542f\u52a8\u6709\u5148\u540e\u987a\u5e8f\u95ee\u9898\uff0c\u90a3\u4e48 Pod \u662f\u600e\u4e48\u6765\u5904\u7406\u8fd9\u4e2a\u95ee\u9898\u7684\u5462\uff1f\u90a3\u5c31\u662f\u52a0\u5165\u4e00\u4e2a\u4e2d\u95f4\u5bb9\u5668\uff08\u6ca1\u6709\u4ec0\u4e48\u67b6\u6784\u662f\u52a0\u4e00\u4e2a\u4e2d\u95f4\u4ef6\u89e3\u51b3\u4e0d\u4e86\u7684\uff1f\uff09\uff0c\u8fd9\u4e2a\u5bb9\u5668\u53eb\u505a Infra \u5bb9\u5668\uff0c\u800c\u4e14\u8fd9\u4e2a\u5bb9\u5668\u5728 Pod \u4e2d\u6c38\u8fdc\u90fd\u662f\u7b2c\u4e00\u4e2a\u88ab\u521b\u5efa\u7684\u5bb9\u5668\uff0c\u8fd9\u6837\u662f\u4e0d\u662f\u5176\u4ed6\u5bb9\u5668\u90fd\u52a0\u5165\u5230\u8fd9\u4e2a Infra \u5bb9\u5668\u5c31\u53ef\u4ee5\u4e86\uff0c\u8fd9\u6837\u5c31\u5b8c\u5168\u5b9e\u73b0\u4e86 Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u548c Infra \u5bb9\u5668\u5171\u4eab\u540c\u4e00\u4e2a Network Namespace \u4e86\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u6240\u4ee5\u5f53\u6211\u4eec\u90e8\u7f72\u5b8c\u6210 Kubernetes \u96c6\u7fa4\u7684\u65f6\u5019\uff0c\u9996\u5148\u9700\u8981\u4fdd\u8bc1\u5728\u6240\u6709\u8282\u70b9\u4e0a\u53ef\u4ee5\u62c9\u53d6\u5230\u9ed8\u8ba4\u7684 Infra \u955c\u50cf\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b Infra \u955c\u50cf\u5730\u5740\u4e3a <code>k8s.gcr.io/pause:3.1</code>\uff0c\u8fd9\u4e2a\u5bb9\u5668\u5360\u7528\u7684\u8d44\u6e90\u975e\u5e38\u5c11\uff0c\u4f46\u662f\u8fd9\u4e2a\u955c\u50cf\u9ed8\u8ba4\u662f\u9700\u8981\u79d1\u5b66\u4e0a\u7f51\u7684\uff0c\u6240\u4ee5\u5f88\u591a\u65f6\u5019\u6211\u4eec\u5728\u90e8\u7f72\u5e94\u7528\u7684\u65f6\u5019\u4e00\u76f4\u5904\u4e8e <code>Pending</code> \u72b6\u6001\uff0c\u56e0\u4e3a\u6240\u6709 Pod \u6700\u5148\u542f\u52a8\u7684\u5bb9\u5668\u955c\u50cf\u90fd\u62c9\u4e0d\u4e0b\u6765\uff0c\u80af\u5b9a\u542f\u52a8\u4e0d\u4e86\uff0c\u542f\u52a8\u4e0d\u4e86\u5176\u4ed6\u5bb9\u5668\u80af\u5b9a\u4e5f\u5c31\u4e0d\u80fd\u542f\u52a8\u4e86\uff1a</p> <pre><code>$ kubelet --help |grep infra\n      --pod-infra-container-image string                                                                          The image whose network/ipc namespaces containers in each pod will use. This docker-specific flag only works when container-runtime is set to docker. (default \"k8s.gcr.io/pause:1\")\n</code></pre> <p>\u4ece\u4e0a\u9762\u56fe\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u666e\u901a\u7684\u5bb9\u5668\u52a0\u5165\u5230\u4e86 Infra \u5bb9\u5668\u7684 Network Namespace \u4e2d\uff0c\u6240\u4ee5\u8fd9\u4e2a Pod \u4e0b\u9762\u7684\u6240\u6709\u5bb9\u5668\u5c31\u662f\u5171\u4eab\u540c\u4e00\u4e2a Network Namespace \u4e86\uff0c\u666e\u901a\u5bb9\u5668\u4e0d\u4f1a\u521b\u5efa\u81ea\u5df1\u7684\u7f51\u5361\uff0c\u914d\u7f6e\u81ea\u5df1\u7684 IP\uff0c\u800c\u662f\u548c Infra \u5bb9\u5668\u5171\u4eab IP\u3001\u7aef\u53e3\u8303\u56f4\u7b49\uff0c\u800c\u4e14\u5bb9\u5668\u4e4b\u95f4\u7684\u8fdb\u7a0b\u53ef\u4ee5\u901a\u8fc7 lo \u7f51\u5361\u8bbe\u5907\u8fdb\u884c\u901a\u4fe1\uff1a</p> <ul> <li>\u4e5f\u5c31\u662f\u5bb9\u5668\u4e4b\u95f4\u662f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>localhost</code> \u8fdb\u884c\u901a\u4fe1\u7684\uff1b</li> <li>\u770b\u5230\u7684\u7f51\u7edc\u8bbe\u5907\u4fe1\u606f\u90fd\u662f\u548c Infra \u5bb9\u5668\u5b8c\u5168\u4e00\u6837\u7684\uff1b</li> <li>\u4e5f\u5c31\u610f\u5473\u7740\u540c\u4e00\u4e2a Pod \u4e0b\u9762\u7684\u5bb9\u5668\u8fd0\u884c\u7684\u591a\u4e2a\u8fdb\u7a0b\u4e0d\u80fd\u7ed1\u5b9a\u76f8\u540c\u7684\u7aef\u53e3\uff1b</li> <li>\u800c\u4e14 Pod \u7684\u751f\u547d\u5468\u671f\u53ea\u8ddf Infra \u5bb9\u5668\u4e00\u81f4\uff0c\u800c\u4e0e\u5bb9\u5668 A \u548c B \u65e0\u5173\u3002</li> </ul> <p>\u5bf9\u4e8e\u6587\u4ef6\u7cfb\u7edf Kubernetes \u662f\u600e\u4e48\u5b9e\u73b0\u8ba9\u4e00\u4e2a Pod \u4e2d\u7684\u5bb9\u5668\u5171\u4eab\u7684\u5462\uff1f\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7edf\u662f\u4e92\u76f8\u9694\u79bb\u7684\uff0c\u8981\u5b9e\u73b0\u5171\u4eab\u53ea\u9700\u8981\u5728 Pod \u7684\u9876\u5c42\u58f0\u660e\u4e00\u4e2a Volume\uff0c\u7136\u540e\u5728\u9700\u8981\u5171\u4eab\u8fd9\u4e2a Volume \u7684\u5bb9\u5668\u4e2d\u58f0\u660e\u6302\u8f7d\u5373\u53ef\u3002</p> <p></p> <p>\u6bd4\u5982\u4e0b\u9762\u7684\u793a\u4f8b\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\nspec:\n  volumes: \n  - name: varlog\n    hostPath: \n      path: /var/log/counter\n  containers:\n  - name: count\n    image: busybox\n    args:\n    - /bin/sh\n    - -c\n    - &gt;\n      i=0;\n      while true;\n      do\n        echo \"$i: $(date)\" &gt;&gt; /var/log/log;\n        i=$((i+1));\n        sleep 1;\n      done\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  - name: count-log\n    image: busybox\n    args: [/bin/sh, -c, 'tail -n+1 -f /var/log/log']\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n</code></pre> <p>\u793a\u4f8b\u4e2d\u6211\u4eec\u5728 Pod \u7684\u9876\u5c42\u58f0\u660e\u4e86\u4e00\u4e2a\u540d\u4e3a varlog \u7684 <code>Volume</code>\uff0c\u800c\u8fd9\u4e2a <code>Volume</code> \u7684\u7c7b\u578b\u662f <code>hostPath</code>\uff0c\u4e5f\u5c31\u610f\u5473\u8fd9\u4e2a\u5bbf\u4e3b\u673a\u7684 <code>/var/log/counter</code> \u76ee\u5f55\u5c06\u88ab\u8fd9\u4e2a Pod \u5171\u4eab\uff0c\u5171\u4eab\u7ed9\u8c01\u5462\uff1f\u5728\u9700\u8981\u7528\u5230\u8fd9\u4e2a\u6570\u636e\u76ee\u5f55\u7684\u5bb9\u5668\u4e0a\u58f0\u660e\u6302\u8f7d\u5373\u53ef\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7 <code>volumeMounts</code> \u58f0\u660e\u6302\u8f7d\u7684\u90e8\u5206\uff0c\u8fd9\u6837\u6211\u4eec\u8fd9\u4e2a Pod \u5c31\u5b9e\u73b0\u4e86\u5171\u4eab\u5bb9\u5668\u7684 <code>/var/log</code> \u76ee\u5f55\uff0c\u800c\u4e14\u6570\u636e\u88ab\u6301\u4e45\u5316\u5230\u4e86\u5bbf\u4e3b\u673a\u76ee\u5f55\u4e0a\u3002</p> <p>\u8fd9\u4e2a\u65b9\u5f0f\u4e5f\u662f Kubernetes \u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u8bbe\u8ba1\u6a21\u5f0f\uff1a<code>sidecar \u6a21\u5f0f</code>\u7684\u5e38\u7528\u65b9\u5f0f\u3002\u5178\u578b\u7684\u573a\u666f\u5c31\u662f\u5bb9\u5668\u65e5\u5fd7\u6536\u96c6\uff0c\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u7684\u8fd9\u4e2a\u5e94\u7528\uff0c\u5176\u4e2d\u5e94\u7528\u7684\u65e5\u5fd7\u662f\u88ab\u8f93\u51fa\u5230\u5bb9\u5668\u7684 /var/log \u76ee\u5f55\u4e0a\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u628a Pod \u58f0\u660e\u7684 Volume \u6302\u8f7d\u5230\u5bb9\u5668\u7684 /var/log \u76ee\u5f55\u4e0a\uff0c\u7136\u540e\u5728\u8fd9\u4e2a Pod \u91cc\u9762\u540c\u65f6\u8fd0\u884c\u4e00\u4e2a sidecar \u5bb9\u5668\uff0c\u4ed6\u4e5f\u58f0\u660e\u6302\u8f7d\u76f8\u540c\u7684 Volume \u5230\u81ea\u5df1\u5bb9\u5668\u7684 /var/log \uff08\u6216\u5176\u4ed6\uff09\u76ee\u5f55\u4e0a\uff0c\u8fd9\u6837\u6211\u4eec\u8fd9\u4e2a sidecar \u5bb9\u5668\u5c31\u53ea\u9700\u8981\u4ece /var/log \u76ee\u5f55\u4e0b\u9762\u4e0d\u65ad\u6d88\u8d39\u65e5\u5fd7\u53d1\u9001\u5230 Elasticsearch \u4e2d\u5b58\u50a8\u8d77\u6765\u5c31\u5b8c\u6210\u4e86\u6700\u57fa\u672c\u7684\u5e94\u7528\u65e5\u5fd7\u7684\u57fa\u672c\u6536\u96c6\u5de5\u4f5c\u4e86\u3002</p> <p>\u9664\u4e86\u8fd9\u4e2a\u5e94\u7528\u573a\u666f\u4e4b\u5916\u4f7f\u7528\u66f4\u591a\u7684\u8fd8\u662f\u5229\u7528 Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u5171\u4eab\u540c\u4e00\u4e2a Network Namespace \u8fd9\u4e2a\u7279\u6027\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u628a Pod \u7f51\u7edc\u76f8\u5173\u7684\u914d\u7f6e\u548c\u7ba1\u7406\u4e5f\u53ef\u4ee5\u4ea4\u7ed9\u4e00\u4e2a sidecar \u5bb9\u5668\u6765\u5b8c\u6210\uff0c\u5b8c\u5168\u4e0d\u9700\u8981\u53bb\u5e72\u6d89\u7528\u6237\u5bb9\u5668\uff0c\u8fd9\u4e2a\u7279\u6027\u5728\u73b0\u5728\u975e\u5e38\u706b\u70ed\u7684 Service Mesh\uff08\u670d\u52a1\u7f51\u683c\uff09\u4e2d\u5e94\u7528\u975e\u5e38\u5e7f\u6cdb\uff0c\u5178\u578b\u7684\u5e94\u7528\u5c31\u662f Istio\uff0c\u4e0d\u8fc7\u4e5f\u4e0d\u7528\u7740\u6025\uff0c\u540e\u9762\u4e5f\u4f1a\u548c\u5927\u5bb6\u4e00\u8d77\u63a2\u8ba8\u7684\u3002</p>"},{"location":"kubernetes_basic/pod/#pod_3","title":"\u5982\u4f55\u5212\u5206 Pod","text":"<p>\u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86 Pod \u7684\u5b9e\u73b0\u539f\u7406\uff0c\u4e86\u89e3\u5230\u4e86\u5e94\u8be5\u628a\u5173\u7cfb\u7d27\u5bc6\u7684\u5bb9\u5668\u5212\u5206\u5230\u540c\u4e00\u4e2a Pod \u4e2d\u8fd0\u884c\uff0c\u90a3\u4e48\u600e\u4e48\u6765\u533a\u5206\u5173\u7cfb\u7d27\u5bc6\u5462\uff1f\u4e3e\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\uff0c\u6bd4\u5982\u6211\u4eec\u7684 Wordpress \u5e94\u7528\uff0c\u662f\u4e00\u4e2a\u5178\u578b\u7684\u524d\u7aef\u670d\u52a1\u5668\u548c\u540e\u7aef\u6570\u636e\u670d\u52a1\u7684\u5e94\u7528\uff0c\u90a3\u4e48\u4f60\u8ba4\u4e3a\u5e94\u8be5\u4f7f\u7528\u4e00\u4e2a Pod \u8fd8\u662f\u4e24\u4e2a Pod \u5462\uff1f</p> <p>\u5982\u679c\u5728\u540c\u4e00\u4e2a Pod \u4e2d\u540c\u65f6\u8fd0\u884c\u670d\u52a1\u5668\u7a0b\u5e8f\u548c\u540e\u7aef\u7684\u6570\u636e\u5e93\u670d\u52a1\u8fd9\u4e24\u4e2a\u5bb9\u5668\uff0c\u7406\u8bba\u4e0a\u80af\u5b9a\u662f\u53ef\u884c\u7684\uff0c\u4f46\u662f\u4e0d\u63a8\u8350\u8fd9\u6837\u4f7f\u7528\uff0c\u6211\u4eec\u77e5\u9053\u4e00\u4e2a Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u662f\u540c\u4e00\u4e2a\u6574\u4f53\u8fdb\u884c\u8c03\u5ea6\u7684\uff0c\u4f46\u662f\u5bf9\u4e8e\u6211\u4eec\u8fd9\u4e2a\u5e94\u7528 Wordpress \u548c MySQL \u6570\u636e\u5e93\u4e00\u5b9a\u9700\u8981\u8fd0\u884c\u5728\u4e00\u8d77\u5417\uff1f\u5f53\u7136\u4e0d\u9700\u8981\uff0c\u6211\u4eec\u751a\u81f3\u53ef\u4ee5\u5c06 MySQL \u90e8\u7f72\u5230\u96c6\u7fa4\u4e4b\u5916\u5bf9\u5427\uff1f\u6240\u4ee5 Wordpress \u548c MySQL \u5373\u4f7f\u4e0d\u8fd0\u884c\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u4e5f\u662f\u53ef\u884c\u7684\uff0c\u53ea\u8981\u80fd\u591f\u8bbf\u95ee\u5230\u5373\u53ef\u3002</p> <p></p> <p>\u4f46\u662f\u5982\u679c\u4f60\u975e\u8981\u5f3a\u884c\u90e8\u7f72\u5230\u540c\u4e00\u4e2a Pod \u4e2d\u5462\uff1f\u4ece\u67d0\u4e2a\u89d2\u5ea6\u6765\u8bf4\u662f\u9519\u8bef\u7684\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u7684\u5e94\u7528\u8bbf\u95ee\u91cf\u975e\u5e38\u5927\uff0c\u4e00\u4e2a Pod \u5df2\u7ecf\u6ee1\u8db3\u4e0d\u4e86\u6211\u4eec\u7684\u9700\u6c42\u4e86\uff0c\u600e\u4e48\u529e\u5462\uff1f\u6269\u5bb9\u5bf9\u5427\uff0c\u4f46\u662f\u6269\u5bb9\u7684\u76ee\u6807\u4e5f\u662f Pod\uff0c\u5e76\u4e0d\u662f\u5bb9\u5668\uff0c\u6bd4\u5982\u6211\u4eec\u518d\u6dfb\u52a0\u4e00\u4e2a Pod\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u6709\u4e24\u4e2a Wordpress \u7684\u5e94\u7528\u548c\u4e24\u4e2a MySQL \u6570\u636e\u5e93\u4e86\uff0c\u800c\u4e14\u8fd9\u4e24\u4e2a Pod \u4e4b\u95f4\u7684\u6570\u636e\u662f\u4e92\u76f8\u72ec\u7acb\u7684\uff0c\u56e0\u4e3a MySQL \u6570\u636e\u5e93\u5e76\u4e0d\u662f\u7b80\u5355\u7684\u589e\u52a0\u526f\u672c\u5c31\u53ef\u4ee5\u5171\u4eab\u6570\u636e\u4e86\uff0c\u6240\u4ee5\u8fd9\u4e2a\u65f6\u5019\u5c31\u5f97\u5206\u5f00\u90e8\u7f72\u4e86\uff0c\u91c7\u7528\u7b2c\u4e8c\u79cd\u65b9\u6848\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ea\u9700\u8981\u5355\u72ec\u6269\u5bb9 Wordpress \u7684\u8fd9\u4e2a Pod\uff0c\u540e\u7aef\u7684 MySQL \u6570\u636e\u5e93\u5e76\u4e0d\u4f1a\u53d7\u5230\u6269\u5bb9\u7684\u5f71\u54cd\u3002</p> <p></p> <p>\u5c06\u591a\u4e2a\u5bb9\u5668\u90e8\u7f72\u5230\u540c\u4e00\u4e2a Pod \u4e2d\u7684\u6700\u4e3b\u8981\u53c2\u8003\u5c31\u662f\u5e94\u7528\u53ef\u80fd\u7531\u4e00\u4e2a\u4e3b\u8fdb\u7a0b\u548c\u4e00\u4e2a\u6216\u591a\u4e2a\u7684\u8f85\u52a9\u8fdb\u7a0b\u7ec4\u6210\uff0c\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u7684\u65e5\u5fd7\u6536\u96c6\u7684 Pod\uff0c\u9700\u8981\u5176\u4ed6\u7684 sidecar \u5bb9\u5668\u6765\u652f\u6301\u65e5\u5fd7\u7684\u91c7\u96c6\u3002\u6240\u4ee5\u5f53\u6211\u4eec\u5224\u65ad\u662f\u5426\u9700\u8981\u5728 Pod \u4e2d\u4f7f\u7528\u591a\u4e2a\u5bb9\u5668\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u6309\u7167\u5982\u4e0b\u7684\u51e0\u4e2a\u65b9\u5f0f\u6765\u5224\u65ad\uff1a</p> <ul> <li>\u8fd9\u4e9b\u5bb9\u5668\u662f\u5426\u4e00\u5b9a\u9700\u8981\u4e00\u8d77\u8fd0\u884c\uff0c\u662f\u5426\u53ef\u4ee5\u8fd0\u884c\u5728\u4e0d\u540c\u7684\u8282\u70b9\u4e0a</li> <li>\u8fd9\u4e9b\u5bb9\u5668\u662f\u4e00\u4e2a\u6574\u4f53\u8fd8\u662f\u72ec\u7acb\u7684\u7ec4\u4ef6</li> <li>\u8fd9\u4e9b\u5bb9\u5668\u4e00\u8d77\u8fdb\u884c\u6269\u7f29\u5bb9\u4f1a\u5f71\u54cd\u5e94\u7528\u5417</li> </ul> <p>\u57fa\u672c\u4e0a\u6211\u4eec\u80fd\u591f\u56de\u7b54\u4e0a\u9762\u7684\u51e0\u4e2a\u95ee\u9898\u5c31\u80fd\u591f\u5224\u65ad\u662f\u5426\u9700\u8981\u5728 Pod \u4e2d\u8fd0\u884c\u591a\u4e2a\u5bb9\u5668\u4e86\u3002</p> <p>Pod \u7684\u8bbe\u8ba1</p> <p>\u5176\u5b9e\u5728\u6211\u4eec\u7406\u89e3 Pod \u7684\u65f6\u5019\uff0c\u6709\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u7c7b\u6bd4\u7684\u65b9\u5f0f\u5c31\u662f\u628a Pod \u770b\u6210\u6211\u4eec\u4e4b\u524d\u7684 \u865a\u62df\u673a\uff0c\u800c\u5bb9\u5668\u5c31\u662f\u865a\u62df\u673a\u4e2d\u8fd0\u884c\u7684\u4e00\u4e2a\u7528\u6237\u7a0b\u5e8f\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5f88\u597d\u7684\u6765\u7406\u89e3 Pod \u7684\u8bbe\u8ba1\u3002</p>"},{"location":"kubernetes_basic/pod_deep/","title":"Pod\u4f7f\u7528\u8fdb\u9636","text":""},{"location":"kubernetes_basic/pod_deep/#pod","title":"Pod \u4f7f\u7528\u8fdb\u9636","text":"<p>\u6df1\u5165\u7406\u89e3 Pod \u5bf9\u8c61</p>"},{"location":"kubernetes_basic/pod_deep/#pod_1","title":"\u9759\u6001 Pod","text":"<p>\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u9664\u4e86\u6211\u4eec\u7ecf\u5e38\u4f7f\u7528\u5230\u7684\u666e\u901a\u7684 Pod \u5916\uff0c\u8fd8\u6709\u4e00\u79cd\u7279\u6b8a\u7684 Pod\uff0c\u53eb\u505aStatic Pod\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u8bf4\u7684\u9759\u6001 Pod\uff0c\u9759\u6001 Pod \u6709\u4ec0\u4e48\u7279\u6b8a\u7684\u5730\u65b9\u5462\uff1f</p> <p>\u9759\u6001 Pod \u76f4\u63a5\u7531\u8282\u70b9\u4e0a\u7684 kubelet \u8fdb\u7a0b\u6765\u7ba1\u7406\uff0c\u4e0d\u901a\u8fc7 master \u8282\u70b9\u4e0a\u7684 apiserver\u3002\u65e0\u6cd5\u4e0e\u6211\u4eec\u5e38\u7528\u7684\u63a7\u5236\u5668 Deployment \u6216\u8005 DaemonSet \u8fdb\u884c\u5173\u8054\uff0c\u5b83\u7531 kubelet \u8fdb\u7a0b\u81ea\u5df1\u6765\u76d1\u63a7\uff0c\u5f53 pod \u5d29\u6e83\u65f6\u4f1a\u91cd\u542f\u8be5 pod\uff0ckubelet \u4e5f\u65e0\u6cd5\u5bf9\u4ed6\u4eec\u8fdb\u884c\u5065\u5eb7\u68c0\u67e5\u3002\u9759\u6001 pod \u59cb\u7ec8\u7ed1\u5b9a\u5728\u67d0\u4e00\u4e2a kubelet \u4e0a\uff0c\u5e76\u4e14\u59cb\u7ec8\u8fd0\u884c\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u3002kubelet \u4f1a\u81ea\u52a8\u4e3a\u6bcf\u4e00\u4e2a\u9759\u6001 pod \u5728 Kubernetes \u7684 apiserver \u4e0a\u521b\u5efa\u4e00\u4e2a\u955c\u50cf Pod\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u5728 apiserver \u4e2d\u67e5\u8be2\u5230\u8be5 pod\uff0c\u4f46\u662f\u4e0d\u80fd\u901a\u8fc7 apiserver \u8fdb\u884c\u63a7\u5236\uff08\u4f8b\u5982\u4e0d\u80fd\u5220\u9664\uff09\u3002</p> <p>\u521b\u5efa\u9759\u6001 Pod \u6709\u4e24\u79cd\u65b9\u5f0f\uff1a<code>\u914d\u7f6e\u6587\u4ef6</code>\u548c <code>HTTP</code> \u4e24\u79cd\u65b9\u5f0f</p>"},{"location":"kubernetes_basic/pod_deep/#_1","title":"\u914d\u7f6e\u6587\u4ef6","text":"<p>\u914d\u7f6e\u6587\u4ef6\u5c31\u662f\u653e\u5728\u7279\u5b9a\u76ee\u5f55\u4e0b\u7684\u6807\u51c6\u7684 JSON \u6216 YAML \u683c\u5f0f\u7684 pod \u5b9a\u4e49\u6587\u4ef6\u3002\u7528 </p> <pre><code>kubelet --pod-manifest-path=&lt;the directory&gt;\n</code></pre> <p>\u6765\u542f\u52a8 kubelet \u8fdb\u7a0b\uff0ckubelet \u5b9a\u671f\u7684\u53bb\u626b\u63cf\u8fd9\u4e2a\u76ee\u5f55\uff0c\u6839\u636e\u8fd9\u4e2a\u76ee\u5f55\u4e0b\u51fa\u73b0\u6216\u6d88\u5931\u7684 YAML/JSON \u6587\u4ef6\u6765\u521b\u5efa\u6216\u5220\u9664\u9759\u6001 pod\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u5728 node01 \u8fd9\u4e2a\u8282\u70b9\u4e0a\u7528\u9759\u6001 pod \u7684\u65b9\u5f0f\u6765\u542f\u52a8\u4e00\u4e2a nginx \u7684\u670d\u52a1\u3002\u6211\u4eec\u767b\u5f55\u5230node01\u8282\u70b9\u4e0a\u9762\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u547d\u4ee4\u627e\u5230 kubelet \u5bf9\u5e94\u7684\u542f\u52a8\u914d\u7f6e\u6587\u4ef6</p> <pre><code>$ systemctl status kubelet\n</code></pre> <p>\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\u4e3a\uff1a</p> <pre><code>$ vi /etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n......\nEnvironment=\"KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests --allow-privileged=true\"\n</code></pre> <p>\u6253\u5f00\u8fd9\u4e2a\u6587\u4ef6\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5176\u4e2d\u6709\u4e00\u4e2a\u53c2\u6570<code>--pod-manifest-path</code>\u7684\u914d\u7f6e\uff0c \u6240\u4ee5\u5982\u679c\u6211\u4eec\u901a\u8fc7kubeadm \u7684\u65b9\u5f0f\u6765\u5b89\u88c5\u7684\u96c6\u7fa4\u73af\u5883\uff0c\u5bf9\u5e94\u7684 kubelet \u5df2\u7ecf\u914d\u7f6e\u4e86\u6211\u4eec\u7684\u9759\u6001 Pod \u6587\u4ef6\u7684\u8def\u5f84\uff0c\u9ed8\u8ba4\u5730\u5740\u4e3a </p> <pre><code>/etc/kubernetes/manifests\n</code></pre> <p>\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u4e00\u4e2a\u6807\u51c6\u7684 Pod \u7684 JSON \u6216\u8005 YAML \u6587\u4ef6\u5373\u53ef\uff0c\u5982\u679c\u4f60\u7684 kubelet \u542f\u52a8\u53c2\u6570\u4e2d\u6ca1\u6709\u914d\u7f6e\u4e0a\u9762\u7684<code>--pod-manifest-path</code> \u53c2\u6570\u7684\u8bdd\uff0c\u90a3\u4e48\u6dfb\u52a0\u4e0a\u8fd9\u4e2a\u53c2\u6570\u7136\u540e\u91cd\u542f kubelet \u5373\u53ef\uff1a</p> <pre><code>[root@ node01 ~] $ cat &lt;&lt;EOF &gt;/etc/kubernetes/manifest/static-web.yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: static-web\n  labels:\n    app: static\nspec:\n  containers:\n    - name: web\n      image: nginx\n      ports:\n        - name: web\n          containerPort: 80\nEOF\n</code></pre>"},{"location":"kubernetes_basic/pod_deep/#http_pods","title":"\u901a\u8fc7 HTTP \u521b\u5efa\u9759\u6001 Pods","text":"<p>kubelet \u5468\u671f\u5730\u4ece\u2013manifest-url=\u53c2\u6570\u6307\u5b9a\u7684\u5730\u5740\u4e0b\u8f7d\u6587\u4ef6\uff0c\u5e76\u4e14\u628a\u5b83\u7ffb\u8bd1\u6210 JSON/YAML \u683c\u5f0f\u7684 pod \u5b9a\u4e49\u3002\u6b64\u540e\u7684\u64cd\u4f5c\u65b9\u5f0f\u4e0e\u2013pod-manifest-path=\u76f8\u540c\uff0ckubelet \u4f1a\u4e0d\u65f6\u5730\u91cd\u65b0\u4e0b\u8f7d\u8be5\u6587\u4ef6\uff0c\u5f53\u6587\u4ef6\u53d8\u5316\u65f6\u5bf9\u5e94\u5730\u7ec8\u6b62\u6216\u542f\u52a8\u9759\u6001 pod\u3002</p> <p>kubelet \u542f\u52a8\u65f6\uff0c\u7531<code>--pod-manifest-path=</code> \u6216 <code>--manifest-url=</code>\u53c2\u6570\u6307\u5b9a\u7684\u76ee\u5f55\u4e0b\u5b9a\u4e49\u7684\u6240\u6709 pod \u90fd\u4f1a\u81ea\u52a8\u521b\u5efa\uff0c\u4f8b\u5982\uff0c\u6211\u4eec\u793a\u4f8b\u4e2d\u7684 static-web\u3002\uff08\u53ef\u80fd\u8981\u82b1\u4e9b\u65f6\u95f4\u62c9\u53d6nginx \u955c\u50cf\uff0c\u8010\u5fc3\u7b49\u5f85\u2026\uff09</p> <pre><code>$ docker ps\nCONTAINER ID IMAGE         COMMAND  CREATED        STATUS         PORTS     NAMES\nf6d05272b57e nginx:latest  \"nginx\"  8 minutes ago  Up 8 minutes             k8s_web.6f802af4_static-web-fk-node1_default_67e24ed9466ba55986d120c867395f3c_378e5f3c\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u901a\u8fc7kubectl\u5de5\u5177\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684\u955c\u50cf Pod\uff1a</p> <pre><code>$ kubectl get pods\nNAME                       READY     STATUS    RESTARTS   AGE\nstatic-web-my-node01        1/1       Running   0          2m\n</code></pre> <p>\u9759\u6001 pod \u7684\u6807\u7b7e\u4f1a\u4f20\u9012\u7ed9\u955c\u50cf Pod\uff0c\u53ef\u4ee5\u7528\u6765\u8fc7\u6ee4\u6216\u7b5b\u9009\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6211\u4eec\u4e0d\u80fd\u901a\u8fc7 API \u670d\u52a1\u5668\u6765\u5220\u9664\u9759\u6001 pod\uff08\u4f8b\u5982\uff0c\u901a\u8fc7kubectl\u547d\u4ee4\uff09\uff0ckubelet \u4e0d\u4f1a\u5220\u9664\u5b83\u3002</p> <pre><code>$ kubectl delete pod static-web-my-node01\n$ kubectl get pods\nNAME                       READY     STATUS    RESTARTS   AGE\nstatic-web-my-node01        1/1       Running   0          12s\n</code></pre> <p>\u6211\u4eec\u5c1d\u8bd5\u624b\u52a8\u7ec8\u6b62\u5bb9\u5668\uff0c\u53ef\u4ee5\u770b\u5230kubelet\u5f88\u5feb\u5c31\u4f1a\u81ea\u52a8\u91cd\u542f\u5bb9\u5668\u3002</p> <pre><code>$ docker ps\nCONTAINER ID        IMAGE         COMMAND                CREATED       ...\n5b920cbaf8b1        nginx:latest  \"nginx -g 'daemon of   2 seconds ago ...\n</code></pre>"},{"location":"kubernetes_basic/pod_deep/#pod_2","title":"\u9759\u6001 Pod \u7684\u52a8\u6001\u589e\u52a0\u548c\u5220\u9664","text":"<p>\u8fd0\u884c\u4e2d\u7684 kubelet \u5468\u671f\u626b\u63cf\u914d\u7f6e\u7684\u76ee\u5f55\uff08\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u5c31\u662f /etc/kubernetes/manifests\uff09\u4e0b\u6587\u4ef6\u7684\u53d8\u5316\uff0c\u5f53\u8fd9\u4e2a\u76ee\u5f55\u4e2d\u6709\u6587\u4ef6\u51fa\u73b0\u6216\u6d88\u5931\u65f6\u521b\u5efa\u6216\u5220\u9664 pods\uff1a</p> <pre><code>$ mv /etc/kubernetes/manifests/static-web.yaml /tmp\n$ sleep 20\n$ docker ps\n// no nginx container is running\n$ mv /tmp/static-web.yaml  /etc/kubernetes/manifests\n$ sleep 20\n$ docker ps\nCONTAINER ID        IMAGE         COMMAND                CREATED           ...\ne7a62e3427f1        nginx:latest  \"nginx -g 'daemon of   27 seconds ago\n</code></pre> <p>\u5176\u5b9e\u6211\u4eec\u7528 kubeadm \u5b89\u88c5\u7684\u96c6\u7fa4\uff0cmaster \u8282\u70b9\u4e0a\u9762\u7684\u51e0\u4e2a\u91cd\u8981\u7ec4\u4ef6\u90fd\u662f\u7528\u9759\u6001 Pod \u7684\u65b9\u5f0f\u8fd0\u884c\u7684\uff0c\u6211\u4eec\u767b\u5f55\u5230 master \u8282\u70b9\u4e0a\u67e5\u770b</p> <pre><code>/etc/kubernetes/manifests\n</code></pre> <p>\u76ee\u5f55\uff1a</p> <pre><code>$ ls /etc/kubernetes/manifests/\netcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml\n</code></pre> <p>\u73b0\u5728\u660e\u767d\u4e86\u5427\uff0c\u8fd9\u79cd\u65b9\u5f0f\u4e5f\u4e3a\u6211\u4eec\u5c06\u96c6\u7fa4\u7684\u4e00\u4e9b\u7ec4\u4ef6\u5bb9\u5668\u5316\u63d0\u4f9b\u4e86\u53ef\u80fd\uff0c\u56e0\u4e3a\u8fd9\u4e9b Pod \u90fd\u4e0d\u4f1a\u53d7\u5230 apiserver \u7684\u63a7\u5236\uff0c\u4e0d\u7136\u6211\u4eec\u8fd9\u91cckube-apiserver\u600e\u4e48\u81ea\u5df1\u53bb\u63a7\u5236\u81ea\u5df1\u5462\uff1f\u4e07\u4e00\u4e0d\u5c0f\u5fc3\u628a\u8fd9\u4e2a Pod \u5220\u6389\u4e86\u5462\uff1f\u6240\u4ee5\u53ea\u80fd\u6709kubelet\u81ea\u5df1\u6765\u8fdb\u884c\u63a7\u5236\uff0c\u8fd9\u5c31\u662f\u6211\u4eec\u6240\u8bf4\u7684\u9759\u6001 Pod\u3002</p>"},{"location":"kubernetes_basic/pod_deep/#downward_api","title":"Downward API","text":"<p>\u524d\u9762\u6211\u4eec\u4ece Pod \u7684\u539f\u7406\u5230\u751f\u547d\u5468\u671f\u4ecb\u7ecd\u4e86 Pod \u7684\u4e00\u4e9b\u4f7f\u7528\uff0c\u4f5c\u4e3a Kubernetes \u4e2d\u6700\u6838\u5fc3\u7684\u8d44\u6e90\u5bf9\u8c61\u3001\u6700\u57fa\u672c\u7684\u8c03\u5ea6\u5355\u5143\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 Pod \u4e2d\u7684\u5c5e\u6027\u8fd8\u662f\u975e\u5e38\u7e41\u591a\u7684\uff0c\u524d\u9762\u6211\u4eec\u4f7f\u7528\u8fc7\u4e00\u4e2a <code>volumes</code> \u7684\u5c5e\u6027\uff0c\u8868\u793a\u58f0\u660e\u4e00\u4e2a\u6570\u636e\u5377\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4</p> <pre><code>kubectl explain pod.spec.volumes\n</code></pre> <p>\u53bb\u67e5\u770b\u8be5\u5bf9\u8c61\u4e0b\u9762\u7684\u5c5e\u6027\u975e\u5e38\u591a\uff0c\u524d\u9762\u6211\u4eec\u53ea\u662f\u7b80\u5355\u4f7f\u7528\u4e86 <code>hostPath</code> \u548c <code>emptyDir{}</code> \u8fd9\u4e24\u79cd\u6a21\u5f0f\uff0c\u5176\u4e2d\u8fd8\u6709\u4e00\u79cd\u6a21\u5f0f\u53eb\u505a<code>downwardAPI</code>\uff0c\u8fd9\u4e2a\u6a21\u5f0f\u548c\u5176\u4ed6\u6a21\u5f0f\u4e0d\u4e00\u6837\u7684\u5730\u65b9\u5728\u4e8e\u5b83\u4e0d\u662f\u4e3a\u4e86\u5b58\u653e\u5bb9\u5668\u7684\u6570\u636e\u4e5f\u4e0d\u662f\u7528\u6765\u8fdb\u884c\u5bb9\u5668\u548c\u5bbf\u4e3b\u673a\u7684\u6570\u636e\u4ea4\u6362\u7684\uff0c\u800c\u662f\u8ba9 Pod \u91cc\u7684\u5bb9\u5668\u80fd\u591f\u76f4\u63a5\u83b7\u53d6\u5230\u8fd9\u4e2a Pod \u5bf9\u8c61\u672c\u8eab\u7684\u4e00\u4e9b\u4fe1\u606f\u3002</p> <p>\u76ee\u524d <code>Downward API</code> \u63d0\u4f9b\u4e86\u4e24\u79cd\u65b9\u5f0f\u7528\u4e8e\u5c06 Pod \u7684\u4fe1\u606f\u6ce8\u5165\u5230\u5bb9\u5668\u5185\u90e8\uff1a</p> <ul> <li>\u73af\u5883\u53d8\u91cf\uff1a\u7528\u4e8e\u5355\u4e2a\u53d8\u91cf\uff0c\u53ef\u4ee5\u5c06 Pod \u4fe1\u606f\u548c\u5bb9\u5668\u4fe1\u606f\u76f4\u63a5\u6ce8\u5165\u5bb9\u5668\u5185\u90e8</li> <li>Volume \u6302\u8f7d\uff1a\u5c06 Pod \u4fe1\u606f\u751f\u6210\u4e3a\u6587\u4ef6\uff0c\u76f4\u63a5\u6302\u8f7d\u5230\u5bb9\u5668\u5185\u90e8\u4e2d\u53bb</li> </ul>"},{"location":"kubernetes_basic/pod_deep/#_2","title":"\u73af\u5883\u53d8\u91cf","text":"<p>\u6211\u4eec\u901a\u8fc7 <code>Downward API</code> \u6765\u5c06 Pod \u7684 IP\u3001\u540d\u79f0\u4ee5\u53ca\u6240\u5bf9\u5e94\u7684 namespace \u6ce8\u5165\u5230\u5bb9\u5668\u7684\u73af\u5883\u53d8\u91cf\u4e2d\u53bb\uff0c\u7136\u540e\u5728\u5bb9\u5668\u4e2d\u6253\u5370\u5168\u90e8\u7684\u73af\u5883\u53d8\u91cf\u6765\u8fdb\u884c\u9a8c\u8bc1\uff0c\u5bf9\u5e94\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\uff1a(env-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: env-pod\n  namespace: kube-system\nspec:\n  containers:\n  - name: env-pod\n    image: busybox\n    command: [\"/bin/sh\", \"-c\", \"env\"]\n    env:\n    - name: POD_NAME\n      valueFrom:\n        fieldRef:\n          fieldPath: metadata.name\n    - name: POD_NAMESPACE\n      valueFrom:\n        fieldRef:\n          fieldPath: metadata.namespace\n    - name: POD_IP\n      valueFrom:\n        fieldRef:\n          fieldPath: status.podIP\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u6211\u4eec\u4f7f\u7528\u4e86\u4e00\u79cd\u65b0\u7684\u65b9\u5f0f\u6765\u8bbe\u7f6e env \u7684\u503c\uff1a<code>valueFrom</code>\uff0c\u7531\u4e8e Pod \u7684 name \u548c namespace \u5c5e\u4e8e\u5143\u6570\u636e\uff0c\u662f\u5728 Pod \u521b\u5efa\u4e4b\u524d\u5c31\u5df2\u7ecf\u5b9a\u4e0b\u6765\u4e86\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 metata \u5c31\u53ef\u4ee5\u83b7\u53d6\u5230\u4e86\uff0c\u4f46\u662f\u5bf9\u4e8e Pod \u7684 IP \u5219\u4e0d\u4e00\u6837\uff0c\u56e0\u4e3a\u6211\u4eec\u77e5\u9053 Pod IP \u662f\u4e0d\u56fa\u5b9a\u7684\uff0cPod \u91cd\u5efa\u4e86\u5c31\u53d8\u4e86\uff0c\u5b83\u5c5e\u4e8e\u72b6\u6001\u6570\u636e\uff0c\u6240\u4ee5\u6211\u4eec\u4f7f\u7528 status \u8fd9\u4e2a\u5c5e\u6027\u53bb\u83b7\u53d6\u3002\u53e6\u5916\u9664\u4e86\u4f7f\u7528 <code>fieldRef</code>\u83b7\u53d6 Pod \u7684\u57fa\u672c\u4fe1\u606f\u5916\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7 <code>resourceFieldRef</code> \u53bb\u83b7\u53d6\u5bb9\u5668\u7684\u8d44\u6e90\u8bf7\u6c42\u548c\u8d44\u6e90\u9650\u5236\u4fe1\u606f\u3002</p> <p>\u6211\u4eec\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl create -f env-pod.yaml\npod \"env-pod\" created\n</code></pre> <p>Pod \u521b\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs env-pod -n kube-system |grep POD\nkubectl logs -f env-pod -n kube-system\nPOD_IP=2121\nKUBERNETES_SERVICE_PORT=443\nKUBERNETES_PORT=tcp://1:443\nKUBE_DNS_SERVICE_PORT_DNS_TCP=53\nHOSTNAME=env-pod\nSHLVL=1\nHOME=/root\nKUBE_DNS_SERVICE_HOST=10\nKUBE_DNS_PORT_9153_TCP_ADDR=10\nKUBE_DNS_PORT_9153_TCP_PORT=9153\nKUBE_DNS_PORT_9153_TCP_PROTO=tcp\nKUBE_DNS_SERVICE_PORT=53\nKUBE_DNS_PORT=udp://10:53\nPOD_NAME=env-pod\nKUBERNETES_PORT_443_TCP_ADDR=1\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nKUBE_DNS_PORT_53_TCP_ADDR=10\nKUBERNETES_PORT_443_TCP_PORT=443\nKUBE_DNS_SERVICE_PORT_METRICS=9153\nKUBERNETES_PORT_443_TCP_PROTO=tcp\nKUBE_DNS_PORT_9153_TCP=tcp://10:9153\nKUBE_DNS_PORT_53_UDP_ADDR=10\nKUBE_DNS_PORT_53_TCP_PORT=53\nKUBE_DNS_PORT_53_TCP_PROTO=tcp\nKUBE_DNS_PORT_53_UDP_PORT=53\nKUBE_DNS_SERVICE_PORT_DNS=53\nKUBE_DNS_PORT_53_UDP_PROTO=udp\nKUBERNETES_SERVICE_PORT_HTTPS=443\nKUBERNETES_PORT_443_TCP=tcp://1:443\nPOD_NAMESPACE=kube-system\nKUBERNETES_SERVICE_HOST=1\nPWD=/\nKUBE_DNS_PORT_53_TCP=tcp://10:53\nKUBE_DNS_PORT_53_UDP=udp://10:53\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pod \u7684 IP\u3001NAME\u3001NAMESPACE \u90fd\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u6253\u5370\u51fa\u6765\u4e86\u3002</p> <p>\u73af\u5883\u53d8\u91cf</p> <p>\u4e0a\u9762\u6253\u5370 Pod \u7684\u73af\u5883\u53d8\u91cf\u53ef\u4ee5\u770b\u5230\u6709\u5f88\u591a\u5185\u7f6e\u7684\u53d8\u91cf\uff0c\u5176\u4e2d\u5927\u90e8\u5206\u662f\u7cfb\u7edf\u81ea\u52a8\u4e3a\u6211\u4eec\u6dfb\u52a0\u7684\uff0cKubernetes \u4f1a\u628a\u5f53\u524d\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684 Service \u4fe1\u606f\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u7684\u5f62\u5f0f\u6ce8\u5165\u5230 Pod \u4e2d\u53bb\uff1a</p> <pre><code>$ kubectl get svc -n kube-system\nNAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE\nkube-dns   ClusterIP   10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   4d21h\n</code></pre>"},{"location":"kubernetes_basic/pod_deep/#volume","title":"Volume \u6302\u8f7d","text":"<p><code>Downward API</code>\u9664\u4e86\u63d0\u4f9b\u73af\u5883\u53d8\u91cf\u7684\u65b9\u5f0f\u5916\uff0c\u8fd8\u63d0\u4f9b\u4e86\u901a\u8fc7 Volume \u6302\u8f7d\u7684\u65b9\u5f0f\u53bb\u83b7\u53d6 Pod \u7684\u57fa\u672c\u4fe1\u606f\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u901a\u8fc7<code>Downward API</code>\u5c06 Pod \u7684 Label\u3001Annotation \u7b49\u4fe1\u606f\u901a\u8fc7 Volume \u6302\u8f7d\u5230\u5bb9\u5668\u7684\u67d0\u4e2a\u6587\u4ef6\u4e2d\u53bb\uff0c\u7136\u540e\u5728\u5bb9\u5668\u4e2d\u6253\u5370\u51fa\u8be5\u6587\u4ef6\u7684\u503c\u6765\u9a8c\u8bc1\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a(volume-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: volume-pod\n  namespace: kube-system\n  labels:\n    k8s-app: test-volume\n    node-env: test\n  annotations:\n    own: youdianzhishi\n    build: test\nspec:\n  volumes:\n  - name: podinfo\n    downwardAPI:\n      items:\n      - path: labels\n        fieldRef:\n          fieldPath: metadata.labels\n      - path: annotations\n        fieldRef:\n          fieldPath: metadata.annotations\n  containers:\n  - name: volume-pod\n    image: busybox\n    args: \n    - sleep \n    - \"3600\"\n    volumeMounts:\n    - name: podinfo\n      mountPath: /etc/podinfo\n</code></pre> <p>\u6211\u4eec\u5c06\u5143\u6570\u636e labels \u548c annotaions \u4ee5\u6587\u4ef6\u7684\u5f62\u5f0f\u6302\u8f7d\u5230\u4e86 <code>/etc/podinfo</code> \u76ee\u5f55\u4e0b\uff0c\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl create -f volume-pod.yaml\npod \"volume-pod\" created\n</code></pre> <p>\u521b\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u8fdb\u5165\u5230\u5bb9\u5668\u4e2d\u67e5\u770b\u5143\u4fe1\u606f\u662f\u4e0d\u662f\u5df2\u7ecf\u5b58\u5165\u5230\u6587\u4ef6\u4e2d\u4e86\uff1a</p> <pre><code>$ kubectl exec -it volume-pod /bin/sh -n kube-system\n/ # ls /etc/podinfo/\n..2019_11_13_09_57_990445016/  annotations\n..data/                           labels\n/ # cat /etc/podinfo/labels\nk8s-app=\"test-volume\"\n/ # cat /etc/podinfo/annotations\nbuild=\"test\"\nkubectl.kubernetes.io/last-applied-configuration=\"{\\\\\"apiVersion\\\\\":\\\\\"v1\\\\\",\\\\\"kind\\\\\":\\\\\"Pod\\\\\",\\\\\"metadata\\\\\":{\\\\\"annotations\\\\\":{\\\\\"build\\\\\":\\\\\"test\\\\\",\\\\\"own\\\\\":\\\\\"youdianzhishi\\\\\"},\\\\\"labels\\\\\":{\\\\\"k8s-app\\\\\":\\\\\"test-volume\\\\\",\\\\\"node-env\\\\\":\\\\\"test\\\\\"},\\\\\"name\\\\\":\\\\\"volume-pod\\\\\",\\\\\"namespace\\\\\":\\\\\"kube-system\\\\\"},\\\\\"spec\\\\\":{\\\\\"containers\\\\\":[{\\\\\"args\\\\\":[\\\\\"sleep\\\\\",\\\\\"3600\\\\\"],\\\\\"image\\\\\":\\\\\"busybox\\\\\",\\\\\"name\\\\\":\\\\\"volume-pod\\\\\",\\\\\"volumeMounts\\\\\":[{\\\\\"mountPath\\\\\":\\\\\"/etc/podinfo\\\\\",\\\\\"name\\\\\":\\\\\"podinfo\\\\\"}]}],\\\\\"volumes\\\\\":[{\\\\\"downwardAPI\\\\\":{\\\\\"items\\\\\":[{\\\\\"fieldRef\\\\\":{\\\\\"fieldPath\\\\\":\\\\\"metadata.labels\\\\\"},\\\\\"path\\\\\":\\\\\"labels\\\\\"},{\\\\\"fieldRef\\\\\":{\\\\\"fieldPath\\\\\":\\\\\"metadata.annotations\\\\\"},\\\\\"path\\\\\":\\\\\"annotations\\\\\"}]},\\\\\"name\\\\\":\\\\\"podinfo\\\\\"}]}}\\\\n\"\nkubernetes.io/config.seen=\"2019-11-13T17:57:320894744+08:00\"\nkubernetes.io/config.source=\"api\"\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pod \u7684 Labels \u548c Annotations \u4fe1\u606f\u90fd\u88ab\u6302\u8f7d\u5230 <code>/etc/podinfo</code> \u76ee\u5f55\u4e0b\u9762\u7684 lables \u548c annotations \u6587\u4ef6\u4e86\u3002</p> <p>\u76ee\u524d\uff0c<code>Downward API</code> \u652f\u6301\u7684\u5b57\u6bb5\u5df2\u7ecf\u975e\u5e38\u4e30\u5bcc\u4e86\uff0c\u6bd4\u5982\uff1a</p> <pre><code>\u4f7f\u7528 fieldRef \u53ef\u4ee5\u58f0\u660e\u4f7f\u7528:\n\nspec.nodeName - \u5bbf\u4e3b\u673a\u540d\u5b57\nstatus.hostIP - \u5bbf\u4e3b\u673aIP\nmetadata.name - Pod\u7684\u540d\u5b57\nmetadata.namespace - Pod\u7684Namespace\nstatus.podIP - Pod\u7684IP\nspec.serviceAccountName - Pod\u7684Service Account\u7684\u540d\u5b57\nmetadata.uid - Pod\u7684UID\nmetadata.labels['&lt;KEY&gt;'] - \u6307\u5b9a&lt;KEY&gt;\u7684Label\u503c\nmetadata.annotations['&lt;KEY&gt;'] - \u6307\u5b9a&lt;KEY&gt;\u7684Annotation\u503c\nmetadata.labels - Pod\u7684\u6240\u6709Label\nmetadata.annotations - Pod\u7684\u6240\u6709Annotation\n\n \u4f7f\u7528 resourceFieldRef \u53ef\u4ee5\u58f0\u660e\u4f7f\u7528:\n\n\u5bb9\u5668\u7684 CPU limit\n\u5bb9\u5668\u7684 CPU request\n\u5bb9\u5668\u7684 memory limit\n\u5bb9\u5668\u7684 memory request\n</code></pre> <p>\u6ce8\u610f</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c<code>Downward API</code> \u80fd\u591f\u83b7\u53d6\u5230\u7684\u4fe1\u606f\uff0c\u4e00\u5b9a\u662f Pod \u91cc\u7684\u5bb9\u5668\u8fdb\u7a0b\u542f\u52a8\u4e4b\u524d\u5c31\u80fd\u591f\u786e\u5b9a\u4e0b\u6765\u7684\u4fe1\u606f\u3002\u800c\u5982\u679c\u4f60\u60f3\u8981\u83b7\u53d6 Pod \u5bb9\u5668\u8fd0\u884c\u540e\u624d\u4f1a\u51fa\u73b0\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\uff0c\u5bb9\u5668\u8fdb\u7a0b\u7684 PID\uff0c\u90a3\u5c31\u80af\u5b9a\u4e0d\u80fd\u4f7f\u7528 <code>Downward API</code> \u4e86\uff0c\u800c\u5e94\u8be5\u8003\u8651\u5728 Pod \u91cc\u5b9a\u4e49\u4e00\u4e2a sidecar \u5bb9\u5668\u6765\u83b7\u53d6\u4e86\u3002</p> <p>\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u5982\u679c\u4f60\u7684\u5e94\u7528\u6709\u83b7\u53d6 Pod \u7684\u57fa\u672c\u4fe1\u606f\u7684\u9700\u6c42\uff0c\u4e00\u822c\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528<code>Downward API</code>\u6765\u83b7\u53d6\u57fa\u672c\u4fe1\u606f\uff0c\u7136\u540e\u7f16\u5199\u4e00\u4e2a\u542f\u52a8\u811a\u672c\u6216\u8005\u5229\u7528<code>initContainer</code>\u5c06 Pod \u7684\u4fe1\u606f\u6ce8\u5165\u5230\u6211\u4eec\u5bb9\u5668\u4e2d\u53bb\uff0c\u7136\u540e\u5728\u6211\u4eec\u81ea\u5df1\u7684\u5e94\u7528\u4e2d\u5c31\u53ef\u4ee5\u6b63\u5e38\u7684\u5904\u7406\u76f8\u5173\u903b\u8f91\u4e86\u3002</p> <p>\u9664\u4e86\u901a\u8fc7 Downward API \u53ef\u4ee5\u83b7\u53d6\u5230 Pod \u672c\u8eab\u7684\u4fe1\u606f\u4e4b\u5916\uff0c\u5176\u5b9e\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u6620\u5c04\u5176\u4ed6\u8d44\u6e90\u5bf9\u8c61\u6765\u83b7\u53d6\u5bf9\u5e94\u7684\u4fe1\u606f\uff0c\u6bd4\u5982 Secret\u3001ConfigMap \u8d44\u6e90\u5bf9\u8c61\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u548c\u6302\u8f7d Volume \u7684\u65b9\u5f0f\u6765\u83b7\u53d6\u4ed6\u4eec\u7684\u4fe1\u606f\uff0c\u4f46\u662f\uff0c\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u83b7\u53d6\u8fd9\u4e9b\u4fe1\u606f\u7684\u65b9\u5f0f\uff0c\u4e0d\u5177\u5907\u81ea\u52a8\u66f4\u65b0\u7684\u80fd\u529b\u3002\u6240\u4ee5\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u90fd\u5efa\u8bae\u4f7f\u7528 Volume \u6587\u4ef6\u7684\u65b9\u5f0f\u83b7\u53d6\u8fd9\u4e9b\u4fe1\u606f\uff0c\u56e0\u4e3a\u901a\u8fc7 Volume \u7684\u65b9\u5f0f\u6302\u8f7d\u7684\u6587\u4ef6\u5728 Pod \u4e2d\u4f1a\u8fdb\u884c\u70ed\u66f4\u65b0\u3002</p>"},{"location":"kubernetes_basic/pod_deep/#podpreset","title":"PodPreset","text":"<p>\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u4e86\u5f88\u591a Pod \u7684\u77e5\u8bc6\u70b9\uff0c\u4f46\u662f\u53ef\u80fd\u6709\u90e8\u5206\u540c\u5b66\u8fd8\u662f\u89c9\u5f97 Pod \u7684\u5b57\u6bb5\u5c5e\u6027\u592a\u591a\u4e86\uff0c\u5f88\u591a\u8bb0\u4e0d\u4f4f\uff0c\u67e5\u8be2\u6587\u6863\u6548\u7387\u4e0d\u9ad8\uff0c\u4f60\u662f\u4e0d\u662f\u5e0c\u671b Kubernetes \u80fd\u591f\u63d0\u4f9b\u4e00\u4e2a\u529f\u80fd\u4e3a Pod \u81ea\u52a8\u586b\u5145\u4e00\u4e9b\u5b57\u6bb5\u5462\uff1f\u8fd9\u4e2a\u9700\u6c42\u8fd8\u662f\u5f88\u5b9e\u9645\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u6309\u7167\u547d\u540d\u7a7a\u95f4\u6765\u5212\u5206\u4e0d\u540c\u7684\u73af\u5883\uff0c\u7136\u540e\u6211\u4eec\u5728\u4e0d\u540c\u7684\u73af\u5883\u4e0a\u90e8\u7f72 Pod \u540e\u81ea\u52a8\u4e3a\u6211\u4eec\u52a0\u4e0a\u73af\u5883\u76f8\u5173\u7684 Labels\u3001Annotations \u7b49\u7b49\u4fe1\u606f\uff0c\u8fd9\u6837\u5c31\u5927\u5927\u63d0\u9ad8\u4e86\u7f16\u5199 YAML \u7684\u6548\u7387\uff0c\u4e3a\u6b64\uff0c\u5728 Kubernetes v1.11 \u7248\u672c\u540e\u5c31\u63d0\u4f9b\u4e86\u4e00\u4e2a\u53eb\u505a <code>PodPreset\uff08Pod \u9884\u8bbe\u503c\uff09</code>\u7684\u529f\u80fd\u53ef\u4ee5\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>Kubernetes \u63d0\u4f9b\u4e86\u4e00\u4e2a <code>PodPreset</code> \u51c6\u5165\u63a7\u5236\u5668\uff0c\u5f53\u542f\u7528\u540e\uff0cPodPreset \u4f1a\u5c06\u5e94\u7528\u521b\u5efa\u8bf7\u6c42\u4f20\u5165\u5230\u8be5\u63a7\u5236\u5668\u4e0a\u3002\u5f53\u6709 Pod \u521b\u5efa\u8bf7\u6c42\u53d1\u751f\u65f6\uff0c\u7cfb\u7edf\u5c06\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p> <ul> <li>\u68c0\u7d22\u6240\u6709\u53ef\u7528\u7684 PodPreset</li> <li>\u68c0\u67e5\u6709 PodPreset \u7684\u6807\u7b7e\u9009\u62e9\u5668\u4e0a\u7684\u6807\u7b7e\u4e0e\u6b63\u5728\u521b\u5efa\u7684 Pod \u4e0a\u7684\u6807\u7b7e\u662f\u5426\u5339\u914d</li> <li>\u5c1d\u8bd5\u5c06\u7531 PodPreset \u5b9a\u4e49\u7684\u5404\u79cd\u8d44\u6e90\u5408\u5e76\u5230\u6b63\u5728\u521b\u5efa\u7684 Pod \u4e2d</li> <li>\u51fa\u73b0\u9519\u8bef\u65f6\uff0c\u5728\u8be5 Pod \u4e0a\u5f15\u53d1\u8bb0\u5f55\u5408\u5e76\u9519\u8bef\u7684\u4e8b\u4ef6\uff0cPodPreset \u4e0d\u4f1a\u6ce8\u5165\u4efb\u4f55\u8d44\u6e90\u5230\u521b\u5efa\u7684 Pod \u4e2d</li> <li> <p>\u6ce8\u91ca\u521a\u751f\u6210\u7684\u4fee\u6539\u8fc7\u7684 Pod spec\uff0c\u4ee5\u8868\u660e\u5b83\u5df2\u88ab PodPreset \u4fee\u6539\u8fc7\u3002\u6ce8\u91ca\u7684\u683c\u5f0f\u4e3a </p> <pre><code>podpreset.admission.kubernetes.io/podpreset-&lt;pod-preset name&gt;\": \"&lt;resource version&gt;\"\n</code></pre> </li> </ul> <p>\u6bcf\u4e2a Pod \u53ef\u4ee5\u5339\u914d\u96f6\u4e2a\u6216\u591a\u4e2a PodPrestet\uff1b\u5e76\u4e14\u6bcf\u4e2a PodPreset \u53ef\u4ee5\u5e94\u7528\u4e8e\u96f6\u4e2a\u6216\u591a\u4e2a Pod\u3002 PodPreset \u5e94\u7528\u4e8e\u4e00\u4e2a\u6216\u591a\u4e2a Pod \u65f6\uff0cKubernetes \u4f1a\u4fee\u6539 Pod Spec\u3002\u5bf9\u4e8e Env\u3001EnvFrom \u548c VolumeMounts \u7684\u66f4\u6539\uff0cKubernetes \u4fee\u6539 Pod \u4e2d\u6240\u6709\u5bb9\u5668\u7684\u5bb9\u5668 spec\uff1b\u5bf9\u4e8e Volume \u7684\u66f4\u6539\uff0cKubernetes \u4fee\u6539 Pod Spec\u3002</p> <p>\u53ef\u80fd\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u60a8\u5e0c\u671b\u4f60\u7684 Pod \u4e0d\u4f1a\u88ab\u4efb\u4f55 Pod Preset \u6240\u6539\u53d8\u3002\u5728\u8fd9\u4e9b\u60c5\u51b5\u4e0b\uff0c\u60a8\u53ef\u4ee5\u5728 Pod \u7684 Pod Spec \u4e2d\u6dfb\u52a0\u4e0a\u8fd9\u6837\u4e00\u4e2a annotation\uff1a</p> <pre><code>podpreset.admission.kubernetes.io/exclude\uff1a\"true\"\n</code></pre> <p>\u3002</p>"},{"location":"kubernetes_basic/pod_deep/#podpreset_1","title":"\u542f\u7528 PodPreset","text":"<p>\u8981\u542f\u7528<code>PodPreset</code>\u529f\u80fd\uff0c\u9700\u8981\u786e\u4fdd\u4f60\u4f7f\u7528\u7684\u662f kubernetes 1.8\u7248\u672c\u4ee5\u4e0a\uff0c\u7136\u540e\u9700\u8981\u5728\u51c6\u5165\u63a7\u5236\u4e2d\u52a0\u5165<code>PodPreset</code>\uff0c\u53e6\u5916\u4e3a\u4e86\u5b9a\u4e49 PodPreset \u5bf9\u8c61\uff0c\u8fd8\u9700\u8981\u5176\u4e2d PodPreset \u7684 API \u7248\u672c\uff0c\u5728 APIServer \u542f\u52a8\u53c2\u6570\u4e2d\u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>- --enable-admission-plugins=NodeRestriction,PodPreset\n- --runtime-config=settings.k8s.io/v1alpha1=true\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u662f\u4f7f\u7528\u7684 kubeadm \u642d\u5efa\u7684\u96c6\u7fa4\uff0c\u6240\u4ee5\u53ea\u9700\u8981\u4fee\u6539\u9759\u6001 Pod \u914d\u7f6e\u5373\u53ef\uff0c\u8def\u5f84 </p> <pre><code>/etc/kubernetes/manifests/kube-apiserver.yaml\n</code></pre> <p>\uff0c\u4fee\u6539\u5b8c\u6210\u540e\uff0c\u5c06 <code>kube-apiserver.yaml</code> \u6587\u4ef6\u79fb\u9664 manifests \u76ee\u5f55\uff0c\u7136\u540e\u79fb\u52a8\u56de\u6765\uff0c\u76f8\u5f53\u4e8e\u5f3a\u5236\u91cd\u542f\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl api-versions |grep settings\nsettings.k8s.io/v1alpha1\n$ kubectl get podpreset\nNo resources found in default namespace.\n</code></pre> <p>\u51fa\u73b0\u5982\u4e0a\u7684\u63d0\u793a\u8bc1\u660e\u5df2\u7ecf\u5f00\u542f\u6210\u529f\u3002</p>"},{"location":"kubernetes_basic/pod_deep/#_3","title":"\u793a\u4f8b","text":"<p>\u6211\u4eec\u7ecf\u5e38\u6709\u4e00\u4e2a\u9700\u6c42\u5c31\u662f\u9700\u8981\u540c\u6b65 Pod \u548c\u5bbf\u4e3b\u673a\u7684\u65f6\u95f4\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u662f\u901a\u8fc7\u6302\u8f7d\u5bbf\u4e3b\u673a\u7684 localtime \u6765\u5b8c\u6210\u7684\uff0c\u5982\u4e0b Pod\uff1a\uff08time-demo.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Pod\nmetadata:\n  name: time-demo\n  labels:\n    app: time\nspec:\n  containers:\n  - name: time-demo\n    image: nginx\n    ports:\n    - containerPort: 80\n</code></pre> <p>\u6211\u4eec\u76f4\u63a5\u521b\u5efa\u8be5 Pod\uff1a</p> <pre><code>$ kubectl apply -f time-demo.yaml\n$ kubectl get pods\nNAME         READY   STATUS    RESTARTS   AGE\ntime-demo    1/1     Running   0          2m8s\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u6bd4\u4e0b\u8282\u70b9\u7684\u65f6\u95f4\u548c Pod \u7684\u65f6\u95f4\uff1a</p> <pre><code>$ date\nThu Nov 14 12:08:27 CST 2019\n$ kubectl exec time-demo date\nThu Nov 14 04:08:41 UTC 2019\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pod \u7684\u65f6\u95f4\u662f UTC \u65f6\u95f4\uff0c\u548c\u8282\u70b9\u4e0d\u540c\u6b65\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u6302\u8f7d\u5bbf\u4e3b\u673a\u7684 localtime \u6587\u4ef6\u5230 Pod \u4e2d\u53bb\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Pod\nmetadata:\n  name: time-demo\n  labels:\n    app: time\nspec:\n  volumes:\n  - name: host-time\n    hostPath:\n      path: /etc/localtime\n  containers:\n  - name: time-demo\n    image: nginx\n    volumeMounts:\n    - name: host-time\n      mountPath: /etc/localtime\n    ports:\n    - containerPort: 80\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u91cd\u65b0\u6765\u6d4b\u8bd5\u4e0b\uff1a</p> <pre><code>$ kubectl delete -f time-demo.yaml\n$ kubectl apply -f time-demo.yaml\n$ kubectl get pods\nNAME         READY   STATUS    RESTARTS   AGE\ntime-demo    1/1     Running   0          2m8s\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u6765\u770b\u4e0b\u65f6\u95f4\u662f\u5426\u540c\u6b65\u4e86\uff1a</p> <pre><code>$ date\nThu Nov 14 12:13:40 CST 2019\n$ kubectl exec time-demo date\nThu Nov 14 12:13:45 CST 2019\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u751f\u6548\u4e86\u3002\u4f46\u662f\u5f80\u5f80\u6211\u4eec\u6240\u6709\u7684 Pod \u90fd\u6709\u65f6\u95f4\u540c\u6b65\u7684\u9700\u6c42\uff0c\u5982\u679c\u6240\u6709\u7684 Pod \u90fd\u6765\u624b\u52a8\u8fdb\u884c\u6302\u8f7d\uff0c\u662f\u4e0d\u662f\u663e\u5f97\u7e41\u7410\u591a\u4f59\u554a\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528 PodPreset \u6765\u9884\u8bbe\u6a21\u677f\uff0c\u5b9a\u4e49\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 PodPreset \u8d44\u6e90\u5bf9\u8c61\uff1a\uff08time-preset.yaml\uff09</p> <pre><code>apiVersion: settings.k8s.io/v1alpha1\nkind: PodPreset\nmetadata:\n  name: time-preset\n  namespace: default\nspec:\n  selector:\n    matchLabels:\n  volumeMounts:\n  - name: localtime\n    mountPath: /etc/localtime\n  volumes:\n  - name: localtime\n    hostPath:\n      path: /etc/localtime\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f time-preset.yaml\npodpreset.settings.k8s.io/time-preset created\n$ kubectl get podpreset\nNAME          CREATED AT\ntime-preset   2019-11-14T06:52:11Z\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u6765\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a(time-demo.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Pod\nmetadata:\n  name: time-demo\n  labels:\n    app: time\nspec:\n  containers:\n  - name: time-demo\n    image: nginx\n    ports:\n    - containerPort: 80\n</code></pre> <p>\u8fd9\u4e2a Pod \u6211\u4eec\u6ca1\u6709\u4e3b\u52a8\u6302\u8f7d\u65f6\u95f4\u6587\u4ef6\uff0c\u76f4\u63a5\u521b\u5efa\uff1a</p> <pre><code>$ kubectl delete -f time-demo.yaml\n$ kubectl apply -f time-demo.yaml\n$  kubectl get pods -l app=time\nNAME        READY   STATUS    RESTARTS   AGE\ntime-demo   1/1     Running   0          60s\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u9a8c\u8bc1\u4e0b Pod \u65f6\u95f4\u662f\u5426\u548c\u5bbf\u4e3b\u673a\u4e00\u81f4\uff1a</p> <pre><code>$ date\nThu Nov 14 14:55:02 CST 2019\n$ kubectl exec time-demo date\nThu Nov 14 14:55:21 CST 2019\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u540c\u6b65\u4e86~\uff0c\u53ef\u4ee5\u76f4\u63a5\u5bfc\u51fa Pod \u7684\u8d44\u6e90\u6e05\u5355\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get pod time-demo -o yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  annotations:\n    kubectl.kubernetes.io/last-applied-configuration: |\n      {\"apiVersion\":\"v1\",\"kind\":\"Pod\",\"metadata\":{\"annotations\":{},\"labels\":{\"app\":\"time\"},\"name\":\"time-demo\",\"namespace\":\"default\"},\"spec\":{\"containers\":[{\"image\":\"nginx\",\"name\":\"time-demo\",\"ports\":[{\"containerPort\":80}]}]}}\n    podpreset.admission.kubernetes.io/podpreset-time-preset: \"1469811\"\n  creationTimestamp: \"2019-11-14T06:54:06Z\"\n  labels:\n    app: time\n  name: time-demo\n  namespace: default\n  resourceVersion: \"1470398\"\n  selfLink: /api/v1/namespaces/default/pods/time-demo\n  uid: 37a7ab94-c2c3-4b10-88df-0c486fb8d422\nspec:\n  containers:\n  - image: nginx\n    imagePullPolicy: Always\n    name: time-demo\n    ports:\n    - containerPort: 80\n      protocol: TCP\n    resources: {}\n    terminationMessagePath: /dev/termination-log\n    terminationMessagePolicy: File\n    volumeMounts:\n    - mountPath: /etc/localtime\n      name: localtime\n    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount\n      name: default-token-5tsh4\n      readOnly: true\n  dnsPolicy: ClusterFirst\n  enableServiceLinks: true\n  nodeName: ydzs-node3\n  priority: 0\n  restartPolicy: Always\n  schedulerName: default-scheduler\n  securityContext: {}\n  serviceAccount: default\n  serviceAccountName: default\n  terminationGracePeriodSeconds: 30\n  tolerations:\n  - effect: NoExecute\n    key: node.kubernetes.io/not-ready\n    operator: Exists\n    tolerationSeconds: 300\n  - effect: NoExecute\n    key: node.kubernetes.io/unreachable\n    operator: Exists\n    tolerationSeconds: 300\n  volumes:\n  - hostPath:\n      path: /etc/localtime\n      type: \"\"\n    name: localtime\n  - name: default-token-5tsh4\n    secret:\n      defaultMode: 420\n      secretName: default-token-5tsh4\nstatus:\n  conditions:\n  - lastProbeTime: null\n    lastTransitionTime: \"2019-11-14T06:54:06Z\"\n    status: \"True\"\n    type: Initialized\n  - lastProbeTime: null\n    lastTransitionTime: \"2019-11-14T06:54:22Z\"\n    status: \"True\"\n    type: Ready\n  - lastProbeTime: null\n    lastTransitionTime: \"2019-11-14T06:54:22Z\"\n    status: \"True\"\n    type: ContainersReady\n  - lastProbeTime: null\n    lastTransitionTime: \"2019-11-14T06:54:06Z\"\n    status: \"True\"\n    type: PodScheduled\n  containerStatuses:\n  - containerID: docker://a774e82d4ebfde98c37b675f1a46377ccf01c0bba931507172309616dbf49165\n    image: nginx:latest\n    imageID: docker-pullable://nginx@sha256:922c815aa4df050d4df476e92daed4231f466acc8ee90e0e774951b0fd7195a4\n    lastState: {}\n    name: time-demo\n    ready: true\n    restartCount: 0\n    started: true\n    state:\n      running:\n        startedAt: \"2019-11-14T06:54:21Z\"\n  hostIP: 157\n  phase: Running\n  podIP: 264\n  podIPs:\n  - ip: 264\n  qosClass: BestEffort\n  startTime: \"2019-11-14T06:54:06Z\"\n</code></pre> <p>\u4ece\u4e0a\u9762 YAML \u4e2d\u4e5f\u53ef\u4ee5\u770b\u51fa Pod \u88ab\u81ea\u52a8\u6ce8\u5165\u4e86 PodPreset \u58f0\u660e\u7684\u6a21\u677f\uff0c\u800c\u4e14\u8be5\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u6240\u6709 Pod \u9ed8\u8ba4\u90fd\u4f1a\u88ab\u6ce8\u5165\u8be5\u6a21\u677f\u3002</p> <p>\u6ce8\u610f</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f PodPreset \u8d44\u6e90\u5bf9\u8c61\u662f namespace scope \u7684\uff0c\u5c31\u662f\u4e0d\u540c\u7684\u547d\u540d\u7a7a\u95f4\u9700\u8981\u521b\u5efa\u4e0d\u540c\u7684 PodPreset\u3002</p>"},{"location":"kubernetes_basic/pod_life/","title":"Pod\u7684\u751f\u547d\u5468\u671f","text":""},{"location":"kubernetes_basic/pod_life/#pod","title":"Pod \u7684\u751f\u547d\u5468\u671f","text":"<p>\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u4e86 Pod \u7684\u8bbe\u8ba1\u539f\u7406\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4e86\u89e3\u4e0b Pod \u7684\u751f\u547d\u5468\u671f\u3002\u4e0b\u56fe\u5c55\u793a\u4e86\u4e00\u4e2a Pod \u7684\u5b8c\u6574\u751f\u547d\u5468\u671f\u8fc7\u7a0b\uff0c\u5176\u4e2d\u5305\u542b <code>Init Container</code>\u3001<code>Pod Hook</code>\u3001<code>\u5065\u5eb7\u68c0\u67e5</code> \u4e09\u4e2a\u4e3b\u8981\u90e8\u5206\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5206\u522b\u4ecb\u7ecd\u5f71\u54cd Pod \u751f\u547d\u5468\u671f\u7684\u90e8\u5206\uff1a</p> <p>\u9996\u5148\u5728\u4ecb\u7ecd Pod \u7684\u751f\u547d\u5468\u671f\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u4e86\u89e3\u4e0b Pod \u7684\u72b6\u6001\uff0c\u56e0\u4e3a Pod \u72b6\u6001\u53ef\u4ee5\u53cd\u5e94\u51fa\u5f53\u524d\u6211\u4eec\u7684 Pod \u7684\u5177\u4f53\u72b6\u6001\u4fe1\u606f\uff0c\u4e5f\u662f\u6211\u4eec\u5206\u6790\u6392\u9519\u7684\u4e00\u4e2a\u5fc5\u5907\u7684\u65b9\u5f0f\u3002</p>"},{"location":"kubernetes_basic/pod_life/#pod_1","title":"Pod \u72b6\u6001","text":"<p>\u9996\u5148\u5148\u4e86\u89e3\u4e0b Pod \u7684\u72b6\u6001\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>kubectl explain pod.status\n</code></pre> <p>\u547d\u4ee4\u6765\u4e86\u89e3\u5173\u4e8e Pod \u72b6\u6001\u7684\u4e00\u4e9b\u4fe1\u606f\uff0cPod \u7684\u72b6\u6001\u5b9a\u4e49\u5728 <code>PodStatus</code> \u5bf9\u8c61\u4e2d\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a <code>phase</code> \u5b57\u6bb5\uff0c\u4e0b\u9762\u662f <code>phase</code> \u7684\u53ef\u80fd\u53d6\u503c\uff1a</p> <ul> <li>\u6302\u8d77\uff08Pending\uff09\uff1aPod \u4fe1\u606f\u5df2\u7ecf\u63d0\u4ea4\u7ed9\u4e86\u96c6\u7fa4\uff0c\u4f46\u662f\u8fd8\u6ca1\u6709\u88ab\u8c03\u5ea6\u5668\u8c03\u5ea6\u5230\u5408\u9002\u7684\u8282\u70b9\u6216\u8005 Pod \u91cc\u7684\u955c\u50cf\u6b63\u5728\u4e0b\u8f7d</li> <li>\u8fd0\u884c\u4e2d\uff08Running\uff09\uff1a\u8be5 Pod \u5df2\u7ecf\u7ed1\u5b9a\u5230\u4e86\u4e00\u4e2a\u8282\u70b9\u4e0a\uff0cPod \u4e2d\u6240\u6709\u7684\u5bb9\u5668\u90fd\u5df2\u88ab\u521b\u5efa\u3002\u81f3\u5c11\u6709\u4e00\u4e2a\u5bb9\u5668\u6b63\u5728\u8fd0\u884c\uff0c\u6216\u8005\u6b63\u5904\u4e8e\u542f\u52a8\u6216\u91cd\u542f\u72b6\u6001</li> <li>\u6210\u529f\uff08Succeeded\uff09\uff1aPod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u88ab\u6210\u529f\u7ec8\u6b62\uff0c\u5e76\u4e14\u4e0d\u4f1a\u518d\u91cd\u542f</li> <li>\u5931\u8d25\uff08Failed\uff09\uff1aPod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u5df2\u7ec8\u6b62\u4e86\uff0c\u5e76\u4e14\u81f3\u5c11\u6709\u4e00\u4e2a\u5bb9\u5668\u662f\u56e0\u4e3a\u5931\u8d25\u7ec8\u6b62\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5bb9\u5668\u4ee5\u975e<code>0</code>\u72b6\u6001\u9000\u51fa\u6216\u8005\u88ab\u7cfb\u7edf\u7ec8\u6b62</li> <li>\u672a\u77e5\uff08Unknown\uff09\uff1a\u56e0\u4e3a\u67d0\u4e9b\u539f\u56e0\u65e0\u6cd5\u53d6\u5f97 Pod \u7684\u72b6\u6001\uff0c\u901a\u5e38\u662f\u56e0\u4e3a\u4e0e Pod \u6240\u5728\u4e3b\u673a\u901a\u4fe1\u5931\u8d25\u5bfc\u81f4\u7684</li> </ul> <p>\u9664\u6b64\u4e4b\u5916\uff0c<code>PodStatus</code> \u5bf9\u8c61\u4e2d\u8fd8\u5305\u542b\u4e00\u4e2a <code>PodCondition</code> \u7684\u6570\u7ec4\uff0c\u91cc\u9762\u5305\u542b\u7684\u5c5e\u6027\u6709\uff1a</p> <ul> <li>lastProbeTime\uff1a\u6700\u540e\u4e00\u6b21\u63a2\u6d4b Pod Condition \u7684\u65f6\u95f4\u6233\u3002</li> <li>lastTransitionTime\uff1a\u4e0a\u6b21 Condition \u4ece\u4e00\u79cd\u72b6\u6001\u8f6c\u6362\u5230\u53e6\u4e00\u79cd\u72b6\u6001\u7684\u65f6\u95f4\u3002</li> <li>message\uff1a\u4e0a\u6b21 Condition \u72b6\u6001\u8f6c\u6362\u7684\u8be6\u7ec6\u63cf\u8ff0\u3002</li> <li>reason\uff1aCondition \u6700\u540e\u4e00\u6b21\u8f6c\u6362\u7684\u539f\u56e0\u3002</li> <li>status\uff1aCondition \u72b6\u6001\u7c7b\u578b\uff0c\u53ef\u4ee5\u4e3a \u201cTrue\u201d, \u201cFalse\u201d, and \u201cUnknown\u201d.</li> <li>type\uff1aCondition \u7c7b\u578b\uff0c\u5305\u62ec\u4ee5\u4e0b\u65b9\u9762\uff1a<ul> <li>PodScheduled\uff08Pod \u5df2\u7ecf\u88ab\u8c03\u5ea6\u5230\u5176\u4ed6 node \u91cc\uff09</li> <li>Ready\uff08Pod \u80fd\u591f\u63d0\u4f9b\u670d\u52a1\u8bf7\u6c42\uff0c\u53ef\u4ee5\u88ab\u6dfb\u52a0\u5230\u6240\u6709\u53ef\u5339\u914d\u670d\u52a1\u7684\u8d1f\u8f7d\u5e73\u8861\u6c60\u4e2d\uff09</li> <li>Initialized\uff08\u6240\u6709\u7684<code>init containers</code>\u5df2\u7ecf\u542f\u52a8\u6210\u529f\uff09</li> <li>Unschedulable\uff08\u8c03\u5ea6\u7a0b\u5e8f\u73b0\u5728\u65e0\u6cd5\u8c03\u5ea6 Pod\uff0c\u4f8b\u5982\u7531\u4e8e\u7f3a\u4e4f\u8d44\u6e90\u6216\u5176\u4ed6\u9650\u5236\uff09</li> <li>ContainersReady\uff08Pod \u91cc\u7684\u6240\u6709\u5bb9\u5668\u90fd\u662f ready \u72b6\u6001\uff09</li> </ul> </li> </ul>"},{"location":"kubernetes_basic/pod_life/#_1","title":"\u91cd\u542f\u7b56\u7565","text":"<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e<code>restartPolicy</code>\u5b57\u6bb5\u6765\u8bbe\u7f6e Pod \u4e2d\u6240\u6709\u5bb9\u5668\u7684\u91cd\u542f\u7b56\u7565\uff0c\u5176\u53ef\u80fd\u503c\u4e3a</p> <pre><code>Always\uff0cOnFailure \u548c Never\n</code></pre> <p>\uff0c\u9ed8\u8ba4\u503c\u4e3a <code>Always</code>\u3002restartPolicy \u4ec5\u6307\u901a\u8fc7 kubelet \u5728\u540c\u4e00\u8282\u70b9\u4e0a\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\u3002\u901a\u8fc7 kubelet \u91cd\u65b0\u542f\u52a8\u7684\u9000\u51fa\u5bb9\u5668\u5c06\u4ee5\u6307\u6570\u589e\u52a0\u5ef6\u8fdf\uff0810s\uff0c20s\uff0c40s\u2026\uff09\u91cd\u65b0\u542f\u52a8\uff0c\u4e0a\u9650\u4e3a 5 \u5206\u949f\uff0c\u5e76\u5728\u6210\u529f\u6267\u884c 10 \u5206\u949f\u540e\u91cd\u7f6e\u3002\u4e0d\u540c\u7c7b\u578b\u7684\u7684\u63a7\u5236\u5668\u53ef\u4ee5\u63a7\u5236 Pod \u7684\u91cd\u542f\u7b56\u7565\uff1a</p> <ul> <li>Job\uff1a\u9002\u7528\u4e8e\u4e00\u6b21\u6027\u4efb\u52a1\u5982\u6279\u91cf\u8ba1\u7b97\uff0c\u4efb\u52a1\u7ed3\u675f\u540e Pod \u4f1a\u88ab\u6b64\u7c7b\u63a7\u5236\u5668\u6e05\u9664\u3002Job \u7684\u91cd\u542f\u7b56\u7565\u53ea\u80fd\u662f<code>\"OnFailure\"</code>\u6216\u8005<code>\"Never\"</code>\u3002</li> <li>Replication Controller, ReplicaSet, or Deployment\uff0c\u6b64\u7c7b\u63a7\u5236\u5668\u5e0c\u671b Pod \u4e00\u76f4\u8fd0\u884c\u4e0b\u53bb\uff0c\u5b83\u4eec\u7684\u91cd\u542f\u7b56\u7565\u53ea\u80fd\u662f<code>\"Always\"</code>\u3002</li> <li>DaemonSet\uff1a\u6bcf\u4e2a\u8282\u70b9\u4e0a\u542f\u52a8\u4e00\u4e2a Pod\uff0c\u5f88\u660e\u663e\u6b64\u7c7b\u63a7\u5236\u5668\u7684\u91cd\u542f\u7b56\u7565\u4e5f\u5e94\u8be5\u662f<code>\"Always\"</code>\u3002</li> </ul>"},{"location":"kubernetes_basic/pod_life/#_2","title":"\u521d\u59cb\u5316\u5bb9\u5668","text":"<p>\u4e86\u89e3\u4e86 Pod \u72b6\u6001\u540e\uff0c\u9996\u5148\u6765\u4e86\u89e3\u4e0b Pod \u4e2d\u6700\u65b0\u542f\u52a8\u7684 <code>Init Container</code>\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5e73\u65f6\u5e38\u8bf4\u7684<code>\u521d\u59cb\u5316\u5bb9\u5668</code>\u3002<code>Init Container</code>\u5c31\u662f\u7528\u6765\u505a\u521d\u59cb\u5316\u5de5\u4f5c\u7684\u5bb9\u5668\uff0c\u53ef\u4ee5\u662f\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\uff0c\u5982\u679c\u6709\u591a\u4e2a\u7684\u8bdd\uff0c\u8fd9\u4e9b\u5bb9\u5668\u4f1a\u6309\u5b9a\u4e49\u7684\u987a\u5e8f\u4f9d\u6b21\u6267\u884c\u3002\u6211\u4eec\u77e5\u9053\u4e00\u4e2a Pod \u91cc\u9762\u7684\u6240\u6709\u5bb9\u5668\u662f\u5171\u4eab\u6570\u636e\u5377\u548cNetwork Namespace \u7684\uff0c\u6240\u4ee5<code>Init Container</code>\u91cc\u9762\u4ea7\u751f\u7684\u6570\u636e\u53ef\u4ee5\u88ab\u4e3b\u5bb9\u5668\u4f7f\u7528\u5230\u3002\u4ece\u4e0a\u9762\u7684 Pod \u751f\u547d\u5468\u671f\u7684\u56fe\u4e2d\u53ef\u4ee5\u770b\u51fa\u521d\u59cb\u5316\u5bb9\u5668\u662f\u72ec\u7acb\u4e0e\u4e3b\u5bb9\u5668\u4e4b\u5916\u7684\uff0c\u53ea\u6709\u6240\u6709\u7684`\u521d\u59cb\u5316\u5bb9\u5668\u6267\u884c\u5b8c\u4e4b\u540e\uff0c\u4e3b\u5bb9\u5668\u624d\u4f1a\u88ab\u542f\u52a8\u3002\u90a3\u4e48\u521d\u59cb\u5316\u5bb9\u5668\u6709\u54ea\u4e9b\u5e94\u7528\u573a\u666f\u5462\uff1a</p> <ul> <li>\u7b49\u5f85\u5176\u4ed6\u6a21\u5757 Ready\uff1a\u8fd9\u4e2a\u53ef\u4ee5\u7528\u6765\u89e3\u51b3\u670d\u52a1\u4e4b\u95f4\u7684\u4f9d\u8d56\u95ee\u9898\uff0c\u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a Web \u670d\u52a1\uff0c\u8be5\u670d\u52a1\u53c8\u4f9d\u8d56\u4e8e\u53e6\u5916\u4e00\u4e2a\u6570\u636e\u5e93\u670d\u52a1\uff0c\u4f46\u662f\u5728\u6211\u4eec\u542f\u52a8\u8fd9\u4e2a Web \u670d\u52a1\u7684\u65f6\u5019\u6211\u4eec\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u4f9d\u8d56\u7684\u8fd9\u4e2a\u6570\u636e\u5e93\u670d\u52a1\u5c31\u5df2\u7ecf\u542f\u52a8\u8d77\u6765\u4e86\uff0c\u6240\u4ee5\u53ef\u80fd\u4f1a\u51fa\u73b0\u4e00\u6bb5\u65f6\u95f4\u5185 Web \u670d\u52a1\u8fde\u63a5\u6570\u636e\u5e93\u5f02\u5e38\u3002\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u8bdd\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 Web \u670d\u52a1\u7684 Pod \u4e2d\u4f7f\u7528\u4e00\u4e2a <code>InitContainer</code>\uff0c\u5728\u8fd9\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\u4e2d\u53bb\u68c0\u67e5\u6570\u636e\u5e93\u662f\u5426\u5df2\u7ecf\u51c6\u5907\u597d\u4e86\uff0c\u51c6\u5907\u597d\u4e86\u8fc7\u540e\u521d\u59cb\u5316\u5bb9\u5668\u5c31\u7ed3\u675f\u9000\u51fa\uff0c\u7136\u540e\u6211\u4eec\u4e3b\u5bb9\u5668\u7684 Web \u670d\u52a1\u624d\u88ab\u542f\u52a8\u8d77\u6765\uff0c\u8fd9\u4e2a\u65f6\u5019\u53bb\u8fde\u63a5\u6570\u636e\u5e93\u5c31\u4e0d\u4f1a\u6709\u95ee\u9898\u4e86\u3002</li> <li>\u505a\u521d\u59cb\u5316\u914d\u7f6e\uff1a\u6bd4\u5982\u96c6\u7fa4\u91cc\u68c0\u6d4b\u6240\u6709\u5df2\u7ecf\u5b58\u5728\u7684\u6210\u5458\u8282\u70b9\uff0c\u4e3a\u4e3b\u5bb9\u5668\u51c6\u5907\u597d\u96c6\u7fa4\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u8fd9\u6837\u4e3b\u5bb9\u5668\u8d77\u6765\u540e\u5c31\u80fd\u7528\u8fd9\u4e2a\u914d\u7f6e\u4fe1\u606f\u52a0\u5165\u96c6\u7fa4\u3002</li> <li>\u5176\u5b83\u573a\u666f\uff1a\u5982\u5c06 Pod \u6ce8\u518c\u5230\u4e00\u4e2a\u4e2d\u592e\u6570\u636e\u5e93\u3001\u914d\u7f6e\u4e2d\u5fc3\u7b49\u3002</li> </ul> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6765\u5b9e\u73b0\u4e00\u4e2a\u529f\u80fd\uff0c\u5728 Nginx Pod \u542f\u52a8\u4e4b\u524d\u53bb\u91cd\u65b0\u521d\u59cb\u5316\u9996\u9875\u5185\u5bb9\uff0c\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u6e05\u5355\uff1a\uff08init-pod.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: init-demo\nspec:\n  volumes:\n  - name: workdir\n    emptyDir: {}\n  initContainers:\n  - name: install\n    image: busybox\n    command:\n    - wget\n    - \"-O\"\n    - \"/work-dir/index.html\"\n    - http://www.baidu.com\n    volumeMounts:\n    - name: workdir\n      mountPath: \"/work-dir\"\n  containers:\n  - name: nginx\n    image: nginx\n    ports:\n    - containerPort: 80\n    volumeMounts:\n    - name: workdir\n      mountPath: /usr/share/nginx/html\n</code></pre> <p>\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u4e2d\u6211\u4eec\u9996\u5148\u5728 Pod \u9876\u5c42\u58f0\u660e\u4e86\u4e00\u4e2a\u540d\u4e3a workdir \u7684 <code>Volume</code>\uff0c\u524d\u9762\u6211\u4eec\u7528\u4e86 hostPath \u7684\u6a21\u5f0f\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684\u662f <code>emptyDir{}</code>\uff0c\u8fd9\u4e2a\u662f\u4e00\u4e2a\u4e34\u65f6\u7684\u76ee\u5f55\uff0c\u6570\u636e\u4f1a\u4fdd\u5b58\u5728 kubelet \u7684\u5de5\u4f5c\u76ee\u5f55\u4e0b\u9762\uff0c\u751f\u547d\u5468\u671f\u7b49\u540c\u4e8e Pod \u7684\u751f\u547d\u5468\u671f\u3002</p> <p>\u7136\u540e\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\uff0c\u8be5\u5bb9\u5668\u4f1a\u4e0b\u8f7d\u4e00\u4e2a html \u6587\u4ef6\u5230 <code>/work-dir</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u4f46\u662f\u7531\u4e8e\u6211\u4eec\u53c8\u5c06\u8be5\u76ee\u5f55\u58f0\u660e\u6302\u8f7d\u5230\u4e86\u5168\u5c40\u7684 Volume\uff0c\u540c\u6837\u7684\u4e3b\u5bb9\u5668 nginx \u4e5f\u5c06\u76ee\u5f55 </p> <pre><code>/usr/share/nginx/html\n</code></pre> <p>\u58f0\u660e\u6302\u8f7d\u5230\u4e86\u5168\u5c40\u7684 Volume\uff0c\u6240\u4ee5\u5728\u4e3b\u5bb9\u5668\u7684\u8be5\u76ee\u5f55\u4e0b\u9762\u4f1a\u540c\u6b65\u521d\u59cb\u5316\u5bb9\u5668\u4e2d\u521b\u5efa\u7684 <code>index.html</code> \u6587\u4ef6\u3002</p> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl apply -f init-pod.yaml\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u53ef\u4ee5\u67e5\u770b\u8be5 Pod \u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods\nNAME                            READY   STATUS     RESTARTS   AGE\ninit-demo                       0/1     Init:0/1   0          4s\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0 Pod \u73b0\u5728\u7684\u72b6\u6001\u5904\u4e8e <code>Init:0/1</code> \u72b6\u6001\uff0c\u610f\u601d\u5c31\u662f\u73b0\u5728\u7b2c\u4e00\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\u8fd8\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u67e5\u770b Pod \u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe pod init-demo\nName:         init-demo\nNamespace:    default\nPriority:     0\nNode:         ydzs-node3/157\nStart Time:   Mon, 11 Nov 2019 20:10:54 +0800\nLabels:       &lt;none&gt;\nAnnotations:  kubectl.kubernetes.io/last-applied-configuration:\n                {\"apiVersion\":\"v1\",\"kind\":\"Pod\",\"metadata\":{\"annotations\":{},\"name\":\"init-demo\",\"namespace\":\"default\"},\"spec\":{\"containers\":[{\"image\":\"ngi...\nStatus:       Pending\nIP:           254\nIPs:\n  IP:  254\nInit Containers:\n  install:\n    Container ID:  docker://762f64641abb913804bc8a3b71b553744afeb1169547ef35d9f6ef0e09a458e0\n    Image:         busybox\n    Image ID:      docker-pullable://busybox@sha256:1303dbf110c57f3edf68d9f5a16c082ec06c4cf7604831669faf2c712260b5a0\n    Port:          &lt;none&gt;\n    Host Port:     &lt;none&gt;\n    Command:\n      wget\n      -O\n      /work-dir/index.html\n      http://www.baidu.com\n    State:          Running\n      Started:      Mon, 11 Nov 2019 20:10:59 +0800\n    Ready:          False\n    Restart Count:  0\n    Environment:    &lt;none&gt;\n    Mounts:\n      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5tsh4 (ro)\n      /work-dir from workdir (rw)\nContainers:\n  nginx:\n    Container ID:\n    Image:          nginx\n    Image ID:\n    Port:           80/TCP\n    Host Port:      0/TCP\n    State:          Waiting\n      Reason:       PodInitializing\n    Ready:          False\n    Restart Count:  0\n    Environment:    &lt;none&gt;\n    Mounts:\n      /usr/share/nginx/html from workdir (rw)\n      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5tsh4 (ro)\nConditions:\n  Type              Status\n  Initialized       False\n  Ready             False\n  ContainersReady   False\n  PodScheduled      True\nVolumes:\n  workdir:\n    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)\n    Medium:\n    SizeLimit:  &lt;unset&gt;\n  default-token-5tsh4:\n    Type:        Secret (a volume populated by a Secret)\n    SecretName:  default-token-5tsh4\n    Optional:    false\nQoS Class:       BestEffort\nNode-Selectors:  &lt;none&gt;\nTolerations:     node.kubernetes.io/not-ready:NoExecute for 300s\n                 node.kubernetes.io/unreachable:NoExecute for 300s\nEvents:\n  Type    Reason     Age        From                 Message\n  ----    ------     ----       ----                 -------\n  Normal  Scheduled  &lt;unknown&gt;  default-scheduler    Successfully assigned default/init-demo to ydzs-node3\n  Normal  Pulling    20s        kubelet, ydzs-node3  Pulling image \"busybox\"\n  Normal  Pulled     17s        kubelet, ydzs-node3  Successfully pulled image \"busybox\"\n  Normal  Created    17s        kubelet, ydzs-node3  Created container install\n  Normal  Started    16s        kubelet, ydzs-node3  Started container install\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u63cf\u8ff0\u4fe1\u606f\u91cc\u9762\u53ef\u4ee5\u770b\u5230\u521d\u59cb\u5316\u5bb9\u5668\u5df2\u7ecf\u542f\u52a8\u4e86\uff0c\u73b0\u5728\u5904\u4e8e <code>Running</code> \u72b6\u6001\uff0c\u6240\u4ee5\u8fd8\u9700\u8981\u7a0d\u7b49\uff0c\u5230\u521d\u59cb\u5316\u5bb9\u5668\u6267\u884c\u5b8c\u6210\u540e\u9000\u51fa\u521d\u59cb\u5316\u5bb9\u5668\u4f1a\u53d8\u6210 <code>Completed</code> \u72b6\u6001\uff0c\u7136\u540e\u624d\u4f1a\u542f\u52a8\u4e3b\u5bb9\u5668\u3002\u5f85\u5230\u4e3b\u5bb9\u5668\u4e5f\u542f\u52a8\u5b8c\u6210\u540e\uff0cPod \u5c31\u4f1a\u53d8\u6210<code>Running</code> \u72b6\u6001\uff0c\u7136\u540e\u6211\u4eec\u53bb\u8bbf\u95ee\u4e0b Pod \u4e3b\u9875\uff0c\u9a8c\u8bc1\u4e0b\u662f\u5426\u6709\u6211\u4eec\u521d\u59cb\u5316\u5bb9\u5668\u4e2d\u4e0b\u8f7d\u7684\u9875\u9762\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pods -o wide\nNAME                            READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES\ninit-demo                       1/1     Running   0          3m39s   254    ydzs-node3   &lt;none&gt;           &lt;none&gt;\n$ curl 254\n&lt;!DOCTYPE html&gt;\n&lt;!--STATUS OK--&gt;&lt;html&gt; &lt;head&gt;&lt;meta http-equiv=content-type content=text/html;charset=utf-8&gt;&lt;meta http-equiv=X-UA-Compatible content=IE=Edge&gt;&lt;meta content=always name=referrer&gt;&lt;link rel=stylesheet type=text/css href=http://sbdstatic.com/r/www/cache/bdorz/baidu.min.css&gt;&lt;title&gt;\u767e\u5ea6\u4e00\u4e0b\uff0c\u4f60\u5c31\u77e5\u9053&lt;/title&gt;&lt;/head&gt; &lt;body link=#0000cc&gt; &lt;div id=wrapper&gt; &lt;div id=head&gt; &lt;div class=head_wrapper&gt; &lt;div class=s_form&gt; &lt;div class=s_form_wrapper&gt; &lt;div id=lg&gt; &lt;img hidefocus=true src=//www.baidu.com/img/bd_logopng width=270 height=129&gt; &lt;/div&gt; &lt;form id=form name=f action=//www.baidu.com/s class=fm&gt; &lt;input type=hidden name=bdorz_come value=1&gt; &lt;input type=hidden name=ie value=utf-8&gt; &lt;input type=hidden name=f value=8&gt; &lt;input type=hidden name=rsv_bp value=1&gt; &lt;input type=hidden name=rsv_idx value=1&gt; &lt;input type=hidden name=tn value=baidu&gt;&lt;span class=\"bg s_ipt_wr\"&gt;&lt;input id=kw name=wd class=s_ipt value maxlength=255 autocomplete=off autofocus&gt;&lt;/span&gt;&lt;span class=\"bg s_btn_wr\"&gt;&lt;input type=submit id=su value=\u767e\u5ea6\u4e00\u4e0b class=\"bg s_btn\"&gt;&lt;/span&gt; &lt;/form&gt; &lt;/div&gt; &lt;/div&gt; &lt;div id=u1&gt; &lt;a href=http://news.baidu.com name=tj_trnews class=mnav&gt;\u65b0\u95fb&lt;/a&gt; &lt;a href=http://www.hao1com name=tj_trhao123 class=mnav&gt;hao123&lt;/a&gt; &lt;a href=http://map.baidu.com name=tj_trmap class=mnav&gt;\u5730\u56fe&lt;/a&gt; &lt;a href=http://v.baidu.com name=tj_trvideo class=mnav&gt;\u89c6\u9891&lt;/a&gt; &lt;a href=http://tieba.baidu.com name=tj_trtieba class=mnav&gt;\u8d34\u5427&lt;/a&gt; &lt;noscript&gt; &lt;a href=http://www.baidu.com/bdorz/login.gif?login&amp;amp;tpl=mn&amp;amp;u=http%3A%2F%2Fwww.baidu.com%2f%3fbdorz_come%3d1 name=tj_login class=lb&gt;\u767b\u5f55&lt;/a&gt; &lt;/noscript&gt; &lt;script&gt;document.write('&lt;a href=\"http://www.baidu.com/bdorz/login.gif?login&amp;tpl=mn&amp;u='+ encodeURIComponent(window.location.href+ (window.location.search === \"\" ? \"?\" : \"&amp;\")+ \"bdorz_come=1\")+ '\" name=\"tj_login\" class=\"lb\"&gt;\u767b\u5f55&lt;/a&gt;');&lt;/script&gt; &lt;a href=//www.baidu.com/more/ name=tj_briicon class=bri style=\"display: block;\"&gt;\u66f4\u591a\u4ea7\u54c1&lt;/a&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;div id=ftCon&gt; &lt;div id=ftConw&gt; &lt;p id=lh&gt; &lt;a href=http://home.baidu.com&gt;\u5173\u4e8e\u767e\u5ea6&lt;/a&gt; &lt;a href=http://ir.baidu.com&gt;About Baidu&lt;/a&gt; &lt;/p&gt; &lt;p id=cp&gt;&amp;copy;2017&amp;nbsp;Baidu&amp;nbsp;&lt;a href=http://www.baidu.com/duty/&gt;\u4f7f\u7528\u767e\u5ea6\u524d\u5fc5\u8bfb&lt;/a&gt;&amp;nbsp; &lt;a href=http://jianyi.baidu.com/ class=cp-feedback&gt;\u610f\u89c1\u53cd\u9988&lt;/a&gt;&amp;nbsp;\u4eacICP\u8bc1030173\u53f7&amp;nbsp; &lt;img src=//www.baidu.com/img/gs.gif&gt; &lt;/p&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/body&gt; &lt;/html&gt;\n</code></pre>"},{"location":"kubernetes_basic/pod_life/#pod_hook","title":"Pod Hook","text":"<p>\u6211\u4eec\u77e5\u9053 Pod \u662f Kubernetes \u96c6\u7fa4\u4e2d\u7684\u6700\u5c0f\u5355\u5143\uff0c\u800c Pod \u662f\u7531\u5bb9\u5668\u7ec4\u6210\u7684\uff0c\u6240\u4ee5\u5728\u8ba8\u8bba Pod \u7684\u751f\u547d\u5468\u671f\u7684\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u5148\u6765\u8ba8\u8bba\u4e0b\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\u3002\u5b9e\u9645\u4e0a Kubernetes \u4e3a\u6211\u4eec\u7684\u5bb9\u5668\u63d0\u4f9b\u4e86\u751f\u547d\u5468\u671f\u7684\u94a9\u5b50\uff0c\u5c31\u662f\u6211\u4eec\u8bf4\u7684<code>Pod Hook</code>\uff0cPod Hook \u662f\u7531 kubelet \u53d1\u8d77\u7684\uff0c\u5f53\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0b\u542f\u52a8\u524d\u6216\u8005\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0b\u7ec8\u6b62\u4e4b\u524d\u8fd0\u884c\uff0c\u8fd9\u662f\u5305\u542b\u5728\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\u4e4b\u4e2d\u3002\u6211\u4eec\u53ef\u4ee5\u540c\u65f6\u4e3a Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u914d\u7f6e hook\u3002</p> <p>Kubernetes \u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e24\u79cd\u94a9\u5b50\u51fd\u6570\uff1a</p> <ul> <li><code>PostStart</code>\uff1a\u8fd9\u4e2a\u94a9\u5b50\u5728\u5bb9\u5668\u521b\u5efa\u540e\u7acb\u5373\u6267\u884c\u3002\u4f46\u662f\uff0c\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u94a9\u5b50\u5c06\u5728\u5bb9\u5668 ENTRYPOINT \u4e4b\u524d\u8fd0\u884c\uff0c\u56e0\u4e3a\u6ca1\u6709\u53c2\u6570\u4f20\u9012\u7ed9\u5904\u7406\u7a0b\u5e8f\u3002\u4e3b\u8981\u7528\u4e8e\u8d44\u6e90\u90e8\u7f72\u3001\u73af\u5883\u51c6\u5907\u7b49\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5982\u679c\u94a9\u5b50\u82b1\u8d39\u592a\u957f\u65f6\u95f4\u4ee5\u81f3\u4e8e\u4e0d\u80fd\u8fd0\u884c\u6216\u8005\u6302\u8d77\uff0c\u5bb9\u5668\u5c06\u4e0d\u80fd\u8fbe\u5230 running \u72b6\u6001\u3002</li> <li><code>PreStop</code>\uff1a\u8fd9\u4e2a\u94a9\u5b50\u5728\u5bb9\u5668\u7ec8\u6b62\u4e4b\u524d\u7acb\u5373\u88ab\u8c03\u7528\u3002\u5b83\u662f\u963b\u585e\u7684\uff0c\u610f\u5473\u7740\u5b83\u662f\u540c\u6b65\u7684\uff0c\u6240\u4ee5\u5b83\u5fc5\u987b\u5728\u5220\u9664\u5bb9\u5668\u7684\u8c03\u7528\u53d1\u51fa\u4e4b\u524d\u5b8c\u6210\u3002\u4e3b\u8981\u7528\u4e8e\u4f18\u96c5\u5173\u95ed\u5e94\u7528\u7a0b\u5e8f\u3001\u901a\u77e5\u5176\u4ed6\u7cfb\u7edf\u7b49\u3002\u5982\u679c\u94a9\u5b50\u5728\u6267\u884c\u671f\u95f4\u6302\u8d77\uff0cPod \u9636\u6bb5\u5c06\u505c\u7559\u5728 running \u72b6\u6001\u5e76\u4e14\u6c38\u4e0d\u4f1a\u8fbe\u5230 failed \u72b6\u6001\u3002</li> </ul> <p>\u5982\u679c PostStart \u6216\u8005 PreStop \u94a9\u5b50\u5931\u8d25\uff0c \u5b83\u4f1a\u6740\u6b7b\u5bb9\u5668\u3002\u6240\u4ee5\u6211\u4eec\u5e94\u8be5\u8ba9\u94a9\u5b50\u51fd\u6570\u5c3d\u53ef\u80fd\u7684\u8f7b\u91cf\u3002\u5f53\u7136\u6709\u4e9b\u60c5\u51b5\u4e0b\uff0c\u957f\u65f6\u95f4\u8fd0\u884c\u547d\u4ee4\u662f\u5408\u7406\u7684\uff0c \u6bd4\u5982\u5728\u505c\u6b62\u5bb9\u5668\u4e4b\u524d\u9884\u5148\u4fdd\u5b58\u72b6\u6001\u3002</p> <p>\u53e6\u5916\u6211\u4eec\u6709\u4e24\u79cd\u65b9\u5f0f\u6765\u5b9e\u73b0\u4e0a\u9762\u7684\u94a9\u5b50\u51fd\u6570\uff1a</p> <ul> <li><code>Exec</code> - \u7528\u4e8e\u6267\u884c\u4e00\u6bb5\u7279\u5b9a\u7684\u547d\u4ee4\uff0c\u4e0d\u8fc7\u8981\u6ce8\u610f\u7684\u662f\u8be5\u547d\u4ee4\u6d88\u8017\u7684\u8d44\u6e90\u4f1a\u88ab\u8ba1\u5165\u5bb9\u5668\u3002</li> <li><code>HTTP</code> - \u5bf9\u5bb9\u5668\u4e0a\u7684\u7279\u5b9a\u7684\u7aef\u70b9\u6267\u884c HTTP \u8bf7\u6c42\u3002</li> </ul> <p>\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e2a Nginx Pod\uff0c\u5176\u4e2d\u8bbe\u7f6e\u4e86 PostStart \u94a9\u5b50\u51fd\u6570\uff0c\u5373\u5728\u5bb9\u5668\u521b\u5efa\u6210\u529f\u540e\uff0c\u5199\u5165\u4e00\u53e5\u8bdd\u5230 /usr/share/message \u6587\u4ef6\u4e2d\uff1a\uff08pod-poststart.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: hook-demo1\nspec:\n  containers:\n  - name: hook-demo1\n    image: nginx\n    lifecycle:\n      postStart:\n        exec:\n          command: [\"/bin/sh\", \"-c\", \"echo Hello from the postStart handler &gt; /usr/share/message\"]\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl apply -f pod-poststart.yaml\n$ kubectl get pods\nNAME                            READY   STATUS    RESTARTS   AGE\nhook-demo1                      1/1     Running   0          43s\n</code></pre> <p>\u521b\u5efa\u6210\u529f\u540e\u53ef\u4ee5\u67e5\u770b\u5bb9\u5668\u4e2d <code>/usr/share/message</code> \u6587\u4ef6\u662f\u5426\u5185\u5bb9\u6b63\u786e\uff1a</p> <pre><code>$ kubectl exec -it hook-demo1 cat /usr/share/message\nHello from the postStart handler\n</code></pre> <p>\u5f53\u7528\u6237\u8bf7\u6c42\u5220\u9664\u542b\u6709 Pod \u7684\u8d44\u6e90\u5bf9\u8c61\u65f6\uff08\u5982 Deployment \u7b49\uff09\uff0cK8S \u4e3a\u4e86\u8ba9\u5e94\u7528\u7a0b\u5e8f\u4f18\u96c5\u5173\u95ed\uff08\u5373\u8ba9\u5e94\u7528\u7a0b\u5e8f\u5b8c\u6210\u6b63\u5728\u5904\u7406\u7684\u8bf7\u6c42\u540e\uff0c\u518d\u5173\u95ed\u8f6f\u4ef6\uff09\uff0cK8S \u63d0\u4f9b\u4e24\u79cd\u4fe1\u606f\u901a\u77e5\uff1a</p> <ul> <li>\u9ed8\u8ba4\uff1aK8S \u901a\u77e5 node \u6267\u884c<code>docker stop</code>\u547d\u4ee4\uff0cdocker \u4f1a\u5148\u5411\u5bb9\u5668\u4e2d PID \u4e3a 1 \u7684\u8fdb\u7a0b\u53d1\u9001\u7cfb\u7edf\u4fe1\u53f7<code>SIGTERM</code>\uff0c\u7136\u540e\u7b49\u5f85\u5bb9\u5668\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u7ec8\u6b62\u6267\u884c\uff0c\u5982\u679c\u7b49\u5f85\u65f6\u95f4\u8fbe\u5230\u8bbe\u5b9a\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u6216\u8005\u9ed8\u8ba4\u8d85\u65f6\u65f6\u95f4\uff0830s\uff09\uff0c\u4f1a\u7ee7\u7eed\u53d1\u9001<code>SIGKILL</code>\u7684\u7cfb\u7edf\u4fe1\u53f7\u5f3a\u884c kill \u6389\u8fdb\u7a0b</li> <li>\u4f7f\u7528 Pod \u751f\u547d\u5468\u671f\uff08\u5229\u7528<code>PreStop</code>\u56de\u8c03\u51fd\u6570\uff09\uff0c\u5b83\u5728\u53d1\u9001\u7ec8\u6b62\u4fe1\u53f7\u4e4b\u524d\u6267\u884c</li> </ul> <p>\u9ed8\u8ba4\u6240\u6709\u7684\u4f18\u96c5\u9000\u51fa\u65f6\u95f4\u90fd\u572830\u79d2\u5185\u3002kubectl delete \u547d\u4ee4\u652f\u6301 </p> <pre><code>--grace-period=&lt;seconds&gt;\n</code></pre> <p>\u9009\u9879\uff0c\u8fd9\u4e2a\u9009\u9879\u5141\u8bb8\u7528\u6237\u7528\u4ed6\u4eec\u81ea\u5df1\u6307\u5b9a\u7684\u503c\u8986\u76d6\u9ed8\u8ba4\u503c\u3002\u503c0\u4ee3\u8868\u5f3a\u5236\u5220\u9664 pod\u3002 \u5728 kubectl 1.5 \u53ca\u4ee5\u4e0a\u7684\u7248\u672c\u91cc\uff0c\u6267\u884c\u5f3a\u5236\u5220\u9664\u65f6\u5fc5\u987b\u540c\u65f6\u6307\u5b9a </p> <pre><code>--force --grace-period=0\n</code></pre> <p>\u3002</p> <p>\u5f3a\u5236\u5220\u9664\u4e00\u4e2a pod \u662f\u4ece\u96c6\u7fa4\u72b6\u6001\u8fd8\u6709 etcd \u91cc\u7acb\u523b\u5220\u9664\u8fd9\u4e2a pod\uff0c\u53ea\u662f\u5f53 Pod \u88ab\u5f3a\u5236\u5220\u9664\u65f6\uff0c APIServer \u4e0d\u4f1a\u7b49\u5f85\u6765\u81ea Pod \u6240\u5728\u8282\u70b9\u4e0a\u7684 kubelet \u7684\u786e\u8ba4\u4fe1\u606f\uff1apod \u5df2\u7ecf\u88ab\u7ec8\u6b62\u3002\u5728 API \u91cc pod \u4f1a\u88ab\u7acb\u523b\u5220\u9664\uff0c\u5728\u8282\u70b9\u4e0a\uff0c pods \u88ab\u8bbe\u7f6e\u6210\u7acb\u523b\u7ec8\u6b62\u540e\uff0c\u5728\u5f3a\u884c\u6740\u6389\u524d\u8fd8\u4f1a\u6709\u4e00\u4e2a\u5f88\u5c0f\u7684\u5bbd\u9650\u671f\u3002</p> <p>\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e2a Nginx Pod\uff0c\u5176\u4e2d\u8bbe\u7f6e\u4e86<code>PreStop</code>\u94a9\u5b50\u51fd\u6570\uff0c\u5373\u5728\u5bb9\u5668\u9000\u51fa\u4e4b\u524d\uff0c\u4f18\u96c5\u7684\u5173\u95ed Nginx\uff1a\uff08pod-prestop.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: hook-demo2\nspec:\n  containers:\n  - name: hook-demo2\n    image: nginx\n    lifecycle:\n      preStop:\n        exec:\n          command: [\"/usr/sbin/nginx\",\"-s\",\"quit\"]  # \u4f18\u96c5\u9000\u51fa\n\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: hook-demo3\nspec:\n  volumes:\n  - name: message\n    hostPath:\n      path: /tmp\n  containers:\n  - name: hook-demo2\n    image: nginx\n    ports:\n    - containerPort: 80\n    volumeMounts:\n    - name: message\n      mountPath: /usr/share/\n    lifecycle:\n      preStop:\n        exec:\n          command: ['/bin/sh', '-c', 'echo Hello from the preStop Handler &gt; /usr/share/message']\n</code></pre> <p>\u4e0a\u9762\u5b9a\u4e49\u7684\u4e24\u4e2a Pod\uff0c\u4e00\u4e2a\u662f\u5229\u7528 <code>preStop</code> \u6765\u8fdb\u884c\u4f18\u96c5\u5220\u9664\uff0c\u53e6\u5916\u4e00\u4e2a\u662f\u5229\u7528 <code>preStop</code> \u6765\u505a\u4e00\u4e9b\u4fe1\u606f\u8bb0\u5f55\u7684\u4e8b\u60c5\uff0c\u540c\u6837\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl apply -f pod-prestop.yaml\n$ kubectl get pods\nNAME                            READY   STATUS    RESTARTS   AGE\nhook-demo2                      1/1     Running   0          67s\nhook-demo3                      1/1     Running   0          67s\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5220\u9664 hook-demo2 \u8fd9\u4e2a Pod\uff0c\u5728\u5bb9\u5668\u5220\u9664\u4e4b\u524d\u4f1a\u6267\u884c preStop \u91cc\u9762\u7684\u4f18\u96c5\u5173\u95ed\u547d\u4ee4\uff0c\u8fd9\u4e2a\u7528\u6cd5\u5728\u540e\u9762\u6211\u4eec\u7684\u6eda\u52a8\u66f4\u65b0\u7684\u65f6\u5019\u7528\u6765\u4fdd\u8bc1\u6211\u4eec\u7684\u5e94\u7528\u96f6\u5b95\u673a\u975e\u5e38\u6709\u7528\u3002\u7b2c\u4e8c\u4e2a Pod \u6211\u4eec\u58f0\u660e\u4e86\u4e00\u4e2a hostPath \u7c7b\u578b\u7684 Volume\uff0c\u5728\u5bb9\u5668\u91cc\u9762\u58f0\u660e\u6302\u8f7d\u5230\u4e86\u8fd9\u4e2a Volume\uff0c\u6240\u4ee5\u5f53\u6211\u4eec\u5220\u9664 Pod\uff0c\u9000\u51fa\u5bb9\u5668\u4e4b\u524d\uff0c\u5728\u5bb9\u5668\u91cc\u9762\u8f93\u51fa\u7684\u4fe1\u606f\u4e5f\u4f1a\u540c\u6837\u7684\u4fdd\u5b58\u5230\u5bbf\u4e3b\u673a\uff08\u4e00\u5b9a\u8981\u662f Pod \u88ab\u8c03\u5ea6\u5230\u7684\u76ee\u6807\u8282\u70b9\uff09\u7684 <code>/tmp</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b hook-demo3 \u8fd9\u4e2a Pod \u88ab\u8c03\u5ea6\u7684\u8282\u70b9\uff1a</p> <pre><code>$ kubectl describe pod hook-demo3\nName:         hook-demo3\nNamespace:    default\nPriority:     0\nNode:         ydzs-node1/122\nStart Time:   Tue, 12 Nov 2019 14:33:54 +0800\n......\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a Pod \u88ab\u8c03\u5ea6\u5230\u4e86 <code>ydzs-node1</code> \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u5230\u8be5\u8282\u70b9\u4e0a\u67e5\u770b <code>/tmp</code> \u76ee\u5f55\u4e0b\u9762\u76ee\u524d\u6ca1\u6709\u4efb\u4f55\u5185\u5bb9\uff1a</p> <p><code>$ ls /tmp/</code></p> <p>\u73b0\u5728\u6211\u4eec\u6765\u5220\u9664 hook-demo3 \u8fd9\u4e2a Pod\uff0c\u5b89\u88c5\u6211\u4eec\u7684\u8bbe\u5b9a\u5728\u5bb9\u5668\u9000\u51fa\u4e4b\u524d\u4f1a\u6267\u884c <code>preStop</code> \u91cc\u9762\u7684\u547d\u4ee4\uff0c\u4e5f\u5c31\u662f\u4f1a\u5f80 message \u6587\u4ef6\u4e2d\u8f93\u51fa\u4e00\u4e9b\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl delete pod hook-demo3\npod \"hook-demo3\" deleted\n$ ls /tmp/\nmessage\n$ cat /tmp/message\nHello from the preStop Handler\n</code></pre> <p>\u53e6\u5916 Hook \u8c03\u7528\u7684\u65e5\u5fd7\u6ca1\u6709\u66b4\u9732\u4e2a\u7ed9 Pod\uff0c\u6240\u4ee5\u53ea\u80fd\u901a\u8fc7 describe \u547d\u4ee4\u6765\u83b7\u53d6\uff0c\u5982\u679c\u6709\u9519\u8bef\u5c06\u53ef\u4ee5\u770b\u5230 <code>FailedPostStartHook</code> \u6216 <code>FailedPreStopHook</code> \u8fd9\u6837\u7684 event\u3002</p>"},{"location":"kubernetes_basic/pod_life/#pod_2","title":"Pod \u5065\u5eb7\u68c0\u67e5","text":"<p>\u73b0\u5728\u5728 Pod \u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u4e2d\uff0c\u80fd\u5f71\u54cd\u5230 Pod \u7684\u5c31\u53ea\u5269\u4e0b\u5065\u5eb7\u68c0\u67e5\u8fd9\u4e00\u90e8\u5206\u4e86\u3002\u5728 Kubernetes \u96c6\u7fa4\u5f53\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e<code>liveness probe\uff08\u5b58\u6d3b\u63a2\u9488</code>\uff09\u548c</p> <pre><code>readiness probe\uff08\u53ef\u8bfb\u6027\u63a2\u9488\uff09\n</code></pre> <p>\u6765\u5f71\u54cd\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\uff1a</p> <ul> <li>kubelet \u901a\u8fc7\u4f7f\u7528 <code>liveness probe</code> \u6765\u786e\u5b9a\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u8fd0\u884c\uff0c\u901a\u4fd7\u70b9\u5c06\u5c31\u662f<code>\u662f\u5426\u8fd8\u6d3b\u7740</code>\u3002\u4e00\u822c\u6765\u8bf4\uff0c\u5982\u679c\u4f60\u7684\u7a0b\u5e8f\u4e00\u65e6\u5d29\u6e83\u4e86\uff0c Kubernetes \u5c31\u4f1a\u7acb\u523b\u77e5\u9053\u8fd9\u4e2a\u7a0b\u5e8f\u5df2\u7ecf\u7ec8\u6b62\u4e86\uff0c\u7136\u540e\u5c31\u4f1a\u91cd\u542f\u8fd9\u4e2a\u7a0b\u5e8f\u3002\u800c\u6211\u4eec\u7684 liveness probe \u7684\u76ee\u7684\u5c31\u662f\u6765\u6355\u83b7\u5230\u5f53\u524d\u5e94\u7528\u7a0b\u5e8f\u8fd8\u6ca1\u6709\u7ec8\u6b62\uff0c\u8fd8\u6ca1\u6709\u5d29\u6e83\uff0c\u5982\u679c\u51fa\u73b0\u4e86\u8fd9\u4e9b\u60c5\u51b5\uff0c\u90a3\u4e48\u5c31\u91cd\u542f\u5904\u4e8e\u8be5\u72b6\u6001\u4e0b\u7684\u5bb9\u5668\uff0c\u4f7f\u5e94\u7528\u7a0b\u5e8f\u5728\u5b58\u5728 bug \u7684\u60c5\u51b5\u4e0b\u4f9d\u7136\u80fd\u591f\u7ee7\u7eed\u8fd0\u884c\u4e0b\u53bb\u3002</li> <li>kubelet \u4f7f\u7528 <code>readiness probe</code> \u6765\u786e\u5b9a\u5bb9\u5668\u662f\u5426\u5df2\u7ecf\u5c31\u7eea\u53ef\u4ee5\u63a5\u6536\u6d41\u91cf\u8fc7\u6765\u4e86\u3002\u8fd9\u4e2a\u63a2\u9488\u901a\u4fd7\u70b9\u8bb2\u5c31\u662f\u8bf4<code>\u662f\u5426\u51c6\u5907\u597d\u4e86</code>\uff0c\u73b0\u5728\u53ef\u4ee5\u5f00\u59cb\u5de5\u4f5c\u4e86\u3002\u53ea\u6709\u5f53 Pod \u4e2d\u7684\u5bb9\u5668\u90fd\u5904\u4e8e\u5c31\u7eea\u72b6\u6001\u7684\u65f6\u5019 kubelet \u624d\u4f1a\u8ba4\u5b9a\u8be5 Pod \u5904\u4e8e\u5c31\u7eea\u72b6\u6001\uff0c\u56e0\u4e3a\u4e00\u4e2a Pod \u4e0b\u9762\u53ef\u80fd\u4f1a\u6709\u591a\u4e2a\u5bb9\u5668\u3002\u5f53\u7136 Pod \u5982\u679c\u5904\u4e8e\u975e\u5c31\u7eea\u72b6\u6001\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u4f1a\u5c06\u4ed6\u4ece Service \u7684 Endpoints \u5217\u8868\u4e2d\u79fb\u9664\u51fa\u6765\uff0c\u8fd9\u6837\u6211\u4eec\u7684\u6d41\u91cf\u5c31\u4e0d\u4f1a\u88ab\u8def\u7531\u5230\u8fd9\u4e2a Pod \u91cc\u9762\u6765\u4e86\u3002</li> </ul> <p>\u548c\u524d\u9762\u7684\u94a9\u5b50\u51fd\u6570\u4e00\u6837\u7684\uff0c\u6211\u4eec\u8fd9\u4e24\u4e2a\u63a2\u9488\u7684\u652f\u6301\u4e0b\u9762\u51e0\u79cd\u914d\u7f6e\u65b9\u5f0f\uff1a</p> <ul> <li>exec\uff1a\u6267\u884c\u4e00\u6bb5\u547d\u4ee4</li> <li>http\uff1a\u68c0\u6d4b\u67d0\u4e2a http \u8bf7\u6c42</li> <li>tcpSocket\uff1a\u4f7f\u7528\u6b64\u914d\u7f6e\uff0ckubelet \u5c06\u5c1d\u8bd5\u5728\u6307\u5b9a\u7aef\u53e3\u4e0a\u6253\u5f00\u5bb9\u5668\u7684\u5957\u63a5\u5b57\u3002\u5982\u679c\u53ef\u4ee5\u5efa\u7acb\u8fde\u63a5\uff0c\u5bb9\u5668\u88ab\u8ba4\u4e3a\u662f\u5065\u5eb7\u7684\uff0c\u5982\u679c\u4e0d\u80fd\u5c31\u8ba4\u4e3a\u662f\u5931\u8d25\u7684\u3002\u5b9e\u9645\u4e0a\u5c31\u662f\u68c0\u67e5\u7aef\u53e3\u3002</li> </ul> <p>\u6211\u4eec\u5148\u6765\u7ed9\u5927\u5bb6\u6f14\u793a\u4e0b\u5b58\u6d3b\u63a2\u9488\u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u9996\u5148\u6211\u4eec\u7528 exec \u6267\u884c\u547d\u4ee4\u7684\u65b9\u5f0f\u6765\u68c0\u6d4b\u5bb9\u5668\u7684\u5b58\u6d3b\uff0c\u5982\u4e0b\uff1a\uff08liveness-exec.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: liveness-exec\nspec:\n  containers:\n  - name: liveness\n    image: busybox\n    args:\n    - /bin/sh\n    - -c\n    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600\n    livenessProbe:\n      exec:\n        command:\n        - cat\n        - /tmp/healthy\n      initialDelaySeconds: 5\n      periodSeconds: 5\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u9700\u8981\u7528\u5230\u4e00\u4e2a\u65b0\u7684\u5c5e\u6027\uff1a<code>livenessProbe</code>\uff0c\u4e0b\u9762\u901a\u8fc7 exec \u6267\u884c\u4e00\u6bb5\u547d\u4ee4:</p> <ul> <li><code>periodSeconds</code>\uff1a\u8868\u793a\u8ba9 kubelet \u6bcf\u96945\u79d2\u6267\u884c\u4e00\u6b21\u5b58\u6d3b\u63a2\u9488\uff0c\u4e5f\u5c31\u662f\u6bcf5\u79d2\u6267\u884c\u4e00\u6b21\u4e0a\u9762\u7684<code>cat /tmp/healthy</code>\u547d\u4ee4\uff0c\u5982\u679c\u547d\u4ee4\u6267\u884c\u6210\u529f\u4e86\uff0c\u5c06\u8fd4\u56de0\uff0c\u90a3\u4e48 kubelet \u5c31\u4f1a\u8ba4\u4e3a\u5f53\u524d\u8fd9\u4e2a\u5bb9\u5668\u662f\u5b58\u6d3b\u7684\uff0c\u5982\u679c\u8fd4\u56de\u7684\u662f\u975e0\u503c\uff0c\u90a3\u4e48 kubelet \u5c31\u4f1a\u628a\u8be5\u5bb9\u5668\u6740\u6389\u7136\u540e\u91cd\u542f\u5b83\u3002\u9ed8\u8ba4\u662f10\u79d2\uff0c\u6700\u5c0f1\u79d2\u3002</li> <li><code>initialDelaySeconds</code>\uff1a\u8868\u793a\u5728\u7b2c\u4e00\u6b21\u6267\u884c\u63a2\u9488\u7684\u65f6\u5019\u8981\u7b49\u5f855\u79d2\uff0c\u8fd9\u6837\u80fd\u591f\u786e\u4fdd\u6211\u4eec\u7684\u5bb9\u5668\u80fd\u591f\u6709\u8db3\u591f\u7684\u65f6\u95f4\u542f\u52a8\u8d77\u6765\u3002\u5927\u5bb6\u53ef\u4ee5\u60f3\u8c61\u4e0b\uff0c\u5982\u679c\u4f60\u7684\u7b2c\u4e00\u6b21\u6267\u884c\u63a2\u9488\u7b49\u5019\u7684\u65f6\u95f4\u592a\u77ed\uff0c\u662f\u4e0d\u662f\u5f88\u6709\u53ef\u80fd\u5bb9\u5668\u8fd8\u6ca1\u6b63\u5e38\u542f\u52a8\u8d77\u6765\uff0c\u6240\u4ee5\u5b58\u6d3b\u63a2\u9488\u5f88\u53ef\u80fd\u59cb\u7ec8\u90fd\u662f\u5931\u8d25\u7684\uff0c\u8fd9\u6837\u5c31\u4f1a\u65e0\u4f11\u6b62\u7684\u91cd\u542f\u4e0b\u53bb\u4e86\uff0c\u5bf9\u5427\uff1f</li> </ul> <p>\u6211\u4eec\u5728\u5bb9\u5668\u542f\u52a8\u7684\u65f6\u5019\uff0c\u6267\u884c\u4e86\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ /bin/sh -c \"touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600\"\n</code></pre> <p>\u610f\u601d\u662f\u8bf4\u5728\u5bb9\u5668\u6700\u5f00\u59cb\u768430\u79d2\u5185\u521b\u5efa\u4e86\u4e00\u4e2a<code>/tmp/healthy</code>\u6587\u4ef6\uff0c\u5728\u8fd930\u79d2\u5185\u6267\u884c<code>cat /tmp/healthy</code>\u547d\u4ee4\u90fd\u4f1a\u8fd4\u56de\u4e00\u4e2a\u6210\u529f\u7684\u8fd4\u56de\u7801\u300230 \u79d2\u540e\uff0c\u6211\u4eec\u5220\u9664\u8fd9\u4e2a\u6587\u4ef6\uff0c\u73b0\u5728\u6267\u884c<code>cat /tmp/healthy</code>\u662f\u4e0d\u662f\u5c31\u4f1a\u5931\u8d25\u4e86\uff08\u9ed8\u8ba4\u68c0\u6d4b\u5931\u8d253\u6b21\u624d\u8ba4\u4e3a\u5931\u8d25\uff09\uff0c\u6240\u4ee5\u8fd9\u4e2a\u65f6\u5019\u5c31\u4f1a\u91cd\u542f\u5bb9\u5668\u4e86\u3002</p> <p>\u6211\u4eec\u6765\u521b\u5efa\u4e0b\u8be5 Pod\uff0c\u7136\u540e\u5728 30 \u79d2\u5185\uff0c\u67e5\u770b Pod \u7684 Event\uff1a</p> <pre><code>$ kubectl apply -f liveness-exec.yaml\n$ kubectl describe pod liveness-exec\n......\n  Normal  Started    20s        kubelet, ydzs-node4  Started container liveness\n......\n Normal   Started    46s               kubelet, ydzs-node4  Started container liveness\n  Warning  Unhealthy  3s (x3 over 13s)  kubelet, ydzs-node4  Liveness probe failed: cat: can't open '/tmp/healthy': No such file or directory\n  Normal   Killing    3s                kubelet, ydzs-node4  Container liveness failed liveness probe, will be restarted\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf\u5230\u5bb9\u5668\u662f\u6b63\u5e38\u542f\u52a8\u7684\uff0c\u5728\u9694\u4e00\u4f1a\u513f\uff0c\u6bd4\u5982 40s \u540e\uff0c\u518d\u67e5\u770b\u4e0b Pod \u7684 Event\uff0c\u5728\u6700\u4e0b\u9762\u6709\u4e00\u6761\u4fe1\u606f\u663e\u793a liveness probe \u5931\u8d25\u4e86\uff0c\u5bb9\u5668\u5c06\u8981\u91cd\u542f\u3002\u7136\u540e\u53ef\u4ee5\u67e5\u770b\u5230 Pod \u7684 <code>RESTARTS</code> \u503c\u52a0 1 \u4e86\uff1a</p> <pre><code>$ kubectl get pods\nNAME            READY   STATUS    RESTARTS   AGE\nliveness-exec   1/1     Running   1          1m\n</code></pre> <p>\u540c\u6837\u7684\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528<code>HTTP GET</code>\u8bf7\u6c42\u6765\u914d\u7f6e\u6211\u4eec\u7684\u5b58\u6d3b\u63a2\u9488\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e00\u4e2a liveness \u955c\u50cf\u6765\u9a8c\u8bc1\u6f14\u793a\u4e0b\uff1a\uff08liveness-http.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: liveness-http\nspec:\n  containers:\n  - name: liveness\n    image: cnych/liveness\n    args:\n    - /server\n    livenessProbe:\n      httpGet:\n        path: /healthz\n        port: 8080\n        httpHeaders:\n        - name: X-Custom-Header\n          value: Awesome\n      initialDelaySeconds: 3\n      periodSeconds: 3\n</code></pre> <p>\u540c\u6837\u7684\uff0c\u6839\u636e periodSeconds \u5c5e\u6027\u6211\u4eec\u53ef\u4ee5\u77e5\u9053 kubelet \u9700\u8981\u6bcf\u96943\u79d2\u6267\u884c\u4e00\u6b21 liveness Probe\uff0c\u8be5\u63a2\u9488\u5c06\u5411\u5bb9\u5668\u4e2d\u7684 server \u7684 8080 \u7aef\u53e3\u53d1\u9001\u4e00\u4e2a HTTP GET \u8bf7\u6c42\u3002\u5982\u679c server \u7684 /healthz \u8def\u5f84\u7684 handler \u8fd4\u56de\u4e00\u4e2a\u6210\u529f\u7684\u8fd4\u56de\u7801\uff0ckubelet \u5c31\u4f1a\u8ba4\u5b9a\u8be5\u5bb9\u5668\u662f\u6d3b\u7740\u7684\u5e76\u4e14\u5f88\u5065\u5eb7\uff0c\u5982\u679c\u8fd4\u56de\u5931\u8d25\u7684\u8fd4\u56de\u7801\uff0ckubelet \u5c06\u6740\u6389\u8be5\u5bb9\u5668\u5e76\u91cd\u542f\u5b83\u3002initialDelaySeconds \u6307\u5b9akubelet \u5728\u8be5\u6267\u884c\u7b2c\u4e00\u6b21\u63a2\u6d4b\u4e4b\u524d\u9700\u8981\u7b49\u5f853\u79d2\u949f\u3002</p> <p>\u8fd4\u56de\u7801</p> <p>\u901a\u5e38\u6765\u8bf4\uff0c\u4efb\u4f55\u5927\u4e8e<code>200</code>\u5c0f\u4e8e<code>400</code>\u7684\u72b6\u6001\u7801\u90fd\u4f1a\u8ba4\u5b9a\u662f\u6210\u529f\u7684\u8fd4\u56de\u7801\u3002\u5176\u4ed6\u8fd4\u56de\u7801\u90fd\u4f1a\u88ab\u8ba4\u4e3a\u662f\u5931\u8d25\u7684\u8fd4\u56de\u7801\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u6765\u67e5\u770b\u4e0b\u4e0a\u9762\u7684 healthz \u7684\u5b9e\u73b0\uff1a</p> <pre><code>http.HandleFunc(\"/healthz\", func(w http.ResponseWriter, r *http.Request) {\n    duration := time.Now().Sub(started)\n    if duration.Seconds() &gt; 10 {\n        w.WriteHeader(500)\n        w.Write([]byte(fmt.Sprintf(\"error: %v\", duration.Seconds())))\n    } else {\n        w.WriteHeader(200)\n        w.Write([]byte(\"ok\"))\n    }\n})\n</code></pre> <p>\u5927\u6982\u610f\u601d\u5c31\u662f\u6700\u5f00\u59cb\u524d 10s \u8fd4\u56de\u72b6\u6001\u7801200\uff0c10s \u8fc7\u540e\u5c31\u8fd4\u56de\u72b6\u6001\u7801500\u3002\u6240\u4ee5\u5f53\u5bb9\u5668\u542f\u52a83\u79d2\u540e\uff0ckubelet \u5f00\u59cb\u6267\u884c\u5065\u5eb7\u68c0\u67e5\u3002\u7b2c\u4e00\u6b21\u5065\u5eb7\u68c0\u67e5\u4f1a\u6210\u529f\uff0c\u56e0\u4e3a\u662f\u5728 10s \u4e4b\u5185\uff0c\u4f46\u662f 10 \u79d2\u540e\uff0c\u5065\u5eb7\u68c0\u67e5\u5c06\u5931\u8d25\uff0c\u56e0\u4e3a\u73b0\u5728\u8fd4\u56de\u7684\u662f\u4e00\u4e2a\u9519\u8bef\u7684\u72b6\u6001\u7801\u4e86\uff0c\u6240\u4ee5 kubelet \u5c06\u4f1a\u6740\u6389\u548c\u91cd\u542f\u5bb9\u5668\u3002</p> <p>\u540c\u6837\u7684\uff0c\u6211\u4eec\u6765\u521b\u5efa\u4e0b\u8be5 Pod \u6d4b\u8bd5\u4e0b\u6548\u679c\uff0c10 \u79d2\u540e\uff0c\u67e5\u770b Pod \u7684 event\uff0c\u786e\u8ba4 liveness probe \u5931\u8d25\u5e76\u91cd\u542f\u4e86\u5bb9\u5668\uff1a</p> <pre><code>$ kubectl apply -f liveness-http.yaml\n$ kubectl describe pod liveness-http\n......\n Normal   Pulled     12s (x3 over 76s)  kubelet, ydzs-node1  Successfully pulled image \"cnych/liveness\"\n  Normal   Created    12s (x3 over 76s)  kubelet, ydzs-node1  Created container liveness\n  Normal   Started    11s (x3 over 76s)  kubelet, ydzs-node1  Started container liveness\n......\n Normal   Pulling    15s (x4 over 102s)  kubelet, ydzs-node1  Pulling image \"cnych/liveness\"\n  Warning  Unhealthy  15s (x9 over 87s)   kubelet, ydzs-node1  Liveness probe failed: HTTP probe failed with statuscode: 500\n  Normal   Killing    15s (x3 over 81s)   kubelet, ydzs-node1  Container liveness failed liveness probe, will be restarted\n......\n$ kubectl get pods\nNAME            READY   STATUS             RESTARTS   AGE\nliveness-http   1/1     Running            3          2m2s\n</code></pre> <p>\u9664\u4e86\u4e0a\u9762\u7684 <code>exec</code> \u548c <code>httpGet</code> \u4e24\u79cd\u68c0\u6d4b\u65b9\u5f0f\u4e4b\u5916\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7 <code>tcpSocket</code> \u65b9\u5f0f\u6765\u68c0\u6d4b\u7aef\u53e3\u662f\u5426\u6b63\u5e38\uff0c\u5927\u5bb6\u53ef\u4ee5\u6309\u7167\u4e0a\u9762\u7684\u65b9\u5f0f\u7ed3\u5408<code>kubectl explain</code>\u547d\u4ee4\u81ea\u5df1\u6765\u9a8c\u8bc1\u4e0b\u8fd9\u79cd\u65b9\u5f0f\u3002</p> <p>\u53e6\u5916\u524d\u9762\u6211\u4eec\u63d0\u5230\u4e86\u63a2\u9488\u91cc\u9762\u6709\u4e00\u4e2a<code>initialDelaySeconds</code>\u7684\u5c5e\u6027\uff0c\u53ef\u4ee5\u6765\u914d\u7f6e\u7b2c\u4e00\u6b21\u6267\u884c\u63a2\u9488\u7684\u7b49\u5f85\u65f6\u95f4\uff0c\u5bf9\u4e8e\u542f\u52a8\u975e\u5e38\u6162\u7684\u5e94\u7528\u8fd9\u4e2a\u53c2\u6570\u975e\u5e38\u6709\u7528\uff0c\u6bd4\u5982 <code>Jenkins</code>\u3001<code>Gitlab</code> \u8fd9\u7c7b\u5e94\u7528\uff0c\u4f46\u662f\u5982\u4f55\u8bbe\u7f6e\u4e00\u4e2a\u5408\u9002\u7684\u521d\u59cb\u5ef6\u8fdf\u65f6\u95f4\u5462\uff1f\u8fd9\u4e2a\u5c31\u548c\u5e94\u7528\u5177\u4f53\u7684\u73af\u5883\u6709\u5173\u7cfb\u4e86\uff0c\u6240\u4ee5\u8fd9\u4e2a\u503c\u5f80\u5f80\u4e0d\u662f\u901a\u7528\u7684\uff0c\u8fd9\u6837\u7684\u8bdd\u53ef\u80fd\u5c31\u4f1a\u5bfc\u81f4\u4e00\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u7684\u8d44\u6e90\u6e05\u5355\u5728\u522b\u7684\u73af\u5883\u4e0b\u53ef\u80fd\u5c31\u4f1a\u5065\u5eb7\u68c0\u67e5\u5931\u8d25\u4e86\uff0c\u4e3a\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5728 Kubernetes v1.26 \u7248\u672c\u5b98\u65b9\u7279\u5730\u65b0\u589e\u4e86\u4e00\u4e2a <code>startupProbe\uff08\u542f\u52a8\u63a2\u9488\uff09</code>\uff0c\u8be5\u63a2\u9488\u5c06\u63a8\u8fdf\u6240\u6709\u5176\u4ed6\u63a2\u9488\uff0c\u76f4\u5230 Pod \u5b8c\u6210\u542f\u52a8\u4e3a\u6b62\uff0c\u4f7f\u7528\u65b9\u6cd5\u548c\u5b58\u6d3b\u63a2\u9488\u4e00\u6837\uff1a</p> <pre><code>startupProbe:\n  httpGet:\n    path: /healthz\n    port: 8080\n  failureThreshold: 30  # \u5c3d\u91cf\u8bbe\u7f6e\u5927\u70b9\n  periodSeconds: 10\n</code></pre> <p>\u6bd4\u5982\u4e0a\u9762\u8fd9\u91cc\u7684\u914d\u7f6e\u8868\u793a\u6211\u4eec\u7684\u6162\u901f\u5bb9\u5668\u6700\u591a\u53ef\u4ee5\u67095\u5206\u949f\uff0830\u4e2a\u68c0\u67e5 * 10\u79d2= 300s\uff09\u6765\u5b8c\u6210\u542f\u52a8\u3002</p> <p>\u6709\u7684\u65f6\u5019\uff0c\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u6682\u65f6\u65e0\u6cd5\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u4f8b\u5982\uff0c\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u9700\u8981\u5728\u542f\u52a8\u671f\u95f4\u52a0\u8f7d\u5927\u91cf\u6570\u636e\u6216\u914d\u7f6e\u6587\u4ef6\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u60a8\u4e0d\u60f3\u6740\u6b7b\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e5f\u4e0d\u60f3\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u3002\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528<code>readiness probe</code>\u6765\u68c0\u6d4b\u548c\u51cf\u8f7b\u8fd9\u4e9b\u60c5\u51b5\u3002 Pod \u4e2d\u7684\u5bb9\u5668\u53ef\u4ee5\u62a5\u544a\u81ea\u5df1\u8fd8\u6ca1\u6709\u51c6\u5907\uff0c\u4e0d\u80fd\u5904\u7406 Kubernetes \u670d\u52a1\u53d1\u9001\u8fc7\u6765\u7684\u6d41\u91cf\u3002<code>readiness probe</code>\u7684\u914d\u7f6e\u8ddf<code>liveness probe</code>\u57fa\u672c\u4e0a\u4e00\u81f4\u7684\u3002\u552f\u4e00\u7684\u4e0d\u540c\u662f\u4f7f\u7528<code>readinessProbe</code>\u800c\u4e0d\u662f<code>livenessProbe</code>\u3002\u4e24\u8005\u5982\u679c\u540c\u65f6\u4f7f\u7528\u7684\u8bdd\u5c31\u53ef\u4ee5\u786e\u4fdd\u6d41\u91cf\u4e0d\u4f1a\u5230\u8fbe\u8fd8\u672a\u51c6\u5907\u597d\u7684\u5bb9\u5668\uff0c\u51c6\u5907\u597d\u8fc7\u540e\uff0c\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u51fa\u73b0\u4e86\u9519\u8bef\uff0c\u5219\u4f1a\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\u3002\u5bf9\u4e8e\u5c31\u7eea\u63a2\u9488\u6211\u4eec\u4f1a\u5728\u540e\u9762 Service \u7684\u7ae0\u8282\u548c\u5927\u5bb6\u7ee7\u7eed\u4ecb\u7ecd\u3002</p> <p>\u53e6\u5916\u9664\u4e86\u4e0a\u9762\u7684<code>initialDelaySeconds</code>\u548c<code>periodSeconds</code>\u5c5e\u6027\u5916\uff0c\u63a2\u9488\u8fd8\u53ef\u4ee5\u914d\u7f6e\u5982\u4e0b\u51e0\u4e2a\u53c2\u6570\uff1a</p> <ul> <li>timeoutSeconds\uff1a\u63a2\u6d4b\u8d85\u65f6\u65f6\u95f4\uff0c\u9ed8\u8ba41\u79d2\uff0c\u6700\u5c0f1\u79d2\u3002</li> <li>successThreshold\uff1a\u63a2\u6d4b\u5931\u8d25\u540e\uff0c\u6700\u5c11\u8fde\u7eed\u63a2\u6d4b\u6210\u529f\u591a\u5c11\u6b21\u624d\u88ab\u8ba4\u5b9a\u4e3a\u6210\u529f\u3002\u9ed8\u8ba4\u662f 1\uff0c\u4f46\u662f\u5982\u679c\u662f<code>liveness</code>\u5219\u5fc5\u987b\u662f 1\u3002\u6700\u5c0f\u503c\u662f 1\u3002</li> <li>failureThreshold\uff1a\u63a2\u6d4b\u6210\u529f\u540e\uff0c\u6700\u5c11\u8fde\u7eed\u63a2\u6d4b\u5931\u8d25\u591a\u5c11\u6b21\u624d\u88ab\u8ba4\u5b9a\u4e3a\u5931\u8d25\u3002\u9ed8\u8ba4\u662f 3\uff0c\u6700\u5c0f\u503c\u662f 1\u3002</li> </ul>"},{"location":"kubernetes_basic/pod_life/#pod_3","title":"Pod \u8d44\u6e90\u914d\u7f6e","text":"<p>\u5b9e\u9645\u4e0a\u4e0a\u9762\u51e0\u4e2a\u6b65\u9aa4\u5c31\u662f\u5f71\u54cd\u4e00\u4e2a Pod \u751f\u547d\u5468\u671f\u7684\u5927\u7684\u90e8\u5206\uff0c\u4f46\u662f\u8fd8\u6709\u4e00\u4e9b\u7ec6\u8282\u4e5f\u4f1a\u5728 Pod \u7684\u542f\u52a8\u8fc7\u7a0b\u8fdb\u884c\u8bbe\u7f6e\uff0c\u6bd4\u5982\u5728\u5bb9\u5668\u542f\u52a8\u4e4b\u524d\u8fd8\u4f1a\u4e3a\u5f53\u524d\u7684\u5bb9\u5668\u8bbe\u7f6e\u5206\u914d\u7684 CPU\u3001\u5185\u5b58\u7b49\u8d44\u6e90\uff0c\u6211\u4eec\u77e5\u9053\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 CGroup \u6765\u5bf9\u5bb9\u5668\u7684\u8d44\u6e90\u8fdb\u884c\u9650\u5236\uff0c\u540c\u6837\u7684\uff0c\u5728 Pod \u4e2d\u6211\u4eec\u4e5f\u53ef\u4ee5\u76f4\u63a5\u914d\u7f6e\u67d0\u4e2a\u5bb9\u5668\u7684\u4f7f\u7528\u7684 CPU \u6216\u8005\u5185\u5b58\u7684\u4e0a\u9650\u3002\u90a3\u4e48 Pod \u662f\u5982\u4f55\u6765\u4f7f\u7528\u548c\u63a7\u5236\u8fd9\u4e9b\u8d44\u6e90\u7684\u5206\u914d\u7684\u5462\uff1f</p> <p>\u9996\u5148\u5bf9\u4e8e CPU\uff0c\u6211\u4eec\u77e5\u9053\u8ba1\u7b97\u673a\u91cc CPU \u7684\u8d44\u6e90\u662f\u6309<code>\u65f6\u95f4\u7247</code>\u7684\u65b9\u5f0f\u6765\u8fdb\u884c\u5206\u914d\u7684\uff0c\u7cfb\u7edf\u91cc\u7684\u6bcf\u4e00\u4e2a\u64cd\u4f5c\u90fd\u9700\u8981 CPU \u7684\u5904\u7406\uff0c\u6240\u4ee5\uff0c\u54ea\u4e2a\u4efb\u52a1\u8981\u662f\u7533\u8bf7\u7684 CPU \u65f6\u95f4\u7247\u8d8a\u591a\uff0c\u90a3\u4e48\u5b83\u5f97\u5230\u7684 CPU \u8d44\u6e90\u5c31\u8d8a\u591a\uff0c\u8fd9\u4e2a\u5f88\u5bb9\u5668\u7406\u89e3\u3002</p> <p>\u7136\u540e\u8fd8\u9700\u8981\u4e86\u89e3\u4e0b CGroup \u91cc\u9762\u5bf9\u4e8e CPU \u8d44\u6e90\u7684\u5355\u4f4d\u6362\u7b97\uff1a</p> <pre><code>1 CPU =  1000 millicpu\uff081 Core = 1000m\uff09\n\n5 CPU = 500 millicpu \uff085 Core = 500m\uff09\n</code></pre> <p>\u8fd9\u91cc\u7684 <code>m</code> \u5c31\u662f\u6beb\u3001\u6beb\u6838\u7684\u610f\u601d\uff0cKubernetes \u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e00\u4e2a\u8282\u70b9\u53ef\u4ee5\u901a\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u7684\u547d\u4ee4\u6765\u786e\u8ba4\u672c\u8282\u70b9\u7684 CPU \u5185\u6838\u6570\u91cf\uff0c\u7136\u540e\u5c06\u8fd9\u4e2a\u6570\u91cf\u4e58\u4ee51000\uff0c\u5f97\u5230\u7684\u5c31\u662f\u8282\u70b9\u603b CPU \u603b\u6beb\u6570\u3002\u6bd4\u5982\u4e00\u4e2a\u8282\u70b9\u6709\u56db\u6838\uff0c\u90a3\u4e48\u8be5\u8282\u70b9\u7684 CPU \u603b\u6beb\u91cf\u4e3a 4000m\uff0c\u5982\u679c\u4f60\u8981\u4f7f\u75280.5 core\uff0c\u5219\u4f60\u8981\u6c42\u7684\u662f 4000*0.5 = 2000m\u3002\u5728 Pod \u91cc\u9762\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u4e24\u4e2a\u53c2\u6570\u6765\u73b0\u5728\u548c\u8bf7\u6c42 CPU \u8d44\u6e90\uff1a</p> <ul> <li> <p><code>spec.containers[].resources.limits.cpu</code></p> <p>\uff1aCPU \u4e0a\u9650\u503c\uff0c\u53ef\u4ee5\u77ed\u6682\u8d85\u8fc7\uff0c\u5bb9\u5668\u4e5f\u4e0d\u4f1a\u88ab\u505c\u6b62 *   <code>spec.containers[].resources.requests.cpu</code></p> <p>\uff1aCPU\u8bf7\u6c42\u503c\uff0cKubernetes \u8c03\u5ea6\u7b97\u6cd5\u91cc\u7684\u4f9d\u636e\u503c\uff0c\u53ef\u4ee5\u8d85\u8fc7</p> </li> </ul> <p>\u8fd9\u91cc\u9700\u8981\u660e\u767d\u7684\u662f\uff0c\u5982\u679c</p> <pre><code>resources.requests.cpu\n</code></pre> <p>\u8bbe\u7f6e\u7684\u503c\u5927\u4e8e\u96c6\u7fa4\u91cc\u6bcf\u4e2a\u8282\u70b9\u7684\u6700\u5927 CPU \u6838\u5fc3\u6570\uff0c\u90a3\u4e48\u8fd9\u4e2a Pod \u5c06\u65e0\u6cd5\u8c03\u5ea6\uff0c\u56e0\u4e3a\u6ca1\u6709\u8282\u70b9\u80fd\u6ee1\u8db3\u5b83\u3002</p> <p>\u5230\u8fd9\u91cc\u5e94\u8be5\u660e\u767d\u4e86\uff0c<code>requests</code> \u662f\u7528\u4e8e\u96c6\u7fa4\u8c03\u5ea6\u4f7f\u7528\u7684\u8d44\u6e90\uff0c\u800c <code>limits</code> \u624d\u662f\u771f\u6b63\u7684\u7528\u4e8e\u8d44\u6e90\u9650\u5236\u7684\u914d\u7f6e\uff0c\u5982\u679c\u4f60\u9700\u8981\u4fdd\u8bc1\u7684\u4f60\u5e94\u7528\u4f18\u5148\u7ea7\u5f88\u9ad8\uff0c\u4e5f\u5c31\u662f\u8d44\u6e90\u5403\u7d27\u7684\u60c5\u51b5\u4e0b\u6700\u540e\u518d\u6740\u6389\u4f60\u7684 Pod\uff0c\u90a3\u4e48\u4f60\u5c31\u628a\u4f60\u7684 requests \u548c limits \u7684\u503c\u8bbe\u7f6e\u6210\u4e00\u81f4\uff0c\u5728\u540e\u9762\u5e94\u7528\u7684 <code>Qos</code> \u4e2d\u4f1a\u5177\u4f53\u8bb2\u89e3\u3002</p> <p>\u6bd4\u5982\uff0c\u73b0\u5728\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a Pod\uff0c\u7ed9\u5bb9\u5668\u7684\u914d\u7f6e\u5982\u4e0b\u7684\u8d44\u6e90\uff1a\uff08pod-resource-demo1.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: resource-demo1\nspec:\n  containers:\n  - name: resource-demo1\n    image: nginx\n    ports:\n    - containerPort: 80\n    resources:\n      requests:\n        memory: 50Mi\n        cpu: 50m\n      limits:\n        memory: 100Mi\n        cpu: 100m\n</code></pre> <p>\u8fd9\u91cc\uff0cCPU \u6211\u4eec\u7ed9\u7684\u662f 50m\uff0c\u4e5f\u5c31\u662f 0.05core\uff0c\u8fd9 0.05 core \u4e5f\u5c31\u662f\u5360\u4e86 1 CPU \u91cc\u7684 5% \u7684\u8d44\u6e90\u65f6\u95f4\u3002\u800c\u9650\u5236\u8d44\u6e90\u662f\u7ed9\u7684\u662f 100m\uff0c\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f CPU \u8d44\u6e90\u662f\u53ef\u538b\u7f29\u8d44\u6e90\uff0c\u4e5f\u5c31\u662f\u5bb9\u5668\u8fbe\u5230\u4e86\u8fd9\u4e2a\u8bbe\u5b9a\u7684\u4e0a\u9650\u540e\uff0c\u5bb9\u5668\u6027\u80fd\u4f1a\u4e0b\u964d\uff0c\u4f46\u662f\u4e0d\u4f1a\u7ec8\u6b62\u6216\u9000\u51fa\u3002\u6bd4\u5982\u6211\u4eec\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl apply -f pod-resource-demoyaml\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pod \u88ab\u8c03\u5ea6\u5230 node3 \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff1a</p> <pre><code>$ kubectl get pods -o wide\nNAME             READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES\nresource-demo1   1/1     Running   0          12m   258    ydzs-node3   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5230 node3 \u8282\u70b9\u4e0a\u53bb\u67e5\u770b Pod \u91cc\u9762\u542f\u52a8\u7684 <code>resource-demo1</code> \u8fd9\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>$ docker ps |grep resource-demo1\nc9e654d573fd        nginx                                      \"nginx -g 'daemon of\u2026\"   14 minutes ago      Up 14 minutes                           k8s_resource-demo1_resource-demo1_default_020bc461-170a-4936-9c22-7c8516972d39_0\n37ab54a2490a        gcr.azk8s.cn/google_containers/pause:1   \"/pause\"                 14 minutes ago      Up 14 minutes                           k8s_POD_resource-demo1_default_020bc461-170a-4936-9c22-7c8516972d39_0\n</code></pre> <p>\u5176\u4e2d\u7b2c\u4e00\u4e2a\u5bb9\u5668\u5c31\u662f\u6211\u4eec\u7684\u4e3b\u5bb9\u5668\uff0c\u7b2c\u4e8c\u5bb9\u5668\u662f Infra \u5bb9\u5668\uff0c\u6211\u4eec\u53ef\u4ee5\u53bb\u67e5\u770b\u4e0b\u4e3b\u5bb9\u5668\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ docker inspect c9e654d573fd\n......\n\"CpuShares\": 51,\n\"Memory\": 104857600,\n\"NanoCpus\": 0,\n\"CgroupParent\": \"kubepods-burstable-pod020bc461_170a_4936_9c22_7c8516972dslice\",\n\"BlkioWeight\": 0,\n\"BlkioWeightDevice\": null,\n\"BlkioDeviceReadBps\": null,\n\"BlkioDeviceWriteBps\": null,\n\"BlkioDeviceReadIOps\": null,\n\"BlkioDeviceWriteIOps\": null,\n\"CpuPeriod\": 100000,\n\"CpuQuota\": 10000,\n\"CpuRealtimePeriod\": 0,\n\"CpuRealtimeRuntime\": 0,\n\"CpusetCpus\": \"\",\n\"CpusetMems\": \"\",\n\"Devices\": [],\n\"DeviceCgroupRules\": null,\n\"DiskQuota\": 0,\n\"KernelMemory\": 0,\n\"MemoryReservation\": 0,\n\"MemorySwap\": 104857600,\n\"MemorySwappiness\": null,\n\"OomKillDisable\": false,\n......\n</code></pre> <p>\u5b9e\u9645\u4e0a\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u5bb9\u5668\u7684\u4e00\u4e9b\u8d44\u6e90\u60c5\u51b5\uff0cPod \u4e0a\u7684\u8d44\u6e90\u914d\u7f6e\u6700\u7ec8\u4e5f\u8fd8\u662f\u901a\u8fc7\u5e95\u5c42\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\u53bb\u63a7\u5236 CGroup \u6765\u5b9e\u73b0\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u8fdb\u5165\u5982\u4e0b\u76ee\u5f55\u67e5\u770b CGroup \u7684\u914d\u7f6e\uff0c\u8be5\u76ee\u5f55\u5c31\u662f CGroup \u7236\u7ea7\u76ee\u5f55\uff0c\u800c CGroup \u662f\u901a\u8fc7\u6587\u4ef6\u7cfb\u7edf\u6765\u8fdb\u884c\u8d44\u6e90\u9650\u5236\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u4e0a\u9762\u9650\u5236\u5bb9\u5668\u7684\u8d44\u6e90\u5c31\u53ef\u4ee5\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u53cd\u6620\u51fa\u6765\uff1a</p> <pre><code>$ cd /sys/fs/cgroup/cpu/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod020bc461_170a_4936_9c22_7c8516972dslice\n$ ls\ncgroup.clone_children  cpu.cfs_period_us  docker-37ab54a2490a48c88918f53572e053784238bf3720cb1ae5bf01052040aba9ascope\ncgroup.event_control   cpu.cfs_quota_us   docker-c9e654d573fd3e3e9a8bb78f3f904e60a59aa3384b344117fd401529e982aescope\ncgroup.procs           cpu.rt_period_us   notify_on_release\ncpuacct.stat           cpu.rt_runtime_us  tasks\ncpuacct.usage          cpu.shares\ncpuacct.usage_percpu   cpu.stat\n$ cat cpu.cfs_quota_us\n10000\n</code></pre> <p>\u5176\u4e2d <code>cpu.cfs_quota_us</code> \u5c31\u662f CPU \u7684\u9650\u5236\u503c\uff0c\u5982\u679c\u8981\u67e5\u770b\u5177\u4f53\u7684\u5bb9\u5668\u7684\u8d44\u6e90\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u8fdb\u5165\u5230\u5bb9\u5668\u76ee\u5f55\u4e0b\u9762\u53bb\u67e5\u770b\u5373\u53ef\u3002</p> <p>\u6700\u540e\u6211\u4eec\u4e86\u89e3\u4e0b\u5185\u5b58\u8fd9\u5757\u7684\u8d44\u6e90\u63a7\u5236\uff0c\u5185\u5b58\u7684\u5355\u4f4d\u6362\u7b97\u6bd4\u8f83\u7b80\u5355\uff1a</p> <p><code>1 MiB = 1024 KiB</code>\uff0c\u5185\u5b58\u8fd9\u5757\u5728 Kubernetes \u91cc\u4e00\u822c\u7528\u7684\u662f<code>Mi</code>\u5355\u4f4d\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528<code>Ki\u3001Gi</code>\u751a\u81f3<code>Pi</code>\uff0c\u770b\u5177\u4f53\u7684\u4e1a\u52a1\u9700\u6c42\u548c\u8d44\u6e90\u5bb9\u91cf\u3002</p> <p>\u5355\u4f4d\u6362\u7b97</p> <p>\u8fd9\u91cc\u6ce8\u610f\u7684\u662f<code>MiB \u2260 MB</code>\uff0cMB \u662f\u5341\u8fdb\u5236\u5355\u4f4d\uff0cMiB \u662f\u4e8c\u8fdb\u5236\uff0c\u5e73\u65f6\u6211\u4eec\u4ee5\u4e3a MB \u7b49\u4e8e 1024KB\uff0c\u5176\u5b9e<code>1MB=1000KB</code>\uff0c<code>1MiB</code>\u624d\u7b49\u4e8e<code>1024KiB</code>\u3002\u4e2d\u95f4\u5e26\u5b57\u6bcd i \u7684\u662f\u56fd\u9645\u7535\u5de5\u534f\u4f1a\uff08IEC\uff09\u5b9a\u7684\uff0c\u8d701024\u4e58\u79ef\uff1bKB\u3001MB\u3001GB\u662f\u56fd\u9645\u5355\u4f4d\u5236\uff0c\u8d701000\u4e58\u79ef\u3002</p> <p>\u8fd9\u91cc\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5185\u5b58\u662f\u53ef\u538b\u7f29\u6027\u8d44\u6e90\uff0c\u5982\u679c\u5bb9\u5668\u4f7f\u7528\u5185\u5b58\u8d44\u6e90\u5230\u8fbe\u4e86\u4e0a\u9650\uff0c\u90a3\u4e48\u4f1a<code>OOM</code>\uff0c\u9020\u6210\u5185\u5b58\u6ea2\u51fa\uff0c\u5bb9\u5668\u5c31\u4f1a\u7ec8\u6b62\u548c\u9000\u51fa\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u7684\u65b9\u5f0f\u53bb\u901a\u8fc7\u67e5\u770b CGroup \u6587\u4ef6\u7684\u503c\u6765\u9a8c\u8bc1\u8d44\u6e90\u9650\u5236\u3002</p>"},{"location":"kubernetes_basic/yaml/","title":"\u8d44\u6e90\u6e05\u5355","text":""},{"location":"kubernetes_basic/yaml/#yaml","title":"YAML \u6587\u4ef6","text":"<p>YAML \u6587\u4ef6\u57fa\u672c\u8bed\u6cd5\u683c\u5f0f</p> <p>\u524d\u9762\u6211\u4eec\u5f97 Kubernetes \u96c6\u7fa4\u5df2\u7ecf\u642d\u5efa\u6210\u529f\u4e86\uff0c\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u96c6\u7fa4\u91cc\u9762\u6765\u8dd1\u6211\u4eec\u7684\u5e94\u7528\u4e86\u3002\u8981\u5728\u96c6\u7fa4\u91cc\u9762\u8fd0\u884c\u6211\u4eec\u81ea\u5df1\u7684\u5e94\u7528\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u77e5\u9053\u51e0\u4e2a\u6982\u5ff5\u3002</p> <p>\u7b2c\u4e00\u4e2a\u5f53\u7136\u5c31\u662f\u5e94\u7528\u7684\u955c\u50cf\uff0c\u56e0\u4e3a\u6211\u4eec\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684\u662f\u5bb9\u5668\uff0c\u6240\u4ee5\u9996\u5148\u9700\u8981\u5c06\u6211\u4eec\u7684\u5e94\u7528\u6253\u5305\u6210\u955c\u50cf\uff0c\u524d\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u8fc7\u5982\u4f55\u5c06\u5e94\u7528\u6253\u5305\u6210\u955c\u50cf\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u8d58\u8ff0\u4e86\u3002</p> <p>\u955c\u50cf\u51c6\u5907\u597d\u4e86\uff0cKubernetes \u96c6\u7fa4\u4e5f\u51c6\u5907\u597d\u4e86\uff0c\u5176\u5b9e\u6211\u4eec\u5c31\u53ef\u4ee5\u628a\u6211\u4eec\u7684\u5e94\u7528\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\u4e86\u3002\u4f46\u662f\u955c\u50cf\u5230\u96c6\u7fa4\u4e2d\u8fd0\u884c\u8fd9\u4e2a\u8fc7\u7a0b\u5982\u4f55\u5b8c\u6210\u5462\uff1f\u5fc5\u7136\u6709\u4e00\u4e2a\u5730\u65b9\u53ef\u4ee5\u6765\u63cf\u8ff0\u6211\u4eec\u7684\u5e94\u7528\uff0c\u7136\u540e\u628a\u8fd9\u4efd\u63cf\u8ff0\u544a\u8bc9\u96c6\u7fa4\uff0c\u7136\u540e\u96c6\u7fa4\u6309\u7167\u8fd9\u4e2a\u63cf\u8ff0\u6765\u90e8\u7f72\u5e94\u7528\u3002</p> <p>\u5728\u4e4b\u524d Docker \u73af\u5883\u4e0b\u9762\u6211\u4eec\u662f\u76f4\u63a5\u901a\u8fc7\u547d\u4ee4 <code>docker run</code> \u6765\u8fd0\u884c\u6211\u4eec\u7684\u5e94\u7528\u7684\uff0c\u5728 Kubernetes \u73af\u5883\u4e0b\u9762\u6211\u4eec\u540c\u6837\u4e5f\u53ef\u4ee5\u7528\u7c7b\u4f3c <code>kubectl run</code> \u8fd9\u6837\u7684\u547d\u4ee4\u6765\u8fd0\u884c\u6211\u4eec\u7684\u5e94\u7528\uff0c\u4f46\u662f\u5728 Kubernetes \u4e2d\u5374\u662f\u4e0d\u63a8\u8350\u4f7f\u7528\u547d\u4ee4\u884c\u7684\u65b9\u5f0f\uff0c\u800c\u662f\u5e0c\u671b\u4f7f\u7528\u6211\u4eec\u79f0\u4e3a<code>\u8d44\u6e90\u6e05\u5355</code>\u7684\u4e1c\u897f\u6765\u63cf\u8ff0\u5e94\u7528\uff0c\u8d44\u6e90\u6e05\u5355\u53ef\u4ee5\u7528 YAML \u6216\u8005 JSON \u6587\u4ef6\u6765\u7f16\u5199\uff0c\u4e00\u822c\u6765\u8bf4 YAML \u6587\u4ef6\u66f4\u65b9\u4fbf\u9605\u8bfb\u548c\u7406\u89e3\uff0c\u6240\u4ee5\u6211\u4eec\u7684\u8bfe\u7a0b\u4e2d\u90fd\u4f1a\u4f7f\u7528 YAML \u6587\u4ef6\u6765\u8fdb\u884c\u63cf\u8ff0\u3002</p> <p>\u901a\u8fc7\u4e00\u4e2a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u6765\u5b9a\u4e49\u597d\u4e00\u4e2a\u5e94\u7528\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 kubectl \u5de5\u5177\u6765\u76f4\u63a5\u8fd0\u884c\u5b83\uff1a</p> <pre><code>$ kubectl create -f xxxx.yaml\n</code></pre> <p>\u6211\u4eec\u77e5\u9053 kubectl \u662f\u76f4\u63a5\u64cd\u4f5c APIServer \u7684\uff0c\u6240\u4ee5\u5c31\u76f8\u5f53\u4e8e\u628a\u6211\u4eec\u7684\u6e05\u5355\u63d0\u4ea4\u7ed9\u4e86 APIServer\uff0c\u7136\u540e\u96c6\u7fa4\u83b7\u53d6\u5230\u6e05\u5355\u63cf\u8ff0\u7684\u5e94\u7528\u4fe1\u606f\u540e\u5b58\u5165\u5230 etcd \u6570\u636e\u5e93\u4e2d\uff0c\u7136\u540e kube-scheduler \u7ec4\u4ef6\u53d1\u73b0\u8fd9\u4e2a\u65f6\u5019\u6709\u4e00\u4e2a Pod \u8fd8\u6ca1\u6709\u7ed1\u5b9a\u5230\u8282\u70b9\u4e0a\uff0c\u5c31\u4f1a\u5bf9\u8fd9\u4e2a Pod \u8fdb\u884c\u4e00\u7cfb\u5217\u7684\u8c03\u5ea6\uff0c\u628a\u5b83\u8c03\u5ea6\u5230\u4e00\u4e2a\u6700\u5408\u9002\u7684\u8282\u70b9\u4e0a\uff0c\u7136\u540e\u628a\u8fd9\u4e2a\u8282\u70b9\u548c Pod \u7ed1\u5b9a\u5230\u4e00\u8d77\uff08\u5199\u56de\u5230 etcd\uff09\uff0c\u7136\u540e\u8282\u70b9\u4e0a\u7684 kubelet \u7ec4\u4ef6\u8fd9\u4e2a\u65f6\u5019 watch \u5230\u6709\u4e00\u4e2a Pod \u88ab\u5206\u914d\u8fc7\u6765\u4e86\uff0c\u5c31\u53bb\u628a\u8fd9\u4e2a Pod \u7684\u4fe1\u606f\u62c9\u53d6\u4e0b\u6765\uff0c\u7136\u540e\u6839\u636e\u63cf\u8ff0\u901a\u8fc7\u5bb9\u5668\u8fd0\u884c\u65f6\u628a\u5bb9\u5668\u521b\u5efa\u51fa\u6765\uff0c\u6700\u540e\u5f53\u7136\u540c\u6837\u628a Pod \u72b6\u6001\u518d\u5199\u56de\u5230 etcd \u4e2d\u53bb\uff0c\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u4e00\u6574\u4e2a\u7684\u521b\u5efa\u6d41\u7a0b\u3002</p>"},{"location":"kubernetes_basic/yaml/#_1","title":"\u7b2c\u4e00\u4e2a\u5bb9\u5668\u5316\u5e94\u7528","text":"<p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u901a\u8fc7 YAML \u6587\u4ef6\u7f16\u5199\u4e86\u4e00\u4e2a\u5982\u4e0b\u7684\u8d44\u6e90\u6e05\u5355\uff0c\u547d\u540d\u4e3a nginx-deployment.yaml\uff1a</p> <pre><code>apiVersion: apps/v1  # API\u7248\u672c\nkind: Deployment  # API\u5bf9\u8c61\u7c7b\u578b\nmetadata:\n  name: nginx-deploy\n  labels:\n    chapter: first-app\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  replicas: 2  # Pod \u526f\u672c\u6570\u91cf\n  template:  # Pod \u6a21\u677f\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - containerPort: 80\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u7528 kubectl \u547d\u4ee4\u6765\u521b\u5efa\u8fd9\u4e2a\u5e94\u7528\uff1a</p> <pre><code>$ kubectl create -f nginx-deployment.yaml\ndeployment.apps/nginx-deploy created\n$ kubectl get pods\nNAME                            READY   STATUS    RESTARTS   AGE\nnginx-deploy-54f57cf6bf-2fdjz   1/1     Running   0          7s\nnginx-deploy-54f57cf6bf-57287   1/1     Running   0          7s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4f1a\u5728\u96c6\u7fa4\u4e2d\u751f\u6210\u4e24\u4e2a Pod \u51fa\u6765\u3002\u800c\u6574\u4e2a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5bf9\u5e94\u5230 Kubernetes \u4e2d\u5c31\u662f\u4e00\u4e2a API Object\uff08API \u5bf9\u8c61\uff09\uff0c\u6211\u4eec\u6309\u7167\u8fd9\u4e9b\u5bf9\u8c61\u7684\u8981\u6c42\u586b\u5145\u4e0a\u5bf9\u5e94\u7684\u5c5e\u6027\u540e\uff0c\u63d0\u4ea4\u7ed9 Kubernetes \u96c6\u7fa4\uff0c\u5c31\u53ef\u4ee5\u4e3a\u6211\u4eec\u521b\u5efa\u51fa\u5bf9\u5e94\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u7684\u662f\u4e00\u4e2a Deployment \u7c7b\u578b\u7684 API \u5bf9\u8c61\uff0c\u6211\u4eec\u6309\u7167\u8fd9\u4e2a API \u5bf9\u8c61\u7684\u8981\u6c42\u586b\u5145\u4e86\u4e00\u4e9b\u5c5e\u6027\uff0c\u5c31\u4f1a\u4e3a\u6211\u4eec\u521b\u5efa\u51fa\u5bf9\u5e94\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u83b7\u53d6\uff1a</p> <pre><code>$ kubectl get deployment\nNAME           READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy   2/2     2            2           12m\n</code></pre> <p>Deployment \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5c31\u662f\u7528\u6765\u5b9a\u4e49\u591a\u526f\u672c\u5e94\u7528\u7684\u5bf9\u8c61\uff0c\u800c\u4e14\u8fd8\u652f\u6301\u5bf9\u6bcf\u4e2a\u526f\u672c\u8fdb\u884c\u6eda\u52a8\u66f4\u65b0\uff0c\u4e0a\u9762\u6211\u4eec\u7684\u8d44\u6e90\u6e05\u5355\u4e2d\u7684\u63cf\u8ff0\u4e2d\u6709\u4e00\u4e2a\u5c5e\u6027 <code>replicas: 2</code>\uff0c\u6240\u4ee5\u6700\u540e\u751f\u6210\u4e24\u4e2a\u526f\u672c\u7684 Pod\u3002</p> <p>\u800c\u8fd9\u4e2a Deployment \u5b9a\u4e49\u7684\u526f\u672c Pod \u5177\u4f53\u662f\u4ec0\u4e48\u6837\u7684\uff0c\u662f\u901a\u8fc7\u4e0b\u9762\u7684 Pod \u6a21\u677f\u6765\u5b9a\u4e49\u7684\uff0c\u5c31\u662f template \u4e0b\u9762\u7684\u5b9a\u4e49\uff0c\u8fd9\u4e2a\u6a21\u677f\u4e2d\u5b9a\u4e49\u4e86\u6211\u4eec\u7684 Pod \u4e2d\u53ea\u6709\u4e00\u4e2a\u540d\u4e3a nginx \u7684\u5bb9\u5668\uff0c\u5bb9\u5668\u4f7f\u7528\u7684\u955c\u50cf\u662f <code>nginx:1.7.9</code>\uff08spec.containers[0].image\uff09\uff0c\u5e76\u4e14\u8fd9\u4e2a\u5bb9\u5668\u76d1\u542c\u7684\u7aef\u53e3\u662f 80\uff08spec.containers[0].ports[0].containerPort\uff09\uff0c\u53e6\u5916\u6211\u4eec\u8fd8\u4e3a Pod \u6dfb\u52a0\u4e86\u4e00\u4e2a<code>app: nginx</code>\u8fd9\u6837\u7684 Label \u6807\u7b7e\uff0c\u8fd9\u91cc\u9700\u8981\u975e\u5e38\u6ce8\u610f\u7684\u662f\u4e0a\u9762\u7684 <code>selector.matchLabels</code> \u533a\u57df\u5c31\u662f\u6765\u8868\u793a\u6211\u4eec\u7684 Deployment \u6765\u7ba1\u7406\u54ea\u4e9b Pod \u7684\uff0c\u6240\u4ee5\u8fd9\u4e2a\u5730\u65b9\u9700\u8981\u548c Pod \u6a21\u677f\u4e2d\u7684 Label \u6807\u7b7e\u4fdd\u6301\u4e00\u81f4\uff0c\u8fd9\u4e2a Label \u6807\u7b7e\u4e4b\u524d\u6211\u4eec\u4e5f\u63d0\u5230\u8fc7\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002</p> <p>\u53e6\u5916\u6211\u4eec\u4e5f\u53ef\u4ee5\u53d1\u73b0\u6bcf\u4e2a API \u5bf9\u8c61\u90fd\u6709\u4e00\u4e2a <code>Metadata</code> \u7684\u5b57\u6bb5\uff0c\u7528\u6765\u8868\u793a\u8be5\u5bf9\u8c61\u7684\u5143\u6570\u636e\u7684\uff0c\u6bd4\u5982\u5b9a\u4e49 name\u3001namespace \u7b49\uff0c\u6bd4\u5982\u4e0a\u9762 Deployment \u548c Pod \u6a21\u677f\u4e2d\u90fd\u6709\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u81f3\u4e8e\u4e3a\u4ec0\u4e48 Pod \u6a21\u677f\u4e2d\u6ca1\u6709 name \u8fd9\u4e2a\u5143\u4fe1\u606f\u5462\uff0c\u8fd9\u662f\u56e0\u4e3a Deployment \u8fd9\u4e2a\u63a7\u5236\u5668\u4f1a\u81ea\u52a8\u5728\u4ed6\u81ea\u5df1\u7684 name \u57fa\u7840\u4e0a\u751f\u6210 Pod \u540d\uff0c\u4e0d\u8fc7 Deployment \u4e0b\u9762\u5b9a\u4e49\u7684 Label \u6807\u7b7e\u5c31\u6ca1\u6709 Pod \u4e2d\u5b9a\u4e49\u7684 Label \u6807\u7b7e\u90a3\u4e48\u91cd\u8981\u4e86\uff0c\u53ea\u662f\u8d77\u5230\u4e00\u4e2a\u5bf9\u8be5\u5bf9\u8c61\u6807\u8bc6\u548c\u8fc7\u6ee4\u7684\u4f5c\u7528\u3002\u6bd4\u5982\u6211\u4eec\u5728\u67e5\u8be2\u5bf9\u8c61\u7684\u65f6\u5019\u53ef\u4ee5\u5e26\u4e0a\u6807\u7b7e\u6765\u8fdb\u884c\u8fc7\u6ee4\uff1a</p> <pre><code>$ kubectl get deployment -l chapter=first-app\nNAME           READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy   2/2     2            2           51m\n$ kubectl get pods -l app=nginx\nNAME                            READY   STATUS    RESTARTS   AGE\nnginx-deploy-54f57cf6bf-2fdjz   1/1     Running   0          51m\nnginx-deploy-54f57cf6bf-57287   1/1     Running   0          51m\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u6211\u4eec\u7684\u7b2c\u4e00\u4e2a\u5e94\u7528\u7684\u5bb9\u5668\u5316\u90e8\u7f72\uff0c\u4f46\u662f\u5f80\u5f80\u6211\u4eec\u5728\u90e8\u7f72\u5e94\u7528\u7684\u8fc7\u7a0b\u4e2d\u6216\u591a\u6216\u5c11\u4f1a\u9047\u5230\u4e00\u4e9b\u95ee\u9898\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a <code>kubectl describe</code> \u547d\u4ee4\u6765\u67e5\u770b\u8d44\u6e90\u5bf9\u8c61\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u6bd4\u5982\u6211\u4eec\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b Pod \u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe pod nginx-deploy-54f57cf6bf-2fdjz\nName:         nginx-deploy-54f57cf6bf-2fdjz\nNamespace:    default\nPriority:     0\nNode:         ydzs-node2/123\nStart Time:   Sat, 09 Nov 2019 15:20:32 +0800\nLabels:       app=nginx\n              pod-template-hash=54f57cf6bf\nAnnotations:  &lt;none&gt;\nStatus:       Running\nIP:           2199\nIPs:\n  IP:           2199\nControlled By:  ReplicaSet/nginx-deploy-54f57cf6bf\nContainers:\n  nginx:\n    Container ID:   docker://e40e78eee7a431b6e7277b414967cce936ac750e2a8ba30298302cdd89e54300\n    Image:          nginx:9\n    Image ID:       docker-pullable://nginx@sha256:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451\n    Port:           80/TCP\n    Host Port:      0/TCP\n    State:          Running\n      Started:      Sat, 09 Nov 2019 15:20:35 +0800\n    Ready:          True\n    Restart Count:  0\n    Environment:    &lt;none&gt;\n    Mounts:\n      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5tsh4 (ro)\nConditions:\n  Type              Status\n  Initialized       True\n  Ready             True\n  ContainersReady   True\n  PodScheduled      True\nVolumes:\n  default-token-5tsh4:\n    Type:        Secret (a volume populated by a Secret)\n    SecretName:  default-token-5tsh4\n    Optional:    false\nQoS Class:       BestEffort\nNode-Selectors:  &lt;none&gt;\nTolerations:     node.kubernetes.io/not-ready:NoExecute for 300s\n                 node.kubernetes.io/unreachable:NoExecute for 300s\nEvents:\n  Type    Reason     Age        From                 Message\n  ----    ------     ----       ----                 -------\n  Normal  Scheduled  &lt;unknown&gt;  default-scheduler    Successfully assigned default/nginx-deploy-54f57cf6bf-2fdjz to ydzs-node2\n  Normal  Pulled     52m        kubelet, ydzs-node2  Container image \"nginx:9\" already present on machine\n  Normal  Created    52m        kubelet, ydzs-node2  Created container nginx\n  Normal  Started    52m        kubelet, ydzs-node2  Started container nginx\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u770b\u5230\u5f88\u591a\u8fd9\u4e2a Pod \u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u6bd4\u5982\u8c03\u5ea6\u5230\u7684\u8282\u70b9\u3001\u72b6\u6001\u3001IP \u7b49\uff0c\u4e00\u822c\u6211\u4eec\u6bd4\u8f83\u5173\u5fc3\u7684\u662f\u4e0b\u9762\u7684 <code>Events</code> \u90e8\u5206\uff0c\u5c31\u662f\u6211\u4eec\u8bf4\u7684<code>\u4e8b\u4ef6</code>\u3002</p> <p>\u5728 Kubernetes \u521b\u5efa\u8d44\u6e90\u5bf9\u8c61\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5bf9\u8be5\u5bf9\u8c61\u7684\u4e00\u4e9b\u91cd\u8981\u64cd\u4f5c\uff0c\u90fd\u4f1a\u88ab\u8bb0\u5f55\u5728\u8fd9\u4e2a\u5bf9\u8c61\u7684 <code>Events</code> \u91cc\u9762\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>kubectl describe</code> \u6307\u4ee4\u67e5\u770b\u5bf9\u5e94\u7684\u7ed3\u679c\u3002\u6240\u4ee5\u8fd9\u4e2a\u6307\u4ee4\u4e5f\u4f1a\u662f\u4ee5\u540e\u6211\u4eec\u6392\u9519\u8fc7\u7a0b\u4e2d\u4f1a\u7ecf\u5e38\u4f7f\u7528\u7684\u547d\u4ee4\uff0c\u4e00\u5b9a\u8981\u8bb0\u4f4f\u8fd9\u4e2a\u91cd\u8981\u7684\u547d\u4ee4\u3002\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u63cf\u8ff0\u7684\u8fd9\u4e2a Pod\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5b83\u88ab\u521b\u5efa\u4e4b\u540e\uff0c\u88ab\u8c03\u5ea6\u5668\u8c03\u5ea6\uff08Successfully assigned\uff09\u5230\u4e86 ydzs-node2 \u8282\u70b9\u4e0a\uff0c\u7136\u540e\u6307\u5b9a\u7684\u955c\u50cf\u5df2\u7ecf\u5728\u8be5\u8282\u70b9\u4e0a\u5b58\u5728\u4e86\uff0c\u6240\u4ee5\u6ca1\u6709\u518d\u53bb\u62c9\u53d6\u955c\u50cf\uff0c\u7136\u540e\u521b\u5efa\u6211\u4eec\u5b9a\u4e49\u7684 nginx \u5bb9\u5668\uff0c\u6700\u540e\u542f\u52a8\u5b9a\u4e49\u7684\u5bb9\u5668\u3002</p> <p>\u53e6\u5916\u4e00\u4e2a\u65b9\u9762\u5982\u679c\u6211\u4eec\u76f8\u5bf9\u6211\u4eec\u7684\u5e94\u7528\u8fdb\u884c\u5347\u7ea7\u7684\u8bdd\u5e94\u8be5\u600e\u4e48\u529e\u5462\uff1f\u8fd9\u4e2a\u64cd\u4f5c\u5728\u6211\u4eec\u65e5\u5e38\u5de5\u4f5c\u4e2d\u8fd8\u662f\u975e\u5e38\u5e38\u89c1\u7684\uff0c\u800c\u5728 Kubernetes \u8fd9\u91cc\u4e5f\u662f\u975e\u5e38\u7b80\u5355\u7684\uff0c\u6211\u4eec\u53ea\u9700\u8981\u4fee\u6539\u6211\u4eec\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5373\u53ef\uff0c\u6bd4\u5982\u6211\u4eec\u628a\u955c\u50cf\u5347\u7ea7\u5230\u6700\u65b0\u7248\u672c<code>nginx:latest</code>\uff1a</p> <pre><code>...    \n    spec:\n      containers:\n      - name: nginx\n        image: nginx:latest  # \u8fd9\u91cc\u88ab\u4ece 9 \u4fee\u6539\u4e3alatest\n        ports:\n      - containerPort: 80\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>kubectl apply</code>\u547d\u4ee4\u6765\u76f4\u63a5\u66f4\u65b0\uff0c\u8fd9\u4e2a\u547d\u4ee4\u4e5f\u662f\u63a8\u8350\u6211\u4eec\u4f7f\u7528\u7684\uff0c\u6211\u4eec\u4e0d\u5fc5\u5173\u5fc3\u5f53\u524d\u7684\u64cd\u4f5c\u662f\u521b\u5efa\uff0c\u8fd8\u662f\u66f4\u65b0\uff0c\u6267\u884c\u7684\u547d\u4ee4\u59cb\u7ec8\u662f <code>kubectl apply</code>\uff0cKubernetes \u5219\u4f1a\u6839\u636e YAML \u6587\u4ef6\u7684\u5185\u5bb9\u53d8\u5316\uff0c\u81ea\u52a8\u8fdb\u884c\u5177\u4f53\u7684\u5904\u7406\uff0c\u6240\u4ee5\u65e0\u8bba\u662f\u521b\u5efa\u8fd8\u662f\u66f4\u65b0\u90fd\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl apply -f nginx-deployment.yaml\n</code></pre> <p>\u901a\u8fc7\u8fd9\u4e2a\u547d\u4ee4\u5c31\u53ef\u4ee5\u6765\u66f4\u65b0\u6211\u4eec\u7684\u5e94\u7528\u4e86\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f\u4e00\u4e2a Deployment \u7684\u63a7\u5236\u5668\uff0c\u6240\u4ee5\u4f1a\u6eda\u52a8\u66f4\u65b0\u6211\u4eec\u7684\u5e94\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u547d\u4ee4\u540e\u9762\u52a0\u4e0a <code>--watch</code> \u53c2\u6570\u6765\u67e5\u770b Pod \u7684\u66f4\u65b0\u8fc7\u7a0b\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx --watch\nNAME                            READY   STATUS              RESTARTS   AGE\nnginx-deploy-54f57cf6bf-2fdjz   1/1     Terminating         0          72m\nnginx-deploy-54f57cf6bf-57287   1/1     Running             0          72m\nnginx-deploy-786b576769-69lrl   1/1     Running             0          4s\nnginx-deploy-786b576769-wwmvz   0/1     ContainerCreating   0          2s\nnginx-deploy-54f57cf6bf-2fdjz   0/1     Terminating         0          72m\nnginx-deploy-786b576769-wwmvz   1/1     Running             0          3s\nnginx-deploy-54f57cf6bf-57287   1/1     Terminating         0          72m\nnginx-deploy-54f57cf6bf-57287   0/1     Terminating         0          72m\nnginx-deploy-54f57cf6bf-57287   0/1     Terminating         0          72m\nnginx-deploy-54f57cf6bf-57287   0/1     Terminating         0          72m\nnginx-deploy-54f57cf6bf-2fdjz   0/1     Terminating         0          72m\nnginx-deploy-54f57cf6bf-2fdjz   0/1     Terminating         0          72m\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u66f4\u65b0\u8fc7\u7a0b\u662f\u5148\u6740\u6389\u4e86\u4e00\u4e2a Pod\uff0c\u7136\u540e\u53c8\u91cd\u65b0\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u7136\u540e\u53c8\u6740\u6389\u4e00\u4e2a\u65e7\u7684 Pod\uff0c\u518d\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u8fd9\u6837\u4ea4\u66ff\u66ff\u6362\u7684\uff0c\u6700\u540e\u5269\u4e0b\u4e24\u4e2a\u65b0\u7684 Pod\uff0c\u8fd9\u5c31\u662f\u6211\u4eec\u6240\u8bf4\u7684\u6eda\u52a8\u66f4\u65b0\uff0c\u6eda\u52a8\u66f4\u65b0\u5bf9\u4e8e\u6211\u4eec\u7684\u5e94\u7528\u6301\u7eed\u63d0\u4f9b\u670d\u52a1\u662f\u975e\u5e38\u91cd\u8981\u7684\u624b\u6bb5\uff0c\u5728\u65e5\u5e38\u5de5\u4f5c\u4e2d\u66f4\u65b0\u5e94\u7528\u80af\u5b9a\u4f1a\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002</p> <p>\u6700\u540e\uff0c\u5982\u679c\u9700\u8981\u628a\u6211\u4eec\u7684\u5e94\u7528\u4ece\u96c6\u7fa4\u4e2d\u5220\u9664\u6389\uff0c\u53ef\u4ee5\u7528 <code>kubectl delete</code> \u547d\u4ee4\u6765\u6e05\u7406\uff1a</p> <pre><code>$ kubectl delete -f nginx-deployment.yaml\n</code></pre>"},{"location":"kubernetes_basic/yaml/#yaml_1","title":"YAML \u6587\u4ef6","text":"<p>\u4e0a\u9762\u6211\u4eec\u5728 Kubernetes \u4e2d\u90e8\u7f72\u4e86\u6211\u4eec\u7684\u7b2c\u4e00\u4e2a\u5bb9\u5668\u5316\u5e94\u7528\uff0c\u6211\u4eec\u4e86\u89e3\u5230\u8981\u90e8\u7f72\u5e94\u7528\u6700\u91cd\u8981\u7684\u5c31\u662f\u7f16\u5199\u5e94\u7528\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u3002\u90a3\u4e48\u5982\u4f55\u7f16\u5199\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5462\uff1f\u65e5\u5e38\u4f7f\u7528\u7684\u65f6\u5019\u6211\u4eec\u90fd\u662f\u4f7f\u7528 YAML \u6587\u4ef6\u6765\u7f16\u5199\uff0c\u4f46\u662f\u73b0\u72b6\u5374\u662f\u5927\u90e8\u5206\u540c\u5b66\u5bf9 JSON \u66f4\u52a0\u719f\u6089\uff0c\u5bf9 YAML \u6587\u4ef6\u7684\u683c\u5f0f\u4e0d\u662f\u5f88\u719f\u6089\uff0c\u6240\u4ee5\u4e5f\u5bfc\u81f4\u5f88\u591a\u540c\u5b66\u5728\u7f16\u5199\u8d44\u6e90\u6e05\u5355\u7684\u65f6\u5019\u4f3c\u61c2\u975e\u61c2\u7684\u611f\u89c9\uff0c\u6240\u4ee5\u5728\u4e86\u89e3\u5982\u4f55\u7f16\u5199\u8d44\u6e90\u6e05\u5355\u4e4b\u524d\u6211\u4eec\u975e\u5e38\u6709\u5fc5\u8981\u6765\u4e86\u89e3\u4e0b YAML \u6587\u4ef6\u7684\u7528\u6cd5\u3002</p> <p><code>YAML</code> \u662f\u4e13\u95e8\u7528\u6765\u5199\u914d\u7f6e\u6587\u4ef6\u7684\u8bed\u8a00\uff0c\u975e\u5e38\u7b80\u6d01\u548c\u5f3a\u5927\uff0c\u8fdc\u6bd4 <code>JSON</code> \u683c\u5f0f\u65b9\u4fbf\u3002<code>YAML</code>\u8bed\u8a00\uff08\u53d1\u97f3 /\u02c8j\u00e6m\u0259l/\uff09\u7684\u8bbe\u8ba1\u76ee\u6807\uff0c\u5c31\u662f\u65b9\u4fbf\u4eba\u7c7b\u8bfb\u5199\u3002\u5b83\u5b9e\u8d28\u4e0a\u662f\u4e00\u79cd\u901a\u7528\u7684\u6570\u636e\u4e32\u884c\u5316\u683c\u5f0f\u3002</p> <p>\u5b83\u7684\u57fa\u672c\u8bed\u6cd5\u89c4\u5219\u5982\u4e0b\uff1a</p> <ul> <li>\u5927\u5c0f\u5199\u654f\u611f</li> <li>\u4f7f\u7528\u7f29\u8fdb\u8868\u793a\u5c42\u7ea7\u5173\u7cfb</li> <li>\u7f29\u8fdb\u65f6\u4e0d\u5141\u8bb8\u4f7f\u7528<code>Tab</code>\u952e\uff0c\u53ea\u5141\u8bb8\u4f7f\u7528\u7a7a\u683c</li> <li>\u7f29\u8fdb\u7684\u7a7a\u683c\u6570\u76ee\u4e0d\u91cd\u8981\uff0c\u53ea\u8981\u76f8\u540c\u5c42\u7ea7\u7684\u5143\u7d20\u5de6\u4fa7\u5bf9\u9f50\u5373\u53ef</li> <li><code>#</code> \u8868\u793a\u6ce8\u91ca\uff0c\u4ece\u8fd9\u4e2a\u5b57\u7b26\u4e00\u76f4\u5230\u884c\u5c3e\uff0c\u90fd\u4f1a\u88ab\u89e3\u6790\u5668\u5ffd\u7565</li> </ul> <p>\u5728 Kubernetes \u4e2d\uff0c\u6211\u4eec\u53ea\u9700\u8981\u4e86\u89e3\u4e24\u79cd\u7ed3\u6784\u7c7b\u578b\u5c31\u884c\u4e86\uff1a</p> <ul> <li>Lists\uff08\u5217\u8868\uff09</li> <li>Maps\uff08\u5b57\u5178\uff09</li> </ul> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f60\u53ef\u80fd\u4f1a\u9047\u5230 Lists \u7684 Maps \u548c Maps \u7684 Lists\uff0c\u7b49\u7b49\u3002\u4e0d\u8fc7\u4e0d\u7528\u62c5\u5fc3\uff0c\u4f60\u53ea\u8981\u638c\u63e1\u4e86\u8fd9\u4e24\u79cd\u7ed3\u6784\u4e5f\u5c31\u53ef\u4ee5\u4e86\uff0c\u5176\u4ed6\u66f4\u52a0\u590d\u6742\u7684\u6211\u4eec\u6682\u4e0d\u8ba8\u8bba\u3002</p>"},{"location":"kubernetes_basic/yaml/#maps","title":"Maps","text":"<p>\u9996\u5148\u6211\u4eec\u6765\u770b\u770b <code>Maps</code>\uff0c\u6211\u4eec\u90fd\u77e5\u9053 <code>Map</code> \u662f\u5b57\u5178\uff0c\u5c31\u662f\u4e00\u4e2a <code>key:value</code> \u7684\u952e\u503c\u5bf9\uff0c<code>Maps</code> \u53ef\u4ee5\u8ba9\u6211\u4eec\u66f4\u52a0\u65b9\u4fbf\u7684\u53bb\u4e66\u5199\u914d\u7f6e\u4fe1\u606f\uff0c\u4f8b\u5982\uff1a</p> <pre><code>---\napiVersion: v1\nkind: Pod\n</code></pre> <p>\u7b2c\u4e00\u884c\u7684<code>---</code>\u662f\u5206\u9694\u7b26\uff0c\u662f\u53ef\u9009\u7684\uff0c\u5728\u5355\u4e00\u6587\u4ef6\u4e2d\uff0c\u53ef\u7528\u8fde\u7eed\u4e09\u4e2a\u8fde\u5b57\u53f7<code>---</code>\u533a\u5206\u591a\u4e2a\u6587\u4ef6\u3002\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u6211\u4eec\u6709\u4e24\u4e2a\u952e\uff1akind \u548c apiVersion\uff0c\u4ed6\u4eec\u5bf9\u5e94\u7684\u503c\u5206\u522b\u662f\uff1av1 \u548c Pod\u3002\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u8f6c\u6362\u6210 JSON \u683c\u5f0f\u7684\u8bdd\uff0c\u4f60\u80af\u5b9a\u5c31\u5bb9\u6613\u660e\u767d\u4e86\uff1a</p> <pre><code>{\n    \"apiVersion\": \"v1\",\n    \"kind\": \"pod\"\n}\n</code></pre> <p>\u6211\u4eec\u5728\u521b\u5efa\u4e00\u4e2a\u76f8\u5bf9\u590d\u6742\u4e00\u70b9\u7684 YAML \u6587\u4ef6\uff0c\u521b\u5efa\u4e00\u4e2a KEY \u5bf9\u5e94\u7684\u503c\u4e0d\u662f\u5b57\u7b26\u4e32\u800c\u662f\u4e00\u4e2a Maps\uff1a</p> <pre><code>---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: ydzs-site\n  labels:\n    app: web\n</code></pre> <p>\u4e0a\u9762\u7684 YAML \u6587\u4ef6\uff0cmetadata \u8fd9\u4e2a KEY \u5bf9\u5e94\u7684\u503c\u5c31\u662f\u4e00\u4e2a <code>Maps</code> \u4e86\uff0c\u800c\u4e14\u5d4c\u5957\u7684 labels \u8fd9\u4e2a KEY \u7684\u503c\u53c8\u662f\u4e00\u4e2a Map\uff0c\u4f60\u53ef\u4ee5\u6839\u636e\u4f60\u81ea\u5df1\u7684\u60c5\u51b5\u8fdb\u884c\u591a\u5c42\u5d4c\u5957\u3002</p> <p>\u4e0a\u9762\u6211\u4eec\u4e5f\u63d0\u5230\u4e86 YAML \u6587\u4ef6\u7684\u8bed\u6cd5\u89c4\u5219\uff0cYAML \u5904\u7406\u5668\u662f\u6839\u636e\u884c\u7f29\u8fdb\u6765\u77e5\u9053\u5185\u5bb9\u4e4b\u95f4\u7684\u55ef\u5173\u8054\u6027\u7684\u3002\u6bd4\u5982\u6211\u4eec\u4e0a\u9762\u7684 YAML \u6587\u4ef6\uff0c<code>\u6211\u7528\u4e86\u4e24\u4e2a\u7a7a\u683c\u4f5c\u4e3a\u7f29\u8fdb\uff0c\u7a7a\u683c\u7684\u6570\u91cf\u5e76\u4e0d\u91cd\u8981\uff0c\u4f46\u662f\u4f60\u5f97\u4fdd\u6301\u4e00\u81f4\uff0c\u5e76\u4e14\u81f3\u5c11\u8981\u6c42\u4e00\u4e2a\u7a7a\u683c</code>\uff08\u4ec0\u4e48\u610f\u601d\uff1f\u5c31\u662f\u4f60\u522b\u4e00\u4f1a\u7f29\u8fdb\u4e24\u4e2a\u7a7a\u683c\uff0c\u4e00\u4f1a\u7f29\u8fdb4\u4e2a\u7a7a\u683c\uff09\u3002\u6211\u4eec\u53ef\u4ee5\u770b\u5230 name \u548c labels \u662f\u76f8\u540c\u7ea7\u522b\u7684\u7f29\u8fdb\uff0c\u6240\u4ee5 YAML \u5904\u7406\u5668\u5c31\u77e5\u9053\u4e86\u4ed6\u4eec\u5c5e\u4e8e\u540c\u4e00\u4e2a Map\uff0c\u800c app \u662f labels \u7684\u503c\u662f\u56e0\u4e3a app \u7684\u7f29\u8fdb\u66f4\u5927\u3002</p> <p>\u6ce8\u610f</p> <p>\u6ce8\u610f\uff1a\u5728 YAML \u6587\u4ef6\u4e2d\u7edd\u5bf9\u4e0d\u8981\u4f7f\u7528 tab \u952e\u6765\u8fdb\u884c\u7f29\u8fdb\u3002</p> <p>\u540c\u6837\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u8f6c\u6362\u6210 JSON \u6587\u4ef6\uff1a</p> <pre><code>{\n    \"apiVersion\": \"v1\",\n    \"kind\": \"Pod\",\n    \"metadata\": {\n        \"name\": \"kube100-site\",\n        \"labels\": {\n            \"app\": \"web\"\n        }\n    }\n}\n</code></pre> <p>\u6216\u8bb8\u4f60\u5bf9\u4e0a\u9762\u7684 JSON \u6587\u4ef6\u66f4\u719f\u6089\uff0c\u4f46\u662f\u4f60\u4e0d\u5f97\u4e0d\u627f\u8ba4 YAML \u6587\u4ef6\u7684\u8bed\u4e49\u5316\u7a0b\u5ea6\u66f4\u9ad8\u5427\uff1f</p>"},{"location":"kubernetes_basic/yaml/#lists","title":"Lists","text":"<p><code>Lists</code>\u5c31\u662f\u5217\u8868\uff0c\u8bf4\u767d\u4e86\u5c31\u662f\u6570\u7ec4\uff0c\u5728 YAML \u6587\u4ef6\u4e2d\u6211\u4eec\u53ef\u4ee5\u8fd9\u6837\u5b9a\u4e49\uff1a</p> <pre><code>args\n  - Cat\n  - Dog\n  - Fish\n</code></pre> <p>\u4f60\u53ef\u4ee5\u6709\u4efb\u4f55\u6570\u91cf\u7684\u9879\u5728\u5217\u8868\u4e2d\uff0c\u6bcf\u4e2a\u9879\u7684\u5b9a\u4e49\u4ee5\u7834\u6298\u53f7\uff08<code>-</code>\uff09\u5f00\u5934\u7684\uff0c\u4e0e\u7236\u5143\u7d20\u4e4b\u95f4\u53ef\u4ee5\u7f29\u8fdb\u4e5f\u53ef\u4ee5\u4e0d\u7f29\u8fdb\u3002\u5bf9\u5e94\u7684 JSON \u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>{\n    \"args\": [ 'Cat', 'Dog', 'Fish' ]\n}\n</code></pre> <p>\u5f53\u7136\uff0cLists \u7684\u5b50\u9879\u4e5f\u53ef\u4ee5\u662f Maps\uff0cMaps \u7684\u5b50\u9879\u4e5f\u53ef\u4ee5\u662f Lists \u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: ydzs-site\n  labels:\n    app: web\nspec:\n  containers:\n    - name: front-end\n      image: nginx\n      ports:\n        - containerPort: 80\n    - name: flaskapp-demo\n      image: cnych/flaskapp\n      ports:\n        - containerPort: 5000\n</code></pre> <p>\u6bd4\u5982\u8fd9\u4e2a YAML \u6587\u4ef6\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u53eb containers \u7684 List \u5bf9\u8c61\uff0c\u6bcf\u4e2a\u5b50\u9879\u90fd\u7531 name\u3001image\u3001ports \u7ec4\u6210\uff0c\u6bcf\u4e2a ports \u90fd\u6709\u4e00\u4e2a key \u4e3a containerPort \u7684 Map \u7ec4\u6210\uff0c\u540c\u6837\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u8f6c\u6210\u5982\u4e0b JSON \u683c\u5f0f\u6587\u4ef6\uff1a</p> <pre><code>{\n    \"apiVersion\": \"v1\",\n    \"kind\": \"Pod\",\n    \"metadata\": {\n        \"name\": \"ydzs-site\",\n        \"labels\": {\n            \"app\": \"web\"\n        }\n    },\n    \"spec\": {\n        \"containers\": [{\n            \"name\": \"front-end\",\n            \"image\": \"nginx\",\n            \"ports\": [{\n                \"containerPort\": \"80\"\n            }]\n        }, {\n            \"name\": \"flaskapp-demo\",\n            \"image\": \"cnych/flaskapp\",\n            \"ports\": [{\n                \"containerPort\": \"5000\"\n            }]\n        }]\n    }\n}\n</code></pre> <p>\u662f\u4e0d\u662f\u89c9\u5f97\u7528 JSON \u683c\u5f0f\u7684\u8bdd\u6587\u4ef6\u660e\u663e\u6bd4 YAML \u6587\u4ef6\u66f4\u590d\u6742\u4e86\u5462\uff1f</p>"},{"location":"kubernetes_basic/yaml/#_2","title":"\u5982\u4f55\u7f16\u5199\u8d44\u6e90\u6e05\u5355","text":"<p>\u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86 YAML \u6587\u4ef6\u7684\u57fa\u672c\u8bed\u6cd5\uff0c\u73b0\u5728\u81f3\u5c11\u53ef\u4ee5\u4fdd\u8bc1\u6211\u4eec\u7684\u7f16\u5199\u7684 YAML \u6587\u4ef6\u8bed\u6cd5\u662f\u5408\u6cd5\u7684\uff0c\u90a3\u4e48\u8981\u600e\u4e48\u7f16\u5199\u7b26\u5408 Kubernetes API \u5bf9\u8c61\u7684\u8d44\u6e90\u6e05\u5355\u5462\uff1f\u6bd4\u5982\u6211\u4eec\u600e\u4e48\u77e5\u9053 Pod\u3001Deployment \u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u6709\u54ea\u4e9b\u529f\u80fd\u3001\u6709\u54ea\u4e9b\u5b57\u6bb5\u5462\uff1f</p> <p>\u4e00\u4e9b\u7b80\u5355\u7684\u8d44\u6e90\u5bf9\u8c61\u6211\u4eec\u53ef\u80fd\u53ef\u4ee5\u51ed\u501f\u8bb0\u5fc6\u5199\u51fa\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\uff0c\u4f46\u662f Kubernetes \u53d1\u5c55\u4e5f\u975e\u5e38\u5feb\uff0c\u7248\u672c\u8fed\u4ee3\u4e5f\u5f88\u5feb\uff0c\u6bcf\u4e2a\u7248\u672c\u4e2d\u8d44\u6e90\u5bf9\u8c61\u53ef\u80fd\u53c8\u6709\u5f88\u591a\u53d8\u5316\uff0c\u90a3\u4e48\u6709\u6ca1\u6709\u4e00\u79cd\u529e\u6cd5\u53ef\u4ee5\u8ba9\u6211\u4eec\u505a\u5230\u6709\u7684\u653e\u77e2\u5462\uff1f</p> <p>\u5b9e\u9645\u4e0a\u662f\u6709\u7684\uff0c\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u5c31\u662f\u67e5\u627e Kubernetes API \u6587\u6863\uff0c\u6bd4\u5982\u6211\u4eec\u73b0\u5728\u4f7f\u7528\u7684\u662f v1.26.2 \u7248\u672c\u7684\u96c6\u7fa4\uff0c\u53ef\u4ee5\u901a\u8fc7\u5730\u5740 https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/ \u67e5\u627e\u5230\u5bf9\u5e94\u7684 API \u6587\u6863\uff0c\u5728\u8fd9\u4e2a\u6587\u6863\u4e2d\u6211\u4eec\u53ef\u4ee5\u627e\u5230\u6240\u6709\u8d44\u6e90\u5bf9\u8c61\u7684\u4e00\u4e9b\u5b57\u6bb5\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u8981\u4e86\u89e3\u521b\u5efa\u4e00\u4e2a Deployment \u8d44\u6e90\u5bf9\u8c61\u9700\u8981\u54ea\u4e9b\u5b57\u6bb5\uff0c\u6211\u4eec\u53ef\u4ee5\u6253\u5f00\u4e0a\u9762\u7684 API \u6587\u6863\u9875\u9762\uff0c\u5728\u5de6\u4fa7\u4fa7\u8fb9\u680f\u627e\u5230 <code>Deployment v1 apps</code>\uff0c\u70b9\u51fb\u4e0b\u9762\u7684 <code>Write Operations</code>\uff0c\u7136\u540e\u70b9\u51fb <code>Create</code>\uff0c\u7136\u540e\u6211\u4eec\u67e5\u627e\u5230\u521b\u5efa Deployment \u9700\u8981\u63d0\u4ea4\u7684 Body \u53c2\u6570</p> <p></p> <p>\u7136\u540e\u70b9\u51fb Body\uff0c\u8fdb\u5165\u5230\u53c2\u6570\u8be6\u60c5\u9875\uff1a</p> <p></p> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u521b\u5efa Deployment \u9700\u8981\u7684\u4e00\u4e9b\u5b57\u6bb5\u4e86\uff0c\u6bd4\u5982 apiVersion\u3001kind\u3001metadata\u3001spec \u7b49\uff0c\u800c\u4e14\u6bcf\u4e2a\u5b57\u6bb5\u90fd\u6709\u5bf9\u5e94\u7684\u6587\u6863\u8bf4\u660e\uff0c\u6bd4\u5982\u6211\u4eec\u50cf\u8981\u4e86\u89e3 DeploymentSpec \u4e0b\u9762\u6709\u54ea\u4e9b\u5b57\u6bb5\uff0c\u7ee7\u7eed\u70b9\u51fb\u8fdb\u53bb\u67e5\u770b\u5c31\u884c\uff1a</p> <p></p> <p>\u6bcf\u4e2a\u5b57\u6bb5\u5177\u4f53\u4ec0\u4e48\u542b\u4e49\u4ee5\u53ca\u6bcf\u4e2a\u5b57\u6bb5\u4e0b\u9762\u662f\u5426\u8fd8\u6709\u5176\u4ed6\u5b57\u6bb5\u90fd\u53ef\u4ee5\u8fd9\u6837\u53bb\u8ffd\u6eaf\u3002</p> <p>\u4f46\u662f\u5982\u679c\u5e73\u65f6\u6211\u4eec\u7f16\u5199\u8d44\u6e90\u6e05\u5355\u7684\u65f6\u5019\u90fd\u8fd9\u6837\u53bb\u67e5\u627e\u6587\u6863\u52bf\u5fc5\u4f1a\u6548\u7387\u4f4e\u4e0b\uff0cKubernetes \u4e5f\u8003\u8651\u5230\u4e86\u8fd9\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 kubectl \u547d\u4ee4\u884c\u5de5\u5177\u6765\u83b7\u53d6\u8fd9\u4e9b\u5b57\u6bb5\u4fe1\u606f\uff0c\u540c\u6837\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u83b7\u53d6 Deployment \u7684\u5b57\u6bb5\u4fe1\u606f\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>kubectl explain</code> \u547d\u4ee4\u6765\u4e86\u89e3\uff1a</p> <pre><code>$ kubectl explain deployment\nKIND:     Deployment\nVERSION:  apps/v1\n\nDESCRIPTION:\n     Deployment enables declarative updates for Pods and ReplicaSets.\n\nFIELDS:\n   apiVersion   &lt;string&gt;\n     APIVersion defines the versioned schema of this representation of an\n     object. Servers should convert recognized schemas to the latest internal\n     value, and may reject unrecognized values. More info:\n     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources\n\n   kind &lt;string&gt;\n     Kind is a string value representing the REST resource this object\n     represents. Servers may infer this from the endpoint the client submits\n     requests to. Cannot be updated. In CamelCase. More info:\n     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds\n\n   metadata &lt;Object&gt;\n     Standard object metadata.\n\n   spec &lt;Object&gt;\n     Specification of the desired behavior of the Deployment.\n\n   status   &lt;Object&gt;\n     Most recently observed status of the Deployment.\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u4fe1\u606f\u548c\u6211\u4eec\u5728 API \u6587\u6863\u4e2d\u67e5\u770b\u5230\u7684\u57fa\u672c\u4e00\u81f4\uff0c\u6bd4\u5982\u6211\u4eec\u770b\u5230\u5176\u4e2d <code>spec</code> \u5b57\u6bb5\u662f\u4e00\u4e2a <code>&lt;Object&gt;</code> \u7c7b\u578b\u7684\uff0c\u8bc1\u660e\u8be5\u5b57\u6bb5\u4e0b\u9762\u662f\u4e00\u4e2a\u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u7ee7\u7eed\u53bb\u67e5\u770b\u8fd9\u4e2a\u5b57\u6bb5\u4e0b\u9762\u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl explain deployment.spec\nKIND:     Deployment\nVERSION:  apps/v1\n\nRESOURCE: spec &lt;Object&gt;\n\nDESCRIPTION:\n     Specification of the desired behavior of the Deployment.\n\n     DeploymentSpec is the specification of the desired behavior of the\n     Deployment.\n\nFIELDS:\n   minReadySeconds  &lt;integer&gt;\n     Minimum number of seconds for which a newly created pod should be ready\n     without any of its container crashing, for it to be considered available.\n     Defaults to 0 (pod will be considered available as soon as it is ready)\n\n   paused   &lt;boolean&gt;\n     Indicates that the deployment is paused.\n\n   progressDeadlineSeconds  &lt;integer&gt;\n     The maximum time in seconds for a deployment to make progress before it is\n     considered to be failed. The deployment controller will continue to process\n     failed deployments and a condition with a ProgressDeadlineExceeded reason\n     will be surfaced in the deployment status. Note that progress will not be\n     estimated during the time a deployment is paused. Defaults to 600s.\n\n   replicas &lt;integer&gt;\n     Number of desired pods. This is a pointer to distinguish between explicit\n     zero and not specified. Defaults to \n\n   revisionHistoryLimit &lt;integer&gt;\n     The number of old ReplicaSets to retain to allow rollback. This is a\n     pointer to distinguish between explicit zero and not specified. Defaults to\n\n   selector &lt;Object&gt; -required-\n     Label selector for pods. Existing ReplicaSets whose pods are selected by\n     this will be the ones affected by this deployment. It must match the pod\n     template's labels.\n\n   strategy &lt;Object&gt;\n     The deployment strategy to use to replace existing pods with new ones.\n\n   template &lt;Object&gt; -required-\n     Template describes the pods that will be created.\n</code></pre> <p>\u5982\u679c\u4e00\u4e2a\u5b57\u6bb5\u663e\u793a\u7684\u662f <code>required</code>\uff0c\u8fd9\u5c31\u8bc1\u660e\u8be5\u81ea\u52a8\u662f\u5fc5\u586b\u7684\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5728\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u7684\u65f6\u5019\u5fc5\u987b\u58f0\u660e\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u6bcf\u4e2a\u5b57\u6bb5\u7684\u7c7b\u578b\u4e5f\u90fd\u5b8c\u5168\u4e3a\u6211\u4eec\u8fdb\u884c\u4e86\u8bf4\u660e\uff0c\u6240\u4ee5\u6709\u4e86 <code>kubectl explain</code> \u8fd9\u4e2a\u547d\u4ee4\u6211\u4eec\u5c31\u5b8c\u5168\u53ef\u4ee5\u5199\u51fa\u4e00\u4e2a\u4e0d\u719f\u6089\u7684\u8d44\u6e90\u5bf9\u8c61\u7684\u6e05\u5355\u8bf4\u660e\u4e86\uff0c\u8fd9\u4e2a\u547d\u4ee4\u6211\u4eec\u4e5f\u662f\u5fc5\u987b\u8981\u8bb0\u4f4f\u7684\uff0c\u4f1a\u5728\u4ee5\u540e\u7684\u5de5\u4f5c\u4e2d\u4e3a\u6211\u4eec\u63d0\u4f9b\u5f88\u5927\u7684\u5e2e\u52a9\u3002</p>"},{"location":"kubernetes_code/kubelet/","title":"kubelet\u6e90\u7801","text":""},{"location":"kubernetes_code/kubelet/#kubelet","title":"kubelet \u6e90\u7801","text":"<p>\u8fdb\u5165 cmd/kubelet/app/server.go \u8c03\u7528 NewKubeletCommand \u51fd\u6570\uff0c\u4f7f\u7528\u9ed8\u8ba4\u7684\u53c2\u6570\u521b\u5efa\u4e00\u4e2a cobra.Command \u6307\u9488\uff1a</p> <pre><code>func NewKubeletCommand() *cobra.Command {\n    ...\n    cmd := &amp;cobra.Command{\n        Use: componentKubelet,\n        ...\n        // Kubelet\u5177\u6709\u7279\u6b8a\u7684flag\u89e3\u6790\u8981\u6c42\u6765\u5f3a\u5236\u6267\u884cflag\u4f18\u5148\u7ea7\u89c4\u5219\uff0c\u56e0\u6b64\u6211\u4eec\u5728\u4e0b\u9762\u7684Run\u4e2d\u624b\u52a8\u5b8c\u6210\u6240\u6709\u89e3\u6790\u3002DisableFlagParsing=true\u63d0\u4f9b\u4f20\u9012\u7ed9`args` arg\u4e2d\u7684kubelet\u7684\u5b8c\u6574flagset\u6765\u8fd0\u884c\uff0c\u6ca1\u6709Cobra\u7684\u5e72\u6270\u3002\n        DisableFlagParsing: true,\n        Run: func(cmd *cobra.Command, args []string) {\n            // \u521d\u59cb\u5316flag\u89e3\u6790\uff0c\u56e0\u4e3a\u6211\u4eec\u7981\u7528\u4e86cobra\u7684flag\u89e3\u6790\n            if err := cleanFlagSet.Parse(args); err != nil {\n                cmd.Usage()\n                klog.Fatal(err)\n            }\n            ......\n            // \u6821\u9a8c\u521d\u59cb\u7684 KubeletFlags\n            // \u52a0\u8f7d kubelet config \u6587\u4ef6(\u5982\u679c\u5f00\u542f)\n            // \u4f7f\u7528\u52a8\u6001\u7684 kubelet config(\u5982\u679c\u5f00\u542f)\n            // \u901a\u8fc7kubeletFlags\u548ckubeletConfig\u5c01\u88c5KubeletServer\u7ed3\u6784\n            // \u4f7f\u7528 kubeletServer \u6765\u6784\u9020\u9ed8\u8ba4\u7684 KubeletDeps\n            // \u6dfb\u52a0 kubelet \u914d\u7f6e\u63a7\u5236\u5668\u5230 kubeletDeps\n            // \u6dfb\u52a0 stopCh Channel \u4f9b kubelet \u548c docker shim \u590d\u7528\n            // \u5f00\u542fdocker shim\u7279\u6027(\u5982\u679c\u5f00\u542f)\n            if kubeletServer.KubeletFlags.ExperimentalDockershim {\n                if err := RunDockershim(&amp;kubeletServer.KubeletFlags, kubeletConfig, stopCh); err != nil {\n                    klog.Fatal(err)\n                }\n                // \u6ce8\u610f\u8fd9\u91cc\u7684return\uff0c\u610f\u5473\u7740\u542f\u7528 dockershim only \u6a21\u5f0f\uff0ckubelet\u53ea\u4f1a\u542f\u52a8 dockershim \u8fdb\u7a0b\u3002\u6b64\u6807\u5fd7\u4ec5\u7528\u4e8e\u6d4b\u8bd5\u76ee\u7684\uff0c\u9664\u975e\u60a8\u610f\u8bc6\u5230\u81ea\u5df1\u5728\u505a\u4ec0\u4e48\uff0c\u5426\u5219\u8bf7\u4e0d\u8981\u4f7f\u7528\u5b83\u3002 [\u9ed8\u8ba4= FALSE]\n                return\n            }\n            // \u8fd0\u884c kubelet\n            if err := Run(kubeletServer, kubeletDeps, stopCh); err != nil {\n                klog.Fatal(err)\n            }\n        }\n    }\n    ...\n    return cmd\n}\n</code></pre> <p>\u5176\u4e2d RunDockershim \u51fd\u6570\u4ec5\u5728\u5f53\u524d\u8fdb\u7a0b\u4e2d\u542f\u52a8 dockershim\u3002\u8fd9\u4ec5\u7528\u4e8e\u9a8c\u8bc1\u6d4b\u8bd5\u76ee\u7684\u3002</p> <pre><code>func RunDockershim(f *options.KubeletFlags, c *kubeletconfiginternal.KubeletConfiguration, stopCh &lt;-chan struct{}) error {\n    // \u521d\u59cb\u5316 docker \u5ba2\u6237\u7aef\u914d\u7f6e\n    // \u521d\u59cb\u5316\u7f51\u7edc\u63d2\u4ef6\u914d\u7f6e\n    // \u521d\u59cb\u5316 streaming \u914d\u7f6e\uff08\u73b0\u5728\u4e0d\u4f7f\u7528TLS\uff09\n    // \u72ec\u7acb\u7684 dockershim \u5c06\u59cb\u7ec8\u4f1a\u542f\u52a8\u672c\u5730\u7684streaming server\u3002\n    ds, err := dockershim.NewDockerService(dockerClientConfig, r.PodSandboxImage, streamingConfig, &amp;pluginSettings,\n        f.RuntimeCgroups, c.CgroupDriver, r.DockershimRootDirectory, true /*startLocalStreamingServer*/)\n    if err != nil {\n        return err\n    }\n    // \u4e3a docker CRI shim \u542f\u52a8 GRPC \u670d\u52a1\u5668\n    server := dockerremote.NewDockerServer(f.RemoteRuntimeEndpoint, ds)\n    if err := server.Start(); err != nil {\n        return err\n    }\n    &lt;-stopCh\n    return nil\n}\n</code></pre> <p>\u7136\u540e\u662f\u6700\u6838\u5fc3\u7684 kubelet \u542f\u52a8\u51fd\u6570 Run\uff1a</p> <pre><code>// Run \u51fd\u6570\u8fd0\u884c\u4e00\u4e2a\u5177\u6709\u7ed9\u5b9a\u4f9d\u8d56\u9879\u7684 KubeletServer\uff0c\u6c38\u8fdc\u4e0d\u4f1a\u9000\u51fa\u3002\n// kubeDeps \u53c2\u6570\u53ef\u80fd\u4e3a nil - \u5982\u679c\u4e3a\u7a7a\uff0c\u5219\u9700\u8981\u4ece KubeletServer \u4e0a\u7684\u8bbe\u7f6e\u8fdb\u884c\u521d\u59cb\u5316\u3002\n// \u5982\u679c\u8c03\u7528\u8005\u5df2\u7ecf\u8bbe\u7f6e\u4e86\u4f9d\u8d56\u5bf9\u8c61\u4e86\u5219\u4e0d\u4f1a\u751f\u6210\u9ed8\u8ba4\u7684\u5bf9\u8c61\u4e86\u3002\nfunc Run(s *options.KubeletServer, kubeDeps *kubelet.Dependencies, stopCh &lt;-chan struct{}) error {\n    if err := initForOS(s.KubeletFlags.WindowsService); err != nil {\n        return fmt.Errorf(\"failed OS init: %v\", err)\n    }\n    if err := run(s, kubeDeps, stopCh); err != nil {\n        return fmt.Errorf(\"failed to run Kubelet: %v\", err)\n    }\n    return nil\n}\n</code></pre> <p>\u8c03\u7528\u4e0b\u9762\u7684\u6838\u5fc3\u7684 run \u51fd\u6570\uff1a</p> <pre><code>func run(s *options.KubeletServer, kubeDeps *kubelet.Dependencies, stopCh &lt;-chan struct{}) (err error) {\n    // \u57fa\u4e8e\u521d\u59cb\u7684KubeletServer\u7684\u503c\u8bbe\u7f6e\u5168\u5c40\u7684 feature gates \u7279\u6027\n    // \u6821\u9a8c\u521d\u59cbKubeletServer\uff08\u6211\u4eec\u9996\u5148\u8bbe\u7f6efeature gates\uff0c\u56e0\u4e3a\u8be5\u9a8c\u8bc1\u4f9d\u8d56feature gates\uff09\n    if err := options.ValidateKubeletServer(s); err != nil {\n        return err\n    }\n    // \u83b7\u53d6 Kubelet \u9501\u6587\u4ef6\n    // \u4f7f\u7528 /configz \u7aef\u53e3\u6ce8\u518c\u5f53\u524d\u914d\u7f6e\n    // \u83b7\u53d6\u5ba2\u6237\u7aef\u7b49\u4fe1\u606f\uff0c\u68c0\u6d4b\u72ec\u7acb(standaloneMode)\u6a21\u5f0f\n    // \u83b7\u53d6\u4e3b\u673a\u540d\u3001\u83b7\u53d6\u8282\u70b9\u540d\n    // \u5982\u679c\u662f\u72ec\u7acb\u6a21\u5f0f\uff0c\u5c3d\u53ef\u80fd\u5c06\u6240\u6709\u5ba2\u6237\u7aef\u8bbe\u7f6e\u6210nil\n    // \u5426\u5219\n    //      \u521b\u5efa kubelet \u5ba2\u6237\u7aef\n    //      \u4e3a\u4e8b\u4ef6\u521b\u5efa\u4e00\u4e2a\u72ec\u7acb\u7684\u5ba2\u6237\u7aef\n    //      \u4e3a\u7981\u7528\u9650\u6d41\u548c\u9644\u52a0\u8d85\u65f6\u7684\u5fc3\u8df3\u521b\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u5ba2\u6237\u7aef\n    //          \u5982\u679c\u542f\u7528\u4e86NodeLease\u529f\u80fd\uff0c\u5219\u8d85\u65f6\u662f\u79df\u7ea6\u6301\u7eed\u65f6\u95f4\u548c\u72b6\u6001\u66f4\u65b0\u9891\u7387\u7684\u6700\u5c0f\u503c\n    //          NodeLease: Kubelet \u4f7f\u7528\u65b0\u7684 Lease API \u62a5\u544a\u8282\u70b9\u5fc3\u8df3\uff0c\u8282\u70b9\u751f\u547d\u5468\u671f\u63a7\u5236\u5668\u4f7f\u7528\u8fd9\u4e9b\u5fc3\u8df3\u4f5c\u4e3a\u8282\u70b9\u5065\u5eb7\u4fe1\u53f7\u3002\n    // \u5982\u679c kubelet \u914d\u7f6e\u63a7\u5236\u5668\u53ef\u7528\uff0c\u5e76\u4e14\u542f\u7528\u4e86\u52a8\u6001\u914d\u7f6e\uff0c\u5219\u542f\u52a8\u914d\u7f6e\u548c\u72b6\u6001\u540c\u6b65\u5faa\u73af\n    // DynamicConfigDir:\n    //      Kubelet \u5c06\u4f7f\u7528\u6b64\u76ee\u5f55\u68c0\u67e5\u4e0b\u8f7d\u7684\u914d\u7f6e\u5e76\u8ddf\u8e2a\u914d\u7f6e\u8fd0\u884c\u72b6\u51b5\u3002\n    //      Kubelet \u5c06\u521b\u5efa\u6b64\u76ee\u5f55\uff08\u5982\u679c\u8be5\u76ee\u5f55\u5c1a\u4e0d\u5b58\u5728\uff09, \u8def\u5f84\u53ef\u4ee5\u662f\u7edd\u5bf9\u7684\u6216\u76f8\u5bf9\u7684; \u76f8\u5bf9\u8def\u5f84\u4f4d\u4e8e Kubelet \u7684\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\u4e0b\u3002\n    //      \u63d0\u4f9b\u6b64\u6807\u5fd7\u53ef\u542f\u7528\u52a8\u6001 kubelet \u914d\u7f6e\uff0c\u8981\u4f7f\u7528\u6b64\u6807\u5fd7\uff0c\u5fc5\u987b\u542f\u7528DynamicKubeletConfig feature gates\u3002\n    if utilfeature.DefaultFeatureGate.Enabled(features.DynamicKubeletConfig) &amp;&amp; len(s.DynamicConfigDir.Value()) &gt; 0 &amp;&amp;\n        kubeDeps.KubeletConfigController != nil &amp;&amp; !standaloneMode &amp;&amp; !s.RunOnce {\n        // StartSync \u51fd\u6570\u544a\u8bc9\u63a7\u5236\u5668\u5f00\u4e00\u4e2agoroutine\u4eceapiserver\u540c\u6b65status/config \u5230 /\uff08\u4f4d\u4e8epkg/kubelt/kubeletconfig/controller.go\uff09\n        if err := kubeDeps.KubeletConfigController.StartSync(kubeDeps.KubeClient, kubeDeps.EventClient, string(nodeName)); err != nil {\n            return err\n        }\n    }\n\n    // \u7136\u540e\u8c03\u7528 BuildAuth \u51fd\u6570\u521b\u5efa\u4e00\u4e2a\u9a8c\u8bc1\u5668\uff0c\u4e00\u4e2a\u6388\u6743\u5668\uff0c\u4ee5\u53ca\u4e00\u4e2a kubelet\u7684authorizer.RequestAttributesGetter\n    // \u5b89\u88c5\u4e8b\u4ef6\u8bb0\u5f55\u5668\n    // \u89e3\u6790\u8d44\u6e90\u9884\u7559\u914d\u7f6e\n    // \u6784\u9020 ContainerManager\n\n    // \u7136\u540e\u8c03\u7528 RunKubelet \u51fd\u6570\n    if err := RunKubelet(s, kubeDeps, s.RunOnce); err != nil {\n        return err\n    }\n\n    // \u5982\u679c\u5f00\u542f\u4e86 healthzPort \u7aef\u53e3\uff08\u672c\u5730 healthz endpint \u7aef\u53e3\uff0c0\u8868\u793a\u7981\u7528\uff09,\u5219\u5f00\u542f healthz server\n\n    // \u5982\u679c\u4f7f\u7528\u4e86 systemd , \u901a\u77e5\u5b83\u6211\u4eec\u5df2\u7ecf\u542f\u52a8\u4e86\n    go daemon.SdNotify(false, \"READY=1\")\n\n    select {\n    case &lt;-done:\n        break\n    case &lt;-stopCh:\n        break\n    }\n\n    return nil\n}\n</code></pre> <p>\u5176\u4e2d\u6821\u9a8c KubeletServer \u7684\u51fd\u6570 ValidateKubeletServer \u4f4d\u4e8e</p> <pre><code>cmd/kubelet/app/options/options.go\n</code></pre> <p>\uff1a</p> <pre><code>// ValidateKubeletServer \u51fd\u6570\u6821\u9a8c KubeletServer \u7684\u914d\u7f6e\uff0c\u5982\u679c\u914d\u7f6e\u65e0\u6548\u5219\u8fd4\u56deerror\u3002\nfunc ValidateKubeletServer(s *KubeletServer) error {\n    // \u4efb\u4f55\u7684 KubeletConfiguration \u6821\u9a8c\u90fd\u4f7f\u7528kubeletconfigvalidation.ValidateKubeletConfiguration\u51fd\u6570\n    // ValidateKubeletConfiguration \u51fd\u6570\u4f4d\u4e8e pkg/kubelet/apis/config/validation/validation.go\n    if err := kubeletconfigvalidation.ValidateKubeletConfiguration(&amp;s.KubeletConfiguration); err != nil {\n        return err\n    }\n    // ValidateKubeletFlags \u51fd\u6570\u6821\u9a8c Kubelet \u7684\u914d\u7f6e flag\uff0c\u5982\u679c\u65e0\u6548\u5219\u8fd4\u56de error\n    if err := ValidateKubeletFlags(&amp;s.KubeletFlags); err != nil {\n        return err\n    }\n    return nil\n}\n</code></pre> <p>\u5176\u4e2d\u542f\u52a8 Kubelet \u6838\u5fc3\u7684 RunKubelet \u51fd\u6570\u5982\u4e0b\uff1a</p> <pre><code>// RunKubelet \u51fd\u6570\u8d1f\u8d23\u914d\u7f6e\u548c\u8fd0\u884c kubelet\u3002\u5b83\u7528\u4e8e\u4e09\u79cd\u4e0d\u540c\u7684\u5e94\u7528\uff1a\n//   \u96c6\u6210\u6d4b\u8bd5\n//   Kubelet \u4e8c\u8fdb\u5236\n//   \u72ec\u7acb\u7684 kubernetes \u4e8c\u8fdb\u5236\n// \u6700\u7ec8\uff0c#2\u5c06\u4f1a\u88ab#3\u7684\u5b9e\u4f8b\u6240\u66ff\u6362\nfunc RunKubelet(kubeServer *options.KubeletServer, kubeDeps *kubelet.Dependencies, runOnce bool) error {\n    ......\n    // \u6838\u5fc3\u4ecd\u7136\u662f\u8c03\u7528 createAndInitKubelet \u51fd\u6570\u5c06 Kubelet \u914d\u7f6e\u3001\u4f9d\u8d56\u7b49\u6784\u9020\u6210 kubelet \u7684\u542f\u52a8\u63a5\u53e3\n\n    // \u7136\u540e\u8c03\u7528 startKubelet \u51fd\u6570\u542f\u52a8 Kubelet\n    startKubelet(k, podCfg, &amp;kubeServer.KubeletConfiguration, kubeDeps, kubeServer.EnableCAdvisorJSONEndpoints, kubeServer.EnableServer)\n\n    return nil\n}\n</code></pre> <p>\u5176\u4e2d createAndInitKubelet \u51fd\u6570\u8c03\u7528\u4e86 kubelet.NewMainKubelet \u51fd\u6570\u6765\u6784\u9020 kubelet \u7684\u542f\u52a8\u63a5\u53e3\uff0cNewMainKubelet \u51fd\u6570\u4f4d\u4e8e</p> <pre><code>pkg/kubelet/kubelet.go\n</code></pre> <p>\uff1a</p> <pre><code>// NewMainKubelet \u51fd\u6570\u5b9e\u4f8b\u5316\u4e00\u4e2a\u65b0\u7684 Kubelet \u5bf9\u8c61\u4ee5\u53ca\u6240\u6709\u5fc5\u9700\u7684\u5185\u90e8\u6a21\u5757\u3002\u6b64\u5904\u4e0d\u4f1a\u521d\u59cb\u5316 Kubelet \u53ca\u5176\u6a21\u5757\u3002\nfunc NewMainKubelet(...) {\n    // \u4e00\u4e9b\u5e38\u89c4\u6821\u9a8c\n    // \u6307\u5b9a\u5bb9\u5668\u5783\u573e\u56de\u6536\u7b56\u7565\n    // \u6307\u5b9a\u955c\u50cf\u5783\u573e\u56de\u6536\u7b56\u7565\n    // \u914d\u7f6e\u9a71\u9010\u76f8\u5173\u7b56\u7565\n    // \u914d\u7f6ekubelet\u5ba2\u6237\u7aef\n    // \u914d\u7f6e\u96c6\u7fa4DNS\n    // \u7ec4\u88c5Kubelet\u7ed3\u6784\u4f53\n    // \u8bbe\u7f6e secretManager\n    // \u8bbe\u7f6e configMapManager\n    // \u8bbe\u7f6e livenessManager\n    // \u8bbe\u7f6e podManager\uff0cpodManager \u8fd8\u8d1f\u8d23\u4fdd\u6301 secretManager \u548c configMapManager \u5185\u5bb9\u4e3a\u6700\u65b0\u3002\n    // \u8bbe\u7f6e statusManager\n    // \u542f\u52a8 docker CRI shim GRPC \u670d\u52a1(\u5305\u62ecRuntimeService\u548cImageService\u4e24\u4e2a\u5ba2\u6237\u7aef):\n    //      \u9ed8\u8ba4 remoteRuntimeEndpoint=unix:///var/run/dockershim.sock\uff0c\u5373\u9ed8\u8ba4\u4f7f\u7528\u672c\u5730\u7684docker\u4f5c\u4e3a\u5bb9\u5668\u8fd0\u884c\u65f6\uff1b\u5982\u679cremoteImageEndpoint\u6ca1\u6709\u6307\u5b9a\uff0c\u5219\u548cremoteRuntimeEndpoint\u4fdd\u6301\u4e00\u81f4\n    // \u7136\u540e\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 kubeGenericRuntimeManager \n    // \u521d\u59cb\u5316\u4e00\u4e2a\u65b0\u7684 GenericPLEG \u5bf9\u8c61\uff0c\u7528\u4e8e\u914d\u7f6epod\u751f\u547d\u5468\u671f\u4e8b\u4ef6\u751f\u6210\u5668\n    // \u7136\u540e\u914d\u7f6e\u5bb9\u5668\u56de\u6536\u7b56\u7565\n    // \u914d\u7f6e\u955c\u50cf\u56de\u6536\u7b56\u7565\n    // \u5982\u679c\u914d\u7f6e\u4e86 Kubelet \u8bc1\u4e66\u81ea\u52a8\u8f6e\u8f6c(\u5f00\u542fRotateKubeletServerCertificate\u7279\u6027)\uff0c\u5219\u521d\u59cb\u5316\u8bc1\u4e66\u7ba1\u7406\u5668\n    // \u7136\u540e\u914d\u7f6eprobe\u7ba1\u7406\u5668(\u63a2\u9488\u7ba1\u7406)\n    // \u751f\u6210\u4e00\u4e2a\u5bf9pod\u7684service account token\u7684\u7ba1\u7406\u5668\n    // \u8c03\u7528\u5982\u4e0b\u65b9\u6cd5\u914d\u7f6evolume\u63d2\u4ef6\u7ba1\u7406\u5668\uff1a\n    //      NewInitializedVolumePluginMgr\u51fd\u6570\u521d\u59cb\u5316Kubelet runtimeState\u4e0a\u7684\u4e00\u4e9bstorageErrors\uff08\u5728csi_plugin.go init\u4e2d\uff09\uff0c\u8fd9\u4f1a\u5f71\u54cd\u8282\u70b9d\u7684\u5c31\u7eea\u72b6\u6001\u3002\u5fc5\u987b\u5728\u521d\u59cb\u5316Kubelet\u4e4b\u524d\u8c03\u7528\u6b64\u51fd\u6570\uff0c\u4ee5\u4fbf\u8282\u70b9ReadyState\u5728\u5b58\u50a8\u72b6\u6001\u4e0b\u51c6\u786e\u65e0\u8bef\u3002\n    klet.volumePluginMgr, err =\n        NewInitializedVolumePluginMgr(klet, secretManager, configMapManager, tokenManager, kubeDeps.VolumePlugins, kubeDeps.DynamicPluginProber)\n    // \u7136\u540e\u914d\u7f6evolume\u7ba1\u7406\u5668\n    // \u914d\u7f6eeviction(\u9a71\u9010)\u7ba1\u7406\u5668\n    // \u5982\u679c\u5f00\u542f\u4e86NodeLease\u7279\u6027(\u8282\u70b9\u751f\u547d\u5468\u671f\u63a7\u5236\u5668\u4f7f\u7528lease api\u62a5\u544a\u7684\u5fc3\u8df3\u6765\u4f5c\u4e3a\u8282\u70b9\u5065\u5eb7\u7684\u4fe1\u53f7))\uff0c\u5219\u914d\u7f6enodeLease\u63a7\u5236\u5668\n    // \u6700\u540e\uff0c\u5c06\u6700\u65b0\u7248\u672c\u7684\u914d\u7f6e\u653e\u5728 Kubelet \u4e0a\uff0c\u4ee5\u4fbf\u53ef\u4ee5\u770b\u5230\u5b83\u7684\u914d\u7f6e\u65b9\u5f0f:\n    klet.kubeletConfiguration = *kubeCfg\n    // \u6700\u540e\u7684\u6700\u540e\uff0c\u751f\u6210\u72b6\u6001\u51fd\u6570\u5e94\u8be5\u662f\u6211\u4eec\u505a\u7684\u6700\u540e\u4e00\u4ef6\u4e8b\uff0c\u56e0\u4e3a\u8fd9\u4f9d\u8d56\u4e8e\u5df2\u7ecf\u6784\u9020\u7684Kubelet\u7684\u5176\u4ed6\u90e8\u5206\u3002\n    // defaultNodeStatusFuncs \u662f\u4e00\u4e2a\u5de5\u5382\u51fd\u6570(\u4f4d\u4e8epkg/kubelet/kubelet_node_status.go)\uff0c\u5b83\u751f\u6210\u4e00\u7ec4\u9ed8\u8ba4\u7684 setNodeStatus \u51fd\u6570\n    klet.setNodeStatusFuncs = klet.defaultNodeStatusFuncs()\n\n    return klet, nil\n}\n</code></pre> <p>\u5176\u4e2d startKubelet \u51fd\u6570\u5728\u8c03\u7528\u4e0a\u9762\u7684 createAndInitKubelet \u51fd\u6570\u83b7\u53d6\u5230\u6700\u65b0\u7684 kubelet \u542f\u52a8\u5bf9\u8c61\u4ee5\u540e\uff0c\u76f4\u63a5\u542f\u52a8 kubelet \u7684\u4e00\u4e2aserver\uff1a</p> <pre><code>// startKubelet \u51fd\u6570\u5f88\u7b80\u5355\u5c31\u662f\u76f4\u63a5\u542f\u52a8\u4e00\u4e2a kubelet \u7684server\uff0c\nfunc startKubelet(k kubelet.Bootstrap, podCfg *config.PodConfig, kubeCfg *kubeletconfiginternal.KubeletConfiguration, kubeDeps *kubelet.Dependencies, enableCAdvisorJSONEndpoints, enableServer bool) {\n    // \u5f00\u542f\u4e00\u4e2agoroutine\uff0c\u8c03\u7528Run\u51fd\u6570\uff0c\u4e0d\u9000\u51fa\u3002\n    go wait.Until(func() {\n        k.Run(podCfg.Updates())\n    }, 0, wait.NeverStop)\n\n    // \u5f00\u542f kubelet server\n    if enableServer {\n        go k.ListenAndServe(net.ParseIP(kubeCfg.Address), uint(kubeCfg.Port), kubeDeps.TLSOptions, kubeDeps.Auth, enableCAdvisorJSONEndpoints, kubeCfg.EnableDebuggingHandlers, kubeCfg.EnableContentionProfiling)\n\n    }\n    // \u5982\u679c\u5f00\u542f\u4e86\u53ea\u8bfb\u7aef\u53e3\uff0c\u7136\u540e\u4e5f\u4f1a\u5728\u4e00\u4e2agorouting \u91cc\u9762\u5f00\u542f\u4e00\u4e2a\u53ea\u8bfb\u7684 server\n    if kubeCfg.ReadOnlyPort &gt; 0 {\n        go k.ListenAndServeReadOnly(net.ParseIP(kubeCfg.Address), uint(kubeCfg.ReadOnlyPort), enableCAdvisorJSONEndpoints)\n    }\n    // \u5982\u679c\u5f00\u542f\u4e86 kubelet \u7684 pod \u8d44\u6e90 grpc \u670d\u52a1\uff0c\u5219\u540c\u6837\u8fd0\u884c \u4e00\u4e2akubelet \u7684 podresource grpc \u670d\u52a1\n    if utilfeature.DefaultFeatureGate.Enabled(features.KubeletPodResources) {\n        go k.ListenAndServePodResources()\n    }\n}\n</code></pre> <p>\u5176\u4e2d Run \u51fd\u6570\uff0c\u4f4d\u4e8e</p> <pre><code>pkg/kubelet/kubelet.go\n</code></pre> <p>\uff0c\u8fd0\u884c\u542f\u52a8 kubelet \u54cd\u5e94\u914d\u7f6e\u66f4\u65b0\uff1a</p> <pre><code>func (kl *Kubelet) Run(updates &lt;-chan kubetypes.PodUpdate) {\n    // \u914d\u7f6e logServer\n    // \u68c0\u67e5 kubeClient\n    // \u5f00\u542f cloud provider \u540c\u6b65\u7ba1\u7406\u5668\n    // \u8c03\u7528 initializeModules \u51fd\u6570\u521d\u59cb\u5316\u5185\u90e8\u6a21\u5757\uff08\u4e0d\u9700\u8981\u542f\u52a8\u5bb9\u5668\u8fd0\u884c\u65f6\uff09\n    if err := kl.initializeModules(); err != nil {\n        kl.recorder.Eventf(kl.nodeRef, vEventTypeWarning, events.KubeletSetupFailed, err.Error())\n        klog.Fatal(err)\n    }\n    // \u542f\u52a8 volume \u7ba1\u7406\u5668\n    if kl.kubeClient != nil {\n        // \u7acb\u5373\u5f00\u59cb\u540c\u6b65\u8282\u70b9\u72b6\u6001\uff0c\u8fd9\u53ef\u80fd\u4f1a\u8bbe\u7f6e\u8fd0\u884c\u65f6\u9700\u8981\u8fd0\u884c\u7684\u5185\u5bb9\n        go wait.Until(kl.syncNodeStatus, kl.nodeStatusUpdateFrequency, wait.NeverStop)\n\n        // FastStatusUpdateOnce \u51fd\u6570\u542f\u52a8\u4e00\u4e2a\u5faa\u73af\uff0c\u5728\u5e94\u7528CIDR\u65f6\u68c0\u67e5\u5185\u90e8\u8282\u70b9\u7d22\u5f15\u5668\u7f13\u5b58\uff0c\u5e76\u5c1d\u8bd5\u7acb\u5373\u66f4\u65b0POD CIDR\u3002\u66f4\u65b0pod CIDR\u540e\uff0c\u5b83\u4f1a\u89e6\u53d1\u8fd0\u884c\u65f6\u66f4\u65b0\u548c\u8282\u70b9\u72b6\u6001\u66f4\u65b0\u3002\u51fd\u6570\u5728\u4e00\u6b21\u6210\u529f\u7684\u8282\u70b9\u72b6\u6001\u66f4\u65b0\u540e\u76f4\u63a5\u8fd4\u56de\u3002\u8be5\u529f\u80fd\u4ec5\u5728 kubelet \u542f\u52a8\u671f\u95f4\u6267\u884c\uff0c\u901a\u8fc7\u5c3d\u5feb\u66f4\u65b0 pod cidr\u3001\u8fd0\u884c\u65f6\u72b6\u6001\u548c\u8282\u70b9\u72b6\u6001\u6765\u63d0\u9ad8\u51c6\u5907\u5c31\u7eea\u8282\u70b9\u7684\u5ef6\u8fdf\u3002\n        go kl.fastStatusUpdateOnce()\n\n        // \u5f00\u59cb\u540c\u6b65 lease\n        if utilfeature.DefaultFeatureGate.Enabled(features.NodeLease) {\n            go kl.nodeLeaseController.Run(wait.NeverStop)\n        }\n    }\n    // \u6bcf5s\u8c03\u7528\u4e00\u6b21updateRuntimeUp\u51fd\u6570\u68c0\u67e5\u5bb9\u5668\u8fd0\u884c\u65f6\u72b6\u6001\n    go wait.Until(kl.updateRuntimeUp, 5*time.Second, wait.NeverStop)\n\n    // \u542f\u52a8\u5faa\u73af\u540c\u6b65 iptables \u89c4\u5219\n    if kl.makeIPTablesUtilChains {\n        // \u4e0d\u8fc7\u5f53\u524dsyncNetworkUtil\u51fd\u6570\u662f\u4e00\u4e2a\u7a7a\u5b9e\u73b0\n        go wait.Until(kl.syncNetworkUtil, 1*time.Minute, wait.NeverStop)\n    }\n\n    // \u5f53 pod \u6ca1\u6709\u88ab podworker \u6b63\u786e\u5904\u7406\u7684\u65f6\u5019\uff0c\u542f\u52a8\u4e00\u4e2a goroutine \u6740\u6b7bpod\u3002\n    go wait.Until(kl.podKiller, 1*time.Second, wait.NeverStop)\n\n    // \u542f\u52a8\u7ec4\u4ef6\u540c\u6b65\u5faa\u73af\n    //      \u4f7f\u7528apiserver\u540c\u6b65pods\u72b6\u6001; \u4e5f\u7528\u4f5c\u72b6\u6001\u7f13\u5b58\u3002\n    kl.statusManager.Start()\n    //      \u5904\u7406\u5bb9\u5668\u63a2\u9488\n    kl.probeManager.Start()\n\n    // \u542f\u52a8 RuntimeClass \u63a7\u5236\u5668\n    if kl.runtimeClassManager != nil {\n        kl.runtimeClassManager.Start(wait.NeverStop)\n    }\n\n    // \u542f\u52a8 Pod \u751f\u547d\u5468\u671f\u4e8b\u4ef6\u751f\u6210\u5668\u3002\n    // PodLifecycleEventGenerator \u662f\u4e00\u4e2a\u5305\u542b\u4e0b\u9762\u51fd\u6570\u7684pod\u751f\u547d\u5468\u671f\u4e8b\u4ef6\u751f\u6210\u5668\u63a5\u53e3\uff1a\n    // type PodLifecycleEventGenerator interface {\n    //     Start()\n    //     Watch() chan *PodLifecycleEvent\n    //     Healthy() (bool, error)\n    // }\n    kl.pleg.Start()\n    // \u8c03\u7528updates\u7684\u540c\u6b65\u5faa\u73af\n    kl.syncLoop(updates, kl)\n}\n</code></pre> <p>\u5176\u4e2d initializeModules \u51fd\u6570\u7528\u6765\u521d\u59cb\u5316\u5185\u90e8\u5f97\u4e00\u4e9b\u6a21\u5757\uff08\u4e0d\u9700\u8981\u542f\u52a8\u5bb9\u5668\u8fd0\u884c\u65f6\uff09</p> <pre><code>func (kl *Kubelet) initializeModules() error {\n    // \u6ce8\u518c prometheus metrics \u63a5\u53e3\n    // \u521b\u5efa\u6587\u4ef6\u7cfb\u7edf\u76ee\u5f55:\n    //      \u6839\u76ee\u5f55 pods\u76ee\u5f55 \u63d2\u4ef6\u76ee\u5f55 pod-resources \u76ee\u5f55\n    if err := kl.setupDataDirs(); err != nil {\n        return err\n    }\n    // \u5982\u679c\u5bb9\u5668\u65e5\u5fd7\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u5219\u521b\u5efa\u8be5\u76ee\u5f55(/var/log/containers)\n\n    // \u7136\u540e\u542f\u52a8\u955c\u50cf\u7ba1\u7406\u5668\n    kl.imageManager.Start()\n\n    // \u5f00\u542f certificate \u7ba1\u7406\u5668\n    if kl.serverCertificateManager != nil {\n        kl.serverCertificateManager.Start()\n    }\n\n    // \u5f00\u542f out of memory \u76d1\u542c\u5668\n    if err := kl.oomWatcher.Start(kl.nodeRef); err != nil {\n        return fmt.Errorf(\"Failed to start OOM watcher %v\", err)\n    }\n\n    // \u5f00\u542f\u8d44\u6e90\u5206\u6790\u5668\n    kl.resourceAnalyzer.Start()\n\n    return nil\n}\n</code></pre> <p>\u7136\u540e\u5c31\u662f\u8c03\u7528 syncNodeStatus \u51fd\u6570\u5931\u6548\u8282\u70b9\u72b6\u6001\u540c\u6b65\uff0c\u4f4d\u4e8e</p> <pre><code>pkg/kubelet/kubelet_node_status.go\n</code></pre> <p>:</p> <pre><code>// syncNodeStatus \u51fd\u6570\u5b9a\u671f\u88ab\u4e00\u4e2agoroutine\u6240\u8c03\u7528\u3002\n// \u5982\u679c\u548c\u4e0a\u6b21\u540c\u6b65\u5bf9\u6bd4\u6709\u4efb\u4f55\u53d8\u5316\u6216\u8005\u4e0a\u6b21\u540c\u6b65\u7ecf\u8fc7\u7684\u65f6\u95f4\u8db3\u591f\u957f\uff0c\u5b83\u4f1a\u5c06\u8282\u70b9\u72b6\u6001\u540c\u6b65\u5230 master\uff0c\u5982\u679c\u9700\u8981\u8bf7\u5148\u6ce8\u518c kubelet \u3002\nfunc (kl *Kubelet) syncNodeStatus() {\n    kl.syncNodeStatusMux.Lock()\n    defer kl.syncNodeStatusMux.Unlock()\n\n    if kl.kubeClient == nil || kl.heartbeatClient == nil {\n        return\n    }\n    // \u5982\u679c\u5f00\u542f\u4e86registerNode\n    if kl.registerNode {\n        // \u5982\u679c\u4e0d\u9700\u8981\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\uff0c\u5b83\u5c06\u7acb\u5373\u9000\u51fa\u3002registerWithApiServer \u51fd\u6570\u5411\u7fa4\u96c6 APIServer \u6ce8\u518c\u8282\u70b9\u3002\u53ef\u4ee5\u5b89\u5168\u5730\u591a\u6b21\u8c03\u7528\uff0c\u4f46\u4e0d\u80fd\u540c\u65f6\u8c03\u7528\uff08kl.registrationcompleted \u672a\u52a0\u9501\uff09\u3002\n        kl.registerWithAPIServer()\n    }\n    if err := kl.updateNodeStatus(); err != nil {\n        klog.Errorf(\"Unable to update node status: %v\", err)\n    }\n}\n</code></pre> <p>\u8c03\u7528 updateNodeStatus \u51fd\u6570\u66f4\u65b0\u8282\u70b9\u72b6\u6001:</p> <pre><code>// updateNodeStatus \u51fd\u6570\u66f4\u65b0\u8282\u70b9\u72b6\u6001\u5230 master\uff0c\u5982\u679c\u4e0a\u6b21\u540c\u6b65\u6709\u4efb\u4f55\u66f4\u6539\u6216\u7ecf\u8fc7\u8db3\u591f\u7684\u65f6\u95f4\uff0c\u5219\u91cd\u8bd5\u4e00\u6b21\uff0c\u6700\u591a\u91cd\u8bd55\u6b21\nfunc (kl *Kubelet) updateNodeStatus() error {\n    klog.V(5).Infof(\"Updating node status\")\n    for i := 0; i &lt; nodeStatusUpdateRetry; i++ {\n        // \u8c03\u7528 tryUpdateNodeStatus \u51fd\u6570\u5c1d\u8bd5\u8fdb\u884c\u72b6\u6001\u66f4\u65b0\n        if err := kl.tryUpdateNodeStatus(i); err != nil {\n            // \u5f53\u5fc3\u8df3\u64cd\u4f5c\u5931\u8d25\u591a\u6b21\u65f6\uff0c\u8c03\u7528 onRepeatedHeartBeatFailure \u51fd\u6570\n            if i &gt; 0 &amp;&amp; kl.onRepeatedHeartbeatFailure != nil {\n                kl.onRepeatedHeartbeatFailure()\n            }\n            klog.Errorf(\"Error updating node status, will retry: %v\", err)\n        } else {\n            return nil\n        }\n    }\n    return fmt.Errorf(\"update node status exceeds retry count\")\n}\n</code></pre> <p>\u8c03\u7528 tryUpdateNodeStatus \u51fd\u6570\u5c1d\u8bd5\u53bb\u8fdb\u884c\u771f\u6b63\u7684\u8282\u70b9\u72b6\u6001\u66f4\u65b0\uff1a</p> <pre><code>func (kl *Kubelet) tryUpdateNodeStatus(tryNumber int) error {\n    // \u5728\u5927\u578b\u96c6\u7fa4\u4e2d\uff0c\u8fd9\u91cc\u7684\u8282\u70b9\u5bf9\u8c61\u7684 GET \u548c PUT \u64cd\u4f5c\u662f apiserver \u548c etcd \u4e0a\u7684\u4e3b\u8981\u8d1f\u8f7d\u3002\n    // \u4e3a\u4e86\u51cf\u5c11 etcd \u4e0a\u7684\u8d1f\u8f7d\uff0c\u6211\u4eec\u63d0\u4f9b\u4e86\u4ece apiserver \u7f13\u5b58\u83b7\u53d6\u64cd\u4f5c\uff08\u6570\u636e\u53ef\u80fd\u7a0d\u6709\u5ef6\u8fdf\uff0c\u4f46\u4f3c\u4e4e\u4e0d\u4f1a\u9020\u6210\u66f4\u591a\u51b2\u7a81-\u5ef6\u8fdf\u975e\u5e38\u5c0f\uff09\u3002\n    // \u5982\u679c\u5bfc\u81f4\u51b2\u7a81\uff0c\u5219\u6240\u6709\u91cd\u8bd5\u90fd\u76f4\u63a5\u4ece etcd \u63d0\u4f9b\u3002\n    opts := metavGetOptions{}\n    if tryNumber == 0 {\n        util.FromApiserverCache(&amp;opts)\n    }\n    node, err := kl.heartbeatClient.CoreV1().Nodes().Get(string(kl.nodeName), opts)\n    if err != nil {\n        return fmt.Errorf(\"error getting node %q: %v\", kl.nodeName, err)\n    }\n\n    originalNode := node.DeepCopy()\n    if originalNode == nil {\n        return fmt.Errorf(\"nil %q node object\", kl.nodeName)\n    }\n\n    podCIDRChanged := false\n    if node.Spec.PodCIDR != \"\" {\n        // Pod CIDR \u4e4b\u524d\u5c31\u5df2\u7ecf\u66f4\u65b0\u8fc7\u4e86\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5224\u65adnode.Spec.PodCIDR\u662f\u5426\u4e3a\u7a7a\uff0c\u8fd8\u9700\u8981\u77e5\u9053 pod CIDR \u662f\u5426\u771f\u7684\u5df2\u7ecf\u6539\u53d8\u4e86\u3002\n        if podCIDRChanged, err = kl.updatePodCIDR(node.Spec.PodCIDR); err != nil {\n            klog.Errorf(err.Error())\n        }\n    }\n\n    // setNodeStatus \u51fd\u6570\u5c31\u662f\u8c03\u7528\u4e0a\u9762\u6211\u4eec\u8bbe\u7f6e\u7684 setNodeStatusFuncs \u51fd\u6570\u5217\u8868\u6765\u8fdb\u884c\u72b6\u6001\u66f4\u65b0\n    kl.setNodeStatus(node)\n\n    // \u5982\u679c\u5f00\u542f\u4e86 NodeLease \u7279\u6027\n    now := kl.clock.Now()\n    if utilfeature.DefaultFeatureGate.Enabled(features.NodeLease) &amp;&amp; now.Before(kl.lastStatusReportTime.Add(kl.nodeStatusReportFrequency)) {\n        if !podCIDRChanged &amp;&amp; !nodeStatusHasChanged(&amp;originalNode.Status, &amp;node.Status) {\n            // \u5c06\u6307\u5b9a\u7684\u5377\u6807\u8bb0\u4e3a\u5df2\u5728\u8282\u70b9\u7684\u5377\u72b6\u6001\u4e2d\u6210\u529f\u62a5\u544a\u4e3a\u201c\u6b63\u5728\u4f7f\u7528\u201d\u3002\n            kl.volumeManager.MarkVolumesAsReportedInUse(node.Status.VolumesInUse)\n            return nil\n        }\n    }\n\n    // Patch \u73b0\u5728\u8282\u70b9\u7684\u72b6\u6001\u5230 APIServer\n    updatedNode, _, err := nodeutil.PatchNodeStatus(kl.heartbeatClient.CoreV1(), types.NodeName(kl.nodeName), originalNode, node)\n    if err != nil {\n        return err\n    }\n    // \u8bbe\u7f6e\u5f53\u524d\u65f6\u95f4\u4e3a\u6700\u8fd1\u4e00\u6b21\u72b6\u6001\u4e0a\u62a5\u65f6\u95f4\n    kl.lastStatusReportTime = now\n    kl.setLastObservedNodeAddresses(updatedNode.Status.Addresses)\n    // \u5982\u679c\u66f4\u65b0\u6210\u529f\u5b8c\u6210\uff0c\u8bf7\u5c06\u5377\u4f7f\u7528\u6807\u8bb0\u4e3aReportedInUse\u4ee5\u8868\u660e\u8fd9\u4e9b\u5377\u5df2\u5728\u8282\u70b9\u72b6\u6001\u4e0b\u66f4\u65b0\n    kl.volumeManager.MarkVolumesAsReportedInUse(updatedNode.Status.VolumesInUse)\n    return nil\n}\n</code></pre>"},{"location":"kubernetes_code/client_go/deltafifo/","title":"workqueue","text":""},{"location":"kubernetes_code/client_go/deltafifo/#deltafifo","title":"DeltaFIFO","text":"<p>\u5728\u4ecb\u7ecd Informer \u4e4b\u524d\uff0c\u6211\u4eec\u8fd8\u5f97\u5148\u4ecb\u7ecd\u4e00\u4e2a <code>DeltaFIFO</code> \u7684\u6982\u5ff5\uff0c\u4ece\u4e0b\u56fe\u53ef\u4ee5\u770b\u51fa\u6765 <code>DeltaFIFO</code> \u4e5f\u5305\u542b\u5728 Informer \u4e2d\u3002</p> <p></p> <p>client-go \u5b98\u65b9\u67b6\u6784\u56fe\uff1a</p> <p></p> <p>DeltaFIFO \u662f\u4e00\u4e2a\u751f\u4ea7\u8005-\u6d88\u8d39\u8005\u7684\u961f\u5217\uff0c\u751f\u4ea7\u8005\u662f Reflector\uff0c\u6d88\u8d39\u8005\u662f Pop \u51fd\u6570\uff0c\u4ece\u67b6\u6784\u56fe\u4e0a\u53ef\u4ee5\u770b\u51fa DeltaFIFO \u7684\u6570\u636e\u6765\u6e90\u4e3a Reflector\uff0c\u901a\u8fc7 Pop \u64cd\u4f5c\u6d88\u8d39\u6570\u636e\uff0c\u6d88\u8d39\u7684\u6570\u636e\u4e00\u65b9\u9762\u5b58\u50a8\u5230 Indexer \u4e2d\uff0c\u53e6\u4e00\u65b9\u9762\u53ef\u4ee5\u901a\u8fc7 Informer \u7684 handler \u8fdb\u884c\u5904\u7406\uff0cInformer \u7684 handler \u5904\u7406\u7684\u6570\u636e\u9700\u8981\u4e0e\u5b58\u50a8\u5728 Indexer \u4e2d\u7684\u6570\u636e\u5339\u914d\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cPop \u7684\u5355\u4f4d\u662f\u4e00\u4e2a Deltas\uff0c\u800c\u4e0d\u662f Delta\u3002</p> <p>DetlaFIFO \u540c\u65f6\u5b9e\u73b0\u4e86 Queue \u548c Store \u63a5\u53e3\uff0c\u4f7f\u7528 Deltas \u4fdd\u5b58\u4e86\u5bf9\u8c61\u72b6\u6001\u7684\u53d8\u66f4\uff08Add/Delete/Update\uff09\u4fe1\u606f\uff08\u5982 Pod \u7684\u5220\u9664\u6dfb\u52a0\u9093\uff09\uff0cDeltas \u7f13\u5b58\u4e86\u9488\u5bf9\u76f8\u540c\u5bf9\u8c61\u7684\u591a\u4e2a\u72b6\u6001\u53d8\u66f4\u4fe1\u606f\uff0c\u5982 Pod \u7684 Deltas[0]\u53ef\u80fd\u66f4\u65b0\u4e86\u6807\u7b7e\uff0cDeltas[1]\u53ef\u80fd\u5220\u9664\u4e86\u8be5 Pod\u3002\u6700\u8001\u7684\u72b6\u6001\u53d8\u66f4\u4fe1\u606f\u4e3a Oldest()\uff0c\u6700\u65b0\u7684\u72b6\u6001\u53d8\u66f4\u4fe1\u606f\u4e3a Newest()\uff0c\u4f7f\u7528\u4e2d\uff0c\u83b7\u53d6 DeltaFIFO \u4e2d\u5bf9\u8c61\u7684 key \u4ee5\u53ca\u83b7\u53d6 DeltaFIFO \u90fd\u4ee5\u6700\u65b0\u72b6\u6001\u4e3a\u51c6\u3002</p>"},{"location":"kubernetes_code/client_go/deltafifo/#_1","title":"\u63a5\u53e3","text":"<p>Delta \u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a\u53d8\u5316\uff0c\u5728 client-go \u4e2d\u5173\u4e8e Delta \u7684\u5b9a\u4e49\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/tools/cache/delta_fifo.go\n// DeltaType \u662f\u53d8\u5316\u7c7b\u578b (\u6dfb\u52a0\u3001\u5220\u9664\u7b49)\ntype DeltaType string\n\nconst (\n    Added   DeltaType = \"Added\"  // \u589e\u52a0\n    Updated DeltaType = \"Updated\"  // \u66f4\u65b0\n    Deleted DeltaType = \"Deleted\"  // \u5220\u9664\n    Sync DeltaType = \"Sync\"  // \u540c\u6b65\n)\n\n// Delta \u662f DeltaFIFO \u5b58\u50a8\u7684\u7c7b\u578b\uff0c\u4ed6\u544a\u8bc9\u4f60\u53d1\u751f\u4e86\u4ec0\u4e48\u53d8\u5316\u4ee5\u53ca\u53d8\u5316\u540e\u5bf9\u8c61\u7684\u72b6\u6001\u3002\ntype Delta struct {\n    Type   DeltaType  // Delta \u7c7b\u578b\n    Object interface{}  // \u5bf9\u8c61\uff0cDelta\u7684\u7c92\u5ea6\u662f\u4e00\u4e2a\u5bf9\u8c61\n}\n</code></pre> <p>Delta \u5176\u5b9e\u5c31\u662f Kubernetes \u4e2d\u5bf9\u8c61\u7684\u53d8\u5316\uff08\u589e\u3001\u5220\u3001\u6539\u3001\u540c\u6b65\uff09\uff0cFIFO \u662f\u4e00\u4e2a\u5148\u5165\u5148\u51fa\u7684\u961f\u5217\uff0c\u90a3\u4e48 DeltaFIFO \u5c31\u662f\u4e00\u4e2a\u6309\u5e8f\u7684\uff08\u5148\u5165\u5148\u51fa\uff09Kubernetes \u5bf9\u8c61\u53d8\u5316\u7684\u961f\u5217\u3002\u9664\u4e86 Delta \u4e4b\u5916\u8fd8\u6709\u51e0\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u7c7b\u578b\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/tools/cache/delta_fifo.go\n// KeyLister \u548c KeyGetter \u7684\u7ec4\u5408\ntype KeyListerGetter interface {\n    KeyLister\n    KeyGetter\n}\n\n// KeyLister \u662f\u4e00\u4e2a\u901a\u7528\u7684\u63a5\u53e3\u7c7b\u578b\uff0c\u53ea\u5b9a\u4e49\u4e86\u4e00\u4e2a\u63a5\u53e3\u51fd\u6570\ntype KeyLister interface {\n    ListKeys() []string  // \u8fd4\u56de\u6240\u6709\u7684keys\n}\n\ntype KeyGetter interface {\n    GetByKey(key string) (interface{}, bool, error)  // \u901a\u8fc7 key \u83b7\u53d6\u5bf9\u8c61\n}\n</code></pre> <p>\u5176\u5b9e\u6211\u4ed4\u7ec6\u89c2\u5bdf\u4f1a\u53d1\u73b0\u524d\u9762 Indexer \u4e2d\u63d0\u5230\u7684 cache\uff08</p> <pre><code>client-go/tools/cache/store\n</code></pre> <p>\uff09\u5c31\u5b9e\u73b0\u4e86\u4e0a\u9762\u4e09\u4e2a\u63a5\u53e3\uff0c\u4e0a\u9762\u4e09\u4e2a\u63a5\u53e3\u57fa\u672c\u4e0a\u5c31\u662f kv \u7684\u6807\u51c6\u63a5\u53e3\uff0c\u4f46\u51e1\u662f\u901a\u8fc7 kv \u65b9\u5f0f\u8bbf\u95ee\u7684\u5bf9\u8c61(\u5b58\u50a8\u3001\u961f\u5217\u3001\u7d22\u5f15\u7b49)\u591a\u534a\u5177\u5907\u4ee5\u4e0a\u63a5\u53e3\u3002\u80af\u5b9a\u6709\u4eba\u4f1a\u95ee\u76f4\u63a5\u4f7f\u7528\u5177\u4f53\u7684\u7c7b\u578b\u4e0d\u5c31\u5b8c\u4e86\u4e48\uff0c\u5b9a\u4e49\u8fd9\u4e9b\u6709\u4ec0\u4e48\u7528\uff1f\u7b54\u6848\u5f88\u7b80\u5355\uff0c\u5f53\u4f60\u9700\u8981\u5bf9 kv \u7684\u5bf9\u8c61\u53ea\u8bfb\u4f46\u662f\u4e0d\u5173\u5fc3\u5177\u4f53\u5b9e\u73b0\u65f6\u5c31\u7528\u4e0a\u4e86~</p> <p>\u63a5\u4e0b\u6765\u518d\u6765\u8ba4\u8bc6\u4e00\u4e2a\u7c7b\u578b\uff1a</p> <pre><code>// client-go/tools/cache/fifo.go\n// Queue \u624d\u662f FIFO \u7684\u62bd\u8c61\uff0cDeltaFIFO \u662f\u4e00\u79cd\u5177\u4f53\u7684\u5b9e\u73b0\uff0c\u548c Store \u76f8\u540c\uff0c\u4f46\u4e5f\u6709\u4e00\u4e2aPop\uff08\uff09\u65b9\u6cd5\u3002\ntype Queue interface {\n    Store  // \u5b9e\u73b0\u4e86\u5b58\u50a8\u63a5\u53e3\uff0cFIFO\u4e5f\u662f\u4e00\u79cd\u5b58\u50a8\n    Pop(PopProcessFunc) (interface{}, error)  // \u5f39\u51fa\u5bf9\u8c61\n    AddIfNotPresent(interface{}) error  // \u5bf9\u8c61\u5982\u679c\u4e0d\u5728\u961f\u5217\u4e2d\u5c31\u6dfb\u52a0\n    HasSynced() bool  // \u901a\u8fc7Replace()\u653e\u5165\u7b2c\u4e00\u6279\u5bf9\u8c61\u5230\u961f\u5217\u4e2d\u5e76\u4e14\u5df2\u7ecf\u88abPop()\u5168\u90e8\u53d6\u8d70\n    Close()  // \u5173\u95ed\u961f\u5217\n}\n</code></pre> <p><code>Queue</code> \u662f\u5728 Store \u57fa\u7840\u4e0a\u6269\u5c55\u4e86 Pop \u65b9\u6cd5\u53ef\u4ee5\u8ba9\u5bf9\u8c61\u6709\u5e8f\u7684\u5f39\u51fa\uff0cIndexer \u662f\u5728 Store \u57fa\u7840\u4e0a\u5efa\u7acb\u4e86\u7d22\u5f15\uff0c\u53ef\u4ee5\u5feb\u901f\u68c0\u7d22\u5bf9\u8c61\u3002</p>"},{"location":"kubernetes_code/client_go/deltafifo/#_2","title":"\u5b9e\u73b0","text":"<p>\u4e0a\u9762\u662f Queue \u7684\u63a5\u53e3\u62bd\u8c61\u5b9a\u4e49\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u770b\u4e0b\u5177\u4f53\u7684\u5b9e\u73b0 DeltaFIFO\uff0c\u5bf9\u5e94\u7684\u7ed3\u6784\u4f53\u5b9a\u4e49\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/tools/cache/delta_fifo.go\ntype DeltaFIFO struct {\n    lock sync.RWMutex  // \u8bfb\u5199\u9501\n    cond sync.Cond  // \u7ed9Pop()\u51fd\u6570\u4f7f\u7528\uff0c\u5728\u6ca1\u6709\u5bf9\u8c61\u7684\u65f6\u5019\u53ef\u4ee5\u963b\u585e\uff0c\u5185\u90e8\u9501\u590d\u7528\u8bfb\u5199\u9501\n\n    items map[string]Deltas // \u6309\u7167kv\u7684\u65b9\u5f0f\u5b58\u50a8\u5bf9\u8c61\uff0c\u4f46\u662f\u5b58\u50a8\u7684\u662f\u5bf9\u8c61\u7684Deltas\u6570\u7ec4\n    queue []string  // \u4e3a\u5148\u5165\u5148\u51fa\u5b9e\u73b0\u7684\uff0c\u5b58\u50a8\u7684\u662f\u5bf9\u8c61\u7684\u952e\n\n    populated bool  // \u901a\u8fc7 Replace() \u63a5\u53e3\u5c06\u7b2c\u4e00\u6279\u5bf9\u8c61\u653e\u5165\u961f\u5217\uff0c\u6216\u8005\u7b2c\u4e00\u6b21\u8c03\u7528\u589e\u3001\u5220\u3001\u6539\u63a5\u53e3\u65f6\u6807\u8bb0\u4e3atrue\n    initialPopulationCount int  // \u901a\u8fc7 Replace() \u63a5\u53e3\u5c06\u7b2c\u4e00\u6279\u5bf9\u8c61\u653e\u5165\u961f\u5217\u7684\u5bf9\u8c61\u6570\u91cf\n\n    keyFunc KeyFunc  // \u5bf9\u8c61\u952e\u8ba1\u7b97\u51fd\u6570\n\n    knownObjects KeyListerGetter  // \u5176\u5b9e\u5c31\u662f Indexer\n\n    closed     bool  // \u662f\u5426\u5df2\u7ecf\u5173\u95ed\u7684\u6807\u8bb0\n    closedLock sync.Mutex\n}\n</code></pre> <p>\u5176\u4e2d\u6bd4\u8f83\u96be\u7406\u89e3\u7684\u662f knownObjects\uff0c\u5b83\u7684\u7c7b\u578b\u662f KeyListerGetter\uff0c\u8fd9\u4e2a\u63a5\u53e3\u4e2d\u7684 ListKeys \u548c GetByKey \u65b9\u6cd5\u4e5f\u662f Store \u63a5\u53e3\u4e2d\u7684\u65b9\u6cd5\uff0c\u6240\u4ee5 knownObjects \u80fd\u591f\u88ab\u8d4b\u503c\u4e3a\u5b9e\u73b0\u4e86 Store \u7684\u7c7b\u578b\u6307\u9488\uff1b\u540c\u6837\u5730\uff0c\u7531\u4e8e Indexer \u7ee7\u627f\u4e86 Store \u65b9\u6cd5\uff0c\u6240\u4ee5 knonwObjects \u80fd\u591f\u88ab\u8d4b\u503c\u4e3a\u5b9e\u73b0\u4e86 Indexer \u7684\u7c7b\u578b\u6307\u9488\u3002knownObjects \u5b9e\u9645\u4f7f\u7528\u65f6\u662f Indexer\uff0c\u5bf9\u5e94\u56fe\u4e2d\u5f97 localStore\u3002DeltaFIFO \u6839\u636e\u5176\u4fdd\u5b58\u5f97\u5bf9\u8c61\u72b6\u6001\u53d8\u66f4\u6d88\u606f\u5904\u7406\uff08\u589e/\u5220/\u6539/\u540c\u6b65\uff09knownObjects \u4e2d\u76f8\u5e94\u5f97\u5bf9\u8c61\u3002\u540c\u6b65\uff08Sync\uff09Deltas \u4e2d\u5373\u5c06\u88ab\u5220\u9664\u7684\u5bf9\u8c61\u662f\u6ca1\u6709\u4e00\u6837\u7684\u3002</p> <p>DeltaFIFO.knowObjects.GetByKey \u5c31\u662f\u6267\u884c\u7684 store.go \u4e2d\u7684 GetByKey \u51fd\u6570\uff0c\u7528\u4e8e\u83b7\u53d6 Indexer \u4e2d\u7684\u5bf9\u8c61\u952e\u3002</p> <pre><code>initialPopulationCount\n</code></pre> <p>\u7528\u4e8e\u8868\u793a\u662f\u5426\u5b8c\u6210\u5168\u91cf\u540c\u6b65\uff0c\u5728 Replace \u51fd\u6570\u4e2d\u589e\u52a0\uff0c\u5728 Pop \u51fd\u6570\u4e2d\u51cf\u5c0f\uff0c\u5f53 initialPopulationCount \u4e3a 0 \u4e14 populated \u4e3a true \u65f6\u8868\u793a Pop \u4e86\u6240\u6709 Replace \u6dfb\u52a0\u5230 DeltaFIFO \u4e2d\u7684\u5bf9\u8c61\uff0cpopulated \u7528\u4e8e\u5224\u65ad DletaFIFO \u662f\u5426\u4e3a\u521d\u59cb\u5316\u72b6\u6001\uff08\u5373\u6ca1\u6709\u5904\u7406\u8fc7\u4efb\u4f55\u5bf9\u8c61\uff09\u3002</p> <p>DeltaFIFO \u7684\u8ba1\u7b97\u5bf9\u8c61\u952e\u7684\u51fd\u6570\u7565\u6709\u4e0d\u540c:</p> <pre><code>// client-go/tools/cache/delta_fifo.go\n// KeyOf \u66b4\u9732 f \u7684 keyFunc\uff0c\u4f46\u662f\u4e5f\u8981\u68c0\u67e5 Deltas \u5bf9\u8c61\u7684 key\nfunc (f *DeltaFIFO) KeyOf(obj interface{}) (string, error) {\n    // \u5148\u7528 Deltas \u505a\u4e00\u6b21\u5f3a\u5236\u8f6c\u6362\n    if d, ok := obj.(Deltas); ok {\n        if len(d) == 0 {\n            return \"\", KeyError{obj, ErrZeroLengthDeltasObject}\n        }\n        // \u53ea\u7528\u6700\u65b0\u7248\u672c\u7684\u5bf9\u8c61\n        obj = d.Newest().Object\n    }\n    if d, ok := obj.(DeletedFinalStateUnknown); ok {\n        return d.Key, nil\n    }\n    return f.keyFunc(obj)\n}\n</code></pre> <p>DeltaFIFO \u7684\u8ba1\u7b97\u5bf9\u8c61\u952e\u7684\u65b9\u5f0f\u4e3a\u4ec0\u4e48\u8981\u5148\u505a\u4e00\u6b21 Deltas \u7684\u7c7b\u578b\u8f6c\u6362\u5462\uff1f\u539f\u56e0\u5f88\u7b80\u5355\uff0c\u90a3\u5c31\u662f\u4ece DeltaFIFO.Pop() \u51fa\u53bb\u7684\u5bf9\u8c61\u5f88\u53ef\u80fd\u8fd8\u8981\u518d\u6dfb\u52a0\u8fdb\u6765\uff08\u6bd4\u5982\u5904\u7406\u5931\u8d25\u9700\u8981\u518d\u653e\u8fdb\u6765\uff09\uff0c\u6b64\u65f6\u6dfb\u52a0\u7684\u5bf9\u8c61\u5c31\u662f\u5df2\u7ecf\u5c01\u88c5\u597d\u7684 Deltas\u3002</p> <p>\u65e2\u7136 DeltaFIFO \u662f Store \u7684\u4e00\u79cd\u5b9e\u73b0\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u770b\u4e0b DeltaFIFO \u76f8\u5e94\u7684\u5b9e\u73b0\uff1a</p> <pre><code>// client-go/tools/cache/delta_fifo.go\n// Add \u6dfb\u52a0\u5143\u7d20\u5230\u961f\u5217\u4e2d\nfunc (f *DeltaFIFO) Add(obj interface{}) error {\n    f.lock.Lock()\n    defer f.lock.Unlock()\n    f.populated = true  // \u961f\u5217\u7b2c\u4e00\u6b21\u5199\u5165\u64cd\u4f5c\u90fd\u8981\u8bbe\u7f6e\u6807\u8bb0\n    return f.queueActionLocked(Added, obj)\n}\n\n// Update \u548c Add \u4e00\u6837\uff0c\u53ea\u662f\u66f4\u65b0 Delta \u5bf9\u8c61\nfunc (f *DeltaFIFO) Update(obj interface{}) error {\n    f.lock.Lock()\n    defer f.lock.Unlock()\n    f.populated = true  // \u961f\u5217\u7b2c\u4e00\u6b21\u5199\u5165\u64cd\u4f5c\u90fd\u8981\u8bbe\u7f6e\u6807\u8bb0\n    return f.queueActionLocked(Updated, obj)\n}\n\n// Delete \u5220\u9664\u5bf9\u8c61\u63a5\u53e3\nfunc (f *DeltaFIFO) Delete(obj interface{}) error {\n    // \u83b7\u53d6\u5bf9\u8c61\u7684\u5bf9\u8c61\u952e\n    id, err := f.KeyOf(obj)\n    if err != nil {\n        return KeyError{obj, err}\n    }\n    f.lock.Lock()\n    defer f.lock.Unlock()\n    f.populated = true  // \u961f\u5217\u7b2c\u4e00\u6b21\u5199\u5165\u64cd\u4f5c\u90fd\u8981\u8bbe\u7f6e\u6807\u8bb0\n    // knownObjects \u5c31\u662f Indexer\uff0c\u91cc\u9762\u5b58\u6709\u5df2\u77e5\u5168\u90e8\u7684\u5bf9\u8c61\n    if f.knownObjects == nil {\n        // \u6ca1\u6709 Indexer \u5c31\u9700\u8981\u81ea\u5df1\u7684\u5b58\u50a8\u5bf9\u8c61\u6765\u5224\u65ad\n        if _, exists := f.items[id]; !exists {\n            return nil\n        }\n    } else {\n        // \u81ea\u5df1\u7684\u5bf9\u8c61\u6216\u8005Indexer\u91cc\u9762\u6709\u5bf9\u8c61\u952e\u5c31\u7b97\u5b58\u5728\n        _, exists, err := f.knownObjects.GetByKey(id)\n        _, itemsExist := f.items[id]\n        if err == nil &amp;&amp; !exists &amp;&amp; !itemsExist {\n            // Presumably, this was deleted when a relist happened.\n            // Don't provide a second report of the same deletion.\n            return nil\n        }\n    }\n\n    return f.queueActionLocked(Deleted, obj)\n}\n\n// \u5217\u4e3e\u5bf9\u8c61\u952e\u63a5\u53e3\nfunc (f *DeltaFIFO) ListKeys() []string {\n    f.lock.RLock()\n    defer f.lock.RUnlock()\n    list := make([]string, 0, len(f.items))\n    for key := range f.items {\n        list = append(list, key)\n    }\n    return list\n}\n\n// \u5217\u4e3e\u5bf9\u8c61\u63a5\u53e3\nfunc (f *DeltaFIFO) List() []interface{} {\n    f.lock.RLock()\n    defer f.lock.RUnlock()\n    return f.listLocked()\n}\n\n// \u5217\u4e3e\u5bf9\u8c61\u7684\u5177\u4f53\u5b9e\u73b0\nfunc (f *DeltaFIFO) listLocked() []interface{} {\n    list := make([]interface{}, 0, len(f.items))\n    for _, item := range f.items {\n        item = copyDeltas(item)\n        list = append(list, item.Newest().Object)\n    }\n    return list\n}\n\n// \u83b7\u53d6\u5bf9\u8c61\u63a5\u53e3\uff0c\u6bd4\u5982\u8bf4\u7528 Service \u5bf9\u8c61\u83b7\u53d6 Pod \u5bf9\u8c61\uff0c\u56e0\u4e3a\u4ed6\u4eec\u7684\u5bf9\u8c61\u952e\u662f\u76f8\u540c\u7684\nfunc (f *DeltaFIFO) Get(obj interface{}) (item interface{}, exists bool, err error) {\n    key, err := f.KeyOf(obj)\n    if err != nil {\n        return nil, false, KeyError{obj, err}\n    }\n    return f.GetByKey(key)\n}\n\n// \u901a\u8fc7\u5bf9\u8c61\u952e\u83b7\u53d6\u5bf9\u8c61\nfunc (f *DeltaFIFO) GetByKey(key string) (item interface{}, exists bool, err error) {\n    f.lock.RLock()\n    defer f.lock.RUnlock()\n    d, exists := f.items[key]\n    if exists {\n        d = copyDeltas(d)\n    }\n    return d, exists, nil\n}\n\n// \u5224\u65ad\u662f\u5426\u5173\u95ed\nfunc (f *DeltaFIFO) IsClosed() bool {\n    f.closedLock.Lock()\n    defer f.closedLock.Unlock()\n    if f.closed {\n        return true\n    }\n    return false\n}\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u5b9e\u73b0\u5927\u90e8\u5206\u5f88\u7b80\u5355\uff0c\u597d\u51e0\u4e2a\u65b9\u6cd5\u7684\u6700\u7ec8\u5b9e\u73b0\u90fd\u662f\u901a\u8fc7\u8c03\u7528 <code>queueActionLocked</code> \u51fd\u6570\u5b9e\u73b0\u7684\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/tools/cache/delta_fifo.go\n// \u4ece\u51fd\u6570\u540d\u79f0\u6765\u770b\u628a\u201c\u52a8\u4f5c\u201d\u653e\u5165\u961f\u5217\u4e2d\uff0c\u8fd9\u4e2a\u52a8\u4f5c\u5c31\u662f DeltaType\uff0c\u800c\u4e14\u5df2\u7ecf\u52a0\u9501\u4e86\nfunc (f *DeltaFIFO) queueActionLocked(actionType DeltaType, obj interface{}) error {\n    // \u8ba1\u7b97\u5bf9\u8c61\u952e\u7684\u51fd\u6570\n    id, err := f.KeyOf(obj)\n    if err != nil {\n        return KeyError{obj, err}\n    }\n    // \u5982\u679c\u662f\u540c\u6b65\uff0c\u5e76\u4e14\u5bf9\u8c61\u672a\u6765\u4f1a\u88ab\u5220\u9664\uff0c\u90a3\u4e48\u5c31\u76f4\u63a5\u8fd4\u56de\uff0c\u6ca1\u5fc5\u8981\u8bb0\u5f55\u8fd9\u4e2a\u52a8\u4f5c\u4e86\n    // \u80af\u5b9a\u6709\u4eba\u4f1a\u95ee\u4e3a\u4ec0\u4e48Add/Delete/Update\u8fd9\u4e9b\u52a8\u4f5c\u53ef\u4ee5\uff0c\u56e0\u4e3a\u540c\u6b65\u5bf9\u4e8e\u5df2\u7ecf\u5220\u9664\u7684\u5bf9\u8c61\u662f\u6ca1\u6709\u610f\u4e49\u7684\n    // \u5df2\u7ecf\u5220\u9664\u7684\u5bf9\u8c61\u540e\u7eed\u6709\u53ef\u80fd\u6dfb\u52a0\u3001\u66f4\u65b0\uff0c\u56e0\u4e3a\u540c\u540d\u7684\u5bf9\u8c61\u53c8\u88ab\u6dfb\u52a0\u4e86\uff0c\u5220\u9664\u4e5f\u662f\u6709\u53ef\u80fd\n    if actionType == Sync &amp;&amp; f.willObjectBeDeletedLocked(id) {\n        return nil\n    }\n    // \u5bf9\u8c61\u64cd\u4f5c\uff0c\u6240\u4ee5\u8981\u8ffd\u52a0\u5230 Deltas \u6570\u7ec4\u4e2d\n    newDeltas := append(f.items[id], Delta{actionType, obj})\n    // \u5408\u5e76\u64cd\u4f5c\uff0c\u53bb\u6389\u5197\u4f59\u7684 delta\n    newDeltas = dedupDeltas(newDeltas)\n    // \u5224\u65ad\u5bf9\u8c61\u662f\u5426\u5df2\u7ecf\u5b58\u5728\n    _, exists := f.items[id]\n    if len(newDeltas) &gt; 0 {\n        // \u5982\u679c\u5bf9\u8c61\u6ca1\u6709\u5b58\u5728\u8fc7\uff0c\u90a3\u5c31\u653e\u5165\u961f\u5217\u4e2d\uff0c\u5982\u679c\u5b58\u5728\u8bf4\u660e\u5df2\u7ecf\u5728 queue \u4e2d\u4e86\uff0c\u4e5f\u5c31\u6ca1\u5fc5\u8981\u518d\u6dfb\u52a0\u4e86\n        if !exists {\n            f.queue = append(f.queue, id)\n        }\n        // \u66f4\u65b0 Deltas \u6570\u7ec4\uff0c\u901a\u77e5\u6240\u6709\u8c03\u7528 Pop() \u7684\u4eba\n        f.items[id] = newDeltas\n        f.cond.Broadcast()\n    } else if exists {\n        // \u76f4\u63a5\u628a\u5bf9\u8c61\u5220\u9664\uff0c\u8fd9\u6bb5\u4ee3\u7801\u6211\u4e0d\u77e5\u9053\u4ec0\u4e48\u6761\u4ef6\u4f1a\u8fdb\u6765\uff0c\u56e0\u4e3adedupDeltas()\u80af\u5b9a\u6709\u8fd4\u56de\u7ed3\u679c\u7684\n        // \u540e\u9762\u4f1a\u6709dedupDeltas()\u8be6\u7ec6\u8bf4\u660e\n        delete(f.items, id)\n    }\n    return nil\n}\n</code></pre> <p>\u9996\u5148\u6211\u4eec\u60f3\u60f3\u4e3a\u4ec0\u4e48\u6bcf\u4e2a\u5bf9\u8c61\u4e00\u4e2a Deltas \u800c\u4e0d\u662f Delta\uff1f\u5bf9\u4e00\u4e2a\u5bf9\u8c61\u7684\u591a\u4e2a\u64cd\u4f5c\uff0c\u4ec0\u4e48\u64cd\u4f5c\u53ef\u4ee5\u5408\u5e76\uff1f</p> <p>DeltaFIFO \u751f\u4ea7\u8005\u548c\u6d88\u8d39\u8005\u662f\u5f02\u6b65\u7684\uff0c\u5982\u679c\u540c\u4e00\u4e2a\u76ee\u6807\u7684\u9891\u7e41\u64cd\u4f5c\uff0c\u524d\u9762\u64cd\u4f5c\u8fd8\u7f13\u5b58\u5728\u961f\u5217\u4e2d\u7684\u65f6\u5019\uff0c\u90a3\u4e48\u961f\u5217\u5c31\u8981\u7f13\u51b2\u5bf9\u8c61\u7684\u6240\u6709\u64cd\u4f5c\uff0c\u90a3\u53ef\u4ee5\u5c06\u591a\u4e2a\u64cd\u4f5c\u5408\u5e76\u4e48\uff1f</p> <p>\u5bf9\u4e8e\u66f4\u65b0\u8fd9\u79cd\u7c7b\u578b\u7684\u64cd\u4f5c\u5728\u6ca1\u6709\u5168\u91cf\u57fa\u7840\u7684\u60c5\u51b5\u4e0b\u662f\u6ca1\u6cd5\u5408\u5e76\u7684\uff0c\u540c\u65f6\u6211\u4eec\u8fd8\u4e0d\u77e5\u9053\u5177\u4f53\u662f\u4ec0\u4e48\u7c7b\u578b\u7684\u5bf9\u8c61\uff0c\u6240\u4ee5\u80fd\u5408\u5e76\u7684\u4e5f\u5c31\u662f\u6709\u6dfb\u52a0/\u5220\u9664\uff0c\u4e24\u4e2a\u6dfb\u52a0/\u5220\u9664\u64cd\u4f5c\u5176\u5b9e\u53ef\u4ee5\u89c6\u4e3a\u4e00\u4e2a\u3002</p> <p>\u5408\u5e76\u7684\u64cd\u4f5c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/tools/cache/delta_fifo.go\n// \u5408\u5e76 Deltas\nfunc dedupDeltas(deltas Deltas) Deltas {\n    // \u5c0f\u4e8e2\u4e2adelta\uff0c\u5c31\u6ca1\u5fc5\u8981\u5408\u5e76\u4e86\n    n := len(deltas)\n    if n &lt; 2 {\n        return deltas\n    }\n    // \u53d6\u51fa\u6700\u540e\u4e24\u4e2a\n    a := &amp;deltas[n-1]\n    b := &amp;deltas[n-2]\n    // \u5224\u65ad\u5982\u679c\u662f\u91cd\u590d\u7684\uff0c\u90a3\u5c31\u5220\u9664\u8fd9\u4e24\u4e2a delta \u628a\u5408\u5e76\u540e\u7684\u8ffd\u52a0\u5230 Deltas \u6570\u7ec4\u5c3e\u90e8\n    if out := isDup(a, b); out != nil {\n        d := append(Deltas{}, deltas[:n-2]...)\n        return append(d, *out)\n    }\n    return deltas\n}\n\n// \u5224\u65ad\u4e24\u4e2a Delta \u662f\u5426\u91cd\u590d\nfunc isDup(a, b *Delta) *Delta {\n    // \u53ea\u6709\u4e00\u4e2a\u5224\u65ad\uff0c\u5224\u65ad\u662f\u5426\u4e3a\u5220\u9664\u7c7b\u64cd\u4f5c\uff08\u5f53\u524d\u53ea\u6709\u5220\u9664\u8fd9\u4e00\u79cd\u80fd\u591f\u5408\u5e76\uff09\n    if out := isDeletionDup(a, b); out != nil {\n        return out\n    }\n    return nil\n}\n\n// \u5224\u65ad\u662f\u5426\u4e3a\u5220\u9664\u7c7b\u7684\u91cd\u590d\nfunc isDeletionDup(a, b *Delta) *Delta {\n    // \u4e8c\u8005\u6709\u4e00\u4e2a\u4e0d\u662f\u5220\u9664\u64cd\u4f5c\u80af\u5b9a\u4e0d\u91cd\u590d\n    if b.Type != Deleted || a.Type != Deleted {\n        return nil\n    }\n    // \u7406\u8bba\u4e0a\u8fd4\u56de\u6700\u540e\u4e00\u4e2a\u6bd4\u8f83\u597d\uff0c\u4f46\u662f\u5bf9\u8c61\u5df2\u7ecf\u4e0d\u518d\u7cfb\u7edf\u76d1\u63a7\u8303\u56f4\uff0c\u524d\u4e00\u4e2a\u5220\u9664\u72b6\u6001\u662f\u597d\u7684\n    if _, ok := b.Object.(DeletedFinalStateUnknown); ok {\n        return a\n    }\n    return b\n}\n</code></pre> <p>\u56e0\u4e3a\u7cfb\u7edf\u5bf9\u4e8e\u5220\u9664\u7684\u5bf9\u8c61\u6709 </p> <pre><code>DeletedFinalStateUnknown\n</code></pre> <p>\u8fd9\u4e2a\u72b6\u6001\uff0c\u6240\u4ee5\u4f1a\u5b58\u5728\u4e24\u6b21\u5220\u9664\u7684\u60c5\u51b5\uff0c\u4f46\u662f\u4e24\u6b21\u6dfb\u52a0\u540c\u4e00\u4e2a\u5bf9\u8c61\u7531\u4e8e apiserver \u53ef\u4ee5\u4fdd\u8bc1\u5bf9\u8c61\u7684\u552f\u4e00\u6027\uff0c\u6240\u4ee5\u5904\u7406\u4e2d\u5c31\u6ca1\u6709\u8003\u8651\u5408\u5e76\u4e24\u6b21\u6dfb\u52a0\u64cd\u4f5c\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u770b\u770b Replace() \u51fd\u6570\u7684\u5b9e\u73b0\uff0c\u8fd9\u4e2a\u4e5f\u662f Store \u5b9a\u4e49\u7684\u63a5\u53e3\uff1a</p> <pre><code>// client-go/tools/cache/delta_fifo.go\nfunc (f *DeltaFIFO) Replace(list []interface{}, resourceVersion string) error {\n    f.lock.Lock()\n    defer f.lock.Unlock()\n    keys := make(sets.String, len(list))\n    // \u904d\u5386list\n    for _, item := range list {\n        // \u83b7\u53d6\u5bf9\u8c61\u952e\n        key, err := f.KeyOf(item)\n        if err != nil {\n            return KeyError{item, err}\n        }\n        // \u7528set\u4fdd\u5b58\u6240\u6709\u7684\u5bf9\u8c61\u952e\n        keys.Insert(key)\n        // \u540c\u6b65\u5bf9\u8c61\n        if err := f.queueActionLocked(Sync, item); err != nil {\n            return fmt.Errorf(\"couldn't enqueue object: %v\", err)\n        }\n    }\n    // \u5982\u679c\u6ca1\u6709Indexer\u5b58\u50a8\u7684\u8bdd\uff0c\u81ea\u5df1\u5b58\u50a8\u7684\u5c31\u662f\u6240\u6709\u7684\u8001\u5bf9\u8c61\uff0c\u76ee\u7684\u662f\u8981\u770b\u54ea\u4e9b\u8001\u5bf9\u8c61\u4e0d\u5728\u5168\u91cf\u96c6\u5408\u4e2d\uff0c\u90a3\u4e48\u5c31\u662f\u5220\u9664\u7684\u5bf9\u8c61\u4e86\n    if f.knownObjects == nil {\n        // \u904d\u5386\u6240\u6709\u7684\u5143\u7d20\n        queuedDeletions := 0\n        for k, oldItem := range f.items {\n            // \u8fd9\u4e2a\u76ee\u6807\u5728\u8f93\u5165\u7684\u5bf9\u8c61\u4e2d\u5b58\u5728\u5c31\u53ef\u4ee5\u5ffd\u7565\n            if keys.Has(k) {\n                continue\n            }\n            // \u8f93\u5165\u5bf9\u8c61\u4e2d\u6ca1\u6709\uff0c\u8bf4\u660e\u5bf9\u8c61\u5df2\u7ecf\u88ab\u5220\u9664\u4e86\n            var deletedObj interface{}\n            if n := oldItem.Newest(); n != nil {\n                deletedObj = n.Object\n            }\n            queuedDeletions++\n            // \u961f\u5217\u4e2d\u5b58\u50a8\u5bf9\u8c61\u7684Deltas\u6570\u7ec4\u4e2d\u53ef\u80fd\u5df2\u7ecf\u5b58\u5728Delete\u4e86\uff0c\u907f\u514d\u91cd\u590d\uff0c\u91c7\u7528DeletedFinalStateUnknown\u7c7b\u578b\n            if err := f.queueActionLocked(Deleted, DeletedFinalStateUnknown{k, deletedObj}); err != nil {\n                return err\n            }\n        }\n        // \u5982\u679c populated \u8fd8\u6ca1\u6709\u8bbe\u7f6e\uff0c\u8bf4\u660e\u662f\u7b2c\u4e00\u6b21\u5e76\u4e14\u8fd8\u6ca1\u6709\u4efb\u4f55\u4fee\u6539\u64cd\u4f5c\u6267\u884c\u8fc7\n        if !f.populated {\n            f.populated = true\n            // \u8bb0\u5f55\u7b2c\u4e00\u6b21\u4f20\u9012\u8fc7\u6765\u7684\u5bf9\u8c61\u6570\u91cf\n            f.initialPopulationCount = len(list) + queuedDeletions\n        }\n\n        return nil\n    }\n    // \u4e0b\u9762\u5904\u7406\u7684\u5c31\u662f\u68c0\u6d4b\u67d0\u4e9b\u76ee\u6807\u5220\u9664\u4f46\u662f Delta \u6ca1\u6709\u5728\u961f\u5217\u4e2d\n    // \u4ece\u5b58\u50a8\u4e2d\u83b7\u53d6\u6240\u6709\u5bf9\u8c61\u952e\n    knownKeys := f.knownObjects.ListKeys()\n    queuedDeletions := 0\n    for _, k := range knownKeys {\n        // \u5bf9\u8c61\u8fd8\u5b58\u5728\u90a3\u5c31\u5ffd\u7565\n        if keys.Has(k) {\n            continue\n        }\n        // \u83b7\u53d6\u5bf9\u8c61\n        deletedObj, exists, err := f.knownObjects.GetByKey(k)\n        if err != nil {\n            deletedObj = nil\n            klog.Errorf(\"Unexpected error %v during lookup of key %v, placing DeleteFinalStateUnknown marker without object\", err, k)\n        } else if !exists {\n            deletedObj = nil\n            klog.Infof(\"Key %v does not exist in known objects store, placing DeleteFinalStateUnknown marker without object\", k)\n        }\n        // \u7d2f\u79ef\u5220\u9664\u7684\u5bf9\u8c61\u6570\u91cf\n        queuedDeletions++\n        // \u628a\u5bf9\u8c61\u5220\u9664\u7684Delta\u653e\u5165\u961f\u5217\n        if err := f.queueActionLocked(Deleted, DeletedFinalStateUnknown{k, deletedObj}); err != nil {\n            return err\n        }\n    }\n    // \u548c\u4e0a\u9762\u7684\u4ee3\u7801\u5dee\u4e0d\u591a\uff0c\u53ea\u662f\u8ba1\u7b97initialPopulationCount\u503c\u7684\u65f6\u5019\u589e\u52a0\u4e86\u5220\u9664\u5bf9\u8c61\u7684\u6570\u91cf\n    if !f.populated {\n        f.populated = true\n        f.initialPopulationCount = len(list) + queuedDeletions\n    }\n    return nil\n}\n</code></pre> <p>\u4ece Replace() \u7684\u5b9e\u73b0\u6765\u770b\uff0c\u4e3b\u8981\u7528\u4e8e\u5b9e\u73b0\u5bf9\u8c61\u7684\u5168\u91cf\u66f4\u65b0\u3002\u8fd9\u4e2a\u53ef\u4ee5\u7406\u89e3\u4e3a DeltaFIFO \u5728\u5fc5\u8981\u7684\u65f6\u5019\u505a\u4e00\u6b21\u5168\u91cf\u66f4\u65b0\uff0c\u8fd9\u4e2a\u65f6\u523b\u53ef\u4ee5\u662f\u5b9a\u671f\u7684\uff0c\u4e5f\u53ef\u4ee5\u662f\u4e8b\u4ef6\u89e6\u53d1\u7684\u3002\u7531\u4e8e DeltaFIFO \u5bf9\u5916\u8f93\u51fa\u7684\u5c31\u662f\u6240\u6709\u76ee\u6807\u7684\u589e\u91cf\u53d8\u5316\uff0c\u6240\u4ee5\u6bcf\u6b21\u5168\u91cf\u66f4\u65b0\u90fd\u8981\u5224\u65ad\u5bf9\u8c61\u662f\u5426\u5df2\u7ecf\u5220\u9664\uff0c\u56e0\u4e3a\u5728\u5168\u91cf\u66f4\u65b0\u524d\u53ef\u80fd\u6ca1\u6709\u6536\u5230\u76ee\u6807\u5220\u9664\u7684\u8bf7\u6c42\u3002\u8fd9\u4e00\u70b9\u4e0e cache \u4e0d\u540c\uff0ccache \u7684 Replace() \u76f8\u5f53\u4e8e\u91cd\u5efa\uff0c\u56e0\u4e3acache \u5c31\u662f\u5bf9\u8c61\u5168\u91cf\u7684\u4e00\u79cd\u5185\u5b58\u6620\u5c04\uff0c\u6240\u4ee5 Replace() \u5c31\u7b49\u4e8e\u91cd\u5efa\u3002</p> <p>\u90a3\u6211\u6765\u95ee\u9898\u4e00\u4e2a\u975e\u5e38\u6709\u6c34\u5e73\u7684\u95ee\u9898\uff0c\u4e3a\u4ec0\u4e48 knownObjects \u4e3a nil \u65f6\u9700\u8981\u5bf9\u6bd4\u961f\u5217\u548c\u5bf9\u8c61\u5168\u91cf\u6765\u5224\u65ad\u5bf9\u8c61\u662f\u5426\u5220\u9664\uff0c\u800cknownObjects \u4e0d\u4e3a\u7a7a\u7684\u65f6\u5019\u5c31\u4e0d\u9700\u8981\u4e86\uff1f\u5982\u679c\u8bfb\u8005\u60f3\u5224\u65ad\u81ea\u5df1\u662f\u5426\u5df2\u7ecf\u5168\u90e8\u7406\u89e3\u53ef\u4ee5\u4e0d\u770b\u4e0b\u9762\u81ea\u5df1\u60f3\u60f3\u3002</p> <p>\u6211\u4eec\u524d\u9762\u8bf4\u8fc7\uff0cknownObjects \u5c31\u662f Indexer(\u5177\u4f53\u5b9e\u73b0\u662f cache)\uff0c\u800c\u5f00\u7bc7\u7684\u90a3\u526f\u56fe\u5df2\u7ecf\u975e\u5e38\u660e\u786e\u7684\u63cf\u8ff0\u4e86\u4e8c\u8005\u4ee5\u53ca\u4f7f\u7528\u4e4b\u95f4\u7684\u5173\u7cfb\u3002\u4e5f\u5c31\u662f\u8bf4 knownObjects \u6709\u7684\u5bf9\u8c61\u5c31\u662f\u4f7f\u7528\u8005\u77e5\u9053\u7684\u6240\u6709\u5bf9\u8c61\uff0c\u6b64\u65f6\u5373\u4fbf\u961f\u5217(DeltaFIFO)\u4e2d\u6709\u76f8\u5e94\u7684\u5bf9\u8c61\uff0c\u5728\u66f4\u65b0\u7684\u5168\u91cf\u5bf9\u8c61\u4e2d\u53c8\u88ab\u5220\u9664\u4e86\uff0c\u90a3\u5c31\u6ca1\u5fc5\u8981\u901a\u77e5\u4f7f\u7528\u8005\u5bf9\u8c61\u5220\u9664\u4e86\uff0c\u8fd9\u79cd\u60c5\u51b5\u53ef\u4ee5\u5047\u60f3\u4e3a\u7cfb\u7edf\u77ed\u65f6\u95f4\u6dfb\u52a0\u5e76\u5220\u9664\u4e86\u5bf9\u8c61\uff0c\u5bf9\u4f7f\u7528\u8005\u6765\u8bf4\u7b49\u540c\u4e8e\u6ca1\u6709\u8fd9\u4e2a\u5bf9\u8c61\u3002</p> <p>=======</p> <p>ListWatch \u7684 list \u6b65\u9aa4\u4f1a\u8c03\u7528 Replace\uff08client-go/tools/cache/delta_fifo.go\uff09\u51fd\u6570\u6765\u5bf9 DeltaFIFO \u8fdb\u884c\u5168\u91cf\u66f4\u65b0\uff1a</p> <ul> <li>Sync \u6240\u6709 DeltaFIFO \u4e2d\u7684\u5bf9\u8c61\uff0c\u5c06\u8f93\u5165\u5bf9\u8c61\u5168\u90e8\u52a0\u5165\u5230 DeltaFIFO</li> <li>\u5982\u679c knowObjects \u4e3a\u7a7a\uff0c\u5219\u5220\u9664 DeltaFIFO \u4e2d\u4e0d\u5b58\u5728\u4e8e\u8f93\u5165\u5bf9\u8c61\u7684\u5bf9\u8c61\uff0c\u4f7f DeltaFIFO \u4e2d\u7684\u6709\u6548\u5bf9\u8c61\uff08\u975e DeletedFinalStateUnknown\uff09\u7b49\u540c\u4e8e\u8f93\u5165\u5bf9\u8c61</li> <li>\u5982\u679c knownObjects \u975e\u7a7a\uff0c\u83b7\u53d6 knowObjects \u4e2d\u4e0d\u5b58\u5728\u4e8e\u8f93\u5165\u5bf9\u8c61\u7684\u5bf9\u8c61\uff0c\u5e76\u5728 DeltaFIFO \u4e2d\u5220\u9664\u8fd9\u4e9b\u5bf9\u8c61</li> </ul> <p>\u7b2c2\u6b65\u597d\u7406\u89e3\uff0cknownObjects \u4e3a\u7a7a\uff0c\u53ea\u9700\u8981\u66f4\u65b0 DeltaFIFO \u5373\u53ef\u3002\u7b2c3\u6b65\u4e2d\uff0c\u5f53 knownObjects \u975e\u7a7a\u65f6\uff0c\u9700\u8981\u4ee5 knowObjects \u4e3a\u57fa\u51c6\u8fdb\u884c\u5bf9\u8c61\u7684\u5220\u9664\uff0c\u5426\u5219\u4f1a\u9020\u6210 indexer \u4e2d\u7684\u6570\u636e\u4e0e apiserver \u7684\u6570\u636e\u4e0d\u4e00\u81f4\uff0c\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u6bd4\u5982 knownObjects \u4e2d\u7684\u5bf9\u8c61\u4e3a {obj1, obj2, obj3}\uff0c\u800c DeltaFIFO\u4e2d\u5f85\u5904\u7406\u7684\u5bf9\u8c61\u4e3a {obj2, obj3,obj4}\uff0c\u5982\u679c\u4ec5\u6309\u71672\u6b65\u9aa4\u8fdb\u884c\u5904\u7406\uff0c\u4f1a\u5bfc\u81f4 knownObjects \u4e2d\u6b8b\u7559 obj1\uff0c\u56e0\u6b64\u9700\u8981\u5728 DeltaFIFO \u4e2d\u6dfb\u52a0\u5220\u9664 obj1 \u7684\u53d8\u66f4\u6d88\u606f\u3002\u4ece\u4e0b\u9762 ShareInformer \u7684\u56fe\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0cknownObjects\uff08\u5373Indexer\uff09\u7684\u6570\u636e\u53ea\u80fd\u901a\u8fc7 DeltaFIFO \u53d8\u66f4\u3002</p> <p></p>"},{"location":"kubernetes_code/client_go/indexer/","title":"indexer","text":""},{"location":"kubernetes_code/client_go/indexer/#indexer","title":"Indexer","text":"<p><code>Indexer</code> \u662f <code>Informer</code> \u4e2d\u4e00\u90e8\u5206\uff0c<code>Informer</code> \u5728 client-go \u4e2d\u662f\u975e\u5e38\u91cd\u8981\u7684\u90e8\u5206\uff0c\u4f46\u662f\u7531\u4e8e Informer \u5185\u5bb9\u6bd4\u8f83\u5e9e\u5927\uff0c\u6211\u4eec\u8fd9\u91cc\u5148\u4ecb\u7ecd Indexer\uff0c\u4ece\u5b57\u9762\u4e0a\u770b\u662f\u7d22\u5f15\u5668\u7684\u610f\u601d\uff0c\u4ed6\u6240\u5728\u7684\u4f4d\u7f6e\u5c31\u662f Informer \u7684 <code>LocalStore</code>\uff0c\u5176\u5b9e Indexer \u5c31\u662f\u5b58\u50a8\u3002</p> <p></p> <p>\u548c\u6570\u636e\u5e93\u7c7b\u4f3c\u7d22\u5f15\u548c\u5b58\u50a8\u662f\u606f\u606f\u76f8\u5173\u7684\uff0c\u7d22\u5f15\u6784\u5efa\u5728\u5b58\u50a8\u4e4b\u4e0a\uff0c\u53ef\u4ee5\u8ba9\u6211\u4eec\u6309\u7167\u67d0\u4e9b\u6761\u4ef6\u67e5\u8be2\u6570\u636e\u7684\u65f6\u5019\u4f1a\u5f88\u5feb\u3002</p> <p>\u5728\u4e86\u89e3 <code>Indexer</code> \u4e4b\u524d\u6211\u4eec\u9700\u8981\u5148\u770b\u51e0\u4e2a\u91cd\u8981\u7684\u7c7b\u578b\u6765\u4e86\u89e3 Indexer \u662f\u5982\u4f55\u5b9e\u73b0\u7d22\u5f15\u7684\uff1a</p> <pre><code>// client-go/tools/cache/index.go\n// IndexFun \u77e5\u9053\u5982\u4f55\u4e3a\u5bf9\u8c61\u63d0\u4f9b\u7d22\u5f15\u503c\uff0c\u8bf4\u767d\u4e86\u5c31\u662f\u8ba1\u7b97\u5bf9\u8c61\u7684\u7d22\u5f15\uff0c\u4f20\u5165\u5bf9\u8c61\uff0c\u8f93\u51fa\u5b57\u7b26\u4e32\u7d22\u5f15\u6570\u7ec4\ntype IndexFunc func(obj interface{}) ([]string, error)\n\ntype Index map[string]sets.String   // \u6bcf\u79cd\u8ba1\u7b97\u7d22\u5f15\u7684\u65b9\u5f0f\u4f1a\u8f93\u51fa\u591a\u4e2a\u7d22\u5f15(\u6570\u7ec4)\uff0c\u800c\u591a\u4e2a\u76ee\u6807\u53ef\u80fd\u4f1a\u7b97\u51fa\u76f8\u540c\u7d22\u5f15\n// \u7d22\u5f15\u952e -&gt; \u5bf9\u8c61\u952eset\u96c6\u5408\n\n// Indexers \u6620\u5c04\u4e00\u4e2a\u540d\u5b57\u5230\u4e00\u4e2a IndexFunc\ntype Indexers map[string]IndexFunc  // \u8ba1\u7b97\u7d22\u5f15\u7684\u51fd\u6570\u6709\u5f88\u591a\uff0c\u7528\u540d\u5b57\u6765\u8fdb\u884c\u5206\u7c7b\uff0c\u5c31\u662f\u7d22\u5f15\u5206\u7c7b\n// \u5206\u7c7b1(\u7279\u5f811) -&gt; \u83b7\u53d6\u5bf9\u8c61\u7684\u7d22\u5f15\u952e(\u6570\u7ec4)\n\n// Indices \u6620\u5c04\u4e00\u4e2a\u540d\u5b57\u5230\u4e00\u4e2aIndex\ntype Indices map[string]Index    // \u7531\u4e8e\u6709\u591a\u79cd\u8ba1\u7b97\u7d22\u5f15\u7684\u65b9\u5f0f\uff0c\u90a3\u5c31\u53c8\u8981\u6309\u7167\u8ba1\u7b97\u7d22\u5f15\u7684\u65b9\u5f0f\u7ec4\u7ec7\u7d22\u5f15\n// \u5206\u7c7b1(\u7279\u5f811) -&gt; \u6240\u6709\u7d22\u5f15\n</code></pre> <p>Indexers\uff1a\u5206\u7c7b1 -&gt; IndexFunc([indexKey1\uff0cindexKey2....]) Indices\uff1a \u5206\u7c7b1 -&gt; Index indexKey1 -&gt; [objKey1, objKey2...] indexKey2 -&gt; [objKey3, objKey4...]</p> <p>\u4e0a\u9762\u51e0\u79cd\u7c7b\u578b\u7406\u89e3\u8d77\u6765\u6709\u70b9\u8d39\u52b2\uff0c\u547d\u540d\u770b\u4e0a\u53bb\u4e5f\u5dee\u4e0d\u591a\u3002\u7d22\u5f15\u7684\u76ee\u7684\u5c31\u662f\u4e3a\u4e86\u5feb\u901f\u67e5\u627e\uff0c\u8fd9\u4e2a\u662f\u6bcb\u5eb8\u7f6e\u7591\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u9700\u8981\u67e5\u627e\u67d0\u4e2a\u8282\u70b9\u4e0a\u7684\u6240\u6709 Pod\uff0c\u90a3\u5c31\u8981 Pod \u6309\u7167\u8282\u70b9\u540d\u79f0\u6392\u5e8f\uff0c\u5bf9\u5e94\u4e0a\u9762\u7684 Index \u7c7b\u578b\u5c31\u662f map[nodename]sets.podname\uff0c\u4f46\u662f\u6211\u4eec\u53ef\u80fd\u6709\u5f88\u591a\u79cd\u67e5\u627e\u65b9\u5f0f\uff0c\u8fd9\u5c31\u662f Indexers \u8fd9\u4e2a\u7c7b\u578b\u7684\u4f5c\u7528\u4e86\u3002</p> <p></p> <p><code>Indexers</code> \u548c <code>Indices</code> \u90fd\u662f\u6309\u7167 IndexFunc \u5206\u7ec4\uff0c\u6bcf\u4e2a IndexFunc \u8f93\u51fa\u591a\u4e2a IndexKey\uff0c\u4ea7\u751f\u76f8\u540c IndexKey \u7684\u591a\u4e2a\u5bf9\u8c61\u5b58\u50a8\u5728\u4e00\u4e2a\u96c6\u5408\u4e2d\u3002\u4e3a\u4e86\u660e\u786e\u610f\u4e49\uff0c\u6211\u4eec\u8fd9\u91cc\u5148\u7edf\u4e00\u51e0\u4e2a\u6982\u5ff5\uff1a</p> <ul> <li>IndexFunc1...\u8fd9\u4e9b\u90fd\u662f\u7d22\u5f15\u51fd\u6570\u7684\u540d\u79f0\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\u7d22\u5f15\u7c7b\uff0c\u5927\u6982\u610f\u601d\u5c31\u662f\u628a\u7d22\u5f15\u5206\u7c7b\u4e86</li> <li>IndexKey1...\u8fd9\u4e9b\u662f\u540c\u4e00\u4e2a\u5bf9\u8c61\u5728\u540c\u4e00\u4e2a\u7d22\u5f15\u7c7b\u4e2d\u7684\u591a\u4e2a\u7d22\u5f15\u952e\u503c\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\u7d22\u5f15\u952e</li> <li>ObjKey1...\u8fd9\u4e9b\u662f\u5bf9\u8c61\u952e\uff0c\u6bcf\u4e2a\u5bf9\u8c61\u90fd\u6709\u552f\u4e00\u7684\u540d\u79f0</li> </ul> <p>\u73b0\u5728\u6211\u4eec\u518d\u6765\u67e5\u770b <code>Indexer</code> \u4e0e\u7d22\u5f15\u76f8\u5173\u7684\u63a5\u53e3\u5b9a\u4e49\uff1a</p> <pre><code>// client-go/tools/cache/index.go\n// Indexer \u662f\u4e00\u4e2a\u5b58\u50a8\u63a5\u53e3\uff0c\u53ef\u4ee5\u8ba9\u6211\u4eec\u4f7f\u7528\u591a\u4e2a\u7d22\u5f15\u51fd\u6570\u6765\u83b7\u53d6\u5bf9\u8c61\u5217\u8868\ntype Indexer interface {\n    Store  // \u7ee7\u627f\u4e86 Storge \u8fd9\u4e2a\u63a5\u53e3\uff08client-go/tools/cache/store.go\uff09\n\n    // indexName \u7d22\u5f15\u7c7b\uff0cobj \u662f\u5bf9\u8c61\uff0c\u8ba1\u7b97 obj \u5728 indexName \u7d22\u5f15\u7c7b\u4e2d\u7684\u7d22\u5f15\u952e\n    // \u901a\u8fc7\u7d22\u5f15\u952e\u628a\u6240\u6709\u5bf9\u8c61\u53d6\u51fa\u6765\uff0c\u57fa\u672c\u5c31\u662f\u83b7\u53d6\u7b26\u5408 obj \u7279\u5f81\u7684\u6240\u6709\u5bf9\u8c61\uff0c\u6240\u8c13\u7684\u7279\u5f81\u5c31\u662f\u5bf9\u8c61\u5728\u7d22\u5f15\u7c7b\u4e2d\u7684\u7d22\u5f15\u952e\n    Index(indexName string, obj interface{}) ([]interface{}, error)  \n\n    // indexKey \u662f indexName \u7d22\u5f15\u7c7b\u4e2d\u7684\u4e00\u4e2a\u7d22\u5f15\u952e\uff0c\u51fd\u6570\u8fd4\u56de indexKey \u6307\u5b9a\u7684\u6240\u6709\u5bf9\u8c61\u952e\n    // \u8fd9\u4e2a\u5bf9\u8c61\u952e\u662f Indexer \u5185\u552f\u4e00\u7684\uff0c\u5728\u6dfb\u52a0\u7684\u65f6\u5019\u4f1a\u6280\u672f\n    IndexKeys(indexName, indexKey string) ([]string, error)  \n\n    // \u83b7\u53d6 indexName \u7d22\u5f15\u7c7b\u4e2d\u7684\u6240\u6709\u7d22\u5f15\u952e\n    ListIndexFuncValues(indexName string) []string  \n\n    // \u4e0e Index \u51fd\u6570\u7c7b\u4f3c\uff0c\u53ea\u662f\u8fd4\u56de\u503c\u4e0d\u662f\u5bf9\u8c61\u952e\u4e86\uff0c\u800c\u662f\u6240\u6709\u5bf9\u8c61\n    ByIndex(indexName, indexKey string) ([]interface{}, error)\n\n    // \u8fd4\u56de Indexers\n    GetIndexers() Indexers\n\n    // \u6dfb\u52a0 Indexers \u5230\u5b58\u50a8(store)\u4e2d\uff0c\u5373\u6dfb\u52a0\u7d22\u5f15\u5206\u7c7b\n    AddIndexers(newIndexers Indexers) error\n}\n</code></pre> <p>\u4e0a\u9762\u662f <code>Indexer</code> \u8fd9\u4e2a\u63a5\u53e3\u7684\u5b9a\u4e49\uff0c\u5176\u4e2d\u7ee7\u627f\u4e86 <code>Store</code> \u8fd9\u4e2a\u63a5\u53e3\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b\u8be5\u63a5\u53e3\u7684\u5b9a\u4e49\uff1a</p> <pre><code>// client-go/tools/cache/store.go\ntype Store interface {\n    // \u6dfb\u52a0\u5bf9\u8c61\n    Add(obj interface{}) error\n    // \u66f4\u65b0\u5bf9\u8c61\n    Update(obj interface{}) error\n    // \u5220\u9664\u5bf9\u8c61\n    Delete(obj interface{}) error\n    // \u5217\u4e3e\u5bf9\u8c61\n    List() []interface{}\n    // \u5217\u4e3e\u5bf9\u8c61\u952e\n    ListKeys() []string\n    // \u83b7\u53d6 obj \u76f8\u540c\u5bf9\u8c61\u952e\u7684\u5bf9\u8c61\uff0c\u5bf9\u8c61\u952e\u662f\u901a\u8fc7\u5bf9\u8c61\u8ba1\u7b97\u51fa\u6765\u7684\u5b57\u7b26\u4e32\n    Get(obj interface{}) (item interface{}, exists bool, err error)\n    // \u901a\u8fc7\u5bf9\u8c61\u952e\u76f4\u63a5\u83b7\u53d6\u5bf9\u8c61\n    GetByKey(key string) (item interface{}, exists bool, err error)\n\n    // \u7528 []interface{} \u66ff\u6362 Store \u5b58\u50a8\u7684\u6240\u6709\u5bf9\u8c61\uff0c\u76f8\u5f53\u4e8e\u4f1a\u5220\u9664\u5b58\u50a8\u4e2d\u539f\u6709\u7684\u6240\u6709\u5185\u5bb9\uff0c\u7136\u540e\u518d\u6dfb\u52a0\u65b0\u7684\u5bf9\u8c61 \n    Replace([]interface{}, string) error\n    // \u91cd\u65b0\u540c\u6b65\n    Resync() error\n}\n</code></pre> <p>\u4ece\u4e0a\u9762\u63a5\u53e3\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u6bcf\u4e2a\u5bf9\u8c61\u90fd\u8981\u6709\u552f\u4e00\u7684\u952e\uff0c\u952e\u7684\u8ba1\u7b97\u65b9\u5f0f\u5c31\u8981\u4f9d\u8d56\u5177\u4f53\u7684\u5b9e\u73b0\u4e86\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u770b\u770b <code>Indexer</code> \u7684\u5177\u4f53\u5b9e\u73b0\u3002</p>"},{"location":"kubernetes_code/client_go/indexer/#cache","title":"cache","text":"<p><code>cache</code> \u662f <code>Indexer</code> \u4e2d\u975e\u5e38\u7ecf\u5178\u7684\u4e00\u79cd\u5b9e\u73b0\uff0c\u6240\u6709\u7684\u5bf9\u8c61\u7f13\u5b58\u5728\u5185\u5b58\u4e2d\uff0c\u4ece\u540d\u79f0\u6765\u770b\u53ef\u4ee5\u77e5\u9053\u662f\u5c5e\u4e8e\u5305\u5185\u79c1\u6709\u7684\u5185\u578b\uff0c\u5916\u90e8\u65e0\u6cd5\u76f4\u63a5\u4f7f\u7528\uff0c\u9700\u8981\u901a\u8fc7\u4e13\u7528\u7684\u51fd\u6570\u6765\u521b\u5efa\uff0c<code>cache</code> \u7684\u5b9a\u4e49\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/tools/cache/store.go\n// cache \u4ec5\u7528\u4e8e\u4e0b\u9762\u4e24\u4e2a\u65b9\u9762\uff1a\n//   \u901a\u8fc7 keyFunc \u8ba1\u7b97\u5bf9\u8c61\u952e\u503c\n//   \u8c03\u7528 ThreadSafeStorage \u63a5\u53e3\u7684\u65b9\u6cd5\ntype cache struct {\n    // \u4e00\u4e2a\u7ebf\u7a0b\u5b89\u5168\u7684 Store\n    cacheStorage ThreadSafeStore  \n    // keyFunc \u662f\u4e00\u4e2a\u7528\u6765\u8ba1\u7b97\u5bf9\u8c61\u952e\u7684\u51fd\u6570\n    keyFunc KeyFunc\n}\n\n// KeyFunc \u7684\u5b9a\u4e49\u5982\u4e0b\u6240\u793a\uff1a\u7528\u6765\u8ba1\u7b97\u5bf9\u8c61\u952e\u7684\u51fd\u6570\ntype KeyFunc func(obj interface{}) (string, error)\n</code></pre> <p>\u4ece <code>cache</code> \u7ed3\u6784\u4f53\u53ef\u4ee5\u770b\u51fa\u521b\u5efa\u8be5\u5bf9\u8c61\u7684\u65f6\u5019\u6211\u4eec\u9700\u8981\u6307\u5b9a\u8fd9\u4e2a <code>KeyFunc</code> \u8ba1\u7b97\u5bf9\u8c61\u952e\u7684\u51fd\u6570\u8fd9\u4e2a\u5b57\u6bb5\u3002\u53e6\u5916\u4e00\u4e2a\u5c31\u662f\u4e00\u4e2a\u7ebf\u7a0b\u5b89\u5168\u7684 <code>ThreadSafeStore</code> \u5bf9\u8c61\u3002</p>"},{"location":"kubernetes_code/client_go/indexer/#threadsafestore","title":"ThreadSafeStore","text":"<p>\u4ece <code>cache</code> \u7684\u5b9a\u4e49\u53ef\u4ee5\u770b\u51fa\u6240\u6709\u7684\u529f\u80fd\u57fa\u672c\u4e0a\u90fd\u662f\u901a\u8fc7 <code>ThreadSafeStore</code> \u8fd9\u4e2a\u7c7b\u578b\u6765\u5b9e\u73b0\u7684\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u5148\u6765\u770b\u4e0b\u8be5\u63a5\u53e3\u7684\u5b9a\u4e49\uff1a</p> <pre><code>// client-go/tools/cache/thread_safe_store.go\ntype ThreadSafeStore interface {\n    Add(key string, obj interface{})\n    Update(key string, obj interface{})\n    Delete(key string)\n    Get(key string) (item interface{}, exists bool)\n    List() []interface{}\n    ListKeys() []string\n    Replace(map[string]interface{}, string)\n    Index(indexName string, obj interface{}) ([]interface{}, error)\n    IndexKeys(indexName, indexKey string) ([]string, error)\n    ListIndexFuncValues(name string) []string\n    ByIndex(indexName, indexKey string) ([]interface{}, error)\n    GetIndexers() Indexers\n\n    AddIndexers(newIndexers Indexers) error\n    Resync() error\n}\n</code></pre> <p>\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u4f1a\u53d1\u73b0\u8be5\u63a5\u53e3\u548c\u4e0a\u9762\u7684 <code>Indexer</code> \u57fa\u672c\u4e0a\u662f\u4e00\u81f4\u7684\uff0c\u4e0d\u540c\u7684\u662f <code>Indexer</code> \u4e2d\u7684 CRUD \u7684\u76f8\u5173\u53c2\u6570\u662f\u5bf9\u8c61\uff0c\u800c\u8fd9\u91cc\u662f\u63d0\u4f9b\u5bf9\u8c61\u952e\u3002<code>ThreadSafeStore</code> \u63a5\u53e3\u7684\u5bf9\u5e94\u5b9e\u73b0\u7ed3\u6784\u4f53\u5b9a\u4e49\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/tools/cache/thread_safe_store.go\n// threadSafeMap \u5b9e\u73b0\u4e86 ThreadSafeStore \u63a5\u53e3\ntype threadSafeMap struct {\n    lock  sync.RWMutex  // \u8bfb\u5199\u9501\uff0c\u8bfb\u591a\u5199\u5c11\u7528\u8bfb\u5199\u9501\u6027\u80fd\u66f4\u597d\n    items map[string]interface{}  // \u5b58\u50a8\u5bf9\u8c61\u7684\u5b57\u5178\uff1a\u5bf9\u8c61\u952e\uff1a\u5bf9\u8c61\n\n    indexers Indexers  // \u7d22\u5f15\u5206\u7c7b\n    indices Indices // \u5feb\u901f\u7d22\u5f15\u8868\uff0c\u901a\u8fc7\u6240\u4ee5\u53ef\u4ee5\u5feb\u901f\u627e\u5230\u5bf9\u8c61\u952e\uff0c\u7136\u540e\u518d\u4eceitems\u4e2d\u53d6\u51fa\u5bf9\u8c61\n}\n</code></pre> <p>\u518d\u6b21\u5f3a\u8c03\u4e0b\u7d22\u5f15\u952e\u548c\u5bf9\u8c61\u952e\u8fd9\u4e24\u4e2a\u91cd\u8981\u7684\u6982\u5ff5\uff0c\u7d22\u5f15\u952e\u662f\u7528\u4e8e\u5bf9\u8c61\u5feb\u901f\u67e5\u627e\u7684\uff0c\u7ecf\u8fc7\u7d22\u5f15\u952e\u5728 map \u4e2d\u6392\u5e8f\u67e5\u627e\u4f1a\u66f4\u5feb\uff1b\u5bf9\u8c61\u952e\u662f\u5bf9\u8c61\u5728\u5b58\u50a8\u4e2d\u7684\u552f\u4e00\u547d\u540d\uff0c\u5bf9\u8c61\u662f\u901a\u8fc7\u540d\u5b57+\u5bf9\u8c61\u7684\u65b9\u5f0f\u5b58\u50a8\u7684\u3002\u63a5\u4e0b\u6765\u770b\u4e0b\u5177\u4f53\u7684\u5b9e\u73b0\u51fd\u6570\uff1a</p> <pre><code>// client-go/tools/cache/thread_safe_store.go\n// \u6dfb\u52a0\u5bf9\u8c61\u51fd\u6570\nfunc (c *threadSafeMap) Add(key string, obj interface{}) {\n    // \u52a0\u9501\uff0c\u56e0\u4e3a\u662f\u5199\u64cd\u4f5c\uff0c\u6240\u4ee5\u5168\u90e8\u4e92\u65a5\n    c.lock.Lock()\n    defer c.lock.Unlock()\n    // \u53d6\u51fa\u8001\u5bf9\u8c61\n    oldObject := c.items[key]\n    // \u5199\u5165\u65b0\u5bf9\u8c61\n    c.items[key] = obj\n    // \u6dfb\u52a0\u4e86\u65b0\u7684\u5bf9\u8c61\u6240\u4ee5\u9700\u8981\u66f4\u65b0\u7d22\u5f15\n    c.updateIndices(oldObject, obj, key)\n}\n\n// \u66f4\u65b0\u5bf9\u8c61\u51fd\u6570\uff0c\u548cAdd\u51fd\u6570\u4e00\u6a21\u4e00\u6837\nfunc (c *threadSafeMap) Update(key string, obj interface{}) {\n    c.lock.Lock()\n    defer c.lock.Unlock()\n    oldObject := c.items[key]\n    c.items[key] = obj\n    c.updateIndices(oldObject, obj, key)\n}\n\n// \u5220\u9664\u5bf9\u8c61\nfunc (c *threadSafeMap) Delete(key string) {\n    c.lock.Lock()\n    defer c.lock.Unlock()\n    // \u5224\u65ad\u5bf9\u8c61\u662f\u5426\u5b58\u5728\n    if obj, exists := c.items[key]; exists {\n        // \u5220\u9664\u5bf9\u8c61\u7684\u7d22\u5f15\n        c.deleteFromIndices(obj, key)\n        // \u5220\u9664\u5bf9\u8c61\u672c\u8eab\n        delete(c.items, key)\n    }\n}\n\n// \u83b7\u53d6\u5bf9\u8c61\nfunc (c *threadSafeMap) Get(key string) (item interface{}, exists bool) {\n    c.lock.RLock()\n    defer c.lock.RUnlock()\n    item, exists = c.items[key]\n    return item, exists\n}\n\n// \u5217\u4e3e\u5bf9\u8c61\nfunc (c *threadSafeMap) List() []interface{} {\n    c.lock.RLock()\n    defer c.lock.RUnlock()\n    // \u76f4\u63a5\u904d\u5386\u5bf9\u8c61map\n    list := make([]interface{}, 0, len(c.items))\n    for _, item := range c.items {\n        list = append(list, item)\n    }\n    return list\n}\n\n// \u5217\u4e3e\u5bf9\u8c61\u952e\nfunc (c *threadSafeMap) ListKeys() []string {\n    c.lock.RLock()\n    defer c.lock.RUnlock()\n    // \u540c\u6837\u904d\u5386\u5bf9\u8c61map\uff0c\u53ea\u9700\u8981\u5bf9\u8c61\u952e\u503c\n    list := make([]string, 0, len(c.items))\n    for key := range c.items {\n        list = append(list, key)\n    }\n    return list\n}\n\n// \u66ff\u6362\u6240\u6709\u5bf9\u8c61\uff0c\u76f8\u5f53\u4e8e\u91cd\u65b0\u6784\u9020\u4e86\u4e00\u6b21\nfunc (c *threadSafeMap) Replace(items map[string]interface{}, resourceVersion string) {\n    c.lock.Lock()\n    defer c.lock.Unlock()\n    // \u76f4\u63a5\u8986\u76d6\u4ee5\u524d\u7684\u5bf9\u8c61\n    c.items = items\n\n    // \u91cd\u5efa\u6240\u6709\u7d22\u5f15\n    c.indices = Indices{}\n    for key, item := range c.items {\n        c.updateIndices(nil, item, key)\n    }\n}\n</code></pre> <p>\u7136\u540e\u5c31\u662f\u548c\u7d22\u5f15\u76f8\u5173\u7684\u51fd\u6570\uff0c\u6bd4\u5982 <code>Index</code> \u51fd\u6570\uff1a</p> <pre><code>// client-go/tools/cache/thread_safe_store.go\n// Index \u901a\u8fc7\u6307\u5b9a\u7684\u7d22\u5f15\u51fd\u6570\u8ba1\u7b97\u5bf9\u8c61\u7684\u7d22\u5f15\u952e\uff0c\u7136\u540e\u628a\u7d22\u5f15\u952e\u7684\u5bf9\u8c61\u5168\u90e8\u53d6\u51fa\u6765\nfunc (c *threadSafeMap) Index(indexName string, obj interface{}) ([]interface{}, error) {\n    // \u53ea\u8bfb\uff0c\u6240\u4ee5\u7528\u8bfb\u9501\u5373\u53ef\n    c.lock.RLock()\n    defer c.lock.RUnlock()\n    // \u4ece\u7d22\u5f15\u5206\u7c7b\u4e2d\u53d6\u51faindexName\u8fd9\u4e2a\u5206\u7c7b\u7d22\u5f15\u51fd\u6570\n    indexFunc := c.indexers[indexName]\n    if indexFunc == nil {\n        return nil, fmt.Errorf(\"Index with name %s does not exist\", indexName)\n    }\n    // \u83b7\u53d6\u5bf9\u8c61\u7684\u7d22\u5f15\u952e\n    indexKeys, err := indexFunc(obj)\n    if err != nil {\n        return nil, err\n    }\n    // \u53d6\u51faindexName\u8fd9\u4e2a\u5206\u7c7b\u7684\u6240\u6709\u7d22\u5f15\n    index := c.indices[indexName]\n    // \u58f0\u660e\u5bf9\u8c61\u7684\u5bf9\u8c61\u952e\u96c6\u5408\n    var returnKeySet sets.String  // string\u7c7b\u578b\u7684set\n    if len(indexKeys) == 1 {\n        // \u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u53ea\u6709\u4e00\u4e2a\u503c\u5339\u914d\n        // \u4f18\u5316\u4e0b\u6700\u5e38\u89c1\u7684\u8def\u5f84 - \u6b64\u5904\u4e0d\u9700\u8981\u91cd\u590d\u6570\u636e\u6d88\u9664\n        returnKeySet = index[indexKeys[0]]\n    } else {\n        // \u9700\u8981\u5bf9\u8fd4\u56de\u5217\u8868\u8fdb\u884c\u6d88\u91cd\n        returnKeySet = sets.String{}\n        for _, indexKey := range indexKeys {\n            for key := range index[indexKey] {\n                returnKeySet.Insert(key)\n            }\n        }\n    }\n    // \u901a\u8fc7\u5bf9\u8c61\u952e\u628a\u5bf9\u8c61\u53d6\u51fa\u6765\n    list := make([]interface{}, 0, returnKeySet.Len())\n    for absoluteKey := range returnKeySet {\n        list = append(list, c.items[absoluteKey])\n    }\n    return list, nil\n}\n</code></pre> <p>\u6bd4\u5982\u6211\u4eec\u8981\u53d6\u51fa\u4e00\u4e2a\u8282\u70b9\u4e0a\u7684\u6240\u6709 Pod\uff0c\u8fd9\u5c31\u662f\u4e00\u4e2a\u7279\u5f81\uff0cindexName \u5c31\u662f\u4e00\u4e2a\u7279\u5f81\u540d\uff0c</p> <pre><code>indexFunc = c.indexers[indexName]\n</code></pre> <p>\u5c31\u662f\u83b7\u53d6\u5230\u7d22\u5f15\u8ba1\u7b97\u51fd\u6570\uff0c\u7136\u540e\u901a\u8fc7\u8fd9\u4e2a\u51fd\u6570\u53ef\u4ee5\u8ba1\u7b97\u5f97\u5230\u8fd9\u4e2a\u5bf9\u8c61\u7684\u7d22\u5f15\u952e\uff0c\u7136\u540e\u901a\u8fc7 <code>indices</code> \u53d6\u51fa\u8be5\u7279\u5f81\u4e0b\u9762\u7684\u6240\u6709\u7d22\u5f15\uff0c\u7136\u540e\u5faa\u73af\u7d22\u5f15\u952e\uff0c\u901a\u8fc7\u7d22\u5f15\u628a\u6240\u6709\u7684\u5bf9\u8c61\u952e\u53d6\u51fa\u6765\uff0c\u7136\u540e\u901a\u8fc7\u5bf9\u8c61\u952e\u628a\u6240\u6709\u5bf9\u8c61\u53d6\u51fa\u6765\u3002</p> <p>\u7136\u540e</p> <pre><code>// client-go/tools/cache/thread_safe_store.go\n// ByIndex \u76f4\u63a5\u901a\u8fc7\u7d22\u5f15\u952e\u6765\u83b7\u53d6\u5bf9\u8c61\u5217\u8868\uff0c\u548c\u4e0a\u9762\u6bd4\u8f83\u7c7b\u4f3c\nfunc (c *threadSafeMap) ByIndex(indexName, indexKey string) ([]interface{}, error) {\n    c.lock.RLock()\n    defer c.lock.RUnlock()\n    // \u83b7\u53d6 indexName \u7684\u7d22\u5f15\u5206\u7c7b\u51fd\u6570\n    indexFunc := c.indexers[indexName]\n    if indexFunc == nil {\n        return nil, fmt.Errorf(\"Index with name %s does not exist\", indexName)\n    }\n    // \u83b7\u53d6\u5206\u7c7b\u7684\u6240\u6709\u7d22\u5f15\n    index := c.indices[indexName]\n    // \u76f4\u63a5\u901a\u8fc7\u7d22\u5f15\u952e\u53bb\u53d6\u6240\u6709\u7684\u5bf9\u8c61\u952e\n    set := index[indexKey]\n    // \u904d\u5386\u5bf9\u8c61\u952e\u8f93\u51fa\u5bf9\u8c61\n    list := make([]interface{}, 0, set.Len())\n    for key := range set {\n        list = append(list, c.items[key])\n    }\n\n    return list, nil\n}\n</code></pre> <p>\u8fd9\u4e2a\u51fd\u6570\u548c\u4e0a\u9762\u7684 Index \u51fd\u6570\u57fa\u672c\u7c7b\u4f3c\uff0c\u529f\u80fd\u66f4\u52a0\u7b80\u5355\uff0c\u76f4\u63a5\u901a\u8fc7\u7d22\u5f15\u952e\u83b7\u53d6\u5168\u90e8\u5bf9\u8c61\u3002\u7136\u540e\u63a5\u4e0b\u6765\u662f <code>IndexKeys</code> \u548c <code>ListIndexFuncValues</code> \u8fd9\u4e24\u4e2a\u51fd\u6570\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/tools/cache/thread_safe_store.go\n// IndexKeys \u6839\u636e\u7d22\u5f15\u952e\u83b7\u5f97\u5bf9\u5e94\u7684\u5bf9\u8c61\u952e\u5217\u8868\nfunc (c *threadSafeMap) IndexKeys(indexName, indexKey string) ([]string, error) {\n    c.lock.RLock()\n    defer c.lock.RUnlock()\n    // \u83b7\u5f97\u7d22\u5f15\u5206\u7c7b\u7684\u7d22\u5f15\u952e\u8ba1\u7b97\u51fd\u6570\n    indexFunc := c.indexers[indexName]\n    if indexFunc == nil {\n        return nil, fmt.Errorf(\"Index with name %s does not exist\", indexName)\n    }\n    // \u83b7\u53d6\u7d22\u5f15\u5206\u7c7b\u7684\u6240\u6709\u7d22\u5f15\n    index := c.indices[indexName]\n    // \u901a\u8fc7\u7d22\u5f15\u952e\u83b7\u53d6\u6240\u6709\u7684\u5bf9\u8c61\u952e\n    set := index[indexKey]\n    return set.List(), nil\n}\n\n// client-go/tools/cache/thread_safe_store.go\n// \u7528\u6765\u83b7\u53d6\u7d22\u5f15\u5206\u7c7b\u4e2d\u7684\u6240\u6709\u7d22\u5f15\u952e\nfunc (c *threadSafeMap) ListIndexFuncValues(indexName string) []string {\n    c.lock.RLock()\n    defer c.lock.RUnlock()\n    // \u6839\u636e\u7d22\u5f15\u5206\u7c7b\u83b7\u53d6\u6240\u6709\u7684\u7d22\u5f15\n    index := c.indices[indexName]\n    names := make([]string, 0, len(index))\n    // \u904d\u5386\u8f93\u51fa\u7d22\u5f15\u952e\n    for key := range index {\n        names = append(names, key)\n    }\n    return names\n}\n</code></pre> <p>\u5176\u4ed6\u51fd\u6570\u90fd\u6bd4\u8f83\u7b80\u5355\uff0c\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u6709\u4e24\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u51fd\u6570\uff0c\u7528\u6765\u66f4\u65b0\u7d22\u5f15\u7684\u64cd\u4f5c\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/tools/cache/thread_safe_store.go\n// updateIndices \u5f53\u6709\u5bf9\u8c61\u6dfb\u52a0\u6216\u8005\u66f4\u65b0\u65f6\uff0c\u9700\u8981\u66f4\u65b0\u7d22\u5f15\uff0c\u56e0\u4e3a\u8c03\u7528\u8be5\u51fd\u6570\u7684\u51fd\u6570\u5df2\u7ecf\u52a0\u9501\u4e86\uff0c\u6240\u4ee5\u8fd9\u4e2a\u51fd\u6570\u6ca1\u6709\u52a0\u9501\u64cd\u4f5c\nfunc (c *threadSafeMap) updateIndices(oldObj interface{}, newObj interface{}, key string) {\n    // \u5982\u679c\u6709\u8001\u5bf9\u8c61\uff0c\u90a3\u4e48\u5c31\u8981\u5148\u5220\u9664\u8001\u5bf9\u8c61\u7684\u7d22\u5f15\n    if oldObj != nil {\n        c.deleteFromIndices(oldObj, key)\n    }\n    // \u904d\u5386\u6240\u6709\u7684\u5206\u7c7b\u7d22\u5f15\u51fd\u6570\uff0c\u56e0\u4e3a\u8981\u4e3a\u5bf9\u8c61\u5728\u6240\u6709\u7684\u7d22\u5f15\u5206\u7c7b\u4e2d\u521b\u5efa\u7d22\u5f15\u952e\n    for name, indexFunc := range c.indexers {\n        // \u8ba1\u7b97\u65b0\u5bf9\u8c61\u7684\u7d22\u5f15\u952e\n        indexValues, err := indexFunc(newObj)\n        if err != nil {\n            panic(fmt.Errorf(\"unable to calculate an index entry for key %q on index %q: %v\", key, name, err))\n        }\n        // \u83b7\u5f97\u7d22\u5f15\u5206\u7c7b\u7684\u6240\u6709\u7d22\u5f15\n        index := c.indices[name]\n        // \u4e3a\u7a7a\u8bf4\u660e\u8fd9\u4e2a\u7d22\u5f15\u5206\u7c7b\u8fd8\u6ca1\u6709\u4efb\u4f55\u7d22\u5f15\n        if index == nil {\n            // \u521d\u59cb\u5316\u4e00\u4e2a\u7a7a\u7d22\u5f15\n            index = Index{}\n            c.indices[name] = index\n        }\n        // \u904d\u5386\u7d22\u5f15\u952e\n        for _, indexValue := range indexValues {\n            // \u83b7\u53d6\u7d22\u5f15\u952e\u7684\u5bf9\u8c61\u952e\u96c6\u5408\n            set := index[indexValue]\n            // \u4e3a\u7a7a\u8bf4\u660e\u8fd9\u4e2a\u7d22\u5f15\u952e\u4e0b\u9762\u8fd8\u6ca1\u6709\u4efb\u4f55\u5bf9\u8c61\n            if set == nil {\n                // \u521b\u5efa\u5bf9\u8c61\u952e\u96c6\u5408\n                set = sets.String{}\n                index[indexValue] = set\n            }\n            // \u628a\u5bf9\u8c61\u952e\u63d2\u5165\u5230\u5bf9\u8c61\u952e\u96c6\u5408\u4e2d\n            set.Insert(key)\n        }\n    }\n}\n\n// deleteFromIndices \u5220\u9664\u5bf9\u8c61\u7684\u7d22\u5f15\nfunc (c *threadSafeMap) deleteFromIndices(obj interface{}, key string) {\n    // \u904d\u5386\u6240\u6709\u7d22\u5f15\u5206\u7c7b\u51fd\u6570\n    for name, indexFunc := range c.indexers {\n        // \u8ba1\u7b97\u5bf9\u8c61\u7684\u7d22\u5f15\u952e\n        indexValues, err := indexFunc(obj)\n        if err != nil {\n            panic(fmt.Errorf(\"unable to calculate an index entry for key %q on index %q: %v\", key, name, err))\n        }\n        // \u83b7\u53d6\u7d22\u5f15\u5206\u7c7b\u7684\u6240\u6709\u7d22\u5f15\n        index := c.indices[name]\n        if index == nil {\n            continue\n        }\n        // \u904d\u5386\u5bf9\u8c61\u7684\u7d22\u5f15\u952e\n        for _, indexValue := range indexValues {\n            // \u83b7\u53d6\u7d22\u5f15\u952e\u5bf9\u5e94\u7684\u5bf9\u8c61\u952e\u96c6\u5408\n            set := index[indexValue]\n            if set != nil {\n                // \u628a\u5bf9\u8c61\u952e\u4ece\u96c6\u5408\u4e2d\u5220\u9664\n                set.Delete(key)\n            }\n        }\n    }\n}\n</code></pre> <p>\u4e0a\u9762\u5c31\u662f\u5173\u4e8e <code>ThreadSafeStore</code> \u8fd9\u4e2a\u63a5\u53e3\u7684\u4e00\u4e9b\u8bf4\u660e\u4ee5\u53ca\u5bf9\u5e94\u7684\u5b9e\u73b0\u3002\u6700\u4e3b\u8981\u7684\u8fd8\u662f\u9700\u8981\u7406\u89e3 <code>Indices</code>\u3001<code>Indexers</code>\u3001<code>Index</code> \u4ee5\u53ca <code>IndexFunc</code> \u8fd9\u51e0\u4e2a\u7c7b\u578b\u7684\u5b9a\u4e49\u3002</p> <p>\u4e0a\u9762\u6211\u63d0\u5230\u4e86 <code>cache</code> \u7684\u5927\u90e8\u5206\u5b9e\u73b0\u90fd\u662f\u901a\u8fc7 <code>ThreadSafeStore</code> \u64cd\u4f5c\u7684\uff0c\u6240\u4ee5 <code>cache</code> \u672c\u8eab\u6bd4\u8f83\u7b80\u5355\uff0c\u53ef\u4ee5\u5728</p> <pre><code>client-go/tools/cache/store.go\n</code></pre> <p>\u4e0b\u9762\u67e5\u770b\u5177\u4f53\u7684\u5b9e\u73b0\u3002</p>"},{"location":"kubernetes_code/client_go/indexer/#_1","title":"\u7d22\u5f15\u51fd\u6570","text":"<p>\u901a\u8fc7\u4e0a\u9762\u7684\u5206\u6790\uff0c\u6211\u4eec\u53ef\u4ee5\u4e86\u89e3\u5230 Indexer \u7684\u6838\u5fc3\u5c31\u662f\u5404\u79cd\u7d22\u5f15\u51fd\u6570\u7684\u5b9a\u4e49\u4e86\u3002\u5728 Kubernetes \u4e2d\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u79cd\u7d22\u5f15\u51fd\u6570\uff1a</p> <ol> <li> <p><code>MetaNamespaceIndexFunc     <pre><code>\uff0c\u5b9a\u4e49\u5728 \n</code></pre>     client-go/tools/cache/index.go</code></p> <p>\u4e0b\u9762\uff0c\u662f\u4e00\u4e2a<code>\u9ed8\u8ba4</code>\u7684\u7d22\u5f15\u51fd\u6570\uff0c\u5b83\u57fa\u4e8e\u5bf9\u8c61\u7684\u547d\u540d\u7a7a\u95f4\u8fdb\u884c\u7d22\u5f15\uff0c\u4e5f\u5c31\u662f\u6240\u6709\u5bf9\u8c61\u4ee5 namespace \u4f5c\u4e3a\u7d22\u5f15\u952e\u3002 2.  <code>indexByPodNodeName</code>\uff0c\u5b9a\u4e49\u5728 </p> <pre><code>kubernetes/pkg/controller/daemon/daemon_controller.go\n</code></pre> <p>\u4e0b\u9762\uff0c\u8be5\u7d22\u5f15\u51fd\u6570\u8ba1\u7b97\u7684\u662f Pod \u5bf9\u8c61\u6240\u5728\u8282\u70b9\u7684\u540d\u5b57\u3002</p> </li> </ol> <p>``` MetaNamespaceIndexFunc <pre><code> \u662f\u9ed8\u8ba4\u7684\u7d22\u5f15\u51fd\u6570\uff0c\u4e5f\u5c31\u662f\u5728\u7d22\u5f15\u4e2d\u5927\u90e8\u5206\u5c31\u4e00\u4e2a\u5206\u7c7b\uff0c\u8fd9\u4e2a\u5206\u7c7b\u7684\u7d22\u5f15\u952e\u5c31\u662f `namesapce`\u3002\u5bf9\u5e94\u7684 `Indexers` \u5982\u4e0b\u6240\u793a\uff1a\n</code></pre> Indexers{\"namespace\": MetaNamespaceIndexFunc} <pre><code>&gt; ```\nMetaNamespaceIndexFunc\n</code></pre></p> <p>\u51fd\u6570\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>// client-go/tools/cache/index.go\nfunc MetaNamespaceIndexFunc(obj interface{}) ([]string, error) {\n    meta, err := meta.Accessor(obj)\n    if err != nil {\n        return []string{\"\"}, fmt.Errorf(\"object has no meta: %v\", err)\n    }\n    return []string{meta.GetNamespace()}, nil\n}\n</code></pre> <p>Indexers\uff1anamespace -&gt; IndexFunc([kube-system]) Indices\uff1a namespace -&gt; Index (kube-system -&gt; [objKey1, objKey2...])</p> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u7d22\u5f15\u51fd\u6570\u5176\u5b9e\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u8fd4\u56de\u8d44\u6e90\u5bf9\u8c61\u7684\u547d\u540d\u7a7a\u95f4\u800c\u5df2\u3002\u90a3\u4e48\u6709\u4eba\u80af\u5b9a\u4f1a\u95ee\uff0c\u5982\u679c\u8fd9\u6837\u7684\u8bdd\uff0c\u6240\u6709\u7684\u5bf9\u8c61\u90fd\u5b58\u5728\u4e00\u4e2a namesapce \u7d22\u5f15\u952e\u4e0b\u9762\uff0c\u8fd9\u6837\u7684\u6548\u7387\u5c82\u4e0d\u662f\u592a\u4f4e\u4e86\uff1f\u5176\u5b9e client-go \u4e3a\u6bcf\u7c7b\u5bf9\u8c61\u90fd\u521b\u5efa\u4e86 <code>Informer</code>\uff08Informer \u5185\u6709 Indexer\uff09\uff0c\u6240\u4ee5\u5373\u4fbf\u5b58\u50a8\u5728\u76f8\u540c namesapce \u4e0b\u7684\u5bf9\u8c61\u90fd\u662f\u540c\u4e00\u7c7b\uff0c\u8fd9\u4e2a\u95ee\u9898\u81ea\u7136\u4e5f\u5c31\u6ca1\u6709\u4e86\u3002</p> <p>\u53e6\u5916\u5927\u5bb6\u4e00\u5b9a\u8981\u533a\u5206 </p> <pre><code>MetaNamespaceIndexFunc\n</code></pre> <p>\u548c <code>MetaNamespaceKeyFunc</code> \u7684\u533a\u5206\uff0c\u7b2c\u4e00\u4e2a\u7d22\u5f15\u952e\u8ba1\u7b97\u51fd\u6570\uff0c\u7b2c\u4e8c\u4e2a\u662f\u5bf9\u8c61\u952e\u8ba1\u7b97\u51fd\u6570\uff0c\u7b2c\u4e00\u4e2a\u8fd4\u56de\u7684\u662f namespace\uff0c\u7b2c\u4e8c\u4e2a\u8fd4\u56de\u7684\u662f\u5bf9\u8c61\u5305\u542b namespace \u5728\u5185\u7684\u5bf9\u8c61\u5168\u79f0\u3002<code>MetaNamespaceKeyFunc</code> \u51fd\u6570\u7684\u5b9a\u4e49\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/tools/cache/store.go\n// MetaNamespaceKeyFunc \u662f\u4e00\u4e2a\u9ed8\u8ba4\u7684 KeyFunc\uff0c\u5b83\u77e5\u9053\u5982\u4f55\u4e3a\u5b9e\u73b0 meta.Interface \u63a5\u53e3\u7684 API \u5bf9\u8c61\u751f\u6210\u952e\u3002\u952e\u4f7f\u7528\u683c\u5f0f &lt;namespace&gt;/&lt;name&gt;\uff08\u9664\u975e&lt;namespace&gt;\u4e3a\u7a7a\uff0c\u503c\u5c31\u662f &lt;name&gt;\uff09\nfunc MetaNamespaceKeyFunc(obj interface{}) (string, error) {\n    if key, ok := obj.(ExplicitKey); ok {\n        return string(key), nil\n    }\n    meta, err := meta.Accessor(obj)\n    if err != nil {\n        return \"\", fmt.Errorf(\"object has no meta: %v\", err)\n    }\n    if len(meta.GetNamespace()) &gt; 0 {\n        return meta.GetNamespace() + \"/\" + meta.GetName(), nil\n    }\n    return meta.GetName(), nil\n}\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u548c\u5927\u5bb6\u4e00\u8d77\u6765\u5206\u6790 <code>Informer</code> \u5728 client-go \u4e2d\u7684\u4f7f\u7528\u3002</p>"},{"location":"kubernetes_code/client_go/workqueue/","title":"workqueue","text":""},{"location":"kubernetes_code/client_go/workqueue/#workqueue","title":"WorkQueue","text":"<p>workqueue \u662f client-go \u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\uff0c\u4e0b\u56fe\u53ef\u4ee5\u770b\u5230 workqueue \u5728 client-go \u4e2d\u7684\u4f4d\u7f6e\uff0c\u540e\u9762\u7528<code>\u961f\u5217</code>\u4ee3\u66ff workqueue\u3002</p> <p></p> <p>client-go \u4e3a\u4ec0\u4e48\u8981\u5b9e\u73b0\u961f\u5217\u5462\uff1f\u961f\u5217\u6709\u70b9\u7c7b\u4f3c\u4e8e golang \u4e2d\u7684 channel\uff0c\u4e3b\u8981\u7528\u4e8e\u5e76\u53d1\u7a0b\u5e8f\u95f4\u7684\u6570\u636e\u540c\u6b65\u3002\u6bd4\u5982\u5404\u79cd Controller \u901a\u8fc7 client-go \u7684 informer \u76d1\u542c\u5bf9\u8c61\u53d8\u5316\uff0c\u5f53\u6709\u8d44\u6e90\u53d8\u5316\u65f6\u901a\u8fc7\u56de\u8c03\u51fd\u6570\u5c06\u8d44\u6e90\u5199\u5165\u961f\u5217\u4e2d\uff0c\u518d\u7531\u5176\u4ed6\u7684\u534f\u7a0b\u5b8c\u6210\u5904\u7406\u3002\u4e0d\u76f4\u63a5\u4f7f\u7528 channel \u4e3b\u8981\u662f\u56e0\u4e3a channel \u529f\u80fd\u8fc7\u4e8e\u5355\u4e00\uff0c\u65e0\u6cd5\u6ee1\u8db3\u5404\u7c7b\u573a\u666f\u7684\u9700\u6c42\uff0c\u6bd4\u5982\u9650\u5236\u6570\u636e\u961f\u5217\u7684\u5199\u5165\u901f\u5ea6\u3002</p> <p>\u56e0\u4e3a Kubernetes \u4e2d\u5f88\u591a\u6a21\u5757\u90fd\u6709\u961f\u5217\u7684\u9700\u6c42\uff0c\u800c\u4e14\u5f88\u591a\u9700\u6c42\u90fd\u4e00\u6837\uff0c\u6240\u4ee5\u7edf\u4e00\u5728 client-go \u4e2d\u5b9e\u73b0\u4e86\u3002client-go \u4e2d\u62bd\u8c61\u4e86\u51e0\u79cd\u961f\u5217\uff0c\u5305\u62ec<code>\u901a\u7528\u961f\u5217\u3001\u9650\u901f\u961f\u5217\u3001\u5ef6\u65f6\u961f\u5217</code>\u7b49\u3002\u6e90\u7801\u7edf\u4e00\u90fd\u5728 </p> <pre><code>staging/src/k8s.io/client-go\n</code></pre> <p>\u5305\u4e0b\u9762\u3002</p>"},{"location":"kubernetes_code/client_go/workqueue/#_1","title":"\u901a\u7528\u961f\u5217","text":"<p>\u6e90\u7801\u8def\u5f84</p> <pre><code>client-go/util/workqueue/queue.go\n</code></pre> <p>\uff0c\u4e3b\u8981\u5c31\u662f\u5176\u4e2d <code>Interface</code> \u8fd9\u4e2a\u63a5\u53e3\u7684\u58f0\u660e\uff1a</p> <pre><code>type Interface interface {\n    Add(item interface{})  // \u5411\u961f\u5217\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u539f\u751f\uff0cinterface{}\u7c7b\u578b\uff0c\u8bf4\u660e\u53ef\u4ee5\u6dfb\u52a0\u4efb\u4f55\u7c7b\u578b\u7684\u5143\u7d20\n    Len() int  // \u961f\u5217\u957f\u961f\uff0c\u4e5f\u5c31\u662f\u5143\u7d20\u4e2a\u6570\n    Get() (item interface{}, shutdown bool)  // \u4ece\u961f\u5217\u4e2d\u83b7\u53d6\u4e00\u4e2a\u5143\u7d20\uff0c\u7b2c\u4e8c\u4e2a\u8fd4\u56de\u503c\u544a\u77e5\u961f\u5217\u662f\u5426\u5df2\u7ecf\u5173\u95ed\u4e86\n    Done(item interface{})  // \u4ece\u961f\u5217\u4e2d\u83b7\u53d6\u67d0\u4e2a\u5143\u7d20\u662f\u5426\u5df2\u7ecf\u5904\u7406\u5b8c\n    ShutDown()  // \u5173\u95ed\u961f\u5217\n    ShuttingDown() bool  // \u67e5\u8be2\u961f\u5217\u662f\u5426\u6b63\u5728\u5173\u95ed\n}\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u961f\u5217\u548c channel \u4e0d\u540c\u7684\u5730\u65b9\u5728\u4e8e Get() \u83b7\u53d6\u5143\u7d20\u540e\u5e76\u4e0d\u4f1a\u4ece\u961f\u5217\u4e2d\u79fb\u9664\uff0c\u53ea\u6709\u6267\u884c\u4e86 Done() \u51fd\u6570\u540e\u624d\u4f1a\u6267\u884c\u79fb\u9664\u64cd\u4f5c\uff0c\u800c channel \u7684 <code>&lt;-</code> \u8c03\u7528\u5c31\u76f4\u63a5\u4ece channel \u7684\u5bf9\u8c61\u4e2d\u5220\u9664\u4e86\u3002</p> <p><code>Interface</code> \u662f\u4e00\u4e2a\u63a5\u53e3\u7684\u62bd\u8c61\u5b9a\u4e49\uff0c\u81ea\u7136\u4f1a\u6709\u5404\u79cd\u5b9e\u73b0\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u6765\u5bf9 client-go \u4e2d\u5b9e\u73b0\u7684\u901a\u7528\u961f\u5217\u8fdb\u884c\u8bf4\u660e\uff0c\u9996\u5148\u770b\u51e0\u4e2a\u91cd\u8981\u7684\u7c7b\u578b\uff1a</p> <pre><code>// client-go/util/workqueue/queue.go\n// Type \u662f\u4e00\u4e2a\u961f\u5217\ntype Type struct {\n    queue []t       // \u5b9a\u4e49\u4e86\u6211\u4eec\u7684\u5143\u7d20\u96c6\u5408\u7684\u987a\u5e8f\uff0c\u961f\u5217\u4e2d\u7684\u6bcf\u4e2a\u5143\u7d20\u90fd\u5e94\u8be5\u5728\u810f\u6570\u636e\u96c6\u5408\u4e2d\uff0c\u800c\u4e0d\u662f\u5728\u5904\u7406\u96c6\u5408\u4e2d\n    dirty set       // \u810f\u5143\u7d20\u96c6\u5408\uff0c\u5b9a\u4e49\u4e86\u6240\u6709\u9700\u8981\u5904\u7406\u7684\u5143\u7d20\u96c6\u5408\n    processing set  // \u6b63\u5728\u5904\u7406\u7684\u5143\u7d20\u96c6\u5408\uff0c\u8fd9\u4e9b\u5143\u7d20\u53ef\u80fd\u540c\u65f6\u5b58\u5728\u4e8e\u810f\u6570\u636e\u96c6\u5408\u4e2d\uff0c\u5f53\u6211\u4eec\u5904\u7406\u5b8c\u67d0\u4e2a\u5143\u7d20\u5e76\u5c06\u5176\u4ece\u8fd9\u4e2a\u96c6\u5408\u4e2d\u79fb\u9664\u65f6\uff0c\u6211\u4eec\u5c06\u68c0\u67e5\u5b83\u662f\u5426\u5728\u810f\u6570\u636e\u96c6\u5408\u4e2d\uff0c\u5982\u679c\u5728\uff0c\u5219\u5c06\u5176\u6dfb\u52a0\u5230\u961f\u5217\u4e2d\n    cond *sync.Cond // \u4e0epthread_cond_t\u76f8\u540c\uff0c\u6761\u4ef6\u540c\u6b65\n    shuttingDown bool   // \u5173\u95ed\u6807\u8bb0\n    metrics queueMetrics    // \u4e0eprometheus\u4e2d\u7684metrics\u6982\u5ff5\u76f8\u540c\n}\n</code></pre> <p>Cond</p> <p>Golang \u7684 sync \u5305\u4e2d\u7684 Cond \u5b9e\u73b0\u4e86\u4e00\u79cd\u6761\u4ef6\u53d8\u91cf\uff0c\u53ef\u4ee5\u4f7f\u7528\u5728\u591a\u4e2aReader\u7b49\u5f85\u5171\u4eab\u8d44\u6e90ready\u7684\u573a\u666f\uff08\u5982\u679c\u53ea\u6709\u4e00\u8bfb\u4e00\u5199\uff0c\u4e00\u4e2a\u9501\u6216\u8005channel\u5c31\u641e\u5b9a\u4e86\uff09\u3002 Cond\u7684\u6c47\u5408\u70b9\uff1a\u591a\u4e2agoroutines\u7b49\u5f85\u30011\u4e2agoroutine\u901a\u77e5\u4e8b\u4ef6\u53d1\u751f\u3002 \u6bcf\u4e2aCond\u90fd\u4f1a\u5173\u8054\u4e00\u4e2aLock\uff08sync.Mutex or sync.RWMutex\uff09\uff0c\u5f53\u4fee\u6539\u6761\u4ef6\u6216\u8005\u8c03\u7528Wait\u65b9\u6cd5\u65f6\uff0c\u5fc5\u987b\u52a0\u9501\uff0c\u4fdd\u62a4condition\u3002</p> <p>\u4e0b\u9762\u662f\u4e0a\u9762\u8fd9\u4e9b\u7c7b\u578b\u7684\u5b9a\u4e49\uff1a</p> <pre><code>type empty struct{}  // \u7a7a\u7c7b\u578b\ntype t interface{}  // \u7a7a\u63a5\u53e3\u7c7b\u578b\uff0c\u5b9e\u9645\u4e0a\u8868\u793a\u4efb\u4f55\u7c7b\u578b\ntype set map[t]empty  // \u7528map\u5b9e\u73b0\u7684set\uff0ckey\u624d\u662f\u771f\u6b63\u7684\u5143\u7d20\uff0c\u4efb\u4f55\u7c7b\u578b\u90fd\u53ef\u4ee5\uff0c\u6240\u6709\u7684value\u662f\u7a7a\u6570\u636e\u5c31\u884c\u4e86\n</code></pre> <p>\u9996\u5148\u770b\u4e0b <code>Add()</code> \u51fd\u6570\u7684\u5b9e\u73b0\uff1a</p> <pre><code>// \u4ee3\u7801\u8def\u5f84\uff1aclient-go/util/workqueue/queue.go\nfunc (q *Type) Add(item interface{}) {\n    // \u548cpthread_cond_t\u4e0d\u540c\u7684\u662fgolang\u7684cond\u81ea\u5e26\u4e86\u4e92\u65a5\u9501\n    q.cond.L.Lock()\n    defer q.cond.L.Unlock()\n    // \u961f\u5217\u6b63\u5728\u5173\u95ed\uff0c\u5219\u76f4\u63a5\u8fd4\u56de\n    if q.shuttingDown {\n        return\n    }\n    // \u5df2\u7ecf\u6807\u8bb0\u4e3adirt\u7684\u6570\u636e\uff0c\u4e5f\u76f4\u63a5\u8fd4\u56de\uff0c\u56e0\u4e3a\u5b58\u50a8\u5728\u4e86\u810f\u6570\u636e\u7684\u96c6\u5408\u4e2d\n    if q.dirty.has(item) {\n        return\n    }\n    // \u544a\u77e5metrics\u6dfb\u52a0\u5143\u7d20\n    q.metrics.add(item)\n    // \u6dfb\u52a0\u5230\u810f\u6570\u636e\u96c6\u5408\u4e2d\n    q.dirty.insert(item)\n    // \u5143\u7d20\u5982\u679c\u6b63\u5728\u88ab\u5904\u7406\uff0c\u90a3\u5c31\u76f4\u63a5\u8fd4\u56de\n    if q.processing.has(item) {\n        return\n    }\n    // \u8ffd\u52a0\u5230\u5143\u7d20\u6570\u7ec4\u7684\u5c3e\u90e8\n    q.queue = append(q.queue, item)\n    // \u901a\u77e5\u6709\u65b0\u5143\u7d20\u5230\u4e86\uff0c\u6b64\u65f6\u6709\u534f\u7a0b\u963b\u585e\u5c31\u4f1a\u88ab\u5524\u9192\n    q.cond.Signal()\n}\n</code></pre> <p>\u4e0a\u9762\u662f\u5411\u961f\u5217\u6dfb\u52a0\u4e00\u4e2a\u5143\u7d20\u7684\u65b9\u6cd5\u5b9e\u73b0\uff0c\u4f46\u662f\u4e3a\u5565\u5728\u6dfb\u52a0\u6570\u636e\u7684\u540c\u65f6\u8981\u6dfb\u52a0\u5230 dirty \u810f\u6570\u636e\u96c6\u5408\u4e2d\u5462\uff0c\u5b58\u50a8\u5728 queue \u4e2d\u4e0d\u5c31\u53ef\u4ee5\u4e86\u4e48\uff1f\u6211\u4eec\u6765\u5206\u6790\u4ee5\u4e0b\uff0c\u961f\u5217\u6dfb\u52a0\u5143\u7d20\u6709\u51e0\u79cd\u72b6\u6001\uff1a</p> <ol> <li>\u961f\u5217\u5173\u95ed\u4e86\uff0c\u6240\u4ee5\u4e0d\u63a5\u53d7\u4efb\u4f55\u6570\u636e\uff1b</li> <li>\u961f\u5217\u4e2d\u6ca1\u6709\u8be5\u5143\u7d20\uff0c\u90a3\u5c31\u76f4\u63a5\u5b58\u50a8\u5728\u961f\u5217\u4e2d\uff1b</li> <li>\u961f\u5217\u4e2d\u5df2\u7ecf\u6709\u4e86\u8be5\u5143\u7d20\uff0c\u8fd9\u4e2a\u6539\u5982\u4f55\u5224\u65ad\u5462\uff1fset \u7c7b\u578b\u80af\u5b9a\u662f\u6700\u5feb\u7684\uff0c\u6570\u7ec4\u9700\u8981\u904d\u5386\u6548\u7387\u592a\u4f4e\uff0c\u8fd9\u4e5f\u662f dirty \u5b58\u5728\u7684\u4ef7\u503c\u4e4b\u4e00\uff0c\u4e0a\u9762\u7684\u4ee3\u7801\u4e5f\u901a\u8fc7 dirty \u5224\u65ad\u5143\u7d20\u662f\u5426\u5b58\u5728\u7684\uff1b</li> <li>\u961f\u5217\u4e2d\u66fe\u7ecf\u5b58\u50a8\u8fc7\u8be5\u5143\u7d20\uff0c\u4f46\u662f\u5df2\u7ecf\u88ab\u62ff\u8d70\u8fd8\u6ca1\u6709\u8c03\u7528 <code>Done()</code> \u65b9\u6cd5\u65f6\uff0c\u4e5f\u5c31\u662f\u6b63\u5728\u5904\u7406\u4e2d\u7684\u5143\u7d20\uff0c\u6b64\u65f6\u518d\u6dfb\u52a0\u5f53\u524d\u7684\u5143\u7d20\u5e94\u8be5\u662f\u6700\u65b0\u7684\uff0c\u5904\u7406\u4e2d\u7684\u5e94\u8be5\u662f\u8fc7\u65f6\u7684\uff0c\u4e5f\u5c31\u662f\u810f\u7684\u3002</li> </ol> <p>\u7efc\u5408\u4e0a\u9762\u51e0\u79cd\u72b6\u6001\u5c31\u6bd4\u8f83\u597d\u7406\u89e3 dirty \u7684\u5b58\u5728\u4e86\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\u5143\u7d20\u53ea\u4f1a\u5728 processing \u548c dirty \u5b58\u4e00\u4efd\uff0c\u540c\u65f6\u5b58\u5728\u5c31\u8bf4\u660e\u8be5\u5143\u7d20\u5728\u88ab\u5904\u7406\u7684\u540c\u65f6\u53c8\u88ab\u6dfb\u52a0\u4e86\u4e00\u6b21\uff0c\u90a3\u4e48\u5148\u524d\u7684\u90a3\u6b21\u53ef\u4ee5\u7406\u89e3\u4e3a\u810f\u7684\uff0c\u540e\u7eed\u6dfb\u52a0\u7684\u8981\u518d\u88ab\u5904\u7406\u3002</p> <p>\u63a5\u4e0b\u6765\u518d\u6765\u770b\u770b <code>Get()</code> \u51fd\u6570\u662f\u5982\u4f55\u5b9e\u73b0\u7684\uff1a</p> <pre><code>// \u4ee3\u7801\u8def\u5f84\uff1aclient-go/util/workqueue/queue.go\n// Get() \u4f1a\u963b\u585e\u76f4\u5230\u5b83\u53ef\u4ee5\u8fd4\u56de\u8981\u5904\u7406\u7684\u5143\u7d20\u3002\u5982\u679c shutdown=true\uff0c\u5219\u8c03\u7528\u65b9\u5e94\u8be5\u7ed3\u675f\u5176goroutine\uff0c\u5904\u7406\u5b8c\u5143\u7d20\u540e\uff0c\u5fc5\u987b\u8c03\u7528 Done() \u65b9\u6cd5\u3002\nfunc (q *Type) Get() (item interface{}, shutdown bool) {\n    q.cond.L.Lock()\n    defer q.cond.L.Unlock()\n    // \u5982\u679c\u5f53\u524d\u961f\u5217\u4e2d\u6ca1\u6709\u6570\u636e\uff0c\u5e76\u4e14\u6ca1\u6709\u8981\u5173\u95ed\u7684\u72b6\u6001\u5219\u963b\u585e\u534f\u7a0b\n    for len(q.queue) == 0 &amp;&amp; !q.shuttingDown {\n        q.cond.Wait()\n    }\n    // \u534f\u7a0b\u88ab\u6fc0\u6d3b\u4f46\u8fd8\u6ca1\u6709\u6570\u636e\uff0c\u8bf4\u660e\u961f\u5217\u88ab\u5173\u95ed\u4e86\n    if len(q.queue) == 0 {\n        // \u5fc5\u987b\u8fd4\u56de\u5173\u95ed\u4e2d\u7684\u72b6\u6001\n        return nil, true\n    }\n    // \u4ece\u961f\u5217\u4e2d\u5f39\u51fa\u7b2c\u4e00\u4e2a\u5143\u7d20\n    item, q.queue = q.queue[0], q.queue[1:]\n    // \u901a\u77e5metrics\u83b7\u53d6\u5143\u7d20\n    q.metrics.get(item)\n    // \u52a0\u5165\u5230\u5904\u7406\u961f\u5217\u4e2d\n    q.processing.insert(item)\n    // \u540c\u65f6\u4ecedirty\u96c6\u5408\uff08\u9700\u8981\u5904\u7406\u7684\u5143\u7d20\u96c6\u5408\uff09\u4e2d\u79fb\u9664\n    q.dirty.delete(item)\n\n    return item, false\n}\n</code></pre> <p>\u7136\u540e\u6765\u770b\u4e0b <code>Done()</code> \u51fd\u6570\uff1a</p> <pre><code>// \u4ee3\u7801\u8def\u5f84\uff1aclient-go/util/workqueue/queue.go\n// Done \u6807\u8bb0\u5143\u7d20\u4e3a\u5904\u7406\u4e2d\uff0c\u5f53\u88ab\u5904\u7406\u65f6\u5982\u679c\u5df2\u7ecf\u53c8\u88ab\u6807\u8bb0\u4e3a dirty\uff0c\u5219\u4f1a\u5c06\u5176\u91cd\u65b0\u6dfb\u52a0\u5230\u961f\u5217\u4e2d\u8fdb\u884c\u91cd\u65b0\u5904\u7406\u3002\nfunc (q *Type) Done(item interface{}) {\n    q.cond.L.Lock()\n    defer q.cond.L.Unlock()\n\n    // \u901a\u77e5 metrics \u5143\u7d20\u5904\u7406\u5b8c\u4e86\n    q.metrics.done(item)\n    // \u4ece\u6b63\u5728\u5904\u7406\u7684\u96c6\u5408\u4e2d\u5220\u9664\u5143\u7d20\n    q.processing.delete(item)\n    // \u6b64\u5904\u5224\u65ad\u810f\u6570\u636e\u96c6\u5408\uff0c\u5982\u679c\u5728\u5904\u7406\u671f\u95f4\u53c8\u88ab\u6dfb\u52a0\u56de\u53bb\u4e86\uff0c\u5219\u53c8\u653e\u5230\u961f\u5217\u4e2d\u91cd\u65b0\u5904\u7406\u3002\n    if q.dirty.has(item) {\n        q.queue = append(q.queue, item)\n        q.cond.Signal()\n    }\n}\n</code></pre>"},{"location":"kubernetes_code/client_go/workqueue/#_2","title":"\u5ef6\u65f6\u961f\u5217","text":"<p>client-go \u4e2d\u8fd8\u5b9a\u4e49\u4e86\u5ef6\u65f6\u961f\u5217\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/delaying_queue.go\n// DelayingInterface \u662f\u4e00\u4e2a\u53ef\u4ee5\u5728\u4e00\u4e2a\u65f6\u95f4\u540e\u6dfb\u52a0\u4e00\u4e2a\u5143\u7d20\u7684 Interface\u3002\u8fd9\u4f7f\u5f97\u5728\u5931\u8d25\u540e\u91cd\u65b0\u6392\u5217\u5143\u7d20\u66f4\u5bb9\u6613\u800c\u4e0d\u4f1a\u5728\u70ed\u5faa\u73af\u4e2d\u7ed3\u675f\u3002\ntype DelayingInterface interface {\n    Interface\n    // AddAfter \u5728\u6307\u5b9a\u7684\u6301\u7eed\u65f6\u95f4\u8fc7\u540e\u5c06\u5143\u7d20\u6dfb\u52a0\u5230 workqueue \u4e2d\n    AddAfter(item interface{}, duration time.Duration)\n}\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u5b9a\u4e49\u6765\u770b\u5ef6\u65f6\u961f\u5217\u548c\u4e4b\u524d\u7684\u901a\u7528\u961f\u5217\u57fa\u672c\u4e0a\u4e00\u81f4\uff0c\u53ea\u662f\u591a\u4e86\u5ef6\u8fdf\u6dfb\u52a0\u7684\u63a5\u53e3\uff0c\u6240\u4ee5\u76f8\u5f53\u4e8e\u5728\u4e4b\u524d\u7684\u901a\u7528\u961f\u5217\u57fa\u7840\u4e0a\u4f1a\u6dfb\u52a0\u4e00\u4e9b\u673a\u5236\u6765\u5b9e\u73b0\u5ef6\u8fdf\u6dfb\u52a0\uff0c\u5982\u4e0b\u7c7b\u578b\u5b9a\u4e49\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/delaying_queue.go\n// delayingType \u5305\u88c5\u4e86 Interface \u7136\u540e\u63d0\u4f9b\u4e86\u5ef6\u8fdf re-enquing\ntype delayingType struct {\n    Interface  // \u901a\u7528\u961f\u5217\u7684\u5b9e\u73b0\n\n    clock clock.Clock  // \u65f6\u949f\uff0c\u7528\u4e8e\u83b7\u53d6\u65f6\u95f4\n\n    stopCh chan struct{}  // \u5ef6\u65f6\u5c31\u9700\u8981\u5f02\u6b65\uff0c\u6240\u4ee5\u9700\u8981\u53e6\u5916\u4e00\u4e2a\u534f\u7a0b\u5904\u7406\uff0c\u6240\u4ee5\u9700\u8981\u9000\u51fa\u4fe1\u53f7\uff08\u8ba9\u6211\u4eec\u5411\u7b49\u5f85\u5faa\u73af\u53d1\u51fa\u5173\u95ed\u4fe1\u53f7\uff09\n    stopOnce sync.Once  // \u4fdd\u8bc1\u6211\u4eec\u53ea\u53d1\u51fa\u4e00\u6b21\u9000\u51fa\u4fe1\u53f7\n\n    heartbeat clock.Ticker  // \u5b9a\u65f6\u5668\uff0c\u5728\u6ca1\u6709\u4efb\u4f55\u6570\u636e\u64cd\u4f5c\u65f6\u53ef\u4ee5\u5b9a\u65f6\u7684\u5524\u9192\u5904\u7406\u534f\u7a0b\uff08\u786e\u4fdd\u5728\u6fc0\u6d3b\u524d\u4e0d\u8d85\u8fc7 maxWait \u65f6\u95f4\uff09\n\n    waitingForAddCh chan *waitFor // \u6240\u6709\u5ef6\u8fdf\u6dfb\u52a0\u7684\u5143\u7d20\u5c01\u88c5\u6210 waitFor \u653e\u5230\u7f13\u51b2\u961f\u5217\u4e2d\n\n    metrics           retryMetrics  // \u8bb0\u5f55\u91cd\u8bd5\u7684\u6b21\u6570\n    deprecatedMetrics retryMetrics\n}\n\n// waitFor \u4fdd\u5b58\u8981\u6dfb\u52a0\u7684\u6570\u636e\u548c\u5e94\u8be5\u6dfb\u52a0\u7684\u65f6\u95f4\ntype waitFor struct {\n    data    t          // \u8981\u6dfb\u52a0\u7684\u5143\u7d20\u6570\u636e\n    readyAt time.Time  // \u5e94\u8be5\u88ab\u6dfb\u52a0\u7684\u65f6\u95f4\u70b9\n    index int  // \u4f18\u5148\u961f\u5217\uff08heap\uff09\u4e2d\u7684\u7d22\u5f15\n}\n</code></pre> <p>\u4e0a\u9762\u662f\u5ef6\u65f6\u961f\u5217\u7684\u7c7b\u578b\u5b9a\u4e49\uff0c<code>waitFor</code>\u662f\u4fdd\u5b58\u5ef6\u65f6\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5728\u8fd9\u4e2a\u57fa\u7840\u4e0a\u8fd8\u5b9a\u4e49\u4e86\u4e00\u4e2a <code>waitForPriorityQueue</code>\uff0c\u7528\u6765\u5b9e\u73b0 <code>waitFor</code> \u5143\u7d20\u7684\u4f18\u5148\u7ea7\u961f\u5217\uff0c\u628a\u9700\u8981\u5ef6\u8fdf\u7684\u5143\u7d20\u5f62\u6210\u4e86\u4e00\u4e2a\u961f\u5217\uff0c\u6309\u7167\u5143\u7d20\u7684\u5ef6\u65f6\u6dfb\u52a0\u7684\u65f6\u95f4\uff08readyAt\uff09\u4ece\u5c0f\u5230\u5927\u6392\u5e8f\u3002</p> <p>\u901a\u8fc7\u5b9e\u73b0 heap.Interface \u63a5\u53e3\u6765\u5b9e\u73b0\u7684\uff1a</p> <pre><code>// go/src/container/heap/heap.go\ntype Interface interface {\n    sort.Interface\n    Push(x interface{}) // add x as element Len()\n    Pop() interface{}   // remove and return element Len() - \n}\n\n// sort.Interface \u5b9a\u4e49\u5982\u4e0b\u6240\u793a\uff1a\n// go/src/sort/sort.go\ntype Interface interface {\n    // Len is the number of elements in the collection.\n    Len() int\n    // Less reports whether the element with\n    // index i should sort before the element with index j.\n    Less(i, j int) bool\n    // Swap swaps the elements with indexes i and j.\n    Swap(i, j int)\n}\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u53ea\u9700\u8981\u77e5\u9053 <code>waitForPriorityQueue</code> \u662f\u4e00\u4e2a\u6709\u5e8f\u7684 slice\uff0c\u6392\u5e8f\u65b9\u5f0f\u662f\u6309\u7167\u65f6\u95f4\u4ece\u5c0f\u5230\u5927\u6392\u5e8f\u7684\uff0c\u6839\u636e <code>heap.Interface</code> \u7684\u5b9a\u4e49\uff0c\u6211\u4eec\u9700\u8981\u5b9e\u73b0 <code>Len</code>\u3001<code>Less</code>\u3001<code>Swap</code>\u3001<code>Push</code>\u3001<code>Pop</code> \u8fd9\u51e0\u4e2a\u65b9\u6cd5\uff1a</p> <pre><code>// client-go/util/workqueue/delaying_queue.go\ntype waitForPriorityQueue []*waitFor\n\n// \u5b9e\u73b0 Len \u65b9\u6cd5\uff0c\u83b7\u53d6\u961f\u5217\u957f\u5ea6\nfunc (pq waitForPriorityQueue) Len() int {\n    return len(pq)\n}\n// \u6839\u636e\u65f6\u95f4\u6765\u6bd4\u8f83\u6392\u5217\u987a\u5e8f\nfunc (pq waitForPriorityQueue) Less(i, j int) bool {\n    return pq[i].readyAt.Before(pq[j].readyAt)\n}\n// \u5b9e\u73b0\u4ea4\u6362\u7b2ci\u548c\u7b2cj\u4e2a\u5143\u7d20\nfunc (pq waitForPriorityQueue) Swap(i, j int) {\n    pq[i], pq[j] = pq[j], pq[i]\n    pq[i].index = i  // \u7531\u4e8eheap\u4e2d\u6ca1\u6709\u7d22\u5f15\uff0c\u6240\u4ee5\u9700\u8981\u81ea\u5df1\u8bb0\u5f55\uff0cwaitFor\u4e2d\u5c31\u5b9a\u4e49\u4e86index\u7d22\u5f15\n    pq[j].index = j\n}\n\n// \u6dfb\u52a0\u5143\u7d20\u5230\u961f\u5217\u4e2d\nfunc (pq *waitForPriorityQueue) Push(x interface{}) {\n    n := len(*pq)\n    item := x.(*waitFor)\n    item.index = n  // \u8bb0\u5f55\u7d22\u5f15\u503c\n    *pq = append(*pq, item)  // \u653e\u5230slice\u5c3e\u90e8\n}\n\n// \u4ece\u961f\u5217\u4e2d\u5f39\u51fa\u6700\u540e\u4e00\u4e2a\u5143\u7d20\nfunc (pq *waitForPriorityQueue) Pop() interface{} {\n    n := len(*pq)\n    item := (*pq)[n-1]\n    item.index = -1\n    *pq = (*pq)[0:(n - 1)]  // \u53bb\u6389\u6700\u540e\u4e00\u4e2a\u5143\u7d20\n    return item\n}\n\n// \u8fd4\u56de\u7b2c\u4e00\u4e2a\u5143\u7d20\uff0c\u6ce8\u610f\u5e76\u6ca1\u6709\u79fb\u8d70\nfunc (pq waitForPriorityQueue) Peek() interface{} {\n    return pq[0]\n}\n</code></pre> <p>\u56e0\u4e3a\u5ef6\u65f6\u961f\u5217\u5229\u7528 <code>waitForPriorityQueue</code> \u961f\u5217\u7ba1\u7406\u6240\u6709\u5ef6\u65f6\u6dfb\u52a0\u7684\u5143\u7d20\uff0c\u6240\u6709\u7684\u5143\u7d20\u5728 <code>waitForPriorityQueue</code> \u4e2d\u6309\u7167\u65f6\u95f4\u4ece\u6548\u5230\u5927\u6392\u5e8f\uff0c\u8fd9\u6837\u5ef6\u65f6\u961f\u5217\u7684\u5904\u7406\u5c31\u4f1a\u65b9\u4fbf\u5f88\u591a\u4e86\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u6765\u770b\u4e0b\u5ef6\u65f6\u961f\u5217\u7684\u5b9e\u73b0\uff0c\u7531\u4e8e\u5ef6\u65f6\u961f\u5217\u5305\u88c5\u4e86\u901a\u7528\u961f\u5217\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u67e5\u770b\u65b0\u589e\u7684\u5b9e\u73b0\u5ef6\u65f6\u7684\u51fd\u6570\u5373\u53ef\uff1a</p> <pre><code>// client-go/util/workqueue/delaying_queue.go\n// AddAfter \u5728\u7ed9\u5b9a\u7684\u5ef6\u65f6\u65f6\u95f4\u540e\u6dfb\u52a0\u5143\u7d20\u5230 workqueue \u961f\u5217\u4e0a\nfunc (q *delayingType) AddAfter(item interface{}, duration time.Duration) {\n    // \u5982\u679c\u5df2\u7ecf\u5173\u95ed\u5219\u76f4\u63a5\u8fd4\u56de\n    if q.ShuttingDown() {\n        return\n    }\n    // \u8bb0\u5f55 metrics\n    q.metrics.retry()\n    q.deprecatedMetrics.retry()\n\n    // \u4e0d\u9700\u8981\u5ef6\u8fdf\uff0c\u90a3\u5c31\u76f4\u63a5\u6dfb\u52a0\n    if duration &lt;= 0 {\n        q.Add(item)\n        return\n    }\n\n    // \u628a\u5143\u7d20\u5c01\u88c5\u6210 waitFor \u4f20\u5165 channel\uff0c\u7531\u4e8e select \u6ca1\u6709default\uff0c\u6240\u4ee5\u88ab\u963b\u585e\n    // \u8fd9\u91cc\u4f7f\u7528 stopCh\uff0c\u56e0\u4e3a\u6709\u963b\u585e\u7684\u53ef\u80fd\uff0c\u6240\u4ee5\u7528 stopChn \u53ef\u4ee5\u4fdd\u8bc1\u9000\u51fa\n    select {\n    case &lt;-q.stopCh:\n        // \u5982\u679c ShutDown() \u88ab\u8c03\u7528\uff0c\u5219\u9000\u51fa\n    case q.waitingForAddCh &lt;- &amp;waitFor{data: item, readyAt: q.clock.Now().Add(duration)}:\n    }\n}\n</code></pre> <p><code>AddAfter()</code> \u5c31\u662f\u7b80\u5355\u628a\u5143\u7d20\u9001\u5230 channel \u4e2d\uff0c\u6240\u4ee5\u6838\u5fc3\u5b9e\u73b0\u662f\u4ece channel \u4e2d\u83b7\u53d6\u6570\u636e\u7684\u90e8\u5206\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/delaying_queue.go\n// waitingLoop \u4e00\u76f4\u8fd0\u884c\u76f4\u5230 workqueue \u5173\u95ed\u4e86\u5e76\u68c0\u67e5\u8981\u6dfb\u52a0\u7684\u5143\u7d20\u5217\u8868\nfunc (q *delayingType) waitingLoop() {\n    defer utilruntime.HandleCrash()\n\n    // \u5f53\u6ca1\u6709\u5143\u7d20\u9700\u8981\u5ef6\u65f6\u6dfb\u52a0\u7684\u65f6\u5019\u5229\u7528\u8fd9\u4e2a\u53d8\u91cf\u5b9e\u73b0\u957f\u65f6\u95f4\u7b49\u5f85\n    never := make(&lt;-chan time.Time)\n    // \u521d\u59cb\u5316\u4e0a\u9762\u7684\u6709\u5e8f\u961f\u5217\n    waitingForQueue := &amp;waitForPriorityQueue{}\n    heap.Init(waitingForQueue)\n    // \u8fd9\u4e2amap\u7528\u6765\u907f\u514d\u91cd\u590d\u6dfb\u52a0\uff0c\u5982\u679c\u91cd\u590d\u6dfb\u52a0\u5219\u53ea\u66f4\u65b0\u65f6\u95f4\u5373\u53ef\n    waitingEntryByData := map[t]*waitFor{}\n    // \u5f00\u59cb\u6b7b\u5faa\u73af\n    for {\n        // \u961f\u5217\u5173\u95ed\u4e86\u5219\u76f4\u63a5\u8fd4\u56de\n        if q.Interface.ShuttingDown() {\n            return\n        }\n        // \u83b7\u53d6\u5f53\u524d\u65f6\u95f4\n        now := q.clock.Now()\n\n        // \u5224\u65ad\u6709\u5e8f\u961f\u5217\u4e2d\u662f\u5426\u6709\u5143\u7d20\n        for waitingForQueue.Len() &gt; 0 {\n            // \u83b7\u5f97\u6709\u5e8f\u961f\u5217\u4e2d\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\n            entry := waitingForQueue.Peek().(*waitFor)\n            // \u5143\u7d20\u6307\u5b9a\u7684\u65f6\u95f4\u662f\u5426\u8fc7\u4e86\uff1f\u6ca1\u6709\u7684\u8bdd\u5c31\u8df3\u51fa\u5faa\u73af\n            if entry.readyAt.After(now) {\n                break\n            }\n            // \u5982\u679c\u65f6\u95f4\u5df2\u7ecf\u8fc7\u4e86\uff0c\u90a3\u5c31\u4ece\u6709\u5e8f\u961f\u5217\u4e2d\u62ff\u51fa\u6765\u653e\u5165\u901a\u7528\u961f\u5217\u4e2d\n            // heap.Pop()\u5c06\u7b2c\u4e00\u5143\u7d20\u548c\u6700\u540e\u4e00\u4e2a\u5143\u7d20\u4ea4\u6362\uff0c\u7136\u540e\u91cd\u65b0\u8c03\u7528down\u4e0b\u6c89\u51fd\u6570\uff0c\u4fdd\u8bc1\u662f\u4e00\u4e2a\u6700\u5c0f\u5806\uff0c\u7136\u540e\u8c03\u7528 waitingForQueue.Pop() \u5f39\u51fa\u6700\u540e\u4e00\u4e2a\u5143\u7d20(\u5b9e\u9645\u4e0a\u662f\u7b2c\u4e00\u4e2a\u5143\u7d20)\n            // \u4ece\u6709\u5e8f\u961f\u5217\u628a\u5143\u7d20\u5f39\u51fa\uff0c\u540c\u65f6\u8981\u628a\u5143\u7d20\u4ece\u4e0a\u9762\u7684\u907f\u514d\u91cd\u590d\u7684map\u4e2d\u5220\u9664\n            entry = heap.Pop(waitingForQueue).(*waitFor)\n            q.Add(entry.data)\n            delete(waitingEntryByData, entry.data)\n        }\n\n        // \u5982\u679c\u6709\u5e8f\u961f\u5217\u4e2d\u6ca1\u6709\u5143\u7d20\uff0c\u90a3\u5c31\u4e0d\u7528\u7b49\u5f85\u4e86\uff0c\u4e5f\u5c31\u662f\u6c38\u4e45\u7b49\u4e0b\u53bb\n        // \u5982\u679c\u6709\u5e8f\u961f\u5217\u4e2d\u6709\u5143\u7d20\uff0c\u90a3\u5c31\u7528\u7b2c\u4e00\u4e2a\u5143\u7d20\u6307\u5b9a\u7684\u65f6\u95f4\u51cf\u53bb\u5f53\u524d\u65f6\u95f4\u4f5c\u4e3a\u7b49\u5f85\u65f6\u95f4\n        // \u6709\u5e8f\u961f\u5217\u7528\u65f6\u95f4\u6392\u5e8f\uff0c\u540e\u9762\u7684\u5143\u7d20\u9700\u8981\u7b49\u5f85\u7684\u65f6\u95f4\u66f4\u957f\uff0c\u6240\u4ee5\u5148\u5904\u7406\u6392\u5e8f\u9760\u524d\u7684\u5143\u7d20\n        nextReadyAt := never  \n        if waitingForQueue.Len() &gt; 0 {\n            entry := waitingForQueue.Peek().(*waitFor)\n            // \u5143\u7d20\u6267\u884c\u7684\u65f6\u95f4\n            nextReadyAt = q.clock.After(entry.readyAt.Sub(now))\n        }\n        // \u8fdb\u5165\u5404\u79cd\u7b49\u5f85\n        select {\n        // \u9000\u51fa\u4fe1\u53f7\n        case &lt;-q.stopCh:\n            return\n        // \u5b9a\u65f6\u5668\uff0cticker\uff0c\u6bcf\u9694\u4e00\u6bb5\u65f6\u95f4\u63a5\u6536\u4e00\u4e2aticker\uff0c\u91cd\u65b0\u6267\u884c\u4e00\u6b21\u5927\u5faa\u73af\uff0c\u5426\u5219select\u5c31hang\u4f4f\u4e86\n        case &lt;-q.heartbeat.C():  // \u7ee7\u7eed\u5faa\u73af\uff0c\u5c06\u6dfb\u52a0\u51c6\u5907\u597d\u7684\u5143\u7d20\n        // \u8fd9\u4e2a\u5c31\u662f\u6709\u5e8f\u961f\u5217\u91cc\u9762\u9700\u8981\u7b49\u5f85\u65f6\u95f4\u7684\u4fe1\u53f7\uff0c\u65f6\u95f4\u5230\u5c31\u4f1a\u6709\u4fe1\u53f7\n        case &lt;-nextReadyAt:  // \u7ee7\u7eed\u5faa\u73af\uff0c\u5c06\u6dfb\u52a0\u51c6\u5907\u597d\u7684\u5143\u7d20\n        // \u8fd9\u91cc\u662f\u4ecechannel\u4e2d\u83b7\u53d6\u5143\u7d20\uff0cAddAfter()\u653e\u5165\u5230channel\u4e2d\u7684\u5143\u7d20\n        case waitEntry := &lt;-q.waitingForAddCh:\n            // \u65f6\u95f4\u6ca1\u6709\u8fc7\u5c31\u63d2\u5165\u5230\u6709\u5e8f\u961f\u5217\u4e2d\n            if waitEntry.readyAt.After(q.clock.Now()) {\n                insert(waitingForQueue, waitingEntryByData, waitEntry)\n            } else {\n                // \u5982\u679c\u65f6\u95f4\u5df2\u7ecf\u8fc7\u4e86\u5c31\u76f4\u63a5\u653e\u5165\u901a\u7528\u961f\u5217\n                q.Add(waitEntry.data)\n            }\n            // \u7531\u4e8e\u961f\u5217\u4e2d\u4e00\u6b21\u6027\u53ef\u80fd\u4f1a\u6dfb\u52a0\u591a\u4e2a\u5143\u7d20\uff0c\u5728\u4e0a\u9762\u6267\u884c\u4ee3\u7801\u7684\u671f\u95f4\u53ef\u80fd channel \u6570\u636e\u79ef\u538b\u4e86\uff0c\u5982\u679c\u5168\u90fd\u4ece\u4e0b\u4e00\u6b21\u5faa\u73af\u6765\u5904\u7406\uff0c\u9700\u8981\u6d88\u8017\u7684\u65f6\u95f4\u592a\u957f\u4e86\uff0c\u6240\u4ee5\u8fd9\u91cc\u518d\u7528\u4e00\u4e2a\u5faa\u73af\u6765\u628a\u5f53\u524d channel \u4e2d\u7684\u6570\u636e\u5168\u90e8\u53d6\u51fa\u6765\uff0c\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u8fd9\u91cc\u7528\u4e86 default\uff0c\u610f\u5473\u7740 channel \u4e2d\u6ca1\u6709\u6570\u636e\u5c31\u4f1a\u7acb\u523b\u505c\u6b62\n            drained := false\n            for !drained {\n                select {\n                case waitEntry := &lt;-q.waitingForAddCh:\n                    if waitEntry.readyAt.After(q.clock.Now()) {\n                        insert(waitingForQueue, waitingEntryByData, waitEntry)\n                    } else {\n                        q.Add(waitEntry.data)\n                    }\n                default:\n                    drained = true\n                }\n            }\n        }\n    }\n}\n</code></pre> <p>\u5176\u4e2d\u63d2\u5165\u5143\u7d20\u5230\u6709\u5e8f\u961f\u5217\u7684\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/delaying_queue.go\n// insert \u6dfb\u52a0\u5143\u7d20\u5230\u4f18\u5148\u7ea7\u961f\u5217\u4e2d\uff0c\u5982\u679c\u5df2\u7ecf\u5b58\u5728\u961f\u5217\u4e2d\u4e86\u5219\u66f4\u65b0 readyAt \u65f6\u95f4\nfunc insert(q *waitForPriorityQueue, knownEntries map[t]*waitFor, entry *waitFor) {\n    // \u5982\u679c\u5143\u7d20\u5df2\u7ecf\u5b58\u5728\uff0c\u5f53\u65f6\u95f4\u4f1a\u5bfc\u81f4\u5143\u7d20\u66f4\u5feb\u6392\u961f\u65f6\u5219\u66f4\u65b0\u65f6\u95f4\n    existing, exists := knownEntries[entry.data]\n    if exists {\n        // \u6267\u884c\u65f6\u95f4\u66f4\u65e9\u4e86\u5219\u66f4\u65b0 readyAt \u65f6\u95f4\n        if existing.readyAt.After(entry.readyAt) {\n            existing.readyAt = entry.readyAt\n            heap.Fix(q, existing.index)\n        }\n        return\n    }\n    // \u628a\u5143\u7d20\u653e\u5165\u6709\u5e8f\u961f\u5217\u4e2d\uff0c\u5e76\u8bb0\u5f55\u5728map\u91cc\u9762,\u8fd9\u4e2amap\u5c31\u662f\u4e0a\u9762\u7528\u4e8e\u5224\u65ad\u5bf9\u8c61\u662f\u5426\u91cd\u590d\u6dfb\u52a0\u7684map\n    // \u6ce8\u610f\uff0c\u8fd9\u91cc\u9762\u8c03\u7528\u7684\u662f heap.Push\uff0c\u4e0d\u662f waitForPriorityQueue.Push\n    heap.Push(q, entry)\n    knownEntries[entry.data] = entry\n}\n</code></pre> <p>\u5230\u8fd9\u91cc\u5c31\u5b9e\u73b0\u4e86\u5ef6\u65f6\u961f\u5217\u7684\u6838\u5fc3\u529f\u80fd\uff0c\u6700\u4e3b\u8981\u7684\u8fd8\u662f\u4f7f\u7528 golang \u4e2d\u7684 <code>heap</code>\uff0c\u7528\u5806\u6765\u5b9e\u73b0\u4e86\u5143\u7d20\u6309\u65f6\u95f4\u5148\u540e\u8fdb\u884c\u6392\u5e8f\uff0c\u8fd9\u6837\u5ef6\u65f6\u961f\u5217\u5c31\u53ef\u4ee5\u4e00\u4e2a\u4e00\u4e2a\u7684\u7b49\u5f85\u8d85\u65f6\u6dfb\u52a0\u4e86\u3002</p>"},{"location":"kubernetes_code/client_go/workqueue/#_3","title":"\u9650\u901f\u961f\u5217","text":"<p>\u9650\u901f\u961f\u5217\u5e94\u7528\u5f97\u975e\u5e38\u5e7f\u6cdb\uff0c\u6bd4\u5982\u5728\u6211\u4eec\u505a\u4e00\u4e9b\u64cd\u4f5c\u5931\u8d25\u540e\u5e0c\u671b\u91cd\u8bd5\u51e0\u6b21\uff0c\u4f46\u662f\u7acb\u523b\u91cd\u8bd5\u5f88\u6709\u53ef\u80fd\u8fd8\u662f\u4f1a\u5931\u8d25\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u5ef6\u8fdf\u4e00\u6bb5\u65f6\u95f4\u518d\u91cd\u8bd5\uff0c\u800c\u4e14\u5931\u8d25\u6b21\u6570\u8d8a\u591a\u5ef6\u8fdf\u65f6\u95f4\u8d8a\u957f\uff0c\u8fd9\u4e2a\u5176\u5b9e\u5c31\u662f\u9650\u901f\u3002\u9996\u5148\u6211\u4eec\u9700\u8981\u6765\u4e86\u89e3\u4e0b<code>\u9650\u901f\u5668</code>\u3002</p>"},{"location":"kubernetes_code/client_go/workqueue/#_4","title":"\u9650\u901f\u5668","text":"<p>\u9650\u901f\u5668\u662f client-go \u4e2d\u7684\u4e00\u79cd\u62bd\u8c61\uff0c\u5177\u4f53\u5b9e\u73b0\u53ef\u4ee5\u6709\u5f88\u591a\u79cd\uff0c\u6bd4\u5982\u6bd4\u8f83\u6781\u7aef\u7684\u5c31\u662f\u4e0d\u9650\u5236\u4efb\u4f55\u901f\u5ea6\uff0c\u4e0b\u9762\u662f\u9650\u901f\u5668\u7684\u63a5\u53e3\u62bd\u8c61\u5b9a\u4e49\uff1a</p> <pre><code>// client-go/util/workqueue/default_rate_limiters.go\ntype RateLimiter interface {\n    When(item interface{}) time.Duration // \u83b7\u53d6item\u5143\u7d20\u5e94\u8be5\u7b49\u5f85\u591a\u957f\u65f6\u95f4\n    Forget(item interface{})  // \u8868\u793a\u5143\u7d20\u5df2\u7ecf\u5b8c\u6210\u4e86\u91cd\u8bd5\uff0c\u4e0d\u7ba1\u662f\u6210\u529f\u8fd8\u662f\u5931\u8d25\u90fd\u4f1a\u505c\u6b62\u8ddf\u8e2a\uff0c\u4e5f\u5c31\u662f\u629b\u5f03\u8be5\u5143\u7d20\n    NumRequeues(item interface{}) int  // \u8fd4\u56de\u5143\u7d20\u5931\u8d25\u7684\u6b21\u6570\uff08\u4e5f\u5c31\u662f\u653e\u5165\u961f\u5217\u7684\u6b21\u6570\uff09\n}\n</code></pre> <p>1.</p> <pre><code>ItemExponentialFailureRateLimiter\n</code></pre> <p>\u662f\u6bd4\u8f83\u5e38\u7528\u7684\u9650\u901f\u5668\uff0c\u4ed6\u4f1a\u6839\u636e\u5143\u7d20\u9519\u8bef\u6b21\u6570\u9010\u6e10\u7d2f\u52a0\u7b49\u5f85\u65f6\u95f4\uff0c\u5b9a\u4e49\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/default_rate_limiters.go\n// baseDelay*2^&lt;num-failures&gt; \ntype ItemExponentialFailureRateLimiter struct {\n    failuresLock sync.Mutex  // \u4e92\u65a5\u9501\n    failures     map[interface{}]int  // \u8bb0\u5f55\u6bcf\u4e2a\u5143\u7d20\u9519\u8bef\u6b21\u6570\uff0c\u6bcf\u8c03\u7528\u4e00\u6b21When\u7d2f\u52a0\u4e00\u6b21\n\n    baseDelay time.Duration  // \u5143\u7d20\u5ef6\u8fdf\u57fa\u6570\n    maxDelay  time.Duration  // \u5143\u7d20\u6700\u5927\u7684\u5ef6\u8fdf\u65f6\u95f4\n}\n\n// \u7528\u6765\u5224\u65ad\u8be5\u7ed3\u6784\u4f53\u662f\u5426\u5b9e\u73b0\u4e86 RateLimiter \u63a5\u53e3\uff0c\u7528\u4f5c\u7c7b\u578b\u65ad\u8a00\uff0c\u5982\u679c\u6ca1\u6709\u5b9e\u73b0\u63a5\u53e3 RateLimiter \u5219\u7f16\u8bd1\u9519\u8bef\u3002\n// \u4e3b\u8981\u662f\u4e3a\u4e86\u89e6\u53d1 interface \u7f16\u8bd1\u5668\u68c0\u67e5\uff0c\u770b\u4e2a\u4eba\u4e60\u60ef\uff0c\u662f\u5426\u5728\u8fd9\u4e2a\u5730\u65b9\u8fdb\u884c\u68c0\u67e5\nvar _ RateLimiter = &amp;ItemExponentialFailureRateLimiter{}\n</code></pre> <p>\u8be5\u9650\u901f\u5668\u5bf9\u5e94\u7684\u9650\u901f\u5668\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/default_rate_limiters.go\nfunc (r *ItemExponentialFailureRateLimiter) When(item interface{}) time.Duration {\n    r.failuresLock.Lock()\n    defer r.failuresLock.Unlock()\n    // \u7d2f\u52a0\u9519\u8bef\u6b21\u6570\n    exp := r.failures[item]\n    r.failures[item] = r.failures[item] + 1\n\n    // \u901a\u8fc7\u9519\u8bef\u6b21\u6570\u8ba1\u7b97\u5ef6\u8fdf\u65f6\u95f4\uff0c\u516c\u5f0f\u662f2^i * baseDelay\uff0c\u6309\u6307\u6570\u9012\u589e\n    backoff := float64(r.baseDelay.Nanoseconds()) * math.Pow(2, float64(exp))\n    // backoff \u662f\u6709\u4e0a\u9650\u7684\uff0c\u8fd9\u6837'calculated' \u503c\u4e0d\u4f1a\u6ea2\u51fa\n    if backoff &gt; math.MaxInt64 {\n        return r.maxDelay\n    }\n    // \u8ba1\u7b97\u540e\u7684\u5ef6\u8fdf\u503c\u548c\u6700\u5927\u5ef6\u8fdf\u503c\u4e8c\u8005\u53d6\u6700\u5c0f\u503c\n    calculated := time.Duration(backoff)\n    if calculated &gt; r.maxDelay {\n        return r.maxDelay\n    }\n    return calculated\n}\n\nfunc (r *ItemExponentialFailureRateLimiter) NumRequeues(item interface{}) int {\n    r.failuresLock.Lock()\n    defer r.failuresLock.Unlock()\n\n    return r.failures[item]\n}\n\nfunc (r *ItemExponentialFailureRateLimiter) Forget(item interface{}) {\n    r.failuresLock.Lock()\n    defer r.failuresLock.Unlock()\n\n    delete(r.failures, item)\n}\n</code></pre> <p>\u4f7f\u7528 </p> <pre><code>ItemExponentialFailureRateLimiter\n</code></pre> <p>\u9650\u901f\u5668\u4e00\u822c\u5c31\u662f\u64cd\u4f5c\u5931\u8d25\u540e\u53c8\u4e0d\u65ad\u5c1d\u8bd5\uff0c\u968f\u7740\u5c1d\u8bd5\u6b21\u6570\u7684\u589e\u52a0\u6309\u7167\u6307\u6570\u589e\u52a0\u5ef6\u8fdf\u65f6\u95f4\u3002</p> <p>2.</p> <pre><code>ItemFastSlowRateLimiter\n</code></pre> <p>\u548c\u4e0a\u9762\u7684\u6307\u6570\u7ea7\u9650\u901f\u5668\u5f88\u50cf\uff0c\u90fd\u662f\u7528\u4e8e\u9519\u8bef\u5c1d\u8bd5\u7684\uff0c\u4f46\u662f\u4e8c\u8005\u7684\u9650\u901f\u7b56\u7565\u4e0d\u540c\uff0c</p> <pre><code>ItemFastSlowRateLimiter\n</code></pre> <p>\u662f\u5c1d\u8bd5\u6b21\u6570\u8d85\u8fc7\u9608\u503c\u540e\u7528\u957f\u5ef6\u8fdf\uff0c\u5426\u5219\u7528\u77ed\u5ef6\u8fdf\uff0c\u5177\u4f53\u7684\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/default_rate_limiters.go\n// \u4ee5\u77ed\u5ef6\u8fdf\u91cd\u8bd5\uff0c\u8fbe\u5230\u9608\u503c\u540e\u5f00\u59cb\u7528\u957f\u5ef6\u8fdf\ntype ItemFastSlowRateLimiter struct {\n    failuresLock sync.Mutex  // \u4e92\u65a5\u9501\n    failures     map[interface{}]int  // \u9519\u8bef\u6b21\u6570\u8ba1\u6570\n\n    maxFastAttempts int  // \u9519\u8bef\u5c1d\u8bd5\u6b21\u6570\u9608\u503c\n    fastDelay       time.Duration  // \u77ed\u5ef6\u8fdf\u65f6\u95f4\n    slowDelay       time.Duration  // \u957f\u5ef6\u8fdf\u65f6\u95f4\n}\n</code></pre> <p>\u8be5\u9650\u901f\u5668\u5bf9\u5e94\u7684\u9650\u901f\u5668\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/default_rate_limiters.go\nfunc (r *ItemFastSlowRateLimiter) When(item interface{}) time.Duration {\n    r.failuresLock.Lock()\n    defer r.failuresLock.Unlock()\n    // \u9519\u8bef\u6b21\u6570+1\n    r.failures[item] = r.failures[item] + 1\n    // \u9519\u8bef\u6b21\u6570\u672a\u8d85\u9608\u503c\uff0c\u7528\u77ed\u5ef6\u8fdf\n    if r.failures[item] &lt;= r.maxFastAttempts {\n        return r.fastDelay\n    }\n    // \u9519\u8bef\u6b21\u6570\u8d85\u8fc7\u9608\u503c\uff0c\u7528\u957f\u5ef6\u8fdf\n    return r.slowDelay\n}\n\nfunc (r *ItemFastSlowRateLimiter) NumRequeues(item interface{}) int {\n    r.failuresLock.Lock()\n    defer r.failuresLock.Unlock()\n\n    return r.failures[item]\n}\n\nfunc (r *ItemFastSlowRateLimiter) Forget(item interface{}) {\n    r.failuresLock.Lock()\n    defer r.failuresLock.Unlock()\n\n    delete(r.failures, item)\n}\n</code></pre> <p>3.<code>MaxOfRateLimiter</code> \u9650\u901f\u5668\u5185\u90e8\u662f\u4e00\u4e2a\u9650\u901f\u5668 slice\uff0c\u6bcf\u6b21\u8fd4\u56de\u6240\u6709\u9650\u901f\u5668\u91cc\u9762\u5ef6\u8fdf\u6700\u5927\u7684\u4e00\u4e2a\u9650\u901f\u5668\uff0c\u5177\u4f53\u7684\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/default_rate_limiters.go\ntype MaxOfRateLimiter struct {\n    limiters []RateLimiter  // \u9650\u901f\u5668slice\n}\n</code></pre> <p>\u8be5\u9650\u901f\u5668\u5bf9\u5e94\u7684\u9650\u901f\u5668\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/default_rate_limiters.go\nfunc (r *MaxOfRateLimiter) When(item interface{}) time.Duration {\n    ret := time.Duration(0)\n    // \u83b7\u53d6\u6240\u6709\u9650\u901f\u5668\u91cc\u9762\u65f6\u95f4\u6700\u5927\u7684\n    for _, limiter := range r.limiters {\n        curr := limiter.When(item)\n        if curr &gt; ret {\n            ret = curr\n        }\n    }\n    return ret\n}\n\nfunc (r *MaxOfRateLimiter) NumRequeues(item interface{}) int {\n    ret := 0\n    // \u540c\u6837\u83b7\u53d6\u6240\u6709\u9650\u901f\u5668\u91cc\u9762\u6700\u5927\u7684 Requeue \u6b21\u6570\n    for _, limiter := range r.limiters {\n        curr := limiter.NumRequeues(item)\n        if curr &gt; ret {\n            ret = curr\n        }\n    }\n    return ret\n}\n\nfunc (r *MaxOfRateLimiter) Forget(item interface{}) {\n    // \u8c03\u7528\u6240\u6709\u7684\u9650\u901f\u5668\u7684 Forget \u65b9\u6cd5\n    for _, limiter := range r.limiters {\n        limiter.Forget(item)\n    }\n}\n</code></pre> <p>4.<code>BucketRateLimiter</code> \u9650\u901f\u5668\u662f\u5229\u7528 </p> <pre><code>golang.org/x/time/rate\n</code></pre> <p>\u5305\u4e2d\u7684 <code>Limiter</code> \u6765\u5b9e\u73b0\u7a33\u5b9a\u901f\u7387(<code>qps</code>)\u7684\u9650\u901f\u5668\uff0c\u5bf9\u5e94\u7684\u7ed3\u6784\u4f53\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/default_rate_limiters.go\n// \u6839\u636e workqueue ratelimiter API \u8c03\u6574\u6807\u51c6 bucket\ntype BucketRateLimiter struct {\n    *rate.Limiter\n}\n</code></pre> <p>\u8be5\u9650\u901f\u5668\u5bf9\u5e94\u7684\u9650\u901f\u5668\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/default_rate_limiters.go\n\nfunc (r *BucketRateLimiter) When(item interface{}) time.Duration {\n    // \u83b7\u53d6\u5ef6\u8fdf\u65f6\u95f4\uff0c\u8be5\u5ef6\u8fdf\u4f1a\u662f\u4e00\u4e2a\u76f8\u5bf9\u56fa\u5b9a\u7684\u5468\u671f\n    return r.Limiter.Reserve().Delay()\n}\n\nfunc (r *BucketRateLimiter) NumRequeues(item interface{}) int {\n    // \u56e0\u4e3a\u662f\u56fa\u5b9a\u9891\u7387\u7684\uff0c\u6240\u4ee5\u5c31\u4e0d\u5b58\u5728\u91cd\u8bd5\u4e86\n    return 0\n}\n\nfunc (r *BucketRateLimiter) Forget(item interface{}) {\n}\n</code></pre>"},{"location":"kubernetes_code/client_go/workqueue/#_5","title":"\u5b9e\u73b0","text":"<p>\u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86\u9ed8\u8ba4\u5b9e\u73b0\u7684\u51e0\u79cd\u9650\u901f\u5668\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u770b\u770b\u9650\u901f\u961f\u5217\u7684\u5b9e\u73b0\uff0c\u9650\u901f\u961f\u5217\u7684\u63a5\u53e3\u5b9a\u4e49\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/rate_limiting_queue.go\n// RateLimitingInterface \u5c06\u9650\u901f\u7684\u5143\u7d20\u6dfb\u52a0\u5230\u961f\u5217\u4e2d\u7684\u4e00\u4e2a\u63a5\u53e3\ntype RateLimitingInterface interface {\n    DelayingInterface  // \u7ee7\u627f\u4e86\u5ef6\u65f6\u961f\u5217\n\n    AddRateLimited(item interface{})  // \u6309\u7167\u9650\u901f\u65b9\u5f0f\u6dfb\u52a0\u5143\u7d20\n\n    Forget(item interface{})  // \u8868\u793a\u5df2\u7ecf\u91cd\u8bd5\u67d0\u5143\u7d20\uff0c\u4e22\u5f03\u6307\u5b9a\u7684\u5143\u7d20\uff0c\u8be5\u64cd\u4f5c\u53ea\u4f1a\u6e05\u9664`rateLimter`\uff0c\u4ecd\u7136\u5fc5\u987b\u5728\u961f\u5217\u4e0a\u8c03\u7528 Done\n\n    NumRequeues(item interface{}) int  // \u5143\u7d20\u653e\u5165\u961f\u5217\u7684\u6b21\u6570\n}\n\n// NewRateLimitingQueue \u6784\u9020\u4e00\u4e2a\u5e26\u6709\u9650\u901f\u80fd\u529b\u7684\u5de5\u4f5c\u961f\u5217\uff0c\u8981\u8bb0\u4f4f\u8c03\u7528 Forget\uff01\u5426\u5219\u53ef\u80fd\u4f1a\u4e00\u76f4\u8ddf\u8e2a\u5931\u8d25\u4e0b\u53bb\u3002\nfunc NewRateLimitingQueue(rateLimiter RateLimiter) RateLimitingInterface {\n    return &amp;rateLimitingType{\n        DelayingInterface: NewDelayingQueue(),  // \u6784\u9020\u4e00\u4e2a\u5ef6\u8fdf\u961f\u5217\n        rateLimiter:       rateLimiter,\n    }\n}\n</code></pre> <p>\u8be5\u9650\u901f\u5668\u63a5\u53e3\u5bf9\u5e94\u7684\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// client-go/util/workqueue/rate_limiting_queue.go\n// rateLimitingType wraps an Interface and provides rateLimited re-enquing\ntype rateLimitingType struct {\n    DelayingInterface  // \u7ee7\u627f\u5ef6\u8fdf\u961f\u5217\n\n    rateLimiter RateLimiter  // \u6dfb\u52a0\u4e00\u4e2a\u9650\u901f\u5668\n}\n\nfunc (q *rateLimitingType) AddRateLimited(item interface{}) {\n    // \u901a\u8fc7\u9650\u901f\u5668\u83b7\u53d6\u5143\u7d20\u5ef6\u65f6\u65f6\u95f4\uff0c\u7136\u540e\u52a0\u5165\u5230\u5ef6\u8fdf\u961f\u5217\u4e2d\u53bb\n    q.DelayingInterface.AddAfter(item, q.rateLimiter.When(item))\n}\n\nfunc (q *rateLimitingType) NumRequeues(item interface{}) int {\n    // \u83b7\u53d6\u9650\u901f\u5668\u4e2d\u5143\u7d20\u52a0\u4e0a\u961f\u5217\u7684\u6b21\u6570\n    return q.rateLimiter.NumRequeues(item)\n}\n\nfunc (q *rateLimitingType) Forget(item interface{}) {\n    // \u5df2\u7ecf\u91cd\u8bd5\u67d0\u5143\u7d20\uff0c\u4e22\u5f03\u6307\u5b9a\u7684\u5143\u7d20\n    q.rateLimiter.Forget(item)\n}\n</code></pre>"},{"location":"kubernetes_config/config_map/","title":"ConfigMap","text":""},{"location":"kubernetes_config/config_map/#configmap","title":"ConfigMap","text":"<p>\u53ef\u53d8\u914d\u7f6e\u7ba1\u7406</p> <p>\u524d\u9762\u6211\u4eec\u5b66\u4e60\u4e86\u4e00\u4e9b\u5e38\u7528\u7684\u8d44\u6e90\u5bf9\u8c61\u7684\u4f7f\u7528\uff0c\u4f46\u662f\u5355\u7eaf\u4f9d\u9760\u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\uff0c\u8fd8\u4e0d\u8db3\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u65e5\u5e38\u9700\u6c42\uff0c\u4e00\u4e2a\u91cd\u8981\u7684\u9700\u6c42\u5c31\u662f\u5e94\u7528\u7684\u914d\u7f6e\u7ba1\u7406\u3001\u654f\u611f\u4fe1\u606f\u7684\u5b58\u50a8\u548c\u4f7f\u7528\uff08\u5982\uff1a\u5bc6\u7801\u3001Token \u7b49\uff09\u3001\u5bb9\u5668\u8fd0\u884c\u8d44\u6e90\u7684\u914d\u7f6e\u3001\u5b89\u5168\u7ba1\u63a7\u3001\u8eab\u4efd\u8ba4\u8bc1\u7b49\u7b49\u3002</p> <p>\u5bf9\u4e8e\u5e94\u7528\u7684\u53ef\u53d8\u914d\u7f6e\u5728 Kubernetes \u4e2d\u662f\u901a\u8fc7\u4e00\u4e2a <code>ConfigMap</code> \u8d44\u6e90\u5bf9\u8c61\u6765\u5b9e\u73b0\u7684\uff0c\u6211\u4eec\u77e5\u9053\u8bb8\u591a\u5e94\u7528\u7ecf\u5e38\u4f1a\u6709\u4ece\u914d\u7f6e\u6587\u4ef6\u3001\u547d\u4ee4\u884c\u53c2\u6570\u6216\u8005\u73af\u5883\u53d8\u91cf\u4e2d\u8bfb\u53d6\u4e00\u4e9b\u914d\u7f6e\u4fe1\u606f\u7684\u9700\u6c42\uff0c\u8fd9\u4e9b\u914d\u7f6e\u4fe1\u606f\u6211\u4eec\u80af\u5b9a\u4e0d\u4f1a\u76f4\u63a5\u5199\u6b7b\u5230\u5e94\u7528\u7a0b\u5e8f\u4e2d\u53bb\u7684\uff0c\u6bd4\u5982\u4f60\u4e00\u4e2a\u5e94\u7528\u8fde\u63a5\u4e00\u4e2a redis \u670d\u52a1\uff0c\u4e0b\u4e00\u6b21\u60f3\u66f4\u6362\u4e00\u4e2a\u4e86\u7684\uff0c\u8fd8\u5f97\u91cd\u65b0\u53bb\u4fee\u6539\u4ee3\u7801\uff0c\u91cd\u65b0\u5236\u4f5c\u4e00\u4e2a\u955c\u50cf\uff0c\u8fd9\u80af\u5b9a\u662f\u4e0d\u53ef\u53d6\u7684\uff0c\u800c<code>ConfigMap</code> \u5c31\u7ed9\u6211\u4eec\u63d0\u4f9b\u4e86\u5411\u5bb9\u5668\u4e2d\u6ce8\u5165\u914d\u7f6e\u4fe1\u606f\u7684\u80fd\u529b\uff0c\u4e0d\u4ec5\u53ef\u4ee5\u7528\u6765\u4fdd\u5b58\u5355\u4e2a\u5c5e\u6027\uff0c\u8fd8\u53ef\u4ee5\u7528\u6765\u4fdd\u5b58\u6574\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u7528\u6765\u914d\u7f6e\u4e00\u4e2a redis \u670d\u52a1\u7684\u8bbf\u95ee\u5730\u5740\uff0c\u4e5f\u53ef\u4ee5\u7528\u6765\u4fdd\u5b58\u6574\u4e2a redis \u7684\u914d\u7f6e\u6587\u4ef6\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u4e86\u89e3\u4e0b <code>ConfigMap</code> \u8fd9\u79cd\u8d44\u6e90\u5bf9\u8c61\u7684\u4f7f\u7528\u65b9\u6cd5\u3002</p>"},{"location":"kubernetes_config/config_map/#_1","title":"\u521b\u5efa","text":"<p><code>ConfigMap</code> \u8d44\u6e90\u5bf9\u8c61\u4f7f\u7528 <code>key-value</code> \u5f62\u5f0f\u7684\u952e\u503c\u5bf9\u6765\u914d\u7f6e\u6570\u636e\uff0c\u8fd9\u4e9b\u6570\u636e\u53ef\u4ee5\u5728 Pod \u91cc\u9762\u4f7f\u7528\uff0c\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u6e05\u5355\uff1a</p> <pre><code>kind: ConfigMap\napiVersion: v1\nmetadata:\n  name: cm-demo\n  namespace: default\ndata:\n  data.1: hello\n  data.2: world\n  config: |\n    property.1=value-1\n    property.2=value-2\n    property.3=value-3\n</code></pre> <p>\u5176\u4e2d\u914d\u7f6e\u6570\u636e\u5728 <code>data</code> \u5c5e\u6027\u4e0b\u9762\u8fdb\u884c\u914d\u7f6e\uff0c\u524d\u4e24\u4e2a\u88ab\u7528\u6765\u4fdd\u5b58\u5355\u4e2a\u5c5e\u6027\uff0c\u540e\u9762\u4e00\u4e2a\u88ab\u7528\u6765\u4fdd\u5b58\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u3002</p> <p>\u5f53\u7136\u540c\u6837\u7684\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528</p> <pre><code>kubectl create -f xx.yaml\n</code></pre> <p>\u6765\u521b\u5efa\u4e0a\u9762\u7684 <code>ConfigMap</code> \u5bf9\u8c61\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u4e0d\u77e5\u9053\u600e\u4e48\u521b\u5efa <code>ConfigMap</code> \u7684\u8bdd\uff0c\u4e0d\u8981\u5fd8\u8bb0 kubectl \u662f\u6211\u4eec\u6700\u597d\u7684\u5e2e\u624b\uff0c\u53ef\u4ee5\u4f7f\u7528</p> <pre><code>kubectl create configmap -h\n</code></pre> <p>\u6765\u67e5\u770b\u5173\u4e8e\u521b\u5efa <code>ConfigMap</code> \u7684\u5e2e\u52a9\u4fe1\u606f\uff1a</p> <pre><code>Examples:\n  # Create a new configmap named my-config based on folder bar\n  kubectl create configmap my-config --from-file=path/to/bar\n  # Create a new configmap named my-config with specified keys instead of file basenames on disk\n  kubectl create configmap my-config --from-file=key1=/path/to/bar/filetxt --from-file=key2=/path/to/bar/filetxt\n  # Create a new configmap named my-config with key1=config1 and key2=config2\n  kubectl create configmap my-config --from-literal=key1=config1 --from-literal=key2=config2\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u53ef\u4ee5\u4ece\u4e00\u4e2a\u7ed9\u5b9a\u7684\u76ee\u5f55\u6765\u521b\u5efa\u4e00\u4e2a <code>ConfigMap</code> \u5bf9\u8c61\uff0c\u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a testcm \u7684\u76ee\u5f55\uff0c\u8be5\u76ee\u5f55\u4e0b\u9762\u5305\u542b\u4e00\u4e9b\u914d\u7f6e\u6587\u4ef6\uff0credis \u548c mysql \u7684\u8fde\u63a5\u4fe1\u606f\uff0c\u5982\u4e0b\uff1a</p> <pre><code>$ ls testcm\nredis.conf\nmysql.conf\n$ cat testcm/redis.conf\nhost=11\nport=6379\n$ cat testcm/mysql.conf\nhost=11\nport=3306\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>from-file</code> \u5173\u952e\u5b57\u6765\u521b\u5efa\u5305\u542b\u8fd9\u4e2a\u76ee\u5f55\u4e0b\u9762\u6240\u4ee5\u914d\u7f6e\u6587\u4ef6\u7684 <code>ConfigMap</code>\uff1a</p> <pre><code>$ kubectl create configmap cm-demo1 --from-file=testcm\nconfigmap \"cm-demo1\" created\n</code></pre> <p>\u5176\u4e2d <code>from-file</code> \u53c2\u6570\u6307\u5b9a\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u7684\u6240\u6709\u6587\u4ef6\u90fd\u4f1a\u88ab\u7528\u5728 <code>ConfigMap</code> \u91cc\u9762\u521b\u5efa\u4e00\u4e2a\u952e\u503c\u5bf9\uff0c\u952e\u7684\u540d\u5b57\u5c31\u662f\u6587\u4ef6\u540d\uff0c\u503c\u5c31\u662f\u6587\u4ef6\u7684\u5185\u5bb9\u3002\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u6765\u67e5\u770b <code>ConfigMap</code> \u5217\u8868\uff1a</p> <pre><code>$ kubectl get configmap\nNAME       DATA      AGE\ncm-demo1   2         17s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u521b\u5efa\u4e86\u4e00\u4e2a cm-demo1 \u7684 <code>ConfigMap</code> \u5bf9\u8c61\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528 <code>describe</code> \u547d\u4ee4\u67e5\u770b\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe configmap cm-demo1\nName:         cm-demo1\nNamespace:    default\nLabels:       &lt;none&gt;\nAnnotations:  &lt;none&gt;\n\nData\n====\nmysql.conf:\n----\nhost=11\nport=3306\n\nredis.conf:\n----\nhost=11\nport=6379\n\nEvents:  &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e24\u4e2a <code>key</code> \u662f testcm \u76ee\u5f55\u4e0b\u9762\u7684\u6587\u4ef6\u540d\u79f0\uff0c\u5bf9\u5e94\u7684 <code>value</code> \u503c\u5c31\u662f\u6587\u4ef6\u5185\u5bb9\uff0c\u8fd9\u91cc\u503c\u5f97\u6ce8\u610f\u7684\u662f\u5982\u679c\u6587\u4ef6\u91cc\u9762\u7684\u914d\u7f6e\u4fe1\u606f\u5f88\u5927\u7684\u8bdd\uff0c<code>describe</code> \u7684\u65f6\u5019\u53ef\u80fd\u4e0d\u4f1a\u663e\u793a\u5bf9\u5e94\u7684\u503c\uff0c\u8981\u67e5\u770b\u5b8c\u6574\u7684\u952e\u503c\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl get configmap cm-demo1 -o yaml\napiVersion: v1\ndata:\n  mysql.conf: |\n    host=11\n    port=3306\n  redis.conf: |\n    host=11\n    port=6379\nkind: ConfigMap\nmetadata:\n  creationTimestamp: 2018-06-14T16:24:36Z\n  name: cm-demo1\n  namespace: default\n  resourceVersion: \"3109975\"\n  selfLink: /api/v1/namespaces/default/configmaps/cm-demo1\n  uid: 6e0f4d82-6fef-11e8-a101-525400db4df7\n</code></pre> <p>\u9664\u4e86\u901a\u8fc7\u6587\u4ef6\u76ee\u5f55\u8fdb\u884c\u521b\u5efa\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528\u6307\u5b9a\u7684\u6587\u4ef6\u8fdb\u884c\u521b\u5efa <code>ConfigMap</code>\uff0c\u540c\u6837\u7684\uff0c\u4ee5\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u4e3a\u4f8b\uff0c\u6211\u4eec\u521b\u5efa\u4e00\u4e2a redis \u7684\u914d\u7f6e\u7684\u4e00\u4e2a\u5355\u72ec <code>ConfigMap</code> \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create configmap cm-demo2 --from-file=testcm/redis.conf\nconfigmap \"cm-demo2\" created\n$ kubectl get configmap cm-demo2 -o yaml\napiVersion: v1\ndata:\n  redis.conf: |\n    host=11\n    port=6379\nkind: ConfigMap\nmetadata:\n  creationTimestamp: 2018-06-14T16:34:29Z\n  name: cm-demo2\n  namespace: default\n  resourceVersion: \"3110758\"\n  selfLink: /api/v1/namespaces/default/configmaps/cm-demo2\n  uid: cf59675d-6ff0-11e8-a101-525400db4df7\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e00\u4e2a\u5173\u8054 redis.conf \u6587\u4ef6\u914d\u7f6e\u4fe1\u606f\u7684 <code>ConfigMap</code> \u5bf9\u8c61\u521b\u5efa\u6210\u529f\u4e86\uff0c\u53e6\u5916\u503c\u5f97\u6ce8\u610f\u7684\u662f <code>--from-file</code> \u8fd9\u4e2a\u53c2\u6570\u53ef\u4ee5\u4f7f\u7528\u591a\u6b21\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e24\u6b21\u5206\u522b\u6307\u5b9a redis.conf \u548c mysql.conf \u6587\u4ef6\uff0c\u5c31\u548c\u76f4\u63a5\u6307\u5b9a\u6574\u4e2a\u76ee\u5f55\u662f\u4e00\u6837\u7684\u6548\u679c\u4e86\u3002</p> <p>\u53e6\u5916\uff0c\u901a\u8fc7\u5e2e\u52a9\u6587\u6863\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u8fd8\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5b57\u7b26\u4e32\u8fdb\u884c\u521b\u5efa\uff0c\u901a\u8fc7 <code>--from-literal</code> \u53c2\u6570\u4f20\u9012\u914d\u7f6e\u4fe1\u606f\uff0c\u540c\u6837\u7684\uff0c\u8fd9\u4e2a\u53c2\u6570\u53ef\u4ee5\u4f7f\u7528\u591a\u6b21\uff0c\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl create configmap cm-demo3 --from-literal=db.host=localhost --from-literal=db.port=3306\nconfigmap \"cm-demo3\" created\n$ kubectl get configmap cm-demo3 -o yaml\napiVersion: v1\ndata:\n  db.host: localhost\n  db.port: \"3306\"\nkind: ConfigMap\nmetadata:\n  creationTimestamp: 2018-06-14T16:43:12Z\n  name: cm-demo3\n  namespace: default\n  resourceVersion: \"3111447\"\n  selfLink: /api/v1/namespaces/default/configmaps/cm-demo3\n  uid: 06eeec7e-6ff2-11e8-a101-525400db4df7\n</code></pre>"},{"location":"kubernetes_config/config_map/#_2","title":"\u4f7f\u7528","text":"<p><code>ConfigMap</code> \u521b\u5efa\u6210\u529f\u4e86\uff0c\u90a3\u4e48\u6211\u4eec\u5e94\u8be5\u600e\u4e48\u5728 Pod \u4e2d\u6765\u4f7f\u7528\u5462\uff1f\u6211\u4eec\u8bf4 <code>ConfigMap</code> \u8fd9\u4e9b\u914d\u7f6e\u6570\u636e\u53ef\u4ee5\u901a\u8fc7\u5f88\u591a\u79cd\u65b9\u5f0f\u5728 Pod \u91cc\u4f7f\u7528\uff0c\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u79cd\u65b9\u5f0f\uff1a</p> <ul> <li>\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\u7684\u503c</li> <li>\u5728\u5bb9\u5668\u91cc\u8bbe\u7f6e\u547d\u4ee4\u884c\u53c2\u6570</li> <li>\u5728\u6570\u636e\u5377\u91cc\u9762\u6302\u8f7d\u914d\u7f6e\u6587\u4ef6</li> </ul> <p>\u9996\u5148\uff0c\u6211\u4eec\u4f7f\u7528 <code>ConfigMap</code> \u6765\u586b\u5145\u6211\u4eec\u7684\u73af\u5883\u53d8\u91cf\uff0c\u5982\u4e0b\u6240\u793a\u7684 Pod \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: testcm1-pod\nspec:\n  containers:\n    - name: testcm1\n      image: busybox\n      command: [ \"/bin/sh\", \"-c\", \"env\" ]\n      env:\n        - name: DB_HOST\n          valueFrom:\n            configMapKeyRef:\n              name: cm-demo3\n              key: db.host\n        - name: DB_PORT\n          valueFrom:\n            configMapKeyRef:\n              name: cm-demo3\n              key: db.port\n      envFrom:\n        - configMapRef:\n            name: cm-demo1\n</code></pre> <p>\u8fd9\u4e2a Pod \u8fd0\u884c\u540e\u4f1a\u8f93\u51fa\u5982\u4e0b\u6240\u793a\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl logs testcm1-pod\n......\nDB_HOST=localhost\nDB_PORT=3306\nmysql.conf=host=11\nport=3306\nredis.conf=host=11\nport=6379\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 DB_HOST \u548c DB_PORT \u90fd\u5df2\u7ecf\u6b63\u5e38\u8f93\u51fa\u4e86\uff0c\u53e6\u5916\u7684\u73af\u5883\u53d8\u91cf\u662f\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u76f4\u63a5\u628a cm-demo1 \u7ed9\u6ce8\u5165\u8fdb\u6765\u4e86\uff0c\u6240\u4ee5\u628a\u4ed6\u4eec\u7684\u6574\u4e2a\u952e\u503c\u7ed9\u8f93\u51fa\u51fa\u6765\u4e86\uff0c\u8fd9\u4e5f\u662f\u7b26\u5408\u9884\u671f\u7684\u3002</p> <p>\u53e6\u5916\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>ConfigMap</code>\u6765\u8bbe\u7f6e\u547d\u4ee4\u884c\u53c2\u6570\uff0c<code>ConfigMap</code> \u4e5f\u53ef\u4ee5\u88ab\u7528\u6765\u8bbe\u7f6e\u5bb9\u5668\u4e2d\u7684\u547d\u4ee4\u6216\u8005\u53c2\u6570\u503c\uff0c\u5982\u4e0b Pod:</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: testcm2-pod\nspec:\n  containers:\n    - name: testcm2\n      image: busybox\n      command: [ \"/bin/sh\", \"-c\", \"echo $(DB_HOST) $(DB_PORT)\" ]\n      env:\n        - name: DB_HOST\n          valueFrom:\n            configMapKeyRef:\n              name: cm-demo3\n              key: db.host\n        - name: DB_PORT\n          valueFrom:\n            configMapKeyRef:\n              name: cm-demo3\n              key: db.port\n</code></pre> <p>\u8fd0\u884c\u8fd9\u4e2a Pod \u540e\u4f1a\u8f93\u51fa\u5982\u4e0b\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl logs testcm2-pod\nlocalhost 3306\n</code></pre> <p>\u53e6\u5916\u4e00\u79cd\u662f\u975e\u5e38\u5e38\u89c1\u7684\u4f7f\u7528 <code>ConfigMap</code> \u7684\u65b9\u5f0f\uff1a\u901a\u8fc7<code>\u6570\u636e\u5377</code>\u4f7f\u7528\uff0c\u5728\u6570\u636e\u5377\u91cc\u9762\u4f7f\u7528 ConfigMap\uff0c\u5c31\u662f\u5c06\u6587\u4ef6\u586b\u5165\u6570\u636e\u5377\uff0c\u5728\u8fd9\u4e2a\u6587\u4ef6\u4e2d\uff0c\u952e\u5c31\u662f\u6587\u4ef6\u540d\uff0c\u952e\u503c\u5c31\u662f\u6587\u4ef6\u5185\u5bb9\uff0c\u5982\u4e0b\u8d44\u6e90\u5bf9\u8c61\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: testcm3-pod\nspec:\n  volumes:\n    - name: config-volume\n      configMap:\n        name: cm-demo2\n  containers:\n    - name: testcm3\n      image: busybox\n      command: [ \"/bin/sh\", \"-c\", \"cat /etc/config/redis.conf\" ]\n      volumeMounts:\n      - name: config-volume\n        mountPath: /etc/config\n</code></pre> <p>\u8fd0\u884c\u8fd9\u4e2a Pod \u7684\uff0c\u67e5\u770b\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs testcm3-pod\nhost=11\nport=6379\n</code></pre> <p>\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728 <code>ConfigMap</code> \u503c\u88ab\u6620\u5c04\u7684\u6570\u636e\u5377\u91cc\u53bb\u63a7\u5236\u8def\u5f84\uff0c\u5982\u4e0b Pod \u5b9a\u4e49\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: testcm4-pod\nspec:\n  volumes:\n    - name: config-volume\n      configMap:\n        name: cm-demo1\n        items:\n        - key: mysql.conf\n          path: path/to/msyql.conf\n  containers:\n    - name: testcm4\n      image: busybox\n      command: [ \"/bin/sh\",\"-c\",\"cat /etc/config/path/to/msyql.conf\" ]\n      volumeMounts:\n      - name: config-volume\n        mountPath: /etc/config\n</code></pre> <p>\u8fd0\u884c\u8fd9\u4e2aPod\u7684\uff0c\u67e5\u770b\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs testcm4-pod\nhost=11\nport=3306\n</code></pre> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5f53 <code>ConfigMap</code> \u4ee5\u6570\u636e\u5377\u7684\u5f62\u5f0f\u6302\u8f7d\u8fdb <code>Pod</code> \u7684\u65f6\uff0c\u8fd9\u65f6\u66f4\u65b0 </p> <pre><code>ConfigMap\uff08\u6216\u5220\u6389\u91cd\u5efaConfigMap\uff09\n</code></pre> <p>\uff0cPod \u5185\u6302\u8f7d\u7684\u914d\u7f6e\u4fe1\u606f\u4f1a\u70ed\u66f4\u65b0\u3002\u8fd9\u65f6\u53ef\u4ee5\u589e\u52a0\u4e00\u4e9b\u76d1\u6d4b\u914d\u7f6e\u6587\u4ef6\u53d8\u66f4\u7684\u811a\u672c\uff0c\u7136\u540e\u91cd\u52a0\u8f7d\u5bf9\u5e94\u670d\u52a1\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5e94\u7528\u7684\u70ed\u66f4\u65b0\u3002</p> <p>\u4f7f\u7528\u6ce8\u610f</p> <p>\u53ea\u6709\u901a\u8fc7 Kubernetes API \u521b\u5efa\u7684 Pod \u624d\u80fd\u4f7f\u7528 <code>ConfigMap</code>\uff0c\u5176\u4ed6\u65b9\u5f0f\u521b\u5efa\u7684\uff08\u6bd4\u5982\u9759\u6001 Pod\uff09\u4e0d\u80fd\u4f7f\u7528\uff1bConfigMap \u6587\u4ef6\u5927\u5c0f\u9650\u5236\u4e3a <code>1MB</code>\uff08ETCD \u7684\u8981\u6c42\uff09\u3002</p>"},{"location":"kubernetes_config/secret/","title":"Secret","text":""},{"location":"kubernetes_config/secret/#secret","title":"Secret","text":"<p>\u654f\u611f\u4fe1\u606f\u914d\u7f6e\u7ba1\u7406</p> <p>\u524d\u6587\u6211\u4eec\u5b66\u4e60 <code>ConfigMap</code> \u7684\u65f6\u5019\uff0c\u6211\u4eec\u8bf4 <code>ConfigMap</code> \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u662f Kubernetes \u5f53\u4e2d\u975e\u5e38\u91cd\u8981\u7684\u4e00\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b ConfigMap \u662f\u7528\u6765\u5b58\u50a8\u4e00\u4e9b\u975e\u5b89\u5168\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u5982\u679c\u6d89\u53ca\u5230\u4e00\u4e9b\u5b89\u5168\u76f8\u5173\u7684\u6570\u636e\u7684\u8bdd\u7528 ConfigMap \u5c31\u975e\u5e38\u4e0d\u59a5\u4e86\uff0c\u56e0\u4e3aConfigMa \u662f\u660e\u6587\u5b58\u50a8\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u7528\u5230\u53e6\u5916\u4e00\u4e2a\u8d44\u6e90\u5bf9\u8c61\u4e86\uff1a<code>Secret</code>\uff0c<code>Secret</code>\u7528\u6765\u4fdd\u5b58\u654f\u611f\u4fe1\u606f\uff0c\u4f8b\u5982\u5bc6\u7801\u3001OAuth \u4ee4\u724c\u548c ssh key \u7b49\u7b49\uff0c\u5c06\u8fd9\u4e9b\u4fe1\u606f\u653e\u5728 <code>Secret</code> \u4e2d\u6bd4\u653e\u5728 Pod \u7684\u5b9a\u4e49\u4e2d\u6216\u8005 Docker \u955c\u50cf\u4e2d\u8981\u66f4\u52a0\u5b89\u5168\u548c\u7075\u6d3b\u3002</p> <p><code>Secret</code> \u4e3b\u8981\u4f7f\u7528\u7684\u6709\u4ee5\u4e0b\u4e09\u79cd\u7c7b\u578b\uff1a</p> <ul> <li><code>Opaque</code>\uff1abase64 \u7f16\u7801\u683c\u5f0f\u7684 Secret\uff0c\u7528\u6765\u5b58\u50a8\u5bc6\u7801\u3001\u5bc6\u94a5\u7b49\uff1b\u4f46\u6570\u636e\u4e5f\u53ef\u4ee5\u901a\u8fc7<code>base64 \u2013decode</code>\u89e3\u7801\u5f97\u5230\u539f\u59cb\u6570\u636e\uff0c\u6240\u6709\u52a0\u5bc6\u6027\u5f88\u5f31\u3002</li> <li> <p><code>kubernetes.io/dockerconfigjson</code></p> <p>\uff1a\u7528\u6765\u5b58\u50a8\u79c1\u6709<code>docker registry</code>\u7684\u8ba4\u8bc1\u4fe1\u606f\u3002 *   <code>kubernetes.io/service-account-token <pre><code>\uff1a\u7528\u4e8e\u88ab `ServiceAccount` ServiceAccount \u521b\u5efa\u65f6 Kubernetes \u4f1a\u9ed8\u8ba4\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 Secret \u5bf9\u8c61\u3002Pod \u5982\u679c\u4f7f\u7528\u4e86 ServiceAccount\uff0c\u5bf9\u5e94\u7684 Secret \u4f1a\u81ea\u52a8\u6302\u8f7d\u5230 Pod \u76ee\u5f55 \n</code></pre> /run/secrets/kubernetes.io/serviceaccount</code></p> <p>\u4e2d\u3002 *   <code>bootstrap.kubernetes.io/token</code></p> <p>\uff1a\u7528\u4e8e\u8282\u70b9\u63a5\u5165\u96c6\u7fa4\u7684\u6821\u9a8c\u7684 Secret</p> </li> </ul>"},{"location":"kubernetes_config/secret/#opaque_secret","title":"Opaque Secret","text":"<p><code>Opaque</code> \u7c7b\u578b\u7684\u6570\u636e\u662f\u4e00\u4e2a map \u7c7b\u578b\uff0c\u8981\u6c42 value \u5fc5\u987b\u662f <code>base64</code> \u7f16\u7801\u683c\u5f0f\uff0c\u6bd4\u5982\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a\u7528\u6237\u540d\u4e3a admin\uff0c\u5bc6\u7801\u4e3a admin321 \u7684 <code>Secret</code> \u5bf9\u8c61\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u5148\u628a\u7528\u6237\u540d\u548c\u5bc6\u7801\u505a <code>base64</code> \u7f16\u7801\uff1a</p> <pre><code>$ echo -n \"admin\" | base64\nYWRtaW4=\n$ echo -n \"admin321\" | base64\nYWRtaW4zMjE=\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528\u4e0a\u9762\u7f16\u7801\u8fc7\u540e\u7684\u6570\u636e\u6765\u7f16\u5199\u4e00\u4e2a YAML \u6587\u4ef6\uff1a(secret-demo.yaml)</p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: mysecret\ntype: Opaque\ndata:\n  username: YWRtaW4=\n  password: YWRtaW4zMjE=\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 kubectl \u547d\u4ee4\u6765\u521b\u5efa\u4e86\uff1a</p> <pre><code>$ kubectl create -f secret-demo.yaml\nsecret \"mysecret\" created\n</code></pre> <p>\u5229\u7528<code>get secret</code>\u547d\u4ee4\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get secret\nNAME                  TYPE                                  DATA      AGE\ndefault-token-n9w2d   kubernetes.io/service-account-token   3         33d\nmysecret              Opaque                                2         40s\n</code></pre> <p>\u5176\u4e2d default-token-n9w2d \u4e3a\u521b\u5efa\u96c6\u7fa4\u65f6\u9ed8\u8ba4\u521b\u5efa\u7684 Secret\uff0c\u88ab </p> <pre><code>serviceacount/default\n</code></pre> <p>\u5f15\u7528\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>describe</code> \u547d\u4ee4\u67e5\u770b\u8be6\u60c5\uff1a</p> <pre><code>$ kubectl describe secret mysecret\nName:         mysecret\nNamespace:    default\nLabels:       &lt;none&gt;\nAnnotations:  &lt;none&gt;\n\nType:  Opaque\n\nData\n====\npassword:  8 bytes\nusername:  5 bytes\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5229\u7528 describe \u547d\u4ee4\u67e5\u770b\u5230\u7684 Data \u6ca1\u6709\u76f4\u63a5\u663e\u793a\u51fa\u6765\uff0c\u5982\u679c\u60f3\u770b\u5230 Data \u91cc\u9762\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u8f93\u51fa\u6210YAML \u6587\u4ef6\u8fdb\u884c\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get secret mysecret -o yaml\napiVersion: v1\ndata:\n  password: YWRtaW4zMjE=\n  username: YWRtaW4=\nkind: Secret\nmetadata:\n  creationTimestamp: 2018-06-19T15:27:06Z\n  name: mysecret\n  namespace: default\n  resourceVersion: \"3694084\"\n  selfLink: /api/v1/namespaces/default/secrets/mysecret\n  uid: 39c139f5-73d5-11e8-a101-525400db4df7\ntype: Opaque\n</code></pre> <p>\u521b\u5efa\u597d <code>Secret</code>\u5bf9\u8c61\u540e\uff0c\u6709\u4e24\u79cd\u65b9\u5f0f\u6765\u4f7f\u7528\u5b83\uff1a</p> <ul> <li>\u4ee5\u73af\u5883\u53d8\u91cf\u7684\u5f62\u5f0f</li> <li>\u4ee5Volume\u7684\u5f62\u5f0f\u6302\u8f7d</li> </ul>"},{"location":"kubernetes_config/secret/#_1","title":"\u73af\u5883\u53d8\u91cf","text":"<p>\u9996\u5148\u6211\u4eec\u6765\u6d4b\u8bd5\u4e0b\u73af\u5883\u53d8\u91cf\u7684\u65b9\u5f0f\uff0c\u540c\u6837\u7684\uff0c\u6211\u4eec\u6765\u4f7f\u7528\u4e00\u4e2a\u7b80\u5355\u7684 busybox \u955c\u50cf\u6765\u6d4b\u8bd5\u4e0b:(secret1-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: secret1-pod\nspec:\n  containers:\n  - name: secret1\n    image: busybox\n    command: [ \"/bin/sh\", \"-c\", \"env\" ]\n    env:\n    - name: USERNAME\n      valueFrom:\n        secretKeyRef:\n          name: mysecret\n          key: username\n    - name: PASSWORD\n      valueFrom:\n        secretKeyRef:\n          name: mysecret\n          key: password\n</code></pre> <p>\u4e3b\u8981\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e0a\u9762\u73af\u5883\u53d8\u91cf\u4e2d\u5b9a\u4e49\u7684 <code>secretKeyRef</code> \u5b57\u6bb5\uff0c\u548c\u6211\u4eec\u524d\u6587\u7684 <code>configMapKeyRef</code> \u7c7b\u4f3c\uff0c\u4e00\u4e2a\u662f\u4ece <code>Secret</code> \u5bf9\u8c61\u4e2d\u83b7\u53d6\uff0c\u4e00\u4e2a\u662f\u4ece <code>ConfigMap</code> \u5bf9\u8c61\u4e2d\u83b7\u53d6\uff0c\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl create -f secret1-pod.yaml\npod \"secret1-pod\" created\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u67e5\u770bPod\u7684\u65e5\u5fd7\u8f93\u51fa\uff1a</p> <pre><code>$ kubectl logs secret1-pod\n...\nUSERNAME=admin\nPASSWORD=admin321\n...\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6709 USERNAME \u548c PASSWORD \u4e24\u4e2a\u73af\u5883\u53d8\u91cf\u8f93\u51fa\u51fa\u6765\u3002</p>"},{"location":"kubernetes_config/secret/#volume","title":"Volume \u6302\u8f7d","text":"<p>\u540c\u6837\u7684\u6211\u4eec\u7528\u4e00\u4e2a Pod \u6765\u9a8c\u8bc1\u4e0b <code>Volume</code> \u6302\u8f7d\uff0c\u521b\u5efa\u4e00\u4e2a Pod \u6587\u4ef6\uff1a(secret2-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: secret2-pod\nspec:\n  containers:\n  - name: secret2\n    image: busybox\n    command: [\"/bin/sh\", \"-c\", \"ls /etc/secrets\"]\n    volumeMounts:\n    - name: secrets\n      mountPath: /etc/secrets\n  volumes:\n  - name: secrets\n    secret:\n     secretName: mysecret\n</code></pre> <p>\u521b\u5efa Pod\uff0c\u7136\u540e\u67e5\u770b\u8f93\u51fa\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl create -f secret-podyaml\npod \"secret2-pod\" created\n$ kubectl logs secret2-pod\npassword\nusername\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 Secret \u628a\u4e24\u4e2a key \u6302\u8f7d\u6210\u4e86\u4e24\u4e2a\u5bf9\u5e94\u7684\u6587\u4ef6\u3002\u5f53\u7136\u5982\u679c\u60f3\u8981\u6302\u8f7d\u5230\u6307\u5b9a\u7684\u6587\u4ef6\u4e0a\u9762\uff0c\u662f\u4e0d\u662f\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e0a\u4e00\u8282\u8bfe\u7684\u65b9\u6cd5\uff1a\u5728 <code>secretName</code> \u4e0b\u9762\u6dfb\u52a0 <code>items</code> \u6307\u5b9a <code>key</code> \u548c <code>path</code>\uff0c\u8fd9\u4e2a\u5927\u5bb6\u53ef\u4ee5\u53c2\u8003\u4e0a\u8282\u8bfe <code>ConfigMap</code> \u4e2d\u7684\u65b9\u6cd5\u53bb\u6d4b\u8bd5\u4e0b\u3002</p>"},{"location":"kubernetes_config/secret/#kubernetesiodockerconfigjson","title":"kubernetes.io/dockerconfigjson","text":"<p>\u9664\u4e86\u4e0a\u9762\u7684 <code>Opaque</code> \u8fd9\u79cd\u7c7b\u578b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u6765\u521b\u5efa\u7528\u6237 <code>docker registry</code> \u8ba4\u8bc1\u7684 <code>Secret</code>\uff0c\u76f4\u63a5\u4f7f\u7528<code>`kubectl create</code> \u547d\u4ee4\u521b\u5efa\u5373\u53ef\uff0c\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl create secret docker-registry myregistry --docker-server=DOCKER_SERVER --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL\nsecret \"myregistry\" created\n</code></pre> <p>\u9664\u4e86\u4e0a\u9762\u8fd9\u79cd\u65b9\u6cd5\u4e4b\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u6587\u4ef6\u7684\u65b9\u5f0f\u6765\u521b\u5efa\u955c\u50cf\u4ed3\u5e93\u8ba4\u8bc1\u4fe1\u606f\uff0c\u9700\u8981\u6ce8\u610f\u5bf9\u5e94\u7684 <code>KEY</code> \u548c <code>TYPE</code>\uff1a</p> <pre><code>$ kubectl create secret generic myregistry --from-file=.dockerconfigjson=/root/.docker/config.json --type=kubernetes.io/dockerconfigjson\n</code></pre> <p>\u7136\u540e\u67e5\u770b Secret \u5217\u8868\uff1a</p> <pre><code>$ kubectl get secret\nNAME                  TYPE                                  DATA      AGE\ndefault-token-n9w2d   kubernetes.io/service-account-token   3         33d\nmyregistry            kubernetes.io/dockerconfigjson        1         15s\nmysecret              Opaque                                2         34m\n</code></pre> <p>\u6ce8\u610f\u770b\u4e0a\u9762\u7684 TYPE \u7c7b\u578b\uff0cmyregistry \u5bf9\u5e94\u7684\u662f </p> <pre><code>kubernetes.io/dockerconfigjson\n</code></pre> <p>\uff0c\u540c\u6837\u7684\u53ef\u4ee5\u4f7f\u7528 describe \u547d\u4ee4\u6765\u67e5\u770b\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe secret myregistry\nName:         myregistry\nNamespace:    default\nLabels:       &lt;none&gt;\nAnnotations:  &lt;none&gt;\n\nType:  kubernetes.io/dockerconfigjson\n\nData\n====\n.dockerconfigjson:  152 bytes\n</code></pre> <p>\u540c\u6837\u7684\u53ef\u4ee5\u770b\u5230 Data \u533a\u57df\u6ca1\u6709\u76f4\u63a5\u5c55\u793a\u51fa\u6765\uff0c\u5982\u679c\u60f3\u67e5\u770b\u7684\u8bdd\u53ef\u4ee5\u4f7f\u7528 <code>-o yaml</code> \u6765\u8f93\u51fa\u5c55\u793a\u51fa\u6765\uff1a</p> <pre><code>$ kubectl get secret myregistry -o yaml\napiVersion: v1\ndata:\n  .dockerconfigjson: eyJhdXRocyI6eyJET0NLRVJfU0VSVkVSIjp7InVzZXJuYW1lIjoiRE9DS0VSX1VTRVIiLCJwYXNzd29yZCI6IkRPQ0tFUl9QQVNTV09SRCIsImVtYWlsIjoiRE9DS0VSX0VNQUlMIiwiYXV0aCI6IlJFOURTMFZTWDFWVFJWSTZSRTlEUzBWU1gxQkJVMU5YVDFKRSJ9fX0=\nkind: Secret\nmetadata:\n  creationTimestamp: 2018-06-19T16:01:05Z\n  name: myregistry\n  namespace: default\n  resourceVersion: \"3696966\"\n  selfLink: /api/v1/namespaces/default/secrets/myregistry\n  uid: f91db707-73d9-11e8-a101-525400db4df7\ntype: kubernetes.io/dockerconfigjson\n</code></pre> <p>\u53ef\u4ee5\u628a\u4e0a\u9762\u7684 </p> <pre><code>data.dockerconfigjson\n</code></pre> <p>\u4e0b\u9762\u7684\u6570\u636e\u505a\u4e00\u4e2a <code>base64</code> \u89e3\u7801\uff0c\u770b\u770b\u91cc\u9762\u7684\u6570\u636e\u662f\u600e\u6837\u7684\u5462\uff1f</p> <pre><code>$ echo eyJhdXRocyI6eyJET0NLRVJfU0VSVkVSIjp7InVzZXJuYW1lIjoiRE9DS0VSX1VTRVIiLCJwYXNzd29yZCI6IkRPQ0tFUl9QQVNTV09SRCIsImVtYWlsIjoiRE9DS0VSX0VNQUlMIiwiYXV0aCI6IlJFOURTMFZTWDFWVFJWSTZSRTlEUzBWU1gxQkJVMU5YVDFKRSJ9fX0= | base64 -d\n{\"auths\":{\"DOCKER_SERVER\":{\"username\":\"DOCKER_USER\",\"password\":\"DOCKER_PASSWORD\",\"email\":\"DOCKER_EMAIL\",\"auth\":\"RE9DS0VSX1VTRVI6RE9DS0VSX1BBU1NXT1JE\"}}}\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u9700\u8981\u62c9\u53d6\u79c1\u6709\u4ed3\u5e93\u4e2d\u7684 Docker \u955c\u50cf\u7684\u8bdd\u5c31\u9700\u8981\u4f7f\u7528\u5230\u4e0a\u9762\u7684 myregistry \u8fd9\u4e2a <code>Secret</code>\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: foo\nspec:\n  containers:\n  - name: foo\n    image: 11100:5000/test:v1\n  imagePullSecrets:\n  - name: myregistry\n</code></pre> <p>imagePullSecrets</p> <p><code>ImagePullSecrets</code> \u4e0e <code>Secrets</code> \u4e0d\u540c\uff0c\u56e0\u4e3a <code>Secrets</code> \u53ef\u4ee5\u6302\u8f7d\u5230 Pod \u4e2d\uff0c\u4f46\u662f <code>ImagePullSecrets</code> \u53ea\u80fd\u7531 Kubelet \u8bbf\u95ee\u3002</p> <p>\u6211\u4eec\u9700\u8981\u62c9\u53d6\u79c1\u6709\u4ed3\u5e93\u955c\u50cf </p> <pre><code>11100:5000/test:v1\n</code></pre> <p>\uff0c\u6211\u4eec\u5c31\u9700\u8981\u9488\u5bf9\u8be5\u79c1\u6709\u4ed3\u5e93\u6765\u521b\u5efa\u4e00\u4e2a\u5982\u4e0a\u7684 <code>Secret</code>\uff0c\u7136\u540e\u5728 Pod \u4e2d\u6307\u5b9a <code>imagePullSecrets</code>\u3002</p> <p>\u9664\u4e86\u8bbe\u7f6e </p> <pre><code>Pod.spec.imagePullSecrets\n</code></pre> <p>\u8fd9\u79cd\u65b9\u5f0f\u6765\u83b7\u53d6\u79c1\u6709\u955c\u50cf\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u5728 <code>ServiceAccount</code> \u4e2d\u8bbe\u7f6e <code>imagePullSecrets</code>\uff0c\u7136\u540e\u5c31\u4f1a\u81ea\u52a8\u4e3a\u4f7f\u7528\u8be5 SA \u7684 Pod \u6ce8\u5165 <code>imagePullSecrets</code> \u4fe1\u606f\uff1a</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  creationTimestamp: \"2019-11-08T12:00:04Z\"\n  name: default\n  namespace: default\n  resourceVersion: \"332\"\n  selfLink: /api/v1/namespaces/default/serviceaccounts/default\n  uid: cc37a719-c4fe-4ebf-92da-e92c3e24d5d0\nsecrets:\n- name: default-token-5tsh4\nimagePullSecrets:\n- name: myregistry\n</code></pre>"},{"location":"kubernetes_config/secret/#kubernetesioservice-account-token","title":"kubernetes.io/service-account-token","text":"<p>\u53e6\u5916\u4e00\u79cd <code>Secret</code> \u7c7b\u578b\u5c31\u662f </p> <pre><code>kubernetes.io/service-account-token\n</code></pre> <p>\uff0c\u7528\u4e8e\u88ab <code>ServiceAccount</code> \u5f15\u7528\u3002<code>ServiceAccout</code> \u521b\u5efa\u65f6 Kubernetes \u4f1a\u9ed8\u8ba4\u521b\u5efa\u5bf9\u5e94\u7684 <code>Secret</code>\u3002Pod \u5982\u679c\u4f7f\u7528\u4e86 <code>ServiceAccount</code>\uff0c\u5bf9\u5e94\u7684 <code>Secret</code> \u4f1a\u81ea\u52a8\u6302\u8f7d\u5230 Pod \u7684 </p> <pre><code>/var/run/secrets/kubernetes.io/serviceaccount/\n</code></pre> <p>\u76ee\u5f55\u4e2d\u3002\u5982\u4e0b\u6240\u793a\u6211\u4eec\u968f\u610f\u521b\u5efa\u4e00\u4e2a Pod\uff1a</p> <pre><code>$ kubectl run secret-pod3 --image nginx:9\ndeployment.apps \"secret-pod3\" created\n$ kubectl get pods\nNAME                           READY     STATUS    RESTARTS   AGE\n...\nsecret-pod3-78c8c76db8-7zmqm   1/1       Running   0          13s\n...\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b\u8fd9\u4e2a Pod \u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>volumeMounts:\n    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount\n      name: default-token-5tsh4\n      readOnly: true\n  ......\n  serviceAccount: default\n  serviceAccountName: default\n  volumes:\n  - name: default-token-5tsh4\n    secret:\n      defaultMode: 420\n      secretName: default-token-5tsh4\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u9ed8\u8ba4\u628a\u540d\u4e3a <code>default</code>\uff08\u81ea\u52a8\u521b\u5efa\u7684\uff09\u7684 <code>ServiceAccount</code> \u5bf9\u5e94\u7684 Secret \u5bf9\u8c61\u901a\u8fc7 Volume \u6302\u8f7d\u5230\u4e86\u5bb9\u5668\u7684 </p> <pre><code>/var/run/secrets/kubernetes.io/serviceaccount\n</code></pre> <p>\u7684\u76ee\u5f55\u4e2d\uff0c\u5bf9\u4e8e\u8be5\u76ee\u5f55\u7684\u4f5c\u7528\u6211\u4eec\u4f1a\u5728\u540e\u9762\u7684\u5b89\u5168\u7ae0\u8282\u4e2d\u7ee7\u7eed\u548c\u5927\u5bb6\u5b66\u4e60\u3002</p>"},{"location":"kubernetes_config/secret/#secret_vs_configmap","title":"Secret vs ConfigMap","text":"<p>\u6700\u540e\u6211\u4eec\u6765\u5bf9\u6bd4\u4e0b <code>Secret</code> \u548c <code>ConfigMap</code>\u8fd9\u4e24\u79cd\u8d44\u6e90\u5bf9\u8c61\u7684\u5f02\u540c\u70b9\uff1a</p>"},{"location":"kubernetes_config/secret/#_2","title":"\u76f8\u540c\u70b9","text":"<ul> <li>key/value\u7684\u5f62\u5f0f</li> <li>\u5c5e\u4e8e\u67d0\u4e2a\u7279\u5b9a\u7684\u547d\u540d\u7a7a\u95f4</li> <li>\u53ef\u4ee5\u5bfc\u51fa\u5230\u73af\u5883\u53d8\u91cf</li> <li>\u53ef\u4ee5\u901a\u8fc7\u76ee\u5f55/\u6587\u4ef6\u5f62\u5f0f\u6302\u8f7d</li> <li>\u901a\u8fc7 volume \u6302\u8f7d\u7684\u914d\u7f6e\u4fe1\u606f\u5747\u53ef\u70ed\u66f4\u65b0</li> </ul>"},{"location":"kubernetes_config/secret/#_3","title":"\u4e0d\u540c\u70b9","text":"<ul> <li>Secret \u53ef\u4ee5\u88ab ServerAccount \u5173\u8054</li> <li>Secret \u53ef\u4ee5\u5b58\u50a8 <code>docker register</code> \u7684\u9274\u6743\u4fe1\u606f\uff0c\u7528\u5728 <code>ImagePullSecret</code> \u53c2\u6570\u4e2d\uff0c\u7528\u4e8e\u62c9\u53d6\u79c1\u6709\u4ed3\u5e93\u7684\u955c\u50cf</li> <li>Secret \u652f\u6301 <code>Base64</code> \u52a0\u5bc6</li> <li> <p>Secret \u5206\u4e3a </p> <pre><code>kubernetes.io/service-account-token\n</code></pre> <p>\u3001</p> <pre><code>kubernetes.io/dockerconfigjson\n</code></pre> <p>\u3001<code>Opaque</code> \u4e09\u79cd\u7c7b\u578b\uff0c\u800c <code>Configmap</code> \u4e0d\u533a\u5206\u7c7b\u578b</p> </li> </ul> <p>\u4f7f\u7528\u6ce8\u610f</p> <p>\u540c\u6837 Secret \u6587\u4ef6\u5927\u5c0f\u9650\u5236\u4e3a <code>1MB</code>\uff08ETCD \u7684\u8981\u6c42\uff09\uff1bSecret \u867d\u7136\u91c7\u7528 <code>Base64</code> \u7f16\u7801\uff0c\u4f46\u662f\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u5f88\u65b9\u4fbf\u89e3\u7801\u83b7\u53d6\u5230\u539f\u59cb\u4fe1\u606f\uff0c\u6240\u4ee5\u5bf9\u4e8e\u975e\u5e38\u91cd\u8981\u7684\u6570\u636e\u8fd8\u662f\u9700\u8981\u614e\u91cd\u8003\u8651\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528 Vault \u6765\u8fdb\u884c\u52a0\u5bc6\u7ba1\u7406\u3002</p>"},{"location":"kubernetes_config/service_account/","title":"ServiceAccount","text":""},{"location":"kubernetes_config/service_account/#serviceaccount","title":"ServiceAccount","text":"<p><code>ServiceAccount</code> \u4e3b\u8981\u662f\u7528\u4e8e\u89e3\u51b3 Pod \u5728\u96c6\u7fa4\u4e2d\u7684\u8eab\u4efd\u8ba4\u8bc1\u95ee\u9898\u7684\u3002\u8ba4\u8bc1\u4f7f\u7528\u7684\u6388\u6743\u4fe1\u606f\u5176\u5b9e\u5c31\u662f\u5229\u7528\u524d\u9762\u6211\u4eec\u8bb2\u5230\u7684\u4e00\u4e2a\u7c7b\u578b\u4e3a </p> <pre><code>kubernetes.io/service-account-token\n</code></pre> <p>\u8fdb\u884c\u7ba1\u7406\u7684\u3002</p>"},{"location":"kubernetes_config/service_account/#_1","title":"\u4ecb\u7ecd","text":"<p><code>ServiceAccount</code> \u662f\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u7684\uff0c\u6bcf\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u521b\u5efa\u7684\u65f6\u5019\u5c31\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>default</code> \u7684 <code>ServiceAccount</code> \u5bf9\u8c61:</p> <pre><code>$ kubectl create ns kube-test\nnamespace/kube-test created\n$ kubectl get sa -n kube-test\nNAME      SECRETS   AGE\ndefault   1         9s\n$ kubectl get secret -n kube-test\nNAME                  TYPE                                  DATA   AGE\ndefault-token-vn4tr   kubernetes.io/service-account-token   3      2m27s\n</code></pre> <p>\u8fd9\u4e2a <code>ServiceAccount</code> \u4f1a\u81ea\u52a8\u5173\u8054\u5230\u4e00\u4e2a <code>Secret</code> \u5bf9\u8c61\u4e0a\uff1a</p> <pre><code>$ kubectl get sa default -n kube-test  -o yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  creationTimestamp: \"2019-11-23T04:19:47Z\"\n  name: default\n  namespace: kube-test\n  resourceVersion: \"4297522\"\n  selfLink: /api/v1/namespaces/kube-test/serviceaccounts/default\n  uid: 75b3314b-e949-4f7b-9450-9bcd89c8c972\nsecrets:\n- name: default-token-vn4tr\n</code></pre> <p>\u8fd9\u4e2a Secret \u5bf9\u8c61\u662f ServiceAccount \u63a7\u5236\u5668\u81ea\u52a8\u521b\u5efa\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u8fd9\u4e2a\u5173\u8054\u7684 <code>Secret</code> \u5bf9\u8c61\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get secret default-token-vn4tr -n kube-test -o yaml\napiVersion: v1\ndata:\n  ca.crt: LS0tLS...\n  namespace: a3ViZS10ZXN0\n  token: ZXlKaG...\nkind: Secret\nmetadata:\n  annotations:\n    kubernetes.io/service-account.name: default\n    kubernetes.io/service-account.uid: 75b3314b-e949-4f7b-9450-9bcd89c8c972\n  creationTimestamp: \"2019-11-23T04:19:47Z\"\n  name: default-token-vn4tr\n  namespace: kube-test\n  resourceVersion: \"4297521\"\n  selfLink: /api/v1/namespaces/kube-test/secrets/default-token-vn4tr\n  uid: e3e60f95-f255-471b-a6c0-600a3c0ee53a\ntype: kubernetes.io/service-account-token\n</code></pre> <p>\u5728 <code>data</code> \u533a\u57df\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u67093\u4e2a\u4fe1\u606f\uff1a</p> <ul> <li><code>ca.crt</code>\uff1a\u7528\u4e8e\u6821\u9a8c\u670d\u52a1\u7aef\u7684\u8bc1\u4e66\u4fe1\u606f</li> <li><code>namespace</code>\uff1a\u8868\u793a\u5f53\u524d\u7ba1\u7406\u7684\u547d\u540d\u7a7a\u95f4</li> <li><code>token</code>\uff1a\u7528\u4e8e Pod \u8eab\u4efd\u8ba4\u8bc1\u7684 Token</li> </ul> <p>\u524d\u9762\u6211\u4eec\u4e5f\u63d0\u5230\u4e86\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5f53\u524d namespace \u4e0b\u9762\u7684 Pod \u4f1a\u9ed8\u8ba4\u4f7f\u7528 <code>default</code> \u8fd9\u4e2a ServiceAccount\uff0c\u5bf9\u5e94\u7684 <code>Secret</code> \u4f1a\u81ea\u52a8\u6302\u8f7d\u5230 Pod \u7684 </p> <pre><code>/var/run/secrets/kubernetes.io/serviceaccount/\n</code></pre> <p>\u76ee\u5f55\u4e2d\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 Pod \u91cc\u9762\u83b7\u53d6\u5230\u7528\u4e8e\u8eab\u4efd\u8ba4\u8bc1\u7684\u4fe1\u606f\u4e86\u3002</p>"},{"location":"kubernetes_config/service_account/#_2","title":"\u5b9e\u73b0\u539f\u7406","text":"<p>\u5b9e\u9645\u4e0a\u8fd9\u4e2a\u81ea\u52a8\u6302\u8f7d\u8fc7\u7a0b\u662f\u5728 Pod \u521b\u5efa\u7684\u65f6\u5019\u901a\u8fc7 </p> <pre><code>Admisson Controller\uff08\u51c6\u5165\u63a7\u5236\u5668\uff09\n</code></pre> <p>\u6765\u5b9e\u73b0\u7684\uff0c\u5173\u4e8e\u51c6\u5165\u63a7\u5236\u5668\u7684\u8be6\u7ec6\u4fe1\u606f\u6211\u4eec\u4f1a\u5728\u540e\u9762\u7684\u5b89\u5168\u7ae0\u8282\u4e2d\u548c\u5927\u5bb6\u7ee7\u7eed\u5b66\u4e60\u3002</p> <p>Admisson Controller</p> <p><code>Admission Controller\uff08\u51c6\u5165\u63a7\u5236\uff09 <pre><code>\u662f Kubernetes API Server \u7528\u4e8e\u62e6\u622a\u8bf7\u6c42\u7684\u4e00\u79cd\u624b\u6bb5\u3002`Admission` \u53ef\u4ee5\u505a\u5230\u5bf9\u8bf7\u6c42\u7684\u8d44\u6e90\u5bf9\u8c61\u8fdb\u884c\u6821\u9a8c\uff0c\u4fee\u6539\uff0cPod \u521b\u5efa\u65f6 `Admission Controller` \u4f1a\u6839\u636e\u6307\u5b9a\u7684\u7684 `ServiceAccount`\uff08\u9ed8\u8ba4\u7684 default\uff09\u628a\u5bf9\u5e94\u7684 `Secret` \u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u7684\u56fa\u5b9a\u76ee\u5f55\u4e0b \n</code></pre> /var/run/secrets/kubernetes.io/serviceaccount/</code></p> <p>\u3002</p> <p>\u7136\u540e\u5f53\u6211\u4eec\u5728 Pod \u91cc\u9762\u8bbf\u95ee\u96c6\u7fa4\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u9ed8\u8ba4\u5229\u7528\u6302\u8f7d\u5230 Pod \u5185\u90e8\u7684 <code>token</code> \u6587\u4ef6\u6765\u8ba4\u8bc1 Pod \u7684\u8eab\u4efd\uff0c<code>ca.crt</code> \u5219\u7528\u6765\u6821\u9a8c\u670d\u52a1\u7aef\u3002\u5728 Pod \u4e2d\u8bbf\u95ee Kubernetes \u96c6\u7fa4\u7684\u4e00\u4e2a\u5178\u578b\u7684\u65b9\u5f0f\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u4ee3\u7801\u4e2d\u6211\u4eec\u6307\u5b9a\u4e86 <code>ServiceAccount</code> \u80cc\u540e\u7684 Secret \u6302\u8f7d\u5230 Pod \u91cc\u9762\u7684\u4e24\u4e2a\u6587\u4ef6\uff1a<code>token</code> \u548c <code>ca.crt</code>\uff0c\u7136\u540e\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u83b7\u53d6\u5230 APIServer \u7684\u8bbf\u95ee\u5730\u5740\uff08\u524d\u9762\u6211\u4eec\u63d0\u5230\u8fc7\u4f1a\u628a Service \u4fe1\u606f\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u7684\u65b9\u5f0f\u6ce8\u5165\u5230 Pod \u4e2d\uff09\uff0c\u7136\u540e\u901a\u8fc7 <code>ca.cart</code> \u6821\u9a8c\u670d\u52a1\u7aef\u662f\u5426\u53ef\u4fe1\uff0c\u6700\u540e\u670d\u52a1\u7aef\u4f1a\u6839\u636e\u6211\u4eec\u63d0\u4f9b\u7684 <code>token</code> \u6587\u4ef6\u5bf9 Pod \u8fdb\u884c\u8ba4\u8bc1\u3002</p> <p>Pod \u8eab\u4efd\u88ab\u8ba4\u8bc1\u5408\u6cd5\u8fc7\u540e\uff0c\u5177\u4f53\u5177\u6709\u54ea\u4e9b\u8d44\u6e90\u7684\u8bbf\u95ee\u6743\u9650\uff0c\u5c31\u9700\u8981\u901a\u8fc7\u540e\u9762\u7684 <code>RBAC</code> \u6765\u8fdb\u884c\u58f0\u660e\u4e86\u3002\u6240\u4ee5\u6211\u4eec\u5728\u5b66\u4e60 Kubernetes \u7684\u6743\u9650\u8ba4\u8bc1\u7684\u65f6\u5019\u9700\u8981\u628a\u6574\u4e2a\u6d41\u7a0b\u5f04\u6e05\u695a\uff0c<code>ServiceAccount</code> \u662f\u5e72\u561b\u7684\uff1f\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981 <code>RBAC</code>\uff1f\u8fd9\u4e9b\u90fd\u662f\u4e0a\u4e0b\u6587\u5173\u8054\u7684\u3002</p>"},{"location":"kubernetes_controller/daemonset/","title":"DaemonSet","text":""},{"location":"kubernetes_controller/daemonset/#daemonset","title":"DaemonSet \u63a7\u5236\u5668","text":"<p>\u901a\u8fc7\u8be5\u63a7\u5236\u5668\u7684\u540d\u79f0\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u5b83\u7684\u7528\u6cd5\uff1a<code>Daemon</code>\uff0c\u5c31\u662f\u7528\u6765\u90e8\u7f72\u5b88\u62a4\u8fdb\u7a0b\u7684\uff0c<code>DaemonSet</code>\u7528\u4e8e\u5728\u6bcf\u4e2a Kubernetes \u8282\u70b9\u4e2d\u5c06\u5b88\u62a4\u8fdb\u7a0b\u7684\u526f\u672c\u4f5c\u4e3a\u540e\u53f0\u8fdb\u7a0b\u8fd0\u884c\uff0c\u8bf4\u767d\u4e86\u5c31\u662f\u5728\u6bcf\u4e2a\u8282\u70b9\u90e8\u7f72\u4e00\u4e2a Pod\u526f\u672c\uff0c\u5f53\u8282\u70b9\u52a0\u5165\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff0cPod \u4f1a\u88ab\u8c03\u5ea6\u5230\u8be5\u8282\u70b9\u4e0a\u8fd0\u884c\uff0c\u5f53\u8282\u70b9\u4ece\u96c6\u7fa4\u53ea\u80fd\u591f\u88ab\u79fb\u9664\u540e\uff0c\u8be5\u8282\u70b9\u4e0a\u7684\u8fd9\u4e2a Pod \u4e5f\u4f1a\u88ab\u79fb\u9664\uff0c\u5f53\u7136\uff0c\u5982\u679c\u6211\u4eec\u5220\u9664 DaemonSet\uff0c\u6240\u6709\u548c\u8fd9\u4e2a\u5bf9\u8c61\u76f8\u5173\u7684 Pods\u90fd\u4f1a\u88ab\u5220\u9664\u3002\u90a3\u4e48\u5728\u54ea\u79cd\u60c5\u51b5\u4e0b\u6211\u4eec\u4f1a\u9700\u8981\u7528\u5230\u8fd9\u79cd\u4e1a\u52a1\u573a\u666f\u5462\uff1f\u5176\u5b9e\u8fd9\u79cd\u573a\u666f\u8fd8\u662f\u6bd4\u8f83\u666e\u901a\u7684\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>\u96c6\u7fa4\u5b58\u50a8\u5b88\u62a4\u7a0b\u5e8f\uff0c\u5982 glusterd\u3001ceph \u8981\u90e8\u7f72\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u4ee5\u63d0\u4f9b\u6301\u4e45\u6027\u5b58\u50a8\uff1b</li> <li>\u8282\u70b9\u76d1\u63a7\u5b88\u62a4\u8fdb\u7a0b\uff0c\u5982 Prometheus \u76d1\u63a7\u96c6\u7fa4\uff0c\u53ef\u4ee5\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a node-exporter \u8fdb\u7a0b\u6765\u6536\u96c6\u76d1\u63a7\u8282\u70b9\u7684\u4fe1\u606f\uff1b</li> <li>\u65e5\u5fd7\u6536\u96c6\u5b88\u62a4\u7a0b\u5e8f\uff0c\u5982 fluentd \u6216 logstash\uff0c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4ee5\u6536\u96c6\u5bb9\u5668\u7684\u65e5\u5fd7</li> <li>\u8282\u70b9\u7f51\u7edc\u63d2\u4ef6\uff0c\u6bd4\u5982 flannel\u3001calico\uff0c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e3a Pod \u63d0\u4f9b\u7f51\u7edc\u670d\u52a1\u3002</li> </ul> <p>\u8fd9\u91cc\u9700\u8981\u7279\u522b\u8bf4\u660e\u7684\u4e00\u4e2a\u5c31\u662f\u5173\u4e8e DaemonSet \u8fd0\u884c\u7684 Pod \u7684\u8c03\u5ea6\u95ee\u9898\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0cPod \u8fd0\u884c\u5728\u54ea\u4e2a\u8282\u70b9\u4e0a\u662f\u7531 Kubernetes \u7684\u8c03\u5ea6\u5668\u7b56\u7565\u6765\u51b3\u5b9a\u7684\uff0c\u7136\u800c\uff0c\u7531 DaemonSet \u63a7\u5236\u5668\u521b\u5efa\u7684 Pod \u5b9e\u9645\u4e0a\u63d0\u524d\u5df2\u7ecf\u786e\u5b9a\u4e86\u5728\u54ea\u4e2a\u8282\u70b9\u4e0a\u4e86\uff08Pod\u521b\u5efa\u65f6\u6307\u5b9a\u4e86<code>.spec.nodeName</code>\uff09\uff0c\u6240\u4ee5\uff1a</p> <ul> <li><code>DaemonSet</code> \u5e76\u4e0d\u5173\u5fc3\u4e00\u4e2a\u8282\u70b9\u7684 <code>unshedulable</code> \u5b57\u6bb5\uff0c\u8fd9\u4e2a\u6211\u4eec\u4f1a\u5728\u540e\u9762\u7684\u8c03\u5ea6\u7ae0\u8282\u548c\u5927\u5bb6\u8bb2\u89e3\u7684\u3002</li> <li><code>DaemonSet</code> \u53ef\u4ee5\u521b\u5efa Pod\uff0c\u5373\u4f7f\u8c03\u5ea6\u5668\u8fd8\u6ca1\u6709\u542f\u52a8\u3002</li> </ul> <p>\u4e0b\u9762\u6211\u4eec\u76f4\u63a5\u4f7f\u7528\u4e00\u4e2a\u793a\u4f8b\u6765\u6f14\u793a\u4e0b\uff0c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90e8\u7f72\u4e00\u4e2a Nginx Pod\uff1a(nginx-ds.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: nginx-ds\n  namespace: default\nspec:\n  selector:\n    matchLabels:\n      k8s-app: nginx\n  template:\n    metadata:\n      labels:\n        k8s-app: nginx\n    spec:\n      containers:\n      - image: nginx:9\n        name: nginx\n        ports:\n        - name: http\n          containerPort: 80\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f nginx-ds.yaml\ndaemonset.apps/nginx-ds created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u67e5\u770b Pod \u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get nodes\nNAME          STATUS   ROLES    AGE     VERSION\nydzs-master   Ready    master   8d      v2\nydzs-node1    Ready    &lt;none&gt;   8d      v2\nydzs-node2    Ready    &lt;none&gt;   8d      v2\nydzs-node3    Ready    &lt;none&gt;   6d23h   v2\nydzs-node4    Ready    &lt;none&gt;   6d23h   v2\n$ kubectl get pods -l k8s-app=nginx -o wide\nNAME             READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES\nnginx-ds-bpsb7   1/1     Running   0          75s   2102   ydzs-node3   &lt;none&gt;           &lt;none&gt;\nnginx-ds-f4s2w   1/1     Running   0          75s   274    ydzs-node2   &lt;none&gt;           &lt;none&gt;\nnginx-ds-j9789   1/1     Running   0          75s   285    ydzs-node4   &lt;none&gt;           &lt;none&gt;\nnginx-ds-ngkt2   1/1     Running   0          75s   2178   ydzs-node1   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u89c2\u5bdf\u53ef\u4ee5\u53d1\u73b0\u9664\u4e86 master \u8282\u70b9\u4e4b\u5916\u76844\u4e2a\u8282\u70b9\u4e0a\u90fd\u6709\u4e00\u4e2a\u76f8\u5e94\u7684 Pod \u8fd0\u884c\uff0c\u56e0\u4e3a master \u8282\u70b9\u4e0a\u9ed8\u8ba4\u88ab\u6253\u4e0a\u4e86<code>\u6c61\u70b9</code>\uff0c\u6240\u4ee5\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4e0d\u80fd\u8c03\u5ea6\u666e\u901a\u7684 Pod \u4e0a\u53bb\uff0c\u540e\u9762\u8bb2\u89e3\u8c03\u5ea6\u5668\u7684\u65f6\u5019\u4f1a\u548c\u5927\u5bb6\u5b66\u4e60\u5982\u4f55\u8c03\u5ea6\u4e0a\u53bb\u3002</p> <p>\u57fa\u672c\u4e0a\u6211\u4eec\u53ef\u4ee5\u7528\u4e0b\u56fe\u6765\u63cf\u8ff0 DaemonSet \u7684\u62d3\u6251\u56fe\uff1a</p> <p></p> <p>\u96c6\u7fa4\u4e2d\u7684 Pod \u548c Node \u662f<code>\u4e00\u4e00</code>\u5bf9\u5e94d\u7684\uff0c\u800c DaemonSet \u4f1a\u7ba1\u7406\u5168\u90e8\u673a\u5668\u4e0a\u7684 Pod \u526f\u672c\uff0c\u8d1f\u8d23\u5bf9\u5b83\u4eec\u8fdb\u884c\u66f4\u65b0\u548c\u5220\u9664\u3002</p> <p>\u90a3\u4e48\uff0cDaemonSet \u63a7\u5236\u5668\u662f\u5982\u4f55\u4fdd\u8bc1\u6bcf\u4e2a Node \u4e0a\u6709\u4e14\u53ea\u6709\u4e00\u4e2a\u88ab\u7ba1\u7406\u7684 Pod \u5462\uff1f</p> <ul> <li>\u9996\u5148\u63a7\u5236\u5668\u4ece Etcd \u83b7\u53d6\u5230\u6240\u6709\u7684 Node \u5217\u8868\uff0c\u7136\u540e\u904d\u5386\u6240\u6709\u7684 Node\u3002</li> <li>\u6839\u636e\u8d44\u6e90\u5bf9\u8c61\u5b9a\u4e49\u662f\u5426\u6709\u8c03\u5ea6\u76f8\u5173\u7684\u914d\u7f6e\uff0c\u7136\u540e\u5206\u522b\u68c0\u67e5 Node \u662f\u5426\u7b26\u5408\u8981\u6c42\u3002</li> <li>\u5728\u53ef\u8fd0\u884c Pod \u7684\u8282\u70b9\u4e0a\u68c0\u67e5\u662f\u5426\u5df2\u6709\u5bf9\u5e94\u7684 Pod\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5219\u5728\u8fd9\u4e2a Node \u4e0a\u521b\u5efa\u8be5 Pod\uff1b\u5982\u679c\u6709\uff0c\u5e76\u4e14\u6570\u91cf\u5927\u4e8e 1\uff0c\u90a3\u5c31\u628a\u591a\u4f59\u7684 Pod \u4ece\u8fd9\u4e2a\u8282\u70b9\u4e0a\u5220\u9664\uff1b\u5982\u679c\u6709\u4e14\u53ea\u6709\u4e00\u4e2a Pod\uff0c\u90a3\u5c31\u8bf4\u660e\u662f\u6b63\u5e38\u60c5\u51b5\u3002</li> </ul> <p>\u5b9e\u9645\u4e0a\u5f53\u6211\u4eec\u5b66\u4e60\u4e86\u8d44\u6e90\u8c03\u5ea6\u540e\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u81ea\u5df1\u7528 Deployment \u6765\u5b9e\u73b0 DaemonSet \u7684\u6548\u679c\uff0c\u8fd9\u91cc\u6211\u4eec\u660e\u767d DaemonSet \u5982\u4f55\u4f7f\u7528\u7684\u5373\u53ef\uff0c\u5f53\u7136\u8be5\u8d44\u6e90\u5bf9\u8c61\u4e5f\u6709\u5bf9\u5e94\u7684\u66f4\u65b0\u7b56\u7565\uff0c\u6709<code>OnDelete</code>\u548c<code>RollingUpdate</code>\u4e24\u79cd\u65b9\u5f0f\uff0c\u9ed8\u8ba4\u662f\u6eda\u52a8\u66f4\u65b0\u3002</p>"},{"location":"kubernetes_controller/deployment/","title":"Deployment","text":""},{"location":"kubernetes_controller/deployment/#deployment","title":"Deployment \u63a7\u5236\u5668","text":"<p>\u524d\u9762\u6211\u4eec\u5b66\u4e60\u4e86 ReplicaSet \u63a7\u5236\u5668\uff0c\u4e86\u89e3\u5230\u8be5\u63a7\u5236\u5668\u662f\u7528\u6765\u7ef4\u62a4\u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684 Pod \u6570\u91cf\u7684\uff0c\u4f46\u662f\u5f80\u5f80\u5728\u5b9e\u9645\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53cd\u800c\u4e0d\u4f1a\u53bb\u76f4\u63a5\u4f7f\u7528 RS\uff0c\u800c\u662f\u4f1a\u4f7f\u7528\u66f4\u4e0a\u5c42\u7684\u63a7\u5236\u5668\uff0c\u6bd4\u5982\u6211\u4eec\u4eca\u5929\u8981\u5b66\u4e60\u7684\u4e3b\u89d2 Deployment\uff0cDeployment \u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u529f\u80fd\u5c31\u662f\u5b9e\u73b0\u4e86 Pod \u7684\u6c34\u5e73\u6269\u5c55/\u6536\u7f29\uff0c\u6bd4\u5982\u6211\u4eec\u5e94\u7528\u66f4\u65b0\u4e86\uff0c\u6211\u4eec\u53ea\u9700\u8981\u66f4\u65b0\u6211\u4eec\u7684\u5bb9\u5668\u955c\u50cf\uff0c\u7136\u540e\u4fee\u6539 Deployment \u91cc\u9762\u7684 Pod \u6a21\u677f\u955c\u50cf\uff0c\u90a3\u4e48 Deployment \u5c31\u4f1a\u7528<code>\u6eda\u52a8\u66f4\u65b0\uff08Rolling Update\uff09</code>\u7684\u65b9\u5f0f\u6765\u5347\u7ea7\u73b0\u5728\u7684 Pod\uff0c\u8fd9\u4e2a\u80fd\u529b\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u56e0\u4e3a\u5bf9\u4e8e\u7ebf\u4e0a\u7684\u670d\u52a1\u6211\u4eec\u9700\u8981\u505a\u5230\u4e0d\u4e2d\u65ad\u670d\u52a1\uff0c\u6240\u4ee5\u6eda\u52a8\u66f4\u65b0\u5c31\u6210\u4e86\u5fc5\u987b\u7684\u4e00\u4e2a\u529f\u80fd\u3002\u800c Deployment \u8fd9\u4e2a\u80fd\u529b\u7684\u5b9e\u73b0\uff0c\u4f9d\u8d56\u7684\u5c31\u662f\u4e0a\u8282\u8bfe\u6211\u4eec\u5b66\u4e60\u7684 ReplicaSet \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u5b9e\u9645\u4e0a\u6211\u4eec\u53ef\u4ee5\u901a\u4fd7\u7684\u7406\u89e3\u5c31\u662f<code>\u6bcf\u4e2a Deployment \u5c31\u5bf9\u5e94\u96c6\u7fa4\u4e2d\u7684\u4e00\u6b21\u90e8\u7f72</code>\uff0c\u8fd9\u6837\u5c31\u66f4\u597d\u7406\u89e3\u4e86\u3002</p>"},{"location":"kubernetes_controller/deployment/#deployment_1","title":"Deployment","text":"<p>Deployment \u8d44\u6e90\u5bf9\u8c61\u7684\u683c\u5f0f\u548c ReplicaSet \u51e0\u4e4e\u4e00\u81f4\uff0c\u5982\u4e0b\u8d44\u6e90\u5bf9\u8c61\u5c31\u662f\u4e00\u4e2a\u5e38\u89c1\u7684 Deployment \u8d44\u6e90\u7c7b\u578b\uff1a\uff08nginx-deploy.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment  \nmetadata:\n  name:  nginx-deploy\n  namespace: default\nspec:\n  replicas: 3  # \u671f\u671b\u7684 Pod \u526f\u672c\u6570\u91cf\uff0c\u9ed8\u8ba4\u503c\u4e3a1\n  selector:  # Label Selector\uff0c\u5fc5\u987b\u5339\u914d Pod \u6a21\u677f\u4e2d\u7684\u6807\u7b7e\n    matchLabels:\n      app: nginx\n  template:  # Pod \u6a21\u677f\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u5c06\u7c7b\u578b\u66ff\u6362\u6210\u4e86 Deployment\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u6765\u521b\u5efa\u4e0b\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f nginx-deploy.yaml\ndeployment.apps/nginx-deploy created\n$ kubectl get deployment\nNAME           READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy   3/3     3            3           58s\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b Pod \u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx\nNAME                            READY   STATUS    RESTARTS   AGE\nnginx-deploy-85ff79dd56-7r76h   1/1     Running   0          41s\nnginx-deploy-85ff79dd56-d5gjs   1/1     Running   0          41s\nnginx-deploy-85ff79dd56-txc4h   1/1     Running   0          41s\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u53d1\u73b0\u548c\u4e4b\u524d\u7684 RS \u5bf9\u8c61\u662f\u5426\u6ca1\u6709\u4ec0\u4e48\u4e24\u6837\uff0c\u90fd\u662f\u6839\u636e<code>spec.replicas</code>\u6765\u7ef4\u6301\u7684\u526f\u672c\u6570\u91cf\uff0c\u6211\u4eec\u968f\u610f\u67e5\u770b\u4e00\u4e2a Pod \u7684\u63cf\u8ff0\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe pod nginx-deploy-85ff79dd56-txc4h\nName:               nginx-deploy-85ff79dd56-txc4h\nNamespace:          default\nPriority:           0\nPriorityClassName:  &lt;none&gt;\nNode:               ydzs-node1/122\nStart Time:         Sat, 16 Nov 2019 16:01:25 +0800\nLabels:             app=nginx\n                    pod-template-hash=85ff79dd56\nAnnotations:        podpreset.admission.kubernetes.io/podpreset-time-preset: 2062768\nStatus:             Running\nIP:                 2166\nControlled By:      ReplicaSet/nginx-deploy-85ff79dd56\n......\nEvents:\n  Type    Reason     Age        From                 Message\n  ----    ------     ----       ----                 -------\n  Normal  Scheduled  &lt;unknown&gt;  default-scheduler    Successfully assigned default/nginx-deploy-85ff79dd56-txc4h to ydzs-node1\n  Normal  Pulling    2m         kubelet, ydzs-node1  Pulling image \"nginx\"\n  Normal  Pulled     117s       kubelet, ydzs-node1  Successfully pulled image \"nginx\"\n  Normal  Created    117s       kubelet, ydzs-node1  Created container nginx\n  Normal  Started    116s       kubelet, ydzs-node1  Started container nginx\n</code></pre> <p>\u6211\u4eec\u4ed4\u7ec6\u67e5\u770b\u5176\u4e2d\u6709\u8fd9\u6837\u4e00\u4e2a\u4fe1\u606f</p> <pre><code>Controlled By: ReplicaSet/nginx-deploy-85ff79dd56\n</code></pre> <p>\uff0c\u4ec0\u4e48\u610f\u601d\uff1f\u662f\u4e0d\u662f\u8868\u793a\u5f53\u524d\u6211\u4eec\u8fd9\u4e2a Pod \u7684\u63a7\u5236\u5668\u662f\u4e00\u4e2a ReplicaSet \u5bf9\u8c61\u554a\uff0c\u6211\u4eec\u4e0d\u662f\u521b\u5efa\u7684\u4e00\u4e2a Deployment \u5417\uff1f\u4e3a\u4ec0\u4e48 Pod \u4f1a\u88ab RS \u6240\u63a7\u5236\u5462\uff1f\u90a3\u6211\u4eec\u518d\u53bb\u770b\u4e0b\u8fd9\u4e2a\u5bf9\u5e94\u7684 RS \u5bf9\u8c61\u7684\u8be6\u7ec6\u4fe1\u606f\u5982\u4f55\u5462\uff1a</p> <pre><code>$ kubectl describe rs nginx-deploy-85ff79dd56\nName:           nginx-deploy-85ff79dd56\nNamespace:      default\nSelector:       app=nginx,pod-template-hash=85ff79dd56\nLabels:         app=nginx\n                pod-template-hash=85ff79dd56\nAnnotations:    deployment.kubernetes.io/desired-replicas: 3\n                deployment.kubernetes.io/max-replicas: 4\n                deployment.kubernetes.io/revision: 1\nControlled By:  Deployment/nginx-deploy\nReplicas:       3 current / 3 desired\nPods Status:    3 Running / 0 Waiting / 0 Succeeded / 0 Failed\n......\nEvents:\n  Type    Reason            Age    From                   Message\n  ----    ------            ----   ----                   -------\n  Normal  SuccessfulCreate  4m52s  replicaset-controller  Created pod: nginx-deploy-85ff79dd56-7r76h\n  Normal  SuccessfulCreate  4m52s  replicaset-controller  Created pod: nginx-deploy-85ff79dd56-d5gjs\n  Normal  SuccessfulCreate  4m52s  replicaset-controller  Created pod: nginx-deploy-85ff79dd56-txc4h\n</code></pre> <p>\u5176\u4e2d\u6709\u8fd9\u6837\u7684\u4e00\u4e2a\u4fe1\u606f\uff1a</p> <pre><code>Controlled By: Deployment/nginx-deploy\n</code></pre> <p>\uff0c\u660e\u767d\u4e86\u5427\uff1f\u610f\u601d\u5c31\u662f\u6211\u4eec\u7684 Pod \u4f9d\u8d56\u7684\u63a7\u5236\u5668 RS \u5b9e\u9645\u4e0a\u88ab\u6211\u4eec\u7684 Deployment \u63a7\u5236\u7740\u5462\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u4e0b\u56fe\u6765\u8bf4\u660e Pod\u3001ReplicaSet\u3001Deployment \u4e09\u8005\u4e4b\u95f4\u7684\u5173\u7cfb\uff1a</p> <p></p> <p>\u901a\u8fc7\u4e0a\u56fe\u6211\u4eec\u53ef\u4ee5\u5f88\u6e05\u695a\u7684\u770b\u5230\uff0c\u5b9a\u4e49\u4e863\u4e2a\u526f\u672c\u7684 Deployment \u4e0e ReplicaSet \u548c Pod \u7684\u5173\u7cfb\uff0c\u5c31\u662f\u4e00\u5c42\u4e00\u5c42\u8fdb\u884c\u63a7\u5236\u7684\u3002ReplicaSet \u4f5c\u7528\u548c\u4e4b\u524d\u4e00\u6837\u8fd8\u662f\u6765\u4fdd\u8bc1 Pod \u7684\u4e2a\u6570\u59cb\u7ec8\u4fdd\u5b58\u6307\u5b9a\u7684\u6570\u91cf\uff0c\u6240\u4ee5 Deployment \u4e2d\u7684\u5bb9\u5668 <code>restartPolicy=Always</code> \u662f\u552f\u4e00\u7684\u5c31\u662f\u8fd9\u4e2a\u539f\u56e0\uff0c\u56e0\u4e3a\u5bb9\u5668\u5fc5\u987b\u59cb\u7ec8\u4fdd\u8bc1\u81ea\u5df1\u5904\u4e8e Running \u72b6\u6001\uff0cReplicaSet \u624d\u53ef\u4ee5\u53bb\u660e\u786e\u8c03\u6574 Pod \u7684\u4e2a\u6570\u3002\u800c Deployment \u662f\u901a\u8fc7\u7ba1\u7406 ReplicaSet \u7684\u6570\u91cf\u548c\u5c5e\u6027\u6765\u5b9e\u73b0<code>\u6c34\u5e73\u6269\u5c55/\u6536\u7f29</code>\u4ee5\u53ca<code>\u6eda\u52a8\u66f4\u65b0</code>\u4e24\u4e2a\u529f\u80fd\u7684\u3002</p>"},{"location":"kubernetes_controller/deployment/#_1","title":"\u6c34\u5e73\u4f38\u7f29","text":"<p><code>\u6c34\u5e73\u6269\u5c55/\u6536\u7f29</code>\u7684\u529f\u80fd\u6bd4\u8f83\u7b80\u5355\uff0c\u56e0\u4e3a ReplicaSet \u5c31\u53ef\u4ee5\u5b9e\u73b0\uff0c\u6240\u4ee5 Deployment \u63a7\u5236\u5668\u53ea\u9700\u8981\u53bb\u4fee\u6539\u5b83\u7f29\u63a7\u5236\u7684 ReplicaSet \u7684 Pod \u526f\u672c\u6570\u91cf\u5c31\u53ef\u4ee5\u4e86\u3002\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u628a Pod \u7684\u526f\u672c\u8c03\u6574\u5230 4 \u4e2a\uff0c\u90a3\u4e48 Deployment \u6240\u5bf9\u5e94\u7684 ReplicaSet \u5c31\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Pod \u51fa\u6765\uff0c\u8fd9\u6837\u5c31\u6c34\u5e73\u6269\u5c55\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u65b0\u7684\u547d\u4ee4 <code>kubectl scale</code> \u547d\u4ee4\u6765\u5b8c\u6210\u8fd9\u4e2a\u64cd\u4f5c\uff1a</p> <pre><code>$ kubectl scale deployment nginx-deploy --replicas=4\ndeployment.apps/nginx-deployment scaled\n</code></pre> <p>\u6269\u5c55\u5b8c\u6210\u540e\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u7684 RS \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get rs\nNAME                      DESIRED   CURRENT   READY   AGE\nnginx-deploy-85ff79dd56   4         4         3       40m\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u671f\u671b\u7684 Pod \u6570\u91cf\u5df2\u7ecf\u53d8\u6210 4 \u4e86\uff0c\u53ea\u662f Pod \u8fd8\u6ca1\u51c6\u5907\u5b8c\u6210\uff0c\u6240\u4ee5 READY \u72b6\u6001\u6570\u91cf\u8fd8\u662f 3\uff0c\u540c\u6837\u67e5\u770b RS \u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe rs nginx-deploy-85ff79dd56\nName:           nginx-deploy-85ff79dd56\nNamespace:      default\nSelector:       app=nginx,pod-template-hash=85ff79dd56\n......\nEvents:\n  Type    Reason            Age   From                   Message\n  ----    ------            ----  ----                   -------\n  Normal  SuccessfulCreate  40m   replicaset-controller  Created pod: nginx-deploy-85ff79dd56-7r76h\n  Normal  SuccessfulCreate  40m   replicaset-controller  Created pod: nginx-deploy-85ff79dd56-d5gjs\n  Normal  SuccessfulCreate  40m   replicaset-controller  Created pod: nginx-deploy-85ff79dd56-txc4h\n  Normal  SuccessfulCreate  17s   replicaset-controller  Created pod: nginx-deploy-85ff79dd56-tph9g\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 ReplicaSet \u63a7\u5236\u5668\u589e\u52a0\u4e86\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u540c\u6837\u7684 Deployment \u8d44\u6e90\u5bf9\u8c61\u7684\u4e8b\u4ef6\u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u5b8c\u6210\u4e86\u6269\u5bb9\u7684\u64cd\u4f5c\uff1a</p> <pre><code>$ kubectl describe deploy nginx-deploy\nName:                   nginx-deploy\nNamespace:              default\n......\nOldReplicaSets:  &lt;none&gt;\nNewReplicaSet:   nginx-deploy-85ff79dd56 (4/4 replicas created)\nEvents:\n  Type    Reason             Age    From                   Message\n  ----    ------             ----   ----                   -------\n  Normal  ScalingReplicaSet  43m    deployment-controller  Scaled up replica set nginx-deploy-85ff79dd56 to 3\n  Normal  ScalingReplicaSet  3m16s  deployment-controller  Scaled up replica set nginx-deploy-85ff79dd56 to 4\n</code></pre>"},{"location":"kubernetes_controller/deployment/#_2","title":"\u6eda\u52a8\u66f4\u65b0","text":"<p>\u5982\u679c\u53ea\u662f<code>\u6c34\u5e73\u6269\u5c55/\u6536\u7f29</code>\u8fd9\u4e24\u4e2a\u529f\u80fd\uff0c\u5c31\u5b8c\u5168\u6ca1\u5fc5\u8981\u8bbe\u8ba1 Deployment \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u4e86\uff0cDeployment \u6700\u7a81\u51fa\u7684\u4e00\u4e2a\u529f\u80fd\u662f\u652f\u6301<code>\u6eda\u52a8\u66f4\u65b0</code>\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u9700\u8981\u628a\u5e94\u7528\u5bb9\u5668\u66f4\u6539\u4e3a <code>nginx:1.7.9</code> \u7248\u672c\uff0c\u4fee\u6539\u540e\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment  \nmetadata:\n  name:  nginx-deploy\n  namespace: default\nspec:\n  replicas: 3  \n  selector:  \n    matchLabels:\n      app: nginx\n  minReadySeconds: 5\n  strategy:  \n    type: RollingUpdate  # \u6307\u5b9a\u66f4\u65b0\u7b56\u7565\uff1aRollingUpdate\u548cRecreate\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n  template:  \n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - containerPort: 80\n</code></pre> <p>\u540e\u524d\u9762\u76f8\u6bd4\u8f83\uff0c\u9664\u4e86\u66f4\u6539\u4e86\u955c\u50cf\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u6307\u5b9a\u4e86\u66f4\u65b0\u7b56\u7565\uff1a</p> <pre><code>minReadySeconds: 5\nstrategy:\n  type: RollingUpdate\n  rollingUpdate:\n    maxSurge: 1\n    maxUnavailable: 1\n</code></pre> <ul> <li><code>minReadySeconds</code>\uff1a\u8868\u793a Kubernetes \u5728\u7b49\u5f85\u8bbe\u7f6e\u7684\u65f6\u95f4\u540e\u624d\u8fdb\u884c\u5347\u7ea7\uff0c\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\u8be5\u503c\uff0cKubernetes \u4f1a\u5047\u8bbe\u8be5\u5bb9\u5668\u542f\u52a8\u8d77\u6765\u540e\u5c31\u63d0\u4f9b\u670d\u52a1\u4e86\uff0c\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\u8be5\u503c\uff0c\u5728\u67d0\u4e9b\u6781\u7aef\u60c5\u51b5\u4e0b\u53ef\u80fd\u4f1a\u9020\u6210\u670d\u52a1\u4e0d\u6b63\u5e38\u8fd0\u884c\uff0c\u9ed8\u8ba4\u503c\u5c31\u662f0\u3002</li> <li><code>type=RollingUpdate</code>\uff1a\u8868\u793a\u8bbe\u7f6e\u66f4\u65b0\u7b56\u7565\u4e3a\u6eda\u52a8\u66f4\u65b0\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u4e3a<code>Recreate</code>\u548c<code>RollingUpdate</code>\u4e24\u4e2a\u503c\uff0c<code>Recreate</code>\u8868\u793a\u5168\u90e8\u91cd\u65b0\u521b\u5efa\uff0c\u9ed8\u8ba4\u503c\u5c31\u662f<code>RollingUpdate</code>\u3002</li> <li> <p><code>maxSurge</code>\uff1a\u8868\u793a\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u6700\u591a\u53ef\u4ee5\u6bd4\u539f\u5148\u8bbe\u7f6e\u591a\u51fa\u7684 Pod \u6570\u91cf\uff0c\u4f8b\u5982\uff1a</p> <pre><code>maxSurage=1\uff0creplicas=5\n</code></pre> <p>\uff0c\u5c31\u8868\u793aKubernetes \u4f1a\u5148\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u7136\u540e\u624d\u5220\u6389\u4e00\u4e2a\u65e7\u7684 Pod\uff0c\u6574\u4e2a\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u6700\u591a\u4f1a\u6709<code>5+1</code>\u4e2a Pod\u3002 *   <code>maxUnavaible</code>\uff1a\u8868\u793a\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u6700\u591a\u6709\u591a\u5c11\u4e2a Pod \u5904\u4e8e\u65e0\u6cd5\u63d0\u4f9b\u670d\u52a1\u7684\u72b6\u6001\uff0c\u5f53<code>maxSurge</code>\u4e0d\u4e3a0\u65f6\uff0c\u8be5\u503c\u4e5f\u4e0d\u80fd\u4e3a0\uff0c\u4f8b\u5982\uff1a<code>maxUnavaible=1</code>\uff0c\u5219\u8868\u793a Kubernetes \u6574\u4e2a\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u6700\u591a\u4f1a\u67091\u4e2a Pod \u5904\u4e8e\u65e0\u6cd5\u670d\u52a1\u7684\u72b6\u6001\u3002</p> </li> </ul> <p>\u73b0\u5728\u6211\u4eec\u6765\u76f4\u63a5\u66f4\u65b0\u4e0a\u9762\u7684 Deployment \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f nginx-deploy.yaml\n</code></pre> <p>record \u53c2\u6570</p> <p>\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u4e86\u4e00\u4e2a\u989d\u5916\u7684 <code>--record</code> \u53c2\u6570\u6765\u8bb0\u5f55\u4e0b\u6211\u4eec\u7684\u6bcf\u6b21\u64cd\u4f5c\u6240\u6267\u884c\u7684\u547d\u4ee4\uff0c\u4ee5\u65b9\u4fbf\u540e\u9762\u67e5\u770b\u3002</p> <p>\u66f4\u65b0\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684 </p> <pre><code>kubectl rollout status\n</code></pre> <p>\u547d\u4ee4\u6765\u67e5\u770b\u6211\u4eec\u6b64\u6b21\u6eda\u52a8\u66f4\u65b0\u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl rollout status deployment/nginx-deploy\nWaiting for deployment \"nginx-deploy\" rollout to finish: 2 out of 3 new replicas have been updated...\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u4fe1\u606f\u53ef\u4ee5\u770b\u51fa\u6211\u4eec\u7684\u6eda\u52a8\u66f4\u65b0\u5df2\u7ecf\u6709\u4e24\u4e2a Pod \u5df2\u7ecf\u66f4\u65b0\u5b8c\u6210\u4e86\uff0c\u5728\u6eda\u52a8\u66f4\u65b0\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u6267\u884c\u5982\u4e0b\u7684\u547d\u4ee4\u6765\u6682\u505c\u66f4\u65b0\uff1a</p> <pre><code>$ kubectl rollout pause deployment/nginx-deploy\ndeployment.apps/nginx-deploy paused\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u7684\u6eda\u52a8\u66f4\u65b0\u5c31\u6682\u505c\u4e86\uff0c\u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e0b Deployment \u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe deploy nginx-deploy\nName:                   nginx-deploy\nNamespace:              default\nCreationTimestamp:      Sat, 16 Nov 2019 16:01:24 +0800\nLabels:                 &lt;none&gt;\nAnnotations:            deployment.kubernetes.io/revision: 2\n                        kubectl.kubernetes.io/last-applied-configuration:\n                          {\"apiVersion\":\"apps/v1\",\"kind\":\"Deployment\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-deploy\",\"namespace\":\"default\"},\"spec\":{\"minReadySec...\nSelector:               app=nginx\nReplicas:               3 desired | 2 updated | 4 total | 4 available | 0 unavailable\nStrategyType:           RollingUpdate\nMinReadySeconds:        5\nRollingUpdateStrategy:  1 max unavailable, 1 max surge\n......\nOldReplicaSets:  nginx-deploy-85ff79dd56 (2/2 replicas created)\nNewReplicaSet:   nginx-deploy-5b7b9ccb95 (2/2 replicas created)\nEvents:\n  Type    Reason             Age    From                   Message\n  ----    ------             ----   ----                   -------\n  Normal  ScalingReplicaSet  26m    deployment-controller  Scaled up replica set nginx-deploy-85ff79dd56 to 4\n  Normal  ScalingReplicaSet  3m44s  deployment-controller  Scaled down replica set nginx-deploy-85ff79dd56 to 3\n  Normal  ScalingReplicaSet  3m44s  deployment-controller  Scaled up replica set nginx-deploy-5b7b9ccb95 to 1\n  Normal  ScalingReplicaSet  3m44s  deployment-controller  Scaled down replica set nginx-deploy-85ff79dd56 to 2\n  Normal  ScalingReplicaSet  3m44s  deployment-controller  Scaled up replica set nginx-deploy-5b7b9ccb95 to 2\n</code></pre> <p></p> <p>\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf Events \u4e8b\u4ef6\u533a\u57df\u7684\u53d8\u5316\uff0c\u4e0a\u9762\u6211\u4eec\u7528 <code>kubectl scale</code> \u547d\u4ee4\u5c06 Pod \u526f\u672c\u8c03\u6574\u5230\u4e86 4\uff0c\u73b0\u5728\u6211\u4eec\u66f4\u65b0\u7684\u65f6\u5019\u662f\u4e0d\u662f\u58f0\u660e\u53c8\u53d8\u6210 3 \u4e86\uff0c\u6240\u4ee5 Deployment \u63a7\u5236\u5668\u9996\u5148\u662f\u5c06\u4e4b\u524d\u63a7\u5236\u7684 </p> <pre><code>nginx-deploy-85ff79dd56\n</code></pre> <p>\u8fd9\u4e2a RS \u8d44\u6e90\u5bf9\u8c61\u8fdb\u884c\u7f29\u5bb9\u64cd\u4f5c\uff0c\u7136\u540e\u6eda\u52a8\u66f4\u65b0\u5f00\u59cb\u4e86\uff0c\u53ef\u4ee5\u53d1\u73b0 Deployment \u4e3a\u4e00\u4e2a\u65b0\u7684 </p> <pre><code>nginx-deploy-5b7b9ccb95\n</code></pre> <p>RS \u8d44\u6e90\u5bf9\u8c61\u9996\u5148\u65b0\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u7136\u540e\u5c06\u4e4b\u524d\u7684 RS \u5bf9\u8c61\u7f29\u5bb9\u5230 2 \u4e86\uff0c\u518d\u7136\u540e\u65b0\u7684 RS \u5bf9\u8c61\u6269\u5bb9\u5230 2\uff0c\u540e\u9762\u7531\u4e8e\u6211\u4eec\u6682\u505c\u6eda\u52a8\u5347\u7ea7\u4e86\uff0c\u6240\u4ee5\u6ca1\u6709\u540e\u7eed\u7684\u4e8b\u4ef6\u4e86\uff0c\u5927\u5bb6\u6709\u770b\u660e\u767d\u8fd9\u4e2a\u8fc7\u7a0b\u5427\uff1f\u8fd9\u4e2a\u8fc7\u7a0b\u5c31\u662f\u6eda\u52a8\u66f4\u65b0\u7684\u8fc7\u7a0b\uff0c\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u6740\u6389\u4e00\u4e2a\u65e7\u7684 Pod\uff0c\u7136\u540e\u518d\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u8fd9\u6837\u6eda\u52a8\u66f4\u65b0\u4e0b\u53bb\uff0c\u76f4\u5230\u5168\u90fd\u53d8\u6210\u65b0\u7684 Pod\uff0c\u8fd9\u4e2a\u65f6\u5019\u7cfb\u7edf\u4e2d\u5e94\u8be5\u5b58\u5728 4 \u4e2a Pod\uff0c\u56e0\u4e3a\u6211\u4eec\u8bbe\u7f6e\u7684\u7b56\u7565<code>maxSurge=1</code>\uff0c\u6240\u4ee5\u5728\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u662f\u5141\u8bb8\u7684\uff0c\u800c\u4e14\u662f\u4e24\u4e2a\u65b0\u7684 Pod\uff0c\u4e24\u4e2a\u65e7\u7684 Pod\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx\nNAME                            READY   STATUS    RESTARTS   AGE\nnginx-deploy-5b7b9ccb95-k6pkh   1/1     Running   0          11m\nnginx-deploy-5b7b9ccb95-l6lmx   1/1     Running   0          11m\nnginx-deploy-85ff79dd56-7r76h   1/1     Running   0          75m\nnginx-deploy-85ff79dd56-txc4h   1/1     Running   0          75m\n</code></pre> <p>\u67e5\u770b Deployment \u7684\u72b6\u6001\u4e5f\u53ef\u4ee5\u770b\u5230\u5f53\u524d\u7684 Pod \u72b6\u6001\uff1a</p> <pre><code>$ kubectl get deployment  \nNAME           READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy   4/3     2            4           75m\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528</p> <pre><code>kubectl rollout resume\n</code></pre> <p>\u6765\u6062\u590d\u6211\u4eec\u7684\u6eda\u52a8\u66f4\u65b0\uff1a</p> <pre><code>$ kubectl rollout resume deployment/nginx-deploy\ndeployment.apps/nginx-deploy resumed\n$ kubectl rollout status deployment/nginx-deploy\nWaiting for deployment \"nginx-deploy\" rollout to finish: 2 of 3 updated replicas are available...\ndeployment \"nginx-deploy\" successfully rolled out\n</code></pre> <p>\u770b\u5230\u4e0a\u9762\u7684\u4fe1\u606f\u8bc1\u660e\u6211\u4eec\u7684\u6eda\u52a8\u66f4\u65b0\u5df2\u7ecf\u6210\u529f\u4e86\uff0c\u540c\u6837\u53ef\u4ee5\u67e5\u770b\u4e0b\u8d44\u6e90\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pod -l app=nginx\nNAME                            READY   STATUS    RESTARTS   AGE\nnginx-deploy-5b7b9ccb95-gmq7v   1/1     Running   0          115s\nnginx-deploy-5b7b9ccb95-k6pkh   1/1     Running   0          15m\nnginx-deploy-5b7b9ccb95-l6lmx   1/1     Running   0          15m\n$ kubectl get deployment                        \nNAME           READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy   3/3     3            3           79m\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u67e5\u770b ReplicaSet \u5bf9\u8c61\uff0c\u53ef\u4ee5\u53d1\u73b0\u4f1a\u51fa\u73b0\u4e24\u4e2a\uff1a</p> <pre><code>$ kubectl get rs -l app=nginx\nNAME                      DESIRED   CURRENT   READY   AGE\nnginx-deploy-5b7b9ccb95   3         3         3       18m\nnginx-deploy-85ff79dd56   0         0         0       81m\n</code></pre> <p>\u4ece\u4e0a\u9762\u53ef\u4ee5\u770b\u51fa\u6eda\u52a8\u66f4\u65b0\u4e4b\u524d\u6211\u4eec\u4f7f\u7528\u7684 RS \u8d44\u6e90\u5bf9\u8c61\u7684 Pod \u526f\u672c\u6570\u5df2\u7ecf\u53d8\u6210 0 \u4e86\uff0c\u800c\u6eda\u52a8\u66f4\u65b0\u540e\u7684 RS \u8d44\u6e90\u5bf9\u8c61\u53d8\u6210\u4e86 3 \u4e2a\u526f\u672c\uff0c\u6211\u4eec\u53ef\u4ee5\u5bfc\u51fa\u4e4b\u524d\u7684 RS \u5bf9\u8c61\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get rs nginx-deploy-85ff79dd56 -o yaml\napiVersion: apps/v1\nkind: ReplicaSet\nmetadata:\n  annotations:\n    deployment.kubernetes.io/desired-replicas: \"3\"\n    deployment.kubernetes.io/max-replicas: \"4\"\n    deployment.kubernetes.io/revision: \"1\"\n  creationTimestamp: \"2019-11-16T08:01:24Z\"\n  generation: 5\n  labels:\n    app: nginx\n    pod-template-hash: 85ff79dd56\n  name: nginx-deploy-85ff79dd56\n  namespace: default\n  ownerReferences:\n  - apiVersion: apps/v1\n    blockOwnerDeletion: true\n    controller: true\n    kind: Deployment\n    name: nginx-deploy\n    uid: b0fc5614-ef58-496c-9111-740353bd90d4\n  resourceVersion: \"2140545\"\n  selfLink: /apis/apps/v1/namespaces/default/replicasets/nginx-deploy-85ff79dd56\n  uid: 8eca2998-3610-4f80-9c21-5482ba579892\nspec:\n  replicas: 0\n  selector:\n    matchLabels:\n      app: nginx\n      pod-template-hash: 85ff79dd56\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        app: nginx\n        pod-template-hash: 85ff79dd56\n    spec:\n      containers:\n      - image: nginx\n        imagePullPolicy: Always\n        name: nginx\n        ports:\n        - containerPort: 80\n          protocol: TCP\n        resources: {}\n        terminationMessagePath: /dev/termination-log\n        terminationMessagePolicy: File\n      dnsPolicy: ClusterFirst\n      restartPolicy: Always\n      schedulerName: default-scheduler\n      securityContext: {}\n      terminationGracePeriodSeconds: 30\nstatus:\n  observedGeneration: 5\n  replicas: 0\n</code></pre> <p>\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u91cc\u9762\u7684\u63cf\u8ff0\u4fe1\u606f\u9664\u4e86\u526f\u672c\u6570\u53d8\u6210\u4e86<code>replicas=0</code>\u4e4b\u5916\uff0c\u548c\u66f4\u65b0\u4e4b\u524d\u6ca1\u6709\u4ec0\u4e48\u533a\u522b\u5427\uff1f\u5927\u5bb6\u770b\u5230\u8fd9\u91cc\u60f3\u5230\u4e86\u4ec0\u4e48\uff1f\u6709\u4e86\u8fd9\u4e2a RS \u7684\u8bb0\u5f55\u5b58\u5728\uff0c\u662f\u4e0d\u662f\u6211\u4eec\u5c31\u53ef\u4ee5\u56de\u6eda\u4e86\u554a\uff1f\u800c\u4e14\u8fd8\u53ef\u4ee5\u56de\u6eda\u5230\u524d\u9762\u7684\u4efb\u610f\u4e00\u4e2a\u7248\u672c\uff0c\u8fd9\u4e2a\u7248\u672c\u662f\u5982\u4f55\u5b9a\u4e49\u7684\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 <code>rollout history</code> \u6765\u83b7\u53d6\uff1a</p> <pre><code>$ kubectl rollout history deployment nginx-deploy\ndeployment.apps/nginx-deploy \nREVISION  CHANGE-CAUSE\n1         &lt;none&gt;\n2         &lt;none&gt;\n</code></pre> <p>\u5176\u5b9e <code>rollout history</code> \u4e2d\u8bb0\u5f55\u7684 <code>revision</code> \u662f\u548c <code>ReplicaSets</code> \u4e00\u4e00\u5bf9\u5e94\u3002\u5982\u679c\u6211\u4eec\u624b\u52a8\u5220\u9664\u67d0\u4e2a <code>ReplicaSet</code>\uff0c\u5bf9\u5e94\u7684<code>rollout history</code>\u5c31\u4f1a\u88ab\u5220\u9664\uff0c\u4e5f\u5c31\u662f\u8bf4\u4f60\u65e0\u6cd5\u56de\u6eda\u5230\u8fd9\u4e2a<code>revison</code>\u4e86\uff0c\u540c\u6837\u6211\u4eec\u8fd8\u53ef\u4ee5\u67e5\u770b\u4e00\u4e2a<code>revison</code>\u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl rollout history deployment nginx-deploy --revision=1 \ndeployment.apps/nginx-deploy with revision #1\nPod Template:\n  Labels:       app=nginx\n        pod-template-hash=85ff79dd56\n  Containers:\n   nginx:\n    Image:      nginx\n    Port:       80/TCP\n    Host Port:  0/TCP\n    Environment:        &lt;none&gt;\n    Mounts:     &lt;none&gt;\n  Volumes:      &lt;none&gt;\n</code></pre> <p>\u5047\u5982\u73b0\u5728\u8981\u76f4\u63a5\u56de\u9000\u5230\u5f53\u524d\u7248\u672c\u7684\u524d\u4e00\u4e2a\u7248\u672c\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u64cd\u4f5c\uff1a</p> <pre><code>$ kubectl rollout undo deployment nginx-deploy\n</code></pre> <p>\u5f53\u7136\u4e5f\u53ef\u4ee5\u56de\u9000\u5230\u6307\u5b9a\u7684<code>revision</code>\u7248\u672c\uff1a</p> <pre><code>$ kubectl rollout undo deployment nginx-deploy --to-revision=1\ndeployment \"nginx-deploy\" rolled back\n</code></pre> <p>\u56de\u6eda\u7684\u8fc7\u7a0b\u4e2d\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u67e5\u770b\u56de\u6eda\u72b6\u6001\uff1a</p> <pre><code>$ kubectl rollout status deployment/nginx-deploy\nWaiting for deployment \"nginx-deploy\" rollout to finish: 1 old replicas are pending termination...\nWaiting for deployment \"nginx-deploy\" rollout to finish: 1 old replicas are pending termination...\nWaiting for deployment \"nginx-deploy\" rollout to finish: 1 old replicas are pending termination...\nWaiting for deployment \"nginx-deploy\" rollout to finish: 2 of 3 updated replicas are available...\nWaiting for deployment \"nginx-deploy\" rollout to finish: 2 of 3 updated replicas are available...\ndeployment \"nginx-deploy\" successfully rolled out\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u67e5\u770b\u5bf9\u5e94\u7684 RS \u8d44\u6e90\u5bf9\u8c61\u53ef\u4ee5\u770b\u5230 Pod \u526f\u672c\u5df2\u7ecf\u56de\u5230\u4e4b\u524d\u7684 RS \u91cc\u9762\u53bb\u4e86\u3002</p> <pre><code>$ kubectl get rs -l app=nginx\nNAME                      DESIRED   CURRENT   READY   AGE\nnginx-deploy-5b7b9ccb95   0         0         0       31m\nnginx-deploy-85ff79dd56   3         3         3       95m\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u56de\u6eda\u7684\u64cd\u4f5c\u6eda\u52a8\u7684<code>revision</code>\u59cb\u7ec8\u662f\u9012\u589e\u7684\uff1a</p> <pre><code>$ kubectl rollout history deployment nginx-deploy\ndeployment.apps/nginx-deploy \nREVISION  CHANGE-CAUSE\n2         &lt;none&gt;\n3         &lt;none&gt;\n</code></pre> <p>\u4fdd\u7559\u65e7\u7248\u672c</p> <p>\u5728\u5f88\u65e9\u4e4b\u524d\u7684 Kubernetes \u7248\u672c\u4e2d\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f1a\u4e3a\u6211\u4eec\u66b4\u9732\u4e0b\u6240\u6709\u6eda\u52a8\u5347\u7ea7\u7684\u5386\u53f2\u8bb0\u5f55\uff0c\u4e5f\u5c31\u662f ReplicaSet \u5bf9\u8c61\uff0c\u4f46\u4e00\u822c\u60c5\u51b5\u4e0b\u6ca1\u5fc5\u8981\u4fdd\u7559\u6240\u6709\u7684\u7248\u672c\uff0c\u6bd5\u7adf\u4f1a\u5b58\u5728 etcd \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e </p> <pre><code>spec.revisionHistoryLimit\n</code></pre> <p>\u5c5e\u6027\u6765\u8bbe\u7f6e\u4fdd\u7559\u7684\u5386\u53f2\u8bb0\u5f55\u6570\u91cf\uff0c\u4e0d\u8fc7\u65b0\u7248\u672c\u4e2d\u8be5\u503c\u9ed8\u8ba4\u4e3a 10\uff0c\u5982\u679c\u5e0c\u671b\u591a\u4fdd\u5b58\u51e0\u4e2a\u7248\u672c\u53ef\u4ee5\u8bbe\u7f6e\u8be5\u5b57\u6bb5\u3002</p>"},{"location":"kubernetes_controller/hpa/","title":"HPA","text":""},{"location":"kubernetes_controller/hpa/#hpa","title":"HPA \u63a7\u5236\u5668","text":"<p>\u5728\u524d\u9762\u7684\u5b66\u4e60\u4e2d\u6211\u4eec\u4f7f\u7528\u7528\u4e00\u4e2a <code>kubectl scale</code> \u547d\u4ee4\u53ef\u4ee5\u6765\u5b9e\u73b0 Pod \u7684\u6269\u7f29\u5bb9\u529f\u80fd\uff0c\u4f46\u662f\u8fd9\u4e2a\u6bd5\u7adf\u662f\u5b8c\u5168\u624b\u52a8\u64cd\u4f5c\u7684\uff0c\u8981\u5e94\u5bf9\u7ebf\u4e0a\u7684\u5404\u79cd\u590d\u6742\u60c5\u51b5\uff0c\u6211\u4eec\u9700\u8981\u80fd\u591f\u505a\u5230\u81ea\u52a8\u5316\u53bb\u611f\u77e5\u4e1a\u52a1\uff0c\u6765\u81ea\u52a8\u8fdb\u884c\u6269\u7f29\u5bb9\u3002\u4e3a\u6b64\uff0cKubernetes \u4e5f\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u8fd9\u6837\u7684\u4e00\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a<code>Horizontal Pod Autoscaling\uff08Pod \u6c34\u5e73\u81ea\u52a8\u4f38\u7f29\uff09</code>\uff0c\u7b80\u79f0<code>HPA</code>\uff0cHPA \u901a\u8fc7\u76d1\u63a7\u5206\u6790\u4e00\u4e9b\u63a7\u5236\u5668\u63a7\u5236\u7684\u6240\u6709 Pod \u7684\u8d1f\u8f7d\u53d8\u5316\u60c5\u51b5\u6765\u786e\u5b9a\u662f\u5426\u9700\u8981\u8c03\u6574 Pod \u7684\u526f\u672c\u6570\u91cf\uff0c\u8fd9\u662f HPA \u6700\u57fa\u672c\u7684\u539f\u7406\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u7684\u901a\u8fc7 <code>kubectl autoscale</code> \u547d\u4ee4\u6765\u521b\u5efa\u4e00\u4e2a HPA \u8d44\u6e90\u5bf9\u8c61\uff0c<code>HPA Controller</code>\u9ed8\u8ba4<code>30s</code>\u8f6e\u8be2\u4e00\u6b21\uff08\u53ef\u901a\u8fc7 <code>kube-controller-manager</code> \u7684<code>--horizontal-pod-autoscaler-sync-period</code> \u53c2\u6570\u8fdb\u884c\u8bbe\u7f6e\uff09\uff0c\u67e5\u8be2\u6307\u5b9a\u7684\u8d44\u6e90\u4e2d\u7684 Pod \u8d44\u6e90\u4f7f\u7528\u7387\uff0c\u5e76\u4e14\u4e0e\u521b\u5efa\u65f6\u8bbe\u5b9a\u7684\u503c\u548c\u6307\u6807\u505a\u5bf9\u6bd4\uff0c\u4ece\u800c\u5b9e\u73b0\u81ea\u52a8\u4f38\u7f29\u7684\u529f\u80fd\u3002</p>"},{"location":"kubernetes_controller/hpa/#metrics-server","title":"Metrics Server","text":"<p>\u5728 HPA \u7684\u7b2c\u4e00\u4e2a\u7248\u672c\u4e2d\uff0c\u6211\u4eec\u9700\u8981 <code>Heapster</code> \u63d0\u4f9b CPU \u548c\u5185\u5b58\u6307\u6807\uff0c\u5728 HPA v2 \u8fc7\u540e\u5c31\u9700\u8981\u5b89\u88c5 Metrcis Server \u4e86\uff0c<code>Metrics Server</code> \u53ef\u4ee5\u901a\u8fc7\u6807\u51c6\u7684 Kubernetes API \u628a\u76d1\u63a7\u6570\u636e\u66b4\u9732\u51fa\u6765\uff0c\u6709\u4e86 <code>Metrics Server</code> \u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7\u6807\u51c6\u7684 Kubernetes API \u6765\u8bbf\u95ee\u6211\u4eec\u60f3\u8981\u83b7\u53d6\u7684\u76d1\u63a7\u6570\u636e\u4e86\uff1a </p><pre><code>https://10.96.0.1/apis/metrics.k8s.io/v1beta1/namespaces/&lt;namespace-name&gt;/pods/&lt;pod-name&gt;</code></pre><p></p> <p>\u6bd4\u5982\u5f53\u6211\u4eec\u8bbf\u95ee\u4e0a\u9762\u7684 API \u7684\u65f6\u5019\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u83b7\u53d6\u5230\u8be5 Pod \u7684\u8d44\u6e90\u6570\u636e\uff0c\u8fd9\u4e9b\u6570\u636e\u5176\u5b9e\u662f\u6765\u81ea\u4e8e kubelet \u7684 <code>Summary API</code> \u91c7\u96c6\u800c\u6765\u7684\u3002\u4e0d\u8fc7\u9700\u8981\u8bf4\u660e\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u53ef\u4ee5\u901a\u8fc7\u6807\u51c6\u7684 API \u6765\u83b7\u53d6\u8d44\u6e90\u76d1\u63a7\u6570\u636e\uff0c\u5e76\u4e0d\u662f\u56e0\u4e3a <code>Metrics Server</code> \u5c31\u662f APIServer \u7684\u4e00\u90e8\u5206\uff0c\u800c\u662f\u901a\u8fc7 Kubernetes \u63d0\u4f9b\u7684 <code>Aggregator</code> \u6c47\u805a\u63d2\u4ef6\u6765\u5b9e\u73b0\u7684\uff0c\u662f\u72ec\u7acb\u4e8e APIServer \u4e4b\u5916\u8fd0\u884c\u7684\u3002</p> <p></p>"},{"location":"kubernetes_controller/hpa/#api","title":"\u805a\u5408 API","text":"<p><code>Aggregator</code> \u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u7f16\u5199\u4e00\u4e2a\u81ea\u5df1\u7684\u670d\u52a1\uff0c\u628a\u8fd9\u4e2a\u670d\u52a1\u6ce8\u518c\u5230 Kubernetes \u7684 APIServer \u91cc\u9762\u53bb\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u50cf\u539f\u751f\u7684 APIServer \u63d0\u4f9b\u7684 API \u4f7f\u7528\u81ea\u5df1\u7684 API \u4e86\uff0c\u6211\u4eec\u628a\u81ea\u5df1\u7684\u670d\u52a1\u8fd0\u884c\u5728 Kubernetes \u96c6\u7fa4\u91cc\u9762\uff0c\u7136\u540e Kubernetes \u7684 <code>Aggregator</code> \u901a\u8fc7 Service \u540d\u79f0\u5c31\u53ef\u4ee5\u8f6c\u53d1\u5230\u6211\u4eec\u81ea\u5df1\u5199\u7684 Service \u91cc\u9762\u53bb\u4e86\u3002\u8fd9\u6837\u8fd9\u4e2a\u805a\u5408\u5c42\u5c31\u5e26\u6765\u4e86\u5f88\u591a\u597d\u5904\uff1a</p> <ul> <li>\u589e\u52a0\u4e86 API \u7684\u6269\u5c55\u6027\uff0c\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u7f16\u5199\u81ea\u5df1\u7684 API \u670d\u52a1\u6765\u66b4\u9732\u4ed6\u4eec\u60f3\u8981\u7684 API\u3002</li> <li>\u4e30\u5bcc\u4e86 API\uff0c\u6838\u5fc3 kubernetes \u56e2\u961f\u963b\u6b62\u4e86\u5f88\u591a\u65b0\u7684 API \u63d0\u6848\uff0c\u901a\u8fc7\u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u5c06\u4ed6\u4eec\u7684 API \u4f5c\u4e3a\u5355\u72ec\u7684\u670d\u52a1\u516c\u5f00\uff0c\u8fd9\u6837\u5c31\u65e0\u987b\u793e\u533a\u7e41\u6742\u7684\u5ba1\u67e5\u4e86\u3002</li> <li>\u5f00\u53d1\u5206\u9636\u6bb5\u5b9e\u9a8c\u6027 API\uff0c\u65b0\u7684 API \u53ef\u4ee5\u5728\u5355\u72ec\u7684\u805a\u5408\u670d\u52a1\u4e2d\u5f00\u53d1\uff0c\u5f53\u5b83\u7a33\u5b9a\u4e4b\u540e\uff0c\u5728\u5408\u5e76\u4f1a APIServer \u5c31\u5f88\u5bb9\u6613\u4e86\u3002</li> <li>\u786e\u4fdd\u65b0 API \u9075\u5faa Kubernetes \u7ea6\u5b9a\uff0c\u5982\u679c\u6ca1\u6709\u8fd9\u91cc\u63d0\u51fa\u7684\u673a\u5236\uff0c\u793e\u533a\u6210\u5458\u53ef\u80fd\u4f1a\u88ab\u8feb\u63a8\u51fa\u81ea\u5df1\u7684\u4e1c\u897f\uff0c\u8fd9\u6837\u5f88\u53ef\u80fd\u9020\u6210\u793e\u533a\u6210\u5458\u548c\u793e\u533a\u7ea6\u5b9a\u4e0d\u4e00\u81f4\u3002</li> </ul>"},{"location":"kubernetes_controller/hpa/#_1","title":"\u5b89\u88c5","text":"<p>\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u8981\u4f7f\u7528 HPA\uff0c\u5c31\u9700\u8981\u5728\u96c6\u7fa4\u4e2d\u5b89\u88c5 <code>Metrics Server</code> \u670d\u52a1\uff0c\u8981\u5b89\u88c5 <code>Metrics Server</code> \u5c31\u9700\u8981\u5f00\u542f <code>Aggregator</code>\uff0c\u56e0\u4e3a <code>Metrics Server</code> \u5c31\u662f\u901a\u8fc7\u8be5\u4ee3\u7406\u8fdb\u884c\u6269\u5c55\u7684\uff0c\u4e0d\u8fc7\u6211\u4eec\u96c6\u7fa4\u662f\u901a\u8fc7 Kubeadm \u642d\u5efa\u7684\uff0c\u9ed8\u8ba4\u5df2\u7ecf\u5f00\u542f\u4e86\uff0c\u5982\u679c\u662f\u4e8c\u8fdb\u5236\u65b9\u5f0f\u5b89\u88c5\u7684\u96c6\u7fa4\uff0c\u9700\u8981\u5355\u72ec\u914d\u7f6e kube-apsierver \u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u53c2\u6570\uff1a </p><pre><code>--requestheader-client-ca-file=&lt;path to aggregator CA cert&gt;\n--requestheader-allowed-names=aggregator\n--requestheader-extra-headers-prefix=X-Remote-Extra-\n--requestheader-group-headers=X-Remote-Group\n--requestheader-username-headers=X-Remote-User\n--proxy-client-cert-file=&lt;path to aggregator proxy cert&gt;\n--proxy-client-key-file=&lt;path to aggregator proxy key&gt;</code></pre><p></p> <p>\u5982\u679c <code>kube-proxy</code> \u6ca1\u6709\u548c APIServer \u8fd0\u884c\u5728\u540c\u4e00\u53f0\u4e3b\u673a\u4e0a\uff0c\u90a3\u4e48\u9700\u8981\u786e\u4fdd\u542f\u7528\u4e86\u5982\u4e0b kube-apsierver \u7684\u53c2\u6570\uff1a </p><pre><code>--enable-aggregator-routing=true</code></pre><p></p> <p>\u5bf9\u4e8e\u8fd9\u4e9b\u8bc1\u4e66\u7684\u751f\u6210\u65b9\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863\uff1ahttps://github.com/kubernetes-sigs/apiserver-builder-alpha/blob/master/docs/concepts/auth.md\u3002</p> <p><code>Aggregator</code> \u805a\u5408\u5c42\u542f\u52a8\u5b8c\u6210\u540e\uff0c\u5c31\u53ef\u4ee5\u6765\u5b89\u88c5 <code>Metrics Server</code> \u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u83b7\u53d6\u8be5\u4ed3\u5e93\u7684\u5b98\u65b9\u5b89\u88c5\u8d44\u6e90\u6e05\u5355\uff1a </p><pre><code># \u5b98\u65b9\u4ed3\u5e93\u5730\u5740\uff1ahttps://github.com/kubernetes-sigs/metrics-server\n$ wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.6/components.yaml</code></pre><p></p> <p>\u5728\u90e8\u7f72\u4e4b\u524d\uff0c\u4fee\u6539 <code>components.yaml</code> \u7684\u955c\u50cf\u5730\u5740\u4e3a\uff1a </p><pre><code>hostNetwork: true  # \u4f7f\u7528hostNetwork\u6a21\u5f0f\ncontainers:\n- name: metrics-server\n  image: registry.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</code></pre><p></p> <p>\u7b49\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u67e5\u770b Pod \u65e5\u5fd7\u662f\u5426\u6b63\u5e38\uff1a </p><pre><code>$ kubectl apply -f components.yaml\n$ kubectl get pods -n kube-system -l k8s-app=metrics-server\nNAME                              READY   STATUS    RESTARTS   AGE\nmetrics-server-6886856d7c-g5k6q   1/1     Running   0          2m39s\n$ kubectl logs -f metrics-server-6886856d7c-g5k6q -n kube-system\n......\nE1119 09:05:57.234312       1 manager.go:111] unable to fully collect metrics: [unable to fully scrape metrics from source kubelet_summary:ydzs-node1: unable to fetch metrics from Kubelet ydzs-node1 (ydzs-node1): Get https://ydzs-node1:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup ydzs-node1 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:ydzs-node4: unable to fetch metrics from Kubelet ydzs-node4 (ydzs-node4): Get https://ydzs-node4:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup ydzs-node4 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:ydzs-node3: unable to fetch metrics from Kubelet ydzs-node3 (ydzs-node3): Get https://ydzs-node3:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup ydzs-node3 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:ydzs-master: unable to fetch metrics from Kubelet ydzs-master (ydzs-master): Get https://ydzs-master:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup ydzs-master on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:ydzs-node2: unable to fetch metrics from Kubelet ydzs-node2 (ydzs-node2): Get https://ydzs-node2:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup ydzs-node2 on 10.96.0.10:53: no such host]</code></pre><p></p> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 Pod \u4e2d\u51fa\u73b0\u4e86\u4e00\u4e9b\u9519\u8bef\u4fe1\u606f\uff1a<code>xxx: no such host</code>\uff0c\u6211\u4eec\u770b\u5230\u8fd9\u4e2a\u9519\u8bef\u4fe1\u606f\u4e00\u822c\u5c31\u53ef\u4ee5\u786e\u5b9a\u662f DNS \u89e3\u6790\u4e0d\u4e86\u9020\u6210\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Metrics Server \u4f1a\u901a\u8fc7 kubelet \u7684 10250 \u7aef\u53e3\u83b7\u53d6\u4fe1\u606f\uff0c\u4f7f\u7528\u7684\u662f hostname\uff0c\u6211\u4eec\u90e8\u7f72\u96c6\u7fa4\u7684\u65f6\u5019\u5728\u8282\u70b9\u7684 <code>/etc/hosts</code> \u91cc\u9762\u6dfb\u52a0\u4e86\u8282\u70b9\u7684 hostname \u548c ip \u7684\u6620\u5c04\uff0c\u4f46\u662f\u662f\u6211\u4eec\u7684 Metrics Server \u7684 Pod \u5185\u90e8\u5e76\u6ca1\u6709\u8fd9\u4e2a hosts \u4fe1\u606f\uff0c\u5f53\u7136\u4e5f\u5c31\u4e0d\u8bc6\u522b hostname \u4e86\uff0c\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6709\u4e24\u79cd\u65b9\u6cd5\uff1a</p> <p>\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5728\u96c6\u7fa4\u5185\u90e8\u7684 DNS \u670d\u52a1\u91cc\u9762\u6dfb\u52a0\u4e0a hostname \u7684\u89e3\u6790\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u96c6\u7fa4\u4e2d\u4f7f\u7528\u7684\u662f <code>CoreDNS</code>\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u53bb\u4fee\u6539\u4e0b CoreDNS \u7684 Configmap \u4fe1\u606f\uff0c\u6dfb\u52a0\u4e0a hosts \u4fe1\u606f\uff1a </p><pre><code>$ kubectl edit configmap coredns -n kube-system\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health\n        hosts {  # \u6dfb\u52a0\u96c6\u7fa4\u8282\u70b9hosts\u9690\u5c04\u4fe1\u606f\n          10.151.30.11 ydzs-master\n          10.151.30.57 ydzs-node3\n          10.151.30.59 ydzs-node4\n          10.151.30.22 ydzs-node1\n          10.151.30.23 ydzs-node2\n          fallthrough\n        }\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n           pods insecure\n           upstream\n           fallthrough in-addr.arpa ip6.arpa\n        }\n        prometheus :9153\n        proxy . /etc/resolv.conf\n        cache 30\n        reload\n    }\nkind: ConfigMap\nmetadata:\n  creationTimestamp: 2019-05-18T11:07:46Z\n  name: coredns\n  namespace: kube-system</code></pre><p></p> <p>\u8fd9\u6837\u5f53\u5728\u96c6\u7fa4\u5185\u90e8\u8bbf\u95ee\u96c6\u7fa4\u7684 hostname \u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u89e3\u6790\u5230\u5bf9\u5e94\u7684 ip \u4e86\uff0c\u53e6\u5916\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5728 metrics-server \u7684\u542f\u52a8\u53c2\u6570\u4e2d\u4fee\u6539 <code>kubelet-preferred-address-types</code> \u53c2\u6570\uff0c\u5982\u4e0b\uff1a </p><pre><code>args:\n- --cert-dir=/tmp\n- --secure-port=4443\n- --kubelet-preferred-address-types=InternalIP</code></pre><p></p> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7b2c\u4e8c\u79cd\u65b9\u5f0f\uff0c\u7136\u540e\u91cd\u65b0\u5b89\u88c5\uff1a </p><pre><code>$ kubectl get pods -n kube-system -l k8s-app=metrics-server\nNAME                              READY   STATUS        RESTARTS   AGE\nmetrics-server-6dcfdf89b5-tvdcp   1/1     Running       0          33s\n$ kubectl logs -f metric-metrics-server-58fc94d9f-jlxcb -n kube-system\n......\nE1119 09:08:49.805959       1 manager.go:111] unable to fully collect metrics: [unable to fully scrape metrics from source kubelet_summary:ydzs-node3: unable to fetch metrics from Kubelet ydzs-node3 (10.151.30.57): Get https://10.151.30.57:10250/stats/summary?only_cpu_and_memory=true: x509: cannot validate certificate for 10.151.30.57 because it doesn't contain any IP SANs, unable to fully scrape metrics from source kubelet_summary:ydzs-node4: unable to fetch metrics from Kubelet ydzs-node4 (10.151.30.59): Get https://10.151.30.59:10250/stats/summary?only_cpu_and_memory=true: x509: cannot validate certificate for 10.151.30.59 because it doesn't contain any IP SANs, unable to fully scrape metrics from source kubelet_summary:ydzs-node2: unable to fetch metrics from Kubelet ydzs-node2 (10.151.30.23): Get https://10.151.30.23:10250/stats/summary?only_cpu_and_memory=true: x509: cannot validate certificate for 10.151.30.23 because it doesn't contain any IP SANs, unable to fully scrape metrics from source kubelet_summary:ydzs-master: unable to fetch metrics from Kubelet ydzs-master (10.151.30.11): Get https://10.151.30.11:10250/stats/summary?only_cpu_and_memory=true: x509: cannot validate certificate for 10.151.30.11 because it doesn't contain any IP SANs, unable to fully scrape metrics from source kubelet_summary:ydzs-node1: unable to fetch metrics from Kubelet ydzs-node1 (10.151.30.22): Get https://10.151.30.22:10250/stats/summary?only_cpu_and_memory=true: x509: cannot validate certificate for 10.151.30.22 because it doesn't contain any IP SANs]</code></pre><p></p> <p>\u56e0\u4e3a\u90e8\u7f72\u96c6\u7fa4\u7684\u65f6\u5019\uff0cCA \u8bc1\u4e66\u5e76\u6ca1\u6709\u628a\u5404\u4e2a\u8282\u70b9\u7684 IP \u7b7e\u4e0a\u53bb\uff0c\u6240\u4ee5\u8fd9\u91cc <code>Metrics Server</code> \u901a\u8fc7 IP \u53bb\u8bf7\u6c42\u65f6\uff0c\u63d0\u793a\u7b7e\u7684\u8bc1\u4e66\u6ca1\u6709\u5bf9\u5e94\u7684 IP\uff08\u9519\u8bef\uff1a<code>x509: cannot validate certificate for 10.151.30.22 because it doesn\u2019t contain any IP SANs</code>\uff09\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a<code>--kubelet-insecure-tls</code>\u53c2\u6570\u8df3\u8fc7\u8bc1\u4e66\u6821\u9a8c\uff1a </p><pre><code>args:\n- --cert-dir=/tmp\n- --secure-port=4443\n- --kubelet-insecure-tls\n- --kubelet-preferred-address-types=InternalIP</code></pre><p></p> <p>\u7136\u540e\u518d\u91cd\u65b0\u5b89\u88c5\u5373\u53ef\u6210\u529f\uff01\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u6765\u9a8c\u8bc1\uff1a </p><pre><code>$ kubectl apply -f components.yaml\n$ kubectl get pods -n kube-system -l k8s-app=metrics-server\nNAME                              READY   STATUS    RESTARTS   AGE\nmetrics-server-5d4dbb78bb-6klw6   1/1     Running   0          14s\n$ kubectl logs -f metrics-server-5d4dbb78bb-6klw6 -n kube-system\nI1119 09:10:44.249092       1 serving.go:312] Generated self-signed cert (/tmp/apiserver.crt, /tmp/apiserver.key)\nI1119 09:10:45.264076       1 secure_serving.go:116] Serving securely on [::]:4443\n$ kubectl get apiservice | grep metrics\nv1beta1.metrics.k8s.io                 kube-system/metrics-server   True        9m\n$ kubectl get --raw \"/apis/metrics.k8s.io/v1beta1/nodes\"\n{\"kind\":\"NodeMetricsList\",\"apiVersion\":\"metrics.k8s.io/v1beta1\",\"metadata\":{\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes\"},\"items\":[{\"metadata\":{\"name\":\"ydzs-node3\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/ydzs-node3\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:38Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"240965441n\",\"memory\":\"3004360Ki\"}},{\"metadata\":{\"name\":\"ydzs-node4\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/ydzs-node4\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:37Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"167036681n\",\"memory\":\"2574664Ki\"}},{\"metadata\":{\"name\":\"ydzs-master\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/ydzs-master\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:38Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"350907350n\",\"memory\":\"2986716Ki\"}},{\"metadata\":{\"name\":\"ydzs-node1\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/ydzs-node1\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:39Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"1319638039n\",\"memory\":\"2094376Ki\"}},{\"metadata\":{\"name\":\"ydzs-node2\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/ydzs-node2\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:36Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"320381888n\",\"memory\":\"3270368Ki\"}}]}\n$ kubectl top nodes\nNAME          CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   \nydzs-master   351m         17%    2916Mi          79%       \nydzs-node1    1320m        33%    2045Mi          26%       \nydzs-node2    321m         8%     3193Mi          41%       \nydzs-node3    241m         6%     2933Mi          37%       \nydzs-node4    168m         4%     2514Mi          32% </code></pre><p></p> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>kubectl top</code> \u547d\u4ee4\u6765\u83b7\u53d6\u5230\u8d44\u6e90\u6570\u636e\u4e86\uff0c\u8bc1\u660e <code>Metrics Server</code> \u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\u3002</p>"},{"location":"kubernetes_controller/hpa/#hpa_1","title":"HPA","text":"<p>\u73b0\u5728\u6211\u4eec\u7528 Deployment \u6765\u521b\u5efa\u4e00\u4e2a Nginx Pod\uff0c\u7136\u540e\u5229\u7528 <code>HPA</code> \u6765\u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\u3002\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a\uff08hpa-demo.yaml\uff09 </p><pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hpa-demo\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80</code></pre><p></p> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa Deployment\uff1a </p><pre><code>$ kubectl apply -f hpa-demo.yaml\ndeployment.apps/hpa-demo created\n$ kubectl get pods -l app=nginx\nNAME                        READY   STATUS    RESTARTS   AGE\nhpa-demo-85ff79dd56-pz8th   1/1     Running   0          21s</code></pre><p></p> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a <code>HPA</code> \u8d44\u6e90\u5bf9\u8c61\uff0c\u53ef\u4ee5\u4f7f\u7528<code>kubectl autoscale</code>\u547d\u4ee4\u6765\u521b\u5efa\uff1a </p><pre><code>$ kubectl autoscale deployment hpa-demo --cpu-percent=10 --min=1 --max=10\nhorizontalpodautoscaler.autoscaling/hpa-demo autoscaled\n$ kubectl get hpa\nNAME       REFERENCE             TARGETS         MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   &lt;unknown&gt;/10%   1         10        1          16s</code></pre><p></p> <p>\u6b64\u547d\u4ee4\u521b\u5efa\u4e86\u4e00\u4e2a\u5173\u8054\u8d44\u6e90 hpa-demo \u7684 HPA\uff0c\u6700\u5c0f\u7684 Pod \u526f\u672c\u6570\u4e3a1\uff0c\u6700\u5927\u4e3a10\u3002HPA \u4f1a\u6839\u636e\u8bbe\u5b9a\u7684 cpu \u4f7f\u7528\u7387\uff0810%\uff09\u52a8\u6001\u7684\u589e\u52a0\u6216\u8005\u51cf\u5c11 Pod \u6570\u91cf\u3002</p> <p>\u5f53\u7136\u6211\u4eec\u4f9d\u7136\u8fd8\u662f\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa YAML \u6587\u4ef6\u7684\u5f62\u5f0f\u6765\u521b\u5efa HPA \u8d44\u6e90\u5bf9\u8c61\u3002\u5982\u679c\u6211\u4eec\u4e0d\u77e5\u9053\u600e\u4e48\u7f16\u5199\u7684\u8bdd\uff0c\u53ef\u4ee5\u67e5\u770b\u4e0a\u9762\u547d\u4ee4\u884c\u521b\u5efa\u7684HPA\u7684YAML\u6587\u4ef6\uff1a </p><pre><code>$ kubectl get hpa hpa-demo -o yaml\napiVersion: autoscaling/v1\nkind: HorizontalPodAutoscaler\nmetadata:\n  annotations:\n    autoscaling.alpha.kubernetes.io/conditions: '[{\"type\":\"AbleToScale\",\"status\":\"True\",\"lastTransitionTime\":\"2019-11-19T09:15:12Z\",\"reason\":\"SucceededGetScale\",\"message\":\"the\n      HPA controller was able to get the target''s current scale\"},{\"type\":\"ScalingActive\",\"status\":\"False\",\"lastTransitionTime\":\"2019-11-19T09:15:12Z\",\"reason\":\"FailedGetResourceMetric\",\"message\":\"the\n      HPA was unable to compute the replica count: missing request for cpu\"}]'\n  creationTimestamp: \"2019-11-19T09:14:56Z\"\n  name: hpa-demo\n  namespace: default\n  resourceVersion: \"3094084\"\n  selfLink: /apis/autoscaling/v1/namespaces/default/horizontalpodautoscalers/hpa-demo\n  uid: b84d79f1-75b0-46e0-95b5-4cbe3509233b\nspec:\n  maxReplicas: 10\n  minReplicas: 1\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: hpa-demo\n  targetCPUUtilizationPercentage: 10\nstatus:\n  currentReplicas: 1\n  desiredReplicas: 0</code></pre><p></p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u5c31\u53ef\u4ee5\u81ea\u5df1\u6765\u521b\u5efa\u4e00\u4e2a\u57fa\u4e8e YAML \u7684 HPA \u63cf\u8ff0\u6587\u4ef6\u4e86\u3002\u4f46\u662f\u6211\u4eec\u53d1\u73b0\u4e0a\u9762\u4fe1\u606f\u91cc\u9762\u51fa\u73b0\u4e86\u4e00\u4e9b Fail \u4fe1\u606f\uff0c\u6211\u4eec\u6765\u67e5\u770b\u4e0b\u8fd9\u4e2a HPA \u5bf9\u8c61\u7684\u4fe1\u606f\uff1a </p><pre><code>$ kubectl describe hpa hpa-demo\nName:                                                  hpa-demo\nNamespace:                                             default\nLabels:                                                &lt;none&gt;\nAnnotations:                                           &lt;none&gt;\nCreationTimestamp:                                     Tue, 19 Nov 2019 17:14:56 +0800\nReference:                                             Deployment/hpa-demo\nMetrics:                                               ( current / target )\n  resource cpu on pods  (as a percentage of request):  &lt;unknown&gt; / 10%\nMin replicas:                                          1\nMax replicas:                                          10\nDeployment pods:                                       1 current / 0 desired\nConditions:\n  Type           Status  Reason                   Message\n  ----           ------  ------                   -------\n  AbleToScale    True    SucceededGetScale        the HPA controller was able to get the target's current scale\n  ScalingActive  False   FailedGetResourceMetric  the HPA was unable to compute the replica count: missing request for cpu\nEvents:\n  Type     Reason                        Age                From                       Message\n  ----     ------                        ----               ----                       -------\n  Warning  FailedGetResourceMetric       14s (x4 over 60s)  horizontal-pod-autoscaler  missing request for cpu\n  Warning  FailedComputeMetricsReplicas  14s (x4 over 60s)  horizontal-pod-autoscaler  invalid metrics (1 invalid out of 1), first error is: failed to get cpu utilization: missing request for cpu</code></pre><p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u4e8b\u4ef6\u4fe1\u606f\u91cc\u9762\u51fa\u73b0\u4e86 <code>failed to get cpu utilization: missing request for cpu</code> \u8fd9\u6837\u7684\u9519\u8bef\u4fe1\u606f\u3002\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u4e0a\u9762\u521b\u5efa\u7684 Pod \u5bf9\u8c61\u6ca1\u6709\u6dfb\u52a0 request \u8d44\u6e90\u58f0\u660e\uff0c\u8fd9\u6837\u5bfc\u81f4 HPA \u8bfb\u53d6\u4e0d\u5230 CPU \u6307\u6807\u4fe1\u606f\uff0c\u6240\u4ee5\u5982\u679c\u8981\u60f3\u8ba9 HPA \u751f\u6548\uff0c\u5bf9\u5e94\u7684 Pod \u8d44\u6e90\u5fc5\u987b\u6dfb\u52a0 requests \u8d44\u6e90\u58f0\u660e\uff0c\u66f4\u65b0\u6211\u4eec\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a </p><pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hpa-demo\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n        resources:\n          requests:\n            memory: 50Mi\n            cpu: 50m</code></pre><p></p> <p>\u7136\u540e\u91cd\u65b0\u66f4\u65b0 Deployment\uff0c\u91cd\u65b0\u521b\u5efa HPA \u5bf9\u8c61\uff1a </p><pre><code>$ kubectl apply -f hpa.yaml \ndeployment.apps/hpa-demo configured\n$ kubectl get pods -o wide -l app=nginx\nNAME                        READY   STATUS    RESTARTS   AGE     IP            NODE         NOMINATED NODE   READINESS GATES\nhpa-demo-69968bb59f-twtdp   1/1     Running   0          4m11s   10.244.4.97   ydzs-node4   &lt;none&gt;           &lt;none&gt;\n$ kubectl delete hpa hpa-demo\nhorizontalpodautoscaler.autoscaling \"hpa-demo\" deleted\n$ kubectl autoscale deployment hpa-demo --cpu-percent=10 --min=1 --max=10\nhorizontalpodautoscaler.autoscaling/hpa-demo autoscaled\n$ kubectl describe hpa hpa-demo                                          \nName:                                                  hpa-demo\nNamespace:                                             default\nLabels:                                                &lt;none&gt;\nAnnotations:                                           &lt;none&gt;\nCreationTimestamp:                                     Tue, 19 Nov 2019 17:23:49 +0800\nReference:                                             Deployment/hpa-demo\nMetrics:                                               ( current / target )\n  resource cpu on pods  (as a percentage of request):  0% (0) / 10%\nMin replicas:                                          1\nMax replicas:                                          10\nDeployment pods:                                       1 current / 1 desired\nConditions:\n  Type            Status  Reason               Message\n  ----            ------  ------               -------\n  AbleToScale     True    ScaleDownStabilized  recent recommendations were higher than current one, applying the highest recent recommendation\n  ScalingActive   True    ValidMetricFound     the HPA was able to successfully calculate a replica count from cpu resource utilization (percentage of request)\n  ScalingLimited  False   DesiredWithinRange   the desired count is within the acceptable range\nEvents:           &lt;none&gt;\n$ kubectl get hpa                                                        \nNAME       REFERENCE             TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   0%/10%    1         10        1          52s</code></pre><p></p> <p>\u73b0\u5728\u53ef\u4ee5\u770b\u5230 HPA \u8d44\u6e90\u5bf9\u8c61\u5df2\u7ecf\u6b63\u5e38\u4e86\uff0c\u73b0\u5728\u6211\u4eec\u6765\u589e\u5927\u8d1f\u8f7d\u8fdb\u884c\u6d4b\u8bd5\uff0c\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a busybox \u7684 Pod\uff0c\u5e76\u4e14\u5faa\u73af\u8bbf\u95ee\u4e0a\u9762\u521b\u5efa\u7684 Pod\uff1a </p><pre><code>$ kubectl run -it --image busybox test-hpa --restart=Never --rm /bin/sh\nIf you don't see a command prompt, try pressing enter.\n/ # while true; do wget -q -O- http://10.244.4.97; done</code></pre><p></p> <p>\u4e0b\u56fe\u53ef\u4ee5\u770b\u5230\uff0cHPA \u5df2\u7ecf\u5f00\u59cb\u5de5\u4f5c\uff1a </p><pre><code>$  kubectl get hpa\nNAME       REFERENCE             TARGETS    MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   338%/10%   1         10        1          5m15s\n$ kubectl get pods -l app=nginx --watch \nNAME                        READY   STATUS              RESTARTS   AGE\nhpa-demo-69968bb59f-8hjnn   1/1     Running             0          22s\nhpa-demo-69968bb59f-9ss9f   1/1     Running             0          22s\nhpa-demo-69968bb59f-bllsd   1/1     Running             0          22s\nhpa-demo-69968bb59f-lnh8k   1/1     Running             0          37s\nhpa-demo-69968bb59f-r8zfh   1/1     Running             0          22s\nhpa-demo-69968bb59f-twtdp   1/1     Running             0          6m43s\nhpa-demo-69968bb59f-w792g   1/1     Running             0          37s\nhpa-demo-69968bb59f-zlxkp   1/1     Running             0          37s\nhpa-demo-69968bb59f-znp6q   0/1     ContainerCreating   0          6s\nhpa-demo-69968bb59f-ztnvx   1/1     Running             0          6s\n</code></pre><p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u81ea\u52a8\u62c9\u8d77\u4e86\u5f88\u591a\u65b0\u7684 Pod\uff0c\u6700\u540e\u5b9a\u683c\u5728\u4e86\u6211\u4eec\u4e0a\u9762\u8bbe\u7f6e\u7684 10 \u4e2a Pod\uff0c\u540c\u65f6\u67e5\u770b\u8d44\u6e90 hpa-demo \u7684\u526f\u672c\u6570\u91cf\uff0c\u526f\u672c\u6570\u91cf\u5df2\u7ecf\u4ece\u539f\u6765\u76841\u53d8\u6210\u4e8610\u4e2a\uff1a </p><pre><code>$ kubectl get deployment hpa-demo\nNAME       READY   UP-TO-DATE   AVAILABLE   AGE\nhpa-demo   10/10   10           10          17m</code></pre><p></p> <p>\u67e5\u770b HPA \u8d44\u6e90\u7684\u5bf9\u8c61\u4e86\u89e3\u5de5\u4f5c\u8fc7\u7a0b\uff1a </p><pre><code>$ kubectl describe hpa hpa-demo\nName:                                                  hpa-demo\nNamespace:                                             default\nLabels:                                                &lt;none&gt;\nAnnotations:                                           &lt;none&gt;\nCreationTimestamp:                                     Tue, 19 Nov 2019 17:23:49 +0800\nReference:                                             Deployment/hpa-demo\nMetrics:                                               ( current / target )\n  resource cpu on pods  (as a percentage of request):  0% (0) / 10%\nMin replicas:                                          1\nMax replicas:                                          10\nDeployment pods:                                       10 current / 10 desired\nConditions:\n  Type            Status  Reason               Message\n  ----            ------  ------               -------\n  AbleToScale     True    ScaleDownStabilized  recent recommendations were higher than current one, applying the highest recent recommendation\n  ScalingActive   True    ValidMetricFound     the HPA was able to successfully calculate a replica count from cpu resource utilization (percentage of request)\n  ScalingLimited  True    TooManyReplicas      the desired replica count is more than the maximum replica count\nEvents:\n  Type    Reason             Age    From                       Message\n  ----    ------             ----   ----                       -------\n  Normal  SuccessfulRescale  5m45s  horizontal-pod-autoscaler  New size: 4; reason: cpu resource utilization (percentage of request) above target\n  Normal  SuccessfulRescale  5m30s  horizontal-pod-autoscaler  New size: 8; reason: cpu resource utilization (percentage of request) above target\n  Normal  SuccessfulRescale  5m14s  horizontal-pod-autoscaler  New size: 10; reason: cpu resource utilization (percentage of request) above target</code></pre><p></p> <p>\u540c\u6837\u7684\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u6765\u5173\u6389 busybox \u6765\u51cf\u5c11\u8d1f\u8f7d\uff0c\u7136\u540e\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4\u89c2\u5bdf\u4e0b HPA \u548c Deployment \u5bf9\u8c61\uff1a </p><pre><code>$ kubectl get hpa\nNAME       REFERENCE             TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   0%/10%    1         10        1          14m\n$ kubectl get deployment hpa-demo\nNAME       READY   UP-TO-DATE   AVAILABLE   AGE\nhpa-demo   1/1     1            1           24m</code></pre><p></p> <p>\u7f29\u653e\u95f4\u9699</p> <p>\u4ece Kubernetes <code>v1.12</code> \u7248\u672c\u5f00\u59cb\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e <code>kube-controller-manager</code> \u7ec4\u4ef6\u7684<code>--horizontal-pod-autoscaler-downscale-stabilization</code> \u53c2\u6570\u6765\u8bbe\u7f6e\u4e00\u4e2a\u6301\u7eed\u65f6\u95f4\uff0c\u7528\u4e8e\u6307\u5b9a\u5728\u5f53\u524d\u64cd\u4f5c\u5b8c\u6210\u540e\uff0c<code>HPA</code> \u5fc5\u987b\u7b49\u5f85\u591a\u957f\u65f6\u95f4\u624d\u80fd\u6267\u884c\u53e6\u4e00\u6b21\u7f29\u653e\u64cd\u4f5c\u3002\u9ed8\u8ba4\u4e3a5\u5206\u949f\uff0c\u4e5f\u5c31\u662f\u9ed8\u8ba4\u9700\u8981\u7b49\u5f855\u5206\u949f\u540e\u624d\u4f1a\u5f00\u59cb\u81ea\u52a8\u7f29\u653e\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\u526f\u672c\u6570\u91cf\u5df2\u7ecf\u7531 10 \u53d8\u4e3a 1\uff0c\u5f53\u524d\u6211\u4eec\u53ea\u662f\u6f14\u793a\u4e86 CPU \u4f7f\u7528\u7387\u8fd9\u4e00\u4e2a\u6307\u6807\uff0c\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u8fd8\u4f1a\u5b66\u4e60\u5230\u6839\u636e\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7\u6307\u6807\u6765\u81ea\u52a8\u5bf9 Pod \u8fdb\u884c\u6269\u7f29\u5bb9\u3002</p>"},{"location":"kubernetes_controller/job/","title":"Job","text":""},{"location":"kubernetes_controller/job/#job_cronjob","title":"Job \u4e0e CronJob","text":"<p>\u4eca\u5929\u6211\u4eec\u6765\u7ed9\u5927\u5bb6\u4ecb\u7ecd\u53e6\u5916\u4e00\u7c7b\u8d44\u6e90\u5bf9\u8c61\uff1a<code>Job</code>\uff0c\u6211\u4eec\u5728\u65e5\u5e38\u7684\u5de5\u4f5c\u4e2d\u7ecf\u5e38\u90fd\u4f1a\u9047\u5230\u4e00\u4e9b\u9700\u8981\u8fdb\u884c\u6279\u91cf\u6570\u636e\u5904\u7406\u548c\u5206\u6790\u7684\u9700\u6c42\uff0c\u5f53\u7136\u4e5f\u4f1a\u6709\u6309\u65f6\u95f4\u6765\u8fdb\u884c\u8c03\u5ea6\u7684\u5de5\u4f5c\uff0c\u5728\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\u4e2d\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86 <code>Job</code> \u548c <code>CronJob</code> \u4e24\u79cd\u8d44\u6e90\u5bf9\u8c61\u6765\u5e94\u5bf9\u6211\u4eec\u7684\u8fd9\u79cd\u9700\u6c42\u3002</p> <p><code>Job</code> \u8d1f\u8d23\u5904\u7406\u4efb\u52a1\uff0c\u5373\u4ec5\u6267\u884c\u4e00\u6b21\u7684\u4efb\u52a1\uff0c\u5b83\u4fdd\u8bc1\u6279\u5904\u7406\u4efb\u52a1\u7684\u4e00\u4e2a\u6216\u591a\u4e2a Pod \u6210\u529f\u7ed3\u675f\u3002\u800c<code>CronJob</code> \u5219\u5c31\u662f\u5728 <code>Job</code> \u4e0a\u52a0\u4e0a\u4e86\u65f6\u95f4\u8c03\u5ea6\u3002</p>"},{"location":"kubernetes_controller/job/#job","title":"Job","text":"<p>\u6211\u4eec\u7528 <code>Job</code> \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u6765\u521b\u5efa\u4e00\u4e2a\u4efb\u52a1\uff0c\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a <code>Job</code> \u6765\u6267\u884c\u4e00\u4e2a\u5012\u8ba1\u65f6\u7684\u4efb\u52a1\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a(job-demo.yaml)</p> <pre><code>apiVersion: batch/v1\nkind: Job\nmetadata:\n  name: job-demo\nspec:\n  template:\n    spec:\n      restartPolicy: Never\n      containers:\n      - name: counter\n        image: busybox\n        command:\n        - \"bin/sh\"\n        - \"-c\"\n        - \"for i in 9 8 7 6 5 4 3 2 1; do echo $i; done\"\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>Job</code> \u4e2d\u4e5f\u662f\u4e00\u4e2a Pod \u6a21\u677f\uff0c\u548c\u4e4b\u524d\u7684 Deployment\u3001StatefulSet \u4e4b\u7c7b\u7684\u662f\u4e00\u81f4\u7684\uff0c\u53ea\u662f Pod \u4e2d\u7684\u5bb9\u5668\u8981\u6c42\u662f\u4e00\u4e2a\u4efb\u52a1\uff0c\u800c\u4e0d\u662f\u4e00\u4e2a\u5e38\u9a7b\u524d\u53f0\u7684\u8fdb\u7a0b\u4e86\uff0c\u56e0\u4e3a\u9700\u8981\u9000\u51fa\uff0c\u53e6\u5916\u503c\u5f97\u6ce8\u610f\u7684\u662f <code>Job</code> \u7684 <code>RestartPolicy</code> \u4ec5\u652f\u6301 <code>Never</code> \u548c <code>OnFailure</code> \u4e24\u79cd\uff0c\u4e0d\u652f\u6301 <code>Always</code>\uff0c\u6211\u4eec\u77e5\u9053 <code>Job</code> \u5c31\u76f8\u5f53\u4e8e\u6765\u6267\u884c\u4e00\u4e2a\u6279\u5904\u7406\u4efb\u52a1\uff0c\u6267\u884c\u5b8c\u5c31\u7ed3\u675f\u4e86\uff0c\u5982\u679c\u652f\u6301 <code>Always</code> \u7684\u8bdd\u662f\u4e0d\u662f\u5c31\u9677\u5165\u4e86\u6b7b\u5faa\u73af\u4e86\uff1f</p> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Job \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f job-demo.yaml\njob.batch/job-demo created\n$ kubectl get job \nNAME       COMPLETIONS   DURATION   AGE\njob-demo   1/1           26s        3m4s\n$ kubectl get pods         \nNAME                      READY   STATUS      RESTARTS   AGE\njob-demo-frs2r            0/1     Completed   0          2m41s\n</code></pre> <p><code>Job</code> \u5bf9\u8c61\u521b\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e0b\u5bf9\u8c61\u7684\u8be6\u7ec6\u63cf\u8ff0\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe job job-demo\nName:           job-demo\nNamespace:      default\nSelector:       controller-uid=b1191631-c71c-45e7-86c9-ebca69cb6125\nLabels:         controller-uid=b1191631-c71c-45e7-86c9-ebca69cb6125\n                job-name=job-demo\n.......\nPod Template:\n  Labels:  controller-uid=b1191631-c71c-45e7-86c9-ebca69cb6125\n           job-name=job-demo\n  Containers:\n   ......\nEvents:\n  Type    Reason            Age   From            Message\n  ----    ------            ----  ----            -------\n  Normal  SuccessfulCreate  49s   job-controller  Created pod: job-demo-z48h2\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cJob \u5bf9\u8c61\u5728\u521b\u5efa\u540e\uff0c\u5b83\u7684 Pod \u6a21\u677f\uff0c\u88ab\u81ea\u52a8\u52a0\u4e0a\u4e86\u4e00\u4e2a </p> <pre><code>controller-uid=&lt; \u4e00\u4e2a\u968f\u673a\u5b57\u7b26\u4e32 &gt;\n</code></pre> <p>\u8fd9\u6837\u7684 Label \u6807\u7b7e\uff0c\u800c\u8fd9\u4e2a Job \u5bf9\u8c61\u672c\u8eab\uff0c\u5219\u88ab\u81ea\u52a8\u52a0\u4e0a\u4e86\u8fd9\u4e2a Label \u5bf9\u5e94\u7684 Selector\uff0c\u4ece\u800c \u4fdd\u8bc1\u4e86 Job \u4e0e\u5b83\u6240\u7ba1\u7406\u7684 Pod \u4e4b\u95f4\u7684\u5339\u914d\u5173\u7cfb\u3002\u800c Job \u63a7\u5236\u5668\u4e4b\u6240\u4ee5\u8981\u4f7f\u7528\u8fd9\u79cd\u643a\u5e26\u4e86 UID \u7684 Label\uff0c\u5c31\u662f\u4e3a\u4e86\u907f\u514d\u4e0d\u540c Job \u5bf9\u8c61\u6240\u7ba1\u7406\u7684 Pod \u53d1\u751f\u91cd\u5408\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5f88\u5feb Pod \u53d8\u6210\u4e86 <code>Completed</code> \u72b6\u6001\uff0c\u8fd9\u662f\u56e0\u4e3a\u5bb9\u5668\u7684\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u6b63\u5e38\u9000\u51fa\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5bf9\u5e94\u7684\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs job-demo-frs2r\n9\n8\n7\n6\n5\n4\n3\n2\n1\n</code></pre> <p>\u5982\u679c\u7684\u4efb\u52a1\u6267\u884c\u5931\u8d25\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u4e86 <code>restartPolicy=Never</code>\uff0c\u90a3\u4e48\u4efb\u52a1\u5728\u6267\u884c\u5931\u8d25\u540e Job \u63a7\u5236\u5668\u5c31\u4f1a\u4e0d\u65ad\u5730\u5c1d\u8bd5\u521b\u5efa\u4e00\u4e2a\u65b0 Pod\uff0c\u5f53\u7136\uff0c\u8fd9\u4e2a\u5c1d\u8bd5\u80af\u5b9a\u4e0d\u80fd\u65e0\u9650\u8fdb\u884c\u4e0b\u53bb\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Job \u5bf9\u8c61\u7684 <code>spec.backoffLimit</code> \u5b57\u6bb5\u6765\u5b9a\u4e49\u91cd\u8bd5\u6b21\u6570\uff0c\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f Job \u63a7\u5236\u5668\u91cd\u65b0\u521b\u5efa Pod \u7684\u95f4\u9694\u662f\u5448\u6307\u6570\u589e\u52a0\u7684\uff0c\u5373\u4e0b\u4e00\u6b21\u91cd\u65b0\u521b\u5efa Pod \u7684\u52a8\u4f5c\u4f1a\u5206\u522b\u53d1\u751f\u5728 10s\u300120s\u300140s\u2026 \u540e\u3002</p> <p>\u5982\u679c\u6211\u4eec\u5b9a\u4e49\u7684 </p> <pre><code>restartPolicy=OnFailure\n</code></pre> <p>\uff0c\u90a3\u4e48\u4efb\u52a1\u6267\u884c\u5931\u8d25\u540e\uff0cJob \u63a7\u5236\u5668\u5c31\u4e0d\u4f1a\u53bb\u5c1d\u8bd5\u521b\u5efa\u65b0\u7684 Pod\u4e86\uff0c\u5b83\u4f1a\u4e0d\u65ad\u5730\u5c1d\u8bd5\u91cd\u542f Pod \u91cc\u7684\u5bb9\u5668\u3002</p> <p>\u4e0a\u9762\u6211\u4eec\u8fd9\u91cc\u7684 Job \u4efb\u52a1\u5bf9\u5e94\u7684 Pod \u5728\u8fd0\u884c\u7ed3\u675f\u540e\uff0c\u4f1a\u53d8\u6210 <code>Completed</code> \u72b6\u6001\uff0c\u4f46\u662f\u5982\u679c\u6267\u884c\u4efb\u52a1\u7684 Pod \u56e0\u4e3a\u67d0\u79cd\u539f\u56e0\u4e00\u76f4\u6ca1\u6709\u7ed3\u675f\u600e\u4e48\u529e\u5462\uff1f\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u5728 Job \u5bf9\u8c61\u4e2d\u901a\u8fc7\u8bbe\u7f6e\u5b57\u6bb5 </p> <pre><code>spec.activeDeadlineSeconds\n</code></pre> <p>\u6765\u9650\u5236\u4efb\u52a1\u8fd0\u884c\u7684\u6700\u957f\u65f6\u95f4\uff0c\u6bd4\u5982\uff1a</p> <pre><code>spec:\n activeDeadlineSeconds: 100\n</code></pre> <p>\u90a3\u4e48\u5f53\u6211\u4eec\u7684\u4efb\u52a1 Pod \u8fd0\u884c\u8d85\u8fc7\u4e86 100s \u540e\uff0c\u8fd9\u4e2a Job \u7684\u6240\u6709 Pod \u90fd\u4f1a\u88ab\u7ec8\u6b62\uff0c\u5e76\u4e14\uff0c Pod \u7684\u7ec8\u6b62\u539f\u56e0\u4f1a\u53d8\u6210 <code>DeadlineExceeded</code>\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e <code>spec.parallelism</code> \u53c2\u6570\u6765\u8fdb\u884c\u5e76\u884c\u63a7\u5236\uff0c\u8be5\u53c2\u6570\u5b9a\u4e49\u4e86\u4e00\u4e2a Job \u5728\u4efb\u610f\u65f6\u95f4\u6700\u591a\u53ef\u4ee5\u6709\u591a\u5c11\u4e2a Pod \u540c\u65f6\u8fd0\u884c\u3002<code>spec.completions</code> \u53c2\u6570\u53ef\u4ee5\u5b9a\u4e49 Job \u81f3\u5c11\u8981\u5b8c\u6210\u7684 Pod \u6570\u76ee\u3002</p>"},{"location":"kubernetes_controller/job/#cronjob","title":"CronJob","text":"<p><code>CronJob</code> \u5176\u5b9e\u5c31\u662f\u5728 <code>Job</code> \u7684\u57fa\u7840\u4e0a\u52a0\u4e0a\u4e86\u65f6\u95f4\u8c03\u5ea6\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u7ed9\u5b9a\u7684\u65f6\u95f4\u70b9\u8fd0\u884c\u4e00\u4e2a\u4efb\u52a1\uff0c\u4e5f\u53ef\u4ee5\u5468\u671f\u6027\u5730\u5728\u7ed9\u5b9a\u65f6\u95f4\u70b9\u8fd0\u884c\u3002\u8fd9\u4e2a\u5b9e\u9645\u4e0a\u548c\u6211\u4eec Linux \u4e2d\u7684 <code>crontab</code> \u5c31\u975e\u5e38\u7c7b\u4f3c\u4e86\u3002</p> <p>\u4e00\u4e2a <code>CronJob</code> \u5bf9\u8c61\u5176\u5b9e\u5c31\u5bf9\u5e94\u4e2d <code>crontab</code> \u6587\u4ef6\u4e2d\u7684\u4e00\u884c\uff0c\u5b83\u6839\u636e\u914d\u7f6e\u7684\u65f6\u95f4\u683c\u5f0f\u5468\u671f\u6027\u5730\u8fd0\u884c\u4e00\u4e2a<code>Job</code>\uff0c\u683c\u5f0f\u548c <code>crontab</code> \u4e5f\u662f\u4e00\u6837\u7684\u3002</p> <p>crontab \u7684\u683c\u5f0f\u4e3a\uff1a<code>\u5206 \u65f6 \u65e5 \u6708 \u661f\u671f \u8981\u8fd0\u884c\u7684\u547d\u4ee4</code> \u3002</p> <ul> <li>\u7b2c1\u5217\u5206\u949f0\uff5e59</li> <li>\u7b2c2\u5217\u5c0f\u65f60\uff5e23\uff09</li> <li>\u7b2c3\u5217\u65e51\uff5e31</li> <li>\u7b2c4\u5217\u67081\uff5e12</li> <li>\u7b2c5\u5217\u661f\u671f0\uff5e7\uff080\u548c7\u8868\u793a\u661f\u671f\u5929\uff09</li> <li>\u7b2c6\u5217\u8981\u8fd0\u884c\u7684\u547d\u4ee4</li> </ul> <p>\u73b0\u5728\uff0c\u6211\u4eec\u7528 <code>CronJob</code> \u6765\u7ba1\u7406\u6211\u4eec\u4e0a\u9762\u7684 <code>Job</code> \u4efb\u52a1\uff0c\u5b9a\u4e49\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u6e05\u5355\uff1a(cronjob-demo.yaml)</p> <pre><code>apiVersion: batch/v1beta1\nkind: CronJob\nmetadata:\n  name: cronjob-demo\nspec:\n  schedule: \"*/1 * * * *\"\n  jobTemplate:\n    spec:\n      template:\n        spec:\n          restartPolicy: OnFailure\n          containers:\n          - name: hello\n            image: busybox\n            args:\n            - \"bin/sh\"\n            - \"-c\"\n            - \"for i in 9 8 7 6 5 4 3 2 1; do echo $i; done\"\n</code></pre> <p>\u8fd9\u91cc\u7684 Kind \u53d8\u6210\u4e86 <code>CronJob</code> \u4e86\uff0c\u8981\u6ce8\u610f\u7684\u662f<code>.spec.schedule</code>\u5b57\u6bb5\u662f\u5fc5\u987b\u586b\u5199\u7684\uff0c\u7528\u6765\u6307\u5b9a\u4efb\u52a1\u8fd0\u884c\u7684\u5468\u671f\uff0c\u683c\u5f0f\u5c31\u548c <code>crontab</code> \u4e00\u6837\uff0c\u53e6\u5916\u4e00\u4e2a\u5b57\u6bb5\u662f<code>.spec.jobTemplate</code>, \u7528\u6765\u6307\u5b9a\u9700\u8981\u8fd0\u884c\u7684\u4efb\u52a1\uff0c\u683c\u5f0f\u5f53\u7136\u548c <code>Job</code> \u662f\u4e00\u81f4\u7684\u3002\u8fd8\u6709\u4e00\u4e9b\u503c\u5f97\u6211\u4eec\u5173\u6ce8\u7684\u5b57\u6bb5 </p> <pre><code>.spec.successfulJobsHistoryLimit\n</code></pre> <p>\u548c </p> <pre><code>.spec.failedJobsHistoryLimit\n</code></pre> <p>\uff0c\u8868\u793a\u5386\u53f2\u9650\u5236\uff0c\u662f\u53ef\u9009\u7684\u5b57\u6bb5\uff0c\u6307\u5b9a\u53ef\u4ee5\u4fdd\u7559\u591a\u5c11\u5b8c\u6210\u548c\u5931\u8d25\u7684 <code>Job</code>\uff0c\u9ed8\u8ba4\u6ca1\u6709\u9650\u5236\uff0c\u6240\u6709\u6210\u529f\u548c\u5931\u8d25\u7684 <code>Job</code> \u90fd\u4f1a\u88ab\u4fdd\u7559\u3002\u7136\u800c\uff0c\u5f53\u8fd0\u884c\u4e00\u4e2a <code>CronJob</code> \u65f6\uff0c<code>Job</code> \u53ef\u4ee5\u5f88\u5feb\u5c31\u5806\u79ef\u5f88\u591a\uff0c\u6240\u4ee5\u4e00\u822c\u63a8\u8350\u8bbe\u7f6e\u8fd9\u4e24\u4e2a\u5b57\u6bb5\u7684\u503c\u3002\u5982\u679c\u8bbe\u7f6e\u9650\u5236\u7684\u503c\u4e3a 0\uff0c\u90a3\u4e48\u76f8\u5173\u7c7b\u578b\u7684 <code>Job</code> \u5b8c\u6210\u540e\u5c06\u4e0d\u4f1a\u88ab\u4fdd\u7559\u3002</p> <p>\u6211\u4eec\u76f4\u63a5\u65b0\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f cronjob-demo.yaml\ncronjob \"cronjob-demo\" created\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u67e5\u770b\u5bf9\u5e94\u7684 Cronjob \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get cronjob\nNAME           SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE\ncronjob-demo   */1 * * * *   False     0        &lt;none&gt;          7s\n</code></pre> <p>\u7a0d\u5fae\u7b49\u4e00\u4f1a\u513f\u67e5\u770b\u53ef\u4ee5\u53d1\u73b0\u591a\u4e86\u51e0\u4e2a Job \u8d44\u6e90\u5bf9\u8c61\uff0c\u8fd9\u4e2a\u5c31\u662f\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u8bbe\u7f6e\u7684 CronJob \u8d44\u6e90\u5bf9\u8c61\uff0c\u6bcf1\u5206\u949f\u6267\u884c\u4e00\u4e2a\u65b0\u7684 Job\uff1a</p> <pre><code>$ kubectl get job \nNAME                      COMPLETIONS   DURATION   AGE\ncronjob-demo-1574147280   1/1           6s         2m45s\ncronjob-demo-1574147340   1/1           11s        105s\ncronjob-demo-1574147400   1/1           5s         45s\n$ kubectl get pods\nNAME                      READY   STATUS      RESTARTS   AGE\ncronjob-demo-1574147340-ksd5x   0/1     Completed           0          3m7s\ncronjob-demo-1574147400-pts94   0/1     Completed           0          2m7s\ncronjob-demo-1574147460-t5hcd   0/1     Completed           0          67s\ncronjob-demo-1574147520-vmjfr   0/1     ContainerCreating   0          7s\n</code></pre> <p>\u8fd9\u4e2a\u5c31\u662f CronJob \u7684\u57fa\u672c\u7528\u6cd5\uff0c\u4e00\u65e6\u4e0d\u518d\u9700\u8981 CronJob\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 kubectl \u547d\u4ee4\u5220\u9664\u5b83\uff1a</p> <pre><code>$ kubectl delete cronjob cronjob-demo\ncronjob \"cronjob-demo\" deleted\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u8fd9\u5c06\u4f1a\u7ec8\u6b62\u6b63\u5728\u521b\u5efa\u7684 Job\uff0c\u4f46\u662f\u8fd0\u884c\u4e2d\u7684 Job \u5c06\u4e0d\u4f1a\u88ab\u7ec8\u6b62\uff0c\u4e0d\u4f1a\u5220\u9664 Job \u6216 \u5b83\u4eec\u7684 Pod\u3002</p>"},{"location":"kubernetes_controller/replicaset/","title":"ReplicaSet","text":""},{"location":"kubernetes_controller/replicaset/#replicaset","title":"ReplicaSet \u63a7\u5236\u5668","text":"<p>\u524d\u9762\u6211\u4eec\u4e00\u8d77\u5b66\u4e60\u4e86 Pod \u7684\u539f\u7406\u548c\u4e00\u4e9b\u57fa\u672c\u4f7f\u7528\uff0c\u4f46\u662f\u5728\u5b9e\u9645\u4f7f\u7528\u7684\u65f6\u5019\u5e76\u4e0d\u4f1a\u76f4\u63a5\u4f7f\u7528 Pod\uff0c\u800c\u662f\u4f1a\u4f7f\u7528\u5404\u79cd\u63a7\u5236\u5668\u6765\u6ee1\u8db3\u6211\u4eec\u7684\u9700\u6c42\uff0cKubernetes \u4e2d\u8fd0\u884c\u4e86\u4e00\u7cfb\u5217\u63a7\u5236\u5668\u6765\u786e\u4fdd\u96c6\u7fa4\u7684\u5f53\u524d\u72b6\u6001\u4e0e\u671f\u671b\u72b6\u6001\u4fdd\u6301\u4e00\u81f4\uff0c\u5b83\u4eec\u5c31\u662f Kubernetes \u7684\u5927\u8111\u3002\u4f8b\u5982\uff0cReplicaSet \u63a7\u5236\u5668\u8d1f\u8d23\u7ef4\u62a4\u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684 Pod \u6570\u91cf\uff1bNode \u63a7\u5236\u5668\u8d1f\u8d23\u76d1\u63a7\u8282\u70b9\u7684\u72b6\u6001\uff0c\u5e76\u5728\u8282\u70b9\u51fa\u73b0\u6545\u969c\u65f6\u53ca\u65f6\u505a\u51fa\u54cd\u5e94\u3002\u603b\u800c\u8a00\u4e4b\uff0c\u5728 Kubernetes \u4e2d\uff0c\u6bcf\u4e2a\u63a7\u5236\u5668\u53ea\u8d1f\u8d23\u67d0\u79cd\u7c7b\u578b\u7684\u7279\u5b9a\u8d44\u6e90\u3002</p>"},{"location":"kubernetes_controller/replicaset/#_1","title":"\u63a7\u5236\u5668","text":"<p>Kubernetes \u63a7\u5236\u5668\u4f1a\u76d1\u542c\u8d44\u6e90\u7684 <code>\u521b\u5efa/\u66f4\u65b0/\u5220\u9664</code> \u4e8b\u4ef6\uff0c\u5e76\u89e6\u53d1 <code>Reconcile</code> \u51fd\u6570\u4f5c\u4e3a\u54cd\u5e94\u3002\u6574\u4e2a\u8c03\u6574\u8fc7\u7a0b\u88ab\u79f0\u4f5c </p> <pre><code>Reconcile Loop\uff08\u8c03\u8c10\u5faa\u73af\uff09\n</code></pre> <p>\u6216\u8005 <code>Sync Loop\uff08\u540c\u6b65\u5faa\u73af\uff09</code>\u3002Reconcile \u662f\u4e00\u4e2a\u4f7f\u7528\u8d44\u6e90\u5bf9\u8c61\u7684\u547d\u540d\u7a7a\u95f4\u548c\u8d44\u6e90\u5bf9\u8c61\u540d\u79f0\u6765\u8c03\u7528\u7684\u51fd\u6570\uff0c\u4f7f\u5f97\u8d44\u6e90\u5bf9\u8c61\u7684\u5b9e\u9645\u72b6\u6001\u4e0e \u8d44\u6e90\u6e05\u5355\u4e2d\u5b9a\u4e49\u7684\u72b6\u6001\u4fdd\u6301\u4e00\u81f4\u3002\u8c03\u7528\u5b8c\u6210\u540e\uff0cReconcile \u4f1a\u5c06\u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u66f4\u65b0\u4e3a\u5f53\u524d\u5b9e\u9645\u72b6\u6001\u3002\u6211\u4eec\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u4e00\u6bb5\u4f2a\u4ee3\u7801\u6765\u8868\u793a\u8fd9\u4e2a\u8fc7\u7a0b\uff1a</p> <pre><code>for {\n  desired := getDesiredState()  // \u671f\u671b\u7684\u72b6\u6001\n  current := getCurrentState()  // \u5f53\u524d\u5b9e\u9645\u72b6\u6001\n  if current == desired {  // \u5982\u679c\u72b6\u6001\u4e00\u81f4\u5219\u4ec0\u4e48\u90fd\u4e0d\u505a\n    // nothing to do\n  } else {  // \u5982\u679c\u72b6\u6001\u4e0d\u4e00\u81f4\u5219\u8c03\u6574\u7f16\u6392\uff0c\u5230\u4e00\u81f4\u4e3a\u6b62\n    // change current to desired status\n  }\n}\n</code></pre> <p>\u8fd9\u4e2a\u7f16\u6392\u6a21\u578b\u5c31\u662f Kubernetes \u9879\u76ee\u4e2d\u7684\u4e00\u4e2a\u901a\u7528\u7f16\u6392\u6a21\u5f0f\uff0c\u5373\uff1a<code>\u63a7\u5236\u5faa\u73af\uff08control loop\uff09</code>\u3002</p>"},{"location":"kubernetes_controller/replicaset/#replicaset_1","title":"ReplicaSet","text":"<p>\u5047\u5982\u6211\u4eec\u73b0\u5728\u6709\u4e00\u4e2a Pod \u6b63\u5728\u63d0\u4f9b\u7ebf\u4e0a\u7684\u670d\u52a1\uff0c\u6211\u4eec\u6765\u60f3\u60f3\u4e00\u4e0b\u6211\u4eec\u53ef\u80fd\u4f1a\u9047\u5230\u7684\u4e00\u4e9b\u573a\u666f\uff1a</p> <ul> <li>\u67d0\u6b21\u8fd0\u8425\u6d3b\u52a8\u975e\u5e38\u6210\u529f\uff0c\u7f51\u7ad9\u8bbf\u95ee\u91cf\u7a81\u7136\u66b4\u589e</li> <li>\u8fd0\u884c\u5f53\u524d Pod \u7684\u8282\u70b9\u53d1\u751f\u6545\u969c\u4e86\uff0cPod \u4e0d\u80fd\u6b63\u5e38\u63d0\u4f9b\u670d\u52a1\u4e86</li> </ul> <p>\u7b2c\u4e00\u79cd\u60c5\u51b5\uff0c\u53ef\u80fd\u6bd4\u8f83\u597d\u5e94\u5bf9\uff0c\u6d3b\u52a8\u4e4b\u524d\u6211\u4eec\u53ef\u4ee5\u5927\u6982\u8ba1\u7b97\u4e0b\u4f1a\u6709\u591a\u5927\u7684\u8bbf\u95ee\u91cf\uff0c\u63d0\u524d\u591a\u542f\u52a8\u51e0\u4e2a Pod \u526f\u672c\uff0c\u6d3b\u52a8\u7ed3\u675f\u540e\u518d\u628a\u591a\u4f59\u7684 Pod \u6740\u6389\uff0c\u867d\u7136\u6709\u70b9\u9ebb\u70e6\uff0c\u4f46\u662f\u8fd8\u662f\u80fd\u591f\u5e94\u5bf9\u8fd9\u79cd\u60c5\u51b5\u7684\u3002</p> <p>\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff0c\u53ef\u80fd\u67d0\u5929\u591c\u91cc\u6536\u5230\u5927\u91cf\u62a5\u8b66\u8bf4\u670d\u52a1\u6302\u4e86\uff0c\u7136\u540e\u8d77\u6765\u6253\u5f00\u7535\u8111\u5728\u53e6\u5916\u7684\u8282\u70b9\u4e0a\u91cd\u65b0\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u95ee\u9898\u53ef\u4ee5\u89e3\u51b3\u3002</p> <p>\u4f46\u662f\u5982\u679c\u6211\u4eec\u90fd\u4eba\u5de5\u7684\u53bb\u89e3\u51b3\u9047\u5230\u7684\u8fd9\u4e9b\u95ee\u9898\uff0c\u4f3c\u4e4e\u53c8\u56de\u5230\u4e86\u4ee5\u524d\u5200\u8015\u706b\u79cd\u7684\u65f6\u4ee3\u4e86\u662f\u5427\uff1f\u5982\u679c\u6709\u4e00\u79cd\u5de5\u5177\u80fd\u591f\u6765\u5e2e\u52a9\u6211\u4eec\u81ea\u52a8\u7ba1\u7406 Pod \u5c31\u597d\u4e86\uff0cPod \u6302\u4e86\u81ea\u52a8\u5e2e\u6211\u5728\u5408\u9002\u7684\u8282\u70b9\u4e0a\u91cd\u65b0\u542f\u52a8\u4e00\u4e2a Pod\uff0c\u8fd9\u6837\u662f\u4e0d\u662f\u9047\u5230\u4e0a\u9762\u7684\u95ee\u9898\u6211\u4eec\u90fd\u4e0d\u9700\u8981\u624b\u52a8\u53bb\u89e3\u51b3\u4e86\u3002</p> <p>\u800c ReplicaSet \u8fd9\u79cd\u8d44\u6e90\u5bf9\u8c61\u5c31\u53ef\u4ee5\u6765\u5e2e\u52a9\u6211\u4eec\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\uff0c<code>ReplicaSet\uff08RS\uff09</code> \u7684\u4e3b\u8981\u4f5c\u7528\u5c31\u662f\u7ef4\u6301\u4e00\u7ec4 Pod \u526f\u672c\u7684\u8fd0\u884c\uff0c\u4fdd\u8bc1\u4e00\u5b9a\u6570\u91cf\u7684 Pod \u5728\u96c6\u7fa4\u4e2d\u6b63\u5e38\u8fd0\u884c\uff0cReplicaSet \u63a7\u5236\u5668\u4f1a\u6301\u7eed\u76d1\u542c\u5b83\u8bf4\u63a7\u5236\u7684\u8fd9\u4e9b Pod \u7684\u8fd0\u884c\u72b6\u6001\uff0c\u5728 Pod \u53d1\u9001\u6545\u969c\u6570\u91cf\u51cf\u5c11\u6216\u8005\u589e\u52a0\u65f6\u4f1a\u89e6\u53d1\u8c03\u8c10\u8fc7\u7a0b\uff0c\u59cb\u7ec8\u4fdd\u6301\u526f\u672c\u6570\u91cf\u4e00\u5b9a\u3002</p> <p>\u548c Pod \u4e00\u6837\u6211\u4eec\u4ecd\u7136\u8fd8\u662f\u901a\u8fc7 YAML \u6587\u4ef6\u6765\u63cf\u8ff0\u6211\u4eec\u7684 ReplicaSet \u8d44\u6e90\u5bf9\u8c61\uff0c\u5982\u4e0b YAML \u6587\u4ef6\u662f\u4e00\u4e2a\u5e38\u89c1\u7684 ReplicaSet \u5b9a\u4e49\uff1a(nginx-rs.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: ReplicaSet  \nmetadata:\n  name:  nginx-rs\n  namespace: default\nspec:\n  replicas: 3  # \u671f\u671b\u7684 Pod \u526f\u672c\u6570\u91cf\uff0c\u9ed8\u8ba4\u503c\u4e3a1\n  selector:  # Label Selector\uff0c\u5fc5\u987b\u5339\u914d Pod \u6a21\u677f\u4e2d\u7684\u6807\u7b7e\n    matchLabels:\n      app: nginx\n  template:  # Pod \u6a21\u677f\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n</code></pre> <p>\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u7ed3\u6784\u548c\u6211\u4eec\u4e4b\u524d\u5b9a\u4e49\u7684 Pod \u770b\u4e0a\u53bb\u6ca1\u592a\u5927\u4e24\u6837\uff0c\u6709\u5e38\u89c1\u7684 apiVersion\u3001kind\u3001metadata\uff0c\u5728 spec \u4e0b\u9762\u63cf\u8ff0 ReplicaSet \u7684\u57fa\u672c\u4fe1\u606f\uff0c\u5176\u4e2d\u5305\u542b3\u4e2a\u91cd\u8981\u5185\u5bb9\uff1a</p> <ul> <li>replias\uff1a\u8868\u793a\u671f\u671b\u7684 Pod \u7684\u526f\u672c\u6570\u91cf</li> <li>selector\uff1aLabel Selector\uff0c\u7528\u6765\u5339\u914d\u8981\u63a7\u5236\u7684 Pod \u6807\u7b7e\uff0c\u9700\u8981\u548c\u4e0b\u9762\u7684 Pod \u6a21\u677f\u4e2d\u7684\u6807\u7b7e\u4e00\u81f4</li> <li>template\uff1aPod \u6a21\u677f\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u4ee5\u524d\u6211\u4eec\u5b9a\u4e49\u7684 Pod \u5185\u5bb9\uff0c\u76f8\u5f53\u4e8e\u628a\u4e00\u4e2a Pod \u7684\u63cf\u8ff0\u4ee5\u6a21\u677f\u7684\u5f62\u5f0f\u5d4c\u5165\u5230\u4e86 ReplicaSet \u4e2d\u6765\u3002</li> </ul> <p>Pod \u6a21\u677f</p> <p>Pod \u6a21\u677f\u8fd9\u4e2a\u6982\u5ff5\u975e\u5e38\u91cd\u8981\uff0c\u56e0\u4e3a\u540e\u9762\u6211\u4eec\u8bb2\u89e3\u5230\u7684\u5927\u591a\u6570\u63a7\u5236\u5668\uff0c\u90fd\u4f1a\u4f7f\u7528 Pod \u6a21\u677f\u6765\u7edf\u4e00\u5b9a\u4e49\u5b83\u6240\u8981\u7ba1\u7406\u7684 Pod\u3002\u66f4\u6709\u610f\u601d\u7684\u662f\uff0c\u6211\u4eec\u8fd8\u4f1a\u770b\u5230\u5176\u4ed6\u7c7b\u578b\u7684\u5bf9\u8c61\u6a21\u677f\uff0c\u6bd4\u5982 Volume \u7684\u6a21\u677f\u767b\u3002</p> <p>\u4e0a\u9762\u5c31\u662f\u6211\u4eec\u5b9a\u4e49\u7684\u4e00\u4e2a\u666e\u901a\u7684 ReplicaSet \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0cReplicaSet \u63a7\u5236\u5668\u4f1a\u901a\u8fc7\u5b9a\u4e49\u7684 Label Selector \u6807\u7b7e\u53bb\u67e5\u627e\u96c6\u7fa4\u4e2d\u7684 Pod \u5bf9\u8c61\uff1a</p> <p></p> <p>\u6211\u4eec\u76f4\u63a5\u6765\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f nginx-rs.yaml\nreplicaset.apps/nginx-rs created\n$ kubectl get rs nginx-rs\nNAME       DESIRED   CURRENT   READY   AGE\nnginx-rs   3         3         3       17m\n</code></pre> <p>\u901a\u8fc7\u67e5\u770b RS \u53ef\u4ee5\u770b\u5230\u5f53\u524d\u8d44\u6e90\u5bf9\u8c61\u7684\u63cf\u8ff0\u4fe1\u606f\uff0c\u5305\u62ec<code>DESIRED</code>\u3001<code>CURRENT</code>\u3001<code>READY</code>\u7684\u72b6\u6001\u503c\uff0c\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u5229\u7528\u5982\u4e0b\u547d\u4ee4\u67e5\u770b\u4e0b Pod \u5217\u8868\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx\nNAME             READY   STATUS              RESTARTS   AGE\nnginx-rs-nxklf   1/1     Running   0          52s\nnginx-rs-t46qc   1/1     Running   0          52s\nnginx-rs-xfqrn   1/1     Running   0          52s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u6709 3 \u4e2a Pod\uff0c\u8fd9 3 \u4e2a Pod \u5c31\u662f\u6211\u4eec\u5728 RS \u4e2d\u58f0\u660e\u7684 3 \u4e2a\u526f\u672c\uff0c\u6bd4\u5982\u6211\u4eec\u5220\u9664\u5176\u4e2d\u4e00\u4e2a Pod\uff1a</p> <pre><code>$ kubectl delete pod nginx-rs-xfqrn\npod \"nginx-rs-xfqrn\" deleted\n</code></pre> <p>\u7136\u540e\u518d\u67e5\u770b Pod \u5217\u8868\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx    \nNAME             READY   STATUS    RESTARTS   AGE\nnginx-rs-nxklf   1/1     Running   0          3m19s\nnginx-rs-t46qc   1/1     Running   0          3m19s\nnginx-rs-xsb59   1/1     Running   0          10s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u53c8\u91cd\u65b0\u51fa\u73b0\u4e86\u4e00\u4e2a Pod\uff0c\u8fd9\u4e2a\u5c31\u662f\u4e0a\u9762\u6211\u4eec\u6240\u8bf4\u7684 ReplicaSet \u63a7\u5236\u5668\u4e3a\u6211\u4eec\u505a\u7684\u5de5\u4f5c\uff0c\u6211\u4eec\u5728 YAML \u6587\u4ef6\u4e2d\u58f0\u660e\u4e86 3 \u4e2a\u526f\u672c\uff0c\u7136\u540e\u73b0\u5728\u6211\u4eec\u5220\u9664\u4e86\u4e00\u4e2a\u526f\u672c\uff0c\u5c31\u53d8\u6210\u4e86\u4e24\u4e2a\uff0c\u8fd9\u4e2a\u65f6\u5019 ReplicaSet \u63a7\u5236\u5668\u76d1\u63a7\u5230\u63a7\u5236\u7684 Pod \u6570\u91cf\u548c\u671f\u671b\u7684 3 \u4e0d\u4e00\u81f4\uff0c\u6240\u4ee5\u5c31\u9700\u8981\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 Pod \u6765\u4fdd\u6301 3 \u4e2a\u526f\u672c\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e0a\u9762\u6211\u4eec\u8bf4\u4e86\u5c31\u662f<code>\u8c03\u8c10</code>\u7684\u8fc7\u7a0b\u3002\u540c\u6837\u53ef\u4ee5\u67e5\u770b RS \u7684\u63cf\u8ff0\u4fe1\u606f\u6765\u67e5\u770b\u5230\u76f8\u5173\u7684\u4e8b\u4ef6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe rs nginx-rs\nName:         nginx-rs\nNamespace:    default\nSelector:     app=nginx\nLabels:       &lt;none&gt;\nAnnotations:  kubectl.kubernetes.io/last-applied-configuration:\n                {\"apiVersion\":\"apps/v1\",\"kind\":\"ReplicaSet\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-rs\",\"namespace\":\"default\"},\"spec\":{\"replicas\":3,\"se...\nReplicas:     3 current / 3 desired\nPods Status:  3 Running / 0 Waiting / 0 Succeeded / 0 Failed\nPod Template:\n  Labels:  app=nginx\n  Containers:\n   nginx:\n    Image:        nginx\n    Port:         80/TCP\n    Host Port:    0/TCP\n    Environment:  &lt;none&gt;\n    Mounts:       &lt;none&gt;\n  Volumes:        &lt;none&gt;\nEvents:\n  Type    Reason            Age   From                   Message\n  ----    ------            ----  ----                   -------\n  Normal  SuccessfulCreate  17m   replicaset-controller  Created pod: nginx-rs-xfqrn\n  Normal  SuccessfulCreate  17m   replicaset-controller  Created pod: nginx-rs-nxklf\n  Normal  SuccessfulCreate  17m   replicaset-controller  Created pod: nginx-rs-t46qc\n  Normal  SuccessfulCreate  14m   replicaset-controller  Created pod: nginx-rs-xsb59\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0\u6700\u5f00\u59cb\u901a\u8fc7 ReplicaSet \u63a7\u5236\u5668\u521b\u5efa\u4e86 3 \u4e2a Pod\uff0c\u540e\u9762\u6211\u4eec\u5220\u9664\u4e86 Pod \u540e\uff0c ReplicaSet \u63a7\u5236\u5668\u53c8\u4e3a\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a Pod\uff0c\u548c\u4e0a\u9762\u6211\u4eec\u7684\u63cf\u8ff0\u662f\u4e00\u81f4\u7684\u3002\u5982\u679c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u628a RS \u8d44\u6e90\u5bf9\u8c61\u7684 Pod \u526f\u672c\u66f4\u6539\u4e3a 2 <code>spec.replicas=2</code>\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u6765\u66f4\u65b0\u4e0b\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f rs.yaml \nreplicaset.apps/nginx-rs configured\n$ kubectl get rs nginx-rs \nNAME       DESIRED   CURRENT   READY   AGE\nnginx-rs   2         2         2       27m\n$ kubectl describe rs nginx-rs\nName:         nginx-rs\nNamespace:    default\nSelector:     app=nginx\nLabels:       &lt;none&gt;\nAnnotations:  kubectl.kubernetes.io/last-applied-configuration:\n                {\"apiVersion\":\"apps/v1\",\"kind\":\"ReplicaSet\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-rs\",\"namespace\":\"default\"},\"spec\":{\"replicas\":2,\"se...\nReplicas:     2 current / 2 desired\nPods Status:  2 Running / 1 Waiting / 0 Succeeded / 0 Failed\nPod Template:\n  Labels:  app=nginx\n  Containers:\n   nginx:\n    Image:        nginx\n    Port:         80/TCP\n    Host Port:    0/TCP\n    Environment:  &lt;none&gt;\n    Mounts:       &lt;none&gt;\n  Volumes:        &lt;none&gt;\nEvents:\n  Type    Reason            Age   From                   Message\n  ----    ------            ----  ----                   -------\n  Normal  SuccessfulCreate  27m   replicaset-controller  Created pod: nginx-rs-xfqrn\n  Normal  SuccessfulCreate  27m   replicaset-controller  Created pod: nginx-rs-nxklf\n  Normal  SuccessfulCreate  27m   replicaset-controller  Created pod: nginx-rs-t46qc\n  Normal  SuccessfulCreate  24m   replicaset-controller  Created pod: nginx-rs-xsb59\n  Normal  SuccessfulDelete  7s    replicaset-controller  Deleted pod: nginx-rs-xsb59\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 Replicaset \u63a7\u5236\u5668\u5728\u53d1\u73b0\u6211\u4eec\u7684\u8d44\u6e90\u58f0\u660e\u4e2d\u526f\u672c\u6570\u53d8\u66f4\u4e3a 2 \u540e\uff0c\u5c31\u4e3b\u52a8\u53bb\u5220\u9664\u4e86\u4e00\u4e2a Pod\uff0c\u8fd9\u6837\u526f\u672c\u6570\u5c31\u548c\u671f\u671b\u7684\u59cb\u7ec8\u4fdd\u6301\u4e00\u81f4\u4e86\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx\nNAME             READY   STATUS    RESTARTS   AGE\nnginx-rs-nxklf   1/1     Running   0          30m\nnginx-rs-t46qc   1/1     Running   0          30m\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u968f\u4fbf\u67e5\u770b\u4e00\u4e2a Pod \u7684\u63cf\u8ff0\u4fe1\u606f\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a Pod \u7684\u6240\u5c5e\u63a7\u5236\u5668\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe pod nginx-rs-xsb59\nName:               nginx-rs-xsb59\nNamespace:          default\nPriority:           0\nPriorityClassName:  &lt;none&gt;\nNode:               ydzs-node1/122\nStart Time:         Fri, 15 Nov 2019 14:18:10 +0800\nLabels:             app=nginx\nAnnotations:        &lt;none&gt;\nStatus:             Running\nIP:                 2148\nControlled By:      ReplicaSet/nginx-rs\n.......\n</code></pre> <p>\u53e6\u5916\u88ab ReplicaSet \u6301\u6709\u7684 Pod \u6709\u4e00\u4e2a </p> <pre><code>metadata.ownerReferences\n</code></pre> <p>\u6307\u9488\u6307\u5411\u5f53\u524d\u7684 ReplicaSet\uff0c\u8868\u793a\u5f53\u524d Pod \u7684\u6240\u6709\u8005\uff0c\u8fd9\u4e2a\u5f15\u7528\u4e3b\u8981\u4f1a\u88ab\u96c6\u7fa4\u4e2d\u7684<code>\u5783\u573e\u6536\u96c6\u5668</code>\u4f7f\u7528\u4ee5\u6e05\u7406\u5931\u53bb\u6240\u6709\u8005\u7684 Pod \u5bf9\u8c61\u3002\u8fd9\u4e2a <code>ownerReferences</code> \u548c\u6570\u636e\u5e93\u4e2d\u7684<code>\u5916\u952e</code>\u662f\u4e0d\u662f\u975e\u5e38\u7c7b\u4f3c\u3002\u53ef\u4ee5\u901a\u8fc7\u5c06 Pod \u8d44\u6e90\u63cf\u8ff0\u4fe1\u606f\u5bfc\u51fa\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get pod nginx-rs-xsb59 -o yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  creationTimestamp: \"2019-11-15T06:18:10Z\"\n  generateName: nginx-rs-\n  labels:\n    app: nginx\n  name: nginx-rs-xsb59\n  namespace: default\n  ownerReferences:  \n  - apiVersion: apps/v1\n    blockOwnerDeletion: true\n    controller: true\n    kind: ReplicaSet\n    name: nginx-rs\n    uid: 4a3121fa-b5ae-4def-b2d2-bf17bc06b7b7\n  resourceVersion: \"1781596\"\n  selfLink: /api/v1/namespaces/default/pods/nginx-rs-xsb59\n  uid: 0a4cae9a-105b-4024-ae96-ee516bfb2d23\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pod \u4e2d\u6709\u4e00\u4e2a </p> <pre><code>metadata.ownerReferences\n</code></pre> <p>\u7684\u5b57\u6bb5\u6307\u5411\u4e86 ReplicaSet \u8d44\u6e90\u5bf9\u8c61\u3002\u5982\u679c\u8981\u5f7b\u5e95\u5220\u9664 Pod\uff0c\u6211\u4eec\u5c31\u53ea\u80fd\u5220\u9664 RS \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl delete rs nginx-rs\n# \u6216\u8005\u6267\u884c kubectl delete -f nginx-rs.yaml\n</code></pre> <p>\u8fd9\u5c31\u662f ReplicaSet \u5bf9\u8c61\u7684\u57fa\u672c\u4f7f\u7528\u3002</p>"},{"location":"kubernetes_controller/replicaset/#replication_controller","title":"Replication Controller","text":"<p>Replication Controller \u7b80\u79f0 RC\uff0c\u5b9e\u9645\u4e0a RC \u548c RS \u7684\u529f\u80fd\u51e0\u4e4e\u4e00\u81f4\uff0cRS \u7b97\u662f\u5bf9 RC \u7684\u6539\u8fdb\uff0c\u76ee\u524d\u552f\u4e00\u7684\u4e00\u4e2a\u533a\u522b\u5c31\u662f RC \u53ea\u652f\u6301\u57fa\u4e8e\u7b49\u5f0f\u7684 selector\uff08env=dev\u6216environment!=qa\uff09\uff0c\u4f46 RS \u8fd8\u652f\u6301\u57fa\u4e8e\u96c6\u5408\u7684 selector\uff08version in (v1.0, v2.0)\uff09\uff0c\u8fd9\u5bf9\u590d\u6742\u7684\u8fd0\u7ef4\u7ba1\u7406\u5c31\u975e\u5e38\u65b9\u4fbf\u4e86\u3002</p> <p>\u6bd4\u5982\u4e0a\u9762\u8d44\u6e90\u5bf9\u8c61\u5982\u679c\u6211\u4eec\u8981\u4f7f\u7528 RC \u7684\u8bdd\uff0c\u5bf9\u5e94\u7684 selector \u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>selector: \n  app: nginx\n</code></pre> <p>RC \u53ea\u652f\u6301\u5355\u4e2a Label \u7684\u7b49\u5f0f\uff0c\u800c RS \u4e2d\u7684 Label Selector \u652f\u6301 <code>matchLabels</code> \u548c <code>matchExpressions</code> \u4e24\u79cd\u5f62\u5f0f\uff1a</p> <pre><code>selector:  \n  matchLabels:\n    app: nginx\n\n---\nselector:\n  matchExpressions:  # \u8be5\u9009\u62e9\u5668\u8981\u6c42 Pod \u5305\u542b\u540d\u4e3a app \u7684\u6807\u7b7e\n  - key: app\n    operator: In\n    values:  # \u5e76\u4e14\u6807\u7b7e\u7684\u503c\u5fc5\u987b\u662f nginx\n    - nginx\n</code></pre> <p>\u603b\u7684\u6765\u8bf4 RS \u662f\u65b0\u4e00\u4ee3\u7684 RC\uff0c\u6240\u4ee5\u4ee5\u540e\u6211\u4eec\u4e0d\u4f7f\u7528 RC\uff0c\u76f4\u63a5\u4f7f\u7528 RS \u5373\u53ef\uff0c\u4ed6\u4eec\u7684\u529f\u80fd\u90fd\u662f\u4e00\u81f4\u7684\uff0c\u4f46\u662f\u5b9e\u9645\u4e0a\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\u6211\u4eec\u4e5f\u4e0d\u4f1a\u76f4\u63a5\u4f7f\u7528 RS\uff0c\u800c\u662f\u4f7f\u7528\u66f4\u4e0a\u5c42\u7684\u7c7b\u4f3c\u4e8e Deployment \u8fd9\u6837\u7684\u8d44\u6e90\u5bf9\u8c61\u3002</p>"},{"location":"kubernetes_controller/statefulset/","title":"StatefulSet","text":""},{"location":"kubernetes_controller/statefulset/#statefulset","title":"StatefulSet \u63a7\u5236\u5668","text":"<p>\u524d\u9762\u6211\u4eec\u5b66\u4e60\u4e86 Deployment \u548c ReplicaSet \u4e24\u79cd\u8d44\u6e90\u5bf9\u8c61\u5f97\u4f7f\u7528\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u7684\u8fc7\u7a0b\u4e2d\uff0cDeployment \u5e76\u4e0d\u80fd\u7f16\u6392\u6240\u6709\u7c7b\u578b\u7684\u5e94\u7528\uff0c\u5bf9<code>\u65e0\u72b6\u6001\u670d\u52a1</code>\u7f16\u6392\u662f\u975e\u5e38\u5bb9\u6613\u7684\uff0c\u4f46\u662f\u5bf9\u4e8e<code>\u6709\u72b6\u6001\u670d\u52a1</code>\u5c31\u65e0\u80fd\u4e3a\u529b\u4e86\u3002\u6211\u4eec\u9700\u8981\u5148\u660e\u767d\u4e00\u4e2a\u6982\u5ff5\uff1a\u4ec0\u4e48\u662f\u6709\u72b6\u6001\u670d\u52a1\uff0c\u4ec0\u4e48\u662f\u65e0\u72b6\u6001\u670d\u52a1\u3002</p> <ul> <li> <p><code>\u65e0\u72b6\u6001\u670d\u52a1\uff08Stateless Service\uff09</code></p> <p>\uff1a\u8be5\u670d\u52a1\u8fd0\u884c\u7684\u5b9e\u4f8b\u4e0d\u4f1a\u5728\u672c\u5730\u5b58\u50a8\u9700\u8981\u6301\u4e45\u5316\u7684\u6570\u636e\uff0c\u5e76\u4e14\u591a\u4e2a\u5b9e\u4f8b\u5bf9\u4e8e\u540c\u4e00\u4e2a\u8bf7\u6c42\u54cd\u5e94\u7684\u7ed3\u679c\u662f\u5b8c\u5168\u4e00\u81f4\u7684\uff0c\u6bd4\u5982\u524d\u9762\u6211\u4eec\u8bb2\u89e3\u7684 WordPress \u5b9e\u4f8b\uff0c\u6211\u4eec\u662f\u4e0d\u662f\u53ef\u4ee5\u540c\u65f6\u542f\u52a8\u591a\u4e2a\u5b9e\u4f8b\uff0c\u4f46\u662f\u6211\u4eec\u8bbf\u95ee\u4efb\u610f\u4e00\u4e2a\u5b9e\u4f8b\u5f97\u5230\u7684\u7ed3\u679c\u90fd\u662f\u4e00\u6837\u7684\u5427\uff1f\u56e0\u4e3a\u4ed6\u552f\u4e00\u9700\u8981\u6301\u4e45\u5316\u7684\u6570\u636e\u662f\u5b58\u50a8\u5728MySQL\u6570\u636e\u5e93\u4e2d\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u8bf4 WordPress \u8fd9\u4e2a\u5e94\u7528\u662f\u65e0\u72b6\u6001\u670d\u52a1\uff0c\u4f46\u662f MySQL \u6570\u636e\u5e93\u5c31\u4e0d\u662f\u4e86\uff0c\u56e0\u4e3a\u4ed6\u9700\u8981\u628a\u6570\u636e\u6301\u4e45\u5316\u5230\u672c\u5730\u3002 *   <code>\u6709\u72b6\u6001\u670d\u52a1\uff08Stateful Service\uff09</code></p> <p>\uff1a\u5c31\u548c\u4e0a\u9762\u7684\u6982\u5ff5\u662f\u5bf9\u7acb\u7684\u4e86\uff0c\u8be5\u670d\u52a1\u8fd0\u884c\u7684\u5b9e\u4f8b\u9700\u8981\u5728\u672c\u5730\u5b58\u50a8\u6301\u4e45\u5316\u6570\u636e\uff0c\u6bd4\u5982\u4e0a\u9762\u7684 MySQL \u6570\u636e\u5e93\uff0c\u4f60\u73b0\u5728\u8fd0\u884c\u5728\u8282\u70b9 A\uff0c\u90a3\u4e48\u4ed6\u7684\u6570\u636e\u5c31\u5b58\u50a8\u5728\u8282\u70b9 A \u4e0a\u9762\u7684\uff0c\u5982\u679c\u8fd9\u4e2a\u65f6\u5019\u4f60\u628a\u8be5\u670d\u52a1\u8fc1\u79fb\u5230\u8282\u70b9 B \u53bb\u7684\u8bdd\uff0c\u90a3\u4e48\u5c31\u6ca1\u6709\u4e4b\u524d\u7684\u6570\u636e\u4e86\uff0c\u56e0\u4e3a\u4ed6\u9700\u8981\u53bb\u5bf9\u5e94\u7684\u6570\u636e\u76ee\u5f55\u91cc\u9762\u6062\u590d\u6570\u636e\uff0c\u800c\u6b64\u65f6\u6ca1\u6709\u4efb\u4f55\u6570\u636e\u3002</p> </li> </ul> <p>\u73b0\u5728\u5bf9<code>\u6709\u72b6\u6001</code>\u548c<code>\u65e0\u72b6\u6001</code>\u6709\u4e00\u5b9a\u7684\u8ba4\u8bc6\u4e86\u5427\uff0c\u6bd4\u5982\u6211\u4eec\u5e38\u89c1\u7684 WEB \u5e94\u7528\uff0c\u662f\u901a\u8fc7 Session \u6765\u4fdd\u6301\u7528\u6237\u7684\u767b\u5f55\u72b6\u6001\u7684\uff0c\u5982\u679c\u6211\u4eec\u5c06 Session \u6301\u4e45\u5316\u5230\u8282\u70b9\u4e0a\uff0c\u90a3\u4e48\u8be5\u5e94\u7528\u5c31\u662f\u4e00\u4e2a\u6709\u72b6\u6001\u7684\u670d\u52a1\u4e86\uff0c\u56e0\u4e3a\u6211\u73b0\u5728\u767b\u5f55\u8fdb\u6765\u4f60\u628a\u6211\u7684 Session \u6301\u4e45\u5316\u5230\u8282\u70b9 A \u4e0a\u4e86\uff0c\u4e0b\u6b21\u6211\u767b\u5f55\u7684\u65f6\u5019\u53ef\u80fd\u4f1a\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u8282\u70b9 B \u4e0a\u53bb\u4e86\uff0c\u4f46\u662f\u8282\u70b9 B \u4e0a\u6839\u672c\u5c31\u6ca1\u6709\u6211\u5f53\u524d\u7684 Session \u6570\u636e\uff0c\u5c31\u4f1a\u88ab\u8ba4\u4e3a\u662f\u672a\u767b\u5f55\u72b6\u6001\u4e86\uff0c\u8fd9\u6837\u5c31\u5bfc\u81f4\u6211\u524d\u540e\u4e24\u6b21\u8bf7\u6c42\u5f97\u5230\u7684\u7ed3\u679c\u4e0d\u4e00\u81f4\u4e86\u3002\u6240\u4ee5\u4e00\u822c\u4e3a\u4e86\u6a2a\u5411\u6269\u5c55\uff0c\u6211\u4eec\u90fd\u4f1a\u628a\u8fd9\u7c7b WEB \u5e94\u7528\u6539\u6210\u65e0\u72b6\u6001\u7684\u670d\u52a1\uff0c\u600e\u4e48\u6539\uff1f\u5c06 Session \u6570\u636e\u5b58\u5165\u4e00\u4e2a\u516c\u5171\u7684\u5730\u65b9\uff0c\u6bd4\u5982 Redis \u91cc\u9762\uff0c\u662f\u4e0d\u662f\u5c31\u53ef\u4ee5\u4e86\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u5ba2\u6237\u7aef\u8bf7\u6c42 API \u7684\u60c5\u51b5\uff0c\u6211\u4eec\u5c31\u4e0d\u4f7f\u7528 Session \u6765\u4fdd\u6301\u7528\u6237\u72b6\u6001\uff0c\u6539\u6210\u7528 Token \u4e5f\u662f\u53ef\u4ee5\u7684\u3002</p> <p>\u65e0\u72b6\u6001\u670d\u52a1\u5229\u7528\u6211\u4eec\u524d\u9762\u7684 Deployment \u53ef\u4ee5\u5f88\u597d\u7684\u8fdb\u884c\u7f16\u6392\uff0c\u5bf9\u5e94\u6709\u72b6\u6001\u670d\u52a1\uff0c\u9700\u8981\u8003\u8651\u7684\u7ec6\u8282\u5c31\u8981\u591a\u5f88\u591a\u4e86\uff0c\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\u6700\u56f0\u96be\u7684\u4efb\u52a1\u4e4b\u4e00\uff0c\u5c31\u662f\u8bbe\u8ba1\u6709\u72b6\u6001\u5206\u5e03\u5f0f\u7ec4\u4ef6\u7684\u90e8\u7f72\u4f53\u7cfb\u7ed3\u6784\u3002\u7531\u4e8e\u65e0\u72b6\u6001\u7ec4\u4ef6\u6ca1\u6709\u9884\u5b9a\u4e49\u7684\u542f\u52a8\u987a\u5e8f\u3001\u96c6\u7fa4\u8981\u6c42\u3001\u70b9\u5bf9\u70b9 TCP \u8fde\u63a5\u3001\u552f\u4e00\u7684\u7f51\u7edc\u6807\u8bc6\u7b26\u3001\u6b63\u5e38\u7684\u542f\u52a8\u548c\u7ec8\u6b62\u8981\u6c42\u7b49\uff0c\u56e0\u6b64\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u8fdb\u884c\u5bb9\u5668\u5316\u3002\u8bf8\u5982\u6570\u636e\u5e93\uff0c\u5927\u6570\u636e\u5206\u6790\u7cfb\u7edf\uff0c\u5206\u5e03\u5f0f key/value \u5b58\u50a8\u3001\u6d88\u606f\u4e2d\u95f4\u4ef6\u9700\u8981\u6709\u590d\u6742\u7684\u5206\u5e03\u5f0f\u4f53\u7cfb\u7ed3\u6784\uff0c\u90fd\u53ef\u80fd\u4f1a\u7528\u5230\u4e0a\u8ff0\u529f\u80fd\u3002\u4e3a\u6b64\uff0cKubernetes \u5f15\u5165\u4e86 <code>StatefulSet</code> \u8fd9\u79cd\u8d44\u6e90\u5bf9\u8c61\u6765\u652f\u6301\u8fd9\u79cd\u590d\u6742\u7684\u9700\u6c42\u3002<code>StatefulSet</code> \u7c7b\u4f3c\u4e8e <code>ReplicaSet</code>\uff0c\u4f46\u662f\u5b83\u53ef\u4ee5\u5904\u7406 Pod \u7684\u542f\u52a8\u987a\u5e8f\uff0c\u4e3a\u4fdd\u7559\u6bcf\u4e2a Pod \u7684\u72b6\u6001\u8bbe\u7f6e\u552f\u4e00\u6807\u8bc6\uff0c\u5177\u6709\u4ee5\u4e0b\u51e0\u4e2a\u529f\u80fd\u7279\u6027\uff1a</p> <ul> <li>\u7a33\u5b9a\u7684\u3001\u552f\u4e00\u7684\u7f51\u7edc\u6807\u8bc6\u7b26</li> <li>\u7a33\u5b9a\u7684\u3001\u6301\u4e45\u5316\u7684\u5b58\u50a8</li> <li>\u6709\u5e8f\u7684\u3001\u4f18\u96c5\u7684\u90e8\u7f72\u548c\u7f29\u653e</li> <li>\u6709\u5e8f\u7684\u3001\u4f18\u96c5\u7684\u5220\u9664\u548c\u7ec8\u6b62</li> <li>\u6709\u5e8f\u7684\u3001\u81ea\u52a8\u6eda\u52a8\u66f4\u65b0</li> </ul>"},{"location":"kubernetes_controller/statefulset/#headless_service","title":"Headless Service","text":"<p>\u5728\u6211\u4eec\u5b66\u4e60 StatefulSet \u5bf9\u8c61\u4e4b\u524d\uff0c\u6211\u4eec\u8fd8\u5fc5\u987b\u4e86\u89e3\u4e00\u4e2a\u65b0\u7684\u6982\u5ff5\uff1a<code>Headless Service</code>\u3002<code>Service</code> \u5176\u5b9e\u5728\u4e4b\u524d\u6211\u4eec\u548c\u5927\u5bb6\u63d0\u5230\u8fc7\uff0cService \u662f\u5e94\u7528\u670d\u52a1\u7684\u62bd\u8c61\uff0c\u901a\u8fc7 Labels \u4e3a\u5e94\u7528\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u548c\u670d\u52a1\u53d1\u73b0\uff0c\u6bcf\u4e2a Service \u90fd\u4f1a\u81ea\u52a8\u5206\u914d\u4e00\u4e2a cluster IP \u548c DNS \u540d\uff0c\u5728\u96c6\u7fa4\u5185\u90e8\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8be5\u5730\u5740\u6216\u8005\u901a\u8fc7 FDQN \u7684\u5f62\u5f0f\u6765\u8bbf\u95ee\u670d\u52a1\u3002\u6bd4\u5982\uff0c\u4e00\u4e2a Deployment \u6709 3 \u4e2a Pod\uff0c\u90a3\u4e48\u6211\u5c31\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a Service\uff0c\u6709\u5982\u4e0b\u4e24\u79cd\u65b9\u5f0f\u6765\u8bbf\u95ee\u8fd9\u4e2a Service\uff1a</p> <ul> <li>cluster IP \u7684\u65b9\u5f0f\uff0c\u6bd4\u5982\uff1a\u5f53\u6211\u8bbf\u95ee 10.109.169.155 \u8fd9\u4e2a Service \u7684 IP \u5730\u5740\u65f6\uff0c10.109.169.155 \u5176\u5b9e\u5c31\u662f\u4e00\u4e2a VIP\uff0c\u5b83\u4f1a\u628a\u8bf7\u6c42\u8f6c\u53d1\u5230\u8be5 Service \u6240\u4ee3\u7406\u7684 Endpoints \u5217\u8868\u4e2d\u7684\u67d0\u4e00\u4e2a Pod \u4e0a\u3002\u5177\u4f53\u539f\u7406\u6211\u4eec\u4f1a\u5728\u540e\u9762\u7684 Service \u7ae0\u8282\u4e2d\u548c\u5927\u5bb6\u6df1\u5165\u4e86\u89e3\u3002</li> <li> <p>Service \u7684 DNS \u65b9\u5f0f\uff0c\u6bd4\u5982\u6211\u4eec\u8bbf\u95ee</p> <pre><code>\u201cmysvc.mynamespace.svc.cluster.local\u201d\n</code></pre> <p>\u8fd9\u6761 DNS \u8bb0\u5f55\uff0c\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230 mynamespace \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u540d\u4e3a mysvc \u7684 Service \u6240\u4ee3\u7406\u7684\u67d0\u4e00\u4e2a Pod\u3002</p> </li> </ul> <p>\u5bf9\u4e8e DNS \u8fd9\u79cd\u65b9\u5f0f\u5b9e\u9645\u4e0a\u4e5f\u6709\u4e24\u79cd\u60c5\u51b5\uff1a</p> <ul> <li> <p>\u7b2c\u4e00\u79cd\u5c31\u662f\u666e\u901a\u7684 Service\uff0c\u6211\u4eec\u8bbf\u95ee</p> <pre><code>\u201cmysvc.mynamespace.svc.cluster.local\u201d\n</code></pre> <p>\u7684\u65f6\u5019\u662f\u901a\u8fc7\u96c6\u7fa4\u4e2d\u7684 DNS \u670d\u52a1\u89e3\u6790\u5230\u7684 mysvc \u8fd9\u4e2a Service \u7684 cluster IP \u7684 *   \u7b2c\u4e8c\u79cd\u60c5\u51b5\u5c31\u662f<code>Headless Service</code>\uff0c\u5bf9\u4e8e\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u8bbf\u95ee</p> <pre><code>\u201cmysvc.mynamespace.svc.cluster.local\u201d\n</code></pre> <p>\u7684\u65f6\u5019\u662f\u76f4\u63a5\u89e3\u6790\u5230\u7684 mysvc \u4ee3\u7406\u7684\u67d0\u4e00\u4e2a\u5177\u4f53\u7684 Pod \u7684 IP \u5730\u5740\uff0c\u4e2d\u95f4\u5c11\u4e86 cluster IP \u7684\u8f6c\u53d1\uff0c\u8fd9\u5c31\u662f\u4e8c\u8005\u7684\u6700\u5927\u533a\u522b\uff0cHeadless Service \u4e0d\u9700\u8981\u5206\u914d\u4e00\u4e2a VIP\uff0c\u800c\u662f\u53ef\u4ee5\u76f4\u63a5\u4ee5 DNS \u7684\u8bb0\u5f55\u65b9\u5f0f\u89e3\u6790\u5230\u540e\u9762\u7684 Pod \u7684 IP \u5730\u5740\u3002</p> </li> </ul> <p>\u6bd4\u5982\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u5982\u4e0b\u7684 <code>Headless Service</code>\uff1a(headless-svc.yaml)</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: nginx\n  namespace: default\n  labels:\n    app: nginx\nspec:\n  ports:\n  - name: http\n    port: 80\n  clusterIP: None\n  selector:\n    app: nginx\n</code></pre> <p>\u5b9e\u9645\u4e0a <code>Headless Service</code> \u5728\u5b9a\u4e49\u4e0a\u548c\u666e\u901a\u7684 Service \u51e0\u4e4e\u4e00\u81f4, \u53ea\u662f\u4ed6\u7684 <code>clusterIP=None</code>\uff0c\u6240\u4ee5\uff0c\u8fd9\u4e2a Service \u88ab\u521b\u5efa\u540e\u5e76\u4e0d\u4f1a\u88ab\u5206\u914d\u4e00\u4e2a cluster IP\uff0c\u800c\u662f\u4f1a\u4ee5 DNS \u8bb0\u5f55\u7684\u65b9\u5f0f\u66b4\u9732\u51fa\u5b83\u6240\u4ee3\u7406\u7684 Pod\uff0c\u800c\u4e14\u8fd8\u6709\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7279\u6027\uff0c\u5bf9\u4e8e <code>Headless Service</code> \u6240\u4ee3\u7406\u7684\u6240\u6709 Pod \u7684 IP \u5730\u5740\u90fd\u4f1a\u7ed1\u5b9a\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 DNS \u8bb0\u5f55\uff1a</p> <pre><code>&lt;pod-name&gt;.&lt;svc-name&gt;.&lt;namespace&gt;.svc.cluster.local\n</code></pre> <p>\u8fd9\u4e2a DNS \u8bb0\u5f55\u6b63\u662f Kubernetes \u96c6\u7fa4\u4e3a Pod \u5206\u914d\u7684\u4e00\u4e2a\u552f\u4e00\u6807\u8bc6\uff0c\u53ea\u8981\u6211\u4eec\u77e5\u9053 Pod \u7684\u540d\u5b57\uff0c\u4ee5\u53ca\u5b83\u5bf9\u5e94\u7684 Service \u540d\u5b57\uff0c\u5c31\u53ef\u4ee5\u7ec4\u88c5\u51fa\u8fd9\u6837\u4e00\u6761 DNS \u8bb0\u5f55\u8bbf\u95ee\u5230 Pod \u7684 IP \u5730\u5740\uff0c\u8fd9\u4e2a\u80fd\u529b\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u770b\u4e0b StatefulSet \u8d44\u6e90\u5bf9\u8c61\u662f\u5982\u4f55\u7ed3\u5408 Headless Service \u63d0\u4f9b\u670d\u52a1\u7684\u3002</p>"},{"location":"kubernetes_controller/statefulset/#statefulset_1","title":"StatefulSet","text":"<p>\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u51c6\u5907\u4e24\u4e2a 1G \u7684\u5b58\u50a8\u5377\uff08PV\uff09\uff0c\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u4e5f\u4f1a\u548c\u5927\u5bb6\u8be6\u7ec6\u8bb2\u89e3 PV \u548c PVC \u7684\u4f7f\u7528\u65b9\u6cd5\u7684\uff0c\u8fd9\u91cc\u6211\u4eec\u5148\u4e0d\u6df1\u7a76\uff1a\uff08pv.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: pv001\nspec:\n  capacity:\n    storage: 1Gi\n  accessModes:\n  - ReadWriteOnce\n  hostPath:\n    path: /tmp/pv001\n\n---\n\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: pv002\nspec:\n  capacity:\n    storage: 1Gi\n  accessModes:\n  - ReadWriteOnce\n  hostPath:\n    path: /tmp/pv002\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa PV \u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f pv.yaml\npersistentvolume \"pv001\" created\npersistentvolume \"pv002\" created\n$ kubectl get pv\nkubectl get pv\nNAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE\npv001     1Gi        RWO            Recycle          Available                                      12s\npv002     1Gi        RWO            Recycle          Available                                      11s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6210\u529f\u521b\u5efa\u4e86\u4e24\u4e2a PV \u5bf9\u8c61\uff0c\u72b6\u6001\u662f\uff1a<code>Available</code>\u3002</p>"},{"location":"kubernetes_controller/statefulset/#_1","title":"\u7279\u6027","text":"<p>\u7136\u540e\u63a5\u4e0b\u6765\u58f0\u660e\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 StatefulSet \u8d44\u6e90\u6e05\u5355\uff1a\uff08nginx-sts.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: web\n  namespace: default\nspec:\n  serviceName: \"nginx\"\n  replicas: 2\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - name: web\n          containerPort: 80\n        volumeMounts:\n        - name: www\n          mountPath: /usr/share/nginx/html\n  volumeClaimTemplates:\n  - metadata:\n      name: www\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      resources:\n        requests:\n          storage: 1Gi\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u4e2d\u53ef\u4ee5\u770b\u51fa\u548c\u6211\u4eec\u524d\u9762\u7684 Deployment \u57fa\u672c\u4e0a\u4e5f\u662f\u4e00\u81f4\u7684\uff0c\u4e5f\u662f\u901a\u8fc7\u58f0\u660e\u7684 Pod \u6a21\u677f\u6765\u521b\u5efa Pod \u7684\uff0c\u53e6\u5916\u4e0a\u9762\u8d44\u6e90\u6e05\u5355\u4e2d\u548c <code>volumeMounts</code> \u8fdb\u884c\u5173\u8054\u7684\u4e0d\u662f <code>volumes</code> \u800c\u662f\u4e00\u4e2a\u65b0\u7684\u5c5e\u6027\uff1a<code>volumeClaimTemplates</code>\uff0c\u8be5\u5c5e\u6027\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a PVC \u5bf9\u8c61\uff0c\u5176\u5b9e\u8fd9\u91cc\u5c31\u662f\u4e00\u4e2a PVC \u7684\u6a21\u677f\uff0c\u548c Pod \u6a21\u677f\u7c7b\u4f3c\uff0cPVC \u88ab\u521b\u5efa\u540e\u4f1a\u81ea\u52a8\u53bb\u5173\u8054\u5f53\u524d\u7cfb\u7edf\u4e2d\u548c\u4ed6\u5408\u9002\u7684 PV \u8fdb\u884c\u7ed1\u5b9a\u3002\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u591a\u4e86\u4e00\u4e2a <code>serviceName: \"nginx\"</code> \u7684\u5b57\u6bb5\uff0c<code>serviceName</code> \u5c31\u662f\u7ba1\u7406\u5f53\u524d <code>StatefulSet</code> \u7684\u670d\u52a1\u540d\u79f0\uff0c\u8be5\u670d\u52a1\u5fc5\u987b\u5728 StatefulSet \u4e4b\u524d\u5b58\u5728\uff0c\u5e76\u4e14\u8d1f\u8d23\u8be5\u96c6\u5408\u7684\u7f51\u7edc\u6807\u8bc6\uff0cPod \u4f1a\u9075\u5faa\u4ee5\u4e0b\u683c\u5f0f\u83b7\u53d6 DNS/\u4e3b\u673a\u540d\uff1a</p> <pre><code>pod-specific-string.serviceName.default.svc.cluster.local\n</code></pre> <p>\uff0c\u5176\u4e2d <code>pod-specific-string</code> \u7531 StatefulSet \u63a7\u5236\u5668\u7ba1\u7406\u3002</p> <p></p> <p><code>StatefulSet</code> \u7684\u62d3\u6251\u7ed3\u6784\u548c\u5176\u4ed6\u7528\u4e8e\u90e8\u7f72\u7684\u8d44\u6e90\u5bf9\u8c61\u5176\u5b9e\u6bd4\u8f83\u7c7b\u4f3c\uff0c\u6bd4\u8f83\u5927\u7684\u533a\u522b\u5728\u4e8e <code>StatefulSet</code> \u5f15\u5165\u4e86 PV \u548c PVC \u5bf9\u8c61\u6765\u6301\u4e45\u5b58\u50a8\u670d\u52a1\u4ea7\u751f\u7684\u72b6\u6001\uff0c\u8fd9\u6837\u6240\u6709\u7684\u670d\u52a1\u867d\u7136\u53ef\u4ee5\u88ab\u6740\u6389\u6216\u8005\u91cd\u542f\uff0c\u4f46\u662f\u5176\u4e2d\u7684\u6570\u636e\u7531\u4e8e PV \u7684\u539f\u56e0\u4e0d\u4f1a\u4e22\u5931\u3002</p> <p>\u6ce8\u610f</p> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u7528<code>volumeClaimTemplates</code>\u58f0\u660e\u7684\u6a21\u677f\u662f\u6302\u8f7d\u70b9\u7684\u65b9\u5f0f\uff0c\u5e76\u4e0d\u662f volume\uff0c\u6240\u6709\u5b9e\u9645\u4e0a\u4e0a\u5f53\u4e8e\u628a PV \u7684\u5b58\u50a8\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\uff0c\u6240\u4ee5\u4f1a\u8986\u76d6\u6389\u5bb9\u5668\u4e2d\u7684\u6570\u636e\uff0c\u5728\u5bb9\u5668\u542f\u52a8\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u624b\u52a8\u5728 PV \u7684\u5b58\u50a8\u91cc\u9762\u65b0\u5efa index.html \u6587\u4ef6\u6765\u4fdd\u8bc1\u5bb9\u5668\u7684\u6b63\u5e38\u8bbf\u95ee\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u8fdb\u5165\u5230\u5bb9\u5668\u4e2d\u53bb\u521b\u5efa\uff0c\u8fd9\u6837\u66f4\u52a0\u65b9\u4fbf\uff1a</p> <pre><code>$ for i in 0 1; do kubectl exec web-$i -- sh -c 'echo hello $(hostname) &gt; /usr/share/nginx/html/index.html'; done\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u4f18\u5148\u521b\u5efa\u4e0a\u9762\u5b9a\u4e49\u7684 <code>Headless Service</code>\uff1a</p> <pre><code>$ kubectl apply -f headless-svc.yaml\nservice/nginx created\n$ kubectl get service nginx\nNAME    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nnginx   ClusterIP   None         &lt;none&gt;        80/TCP    9s\n</code></pre> <p><code>Headless Service</code> \u521b\u5efa\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u6765\u521b\u5efa\u5bf9\u5e94\u7684 StatefulSet \u5bf9\u8c61\u4e86\uff1a</p> <pre><code>$ kubectl apply -f nginx-sts.yaml \nstatefulset.apps/web created\n$ kubectl get pvc\nNAME        STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nwww-web-0   Bound    pv001    1Gi        RWO                           10m\nwww-web-1   Bound    pv002    1Gi        RWO                           6m26s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u901a\u8fc7 Volume \u6a21\u677f\u81ea\u52a8\u751f\u6210\u4e86\u4e24\u4e2a PVC \u5bf9\u8c61\uff0c\u4e5f\u81ea\u52a8\u548c PV \u8fdb\u884c\u4e86\u7ed1\u5b9a\u3002\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u5feb\u901f\u901a\u8fc7\u4e00\u4e2a <code>--watch</code> \u53c2\u6570\u6765\u67e5\u770b Pod \u7684\u521b\u5efa\u8fc7\u7a0b\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx --watch \nNAME                      READY   STATUS              RESTARTS   AGE\nweb-0                     0/1     ContainerCreating   0          1s\nweb-0                     1/1     Running             0          2s\nweb-1                     0/1     Pending             0          0s\nweb-1                     0/1     Pending             0          0s\nweb-1                     0/1     ContainerCreating   0          0s\nweb-1                     1/1     Running             0          6s\n</code></pre> <p>\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u6574\u4e2a\u8fc7\u7a0b\u51fa\u73b0\u4e86\u4e24\u4e2a Pod\uff1a<code>web-0</code> \u548c <code>web-1</code>\uff0c\u800c\u4e14\u8fd9\u4e24\u4e2a Pod \u662f\u6309\u7167\u987a\u5e8f\u8fdb\u884c\u521b\u5efa\u7684\uff0c<code>web-0</code> \u542f\u52a8\u8d77\u6765\u540e <code>web-1</code> \u624d\u5f00\u59cb\u521b\u5efa\u3002\u5982\u540c\u4e0a\u9762 StatefulSet \u6982\u5ff5\u4e2d\u6240\u63d0\u5230\u7684\uff0cStatefulSet \u4e2d\u7684 Pod \u62e5\u6709\u4e00\u4e2a\u5177\u6709\u7a33\u5b9a\u7684\u3001\u72ec\u4e00\u65e0\u4e8c\u7684\u8eab\u4efd\u6807\u5fd7\u3002\u8fd9\u4e2a\u6807\u5fd7\u57fa\u4e8e StatefulSet \u63a7\u5236\u5668\u5206\u914d\u7ed9\u6bcf\u4e2a Pod \u7684\u552f\u4e00\u987a\u5e8f\u7d22\u5f15\u3002Pod \u7684\u540d\u79f0\u7684\u5f62\u5f0f\u4e3a</p> <pre><code>&lt;statefulset name&gt;-&lt;ordinal index&gt;\n</code></pre> <p>\u3002\u6211\u4eec\u8fd9\u91cc\u7684\u5bf9\u8c61\u62e5\u6709\u4e24\u4e2a\u526f\u672c\uff0c\u6240\u4ee5\u5b83\u521b\u5efa\u4e86\u4e24\u4e2a Pod \u540d\u79f0\u5206\u522b\u4e3a\uff1aweb-0 \u548c web-1\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>kubectl exec</code> \u547d\u4ee4\u8fdb\u5165\u5230\u5bb9\u5668\u4e2d\u67e5\u770b\u5b83\u4eec\u7684 hostname\uff1a</p> <pre><code>$ kubectl exec web-0 hostname\nweb-0\n$ kubectl exec web-1 hostname\nweb-1\n</code></pre> <p>\u987a\u5e8f</p> <p>StatefulSet \u4e2d Pod \u526f\u672c\u7684\u521b\u5efa\u4f1a\u6309\u7167\u5e8f\u5217\u53f7<code>\u5347\u5e8f</code>\u5904\u7406\uff0c\u526f\u672c\u7684\u66f4\u65b0\u548c\u5220\u9664\u4f1a\u6309\u7167\u5e8f\u5217\u53f7<code>\u964d\u5e8f</code>\u5904\u7406\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e24\u4e2a Pod \u7684 hostname \u4e0e Pod \u540d\u5b57\u662f\u4e00\u81f4\u7684\uff0c\u90fd\u88ab\u5206\u914d\u4e86\u5bf9\u5e94\u7684\u7f16\u53f7\u3002\u6211\u4eec\u968f\u610f\u67e5\u770b\u4e00\u4e2a Pod \u7684\u63cf\u8ff0\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe pod web-0\nName:               web-0\nNamespace:          default\nPriority:           0\nPriorityClassName:  &lt;none&gt;\nNode:               ydzs-node3/157\nStart Time:         Sun, 17 Nov 2019 12:32:50 +0800\nLabels:             app=nginx\n                    controller-revision-hash=web-6c5c7fd59b\n                    statefulset.kubernetes.io/pod-name=web-0\nAnnotations:        podpreset.admission.kubernetes.io/podpreset-time-preset: 2062768\nStatus:             Running\nIP:                 298\nControlled By:      StatefulSet/web\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230</p> <pre><code>Controlled By: StatefulSet/web\n</code></pre> <p>\uff0c\u8bc1\u660e\u6211\u4eec\u7684 Pod \u662f\u76f4\u63a5\u53d7\u5230 StatefulSet \u63a7\u5236\u5668\u7ba1\u7406\u7684\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u521b\u5efa\u4e00\u4e2a busybox\uff08\u8be5\u955c\u50cf\u4e2d\u6709\u4e00\u7cfb\u5217\u7684\u5de5\u5177\uff09\u7684\u5bb9\u5668\uff0c\u5728\u5bb9\u5668\u4e2d\u7528 DNS \u7684\u65b9\u5f0f\u6765\u8bbf\u95ee\u4e00\u4e0b\u8fd9\u4e2a <code>Headless Service</code>\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u5355\u7eaf\u7684\u4e3a\u4e86\u6d4b\u8bd5\uff0c\u6240\u4ee5\u6ca1\u5fc5\u8981\u5199\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u6765\u58f0\u660e\uff0c\u7528<code>kubectl run</code>\u547d\u4ee4\u542f\u52a8\u4e00\u4e2a\u6d4b\u8bd5\u7684\u5bb9\u5668\u5373\u53ef\uff1a</p> <pre><code>$ kubectl run -it --image busybox:3 test --restart=Never --rm /bin/sh\nIf you don't see a command prompt, try pressing enter.\n/ #\n</code></pre> <p>busybox \u955c\u50cf</p> <p><code>busybox</code> \u6700\u65b0\u7248\u672c\u7684\u955c\u50cf\u6709 BUG\uff0c\u4f1a\u51fa\u73b0<code>nslookup</code>\u63d0\u793a\u65e0\u6cd5\u89e3\u6790\u7684\u95ee\u9898\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u8001\u4e00\u70b9\u7684\u955c\u50cf\u7248\u672c<code>1.28.3</code>\u5373\u53ef\u3002</p> <p>\u5982\u679c\u5bf9 <code>kubectl run</code> \u547d\u4ee4\u7684\u4f7f\u7528\u53c2\u6570\u4e0d\u6e05\u695a\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>kubectl run --help</code> \u547d\u4ee4\u67e5\u770b\u53ef\u4f7f\u7528\u7684\u53c2\u6570\u3002\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 <code>kubectl run</code> \u547d\u4ee4\u542f\u52a8\u4e86\u4e00\u4e2a\u4ee5 busybox \u4e3a\u955c\u50cf\u7684 Pod\uff0c<code>--rm</code> \u53c2\u6570\u610f\u5473\u7740\u6211\u4eec\u9000\u51fa Pod \u540e\u5c31\u4f1a\u88ab\u5220\u9664\uff0c\u548c\u4e4b\u524d\u7684 <code>docker run</code> \u547d\u4ee4\u7528\u6cd5\u57fa\u672c\u4e00\u81f4\uff0c\u73b0\u5728\u6211\u4eec\u5728\u8fd9\u4e2a Pod \u5bb9\u5668\u91cc\u9762\u53ef\u4ee5\u4f7f\u7528 <code>nslookup</code> \u547d\u4ee4\u6765\u5c1d\u8bd5\u89e3\u6790\u4e0b\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684 <code>Headless Service</code>\uff1a</p> <pre><code>/ # nslookup nginx\nServer:    10\nAddress 1: 10 kube-dns.kube-system.svc.cluster.local\n\nName:      nginx\nAddress 1: 2175 web-nginx.default.svc.cluster.local\nAddress 2: 283 web-nginx.default.svc.cluster.local\n/ # ping nginx\nPING nginx (2175): 56 data bytes\n64 bytes from 2175: seq=0 ttl=62 time=076 ms\n64 bytes from 2175: seq=1 ttl=62 time=029 ms\n64 bytes from 2175: seq=2 ttl=62 time=075 ms\n</code></pre> <p>\u6211\u4eec\u76f4\u63a5\u89e3\u6790 <code>Headless Service</code> \u7684\u540d\u79f0\uff0c\u53ef\u4ee5\u770b\u5230\u5f97\u5230\u7684\u662f\u4e24\u4e2a Pod \u7684\u89e3\u6790\u8bb0\u5f55\uff0c\u4f46\u5b9e\u9645\u4e0a\u5982\u679c\u6211\u4eec\u901a\u8fc7<code>nginx</code>\u8fd9\u4e2a DNS \u53bb\u8bbf\u95ee\u6211\u4eec\u7684\u670d\u52a1\u7684\u8bdd\uff0c\u5e76\u4e0d\u4f1a\u968f\u673a\u6216\u8005\u8f6e\u8be2\u80cc\u540e\u7684\u4e24\u4e2a Pod\uff0c\u800c\u662f\u8bbf\u95ee\u5230\u4e00\u4e2a\u56fa\u5b9a\u7684 Pod\uff0c\u6240\u4ee5\u4e0d\u80fd\u4ee3\u66ff\u666e\u901a\u7684 Service\u3002\u5982\u679c\u5206\u522b\u89e3\u6790\u5bf9\u5e94\u7684 Pod \u5462\uff1f</p> <pre><code>$ / # nslookup web-nginx\nServer:    10\nAddress 1: 10 kube-dns.kube-system.svc.cluster.local\n\nName:      web-nginx\nAddress 1: 283 web-nginx.default.svc.cluster.local\n/ # nslookup web-nginx\nServer:    10\nAddress 1: 10 kube-dns.kube-system.svc.cluster.local\n\nName:      web-nginx\nAddress 1: 2175 web-nginx.default.svc.cluster.local\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u89e3\u6790 <code>web-0.nginx</code> \u7684\u65f6\u5019\u89e3\u6790\u5230\u4e86 <code>web-0</code> \u8fd9\u4e2a Pod \u7684 IP\uff0c<code>web-1.nginx</code> \u89e3\u6790\u5230\u4e86 <code>web-1</code> \u8fd9\u4e2a Pod \u7684 IP\uff0c\u800c\u4e14\u8fd9\u4e2a DNS \u5730\u5740\u8fd8\u662f\u7a33\u5b9a\u7684\uff0c\u56e0\u4e3a Pod \u540d\u79f0\u5c31\u662f\u56fa\u5b9a\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u4e2a\u65f6\u5019\u53bb\u5220\u6389 <code>web-0</code> \u548c <code>web-1</code> \u8fd9\u4e24\u4e2a Pod\uff1a</p> <pre><code>$ kubectl delete pod -l app=nginx\npod \"web-0\" deleted\npod \"web-1\" deleted\n</code></pre> <p>\u5220\u9664\u5b8c\u6210\u540e\u624d\u770b Pod \u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx  \nNAME    READY   STATUS    RESTARTS   AGE\nweb-0   1/1     Running   0          42s\nweb-1   1/1     Running   0          39s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 StatefulSet \u63a7\u5236\u5668\u4ecd\u7136\u4f1a\u5b89\u88c5\u987a\u5e8f\u521b\u5efa\u51fa\u4e24\u4e2a Pod \u526f\u672c\u51fa\u6765\uff0c\u800c\u4e14 Pod \u7684\u552f\u4e00\u6807\u8bc6\u4f9d\u7136\u6ca1\u53d8\uff0c\u6240\u4ee5\u8fd9\u4e24\u4e2a Pod \u7684\u7f51\u7edc\u6807\u8bc6\u8fd8\u662f\u56fa\u5b9a\u7684\uff0c\u6211\u4eec\u4f9d\u7136\u53ef\u4ee5\u901a\u8fc7<code>web-0.nginx</code>\u53bb\u8bbf\u95ee\u5230<code>web-0</code>\u8fd9\u4e2a Pod\uff0c\u867d\u7136 Pod \u5df2\u7ecf\u91cd\u5efa\u4e86\uff0c\u5bf9\u5e94 Pod IP \u5df2\u7ecf\u53d8\u5316\u4e86\uff0c\u4f46\u662f\u8bbf\u95ee\u8fd9\u4e2a Pod \u7684\u5730\u5740\u4f9d\u7136\u6ca1\u53d8\uff0c\u5e76\u4e14\u4ed6\u4eec\u4f9d\u7136\u8fd8\u662f\u5173\u8054\u7684\u4e4b\u524d\u7684 PVC\uff0c\u6570\u636e\u5e76\u4e0d\u4f1a\u4e22\u5931\uff1a</p> <pre><code>/ # nslookup web-nginx\nServer:    10\nAddress 1: 10 kube-dns.kube-system.svc.cluster.local\n\nName:      web-nginx\nAddress 1: 298 web-nginx.default.svc.cluster.local\n/ # nslookup web-nginx\nServer:    10\nAddress 1: 10 kube-dns.kube-system.svc.cluster.local\n\nName:      web-nginx\nAddress 1: 2176 web-nginx.default.svc.cluster.local\n</code></pre> <p>\u901a\u8fc7 <code>Headless Service</code>\uff0cStatefulSet \u5c31\u4fdd\u8bc1\u4e86 Pod \u7f51\u7edc\u6807\u8bc6\u7684\u552f\u4e00\u7a33\u5b9a\u6027\uff0c\u7531\u4e8e Pod IP \u5e76\u4e0d\u662f\u56fa\u5b9a\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u8bbf\u95ee<code>\u6709\u72b6\u6001\u5e94\u7528</code>\u5b9e\u4f8b\u7684\u65f6\u5019\uff0c\u5c31\u5fc5\u987b\u4f7f\u7528 DNS \u8bb0\u5f55\u7684\u65b9\u5f0f\u6765\u8bbf\u95ee\u4e86\uff0c\u6240\u4ee5\u5f88\u591a\u540c\u5b66\u5076\u5c14\u6709\u56fa\u5b9a\u7684 Pod IP \u7684\u9700\u6c42\uff0c\u6216\u8bb8\u53ef\u4ee5\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u4ee3\u66ff\u3002</p> <p>\u6700\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5220\u9664 StatefulSet \u5bf9\u8c61\u6765\u5220\u9664\u6240\u6709\u7684 Pod\uff0c\u4ed4\u7ec6\u89c2\u5bdf\u4e5f\u4f1a\u53d1\u73b0\u662f\u6309\u7167\u5012\u5e8f\u7684\u65b9\u5f0f\u8fdb\u884c\u5220\u9664\u7684\uff1a</p> <pre><code>$ kubectl delete statefulsets  web\nstatefulset.apps \"web\" deleted\n$ kubectl get pods --watch\nNAME    READY   STATUS    RESTARTS   AGE\nweb-1   1/1   Terminating   0     3h/31m\nweb-0   1/1   Terminating   0     3h/31m\n</code></pre>"},{"location":"kubernetes_controller/statefulset/#_2","title":"\u7ba1\u7406\u7b56\u7565","text":"<p>\u5bf9\u4e8e\u67d0\u4e9b\u5206\u5e03\u5f0f\u7cfb\u7edf\u6765\u8bf4\uff0cStatefulSet \u7684\u987a\u5e8f\u6027\u4fdd\u8bc1\u662f\u4e0d\u5fc5\u8981\u548c/\u6216\u8005\u4e0d\u5e94\u8be5\u7684\uff0c\u8fd9\u4e9b\u7cfb\u7edf\u4ec5\u4ec5\u8981\u6c42\u552f\u4e00\u6027\u548c\u8eab\u4efd\u6807\u5fd7\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728\u58f0\u660e StatefulSet \u7684\u65f6\u5019\u91cd\u65b0\u8bbe\u7f6e </p> <pre><code>spec.podManagementPolicy\n</code></pre> <p>\u7684\u7b56\u7565\u5373\u53ef\u3002</p> <p>\u9ed8\u8ba4\u7684\u7ba1\u7406\u7b56\u7565\u662f <code>OrderedReady</code>\uff0c\u8868\u793a\u8ba9 StatefulSet \u63a7\u5236\u5668\u9075\u5faa\u4e0a\u6587\u6f14\u793a\u7684\u987a\u5e8f\u6027\u4fdd\u8bc1\u3002\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u4e3a <code>Parallel</code> \u7ba1\u7406\u6a21\u5f0f\uff0c\u8868\u793a\u8ba9 StatefulSet \u63a7\u5236\u5668\u5e76\u884c\u7684\u7ec8\u6b62\u6240\u6709 Pod\uff0c\u5728\u542f\u52a8\u6216\u7ec8\u6b62\u53e6\u4e00\u4e2a Pod \u524d\uff0c\u4e0d\u5fc5\u7b49\u5f85\u8fd9\u4e9b Pod \u53d8\u6210 Running \u548c Ready \u6216\u8005\u5b8c\u5168\u7ec8\u6b62\u72b6\u6001\u3002</p>"},{"location":"kubernetes_controller/statefulset/#_3","title":"\u66f4\u65b0\u7b56\u7565","text":"<p>\u524d\u9762\u8bfe\u7a0b\u4e2d\u6211\u4eec\u5b66\u4e60\u4e86 Deployment \u7684\u5347\u7ea7\u7b56\u7565\uff0c\u5728 StatefulSet \u4e2d\u540c\u6837\u4e5f\u652f\u6301\u4e24\u79cd\u5347\u7ea7\u7b56\u7565\uff1a<code>onDelete</code> \u548c <code>RollingUpdate</code>\uff0c\u540c\u6837\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e </p> <pre><code>.spec.updateStrategy.type\n</code></pre> <p>\u8fdb\u884c\u6307\u5b9a\u3002</p> <ul> <li><code>OnDelete</code>: \u8be5\u7b56\u7565\u8868\u793a\u5f53\u66f4\u65b0\u4e86 <code>StatefulSet</code> \u7684\u6a21\u677f\u540e\uff0c\u53ea\u6709\u624b\u52a8\u5220\u9664\u65e7\u7684 Pod \u624d\u4f1a\u521b\u5efa\u65b0\u7684 Pod\u3002</li> <li><code>RollingUpdate</code>\uff1a\u8be5\u7b56\u7565\u8868\u793a\u5f53\u66f4\u65b0 StatefulSet \u6a21\u677f\u540e\u4f1a\u81ea\u52a8\u5220\u9664\u65e7\u7684 Pod \u5e76\u521b\u5efa\u65b0\u7684Pod\uff0c\u5982\u679c\u66f4\u65b0\u53d1\u751f\u4e86\u9519\u8bef\uff0c\u8fd9\u6b21\u201c\u6eda\u52a8\u66f4\u65b0\u201d\u5c31\u4f1a\u505c\u6b62\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f StatefulSet \u7684 Pod \u5728\u90e8\u7f72\u65f6\u662f\u987a\u5e8f\u4ece 0~n \u7684\uff0c\u800c\u5728\u6eda\u52a8\u66f4\u65b0\u65f6\uff0c\u8fd9\u4e9b Pod \u5219\u662f\u6309\u9006\u5e8f\u7684\u65b9\u5f0f\u5373 n~0 \u4e00\u6b21\u5220\u9664\u5e76\u521b\u5efa\u3002</li> </ul> <p>\u53e6\u5916<code>SatefulSet</code> \u7684\u6eda\u52a8\u5347\u7ea7\u8fd8\u652f\u6301 <code>Partitions</code>\u7684\u7279\u6027\uff0c\u53ef\u4ee5\u901a\u8fc7</p> <pre><code>.spec.updateStrategy.rollingUpdate.partition\n</code></pre> <p>\u8fdb\u884c\u8bbe\u7f6e\uff0c\u5728\u8bbe\u7f6e partition \u540e\uff0cSatefulSet \u7684 Pod \u4e2d\u5e8f\u53f7\u5927\u4e8e\u6216\u7b49\u4e8e partition \u7684 Pod \u4f1a\u5728 StatefulSet \u7684\u6a21\u677f\u66f4\u65b0\u540e\u8fdb\u884c\u6eda\u52a8\u5347\u7ea7\uff0c\u800c\u5176\u4f59\u7684 Pod \u4fdd\u6301\u4e0d\u53d8\uff0c\u8fd9\u4e2a\u529f\u80fd\u662f\u4e0d\u662f\u53ef\u4ee5\u5b9e\u73b0<code>\u7070\u5ea6\u53d1\u5e03</code>\uff1f\u5927\u5bb6\u53ef\u4ee5\u53bb\u624b\u52a8\u9a8c\u8bc1\u4e0b\u3002</p> <p>\u5728\u5b9e\u9645\u7684\u9879\u76ee\u4e2d\uff0c\u5176\u5b9e\u6211\u4eec\u8fd8\u662f\u5f88\u5c11\u4f1a\u53bb\u76f4\u63a5\u901a\u8fc7 StatefulSet \u6765\u90e8\u7f72\u6211\u4eec\u7684\u6709\u72b6\u6001\u670d\u52a1\u7684\uff0c\u9664\u975e\u4f60\u81ea\u5df1\u80fd\u591f\u5b8c\u5168\u80fd\u591f hold \u4f4f\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u7279\u5b9a\u7684\u670d\u52a1\uff0c\u6211\u4eec\u53ef\u80fd\u4f1a\u4f7f\u7528\u66f4\u52a0\u9ad8\u7ea7\u7684 Operator \u6765\u90e8\u7f72\uff0c\u6bd4\u5982 etcd-operator\u3001prometheus-operator \u7b49\u7b49\uff0c\u8fd9\u4e9b\u5e94\u7528\u90fd\u80fd\u591f\u5f88\u597d\u7684\u6765\u7ba1\u7406\u6709\u72b6\u6001\u7684\u670d\u52a1\uff0c\u800c\u4e0d\u662f\u5355\u7eaf\u7684\u4f7f\u7528\u4e00\u4e2a StatefulSet \u6765\u90e8\u7f72\u4e00\u4e2a Pod \u5c31\u884c\uff0c\u56e0\u4e3a\u5bf9\u4e8e\u6709\u72b6\u6001\u7684\u5e94\u7528\u6700\u91cd\u8981\u7684\u8fd8\u662f\u6570\u636e\u6062\u590d\u3001\u6545\u969c\u8f6c\u79fb\u7b49\u7b49\u3002</p>"},{"location":"kubernetes_devops/gitlab/","title":"Gitlab","text":""},{"location":"kubernetes_devops/gitlab/#gitlab","title":"Gitlab","text":"<p>Gitlab \u5b98\u65b9\u63d0\u4f9b\u4e86 Helm \u7684\u65b9\u5f0f\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u6765\u5feb\u901f\u5b89\u88c5\uff0c\u4f46\u662f\u5728\u4f7f\u7528\u7684\u8fc7\u7a0b\u4e2d\u53d1\u73b0 Helm \u63d0\u4f9b\u7684 Chart \u5305\u4e2d\u6709\u5f88\u591a\u5176\u4ed6\u989d\u5916\u7684\u914d\u7f6e\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\b\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u65b9\u5f0f\u6765\u5b89\u88c5\uff0c\u4e5f\u5c31\u662f\u81ea\u5df1\u6765\u5b9a\u4e49\u4e00\u4e9b\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u3002</p> <p>Gitlab \u4e3b\u8981\u6d89\u53ca\u52303\u4e2a\u5e94\u7528\uff1aRedis\u3001Postgresql\u3001Gitlab \u6838\u5fc3\u7a0b\u5e8f\uff0c\u5b9e\u9645\u4e0a\u6211\u4eec\u53ea\u8981\u5c06\u8fd93\u4e2a\u5e94\u7528\u5206\u522b\u542f\u52a8\u8d77\u6765\uff0c\u7136\u540e\u52a0\u4e0a\u5bf9\u5e94\u7684\u914d\u7f6e\b\u5c31\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u5b89\u88c5 Gitlab \u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u9009\u62e9\u4f7f\u7528\u7684\u955c\u50cf\u4e0d\u662f\u5b98\u65b9\u7684\uff0c\u800c\u662f Gitlab \u5bb9\u5668\u5316\u4e2d\u4f7f\u7528\u975e\u5e38\u591a\u7684\u4e00\u4e2a\u7b2c\u4e09\u65b9\u955c\u50cf\uff1asameersbn/gitlab\uff0c\u57fa\u672c\u4e0a\u548c\u5b98\u65b9\u4fdd\u6301\u540c\u6b65\u66f4\u65b0\uff0c\u5730\u5740\uff1ahttp://www.damagehead.com/docker-gitlab/</p> <p>\u5982\u679c\u6211\u4eec\u5df2\u7ecf\u6709\u53ef\u4f7f\u7528\u7684 Redis \u6216 Postgresql \u670d\u52a1\u7684\u8bdd\uff0c\u90a3\u4e48\u76f4\u63a5\u914d\u7f6e\u5728 Gitlab \u73af\u5883\u53d8\u91cf\u4e2d\u5373\u53ef\uff0c\u5982\u679c\u6ca1\u6709\u7684\u8bdd\u5c31\u5355\u72ec\u90e8\u7f72,\u6211\u4eec\u8fd9\u91cc\u4e3a\u4e86\u5c55\u793a gitlab \u90e8\u7f72\u7684\u5b8c\u6574\u6027\uff0c\u8fd8\u662f\u5206\u5f00\u90e8\u7f72\u3002</p> <p>\u9996\u5148\u90e8\u7f72\u9700\u8981\u7684 Redis \u670d\u52a1\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\uff1a(gitlab-redis.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: redis\n  namespace: kube-ops\n  labels:\n    name: redis\nspec:\n  selector:\n    matchLabels:\n      name: redis\n  template:\n    metadata:\n      name: redis\n      labels:\n        name: redis\n    spec:\n      containers:\n      - name: redis\n        image: sameersbn/redis:9-2\n        imagePullPolicy: IfNotPresent\n        ports:\n        - name: redis\n          containerPort: 6379\n        volumeMounts:\n        - mountPath: /var/lib/redis\n          name: data\n        livenessProbe:\n          exec:\n            command:\n            - redis-cli\n            - ping\n          initialDelaySeconds: 30\n          timeoutSeconds: 5\n        readinessProbe:\n          exec:\n            command:\n            - redis-cli\n            - ping\n          initialDelaySeconds: 30\n          timeoutSeconds: 1\n      volumes:\n      - name: data\n        emptyDir: {}\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: redis\n  namespace: kube-ops\n  labels:\n    name: redis\nspec:\n  ports:\n    - name: redis\n      port: 6379\n      targetPort: redis\n  selector:\n    name: redis\n</code></pre> <p>\u7136\u540e\u662f\u6570\u636e\u5e93 Postgresql\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\uff1a(gitlab-postgresql.yaml)</p> <pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: postgresql-pvc\n  namespace: kube-ops\nspec:\n  storageClassName: rook-ceph-block\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 20Gi\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: postgresql\n  namespace: kube-ops\n  labels:\n    name: postgresql\nspec:\n  selector:\n    matchLabels:\n      name: postgresql\n  template:\n    metadata:\n      name: postgresql\n      labels:\n        name: postgresql\n    spec:\n      containers:\n      - name: postgresql\n        image: sameersbn/postgresql:10-2\n        imagePullPolicy: IfNotPresent\n        env:\n        - name: DB_USER\n          value: gitlab\n        - name: DB_PASS\n          value: passw0rd\n        - name: DB_NAME\n          value: gitlab_production\n        - name: DB_EXTENSION\n          value: pg_trgm\n        - name: USERMAP_UID\n          value: \"999\"\n        - name: USERMAP_GID\n          value: \"999\"\n        ports:\n        - name: postgres\n          containerPort: 5432\n        volumeMounts:\n        - mountPath: /var/lib/postgresql\n          name: data\n        readinessProbe:\n          exec:\n            command:\n            - pg_isready\n            - -h\n            - localhost\n            - -U\n            - postgres\n          initialDelaySeconds: 30\n          timeoutSeconds: 1\n      volumes:\n      - name: data\n        persistentVolumeClaim:\n          claimName: postgresql-pvc\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: postgresql\n  namespace: kube-ops\n  labels:\n    name: postgresql\nspec:\n  ports:\n    - name: postgres\n      port: 5432\n      targetPort: postgres\n  selector:\n    name: postgresql\n</code></pre> <p>\u4e3a\u4e86\u63d0\u9ad8\u6570\u636e\u5e93\u7684\u6027\u80fd\uff0c\u6211\u4eec\u8fd9\u91cc\u4e5f\u6ca1\u6709\u4f7f\u7528\u5171\u4eab\u5b58\u50a8\u4e4b\u7c7b\u7684\uff0c\u800c\u662f\u76f4\u63a5\u7528\u7684 Local PV \u5c06\u5e94\u7528\u56fa\u5b9a\u5230\u4e00\u4e2a\u8282\u70b9\u4e0a\u3002\u7136\u540e\u5c31\u662f\u6211\u4eec\u6700\u6838\u5fc3\u7684 Gitlab \u7684\b\u5e94\u7528\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\uff1a(gitlab.yaml)</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: gitlab-pv\nspec:\n  storageClassName: local  # Local PV\n  capacity:\n    storage: 20Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  local:  \n    path: /data/k8s/gitlab/data/\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - ydzs-node4\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: gitlab-pvc\n  namespace: kube-ops\nspec:\n  storageClassName: local\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 20Gi\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: gitlab\n  namespace: kube-ops\n  labels:\n    name: gitlab\nspec:\n  selector:\n    matchLabels:\n      name: gitlab\n  template:\n    metadata:\n      name: gitlab\n      labels:\n        name: gitlab\n    spec:\n      initContainers:\n      - name: fix-permissions\n        image: busybox\n        command: [\"sh\", \"-c\", \"chown -R 1000:1000 /home/git/data\"]\n        securityContext:\n          privileged: true\n        volumeMounts:\n        - name: data\n          mountPath: /home/git/data\n      containers:\n      - name: gitlab\n        image: sameersbn/gitlab:5\n        imagePullPolicy: IfNotPresent\n        env:\n        - name: TZ\n          value: Asia/Shanghai\n        - name: GITLAB_TIMEZONE\n          value: Beijing\n        - name: GITLAB_SECRETS_DB_KEY_BASE\n          value: long-and-random-alpha-numeric-string\n        - name: GITLAB_SECRETS_SECRET_KEY_BASE\n          value: long-and-random-alpha-numeric-string\n        - name: GITLAB_SECRETS_OTP_KEY_BASE\n          value: long-and-random-alpha-numeric-string\n        - name: GITLAB_ROOT_PASSWORD\n          value: admin321\n        - name: GITLAB_ROOT_EMAIL\n          value: 517554016@qq.com\n        - name: GITLAB_HOST\n          value: git.k8s.local\n        - name: GITLAB_PORT\n          value: \"80\"\n        - name: GITLAB_SSH_PORT\n          value: \"22\"\n        - name: GITLAB_NOTIFY_ON_BROKEN_BUILDS\n          value: \"true\"\n        - name: GITLAB_NOTIFY_PUSHER\n          value: \"false\"\n        - name: GITLAB_BACKUP_SCHEDULE\n          value: daily\n        - name: GITLAB_BACKUP_TIME\n          value: 01:00\n        - name: DB_TYPE\n          value: postgres\n        - name: DB_HOST\n          value: postgresql\n        - name: DB_PORT\n          value: \"5432\"\n        - name: DB_USER\n          value: gitlab\n        - name: DB_PASS\n          value: passw0rd\n        - name: DB_NAME\n          value: gitlab_production\n        - name: REDIS_HOST\n          value: redis\n        - name: REDIS_PORT\n          value: \"6379\"\n        ports:\n        - name: http\n          containerPort: 80\n        - name: ssh\n          containerPort: 22\n        volumeMounts:\n        - mountPath: /home/git/data\n          name: data\n        readinessProbe:\n          httpGet:\n            path: /\n            port: 80\n          initialDelaySeconds: 60\n          timeoutSeconds: 1\n      volumes:\n      - name: data\n        persistentVolumeClaim:\n          claimName: gitlab-pvc\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: gitlab\n  namespace: kube-ops\n  labels:\n    name: gitlab\nspec:\n  ports:\n    - name: http\n      port: 80\n      targetPort: http\n    - name: ssh\n      port: 22\n      targetPort: ssh\n  selector:\n    name: gitlab\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: gitlab\n  namespace: kube-ops\nspec:\n  entryPoints:\n  - web   \n  routes:\n  - kind: Rule\n    match: Host(`git.k8s.local`)\n    services:\n    - name: gitlab\n      port: 80\n</code></pre> <p>\u540c\u6837\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u7684 gitlab \u955c\u50cf\u5185\u90e8\u662f\u4e00\u4e2a <code>git</code> \u7684\u7528\u6237\uff08id=1000\uff09\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4e3a\u4e86\u6301\u4e45\u5316\u6570\u636e\u901a\u8fc7\u4e00\u4e2a initContainers \u5c06\u6211\u4eec\u7684\u6570\u636e\u76ee\u5f55\u6743\u9650\u8fdb\u884c\u66f4\u6539\uff1a</p> <pre><code>initContainers:\n- name: fix-permissions\n  image: busybox\n  command: [\"sh\", \"-c\", \"chown -R 1000:1000 /home/git/data\"]\n  securityContext:\n    privileged: true\n  volumeMounts:\n  - name: data\n    mountPath: /home/git/data\n</code></pre> <p>\u7531\u4e8e gitlab \u542f\u52a8\u975e\u5e38\u6162\uff0c\u4e5f\u975e\u5e38\u6d88\u8017\u8d44\u6e90\uff0c\u6211\u4eec\u540c\u6837\u8fd8\u662f\u7528\u7684 Local PV\uff0c\u4e3a\u4e86\u4e0d\u8ba9\u5e94\u7528\u91cd\u542f\uff0c\u6211\u4eec\u8fd9\u91cc\u4e5f\u76f4\u63a5\u53bb\u6389\u4e86 livenessProbe\uff0c\u8fd9\u6837\u53ef\u4ee5\u9632\u6b62 gitlab \u81ea\u52a8\u91cd\u542f\uff0c\u8981\u6ce8\u610f\u7684\u662f\u5176\u4e2d Redis \u548c Postgresql \u76f8\u5173\u7684\u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u53e6\u5916\uff0c\u6211\u4eec\u8fd9\u91cc\u6dfb\u52a0\u4e86\u4e00\u4e2a IngressRoute \u5bf9\u8c61\uff0c\u6765\u4e3a\u6211\u4eec\u7684 Gitlab \u914d\u7f6e\u4e00\u4e2a\u57df\u540d <code>git.k8s.local</code>\uff0c\u8fd9\u6837\u5e94\u7528\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u8be5\u57df\u540d\u6765\u8bbf\u95ee\u4e86\uff0c\u7136\u540e\u76f4\u63a5\u90e8\u7f72\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f gitlab-redis.yaml gitlab-postgresql.yaml gitlab.yaml\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b Pod \u7684\u90e8\u7f72\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods -n kube-ops\nNAME                                           READY     STATUS    RESTARTS   AGE\ngitlab-7d855554cb-twh7c                        1/1       Running   0          10m\npostgresql-8566bb959c-2tnvr                    1/1       Running   0          17h\nredis-8446f57bdf-4v62p                         1/1       Running   0          17h\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u90fd\u5df2\u7ecf\u90e8\u7f72\u6210\u529f\u4e86\uff0c\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Ingress \u4e2d\u5b9a\u4e49\u7684\u57df\u540d <code>git.k8s.local</code>(\u9700\u8981\u505a DNS \u89e3\u6790\u6216\u8005\u5728\u672c\u5730 <code>/etc/hosts</code> \u4e2d\u6dfb\u52a0\u6620\u5c04)\u6765\u8bbf\u95ee Portal\uff1a</p> <p></p> <p>\u4f7f\u7528\u7528\u6237\u540d <code>root</code>\uff0c\u548c\u90e8\u7f72\u7684\u65f6\u5019\u6307\u5b9a\u7684\u8d85\u7ea7\u7528\u6237\u5bc6\u7801 </p> <pre><code>GITLAB_ROOT_PASSWORD=admin321\n</code></pre> <p>\u5373\u53ef\u767b\u5f55\u8fdb\u5165\u5230\u9996\u9875\uff1a</p> <p></p> <p>Gitlab \u8fd0\u884c\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6ce8\u518c\u4e3a\u65b0\u7528\u6237\u5e76\u521b\u5efa\u4e00\u4e2a\u9879\u76ee\uff0c\u8fd8\u53ef\u4ee5\u505a\u5f88\u591a\u7684\u5176\u4ed6\u7cfb\u7edf\u8bbe\u7f6e\uff0c\u6bd4\u5982\u8bbe\u7f6e\b\u8bed\u8a00\u3001\u8bbe\u7f6e\b\u5e94\u7528\u98ce\u683c\u6837\u5f0f\u7b49\u7b49\u3002</p> <p>\u70b9\u51fb <code>Create a project</code> \u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u9879\u76ee\uff0c\u548c Github \u4f7f\u7528\u4e0a\u6ca1\u6709\u591a\u5927\u7684\u5dee\u522b\uff1a</p> <p></p> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u672c\u5730\u7528\u6237\u7684\u4e00\u4e2a <code>SSH-KEY</code>\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>SSH</code> \u6765\u62c9\u53d6\u6216\u8005\u63a8\u9001\u4ee3\u7801\u4e86\u3002SSH \u516c\u94a5\u901a\u5e38\u5305\u542b\u5728 <code>~/.ssh/id_rsa.pub</code> \u6587\u4ef6\u4e2d\uff0c\u5e76\u4ee5 <code>ssh-rsa</code> \u5f00\u5934\u3002\u5982\u679c\u6ca1\u6709\u7684\u8bdd\u53ef\u4ee5\u4f7f\u7528 <code>ssh-keygen</code> \u547d\u4ee4\u6765\u751f\u6210\uff0c<code>id_rsa.pub</code> \u91cc\u9762\u7684\u5185\u5bb9\u5c31\u662f\u6211\u4eec\u9700\u8981\u7684 SSH \u516c\u94a5\uff0c\u7136\u540e\u6dfb\u52a0\u5230 Gitlab \u4e2d\u3002</p> <p>\u7531\u4e8e\u5e73\u65f6\u4f7f\u7528\u7684 ssh \u9ed8\u8ba4\u662f 22 \u7aef\u53e3\uff0c\u73b0\u5728\u5982\u679c\u7528\u9ed8\u8ba4\u7684 22 \u7aef\u53e3\u53bb\u8fde\u63a5\uff0c\u662f\u6ca1\u529e\u6cd5\u548c Gitlab \u5bb9\u5668\u4e2d\u7684 22 \u7aef\u53e3\u8fdb\u884c\u6620\u5c04\u7684\uff0c\u56e0\u4e3a\u6211\u4eec\u53ea\u662f\u901a\u8fc7 Service \u7684 22 \u7aef\u53e3\u8fdb\u884c\u4e86\u6620\u5c04\uff0c\u8981\u60f3\u901a\u8fc7\u8282\u70b9\u53bb\u8fdb\u884c ssh \u94fe\u63a5\u5c31\u9700\u8981\u5728\u8282\u70b9\u4e0a\u4e00\u4e2a\u7aef\u53e3\u548c\u5bb9\u5668\u5185\u90e8\u7684 22 \u7aef\u53e3\u8fdb\u884c\u7ed1\u5b9a\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 NodePort \u53bb\u6620\u5c04 Gitlab \u5bb9\u5668\u5185\u90e8\u7684 22 \u7aef\u53e3\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u73af\u5883\u53d8\u91cf\u8bbe\u7f6e\u4e3a </p> <pre><code>GITLAB_SSH_PORT=30022\n</code></pre> <p>\uff0c\u5c06 Gitlab \u7684 Service \u4e5f\u8bbe\u7f6e\u4e3a NodePort \u7c7b\u578b\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: gitlab\n  namespace: kube-ops\n  labels:\n    name: gitlab\nspec:\n  ports:\n    - name: http\n      port: 80\n      targetPort: http\n    - name: ssh\n      port: 22\n      targetPort: ssh\n      nodePort: 30022\n  type: NodePort\n  selector:\n    name: gitlab\n</code></pre> <p>\u6ce8\u610f\u4e0a\u9762 ssh \u5bf9\u5e94\u7684 nodePort \u7aef\u53e3\u8bbe\u7f6e\u4e3a 30022\uff0c\u8fd9\u6837\u5c31\u4e0d\u4f1a\u968f\u673a\u751f\u6210\u4e86\uff0c\u91cd\u65b0\u66f4\u65b0\u4e0b Deployment \u548c Service\uff0c\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u73b0\u5728\u6211\u4eec\u5728\u9879\u76ee\u4e0a\u9762 Clone \u7684\u65f6\u5019\b\u4f7f\u7528 ssh \u5c31\u4f1a\u5e26\u4e0a\u7aef\u53e3\u53f7\u4e86\uff1a</p> <p></p> <p>\u73b0\u5728\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>Clone with SSH</code> \u7684\u5730\u5740\u4e86\uff0c\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u4e86 SSH \u516c\u94a5\uff0c\u6240\u4ee5\u5c31\u53ef\u4ee5\u76f4\u63a5\b\b\u8bbf\u95ee\u4e0a\u9762\u7684\u4ed3\u5e93\u4e86\uff1a</p> <pre><code>$ git clone ssh://git@git.k8s.local:30022/root/gitlab-demo.git\nCloning into 'gitlab-demo'...\nWarning: the ECDSA host key for '[git.k8s.local]:30022' differs from the key for the IP address '[1111]:300\n22'\nOffending key for IP in /Users/ych/.ssh/known_hosts:195\nMatching host key in /Users/ych/.ssh/known_hosts:204\nAre you sure you want to continue connecting (yes/no)? yes\nremote: Enumerating objects: 3, done.\nremote: Counting objects: 100% (3/3), done.\nremote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0\nReceiving objects: 100% (3/3), done.\n</code></pre> <p>\u7136\u540e\u968f\u4fbf\u5728\u8be5\u9879\u76ee\u4e0b\u9762\u6dfb\u52a0\u4e00\u4e9b\u8d44\u6e90\uff1a</p> <pre><code>$ echo \"# hello world\" &gt;  README.md\n$ git add .\n$ git commit -m \"change README\"\n[master 1023f85] change README\n 1 file changed, 1 insertion(+), 1 deletion(-)\n$ git push origin master\nWarning: the ECDSA host key for '[git.k8s.local]:30022' differs from the key for the IP address '[1111]:30022'\nOffending key for IP in /Users/ych/.ssh/known_hosts:195\nMatching host key in /Users/ych/.ssh/known_hosts:204\nAre you sure you want to continue connecting (yes/no)? yes\nEnumerating objects: 3, done.\nCounting objects: 100% (3/3), done.\nWriting objects: 100% (3/3), 259 bytes | 200 KiB/s, done.\nTotal 3 (delta 0), reused 0 (delta 0)\nTo ssh://git.k8s.local:30022/root/gitlab-demo.git\n   dfc35a.1023f85  master -&gt; master\n</code></pre> <p>\u7136\u540e\u5237\u65b0\u6d4f\u89c8\u5668\uff0c\u5c31\u53ef\u4ee5\u770b\u5230\u521a\u521a\u521b\u5efa\u7684 Git \u4ed3\u5e93\u4e2d\u591a\u4e86\u4e00\u4e2a <code>README.md</code> \u7684\u6587\u4ef6\uff1a</p> <p></p> <p>\u5230\u8fd9\u91cc\u5c31\u8868\u660e\u6211\u4eec\u7684 GitLab \u5c31\u6210\u529f\u90e8\u7f72\u5230\u4e86 Kubernetes \u96c6\u7fa4\u5f53\u4e2d\u4e86\u3002</p>"},{"location":"kubernetes_devops/harbor/","title":"Harbor","text":""},{"location":"kubernetes_devops/harbor/#harbor","title":"Harbor","text":"<p>Harbor \u662f\u4e00\u4e2a CNCF \u57fa\u91d1\u4f1a\u6258\u7ba1\u7684\u5f00\u6e90\u7684\u53ef\u4fe1\u7684\u4e91\u539f\u751f docker registry \u9879\u76ee\uff0c\u53ef\u4ee5\u7528\u4e8e\u5b58\u50a8\u3001\u7b7e\u540d\u3001\u626b\u63cf\u955c\u50cf\u5185\u5bb9\uff0cHarbor \u901a\u8fc7\u6dfb\u52a0\u4e00\u4e9b\u5e38\u7528\u7684\u529f\u80fd\u5982\u5b89\u5168\u6027\u3001\u8eab\u4efd\u6743\u9650\u7ba1\u7406\u7b49\u6765\u6269\u5c55 docker registry \u9879\u76ee\uff0c\u6b64\u5916\u8fd8\u652f\u6301\u5728 registry \u4e4b\u95f4\u590d\u5236\u955c\u50cf\uff0c\u8fd8\u63d0\u4f9b\u66f4\u52a0\u9ad8\u7ea7\u7684\u5b89\u5168\u529f\u80fd\uff0c\u5982\u7528\u6237\u7ba1\u7406\u3001\u8bbf\u95ee\u63a7\u5236\u548c\u6d3b\u52a8\u5ba1\u8ba1\u7b49\uff0c\u5728\u65b0\u7248\u672c\u4e2d\u8fd8\u6dfb\u52a0\u4e86 Helm \u4ed3\u5e93\u6258\u7ba1\u7684\u652f\u6301\u3002</p> <p>Harbor \u6700\u6838\u5fc3\u7684\u529f\u80fd\u5c31\u662f\u7ed9 docker registry \u6dfb\u52a0\u4e0a\u4e00\u5c42\u6743\u9650\u4fdd\u62a4\u7684\u529f\u80fd\uff0c\u8981\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\uff0c\u5c31\u9700\u8981\u6211\u4eec\u5728\u4f7f\u7528 docker login\u3001pull\u3001push \u7b49\u547d\u4ee4\u7684\u65f6\u5019\u8fdb\u884c\u62e6\u622a\uff0c\u5148\u8fdb\u884c\u4e00\u4e9b\u6743\u9650\u76f8\u5173\u7684\u6821\u9a8c\uff0c\u518d\u8fdb\u884c\u64cd\u4f5c\uff0c\u5176\u5b9e\u8fd9\u4e00\u7cfb\u5217\u7684\u64cd\u4f5c docker registry v2 \u5c31\u5df2\u7ecf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u652f\u6301\uff0cv2 \u96c6\u6210\u4e86\u4e00\u4e2a\u5b89\u5168\u8ba4\u8bc1\u7684\u529f\u80fd\uff0c\u5c06\u5b89\u5168\u8ba4\u8bc1\u66b4\u9732\u7ed9\u5916\u90e8\u670d\u52a1\uff0c\u8ba9\u5916\u90e8\u670d\u52a1\u53bb\u5b9e\u73b0\u3002</p>"},{"location":"kubernetes_devops/harbor/#harbor_1","title":"Harbor \u8ba4\u8bc1\u539f\u7406","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bf4\u4e86 docker registry v2 \u5c06\u5b89\u5168\u8ba4\u8bc1\u66b4\u9732\u7ed9\u4e86\u5916\u90e8\u670d\u52a1\u4f7f\u7528\uff0c\u90a3\u4e48\u662f\u600e\u6837\u66b4\u9732\u7684\u5462\uff1f\u6211\u4eec\u5728\u547d\u4ee4\u884c\u4e2d\u8f93\u5165 </p> <pre><code>docker login https://registry.qikqiak.com\n</code></pre> <p>\u4e3a\u4f8b\u6765\u4e3a\u5927\u5bb6\u8bf4\u660e\u4e0b\u8ba4\u8bc1\u6d41\u7a0b\uff1a</p> <ol> <li>docker client \u63a5\u6536\u5230\u7528\u6237\u8f93\u5165\u7684 docker login \u547d\u4ee4\uff0c\u5c06\u547d\u4ee4\u8f6c\u5316\u4e3a\u8c03\u7528 engine api \u7684 RegistryLogin \u65b9\u6cd5</li> <li>\u5728 RegistryLogin \u65b9\u6cd5\u4e2d\u901a\u8fc7 http \u76d7\u7528 registry \u670d\u52a1\u4e2d\u7684 auth \u65b9\u6cd5</li> <li>\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f v2 \u7248\u672c\u7684\u670d\u52a1\uff0c\u6240\u4ee5\u4f1a\u8c03\u7528 loginV2 \u65b9\u6cd5\uff0c\u5728 loginV2 \u65b9\u6cd5\u4e2d\u4f1a\u8fdb\u884c /v2/ \u63a5\u53e3\u8c03\u7528\uff0c\u8be5\u63a5\u53e3\u4f1a\u5bf9\u8bf7\u6c42\u8fdb\u884c\u8ba4\u8bc1</li> <li>\u6b64\u65f6\u7684\u8bf7\u6c42\u4e2d\u5e76\u6ca1\u6709\u5305\u542b token \u4fe1\u606f\uff0c\u8ba4\u8bc1\u4f1a\u5931\u8d25\uff0c\u8fd4\u56de 401 \u9519\u8bef\uff0c\u540c\u65f6\u4f1a\u5728 header \u4e2d\u8fd4\u56de\u53bb\u54ea\u91cc\u8bf7\u6c42\u8ba4\u8bc1\u7684\u670d\u52a1\u5668\u5730\u5740</li> <li>registry client \u7aef\u6536\u5230\u4e0a\u9762\u7684\u8fd4\u56de\u7ed3\u679c\u540e\uff0c\u4fbf\u4f1a\u53bb\u8fd4\u56de\u7684\u8ba4\u8bc1\u670d\u52a1\u5668\u90a3\u91cc\u8fdb\u884c\u8ba4\u8bc1\u8bf7\u6c42\uff0c\u5411\u8ba4\u8bc1\u670d\u52a1\u5668\u53d1\u9001\u7684\u8bf7\u6c42\u7684 header \u4e2d\u5305\u542b\u6709\u52a0\u5bc6\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801</li> <li>\u8ba4\u8bc1\u670d\u52a1\u5668\u4ece header \u4e2d\u83b7\u53d6\u5230\u52a0\u5bc6\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u7ed3\u5408\u5b9e\u9645\u7684\u8ba4\u8bc1\u7cfb\u7edf\u8fdb\u884c\u8ba4\u8bc1\u4e86\uff0c\u6bd4\u5982\u4ece\u6570\u636e\u5e93\u4e2d\u67e5\u8be2\u7528\u6237\u8ba4\u8bc1\u4fe1\u606f\u6216\u8005\u5bf9\u63a5 ldap \u670d\u52a1\u8fdb\u884c\u8ba4\u8bc1\u6821\u9a8c</li> <li>\u8ba4\u8bc1\u6210\u529f\u540e\uff0c\u4f1a\u8fd4\u56de\u4e00\u4e2a token \u4fe1\u606f\uff0cclient \u7aef\u4f1a\u62ff\u7740\u8fd4\u56de\u7684 token \u518d\u6b21\u5411 registry \u670d\u52a1\u53d1\u9001\u8bf7\u6c42\uff0c\u8fd9\u6b21\u9700\u8981\u5e26\u4e0a\u5f97\u5230\u7684 token\uff0c\u8bf7\u6c42\u9a8c\u8bc1\u6210\u529f\uff0c\u8fd4\u56de\u72b6\u6001\u7801\u5c31\u662f200\u4e86</li> <li>docker client \u7aef\u63a5\u6536\u5230\u8fd4\u56de\u7684200\u72b6\u6001\u7801\uff0c\u8bf4\u660e\u64cd\u4f5c\u6210\u529f\uff0c\u5728\u63a7\u5236\u53f0\u4e0a\u6253\u5370 Login Succeeded \u7684\u4fe1\u606f \u81f3\u6b64\uff0c\u6574\u4e2a\u767b\u5f55\u8fc7\u7a0b\u5b8c\u6210\uff0c\u6574\u4e2a\u8fc7\u7a0b\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u6d41\u7a0b\u56fe\u6765\u8bf4\u660e\uff1a</li> </ol> <p></p> <p>\u8981\u5b8c\u6210\u4e0a\u9762\u7684\u767b\u5f55\u8ba4\u8bc1\u8fc7\u7a0b\u6709\u4e24\u4e2a\u5173\u952e\u70b9\u9700\u8981\u6ce8\u610f\uff1a\u600e\u6837\u8ba9 registry \u670d\u52a1\u77e5\u9053\u670d\u52a1\u8ba4\u8bc1\u5730\u5740\uff1f\u6211\u4eec\u81ea\u5df1\u63d0\u4f9b\u7684\u8ba4\u8bc1\u670d\u52a1\u751f\u6210\u7684 token \u4e3a\u4ec0\u4e48 registry \u5c31\u80fd\u591f\u8bc6\u522b\uff1f</p> <p>\u5bf9\u4e8e\u7b2c\u4e00\u4e2a\u95ee\u9898\uff0c\u6bd4\u8f83\u597d\u89e3\u51b3\uff0cregistry \u670d\u52a1\u672c\u8eab\u5c31\u63d0\u4f9b\u4e86\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u53ef\u4ee5\u5728\u542f\u52a8 registry \u670d\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\u4e0a\u8ba4\u8bc1\u670d\u52a1\u5730\u5740\u5373\u53ef\uff0c\u5176\u4e2d\u6709\u5982\u4e0b\u8fd9\u6837\u7684\u4e00\u6bb5\u914d\u7f6e\u4fe1\u606f\uff1a</p> <pre><code>......\nauth:\n  token:\n    realm: token-realm\n    service: token-service\n    issuer: registry-token-issuer\n    rootcertbundle: /root/certs/bundle\n......\n</code></pre> <p>\u5176\u4e2d realm \u5c31\u53ef\u4ee5\u7528\u6765\u6307\u5b9a\u4e00\u4e2a\u8ba4\u8bc1\u670d\u52a1\u7684\u5730\u5740\uff0c\u4e0b\u9762\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Harbor \u4e2d\u8be5\u914d\u7f6e\u7684\u5185\u5bb9\u3002</p> <p>\u5173\u4e8e registry \u7684\u914d\u7f6e\uff0c\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863\uff1ahttps://docs.docker.com/registry/configuration/</p> <p>\u7b2c\u4e8c\u4e2a\u95ee\u9898\uff0c\u5c31\u662f registry \u600e\u4e48\u80fd\u591f\u8bc6\u522b\u6211\u4eec\u8fd4\u56de\u7684 token \u6587\u4ef6\uff1f\u5982\u679c\u6309\u7167 registry \u7684\u8981\u6c42\u751f\u6210\u4e00\u4e2a token\uff0c\u662f\u4e0d\u662f registry \u5c31\u53ef\u4ee5\u8bc6\u522b\u4e86\uff1f\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5728\u6211\u4eec\u7684\u8ba4\u8bc1\u670d\u52a1\u5668\u4e2d\u6309\u7167 registry \u7684\u8981\u6c42\u751f\u6210 token\uff0c\u800c\u4e0d\u662f\u968f\u4fbf\u4e71\u751f\u6210\u3002\u90a3\u4e48\u8981\u600e\u4e48\u751f\u6210\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u5728 docker registry \u7684\u6e90\u7801\u4e2d\u53ef\u4ee5\u770b\u5230 token \u662f\u901a\u8fc7 <code>JWT\uff08JSON Web Token\uff09</code>\u6765\u5b9e\u73b0\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u6309\u7167\u8981\u6c42\u751f\u6210\u4e00\u4e2a JWT \u7684 token \u5c31\u53ef\u4ee5\u4e86\u3002</p> <p>\u5bf9 golang \u719f\u6089\u7684\u540c\u5b66\u53ef\u4ee5\u53bb clone \u4e0b Harbor \u7684\u4ee3\u7801\u67e5\u770b\u4e0b\uff0cHarbor \u91c7\u7528 beego \u8fd9\u4e2a web \u5f00\u53d1\u6846\u67b6\uff0c\u6e90\u7801\u9605\u8bfb\u8d77\u6765\u4e0d\u662f\u7279\u522b\u56f0\u96be\u3002\u6211\u4eec\u53ef\u4ee5\u5f88\u5bb9\u6613\u7684\u770b\u5230 Harbor \u4e2d\u5173\u4e8e\u4e0a\u9762\u6211\u4eec\u8bb2\u89e3\u7684\u8ba4\u8bc1\u670d\u52a1\u90e8\u5206\u7684\u5b9e\u73b0\u65b9\u6cd5\u3002</p>"},{"location":"kubernetes_devops/harbor/#_1","title":"\u5b89\u88c5","text":"<p>\u7531\u4e8e Harbor \u6d89\u53ca\u7684\u7ec4\u4ef6\u592a\u591a\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u7528\u66f4\u52a0\u4fbf\u6377\u7684 Helm \u6765\u8fdb\u884c\u5b89\u88c5\u3002\u9996\u5148\u6dfb\u52a0\u4ed3\u5e93\u5730\u5740\uff1a</p> <pre><code>$ helm repo add harbor https://helm.goharbor.io\n\"harbor\" has been added to your repositories\n</code></pre> <p>\u5728\u5b89\u88c5 Harbor \u7684\u65f6\u5019\u6709\u5f88\u591a\u53ef\u4ee5\u914d\u7f6e\u7684\u53c2\u6570\uff0c\u53ef\u4ee5\u5728 harbor-helm \u9879\u76ee\u4e0a\u8fdb\u884c\u67e5\u770b\u3002</p> <p>\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u5c06\u4e3b\u57df\u540d\u914d\u7f6e\u4e3a <code>harbor.k8s.local</code>\uff0c\u901a\u8fc7\u524d\u9762\u7684 Ceph RBD \u7684 StorageClass \u6765\u63d0\u4f9b\u5b58\u50a8\uff0c\u53c8\u56e0\u4e3a\u524d\u9762\u6211\u4eec\u5728\u5b89\u88c5 GitLab \u7684\u65f6\u5019\u5c31\u5df2\u7ecf\u5355\u72ec\u5b89\u88c5\u4e86 postgresql \u548c reids \u4e24\u4e2a\u6570\u636e\u5e93\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u53ef\u4ee5\u914d\u7f6e Harbor \u4f7f\u7528\u8fd9\u4e24\u4e2a\u5916\u7f6e\u7684\u6570\u636e\u5e93\uff0c\u8fd9\u6837\u53ef\u4ee5\u964d\u4f4e\u8d44\u6e90\u7684\u4f7f\u7528\u3002\u4f46\u662f\u4f7f\u7528\u5916\u7f6e\u7684\u6570\u636e\u5e93\u6211\u4eec\u9700\u8981\u63d0\u524d\u624b\u52a8\u521b\u5efa\u6570\u636e\u5e93\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684 GitLab \u63d0\u4f9b\u7684\u6570\u636e\u5e93\uff0c\u5219\u8fdb\u5165\u8be5 Pod \u521b\u5efa registry\u3001clair\u3001notary_server\u3001notary_signer \u8fd94\u4e2a\u6570\u636e\u5e93\uff1a</p> <pre><code>$ kubectl get pods -n kube-ops -l name=postgresql\nNAME                         READY   STATUS    RESTARTS   AGE\npostgresql-6f494df48-frsvp   1/1     Running   0          5d3h\n$ kubectl exec -it postgresql-6f494df48-frsvp /bin/bash -n kube-ops\nroot@postgresql-6f494df48-frsvp:~$ sudo su - postgres\npostgres@postgresql-6f494df48-frsvp:~$ psql\npsql (9 (Ubuntu 9-pgdg04+1))\nType \"help\" for help.\n\npostgres=# CREATE DATABASE registry OWNER postgres;  # \u521b\u5efa registry \u6570\u636e\u5e93\nCREATE DATABASE\npostgres=# GRANT ALL PRIVILEGES ON DATABASE registry to postgres;  # \u6388\u6743\u7ed9 postgres \u7528\u6237\nGRANT\npostgres=# GRANT ALL PRIVILEGES ON DATABASE registry to gitlab;  # \u6388\u6743\u7ed9 gitlab \u7528\u6237\nGRANT\n# Todo: \u7528\u540c\u6837\u7684\u65b9\u5f0f\u521b\u5efa\u5176\u4ed6\u4e09\u4e2a\u6570\u636e\u5e93\uff1aclair\u3001notary_server\u3001notary_signer\n......\npostgres-# \\\\q  # \u9000\u51fa\n</code></pre> <p>\u6570\u636e\u5e93\u51c6\u5907\u8fc7\u540e\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u6211\u4eec\u81ea\u5df1\u5b9a\u5236\u7684 values \u6587\u4ef6\u6765\u8fdb\u884c\u5b89\u88c5\u4e86\uff0c\u5b8c\u6574\u7684\u5b9a\u5236\u7684 values \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a(harbor-values.yaml)</p> <pre><code>externalURL: https://harbor.k8s.local\nharborAdminPassword: Harbor12345\nlogLevel: debug\n\nexpose:\n  type: ingress\n  tls:\n    enabled: true\n  ingress:\n    hosts:\n      core: harbor.k8s.local\n      notary: notary.k8s.local\n\npersistence:\n  enabled: true\n  resourcePolicy: \"keep\"\n  persistentVolumeClaim:\n    registry:\n      # \u5982\u679c\u9700\u8981\u505a\u9ad8\u53ef\u7528\uff0c\u591a\u4e2a\u526f\u672c\u7684\u7ec4\u4ef6\u5219\u9700\u8981\u4f7f\u7528\u652f\u6301 ReadWriteMany \u7684\u540e\u7aef\uff0cceph rbd \u662f\u4e0d\u652f\u6301\u7684\uff0c\u53ef\u4ee5\u4f7f\u7528 cephfs\uff0c\u53ef\u4ee5\u6362\u6210\u524d\u9762\u6211\u4eec\u4f7f\u7528\u7684 rook-ceph-fs\n      storageClass: \"rook-ceph-block\"  \n      # \u5982\u679c\u662f\u9ad8\u53ef\u7528\u7684\uff0c\u591a\u4e2a\u526f\u672c\u7ec4\u4ef6\u9700\u8981\u4f7f\u7528 ReadWriteMany\uff0c\u9ed8\u8ba4\u4e3a ReadWriteOnce\n      accessMode: ReadWriteOnce  \n      size: 50Gi\n    chartmuseum:\n      storageClass: \"rook-ceph-block\"\n      accessMode: ReadWriteOnce\n      size: 10Gi\n    jobservice:\n      storageClass: \"rook-ceph-block\"\n      accessMode: ReadWriteOnce\n      size: 2Gi\n\ndatabase:\n  type: external\n  external:\n    host: \"postgresql.kube-ops.svc.cluster.local\"\n    port: \"5432\"\n    username: \"gitlab\"\n    password: \"passw0rd\"\n\nredis:\n  type: external\n  external:\n    host: \"redis.kube-ops.svc.cluster.local\"\n    port: \"6379\"\n\n# \u9ed8\u8ba4\u4e3a\u4e00\u4e2a\u526f\u672c\uff0c\u5982\u679c\u8981\u505a\u9ad8\u53ef\u7528\uff0c\u53ea\u9700\u8981\u8bbe\u7f6e\u4e3a replicas &gt;= 2 \u5373\u53ef\nportal:\n  replicas: 1\ncore:\n  replicas: 1\njobservice:\n  replicas: 1\nregistry:\n  replicas: 1\nchartmuseum: \n  replicas: 1\nclair:\n  replicas: 1\nnotary:\n  server:\n    replicas: 1\n  signer:\n    replicas: 1\n</code></pre> <p>\u8fd9\u4e9b\u914d\u7f6e\u4fe1\u606f\u90fd\u662f\u6839\u636e Harbor \u7684 Chart \u5305\u9ed8\u8ba4\u7684 values \u503c\u8fdb\u884c\u8986\u76d6\u7684\u3002\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a</p> <pre><code>$ helm install myharbor harbor/harbor -f values.yaml -n kube-ops\nNAME: myharbor\nLAST DEPLOYED: Tue May 12 15:23:15 2020\nNAMESPACE: kube-ops\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nPlease wait for several minutes for Harbor deployment to complete.\nThen you should be able to visit the Harbor portal at https://harbor.k8s.local.\nFor more details, please visit https://github.com/goharbor/harbor.\n</code></pre> <p>\u6b63\u5e38\u60c5\u51b5\u4e0b\u9694\u4e00\u4f1a\u513f\u5c31\u53ef\u4ee5\u5b89\u88c5\u6210\u529f\u4e86\uff1a</p> <pre><code>$ helm ls -n kube-ops\nNAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART       APP VERSION\nmyharbor        kube-ops        1               2020-05-12 15:23:194263 +0800 CST    deployed        harbor-2     \n$ kubectl get pods -n kube-ops -l app=harbor\nNAME                                            READY   STATUS    RESTARTS   AGE\nmyharbor-harbor-chartmuseum-95f9d9898-mqqnn     1/1     Running   0          40m\nmyharbor-harbor-clair-79fb8694b4-5dnk5          2/2     Running   10         40m\nmyharbor-harbor-core-c7bdc46d9-qw9hc            1/1     Running   0          79s\nmyharbor-harbor-jobservice-549d67dc87-j6hr8     1/1     Running   0          79s\nmyharbor-harbor-notary-server-9d57d5d9f-9fvbw   1/1     Running   10         40m\nmyharbor-harbor-notary-signer-658d7886-2ssrl    1/1     Running   10         40m\nmyharbor-harbor-portal-65588b87db-d7whd         1/1     Running   0          40m\nmyharbor-harbor-registry-5f7cc9d69d-89hkw       2/2     Running   0          40m\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06\u57df\u540d <code>harbor.k8s.local</code> \u89e3\u6790\u5230 Ingress Controller \u6240\u5728\u7684\u8282\u70b9\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u4ecd\u7136\u662f Traefik\uff0c\u7531\u4e8e\u6211\u4eec\u5f00\u542f\u4e86 KubernetesIngress \u652f\u6301\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u5c06\u57df\u540d\u89e3\u6790\u5230 Traefik \u7684 Pod \u6240\u5728\u8282\u70b9\u5373\u53ef\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7\u8be5\u57df\u540d\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee\u4e86\uff1a</p> <pre><code>$ kubectl get ingress -n kube-ops\nNAME                      HOSTS                               ADDRESS   PORTS     AGE\nmyharbor-harbor-ingress   harbor.k8s.local,notary.k8s.local             80, 443   41m\n</code></pre> <p>\u7528\u6237\u540d\u4f7f\u7528\u9ed8\u8ba4\u7684 admin\uff0c\u5bc6\u7801\u5219\u662f\u4e0a\u9762\u914d\u7f6e\u7684\u9ed8\u8ba4 Harbor12345\uff1a</p> <p></p> <p>\u767b\u5f55\u8fc7\u540e\u5373\u53ef\u8fdb\u5165 Harbor \u7684 Dashboard \u9875\u9762\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6709\u5f88\u591a\u529f\u80fd\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f1a\u6709\u4e00\u4e2a\u540d\u53eb <code>library</code> \u7684\u9879\u76ee\uff0c\u8be5\u9879\u76ee\u9ed8\u8ba4\u662f\u516c\u5f00\u8bbf\u95ee\u6743\u9650\u7684\uff0c\u8fdb\u5165\u9879\u76ee\u53ef\u4ee5\u770b\u5230\u91cc\u9762\u8fd8\u6709 <code>Helm Chart</code> \u5305\u7684\u7ba1\u7406\uff0c\u53ef\u4ee5\u624b\u52a8\u5728\u8fd9\u91cc\u4e0a\u4f20\uff0c\u4e5f\u53ef\u4ee5\u5bf9\u8be5\u9879\u76ee\u91cc\u9762\u7684\u955c\u50cf\u8fdb\u884c\u4e00\u4e9b\u5176\u4ed6\u914d\u7f6e\u3002</p>"},{"location":"kubernetes_devops/harbor/#_2","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u73b0\u5728\u6211\u4eec\u6765\u6d4b\u8bd5\u4e0b\u4f7f\u7528 <code>docker cli</code> \u6765\u8fdb\u884c <code>pull/push</code> \u955c\u50cf\uff0c\u76f4\u63a5\u4f7f\u7528 <code>docker login</code> \u547d\u4ee4\u767b\u5f55\uff1a</p> <pre><code>$ docker login harbor.k8s.local\nUsername: admin\nPassword: \nINFO[0006] Error logging in to v2 endpoint, trying next endpoint: Get https://harbor.k8s.local/v2/: x509: certificat\ne signed by unknown authority \nGet https://harbor.k8s.local/v2/: x509: certificate signed by unknown authority\n</code></pre> <p>\u8fd9\u662f\u56e0\u4e3a\u5728\u4f7f\u7528 <code>docker login</code> \u767b\u5f55\u7684\u65f6\u5019\u4f1a\u4f7f\u7528 https \u7684\u670d\u52a1\uff0c\u800c\u6211\u4eec\u8fd9\u91cc\u662f\u81ea\u7b7e\u540d\u7684\u8bc1\u4e66\uff0c\u6240\u4ee5\u5c31\u62a5\u9519\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u4f7f\u7528\u5230\u7684 CA \u8bc1\u4e66\u6587\u4ef6\u590d\u5236\u5230 </p> <pre><code>/etc/docker/certs.d/harbor.k8s.local\n</code></pre> <p>\u76ee\u5f55\u4e0b\u9762\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff08\u5982\u679c\u8be5\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u5219\u521b\u5efa\u5b83\uff09\u3002<code>ca.crt</code> \u8fd9\u4e2a\u8bc1\u4e66\u6587\u4ef6\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Ingress \u4e2d\u4f7f\u7528\u7684 Secret \u8d44\u6e90\u5bf9\u8c61\u6765\u63d0\u4f9b\uff1a</p> <pre><code>$ kubectl get secret myharbor-harbor-ingress -n kube-ops -o yaml\napiVersion: v1\ndata:\n  ca.crt: &lt;ca.crt&gt;\n  tls.crt: &lt;tls.crt&gt;\n  tls.key: &lt;tls.key&gt;\nkind: Secret\nmetadata:\n  creationTimestamp: \"2020-05-12T07:23:20Z\"\n  labels:\n    app: harbor\n    chart: harbor\n    heritage: Helm\n    release: myharbor\n  name: myharbor-harbor-ingress\n  namespace: kube-ops\n  resourceVersion: \"67162075\"\n  selfLink: /api/v1/namespaces/kube-ops/secrets/myharbor-harbor-ingress\n  uid: 10a9d22d-3889-4ac4-87c4-5cda7e701828\ntype: kubernetes.io/tls\n</code></pre> <p>\u5176\u4e2d data \u533a\u57df\u4e2d <code>ca.crt</code> \u5bf9\u5e94\u7684\u503c\u5c31\u662f\u6211\u4eec\u9700\u8981\u8bc1\u4e66\uff0c\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u8fd8\u9700\u8981\u505a\u4e00\u4e2a base64 \u7684\u89e3\u7801\uff0c\u8fd9\u6837\u8bc1\u4e66\u914d\u7f6e\u4e0a\u4ee5\u540e\u5c31\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\u4e86\u3002</p> <p>\u4e0d\u8fc7\u7531\u4e8e\u4e0a\u9762\u7684\u65b9\u6cd5\u8f83\u4e3a\u7e41\u7410\uff0c\u6240\u4ee5\u4e00\u822c\u60c5\u51b5\u4e0b\u9762\u6211\u4eec\u5728\u4f7f\u7528 <code>docker cli</code> \u7684\u65f6\u5019\u662f\u5728 docker \u542f\u52a8\u53c2\u6570\u540e\u9762\u6dfb\u52a0\u4e00\u4e2a <code>--insecure-registry</code> \u53c2\u6570\u6765\u5ffd\u7565\u8bc1\u4e66\u7684\u6821\u9a8c\u7684\uff0c\u5728 docker \u542f\u52a8\u914d\u7f6e\u6587\u4ef6 </p> <pre><code>/usr/lib/systemd/system/docker.service\n</code></pre> <p>\u4e2d\u4fee\u6539ExecStart\u7684\u542f\u52a8\u53c2\u6570\uff1a</p> <pre><code>ExecStart=/usr/bin/dockerd --insecure-registry harbor.k8s.local\n</code></pre> <p>\u6216\u8005\u5728 <code>Docker Daemon</code> \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\uff1a</p> <pre><code>$ cat /etc/docker/daemon.json\n{\n  \"insecure-registries\" : [\n    \"harbor.k8s.local\"\n  ],\n  \"registry-mirrors\" : [\n    \"https://ot2k4dmirror.aliyuncs.com/\"\n  ]\n}\n</code></pre> <p>\u7136\u540e\u4fdd\u5b58\u91cd\u542f docker\uff0c\u518d\u4f7f\u7528 <code>docker cli</code> \u5c31\u6ca1\u6709\u4efb\u4f55\u95ee\u9898\u4e86\uff1a</p> <pre><code>$ docker login harbor.k8s.local\nUsername: admin\nPassword:\nLogin Succeeded\n</code></pre> <p>\u6bd4\u5982\u6211\u4eec\u672c\u5730\u73b0\u5728\u6709\u4e00\u4e2a\u540d\u4e3a busybox \u7684\u955c\u50cf\uff0c\u73b0\u5728\u6211\u4eec\u60f3\u8981\u5c06\u8be5\u955c\u50cf\u63a8\u9001\u5230\u6211\u4eec\u7684\u79c1\u6709\u4ed3\u5e93\u4e2d\u53bb\uff0c\u5e94\u8be5\u600e\u6837\u64cd\u4f5c\u5462\uff1f\u9996\u5148\u6211\u4eec\u9700\u8981\u7ed9\u8be5\u955c\u50cf\u91cd\u65b0\u6253\u4e00\u4e2a\u5177\u6709 <code>harbor.k8s.local</code> \u524d\u7f00\u7684\u955c\u50cf\uff0c\u7136\u540e\u63a8\u9001\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u8bc6\u522b\u5230\u63a8\u9001\u5230\u54ea\u4e2a\u955c\u50cf\u4ed3\u5e93\uff1a</p> <pre><code>$ docker tag busybox harbor.k8s.local/library/busybox\n$ docker push harbor.k8s.local/library/busybox\nThe push refers to repository [harbor.k8s.local/library/busybox]\n5b0d2d635df8: Pushed \nlatest: digest: sha256:a2490cec4484ee6c1068ba3a05f89934010c85242f736280b35343483b2264b6 size: 527\n</code></pre> <p>\u63a8\u9001\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u5728 Portal \u9875\u9762\u4e0a\u770b\u5230\u8fd9\u4e2a\u955c\u50cf\u7684\u4fe1\u606f\uff1a </p> <p>\u955c\u50cf push \u6210\u529f\uff0c\u540c\u6837\u53ef\u4ee5\u6d4b\u8bd5\u4e0b pull\uff1a</p> <pre><code>$ docker rmi harbor.k8s.local/library/busybox\nUntagged: harbor.k8s.local/library/busybox:latest\nUntagged: harbor.k8s.local/library/busybox@sha256:a2490cec4484ee6c1068ba3a05f89934010c85242f736280b35343483b2264b6\n$ docker rmi busybox\nUntagged: busybox:latest\nUntagged: busybox@sha256:061ca9704a714ee3e8b80523ec720c64f6209ad3f97c0ff7cb9ec7d19f15149f\n$ docker pull harbor.k8s.local/library/busybox:latest\nlatest: Pulling from library/busybox\ne2334dd9fee4: Already exists \nDigest: sha256:a2490cec4484ee6c1068ba3a05f89934010c85242f736280b35343483b2264b6\nStatus: Downloaded newer image for harbor.k8s.local/library/busybox:latest\nharbor.k8s.local/library/busybox:latest\n$ docker images |grep busybox\nharbor.k8s.local/library/busybox                                                                                                       latest              be5888e67be6        3 weeks ago         22MB\n</code></pre> <p>\u5230\u8fd9\u91cc\u8bc1\u660e\u4e0a\u9762\u6211\u4eec\u7684\u79c1\u6709 docker \u4ed3\u5e93\u642d\u5efa\u6210\u529f\u4e86\uff0c\u5927\u5bb6\u53ef\u4ee5\u5c1d\u8bd5\u53bb\u521b\u5efa\u4e00\u4e2a\u79c1\u6709\u7684\u9879\u76ee\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u7528\u6237\uff0c\u4f7f\u7528\u8fd9\u4e2a\u7528\u6237\u6765\u8fdb\u884c pull/push \u955c\u50cf\uff0cHarbor\b\u8fd8\u5177\u6709\u5176\u4ed6\u7684\u4e00\u4e9b\u529f\u80fd\uff0c\u6bd4\u5982\u955c\u50cf\u590d\u5236\uff0c\u5927\u5bb6\u53ef\u4ee5\u81ea\u884c\u6d4b\u8bd5\uff0c\u611f\u53d7\u4e0b Harbor \u548c\u5b98\u65b9\u81ea\u5e26\u7684 registry \u4ed3\u5e93\u7684\u5dee\u522b\u3002</p>"},{"location":"kubernetes_devops/harbor/#_3","title":"\u9ad8\u53ef\u7528","text":"<p>Harbor \u7684\u5927\u90e8\u5206\u7ec4\u4ef6\u90fd\u662f\u65e0\u72b6\u6001\u7684\u5e94\u7528\uff0c\u6bd4\u5982 portal\u3001core \u7b49\u53ea\u9700\u8981\u589e\u52a0\u5176\u76f8\u5e94\u7684\u526f\u672c\u6570\u91cf\u5373\u53ef\uff1b\u5728\u5b58\u50a8\u6570\u636e\u5c42\u9762\uff0c\u9700\u8981\u63d0\u4f9b\u9ad8\u53ef\u7528\u7684 Postgresql\u3001Redis \u96c6\u7fa4\uff0c\u53e6\u5916\u9488\u5bf9\u955c\u50cf\u548c chart \u670d\u52a1\u4e5f\u9700\u8981\u63d0\u4f9b\u53ef\u6301\u4e45\u7684\u5b58\u50a8\u3002</p> <p></p> <p>\u8981\u505a\u9ad8\u53ef\u7528\u7684 Harbor\uff0c\u6211\u4eec\u9700\u8981\u5c06\u6570\u636e\u5e93\u901a\u8fc7\u5916\u7f6e\u65b9\u5f0f\u8fdb\u884c\u63d0\u4f9b\uff0c\u5f53\u7136\u4e5f\u9700\u8981\u4fdd\u8bc1\u6570\u636e\u5e93\u662f\u9ad8\u53ef\u7528\u7684\u3002\u7136\u540e\u5b58\u50a8\u9700\u8981\u5141\u8bb8\u8de8\u8282\u70b9\u6570\u636e\u5171\u4eab\uff0c\u4e5f\u5c31\u662f\u8981\u652f\u6301 ReadWriteMany \u6a21\u5f0f\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 Ceph \u7684\u8bdd\u5c31\u9700\u8981\u4f7f\u7528 CephFS\u3002\u7136\u540e\u5c06\u5176\u4ed6\u7ec4\u4ef6\u526f\u672c\u6570\u8bbe\u7f6e\u4e3a\u5927\u4e8e\u7b49\u4e8e2\uff1aportal.replicas\u3001core.replicas\u3001jobservice.replicas\u3001registry.replicas\u3001chartmuseum.replicas\u3001clair.replicas\u3001notary.server.replicas \u4ee5\u53ca notary.signer.replicas\u3002</p> <p>\u7136\u540e\u91cd\u65b0\u4f7f\u7528 Helm \u8fdb\u884c\u5b89\u88c5\u5373\u53ef\u3002</p>"},{"location":"kubernetes_devops/jenkins/","title":"Jenins","text":""},{"location":"kubernetes_devops/jenkins/#jenkins","title":"Jenkins","text":"<p>\u63d0\u5230\u57fa\u4e8e Kubernete \u7684CI/CD\uff0c\u53ef\u4ee5\u4f7f\u7528\u7684\u5de5\u5177\u6709\u5f88\u591a\uff0c\u6bd4\u5982 Jenkins\u3001Gitlab CI \u4ee5\u53ca\u65b0\u5174\u7684 drone \u4e4b\u7c7b\u7684\uff0c\u6211\u4eec\u8fd9\u91cc\u4f1a\u4f7f\u7528\u5927\u5bb6\u6700\u4e3a\u719f\u6089\u7684 Jenkins \u6765\u505a CI/CD \u7684\u5de5\u5177\u3002</p>"},{"location":"kubernetes_devops/jenkins/#_1","title":"\u5b89\u88c5","text":"<p>\u65e2\u7136\u8981\u57fa\u4e8e Kubernetes \u6765\u505a CI/CD\uff0c\u6211\u4eec\u8fd9\u91cc\u6700\u597d\u8fd8\u662f\u5c06 Jenkins \u5b89\u88c5\u5230 Kubernetes \u96c6\u7fa4\u5f53\u4e2d\uff0c\u5b89\u88c5\u7684\u65b9\u5f0f\u4e5f\u5f88\u591a\uff0c\u6211\u4eec\u8fd9\u91cc\u4ecd\u7136\u8fd8\u662f\u4f7f\u7528\u624b\u52a8\u7684\u65b9\u5f0f\uff0c\u8fd9\u6837\u53ef\u4ee5\u4e86\u89e3\u66f4\u591a\u7ec6\u8282\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: jenkins-pv\nspec:\n  storageClassName: local  # Local PV\n  capacity:\n    storage: 2Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  local:  \n    path: /data/k8s/jenkins\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - ydzs-node6\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: jenkins-pvc\n  namespace: kube-ops\nspec:\n  storageClassName: local\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 2Gi\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: jenkins\n  namespace: kube-ops\n---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: jenkins\nrules:\n  - apiGroups: [\"extensions\", \"apps\"]\n    resources: [\"deployments\", \"ingresses\"]\n    verbs: [\"create\", \"delete\", \"get\", \"list\", \"watch\", \"patch\", \"update\"]\n  - apiGroups: [\"\"]\n    resources: [\"services\"]\n    verbs: [\"create\", \"delete\", \"get\", \"list\", \"watch\", \"patch\", \"update\"]\n  - apiGroups: [\"\"]\n    resources: [\"pods\"]\n    verbs: [\"create\",\"delete\",\"get\",\"list\",\"patch\",\"update\",\"watch\"]\n  - apiGroups: [\"\"]\n    resources: [\"pods/exec\"]\n    verbs: [\"create\",\"delete\",\"get\",\"list\",\"patch\",\"update\",\"watch\"]\n  - apiGroups: [\"\"]\n    resources: [\"pods/log\", \"events\"]\n    verbs: [\"get\",\"list\",\"watch\"]\n  - apiGroups: [\"\"]\n    resources: [\"secrets\"]\n    verbs: [\"get\"]\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: jenkins\n  namespace: kube-ops\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: jenkins\nsubjects:\n  - kind: ServiceAccount\n    name: jenkins\n    namespace: kube-ops\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: jenkins-mirror-conf\n  namespace: kube-ops\ndata:\n  nginx.conf: |\n    user nginx;\n    worker_processes  3;\n    error_log  /dev/stderr;\n    events {\n      worker_connections  10240;\n    }\n    http {\n      log_format main '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\" $request_time';\n      access_log    /dev/stdout main;\n      server {\n          listen 80;\n          server_name mirrors.jenkins-ci.org;\n          location / {\n            proxy_redirect off;\n            proxy_pass https://mirrors.tuna.tsinghua.edu.cn/jenkins/;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header Accept-Encoding \"\";\n            proxy_set_header Accept-Language \"zh-CN\";\n          }\n          index index.html index.htm index.php;\n          location ~ /\\. {\n            deny all;\n          }\n      }\n    }\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: jenkins\n  namespace: kube-ops\nspec:\n  selector:\n    matchLabels:\n      app: jenkins\n  template:\n    metadata:\n      labels:\n        app: jenkins\n    spec:\n      serviceAccount: jenkins\n      hostAliases:\n      - ip: \"11\"\n        hostnames:\n        - \"mirrors.jenkins-ci.org\"\n      initContainers:\n      - name: fix-permissions\n        image: busybox\n        command: [\"sh\", \"-c\", \"chown -R 1000:1000 /var/jenkins_home\"]\n        securityContext:\n          privileged: true\n        volumeMounts:\n        - name: jenkinshome\n          mountPath: /var/jenkins_home\n      containers:\n      - name: mirror\n        image: nginx:9\n        ports:\n        - containerPort: 80\n        volumeMounts:\n        - mountPath: /etc/nginx \n          readOnly: true\n          name: nginx-conf\n      - name: jenkins\n        image: jenkins/jenkins:lts\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 8080\n          name: web\n          protocol: TCP\n        - containerPort: 50000\n          name: agent\n          protocol: TCP\n        resources:\n          limits:\n            cpu: 1500m\n            memory: 2048Mi\n          requests:\n            cpu: 1500m\n            memory: 2048Mi\n        readinessProbe:\n          httpGet:\n            path: /login\n            port: 8080\n          initialDelaySeconds: 60\n          timeoutSeconds: 5\n          failureThreshold: 12\n        volumeMounts:\n        - name: jenkinshome\n          mountPath: /var/jenkins_home\n      volumes:\n      - name: jenkinshome\n        persistentVolumeClaim:\n          claimName: jenkins-pvc\n      - name: nginx-conf\n        configMap:\n          name: jenkins-mirror-conf\n          items:\n          - key: nginx.conf\n            path: nginx.conf\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: jenkins\n  namespace: kube-ops\n  labels:\n    app: jenkins\nspec:\n  selector:\n    app: jenkins\n  ports:\n  - name: web\n    port: 8080\n    targetPort: web\n  - name: agent\n    port: 50000\n    targetPort: agent\n# ---\n# apiVersion: extensions/v1beta1\n# kind: Ingress\n# metadata:\n#   name: jenkins\n#   namespace: kube-ops\n# spec:\n#   rules:\n#   - host: jenkins.k8s.local\n#     http:\n#       paths:\n#       - backend:\n#           serviceName: jenkins\n#           servicePort: web\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: jenkins\n  namespace: kube-ops\nspec:\n  entryPoints:\n  - web   \n  routes:\n  - kind: Rule\n    match: Host(`jenkins.k8s.local`)\n    services:\n    - name: jenkins\n      port: 8080\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a <code>jenkins/jenkins:lts</code> \u7684\u955c\u50cf\uff0c\u8fd9\u662f jenkins \u5b98\u65b9\u7684 Docker \u955c\u50cf\uff0c\u7136\u540e\u4e5f\u6709\u4e00\u4e9b\u73af\u5883\u53d8\u91cf\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u6765\u5b9a\u5236\u4e00\u4e2a\u955c\u50cf\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u5c06\u4e00\u4e9b\u63d2\u4ef6\u6253\u5305\u5728\u81ea\u5b9a\u4e49\u7684\u955c\u50cf\u5f53\u4e2d\uff0c\u53ef\u4ee5\u53c2\u8003\u6587\u6863\uff1ahttps://github.com/jenkinsci/docker\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u9ed8\u8ba4\u7684\u5b98\u65b9\u955c\u50cf\u5c31\u884c\uff0c\u53e6\u5916\u4e00\u4e2a\u8fd8\u9700\u8981\u6ce8\u610f\u7684\u6570\u636e\u7684\u6301\u4e45\u5316\uff0c\u5c06\u5bb9\u5668\u7684 <code>/var/jenkins_home</code> \u76ee\u5f55\u6301\u4e45\u5316\u5373\u53ef\uff0c\u540c\u6837\u4e3a\u4e86\u6027\u80fd\u8003\u8651\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 Local PV\uff0c\u5c06 Pod \u8c03\u5ea6\u5230\u56fa\u5b9a\u7684\u8282\u70b9\u4e0a\u3002</p> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u955c\u50cf\u5185\u90e8\u8fd0\u884c\u7684\u7528\u6237 <code>uid=1000</code>\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u6302\u8f7d\u51fa\u6765\u540e\u4f1a\u51fa\u73b0\u6743\u9650\u95ee\u9898\uff0c\u4e3a\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u540c\u6837\u8fd8\u662f\u7528\u4e00\u4e2a\u7b80\u5355\u7684 <code>initContainer</code> \u6765\u4fee\u6539\u4e0b\u6211\u4eec\u6302\u8f7d\u7684\u6570\u636e\u76ee\u5f55\u3002</p> <p>\u53e6\u5916\u6211\u4eec\u8fd9\u91cc\u8fd8\u9700\u8981\u4f7f\u7528\u5230\u4e00\u4e2a\u62e5\u6709\u76f8\u5173\u6743\u9650\u7684 </p> <pre><code>serviceAccount\uff1ajenkins\n</code></pre> <p>\uff0c\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u7ed9 jenkins \u8d4b\u4e88\u4e86\u4e00\u4e9b\u5fc5\u8981\u7684\u6743\u9650\uff0c\u5f53\u7136\u5982\u679c\u4f60\u5bf9 serviceAccount \u7684\u6743\u9650\u4e0d\u662f\u5f88\u719f\u6089\u7684\u8bdd\uff0c\u6211\u4eec\u7ed9\u8fd9\u4e2a sa \u7ed1\u5b9a\u4e00\u4e2a <code>cluster-admin</code> \u7684\u96c6\u7fa4\u89d2\u8272\u6743\u9650\u4e5f\u662f\u53ef\u4ee5\u7684\uff0c\u5f53\u7136\u8fd9\u6837\u5177\u6709\u4e00\u5b9a\u7684\u5b89\u5168\u98ce\u9669\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u8fd9\u91cc\u6211\u4eec\u8fd8\u6dfb\u52a0\u4e86\u4e00\u4e2a\u989d\u5916\u7684\u540d\u4e3a <code>mirror</code> \u7684\u5bb9\u5668\uff0c\u6dfb\u52a0\u8fd9\u4e2a\u5bb9\u5668\u7684\u76ee\u7684\u662f\u4f7f\u7528\u4e00\u4e2a nginx \u5bb9\u5668\u6765\u53cd\u5411\u4ee3\u7406 Jenkins \u63d2\u4ef6\u7684\u5b98\u65b9\u6e90\u5230\u6e05\u534e\u5927\u5b66\u7684\u6e90\u4e0a\u9762\uff0c\u56e0\u4e3a\u5b98\u65b9\u6e90\u5b9e\u5728\u662f\u592a\u6162\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u5c06\u5b98\u65b9\u7684\u955c\u50cf\u5730\u5740 </p> <pre><code>mirrors.jenkins-ci.org\n</code></pre> <p>\u901a\u8fc7 <code>hostAlias</code> \u6620\u5c04\u5230\u4e86 <code>127.0.0.1</code> \u8fd9\u4e2a\u5730\u5740\u4e0a\uff0c\u800c\u8fd9\u4e2a\u5730\u5740\u6070\u597d\u5c31\u662f <code>mirror</code> \u8fd9\u4e2a nginx \u5bb9\u5668\uff0c\u6211\u4eec\u901a\u8fc7\u4e00\u4e2a ConfigMap \u6765\u914d\u7f6e Nginx\uff0c\u5c06 </p> <pre><code>mirros.jenkins-ci.org\n</code></pre> <p>\u53cd\u5411\u4ee3\u7406\u5230\u4e86 </p> <pre><code>proxy_pass https://mirrors.tuna.tsinghua.edu.cn/jenkins/;\n</code></pre> <p>\uff0c\u8fd9\u6837\u5f53\u6211\u4eec\u5728 Jenkins \u4e2d\u8981\u4e0b\u8f7d\u63d2\u4ef6\u7684\u65f6\u5019\u5b9e\u9645\u4e0a\u4f1a\u88ab\u4ee3\u7406\u5230\u6e05\u534e\u7684\u6e90\u4e0a\u9762\u53bb\uff0c\u8fd9\u6837\u5c31\u5927\u5927\u52a0\u5feb\u4e86\u63d2\u4ef6\u4e0b\u8f7d\u7684\u901f\u5ea6\u3002</p> <p>\u6700\u540e\u5c31\u662f\u901a\u8fc7 IngressRoute \u6765\u66b4\u9732\u6211\u4eec\u7684\u670d\u52a1\uff0c\u8fd9\u4e2a\u6bd4\u8f83\u7b80\u5355\u3002</p> <p>\u6211\u4eec\u76f4\u63a5\u6765\u521b\u5efa jenkins \u7684\u8d44\u6e90\u6e05\u5355\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f jenkins.yaml\n$ kubectl get pods -n kube-ops -l app=jenkins\nNAME                       READY   STATUS    RESTARTS   AGE\njenkins-5b957d4b8f-t22gp   2/2     Running   0          18m\n$ kubectl logs -f jenkins-5b957d4b8f-t22gp jenkins -n kube-ops\n......\n2019-12-16 13:26:756+0000 [id=39]    INFO    hudson.model.AsyncPeriodicWork$1#run: Finished Download metadata. 28,073 ms\n2019-12-16 13:26:760+0000 [id=26]    INFO    jenkins.InitReactorRunner$1#onAttained: Completed initialization\n2019-12-16 13:26:863+0000 [id=19]    INFO    hudson.WebAppMain$3#run: Jenkins is fully up and running\n</code></pre> <p>\u770b\u5230\u4e0a\u9762\u7684 </p> <pre><code>run: Jenkins is fully up and running\n</code></pre> <p>\u4fe1\u606f\u5c31\u8bc1\u660e\u6211\u4eec\u7684 Jenkins \u5e94\u7528\u4ee5\u524d\u542f\u52a8\u8d77\u6765\u4e86\u3002</p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 IngressRoute \u4e2d\u5b9a\u4e49\u7684\u57df\u540d <code>jenkins.k8s.local</code>(\u9700\u8981\u505a DNS \u89e3\u6790\u6216\u8005\u5728\u672c\u5730 <code>/etc/hosts</code> \u4e2d\u6dfb\u52a0\u6620\u5c04)\u6765\u8bbf\u95ee jenkins \u670d\u52a1\uff1a</p> <p></p> <p>\u7136\u540e\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u83b7\u53d6\u89e3\u9501\u7684\u7ba1\u7406\u5458\u5bc6\u7801\uff1a</p> <pre><code>$ kubectl exec -it jenkins-5b957d4b8f-t22gp -c jenkins -n kube-ops -- cat /var/jenkins_home/secrets/initialAdminPassword\n35b083de1d25409eaef57255e0da481a   # jenkins\u542f\u52a8\u65e5\u5fd7\u91cc\u9762\u4e5f\u6709\n</code></pre> <p>\u7136\u540e\u9009\u62e9\u5b89\u88c5\u63a8\u8350\u7684\u63d2\u4ef6\u5373\u53ef\uff0c\u7531\u4e8e\u6211\u4eec\u5df2\u7ecf\u505a\u4e86\u63d2\u4ef6\u7684\u53cd\u5411\u4ee3\u7406\u4e86\uff0c\u6240\u4ee5\u7406\u8bba\u4e0a\u5b89\u88c5\u901f\u5ea6\u4f1a\u6bd4\u8f83\u5feb</p> <p></p> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u6dfb\u52a0\u7ba1\u7406\u5458\u5e10\u53f7\u5373\u53ef\u8fdb\u5165\u5230 jenkins \u4e3b\u754c\u9762\uff1a</p> <p></p>"},{"location":"kubernetes_devops/jenkins/#_2","title":"\u67b6\u6784","text":"<p>Jenkins \u5b89\u88c5\u5b8c\u6210\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u4e0d\u7528\u6025\u7740\u5c31\u53bb\u4f7f\u7528\uff0c\u6211\u4eec\u8981\u4e86\u89e3\u4e0b\u5728 Kubernetes \u73af\u5883\u4e0b\u9762\u4f7f\u7528 Jenkins \u6709\u4ec0\u4e48\u597d\u5904\u3002</p> <p>\u6211\u4eec\u77e5\u9053\u6301\u7eed\u6784\u5efa\u4e0e\u53d1\u5e03\u662f\u6211\u4eec\u65e5\u5e38\u5de5\u4f5c\u4e2d\u5fc5\u4e0d\u53ef\u5c11\u7684\u4e00\u4e2a\u6b65\u9aa4\uff0c\u76ee\u524d\u5927\u591a\u516c\u53f8\u90fd\u91c7\u7528 Jenkins \u96c6\u7fa4\u6765\u642d\u5efa\u7b26\u5408\u9700\u6c42\u7684 CI/CD \u6d41\u7a0b\uff0c\u7136\u800c\u4f20\u7edf\u7684 Jenkins Slave \u4e00\u4e3b\u591a\u4ece\u65b9\u5f0f\u4f1a\u5b58\u5728\u4e00\u4e9b\u75db\u70b9\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>\u4e3b Master \u53d1\u751f\u5355\u70b9\u6545\u969c\u65f6\uff0c\u6574\u4e2a\u6d41\u7a0b\u90fd\u4e0d\u53ef\u7528\u4e86</li> <li>\u6bcf\u4e2a Slave \u7684\u914d\u7f6e\u73af\u5883\u4e0d\u4e00\u6837\uff0c\u6765\u5b8c\u6210\u4e0d\u540c\u8bed\u8a00\u7684\u7f16\u8bd1\u6253\u5305\u7b49\u64cd\u4f5c\uff0c\u4f46\u662f\u8fd9\u4e9b\u5dee\u5f02\u5316\u7684\u914d\u7f6e\u5bfc\u81f4\u7ba1\u7406\u8d77\u6765\u975e\u5e38\u4e0d\u65b9\u4fbf\uff0c\u7ef4\u62a4\u8d77\u6765\u4e5f\u662f\u6bd4\u8f83\u8d39\u52b2</li> <li>\u8d44\u6e90\u5206\u914d\u4e0d\u5747\u8861\uff0c\u6709\u7684 Slave \u8981\u8fd0\u884c\u7684 job \u51fa\u73b0\u6392\u961f\u7b49\u5f85\uff0c\u800c\u6709\u7684 Slave \u5904\u4e8e\u7a7a\u95f2\u72b6\u6001</li> <li>\u8d44\u6e90\u6709\u6d6a\u8d39\uff0c\u6bcf\u53f0 Slave \u53ef\u80fd\u662f\u7269\u7406\u673a\u6216\u8005\u865a\u62df\u673a\uff0c\u5f53 Slave \u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\u65f6\uff0c\u4e5f\u4e0d\u4f1a\u5b8c\u5168\u91ca\u653e\u6389\u8d44\u6e90\u3002</li> </ul> <p>\u6b63\u56e0\u4e3a\u4e0a\u9762\u7684\u8fd9\u4e9b\u79cd\u79cd\u75db\u70b9\uff0c\u6211\u4eec\u6e34\u671b\u4e00\u79cd\u66f4\u9ad8\u6548\u66f4\u53ef\u9760\u7684\u65b9\u5f0f\u6765\u5b8c\u6210\u8fd9\u4e2a CI/CD \u6d41\u7a0b\uff0c\u800c Docker \u865a\u62df\u5316\u5bb9\u5668\u6280\u672f\u80fd\u5f88\u597d\u7684\u89e3\u51b3\u8fd9\u4e2a\u75db\u70b9\uff0c\u53c8\u7279\u522b\u662f\u5728 Kubernetes \u96c6\u7fa4\u73af\u5883\u4e0b\u9762\u80fd\u591f\u66f4\u597d\u6765\u89e3\u51b3\u4e0a\u9762\u7684\u95ee\u9898\uff0c\u4e0b\u56fe\u662f\u57fa\u4e8e Kubernetes \u642d\u5efa Jenkins \u96c6\u7fa4\u7684\u7b80\u5355\u793a\u610f\u56fe\uff1a</p> <p></p> <p>\u4ece\u56fe\u4e0a\u53ef\u4ee5\u770b\u5230 <code>Jenkins Master</code> \u548c <code>Jenkins Slave</code> \u4ee5 Pod \u5f62\u5f0f\u8fd0\u884c\u5728 Kubernetes \u96c6\u7fa4\u7684 Node \u4e0a\uff0cMaster \u8fd0\u884c\u5728\u5176\u4e2d\u4e00\u4e2a\u8282\u70b9\uff0c\u5e76\u4e14\u5c06\u5176\u914d\u7f6e\u6570\u636e\u5b58\u50a8\u5230\u4e00\u4e2a Volume \u4e0a\u53bb\uff0cSlave \u8fd0\u884c\u5728\u5404\u4e2a\u8282\u70b9\u4e0a\uff0c\u5e76\u4e14\u5b83\u4e0d\u662f\u4e00\u76f4\u5904\u4e8e\u8fd0\u884c\u72b6\u6001\uff0c\u5b83\u4f1a\u6309\u7167\u9700\u6c42\u52a8\u6001\u7684\u521b\u5efa\u5e76\u81ea\u52a8\u5220\u9664\u3002</p> <p>\u8fd9\u79cd\u65b9\u5f0f\u7684\u5de5\u4f5c\u6d41\u7a0b\u5927\u81f4\u4e3a\uff1a\u5f53 Jenkins Master \u63a5\u53d7\u5230 Build \u8bf7\u6c42\u65f6\uff0c\u4f1a\u6839\u636e\u914d\u7f6e\u7684 Label \u52a8\u6001\u521b\u5efa\u4e00\u4e2a\u8fd0\u884c\u5728 Pod \u4e2d\u7684 Jenkins Slave \u5e76\u6ce8\u518c\u5230 Master \u4e0a\uff0c\u5f53\u8fd0\u884c\u5b8c Job \u540e\uff0c\u8fd9\u4e2a Slave \u4f1a\u88ab\u6ce8\u9500\u5e76\u4e14\u8fd9\u4e2a Pod \u4e5f\u4f1a\u81ea\u52a8\u5220\u9664\uff0c\u6062\u590d\u5230\u6700\u521d\u72b6\u6001\u3002</p> <p>\u90a3\u4e48\u6211\u4eec\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u5e26\u6765\u4e86\u54ea\u4e9b\u597d\u5904\u5462\uff1f</p> <ul> <li><code>\u670d\u52a1\u9ad8\u53ef\u7528</code>\uff0c\u5f53 Jenkins Master \u51fa\u73b0\u6545\u969c\u65f6\uff0cKubernetes \u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Jenkins Master \u5bb9\u5668\uff0c\u5e76\u4e14\u5c06 Volume \u5206\u914d\u7ed9\u65b0\u521b\u5efa\u7684\u5bb9\u5668\uff0c\u4fdd\u8bc1\u6570\u636e\u4e0d\u4e22\u5931\uff0c\u4ece\u800c\u8fbe\u5230\u96c6\u7fa4\u670d\u52a1\u9ad8\u53ef\u7528\u3002</li> <li><code>\u52a8\u6001\u4f38\u7f29</code>\uff0c\u5408\u7406\u4f7f\u7528\u8d44\u6e90\uff0c\u6bcf\u6b21\u8fd0\u884c Job \u65f6\uff0c\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a Jenkins Slave\uff0cJob \u5b8c\u6210\u540e\uff0cSlave \u81ea\u52a8\u6ce8\u9500\u5e76\u5220\u9664\u5bb9\u5668\uff0c\u8d44\u6e90\u81ea\u52a8\u91ca\u653e\uff0c\u800c\u4e14 Kubernetes \u4f1a\u6839\u636e\u6bcf\u4e2a\u8d44\u6e90\u7684\u4f7f\u7528\u60c5\u51b5\uff0c\u52a8\u6001\u5206\u914d Slave \u5230\u7a7a\u95f2\u7684\u8282\u70b9\u4e0a\u521b\u5efa\uff0c\u964d\u4f4e\u51fa\u73b0\u56e0\u67d0\u8282\u70b9\u8d44\u6e90\u5229\u7528\u7387\u9ad8\uff0c\u8fd8\u6392\u961f\u7b49\u5f85\u5728\u8be5\u8282\u70b9\u7684\u60c5\u51b5\u3002</li> <li><code>\u6269\u5c55\u6027\u597d</code>\uff0c\u5f53 Kubernetes \u96c6\u7fa4\u7684\u8d44\u6e90\u4e25\u91cd\u4e0d\u8db3\u800c\u5bfc\u81f4 Job \u6392\u961f\u7b49\u5f85\u65f6\uff0c\u53ef\u4ee5\u5f88\u5bb9\u6613\u7684\u6dfb\u52a0\u4e00\u4e2a Kubernetes Node \u5230\u96c6\u7fa4\u4e2d\uff0c\u4ece\u800c\u5b9e\u73b0\u6269\u5c55\u3002 \u662f\u4e0d\u662f\u4ee5\u524d\u6211\u4eec\u9762\u4e34\u7684\u79cd\u79cd\u95ee\u9898\u5728 Kubernetes \u96c6\u7fa4\u73af\u5883\u4e0b\u9762\u662f\u4e0d\u662f\u90fd\u6ca1\u6709\u4e86\u554a\uff1f\u770b\u4e0a\u53bb\u975e\u5e38\u5b8c\u7f8e\u3002</li> </ul>"},{"location":"kubernetes_devops/jenkins/#_3","title":"\u914d\u7f6e","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u9700\u8981\u6765\u914d\u7f6e Jenkins\uff0c\u8ba9\u4ed6\u80fd\u591f\u52a8\u6001\u7684\u751f\u6210 Slave \u7684 Pod\u3002</p> <p>\u7b2c1\u6b65. \u6211\u4eec\u9700\u8981\u5b89\u88c5 kubernetes \u63d2\u4ef6\uff0c \u70b9\u51fb Manage Jenkins -&gt; Manage Plugins -&gt; Available -&gt; Kubernetes \u52fe\u9009\u5b89\u88c5\u5373\u53ef\u3002</p> <p></p> <p>\u7b2c2\u6b65. \u5b89\u88c5\u5b8c\u6bd5\u540e\uff0c\u70b9\u51fb Manage Jenkins \u2014&gt; Configure System \u2014&gt; (\u62d6\u5230\u6700\u4e0b\u65b9)\uff0c\u5982\u679c\u6709 <code>Add a new cloud</code> \u2014&gt; \u9009\u62e9 Kubernetes\uff0c\u7136\u540e\u586b\u5199 Kubernetes \u548c Jenkins \u914d\u7f6e\u4fe1\u606f\u5373\u53ef\uff0c\u4f46\u662f\u6700\u65b0\u7248\u672c\u7684 Kubernetes \u63d2\u4ef6\u5c06\u914d\u7f6e\u5355\u72ec\u653e\u7f6e\u5230\u4e86\u4e00\u4e2a\u9875\u9762\u4e2d\uff1a</p> <p></p> <p>\u8fd9\u4e2a\u65f6\u5019\u9700\u8981\u70b9\u51fb </p> <pre><code>a separate configuration page\n</code></pre> <p>\u8fd9\u4e2a\u94fe\u63a5\uff0c\u8df3\u8f6c\u5230 <code>Configure Cloud</code> \u9875\u9762\uff1a</p> <p></p> <p>\u5728\u8be5\u9875\u9762\u6211\u4eec\u53ef\u4ee5\u70b9\u51fb <code>Add a new cloud</code> -&gt; \u9009\u62e9 Kubernetes\uff0c\u7136\u540e\u586b\u5199 Kubernetes \u548c Jenkins \u914d\u7f6e\u4fe1\u606f\uff1a</p> <p></p> <p>\u6ce8\u610f namespace\uff0c\u6211\u4eec\u8fd9\u91cc\u586b kube-ops\uff0c\u7136\u540e\u70b9\u51fb <code>Test Connection</code>\uff0c\u5982\u679c\u51fa\u73b0 </p> <pre><code>Connection test successful\n</code></pre> <p>\u7684\u63d0\u793a\u4fe1\u606f\u8bc1\u660e Jenkins \u5df2\u7ecf\u53ef\u4ee5\u548c Kubernetes \u7cfb\u7edf\u6b63\u5e38\u901a\u4fe1\u4e86\uff0c\u7136\u540e\u4e0b\u65b9\u7684 Jenkins URL \u5730\u5740\uff1a</p> <pre><code>http://jenkins.kube-ops.svc.cluster.local:8080\n</code></pre> <p>\uff0c\u8fd9\u91cc\u7684\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>\u670d\u52a1\u540d.namespace.svc.cluster.local:8080\n</code></pre> <p>\uff0c\u6839\u636e\u4e0a\u9762\u521b\u5efa\u7684 jenkins \u7684\u670d\u52a1\u540d\u586b\u5199\u3002</p> <p>\u7b2c3\u6b65. \u914d\u7f6e <code>Pod Template</code>\uff0c\u5176\u5b9e\u5c31\u662f\u914d\u7f6e Jenkins Slave \u8fd0\u884c\u7684 Pod \u6a21\u677f\uff0c\u547d\u540d\u7a7a\u95f4\u6211\u4eec\u540c\u6837\u662f\u7528 kube-ops\uff0cLabels \u8fd9\u91cc\u4e5f\u975e\u5e38\u91cd\u8981\uff0c\u5bf9\u4e8e\u540e\u9762\u6267\u884c Job \u7684\u65f6\u5019\u9700\u8981\u7528\u5230\u8be5\u503c\uff0c\u7136\u540e\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f <code>cnych/jenkins:jnlp6</code> \u8fd9\u4e2a\u955c\u50cf\uff0c\u8fd9\u4e2a\u955c\u50cf\u662f\u5728\u5b98\u65b9\u7684 jnlp \u955c\u50cf\u57fa\u7840\u4e0a\u5b9a\u5236\u7684\uff0c\u52a0\u5165\u4e86 docker\u3001kubectl \u7b49\u4e00\u4e9b\u5b9e\u7528\u7684\u5de5\u5177\u3002</p> <p></p> <p>\u6ce8\u610f</p> <p>\u5bb9\u5668\u7684\u540d\u79f0\u5fc5\u987b\u662f jnlp\uff0c\u8fd9\u662f\u9ed8\u8ba4\u62c9\u8d77\u7684\u5bb9\u5668\uff0c\u53e6\u5916\u9700\u8981\u5c06 <code>Command to run</code> \u548c </p> <pre><code>Arguments to pass to the command\n</code></pre> <p>\u7684\u503c\u90fd\u5220\u9664\u6389\uff0c\u5426\u5219\u4f1a\u5931\u8d25\u3002</p> <p>\u7136\u540e\u6211\u4eec\u8fd9\u91cc\u9700\u8981\u5728\u4e0b\u9762\u6302\u8f7d\u4e24\u4e2a\u4e3b\u673a\u76ee\u5f55\uff0c\u4e00\u4e2a\u662f <code>/var/run/docker.sock</code>\uff0c\u8be5\u6587\u4ef6\u662f\u7528\u4e8e Pod \u4e2d\u7684\u5bb9\u5668\u80fd\u591f\u5171\u4eab\u5bbf\u4e3b\u673a\u7684 Docker\uff0c\u8fd9\u5c31\u662f\u5927\u5bb6\u8bf4\u7684 <code>docker in docker</code> \u7684\u65b9\u5f0f\uff0cDocker \u4e8c\u8fdb\u5236\u6587\u4ef6\u5df2\u7ecf\u6253\u5305\u5230\u4e0a\u9762\u7684\u955c\u50cf\u4e2d\u4e86\uff0c\u53e6\u5916\u4e00\u4e2a\u76ee\u5f55\u4e0b <code>/root/.kube</code> \u76ee\u5f55\uff0c\u6211\u4eec\u5c06\u8fd9\u4e2a\u76ee\u5f55\u6302\u8f7d\u5230\u5bb9\u5668\u7684 <code>/root/.kube</code> \u76ee\u5f55\u4e0b\u9762\u8fd9\u662f\u4e3a\u4e86\u8ba9\u6211\u4eec\u80fd\u591f\u5728 Pod \u7684\u5bb9\u5668\u4e2d\u80fd\u591f\u4f7f\u7528 <code>kubectl</code> \u5de5\u5177\u6765\u8bbf\u95ee\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\uff0c\u65b9\u4fbf\u6211\u4eec\u540e\u9762\u5728 <code>Slave Pod</code> \u90e8\u7f72 Kubernetes \u5e94\u7528\u3002</p> <p></p> <p>\u53e6\u5916\u5982\u679c\u5728\u914d\u7f6e\u4e86\u540e\u8fd0\u884c Slave Pod \u7684\u65f6\u5019\u51fa\u73b0\u4e86\u6743\u9650\u95ee\u9898\uff0c\u8fd9\u662f\u56e0\u4e3a Jenkins Slave Pod \u4e2d\u6ca1\u6709\u914d\u7f6e\u6743\u9650\uff0c\u6240\u4ee5\u9700\u8981\u914d\u7f6e\u4e0a ServiceAccount\uff0c\u5728 Slave Pod \u914d\u7f6e\u7684\u5730\u65b9\u70b9\u51fb\u4e0b\u9762\u7684\u9ad8\u7ea7\uff0c\u6dfb\u52a0\u4e0a\u5bf9\u5e94\u7684 ServiceAccount \u5373\u53ef\uff1a</p> <p></p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u7684 Kubernetes \u63d2\u4ef6\u5c31\u7b97\u914d\u7f6e\u5b8c\u6210\u4e86\u3002</p>"},{"location":"kubernetes_devops/jenkins/#_4","title":"\u6d4b\u8bd5","text":"<p>Kubernetes \u63d2\u4ef6\u7684\u914d\u7f6e\u5de5\u4f5c\u5b8c\u6210\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u6dfb\u52a0\u4e00\u4e2a Job \u4efb\u52a1\uff0c\u770b\u662f\u5426\u80fd\u591f\u5728 Slave Pod \u4e2d\u6267\u884c\uff0c\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u540e\u770b Pod \u662f\u5426\u4f1a\u88ab\u9500\u6bc1\u3002</p> <p>\u5728 Jenkins \u9996\u9875\u70b9\u51fb <code>create new jobs</code>\uff0c\u521b\u5efa\u4e00\u4e2a\u6d4b\u8bd5\u7684\u4efb\u52a1\uff0c\u8f93\u5165\u4efb\u52a1\u540d\u79f0\uff0c\u7136\u540e\u6211\u4eec\u9009\u62e9 <code>Freestyle project</code> \u7c7b\u578b\u7684\u4efb\u52a1\uff0c\u6ce8\u610f\u5728\u4e0b\u9762\u7684 <code>Label Expression</code> \u8fd9\u91cc\u8981\u586b\u5165 <code>ydzs-jnlp</code>\uff0c\u5c31\u662f\u524d\u9762\u6211\u4eec\u914d\u7f6e\u7684 Slave Pod \u4e2d\u7684 Label\uff0c\u8fd9\u4e24\u4e2a\u5730\u65b9\u5fc5\u987b\u4fdd\u6301\u4e00\u81f4\uff1a</p> <p></p> <p>\u7136\u540e\u5f80\u4e0b\u62c9\uff0c\u5728 Build \u533a\u57df\u9009\u62e9<code>Execute shell</code></p> <p></p> <p>\u7136\u540e\u8f93\u5165\u6211\u4eec\u6d4b\u8bd5\u547d\u4ee4</p> <pre><code>echo \"\u6d4b\u8bd5 Kubernetes \u52a8\u6001\u751f\u6210 jenkins slave\"\necho \"docker in docker\"\ndocker info\n\necho \"kubectl\"\nkubectl get pods\n</code></pre> <p>\u6700\u540e\u70b9\u51fb\u4fdd\u5b58</p> <p></p> <p>\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u5728\u9875\u9762\u70b9\u51fb\u5de6\u4fa7\u7684 <code>Build now</code> \u89e6\u53d1\u6784\u5efa\u5373\u53ef\uff0c\u7136\u540e\u89c2\u5bdf Kubernetes \u96c6\u7fa4\u4e2d Pod \u7684\u53d8\u5316\uff1a</p> <pre><code>$ kubectl get pods -n kube-ops                        \nNAME                                           READY   STATUS              RESTARTS   AGE\njenkins-68ccff445c-dk24f                       1/1     Running             0          12h\njnlp-1g893                                     0/1     ContainerCreating   0          83s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5728\u6211\u4eec\u70b9\u51fb\u7acb\u523b\u6784\u5efa\u7684\u65f6\u5019\u53ef\u4ee5\u770b\u5230\u4e00\u4e2a\u65b0\u7684 Pod\uff1ajnlp-1g893 \u88ab\u521b\u5efa\u4e86\uff0c\u8fd9\u5c31\u662f\u6211\u4eec\u7684 Jenkins Slave\u3002\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4efb\u52a1\u4fe1\u606f\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u662f \u82b1\u8d39\u4e86 21s \u65f6\u95f4\u5728 jnlp-1g893 \u8fd9\u4e2a Slave\u4e0a\u9762</p> <p></p> <p>\u5230\u8fd9\u91cc\u8bc1\u660e\u6211\u4eec\u7684\u4efb\u52a1\u5df2\u7ecf\u6784\u5efa\u5b8c\u6210\uff0c\u7136\u540e\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u53bb\u96c6\u7fa4\u67e5\u770b\u6211\u4eec\u7684 Pod \u5217\u8868\uff0c\u53d1\u73b0 kube-ops \u8fd9\u4e2a namespace \u4e0b\u9762\u5df2\u7ecf\u6ca1\u6709\u4e4b\u524d\u7684 Slave \u8fd9\u4e2a Pod \u4e86\u3002</p> <pre><code>$ kubectl get pods -n kube-ops                        \nNAME                                           READY   STATUS              RESTARTS   AGE\njenkins-68ccff445c-dk24f                       1/1     Running             0          12h\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 Kubernetes \u52a8\u6001\u751f\u6210 Jenkins Slave \u7684\u65b9\u6cd5\u3002</p>"},{"location":"kubernetes_devops/jenkins_pipeline/","title":"Jenkins Pipeline","text":""},{"location":"kubernetes_devops/jenkins_pipeline/#jenkins_pipeline","title":"Jenkins Pipeline","text":"<p>\u8981\u5b9e\u73b0\u5728 Jenkins \u4e2d\u7684\u6784\u5efa\u5de5\u4f5c\uff0c\u53ef\u4ee5\u6709\u591a\u79cd\u65b9\u5f0f\uff0c\u6211\u4eec\u8fd9\u91cc\u91c7\u7528\u6bd4\u8f83\u5e38\u7528\u7684 Pipeline \u8fd9\u79cd\u65b9\u5f0f\u3002Pipeline\uff0c\u7b80\u5355\u6765\u8bf4\uff0c\u5c31\u662f\u4e00\u5957\u8fd0\u884c\u5728 Jenkins \u4e0a\u7684\u5de5\u4f5c\u6d41\u6846\u67b6\uff0c\u5c06\u539f\u6765\u72ec\u7acb\u8fd0\u884c\u4e8e\u5355\u4e2a\u6216\u8005\u591a\u4e2a\u8282\u70b9\u7684\u4efb\u52a1\u8fde\u63a5\u8d77\u6765\uff0c\u5b9e\u73b0\u5355\u4e2a\u4efb\u52a1\u96be\u4ee5\u5b8c\u6210\u7684\u590d\u6742\u6d41\u7a0b\u7f16\u6392\u548c\u53ef\u89c6\u5316\u7684\u5de5\u4f5c\u3002</p> <p>Jenkins Pipeline \u6709\u51e0\u4e2a\u6838\u5fc3\u6982\u5ff5\uff1a</p> <ul> <li>Node\uff1a\u8282\u70b9\uff0c\u4e00\u4e2a Node \u5c31\u662f\u4e00\u4e2a Jenkins \u8282\u70b9\uff0cMaster \u6216\u8005 Agent\uff0c\u662f\u6267\u884c Step \u7684\u5177\u4f53\u8fd0\u884c\u73af\u5883\uff0c\u6bd4\u5982\u6211\u4eec\u4e4b\u524d\u52a8\u6001\u8fd0\u884c\u7684 Jenkins Slave \u5c31\u662f\u4e00\u4e2a Node \u8282\u70b9</li> <li>Stage\uff1a\u9636\u6bb5\uff0c\u4e00\u4e2a Pipeline \u53ef\u4ee5\u5212\u5206\u4e3a\u82e5\u5e72\u4e2a Stage\uff0c\u6bcf\u4e2a Stage \u4ee3\u8868\u4e00\u7ec4\u64cd\u4f5c\uff0c\u6bd4\u5982\uff1aBuild\u3001Test\u3001Deploy\uff0cStage \u662f\u4e00\u4e2a\u903b\u8f91\u5206\u7ec4\u7684\u6982\u5ff5\uff0c\u53ef\u4ee5\u8de8\u591a\u4e2a Node</li> <li>Step\uff1a\u6b65\u9aa4\uff0cStep \u662f\u6700\u57fa\u672c\u7684\u64cd\u4f5c\u5355\u5143\uff0c\u53ef\u4ee5\u662f\u6253\u5370\u4e00\u53e5\u8bdd\uff0c\u4e5f\u53ef\u4ee5\u662f\u6784\u5efa\u4e00\u4e2a Docker \u955c\u50cf\uff0c\u7531\u5404\u7c7b Jenkins \u63d2\u4ef6\u63d0\u4f9b\uff0c\u6bd4\u5982\u547d\u4ee4\uff1ash 'make'\uff0c\u5c31\u76f8\u5f53\u4e8e\u6211\u4eec\u5e73\u65f6 shell \u7ec8\u7aef\u4e2d\u6267\u884c make \u547d\u4ee4\u4e00\u6837\u3002</li> </ul> <p>\u90a3\u4e48\u6211\u4eec\u5982\u4f55\u521b\u5efa Jenkins Pipline \u5462\uff1f</p> <ul> <li>Pipeline \u811a\u672c\u662f\u7531 Groovy \u8bed\u8a00\u5b9e\u73b0\u7684\uff0c\u4f46\u662f\u6211\u4eec\u6ca1\u5fc5\u8981\u5355\u72ec\u53bb\u5b66\u4e60 Groovy\uff0c\u5f53\u7136\u4f60\u4f1a\u7684\u8bdd\u6700\u597d</li> <li>Pipeline \u652f\u6301\u4e24\u79cd\u8bed\u6cd5\uff1aDeclarative(\u58f0\u660e\u5f0f)\u548c Scripted Pipeline(\u811a\u672c\u5f0f)\u8bed\u6cd5</li> <li>Pipeline \u4e5f\u6709\u4e24\u79cd\u521b\u5efa\u65b9\u6cd5\uff1a\u53ef\u4ee5\u76f4\u63a5\u5728 Jenkins \u7684 Web UI \u754c\u9762\u4e2d\u8f93\u5165\u811a\u672c\uff1b\u4e5f\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a Jenkinsfile \u811a\u672c\u6587\u4ef6\u653e\u5165\u9879\u76ee\u6e90\u7801\u5e93\u4e2d</li> <li>\u4e00\u822c\u6211\u4eec\u90fd\u63a8\u8350\u5728 Jenkins \u4e2d\u76f4\u63a5\u4ece\u6e90\u4ee3\u7801\u63a7\u5236(SCMD)\u4e2d\u76f4\u63a5\u8f7d\u5165 Jenkinsfile Pipeline \u8fd9\u79cd\u65b9\u6cd5</li> </ul> <p>\u6211\u4eec\u8fd9\u91cc\u6765\u7ed9\u5927\u5bb6\u5feb\u901f\u521b\u5efa\u4e00\u4e2a\u7b80\u5355\u7684 Pipeline\uff0c\u76f4\u63a5\u5728 Jenkins \u7684 Web UI \u754c\u9762\u4e2d\u8f93\u5165\u811a\u672c\u8fd0\u884c\u3002</p> <ul> <li>\u65b0\u5efa Job\uff1a\u5728 Web UI \u4e2d\u70b9\u51fb New Item -&gt; \u8f93\u5165\u540d\u79f0\uff1apipeline-demo -&gt; \u9009\u62e9\u4e0b\u9762\u7684 Pipeline -&gt; \u70b9\u51fb OK</li> <li> <p>\u914d\u7f6e\uff1a\u5728\u6700\u4e0b\u65b9\u7684 Pipeline \u533a\u57df\u8f93\u5165\u5982\u4e0b Script \u811a\u672c\uff0c\u7136\u540e\u70b9\u51fb\u4fdd\u5b58\u3002</p> <pre><code>node {\nstage('Clone') {\n    echo \"Clone Stage\"\n}\nstage('Test') {\n    echo \"Test Stage\"\n}\nstage('Build') {\n    echo \"Build Stage\"\n}\nstage('Deploy') {\n    echo \" Deploy Stage\"\n}\n}\n</code></pre> </li> <li> <p>\u6784\u5efa\uff1a\u70b9\u51fb\u5de6\u4fa7\u533a\u57df\u7684 <code>Build Now</code>\uff0c\u53ef\u4ee5\u770b\u5230 Job \u5f00\u59cb\u6784\u5efa\u4e86</p> </li> </ul> <p>\u9694\u4e00\u4f1a\u513f\uff0c\u6784\u5efa\u5b8c\u6210\uff0c\u53ef\u4ee5\u70b9\u51fb\u5de6\u4fa7\u533a\u57df\u7684 \u00b7Console Output\u00b7\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u8f93\u51fa\u4fe1\u606f\uff1a</p> <p>console output \u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u6211\u4eec Pipeline \u811a\u672c\u4e2d\u76844\u6761\u8f93\u51fa\u8bed\u53e5\u90fd\u6253\u5370\u51fa\u6765\u4e86\uff0c\u8bc1\u660e\u662f\u7b26\u5408\u6211\u4eec\u7684\u9884\u671f\u7684\u3002</p> <p>\u5982\u679c\u5927\u5bb6\u5bf9 Pipeline \u8bed\u6cd5\u4e0d\u662f\u7279\u522b\u719f\u6089\u7684\uff0c\u53ef\u4ee5\u524d\u5f80\u8f93\u5165\u811a\u672c\u7684\u4e0b\u9762\u7684\u94fe\u63a5 <code>Pipeline Syntax</code> \u4e2d\u8fdb\u884c\u67e5\u770b\uff0c\u8fd9\u91cc\u6709\u5f88\u591a\u5173\u4e8e Pipeline \u8bed\u6cd5\u7684\u4ecb\u7ecd\uff0c\u4e5f\u53ef\u4ee5\u81ea\u52a8\u5e2e\u6211\u4eec\u751f\u6210\u4e00\u4e9b\u811a\u672c\u3002</p>"},{"location":"kubernetes_devops/jenkins_pipeline/#slave","title":"\u5728 Slave \u4e2d\u6784\u5efa\u4efb\u52a1","text":"<p>\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u7b80\u5355\u7684 Pipeline \u4efb\u52a1\uff0c\u4f46\u662f\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u4efb\u52a1\u5e76\u6ca1\u6709\u5728 Jenkins \u7684 Slave \u4e2d\u8fd0\u884c\uff0c\u90a3\u4e48\u5982\u4f55\u8ba9\u6211\u4eec\u7684\u4efb\u52a1\u8dd1\u5728 Slave \u4e2d\u5462\uff1f\u8fd8\u8bb0\u5f97\u4e0a\u8282\u8bfe\u6211\u4eec\u5728\u6dfb\u52a0 Slave Pod \u7684\u65f6\u5019\uff0c\u4e00\u5b9a\u8981\u8bb0\u4f4f\u6dfb\u52a0\u7684 label \u5417\uff1f\u6ca1\u9519\uff0c\u6211\u4eec\u5c31\u9700\u8981\u7528\u5230\u8fd9\u4e2a label\uff0c\u6211\u4eec\u91cd\u65b0\u7f16\u8f91\u4e0a\u9762\u521b\u5efa\u7684 Pipeline \u811a\u672c\uff0c\u7ed9 node \u6dfb\u52a0\u4e00\u4e2a label \u5c5e\u6027\uff0c\u5982\u4e0b\uff1a</p> <pre><code>node('ydzs-jnlp') {\n  stage('Clone') {\n    echo \"Clone Stage\"\n  }\n  stage('Test') {\n    echo \"Test Stage\"\n  }\n  stage('Build') {\n    echo \"Build Stage\"\n  }\n  stage('Deploy') {\n    echo \" Deploy Stage\"\n  }\n}\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u7ed9 node \u6dfb\u52a0\u4e86\u4e00\u4e2a <code>ydzs-jnlp</code> \u8fd9\u6837\u7684\u4e00\u4e2alabel\uff0c\u7136\u540e\u6211\u4eec\u4fdd\u5b58\uff0c\u6784\u5efa\u4e4b\u524d\u67e5\u770b\u4e0b kubernetes \u96c6\u7fa4\u4e2d\u7684 Pod\uff1a</p> <pre><code>$ kubectl get pods -n kube-ops\nNAME                       READY     STATUS              RESTARTS   AGE\njenkins-7c85b6f4bd-rfqgv   1/1       Running             4          6d\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u89e6\u53d1\u7acb\u523b\u6784\u5efa\uff1a</p> <pre><code>$ kubectl get pods -n kube-ops\nNAME                       READY     STATUS    RESTARTS   AGE\njenkins-7c85b6f4bd-rfqgv   1/1       Running   4          6d\njnlp-0hrrz                 1/1       Running   0          23s\n</code></pre> <p>\u6211\u4eec\u53d1\u73b0\u591a\u4e86\u4e00\u4e2a\u540d\u53ebjnlp-0hrrz\u7684 Pod \u6b63\u5728\u8fd0\u884c\uff0c\u9694\u4e00\u4f1a\u513f\u8fd9\u4e2a Pod \u5c31\u4e0d\u518d\u4e86\uff1a</p> <pre><code>$ kubectl get pods -n kube-ops\nNAME                       READY     STATUS    RESTARTS   AGE\njenkins-7c85b6f4bd-rfqgv   1/1       Running   4          6d\n</code></pre> <p>\u8fd9\u4e5f\u8bc1\u660e\u6211\u4eec\u7684 Job \u6784\u5efa\u5b8c\u6210\u4e86\uff0c\u540c\u6837\u56de\u5230 Jenkins \u7684 Web UI \u754c\u9762\u4e2d\u67e5\u770b Console Output\uff0c\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u7684\u4fe1\u606f\uff1a</p> <p>pipeline demo2 \u662f\u4e0d\u662f\u4e5f\u8bc1\u660e\u6211\u4eec\u5f53\u524d\u7684\u4efb\u52a1\u5728\u8dd1\u5728\u4e0a\u9762\u52a8\u6001\u751f\u6210\u7684\u8fd9\u4e2a Pod \u4e2d\uff0c\u4e5f\u7b26\u5408\u6211\u4eec\u7684\u9884\u671f\u3002\u6211\u4eec\u56de\u5230 Job \u7684\u4e3b\u754c\u9762\uff0c\u4e5f\u53ef\u4ee5\u770b\u5230\u5927\u5bb6\u53ef\u80fd\u6bd4\u8f83\u719f\u6089\u7684 Stage View \u754c\u9762\uff1a</p>"},{"location":"kubernetes_devops/jenkins_pipeline/#kubernetes","title":"\u90e8\u7f72 Kubernetes \u5e94\u7528","text":"<p>\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u4e86\u5982\u4f55\u5728 Jenkins Slave \u4e2d\u6784\u5efa\u4efb\u52a1\u4e86\uff0c\u90a3\u4e48\u5982\u4f55\u6765\u90e8\u7f72\u4e00\u4e2a\u539f\u751f\u7684 Kubernetes \u5e94\u7528\u5462\uff1f \u8981\u90e8\u7f72 Kubernetes \u5e94\u7528\uff0c\u6211\u4eec\u5c31\u5f97\u5bf9\u6211\u4eec\u4e4b\u524d\u90e8\u7f72\u5e94\u7528\u7684\u6d41\u7a0b\u8981\u975e\u5e38\u719f\u6089\u624d\u884c\uff0c\u6211\u4eec\u4e4b\u524d\u7684\u6d41\u7a0b\u662f\u600e\u6837\u7684\uff1a</p> <ul> <li>\u7f16\u5199\u4ee3\u7801</li> <li>\u6d4b\u8bd5</li> <li>\u7f16\u5199 Dockerfile</li> <li>\u6784\u5efa\u6253\u5305 Docker \u955c\u50cf</li> <li>\u63a8\u9001 Docker \u955c\u50cf\u5230\u4ed3\u5e93</li> <li>\u7f16\u5199 Kubernetes YAML \u6587\u4ef6</li> <li>\u66f4\u6539 YAML \u6587\u4ef6\u4e2d Docker \u955c\u50cf TAG</li> <li>\u5229\u7528 kubectl \u5de5\u5177\u90e8\u7f72\u5e94\u7528</li> </ul> <p>\u6211\u4eec\u4e4b\u524d\u5728 Kubernetes \u73af\u5883\u4e2d\u90e8\u7f72\u4e00\u4e2a\u539f\u751f\u5e94\u7528\u7684\u6d41\u7a0b\u5e94\u8be5\u57fa\u672c\u4e0a\u662f\u4e0a\u9762\u8fd9\u4e9b\u6d41\u7a0b\u5427\uff1f\u73b0\u5728\u6211\u4eec\u5c31\u9700\u8981\u628a\u4e0a\u9762\u8fd9\u4e9b\u6d41\u7a0b\u653e\u5165 Jenkins \u4e2d\u6765\u81ea\u52a8\u5e2e\u6211\u4eec\u5b8c\u6210(\u5f53\u7136\u7f16\u7801\u9664\u5916)\uff0c\u4ece\u6d4b\u8bd5\u5230\u66f4\u65b0 YAML \u6587\u4ef6\u5c5e\u4e8e CI \u6d41\u7a0b\uff0c\u540e\u9762\u90e8\u7f72\u5c5e\u4e8e CD \u7684\u6d41\u7a0b\u3002\u5982\u679c\u6309\u7167\u6211\u4eec\u4e0a\u9762\u7684\u793a\u4f8b\uff0c\u6211\u4eec\u73b0\u5728\u8981\u6765\u7f16\u5199\u4e00\u4e2a Pipeline \u7684\u811a\u672c\uff0c\u5e94\u8be5\u600e\u4e48\u7f16\u5199\u5462\uff1f</p> <pre><code>node('ydzs-jnlp') {\n    stage('Clone') {\n      echo \"Clone Stage\"\n    }\n    stage('Test') {\n      echo \"Test Stage\"\n    }\n    stage('Build') {\n      echo \"Build Docker Image Stage\"\n    }\n    stage('Push') {\n      echo \"Push Docker Image Stage\"\n    }\n    stage('YAML') {\n      echo \"Change YAML File Stage\"\n    }\n    stage('Deploy') {\n      echo \"Deploy Stage\"\n    }\n}\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u6d41\u6c34\u7ebf\u7684\u4f5c\u4e1a\uff0c\u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684\u811a\u672c\u6765\u6784\u5efa\uff0c\u540c\u6837\u53ef\u4ee5\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c\uff1a</p> <p></p> <p>\u8fd9\u91cc\u6211\u4eec\u6765\u5c06\u4e00\u4e2a\u7b80\u5355 golang \u7a0b\u5e8f\uff0c\u90e8\u7f72\u5230 kubernetes \u73af\u5883\u4e2d\uff0c\u4ee3\u7801\u94fe\u63a5\uff1ahttps://github.com/cnych/drone-k8s-demo\u3002\u6211\u4eec\u5c06\u4ee3\u7801\u63a8\u9001\u5230\u6211\u4eec\u81ea\u5df1\u7684 GitLab \u4ed3\u5e93\u4e0a\u53bb\uff0c\u5730\u5740\uff1ahttp://git.k8s.local/course/devops-demo\uff0c\u8fd9\u6837\u8ba9 Jenkins \u548c Gitlab \u53bb\u8fdb\u884c\u8fde\u63a5\u8fdb\u884c CI/CD\u3002</p> <p>\u5982\u679c\u6309\u7167\u4e4b\u524d\u7684\u793a\u4f8b\uff0c\u6211\u4eec\u662f\u4e0d\u662f\u5e94\u8be5\u50cf\u8fd9\u6837\u6765\u7f16\u5199 Pipeline \u811a\u672c\uff1a</p> <p>\u7b2c\u4e00\u6b65\uff0cclone \u4ee3\u7801 \u7b2c\u4e8c\u6b65\uff0c\u8fdb\u884c\u6d4b\u8bd5\uff0c\u5982\u679c\u6d4b\u8bd5\u901a\u8fc7\u4e86\u624d\u7ee7\u7eed\u4e0b\u9762\u7684\u4efb\u52a1 \u7b2c\u4e09\u6b65\uff0c\u7531\u4e8e Dockerfile \u57fa\u672c\u4e0a\u90fd\u662f\u653e\u5165\u6e90\u7801\u4e2d\u8fdb\u884c\u7ba1\u7406\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u5c31\u662f\u76f4\u63a5\u6784\u5efa Docker \u955c\u50cf\u4e86 \u7b2c\u56db\u6b65\uff0c\u955c\u50cf\u6253\u5305\u5b8c\u6210\uff0c\u5c31\u5e94\u8be5\u63a8\u9001\u5230\u955c\u50cf\u4ed3\u5e93\u4e2d\u5427 \u7b2c\u4e94\u6b65\uff0c\u955c\u50cf\u63a8\u9001\u5b8c\u6210\uff0c\u662f\u4e0d\u662f\u9700\u8981\u66f4\u6539 YAML \u6587\u4ef6\u4e2d\u7684\u955c\u50cf TAG \u4e3a\u8fd9\u6b21\u955c\u50cf\u7684 TAG \u7b2c\u516d\u6b65\uff0c\u4e07\u4e8b\u4ff1\u5907\uff0c\u53ea\u5dee\u6700\u540e\u4e00\u6b65\uff0c\u4f7f\u7528 kubectl \u547d\u4ee4\u884c\u5de5\u5177\u8fdb\u884c\u90e8\u7f72\u4e86</p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u7684\u6574\u4e2a CI/CD \u7684\u6d41\u7a0b\u662f\u4e0d\u662f\u5c31\u90fd\u5b8c\u6210\u4e86\u3002\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u7528\u4e0a\u9762\u7684\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u4e00\u4e2a jnlp \u7684\u955c\u50cf\u6765\u5b8c\u6210\u6211\u4eec\u7684\u6574\u4e2a\u6784\u5efa\u5de5\u4f5c\uff0c\u4f46\u662f\u6211\u4eec\u8fd9\u91cc\u7684\u9879\u76ee\u662f golang \u4ee3\u7801\u7684\uff0c\u6784\u5efa\u9700\u8981\u76f8\u5e94\u7684\u73af\u5883\uff0c\u5982\u679c\u6bcf\u6b21\u9700\u8981\u7279\u5b9a\u7684\u73af\u5883\u90fd\u9700\u8981\u91cd\u65b0\u53bb\u5b9a\u5236\u4e0b\u955c\u50cf\u8fd9\u672a\u514d\u592a\u9ebb\u70e6\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u6765\u91c7\u7528\u4e00\u79cd\u66f4\u52a0\u7075\u6d3b\u7684\u65b9\u5f0f\uff0c\u81ea\u5b9a\u4e49 <code>podTemplate</code>\u3002\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728 Pipeline \u4e2d\u53bb\u81ea\u5b9a\u4e49 Slave Pod \u4e2d\u6240\u9700\u8981\u7528\u5230\u7684\u5bb9\u5668\u6a21\u677f\uff0c\u8fd9\u6837\u6211\u4eec\u9700\u8981\u4ec0\u4e48\u955c\u50cf\u53ea\u9700\u8981\u5728 <code>Slave Pod Template</code> \u4e2d\u58f0\u660e\u5373\u53ef\uff0c\u5b8c\u5168\u4e0d\u9700\u8981\u53bb\u5b9a\u4e49\u4e00\u4e2a\u5e9e\u5927\u7684 Slave \u955c\u50cf\u4e86\u3002</p> <p>\u9996\u5148\u53bb\u6389 Jenkins \u4e2d kubernetes \u63d2\u4ef6\u4e2d\u7684 Pod Template \u7684\u5b9a\u4e49\uff0c\u8fdb\u5165\u9875\u9762 http://jenkins.k8s.local/configureClouds/\uff0c\u5220\u9664\u4e0b\u65b9\u7684 <code>Pod Template</code> -&gt; \u4fdd\u5b58\u3002</p> <p></p> <p>\u7136\u540e\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a <code>devops-demo</code> \u7c7b\u578b\u4e3a\u6d41\u6c34\u7ebf(Pipeline)\u7684\u4efb\u52a1\uff1a</p> <p></p> <p>\u7136\u540e\u5728\u8fd9\u91cc\u9700\u8981\u52fe\u9009\u89e6\u53d1\u8fdc\u7a0b\u6784\u5efa\u7684\u89e6\u53d1\u5668\uff0c\u5176\u4e2d\u4ee4\u724c\u6211\u4eec\u53ef\u4ee5\u968f\u4fbf\u5199\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u7136\u540e\u8bb0\u4f4f\u4e0b\u9762\u7684 URL\uff0c\u5c06 JENKINS_URL \u66ff\u6362\u6210 Jenkins \u7684\u5730\u5740,\u6211\u4eec\u8fd9\u91cc\u7684\u5730\u5740\u5c31\u662f\uff1a</p> <pre><code>http://jenkins.k8s.local/job/devops-demo/build?token=server321\n</code></pre> <p></p> <p>\u7136\u540e\u5728\u4e0b\u9762\u7684\u6d41\u6c34\u7ebf\u533a\u57df\u6211\u4eec\u53ef\u4ee5\u9009\u62e9 <code>Pipeline script</code> \u7136\u540e\u5728\u4e0b\u9762\u6d4b\u8bd5\u6d41\u6c34\u7ebf\u811a\u672c\uff0c\u6211\u4eec\u8fd9\u91cc\u9009\u62e9 </p> <pre><code>Pipeline script from SCM\n</code></pre> <p>\uff0c\u610f\u601d\u5c31\u662f\u4ece\u4ee3\u7801\u4ed3\u5e93\u4e2d\u901a\u8fc7 <code>Jenkinsfile</code> \u6587\u4ef6\u83b7\u53d6 <code>Pipeline script</code> \u811a\u672c\u5b9a\u4e49\uff0c\u7136\u540e\u9009\u62e9 SCM \u6765\u6e90\u4e3a Git\uff0c\u5728\u51fa\u73b0\u7684\u5217\u8868\u4e2d\u914d\u7f6e\u4e0a\u4ed3\u5e93\u5730\u5740 </p> <pre><code>http://git.k8s.local/course/devops-demo.git\n</code></pre> <p>\uff0c\u7531\u4e8e\u6211\u4eec\u662f\u5728\u4e00\u4e2a Slave Pod \u4e2d\u53bb\u8fdb\u884c\u6784\u5efa\uff0c\u6240\u4ee5\u5982\u679c\u4f7f\u7528 SSH \u7684\u65b9\u5f0f\u53bb\u8bbf\u95ee Gitlab \u4ee3\u7801\u4ed3\u5e93\u7684\u8bdd\u5c31\u9700\u8981\u9891\u7e41\u7684\u53bb\u66f4\u65b0 SSH-KEY\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u91c7\u7528\u76f4\u63a5\u4f7f\u7528\u7528\u6237\u540d\u548c\u5bc6\u7801\u7684\u5f62\u5f0f\u6765\u65b9\u5f0f\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a\u660e\u663e\u7684\u9519\u8bef </p> <pre><code>Could not resolve host: git.k8s.local\n</code></pre> <p>\u63d0\u793a\u4e0d\u80fd\u89e3\u6790\u6211\u4eec\u7684 GitLab \u57df\u540d\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u7684\u57df\u540d\u90fd\u662f\u81ea\u5b9a\u4e49\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728 CoreDNS \u4e2d\u6dfb\u52a0\u81ea\u5b9a\u4e49\u57df\u540d\u89e3\u6790\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff1a</p> <pre><code>$ kubectl edit cm coredns -n kube-system\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        log\n        errors\n        health {\n          lameduck 5s\n        }\n        ready\n        hosts {  # \u6dfb\u52a0\u81ea\u5b9a\u4e49\u57df\u540d\u89e3\u6790\n          111 git.k8s.local\n          111 jenkins.k8s.local\n          111 harbor.k8s.local\n          fallthrough\n        }\n        kubernetes cluster.local in-addr.arpa iparpa {\n           pods insecure\n           upstream\n           fallthrough in-addr.arpa iparpa\n        }\n        prometheus :9153\n        forward . /etc/resolv.conf\n        cache 30\n        loop\n        reload\n        loadbalance\n    }\nkind: ConfigMap\nmetadata:\n  creationTimestamp: \"2019-11-08T11:59:49Z\"\n  name: coredns\n  namespace: kube-system\n  resourceVersion: \"67954425\"\n  selfLink: /api/v1/namespaces/kube-system/configmaps/coredns\n  uid: 21966186-c2d9-467a-b87f-d061c5c9e4d7\n</code></pre> <p>\u4fee\u6539\u5b8c\u6210\u540e\uff0c\u9694\u4e00\u5c0f\u4f1a\u513f\uff0cCoreDNS \u5c31\u662f\u81ea\u52a8\u70ed\u52a0\u8f7d\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u96c6\u7fa4\u5185\u8bbf\u95ee\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u57df\u540d\u4e86\u3002\u7136\u540e\u80af\u5b9a\u6ca1\u6709\u6743\u9650\uff0c\u6240\u4ee5\u9700\u8981\u914d\u7f6e\u5e10\u53f7\u8ba4\u8bc1\u4fe1\u606f\u3002\u5728 <code>Credentials</code> \u533a\u57df\u70b9\u51fb\u6dfb\u52a0\u6309\u94ae\u6dfb\u52a0\u6211\u4eec\u8bbf\u95ee Gitlab \u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\uff1a</p> <p></p> <p>\u7136\u540e\u9700\u8981\u6211\u4eec\u914d\u7f6e\u7528\u4e8e\u6784\u5efa\u7684\u5206\u652f\uff0c\u5982\u679c\u6240\u6709\u7684\u5206\u652f\u6211\u4eec\u90fd\u60f3\u8981\u8fdb\u884c\u6784\u5efa\u7684\u8bdd\uff0c\u53ea\u9700\u8981\u5c06 <code>Branch Specifier</code> \u533a\u57df\u7559\u7a7a\u5373\u53ef\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u4e0d\u540c\u7684\u73af\u5883\u5bf9\u5e94\u7684\u5206\u652f\u624d\u9700\u8981\u6784\u5efa\uff0c\u6bd4\u5982 master\u3001develop\u3001test \u7b49\uff0c\u5e73\u65f6\u5f00\u53d1\u7684 feature \u6216\u8005 bugfix \u7684\u5206\u652f\u6ca1\u5fc5\u8981\u9891\u7e41\u6784\u5efa\uff0c\u6211\u4eec\u8fd9\u91cc\u5c31\u53ea\u914d\u7f6e master \u548c develop \u4e24\u4e2a\u5206\u652f\u7528\u4e8e\u6784\u5efa\u3002</p> <p></p> <p>\u7f16\u8f91\u5b8c\u6210\u540e\uff0c\u8fd9\u4e2a\u65f6\u5019 Jenkins \u5c31\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\u5230 GitLab \u4e86\u3002</p> <p>\u7136\u540e\u524d\u5f80 Gitlab \u4e2d\u914d\u7f6e\u9879\u76ee devops-demo \u7684 Webhook\uff0csettings -&gt; Webhooks\uff0c\u586b\u5199\u4e0a\u9762\u5f97\u5230\u7684 trigger \u5730\u5740\uff1a</p> <p></p> <p>\u4fdd\u5b58\u540e\uff0c\u5982\u679c\u51fa\u73b0 </p> <pre><code>Url is blocked: Requests to the local network are not allowed\n</code></pre> <p>\u8fd9\u6837\u7684\u62a5\u8b66\u4fe1\u606f\uff0c\u5219\u9700\u8981\u8fdb\u5165 GitLab Admin -&gt; Settings -&gt; NetWork -&gt; \u52fe\u9009 <code>Outbound requests</code>\uff0c\u7136\u540e\u91cd\u65b0\u914d\u7f6e\u5373\u53ef\u3002</p> <p></p> <p>\u4fdd\u5b58\u540e\uff0c\u53ef\u4ee5\u76f4\u63a5\u70b9\u51fb Test -&gt; Push Event \u6d4b\u8bd5\u662f\u5426\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee Webhook \u5730\u5740\uff0c\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u9700\u8981\u914d\u7f6e\u4e0b Jenkins \u7684\u5b89\u5168\u914d\u7f6e\uff0c\u5426\u5219\u8fd9\u91cc\u7684\u89e6\u53d1\u5668\u6ca1\u6743\u9650\u8bbf\u95ee Jenkins\uff0c\u7cfb\u7edf\u7ba1\u7406 -&gt; \u5168\u5c40\u5b89\u5168\u914d\u7f6e\uff1a\u53d6\u6d88\u9632\u6b62\u8de8\u7ad9\u70b9\u8bf7\u6c42\u4f2a\u9020\uff0c\u52fe\u9009\u4e0a\u533f\u540d\u7528\u6237\u5177\u6709\u53ef\u8bfb\u6743\u9650\uff1a</p> <p>\u4fdd\u5b58\u540e\uff0c\u53ef\u4ee5\u76f4\u63a5\u70b9\u51fb <code>Test -&gt; Push Event</code> \u6d4b\u8bd5\u8bbf\u95ee\uff0c\u6b63\u5e38\u5982\u679c\u6ca1\u6709\u914d\u7f6e\u8fc7 Jenkins \u7684\u5b89\u5168\u9009\u9879\uff0c\u4f1a\u51fa\u73b0403\u9519\u8bef\uff0c\u7cfb\u7edf\u7ba1\u7406 -&gt; \u5168\u5c40\u5b89\u5168\u914d\u7f6e\uff1a<code>\u52fe\u9009\u533f\u540d\u7528\u6237\u5177\u6709\u8bfb\u5199\u6743\u9650</code>\uff1a</p> <p></p> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u7684 Jenkins \u662f\u6bd4\u8f83\u65b0\u7684 <code>Jenkins ver. 2.222.3</code> \u7248\u672c\uff0c\u8be5\u7248\u672c\u5df2\u7ecf\u9ed8\u8ba4\u53d6\u6d88\u4e86 CSRF \u7684\u5b89\u5168\u914d\u7f6e\u5165\u53e3\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u624b\u52a8\u6267\u884c\u4e00\u6bb5\u811a\u672c\u6765\u7981\u7528 CSRF \u7684\u8de8\u7ad9\u8bf7\u6c42\uff0c\u7cfb\u7edf\u7ba1\u7406 -&gt; \u811a\u672c\u547d\u4ee4\u884c\uff1a\u6267\u884c\u4e0b\u56fe\u6240\u793a\u7684\u547d\u4ee4\u5373\u53ef\u3002</p> <pre><code>import jenkins.model.Jenkins\n\ndef jenkins = Jenkins.instance\n\njenkins.setCrumbIssuer(null)\n</code></pre> <p></p> <p>\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u91cd\u65b0\u53bb GitLab \u8fdb\u884c\u6d4b\u8bd5\uff0c\u51fa\u73b0\u4e86 </p> <pre><code>Hook executed successfully: HTTP 201\n</code></pre> <p>\u5219\u8bc1\u660e Webhook \u914d\u7f6e\u6210\u529f\u4e86\uff0c\u5426\u5219\u5c31\u9700\u8981\u68c0\u67e5\u4e0b Jenkins \u7684\u5b89\u5168\u914d\u7f6e\u662f\u5426\u6b63\u786e\u4e86\u3002</p> <p>\u7531\u4e8e\u5f53\u524d\u9879\u76ee\u4e2d\u8fd8\u6ca1\u6709 <code>Jenkinsfile</code> \u6587\u4ef6\uff0c\u6240\u4ee5\u89e6\u53d1\u8fc7\u540e\u4f1a\u6784\u5efa\u5931\u8d25\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u76f4\u63a5\u5728\u4ee3\u7801\u4ed3\u5e93\u6839\u76ee\u5f55\u4e0b\u9762\u6dfb\u52a0 <code>Jenkinsfile</code> \u6587\u4ef6\uff0c\u7528\u4e8e\u63cf\u8ff0\u6d41\u6c34\u7ebf\u6784\u5efa\u6d41\u7a0b\u3002</p> <p>\u9996\u5148\u5b9a\u4e49\u6700\u7b80\u5355\u7684\u6d41\u7a0b\uff0c\u8981\u6ce8\u610f\u8fd9\u91cc\u548c\u524d\u9762\u7684\u4e0d\u540c\u4e4b\u5904\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 <code>podTemplate</code> \u6765\u5b9a\u4e49\u4e0d\u540c\u9636\u6bb5\u4f7f\u7528\u7684\u7684\u5bb9\u5668\uff0c\u6709\u54ea\u4e9b\u9636\u6bb5\u5462\uff1f</p> <pre><code>Clone \u4ee3\u7801 -&gt; \u5355\u5143\u6d4b\u8bd5 -&gt; Golang \u7f16\u8bd1\u6253\u5305 -&gt; Docker \u955c\u50cf\u6784\u5efa/\u63a8\u9001 -&gt; Kubectl \u90e8\u7f72\u670d\u52a1\u3002\n</code></pre> <p>Clone \u4ee3\u7801\u5728\u9ed8\u8ba4\u7684 Slave \u5bb9\u5668\u4e2d\u5373\u53ef\uff1b\u5355\u5143\u6d4b\u8bd5\u6211\u4eec\u8fd9\u91cc\u76f4\u63a5\u5ffd\u7565\uff0c\u6709\u9700\u8981\u8fd9\u4e2a\u9636\u6bb5\u7684\u540c\u5b66\u81ea\u5df1\u6dfb\u52a0\u4e0a\u5373\u53ef\uff1bGolang \u7f16\u8bd1\u6253\u5305\u80af\u5b9a\u5c31\u9700\u8981 Golang \u7684\u5bb9\u5668\u4e86\uff1bDocker \u955c\u50cf\u6784\u5efa/\u63a8\u9001\u662f\u4e0d\u662f\u5c31\u9700\u8981 Docker \u73af\u5883\u4e86\uff1b\u6700\u540e\u7684 Kubectl \u66f4\u65b0\u670d\u52a1\u662f\u4e0d\u662f\u5c31\u9700\u8981\u4e00\u4e2a\u6709 Kubectl \u7684\u5bb9\u5668\u73af\u5883\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u5c31\u53ef\u4ee5\u5f88\u7b80\u5355\u7684\u5b9a\u4e49 <code>podTemplate</code> \u4e86\uff0c\u5982\u4e0b\u5b9a\u4e49\uff1a</p> <pre><code>def label = \"slave-${UUID.randomUUID().toString()}\"\n\npodTemplate(label: label, containers: [\n  containerTemplate(name: 'golang', image: 'golang:2-alpine11', command: 'cat', ttyEnabled: true),\n  containerTemplate(name: 'docker', image: 'docker:latest', command: 'cat', ttyEnabled: true),\n  containerTemplate(name: 'kubectl', image: 'cnych/kubectl', command: 'cat', ttyEnabled: true)\n], serviceAccount: 'jenkins', volumes: [\n  hostPathVolume(mountPath: '/home/jenkins/.kube', hostPath: '/root/.kube'),\n  hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock')\n]) {\n  node(label) {\n    def myRepo = checkout scm\n    def gitCommit = myRepo.GIT_COMMIT\n    def gitBranch = myRepo.GIT_BRANCH\n\n    stage('\u5355\u5143\u6d4b\u8bd5') {\n      echo \"\u6d4b\u8bd5\u9636\u6bb5\"\n    }\n    stage('\u4ee3\u7801\u7f16\u8bd1\u6253\u5305') {\n      container('golang') {\n        echo \"\u4ee3\u7801\u7f16\u8bd1\u6253\u5305\u9636\u6bb5\"\n      }\n    }\n    stage('\u6784\u5efa Docker \u955c\u50cf') {\n      container('docker') {\n        echo \"\u6784\u5efa Docker \u955c\u50cf\u9636\u6bb5\"\n      }\n    }\n    stage('\u8fd0\u884c Kubectl') {\n      container('kubectl') {\n        echo \"\u67e5\u770b K8S \u96c6\u7fa4 Pod \u5217\u8868\"\n        sh \"kubectl get pods\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u76f4\u63a5\u5728 <code>podTemplate</code> \u91cc\u9762\u5b9a\u4e49\u6bcf\u4e2a\u9636\u6bb5\u9700\u8981\u7528\u5230\u7684\u5bb9\u5668\uff0cvolumes \u91cc\u9762\u5c06\u6211\u4eec\u9700\u8981\u7528\u5230\u7684 <code>docker.sock</code> \u6587\u4ef6\uff0c\u9700\u8981\u6ce8\u610f\u7684\u6211\u4eec\u4f7f\u7528\u7684 label \u6807\u7b7e\u662f\u662f\u4e00\u4e2a\u968f\u673a\u751f\u6210\u7684\uff0c\u8fd9\u6837\u6709\u4e00\u4e2a\u597d\u5904\u5c31\u662f\u6709\u591a\u4e2a\u4efb\u52a1\u6765\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u540c\u65f6\u6784\u5efa\u4e86\u3002\u6b63\u5e38\u6765\u8bf4\u6211\u4eec\u8fd8\u9700\u8981\u5c06\u8bbf\u95ee\u96c6\u7fa4\u7684 <code>kubeconfig</code> \u6587\u4ef6\u62f7\u8d1d\u5230 kubectl \u5bb9\u5668\u7684 <code>~/.kube/config</code> \u6587\u4ef6\u4e0b\u9762\u53bb\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u5bb9\u5668\u4e2d\u8bbf\u95ee Kubernetes \u96c6\u7fa4\u4e86\uff0c\u4f46\u662f\u7531\u4e8e\u6211\u4eec\u6784\u5efa\u662f\u5728 Slave Pod \u4e2d\u53bb\u6784\u5efa\u7684\uff0cPod \u5c31\u5f88\u6709\u53ef\u80fd\u6bcf\u6b21\u8c03\u5ea6\u5230\u4e0d\u540c\u7684\u8282\u70b9\u53bb\uff0c\u8fd9\u5c31\u9700\u8981\u4fdd\u8bc1\u6bcf\u4e2a\u8282\u70b9\u4e0a\u6709 <code>kubeconfig</code> \u6587\u4ef6\u624d\u80fd\u6302\u8f7d\u6210\u529f\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u53e6\u5916\u4e00\u79cd\u65b9\u5f0f\u3002</p> <p>\u901a\u8fc7\u5c06 <code>kubeconfig</code> \u6587\u4ef6\u901a\u8fc7\u51ed\u8bc1\u4e0a\u4f20\u5230 Jenkins \u4e2d\uff0c\u7136\u540e\u5728 Jenkinsfile \u4e2d\u8bfb\u53d6\u5230\u8fd9\u4e2a\u6587\u4ef6\u540e\uff0c\u62f7\u8d1d\u5230 kubectl \u5bb9\u5668\u4e2d\u7684 <code>~/.kube/config</code> \u6587\u4ef6\u4e2d\uff0c\u8fd9\u6837\u540c\u6837\u5c31\u53ef\u4ee5\u6b63\u5e38\u4f7f\u7528 kubectl \u8bbf\u95ee\u96c6\u7fa4\u4e86\u3002\u5728 Jenkins \u9875\u9762\u4e2d\u6dfb\u52a0\u51ed\u636e\uff0c\u9009\u62e9 <code>Secret file</code> \u7c7b\u578b\uff0c\u7136\u540e\u4e0a\u4f20 <code>kubeconfig</code> \u6587\u4ef6\uff0c\u6307\u5b9a ID \u5373\u53ef\uff1a</p> <p></p> <p>\u7136\u540e\u5728 <code>Jenkinsfile</code> \u7684 kubectl \u5bb9\u5668\u4e2d\u8bfb\u53d6\u4e0a\u9762\u6dfb\u52a0\u7684 <code>Secret file</code> \u6587\u4ef6\uff0c\u62f7\u8d1d\u5230 <code>~/.kube/config</code> \u5373\u53ef\uff1a</p> <pre><code>stage('\u8fd0\u884c Kubectl') {\n  container('kubectl') {\n    withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {\n      echo \"\u67e5\u770b K8S \u96c6\u7fa4 Pod \u5217\u8868\"\n      sh \"mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config\"\n      sh \"kubectl get pods\"\n    }\n  }\n}\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u5c06 <code>Jenkinsfile</code> \u6587\u4ef6\u63d0\u4ea4\u5230 GitLab \u4ee3\u7801\u4ed3\u5e93\u4e2d\uff0c\u6b63\u5e38\u6765\u8bf4\u5c31\u53ef\u4ee5\u89e6\u53d1 Jenkins \u7684\u6784\u5efa\u4e86\uff1a</p> <pre><code>$ kubectl get pods -n kube-ops\nNAME                                                     READY   STATUS              RESTARTS   AGE\njenkins-68ccff445c-dk24f                                 1/1     Running             0          14h\nslave-5dc89808-76f8-418f-ad31-ec34175aa192-5tmwz-2sdm8   0/4     ContainerCreating   0          3s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u751f\u6210\u7684 slave Pod \u5305\u542b\u4e864\u4e2a\u5bb9\u5668\uff0c\u5c31\u662f\u6211\u4eec\u5728 podTemplate \u6307\u5b9a\u7684\u52a0\u4e0a slave \u7684\u955c\u50cf\uff0c\u8fd0\u884c\u5b8c\u6210\u540e\u8be5 Pod \u4e5f\u4f1a\u81ea\u52a8\u9500\u6bc1\u3002</p> <p></p>"},{"location":"kubernetes_devops/jenkins_pipeline/#pipeline","title":"Pipeline","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5b9e\u73b0\u5177\u4f53\u7684\u6d41\u6c34\u7ebf\u3002</p> <p>\u7b2c\u4e00\u4e2a\u9636\u6bb5\uff1a\u5355\u5143\u6d4b\u8bd5\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u8fd9\u4e2a\u9636\u6bb5\u662f\u8fd0\u884c\u4e00\u4e9b\u5355\u5143\u6d4b\u8bd5\u6216\u8005\u9759\u6001\u4ee3\u7801\u5206\u6790\u7684\u811a\u672c\uff0c\u6211\u4eec\u8fd9\u91cc\u76f4\u63a5\u5ffd\u7565\u3002</p> <p>\u7b2c\u4e8c\u4e2a\u9636\u6bb5\uff1a\u4ee3\u7801\u7f16\u8bd1\u6253\u5305\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u662f\u5728\u4e00\u4e2a golang \u7684\u5bb9\u5668\u4e2d\u6765\u6267\u884c\u7684\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728\u8be5\u5bb9\u5668\u4e2d\u83b7\u53d6\u5230\u4ee3\u7801\uff0c\u7136\u540e\u5728\u4ee3\u7801\u76ee\u5f55\u4e0b\u9762\u6267\u884c\u6253\u5305\u547d\u4ee4\u5373\u53ef\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>stage('\u4ee3\u7801\u7f16\u8bd1\u6253\u5305') {\n  try {\n    container('golang') {\n      echo \"\u4ee3\u7801\u7f16\u8bd1\u6253\u5305\u9636\u6bb5\"\n      sh \"\"\"\n        export GOPROXY=https://goproxy.cn\n        GOOS=linux GOARCH=amd64 go build -v -o demo-app\n        \"\"\"\n    }\n  } catch (exc) {\n    println \"\u6784\u5efa\u5931\u8d25 - ${currentBuild.fullDisplayName}\"\n    throw(exc)\n  }\n}\n</code></pre> <p>\u7b2c\u4e09\u4e2a\u9636\u6bb5\uff1a\u6784\u5efa Docker \u955c\u50cf\uff0c\u8981\u6784\u5efa Docker \u955c\u50cf\uff0c\u5c31\u9700\u8981\u63d0\u4f9b\u955c\u50cf\u7684\u540d\u79f0\u548c tag\uff0c\u8981\u63a8\u9001\u5230 Harbor \u4ed3\u5e93\uff0c\u5c31\u9700\u8981\u63d0\u4f9b\u767b\u5f55\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\uff0c\b\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u5230\u4e86 <code>withCredentials</code> \u65b9\u6cd5\uff0c\u5728\u91cc\u9762\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e2a<code>credentialsId</code> \u4e3a dockerhub \u7684\u8ba4\u8bc1\u4fe1\u606f\uff0c\u5982\u4e0b\uff1a</p> <pre><code>stage('\u6784\u5efa Docker \u955c\u50cf') {\n  withCredentials([[$class: 'UsernamePasswordMultiBinding',\n    credentialsId: 'docker-auth',\n    usernameVariable: 'DOCKER_USER',\n    passwordVariable: 'DOCKER_PASSWORD']]) {\n      container('docker') {\n        echo \" \u6784\u5efa Docker \u955c\u50cf\u9636\u6bb5\"\n        sh \"\"\"\n          docker login ${registryUrl} -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}\n          docker build -t ${image} .\n          docker push ${image}\n          \"\"\"\n      }\n  }\n}\n</code></pre> <p>\u5176\u4e2d <code>${image}</code> \u548c <code>${imageTag}</code> \u6211\u4eec\u53ef\u4ee5\u5728\u4e0a\u9762\u5b9a\u4e49\u6210\u5168\u5c40\u53d8\u91cf\uff1a</p> <pre><code>// \u83b7\u53d6 git commit id \u4f5c\u4e3a\u955c\u50cf\u6807\u7b7e\ndef imageTag = sh(script: \"git rev-parse --short HEAD\", returnStdout: true).trim()\n// \u4ed3\u5e93\u5730\u5740\ndef registryUrl = \"harbor.k8s.local\"\ndef imageEndpoint = \"course/devops-demo\"\n// \u955c\u50cf\ndef image = \"${registryUrl}/${imageEndpoint}:${imageTag}\"\n</code></pre> <p>\u8fd9\u91cc\u5b9a\u4e49\u7684\u955c\u50cf\u540d\u79f0\u4e3a <code>course/devops-demo</code>\uff0c\u6240\u4ee5\u9700\u8981\u63d0\u524d\u5728 Harbor \u4e2d\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a course \u7684\u79c1\u6709\u9879\u76ee\uff1a </p> <p>Docker \u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\u4fe1\u606f\u5219\u9700\u8981\u901a\u8fc7\u51ed\u636e\u6765\u8fdb\u884c\u6dfb\u52a0\uff0c\u8fdb\u5165 jenkins \u9996\u9875 -&gt; \u5de6\u4fa7\u83dc\u5355\u51ed\u636e -&gt; \u6dfb\u52a0\u51ed\u636e\uff0c\u9009\u62e9\u7528\u6237\u540d\u548c\u5bc6\u7801\u7c7b\u578b\u7684\uff0c\u5176\u4e2d ID \u4e00\u5b9a\u8981\u548c\u4e0a\u9762\u7684 <code>credentialsId</code> \u7684\u503c\u4fdd\u6301\u4e00\u81f4\uff1a</p> <p></p> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f <code>Docker IN Docker</code> \u6a21\u5f0f\u6765\u6784\u5efa Docker \u955c\u50cf\uff0c\u901a\u8fc7\u5c06\u5bbf\u4e3b\u673a\u7684 <code>docker.sock</code> \u6587\u4ef6\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u6765\u5171\u4eab Docker Daemon\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u9700\u8981\u63d0\u524d\u5728\u8282\u70b9\u4e0a\u914d\u7f6e\u5bf9 Harbor \u955c\u50cf\u4ed3\u5e93\u7684\u4fe1\u4efb:</p> <pre><code>$ vi /etc/docker/daemon.json\n{\n  \"insecure-registries\" : [  # \u914d\u7f6e\u5ffd\u7565 Harobr \u955c\u50cf\u4ed3\u5e93\u7684\u8bc1\u4e66\u6821\u9a8c\n    \"harbor.k8s.local\"\n  ],\n  \"storage-driver\": \"overlay2\",\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"registry-mirrors\" : [\n    \"https://ot2k4dmirror.aliyuncs.com/\"\n  ],\n}\n$ systemctl daemon-reload\n$ systemctl restart docker\n</code></pre> <p>\u914d\u7f6e\u751f\u6548\u8fc7\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u6b63\u5e38\u5728\u6d41\u6c34\u7ebf\u4e2d\u53bb\u64cd\u4f5c Docker \u547d\u4ee4\uff0c\u5426\u5219\u4f1a\u51fa\u73b0\u5982\u4e0b\u6240\u793a\u7684\u9519\u8bef\uff1a </p> <p>\u73b0\u5728\u955c\u50cf\u6211\u4eec\u90fd\u5df2\u7ecf\u63a8\u9001\u5230\u4e86 Harbor \u4ed3\u5e93\u4e2d\u53bb\u4e86\uff0c\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u90e8\u7f72\u5e94\u7528\u5230 Kubernetes \u96c6\u7fa4\u4e2d\u4e86\uff0c\u5f53\u7136\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 kubectl \u5de5\u5177\u53bb\u64cd\u4f5c YAML \u6587\u4ef6\u6765\u90e8\u7f72\uff0c\u6211\u4eec\u8fd9\u91cc\u7684\u793a\u4f8b\uff0c\u7f16\u5199\u4e86\u4e00\u4e2a Helm Chart \u6a21\u677f\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 Helm \u6765\u8fdb\u884c\u90e8\u7f72\uff0c\u6240\u4ee5\u5f53\u7136\u5c31\u9700\u8981\u4e00\u4e2a\u5177\u6709 helm \u547d\u4ee4\u7684\u5bb9\u5668\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 <code>cnych/helm</code> \u8fd9\u4e2a\u955c\u50cf\uff0c\u8fd9\u4e2a\u955c\u50cf\u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u5c31\u662f\u7b80\u5355\u7684\u5c06 helm \u4e8c\u8fdb\u5236\u6587\u4ef6\u4e0b\u8f7d\u4e0b\u6765\u653e\u5230 PATH \u8def\u5f84\u4e0b\u9762\u53bb\u5373\u53ef\uff0c\u5bf9\u5e94\u7684 Dockerfile \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff0c\u5927\u5bb6\u4e5f\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u8981\u6765\u8fdb\u884c\u5b9a\u5236\uff1a</p> <pre><code>FROM alpine\nMAINTAINER cnych &lt;icnych@gmail.com&gt;\nARG HELM_VERSION=\"v1\"\nRUN apk add --update ca-certificates \\\\\n &amp;&amp; apk add --update -t deps wget git openssl bash \\\\\n &amp;&amp; wget https://get.helm.sh/helm-${HELM_VERSION}-linux-amdtar.gz \\\\\n &amp;&amp; tar -xvf helm-${HELM_VERSION}-linux-amdtar.gz \\\\\n &amp;&amp; mv linux-amd64/helm /usr/local/bin \\\\\n &amp;&amp; apk del --purge deps \\\\\n &amp;&amp; rm /var/cache/apk/* \\\\\n &amp;&amp; rm -f /helm-${HELM_VERSION}-linux-amdtar.gz\nENTRYPOINT [\"helm\"]\nCMD [\"help\"]\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f Helm3 \u7248\u672c\uff0c\u6240\u4ee5\u8981\u60f3\u7528 Helm \u6765\u90e8\u7f72\u5e94\u7528\uff0c\u540c\u6837\u7684\u9700\u8981\u914d\u7f6e\u4e00\u4e2a kubeconfig \u6587\u4ef6\u5728\u5bb9\u5668\u4e2d\uff0c\u8fd9\u6837\u624d\u80fd\u8bbf\u95ee\u5230 Kubernetes \u96c6\u7fa4\u3002\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5c06 <code>\u8fd0\u884c Kubectl</code> \u7684\u9636\u6bb5\u505a\u5982\u4e0b\u66f4\u6539\uff1a</p> <pre><code>stage('\u8fd0\u884c Helm') {\n  withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {\n    container('helm') {\n      sh \"mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config\"\n      echo \"\u5f00\u59cb Helm \u90e8\u7f72\"\n      helmDeploy(\n          debug       : false,\n          name        : \"devops-demo\",\n          chartDir    : \"./helm\",\n          namespace   : \"kube-ops\",\n          valuePath   : \"./helm/my-value.yaml\",\n          imageTag    : \"${imageTag}\"\n      )\n      echo \"[INFO] Helm \u90e8\u7f72\u5e94\u7528\u6210\u529f...\"\n    }\n  }\n}\n</code></pre> <p>\u5176\u4e2d <code>helmDeploy</code> \u65b9\u6cd5\u53ef\u4ee5\u5728\u5168\u5c40\u4e2d\u8fdb\u884c\u5b9a\u4e49\u5c01\u88c5\uff1a</p> <pre><code>def helmLint(String chartDir) {\n    println \"\u6821\u9a8c chart \u6a21\u677f\"\n    sh \"helm lint ${chartDir}\"\n}\n\ndef helmDeploy(Map args) {\n    if (args.debug) {\n        println \"Debug \u5e94\u7528\"\n        sh \"helm upgrade --dry-run --debug --install ${args.name} ${args.chartDir} -f ${args.valuePath} --set image.tag=${args.imageTag} --namespace ${args.namespace}\"\n    } else {\n        println \"\u90e8\u7f72\u5e94\u7528\"\n        sh \"helm upgrade --install ${args.name} ${args.chartDir} -f ${args.valuePath} --set image.tag=${args.imageTag} --namespace ${args.namespace}\"\n        echo \"\u5e94\u7528 ${args.name} \u90e8\u7f72\u6210\u529f. \u53ef\u4ee5\u4f7f\u7528 helm status ${args.name} \u67e5\u770b\u5e94\u7528\u72b6\u6001\"\n    }\n}\n</code></pre> <p>\u6211\u4eec\u5728 Chart \u6a21\u677f\u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a <code>my-values.yaml</code> \u7684 Values \u6587\u4ef6\uff0c\u7528\u6765\u8986\u76d6\u9ed8\u8ba4\u7684\u503c\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u4f7f\u7528 Harbor \u79c1\u6709\u4ed3\u5e93\u7684\u955c\u50cf\uff0c\u5219\u5fc5\u7136\u9700\u8981\u5b9a\u4e49 <code>imagePullSecrets</code>\uff0c\u6240\u4ee5\u9700\u8981\u5728\u76ee\u6807 namespace \u4e0b\u9762\u521b\u5efa\u4e00\u4e2a Harbor \u767b\u5f55\u8ba4\u8bc1\u7684 Secret \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create secret docker-registry harbor-auth --docker-server=harbor.k8s.local --docker-username=admin --docker-password=Harbor12345 --docker-email=admin@admin.com --namespace kube-ops\nsecret/harbor-auth created\n</code></pre> <p>\u7136\u540e\u7531\u4e8e\u6bcf\u6b21\u6211\u4eec\u6784\u5efa\u7684\u955c\u50cf tag \u90fd\u4f1a\u53d8\u5316\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>--set</code> \u6765\u52a8\u6001\u8bbe\u7f6e\u3002</p> <p>\u4e0d\u8fc7\u9700\u8981\u8bb0\u5f97\u5728\u4e0a\u9762\u5bb9\u5668\u6a21\u677f\u4e2d\u6dfb\u52a0 helm \u5bb9\u5668\uff1a</p> <pre><code>containerTemplate(name: 'helm', image: 'cnych/helm', command: 'cat', ttyEnabled: true)\n</code></pre> <p>\u5bf9\u4e8e\u4e0d\u540c\u7684\u73af\u5883\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0d\u540c\u7684 values \u6587\u4ef6\u6765\u8fdb\u884c\u533a\u5206\uff0c\u8fd9\u6837\u5f53\u6211\u4eec\u90e8\u7f72\u7684\u65f6\u5019\u53ef\u4ee5\u624b\u52a8\u9009\u62e9\u90e8\u7f72\u5230\u67d0\u4e2a\u73af\u5883\u4e0b\u9762\u53bb\u3002</p> <pre><code>def userInput = input(\n  id: 'userInput',\n  message: '\u9009\u62e9\u4e00\u4e2a\u90e8\u7f72\u73af\u5883',\n  parameters: [\n      [\n          $class: 'ChoiceParameterDefinition',\n          choices: \"Dev\\\\nQA\\\\nProd\",\n          name: 'Env'\n      ]\n  ]\n)\necho \"\u90e8\u7f72\u5e94\u7528\u5230 ${userInput} \u73af\u5883\"\n// \u9009\u62e9\u4e0d\u540c\u73af\u5883\u4e0b\u9762\u7684 values \u6587\u4ef6\nif (userInput == \"Dev\") {\n    // deploy dev stuff\n} else if (userInput == \"QA\"){\n    // deploy qa stuff\n} else {\n    // deploy prod stuff\n}\n// \u6839\u636e values \u6587\u4ef6\u518d\u53bb\u4f7f\u7528 Helm \u8fdb\u884c\u90e8\u7f72\n</code></pre> <p>\u7136\u540e\u53bb\u6784\u5efa\u5e94\u7528\u7684\u65f6\u5019\uff0c\u5728 Helm \u90e8\u7f72\u9636\u6bb5\u5c31\u4f1a\u770b\u5230 Stage View \u754c\u9762\u51fa\u73b0\u4e86\u6682\u505c\u7684\u60c5\u51b5\uff0c\u9700\u8981\u6211\u4eec\u9009\u62e9\u4e00\u4e2a\u73af\u5883\u6765\u8fdb\u884c\u90e8\u7f72\uff1a</p> <p></p> <p>\u9009\u62e9\u5b8c\u6210\u540e\u518d\u53bb\u90e8\u7f72\u5e94\u7528\u3002\u6700\u540e\u6211\u4eec\u8fd8\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a kubectl \u5bb9\u5668\u6765\u67e5\u770b\u5e94\u7528\u7684\u76f8\u5173\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>stage('\u8fd0\u884c Kubectl') {\n  withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {\n    container('kubectl') {\n      sh \"mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config\"\n      echo \"\u67e5\u770b\u5e94\u7528\"\n      sh \"kubectl get all -n kube-ops -l app=devops-demo\"\n    }\n  }\n}\n</code></pre> <p>\u6709\u65f6\u5019\u6211\u4eec\u90e8\u7f72\u7684\u5e94\u7528\u5373\u4f7f\u6709\u5f88\u591a\u6d4b\u8bd5\uff0c\u4f46\u662f\u4e5f\u96be\u514d\u4f1a\u51fa\u73b0\u4e00\u4e9b\u9519\u8bef\uff0c\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u6211\u4eec\u662f\u90e8\u7f72\u5230\u7ebf\u4e0a\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u8981\u6c42\u80fd\u591f\u7acb\u5373\u8fdb\u884c\u56de\u6eda\uff0c\u8fd9\u91cc\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u4f7f\u7528 Helm \u6765\u975e\u5e38\u65b9\u4fbf\u7684\u64cd\u4f5c\uff0c\u6dfb\u52a0\u5982\u4e0b\u4e00\u4e2a\u56de\u6eda\u7684\u9636\u6bb5\uff1a</p> <pre><code>stage('\u5feb\u901f\u56de\u6eda?') {\n  withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {\n    container('helm') {\n      sh \"mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config\"\n      def userInput = input(\n        id: 'userInput',\n        message: '\u662f\u5426\u9700\u8981\u5feb\u901f\u56de\u6eda\uff1f',\n        parameters: [\n            [\n                $class: 'ChoiceParameterDefinition',\n                choices: \"Y\\\\nN\",\n                name: '\u56de\u6eda?'\n            ]\n        ]\n      )\n      if (userInput == \"Y\") {\n        sh \"helm rollback devops-demo --namespace kube-ops\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u6700\u540e\u4e00\u6761\u5b8c\u6574\u7684\u6d41\u6c34\u7ebf\u5c31\u5b8c\u6210\u4e86\u3002</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u672c\u5730\u52a0\u4e0a\u5e94\u7528\u57df\u540d </p> <pre><code>devops-demo.k8s.local\n</code></pre> <p>\u7684\u6620\u5c04\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5e94\u7528\u4e86\uff1a</p> <pre><code>$ curl http://devops-demo.k8s.local\n{\"msg\":\"Hello DevOps On Kubernetes\"}\n</code></pre> <p>\u5b8c\u6574\u7684 Jenkinsfile \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>def label = \"slave-${UUID.randomUUID().toString()}\"\n\ndef helmLint(String chartDir) {\n    println \"\u6821\u9a8c chart \u6a21\u677f\"\n    sh \"helm lint ${chartDir}\"\n}\n\ndef helmDeploy(Map args) {\n    if (args.debug) {\n        println \"Debug \u5e94\u7528\"\n        sh \"helm upgrade --dry-run --debug --install ${args.name} ${args.chartDir} -f ${args.valuePath} --set image.tag=${args.imageTag} --namespace ${args.namespace}\"\n    } else {\n        println \"\u90e8\u7f72\u5e94\u7528\"\n        sh \"helm upgrade --install ${args.name} ${args.chartDir} -f ${args.valuePath} --set image.tag=${args.imageTag} --namespace ${args.namespace}\"\n        echo \"\u5e94\u7528 ${args.name} \u90e8\u7f72\u6210\u529f. \u53ef\u4ee5\u4f7f\u7528 helm status ${args.name} \u67e5\u770b\u5e94\u7528\u72b6\u6001\"\n    }\n}\n\npodTemplate(label: label, containers: [\n  containerTemplate(name: 'golang', image: 'golang:2-alpine11', command: 'cat', ttyEnabled: true),\n  containerTemplate(name: 'docker', image: 'docker:latest', command: 'cat', ttyEnabled: true),\n  containerTemplate(name: 'helm', image: 'cnych/helm', command: 'cat', ttyEnabled: true),\n  containerTemplate(name: 'kubectl', image: 'cnych/kubectl', command: 'cat', ttyEnabled: true)\n], serviceAccount: 'jenkins', volumes: [\n  hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock')\n]) {\n  node(label) {\n    def myRepo = checkout scm\n    // \u83b7\u53d6 git commit id \u4f5c\u4e3a\u955c\u50cf\u6807\u7b7e\n    def imageTag = sh(script: \"git rev-parse --short HEAD\", returnStdout: true).trim()\n    // \u4ed3\u5e93\u5730\u5740\n    def registryUrl = \"harbor.k8s.local\"\n    def imageEndpoint = \"course/devops-demo\"\n    // \u955c\u50cf\n    def image = \"${registryUrl}/${imageEndpoint}:${imageTag}\"\n\n    stage('\u5355\u5143\u6d4b\u8bd5') {\n      echo \"\u6d4b\u8bd5\u9636\u6bb5\"\n    }\n    stage('\u4ee3\u7801\u7f16\u8bd1\u6253\u5305') {\n      try {\n        container('golang') {\n          echo \"\u4ee3\u7801\u7f16\u8bd1\u6253\u5305\u9636\u6bb5\"\n          sh \"\"\"\n            export GOPROXY=https://goproxy.cn\n            GOOS=linux GOARCH=amd64 go build -v -o demo-app\n            \"\"\"\n        }\n      } catch (exc) {\n        println \"\u6784\u5efa\u5931\u8d25 - ${currentBuild.fullDisplayName}\"\n        throw(exc)\n      }\n    }\n    stage('\u6784\u5efa Docker \u955c\u50cf') {\n      withCredentials([[$class: 'UsernamePasswordMultiBinding',\n        credentialsId: 'docker-auth',\n        usernameVariable: 'DOCKER_USER',\n        passwordVariable: 'DOCKER_PASSWORD']]) {\n          container('docker') {\n            echo \" \u6784\u5efa Docker \u955c\u50cf\u9636\u6bb5\"\n            sh \"\"\"\n              cat /etc/resolv.conf\n              docker login ${registryUrl} -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}\n              docker build -t ${image} .\n              docker push ${image}\n              \"\"\"\n          }\n      }\n    }\n    stage('\u8fd0\u884c Helm') {\n      withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {\n        container('helm') {\n          sh \"mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config\"\n          echo \"\u5f00\u59cb Helm \u90e8\u7f72\"\n          def userInput = input(\n            id: 'userInput',\n            message: '\u9009\u62e9\u4e00\u4e2a\u90e8\u7f72\u73af\u5883',\n            parameters: [\n                [\n                    $class: 'ChoiceParameterDefinition',\n                    choices: \"Dev\\\\nQA\\\\nProd\",\n                    name: 'Env'\n                ]\n            ]\n          )\n          echo \"\u90e8\u7f72\u5e94\u7528\u5230 ${userInput} \u73af\u5883\"\n          // \u9009\u62e9\u4e0d\u540c\u73af\u5883\u4e0b\u9762\u7684 values \u6587\u4ef6\n          if (userInput == \"Dev\") {\n              // deploy dev stuff\n          } else if (userInput == \"QA\"){\n              // deploy qa stuff\n          } else {\n              // deploy prod stuff\n          }\n          helmDeploy(\n              debug       : false,\n              name        : \"devops-demo\",\n              chartDir    : \"./helm\",\n              namespace   : \"kube-ops\",\n              valuePath   : \"./helm/my-values.yaml\",\n              imageTag    : \"${imageTag}\"\n          )\n        }\n      }\n    }\n    stage('\u8fd0\u884c Kubectl') {\n      withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {\n        container('kubectl') {\n          sh \"mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config\"\n          echo \"\u67e5\u770b\u5e94\u7528\"\n          sh \"kubectl get all -n kube-ops -l app=devops-demo\"\n        }\n      }\n    }\n    stage('\u5feb\u901f\u56de\u6eda?') {\n      withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {\n        container('helm') {\n          sh \"mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config\"\n          def userInput = input(\n            id: 'userInput',\n            message: '\u662f\u5426\u9700\u8981\u5feb\u901f\u56de\u6eda\uff1f',\n            parameters: [\n                [\n                    $class: 'ChoiceParameterDefinition',\n                    choices: \"Y\\\\nN\",\n                    name: '\u56de\u6eda?'\n                ]\n            ]\n          )\n          if (userInput == \"Y\") {\n            sh \"helm rollback devops-demo --namespace kube-ops\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"kubernetes_devops/token/","title":"Tekton","text":""},{"location":"kubernetes_devops/token/#tekton","title":"Tekton","text":"<p>Tekton \u662f\u4e00\u6b3e\u529f\u80fd\u975e\u5e38\u5f3a\u5927\u800c\u7075\u6d3b\u7684 CI/CD \u5f00\u6e90\u7684\u4e91\u539f\u751f\u6846\u67b6\u3002Tekton \u7684\u524d\u8eab\u662f Knative \u9879\u76ee\u7684 build-pipeline \u9879\u76ee\uff0c\u8fd9\u4e2a\u9879\u76ee\u662f\u4e3a\u4e86\u7ed9 build \u6a21\u5757\u589e\u52a0 pipeline \u7684\u529f\u80fd\uff0c\u4f46\u662f\u968f\u7740\u4e0d\u540c\u7684\u529f\u80fd\u52a0\u5165\u5230 Knative build \u6a21\u5757\u4e2d\uff0cbuild \u6a21\u5757\u8d8a\u6765\u8d8a\u53d8\u5f97\u50cf\u4e00\u4e2a\u901a\u7528\u7684 CI/CD \u7cfb\u7edf\uff0c\u4e8e\u662f\uff0c\u7d22\u6027\u5c06 build-pipeline \u5265\u79bb\u51fa Knative\uff0c\u5c31\u53d8\u6210\u4e86\u73b0\u5728\u7684 Tekton\uff0c\u800c Tekton \u4e5f\u4ece\u6b64\u81f4\u529b\u4e8e\u63d0\u4f9b\u5168\u529f\u80fd\u3001\u6807\u51c6\u5316\u7684\u4e91\u539f\u751f CI/CD \u89e3\u51b3\u65b9\u6848\u3002</p>"},{"location":"kubernetes_devops/token/#_1","title":"\u5b89\u88c5","text":"<p>\u5b89\u88c5 Tekton \u975e\u5e38\u7b80\u5355\uff0c\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 tektoncd/pipeline \u7684 GitHub \u4ed3\u5e93\u4e2d\u7684 <code>release.yaml</code> \u6587\u4ef6\u8fdb\u884c\u5b89\u88c5\uff0c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl apply -f https://github.com/tektoncd/pipeline/releases/download/v0/release.yaml\n</code></pre> <p>\u7531\u4e8e\u5b98\u65b9\u4f7f\u7528\u7684\u955c\u50cf\u662f <code>gcr</code> \u7684\u955c\u50cf\uff0c\u6240\u4ee5\u6b63\u5e38\u60c5\u51b5\u4e0b\u6211\u4eec\u662f\u83b7\u53d6\u4e0d\u5230\u7684\uff0c\u5982\u679c\u4f60\u7684\u96c6\u7fa4\u7531\u4e8e\u67d0\u4e9b\u539f\u56e0\u83b7\u53d6\u4e0d\u5230\u955c\u50cf\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u6211\u5df2\u7ecf\u5c06\u955c\u50cf\u66ff\u6362\u6210\u4e86 Docker Hub \u4e0a\u9762\u7684\u955c\u50cf\uff1a</p> <pre><code>$ kubectl apply -f https://www.qikqiak.com/k8strain/devops/manifests/tekton/release.yaml\n</code></pre> <p>\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5b89\u88c5\u540e\uff0c\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>tekton-pipelines</code> \u7684\u547d\u540d\u7a7a\u95f4\uff0c\u5728\u8be5\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u4f1a\u6709\u5927\u91cf\u548c tekton \u76f8\u5173\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u8be5\u547d\u540d\u7a7a\u95f4\u4e2d\u67e5\u770b Pod \u5e76\u786e\u4fdd\u5b83\u4eec\u5904\u4e8e Running \u72b6\u6001\u6765\u68c0\u67e5\u5b89\u88c5\u662f\u5426\u6210\u529f\uff1a</p> <pre><code>$ kubectl get pods -n tekton-pipelines\nNAME                                           READY   STATUS    RESTARTS   AGE\ntekton-pipelines-controller-67f4dc98d8-pgxrq   1/1     Running   0          9m46s\ntekton-pipelines-webhook-59df55445c-jw76v      1/1     Running   0          9m45s\n</code></pre> <p>Tekton \u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u9009\u62e9\u662f\u5426\u5b89\u88c5 CLI \u5de5\u5177\uff0c\u6709\u65f6\u5019\u53ef\u80fd Tekton \u63d0\u4f9b\u7684\u547d\u4ee4\u884c\u5de5\u5177\u6bd4 kubectl \u7ba1\u7406\u8fd9\u4e9b\u8d44\u6e90\u66f4\u52a0\u65b9\u4fbf\uff0c\u5f53\u7136\u8fd9\u5e76\u4e0d\u662f\u5f3a\u5236\u7684\uff0c\u6211\u8fd9\u91cc\u662f Mac \u7cfb\u7edf\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528\u5e38\u7528\u7684 Homebrew \u5de5\u5177\u6765\u5b89\u88c5\uff1a</p> <pre><code>$ brew tap tektoncd/tools\n$ brew install tektoncd/tools/tektoncd-cli\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u9a8c\u8bc1 CLI \u662f\u5426\u5b89\u88c5\u6210\u529f\uff1a</p> <pre><code>$ tkn version\nClient version: 0\nPipeline version: v0\n</code></pre> <p>\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u5b89\u88c5\u4e00\u4e2a Tekton \u63d0\u4f9b\u7684\u4e00\u4e2a Dashboard\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Dashboard \u67e5\u770b Tekton \u6574\u4e2a\u4efb\u52a1\u7684\u6784\u5efa\u8fc7\u7a0b\uff0c\u76f4\u63a5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f kubectl apply -f https://www.qikqiak.com/k8strain/devops/manifests/tekton/dashboard.yaml\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Dashboard \u7684 Service \u7684 NodePort \u6765\u8bbf\u95ee\u5e94\u7528\u3002</p> <p></p>"},{"location":"kubernetes_devops/token/#_2","title":"\u6982\u5ff5","text":"<p>Tekton \u4e3a Kubernetes \u63d0\u4f9b\u4e86\u591a\u79cd CRD \u8d44\u6e90\u5bf9\u8c61\uff0c\u53ef\u7528\u4e8e\u5b9a\u4e49\u6211\u4eec\u7684\u6d41\u6c34\u7ebf\u3002</p> <p></p> <p>\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <ul> <li>Task\uff1a\u8868\u793a\u6267\u884c\u547d\u4ee4\u7684\u4e00\u7cfb\u5217\u6b65\u9aa4\uff0ctask \u91cc\u53ef\u4ee5\u5b9a\u4e49\u4e00\u7cfb\u5217\u7684 steps\uff0c\u4f8b\u5982\u7f16\u8bd1\u4ee3\u7801\u3001\u6784\u5efa\u955c\u50cf\u3001\u63a8\u9001\u955c\u50cf\u7b49\uff0c\u6bcf\u4e2a step \u5b9e\u9645\u7531\u4e00\u4e2a Pod \u6267\u884c\u3002</li> <li>ClusterTask\uff1a\u8986\u76d6\u6574\u4e2a\u96c6\u7fa4\u7684\u4efb\u52a1\uff0c\u800c\u4e0d\u662f\u5355\u4e00\u7684\u67d0\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u8fd9\u662f\u548c Task \u6700\u5927\u7684\u533a\u522b\uff0c\u5176\u4ed6\u57fa\u672c\u4e0a\u4e00\u81f4\u7684\u3002</li> <li>TaskRun\uff1atask \u53ea\u662f\u5b9a\u4e49\u4e86\u4e00\u4e2a\u6a21\u7248\uff0ctaskRun \u624d\u771f\u6b63\u4ee3\u8868\u4e86\u4e00\u6b21\u5b9e\u9645\u7684\u8fd0\u884c\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u81ea\u5df1\u624b\u52a8\u521b\u5efa\u4e00\u4e2a taskRun\uff0ctaskRun \u521b\u5efa\u51fa\u6765\u4e4b\u540e\uff0c\u5c31\u4f1a\u81ea\u52a8\u89e6\u53d1 task \u63cf\u8ff0\u7684\u6784\u5efa\u4efb\u52a1\u3002</li> <li>Pipeline\uff1a\u4e00\u7ec4\u4efb\u52a1\uff0c\u8868\u793a\u4e00\u4e2a\u6216\u591a\u4e2a Task\u3001PipelineResource \u4ee5\u53ca\u5404\u79cd\u5b9a\u4e49\u53c2\u6570\u7684\u96c6\u5408\u3002</li> <li>PipelineRun\uff1a\u7c7b\u4f3c task \u548c taskRun \u7684\u5173\u7cfb\uff0cpipelineRun \u4e5f\u8868\u793a\u67d0\u4e00\u6b21\u5b9e\u9645\u8fd0\u884c\u7684 pipeline\uff0c\u4e0b\u53d1\u4e00\u4e2a pipelineRun CRD \u5b9e\u4f8b\u5230 Kubernetes \u540e\uff0c\u540c\u6837\u4e5f\u4f1a\u89e6\u53d1\u4e00\u6b21 pipeline \u7684\u6784\u5efa\u3002</li> <li>PipelineResource\uff1a\u8868\u793a pipeline \u8f93\u5165\u8d44\u6e90\uff0c\u6bd4\u5982 github \u4e0a\u7684\u6e90\u7801\uff0c\u6216\u8005 pipeline \u8f93\u51fa\u8d44\u6e90\uff0c\u4f8b\u5982\u4e00\u4e2a\u5bb9\u5668\u955c\u50cf\u6216\u8005\u6784\u5efa\u751f\u6210\u7684 jar \u5305\u7b49\u3002</li> </ul>"},{"location":"kubernetes_devops/token/#_3","title":"\u793a\u4f8b","text":"<p>\u5728\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e00\u4e2a\u7b80\u5355\u7684 Golang \u5e94\u7528\uff0c\u53ef\u4ee5\u5728\u4ed3\u5e93 https://github.com/cnych/tekton-demo \u4e0b\u9762\u83b7\u53d6\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\uff0c\u6d4b\u8bd5\u4ee5\u53ca Dockerfile \u6587\u4ef6\u3002</p> <p>\u9996\u5148\u7b2c\u4e00\u4e2a\u4efb\u52a1\u5c31\u662f Clone \u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u8fdb\u884c\u6d4b\u8bd5\uff0c\u521b\u5efa\u4e00\u4e2a <code>task-test.yaml</code> \u7684\u8d44\u6e90\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: tekton.dev/v1beta1\nkind: Task\nmetadata:\n  name: test\nspec:\n  resources:\n    inputs:\n    - name: repo\n      type: git\n  steps:\n  - name: run-test\n    image: golang:14-alpine\n    workingDir: /workspace/repo\n    command: [\"go\"]\n    args: [\"test\"]\n</code></pre> <p>\u5176\u4e2d <code>resources</code> \u5b9a\u4e49\u4e86\u6211\u4eec\u7684\u4efb\u52a1\u4e2d\u5b9a\u4e49\u7684\u6b65\u9aa4\u6240\u9700\u7684\u8f93\u5165\u5185\u5bb9\uff0c\u8fd9\u91cc\u6211\u4eec\u7684\u6b65\u9aa4\u9700\u8981 Clone \u4e00\u4e2a Git \u4ed3\u5e93\u4f5c\u4e3a <code>go test</code> \u547d\u4ee4\u7684\u8f93\u5165\uff0c\u76ee\u524d\u652f\u6301 git\u3001pullRequest\u3001image\u3001cluster\u3001storage\u3001cloudevent \u7b49\u8d44\u6e90\u3002</p> <p>Tekton \u5185\u7f6e\u7684 git \u8d44\u6e90\u7c7b\u578b\uff0c\u5b83\u4f1a\u81ea\u52a8\u5c06\u4ee3\u7801\u4ed3\u5e93 Clone \u5230 </p> <pre><code>/workspace/$input_name\n</code></pre> <p>\u76ee\u5f55\u4e2d\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u8f93\u5165\u88ab\u547d\u540d\u6210 repo\uff0c\u6240\u4ee5\u4ee3\u7801\u4f1a\u88ab Clone \u5230 <code>/workspace/repo</code> \u76ee\u5f55\u4e0b\u9762\u3002</p> <p>\u7136\u540e\u4e0b\u9762\u7684 <code>steps</code> \u5c31\u662f\u6765\u5b9a\u4e49\u6267\u884c\u8fd0\u884c\u6d4b\u8bd5\u547d\u4ee4\u7684\u6b65\u9aa4\uff0c\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u5728\u4ee3\u7801\u7684\u6839\u76ee\u5f55\u4e2d\u8fd0\u884c <code>go test</code> \u547d\u4ee4\u5373\u53ef\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u547d\u4ee4\u548c\u53c2\u6570\u9700\u8981\u5206\u522b\u5b9a\u4e49\u3002</p> <p>\u5b9a\u4e49\u5b8c\u6210\u540e\u76f4\u63a5\u4f7f\u7528 kubectl \u521b\u5efa\u8be5\u4efb\u52a1\uff1a</p> <pre><code>$ kubectl apply -f task-test.yaml\ntask.tekton.dev/test created\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5b9a\u4e49\u5b8c\u6210\u4e86\u4e00\u4e2a\u5efa\u7684 Task \u4efb\u52a1\uff0c\u4f46\u662f\u8be5\u4efb\u52a1\u5e76\u4e0d\u4f1a\u7acb\u5373\u6267\u884c\uff0c\u6211\u4eec\u5fc5\u987b\u521b\u5efa\u4e00\u4e2a <code>TaskRun</code> \u5f15\u7528\u5b83\u5e76\u63d0\u4f9b\u6240\u6709\u5fc5\u9700\u8f93\u5165\u7684\u6570\u636e\u624d\u884c\u3002\u8fd9\u91cc\u6211\u4eec\u5c31\u9700\u8981\u5c06 git \u4ee3\u7801\u5e93\u4f5c\u4e3a\u8f93\u5165\uff0c\u6211\u4eec\u5fc5\u987b\u5148\u521b\u5efa\u4e00\u4e2a <code>PipelineResource</code> \u5bf9\u8c61\u6765\u5b9a\u4e49\u8f93\u5165\u4fe1\u606f\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a </p> <pre><code>pipelineresource.yaml\n</code></pre> <p>\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: tekton.dev/v1alpha1\nkind: PipelineResource\nmetadata:\n  name: cnych-tekton-example\nspec:\n  type: git\n  params:\n  - name: url\n    value: https://github.com/cnych/tekton-demo\n  - name: revision\n    value: master\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f pipelineresource.yaml\npipelineresource.tekton.dev/cnych-tekton-example created\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u521b\u5efa <code>TaskRun</code> \u5bf9\u8c61\u4e86\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>taskrun.yaml</code> \u7684\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: tekton.dev/v1beta1\nkind: TaskRun\nmetadata:\n  name: testrun\nspec:\n  taskRef:\n    name: test\n  resources:\n    inputs:\n    - name: repo\n      resourceRef:\n        name: cnych-tekton-example\n</code></pre> <p>\u8fd9\u91cc\u901a\u8fc7 <code>taskRef</code> \u5f15\u7528\u4e0a\u9762\u5b9a\u4e49\u7684 Task \u548c git \u4ed3\u5e93\u4f5c\u4e3a\u8f93\u5165\uff0c<code>resourceRef</code> \u4e5f\u662f\u5f15\u7528\u4e0a\u9762\u5b9a\u4e49\u7684 <code>PipelineResource</code> \u8d44\u6e90\u5bf9\u8c61\u3002\u73b0\u5728\u6211\u4eec\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u8fc7\u540e\uff0c\u5c31\u4f1a\u5f00\u59cb\u8fd0\u884c\u4e86\uff1a</p> <pre><code>$ kubectl apply -f taskrun.yaml\ntaskrun.tekton.dev/testrun created\n</code></pre> <p>\u521b\u5efa\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b TaskRun \u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u6765\u67e5\u770b\u6784\u5efa\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get taskrun\nNAME      SUCCEEDED   REASON    STARTTIME   COMPLETIONTIME\ntestrun   Unknown     Pending   21s    \n$ kubectl get pods   \nNAME                             READY   STATUS     RESTARTS   AGE\ntestrun-pod-mw9bt                0/2     Init:1/2   0          59s\n$ kubectl describe pod testrun-pod-mw9bt\n......\n                 node.kubernetes.io/unreachable:NoExecute for 300s\nEvents:\n  Type    Reason     Age        From                 Message\n  ----    ------     ----       ----                 -------\n  Normal  Scheduled  &lt;unknown&gt;  default-scheduler    Successfully assigned default/testrun-pod-mw9bt to ydzs-node5\n  Normal  Pulling    4m20s      kubelet, ydzs-node5  Pulling image \"busybox@sha256:a2490cec4484ee6c1068ba3a05f89934010c85242f736280b35343483b2264b6\"\n  Normal  Pulled     4m13s      kubelet, ydzs-node5  Successfully pulled image \"busybox@sha256:a2490cec4484ee6c1068ba3a05f89934010c85242f736280b35343483b2264b6\"\n  Normal  Created    4m13s      kubelet, ydzs-node5  Created container working-dir-initializer\n  Normal  Started    4m13s      kubelet, ydzs-node5  Started container working-dir-initializer\n  Normal  Pulling    4m12s      kubelet, ydzs-node5  Pulling image \"cnych/tekton-entrypoint:v0\"\n  Normal  Pulled     2m13s      kubelet, ydzs-node5  Successfully pulled image \"cnych/tekton-entrypoint:v0\"\n  Normal  Created    2m13s      kubelet, ydzs-node5  Created container place-tools\n  Normal  Started    2m12s      kubelet, ydzs-node5  Started container place-tools\n  Normal  Pulling    2m12s      kubelet, ydzs-node5  Pulling image \"cnych/tekton-git-init:v0\"\n  Normal  Pulled     33s        kubelet, ydzs-node5  Successfully pulled image \"cnych/tekton-git-init:v0\"\n  Normal  Created    32s        kubelet, ydzs-node5  Created container step-git-source-cnych-tekton-example-d6mcz\n  Normal  Started    32s        kubelet, ydzs-node5  Started container step-git-source-cnych-tekton-example-d6mcz\n  Normal  Pulling    32s        kubelet, ydzs-node5  Pulling image \"golang:14-alpine\"\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>kubectl describe</code> \u547d\u4ee4\u6765\u67e5\u770b\u4efb\u52a1\u8fd0\u884c\u7684\u8fc7\u7a0b\uff0c\u9996\u5148\u5c31\u662f\u901a\u8fc7 <code>initContainer</code> \u4e2d\u7684\u4e00\u4e2a busybox \u955c\u50cf\u5c06\u4ee3\u7801 Clone \u4e0b\u6765\uff0c\u7136\u540e\u4f7f\u7528\u4efb\u52a1\u4e2d\u5b9a\u4e49\u7684\u955c\u50cf\u6765\u6267\u884c\u547d\u4ee4\u3002</p> <p>\u5f53\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u540e\uff0c Pod \u5c31\u4f1a\u53d8\u6210 Completed \u72b6\u6001\u4e86\uff1a</p> <pre><code>$ kubectl get pods\nNAME                READY   STATUS      RESTARTS   AGE\ntestrun-pod-mw9bt   0/2     Completed   0          4m27s\n$ kubectl get taskrun\nNAME      SUCCEEDED   REASON      STARTTIME   COMPLETIONTIME\ntestrun   True        Succeeded   70s         57s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5bb9\u5668\u7684\u65e5\u5fd7\u4fe1\u606f\u6765\u4e86\u89e3\u4efb\u52a1\u7684\u6267\u884c\u7ed3\u679c\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl logs testrun-pod-mw9bt --all-containers\n{\"level\":\"info\",\"ts\":15887518779908,\"caller\":\"git/git.go:136\",\"msg\":\"Successfully cloned https://github.com/cnych/tekton-demo @ f840e0c390be9a1a6edad76abbde64e882047f05 (grafted, HEAD, origin/master) in path /workspace/repo\"}\n{\"level\":\"info\",\"ts\":158875188844209,\"caller\":\"git/git.go:177\",\"msg\":\"Successfully initialized and updated submodules in path /workspace/repo\"}\nPASS\nok      _/workspace/repo        006s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u7684\u6d4b\u8bd5\u5df2\u7ecf\u901a\u8fc7\u4e86\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 Tekton CLI \u5de5\u5177\u6765\u8fd0\u884c\u8fd9\u4e2a\u4efb\u52a1\u3002Tekton CLI \u63d0\u4f9b\u4e86\u4e00\u79cd\u66f4\u5feb\u3001\u66f4\u65b9\u4fbf\u7684\u65b9\u5f0f\u6765\u8fd0\u884c\u4efb\u52a1\u3002</p> <p>\u6211\u4eec\u4e0d\u7528\u624b\u52a8\u7f16\u5199 TaskRun \u8d44\u6e90\u6e05\u5355\uff0c\u53ef\u4ee5\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u6765\u6267\u884c\uff0c\u8be5\u547d\u4ee4\u5f15\u7528\u6211\u4eec\u7684\u4efb\u52a1\uff08\u540d\u4e3a test\uff09\uff0c\u751f\u6210\u4e00\u4e2a TaskRun \u8d44\u6e90\u5bf9\u8c61\u5e76\u663e\u793a\u5176\u65e5\u5fd7\uff1a</p> <pre><code>$ tkn task start test --inputresource repo=cnych-tekton-example --showlog\nTaskrun started: test-run-z56lj\nWaiting for logs to be available...\n[git-source-cnych-tekton-example-8q268] {\"level\":\"info\",\"ts\":15887526350016,\"caller\":\"git/git.go:136\",\"msg\":\"Successfully cloned https://github.com/cnych/tekton-demo @ f840e0c390be9a1a6edad76abbde64e882047f05 (grafted, HEAD, origin/master) in path /workspace/repo\"}\n[git-source-cnych-tekton-example-8q268] {\"level\":\"info\",\"ts\":15887526453426,\"caller\":\"git/git.go:177\",\"msg\":\"Successfully initialized and updated submodules in path /workspace/repo\"}\n\n[run-test] PASS\n[run-test] ok   _/workspace/repo    007s\n</code></pre>"},{"location":"kubernetes_devops/token/#docker_hub","title":"Docker Hub \u914d\u7f6e","text":"<p>\u4e3a\u4e86\u80fd\u591f\u6784\u5efa Docker \u955c\u50cf\uff0c\u4e00\u822c\u6765\u8bf4\u6211\u4eec\u9700\u8981\u4f7f\u7528 Docker \u6765\u8fdb\u884c\uff0c\u6211\u4eec\u8fd9\u91cc\u662f\u5bb9\u5668\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528 <code>Docker In Docker \u6a21\u5f0f</code>\uff0c\u4f46\u662f\u8fd9\u79cd\u6a21\u5f0f\u5b89\u5168\u6027\u4e0d\u9ad8\uff0c\u9664\u4e86\u8fd9\u79cd\u65b9\u5f0f\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 Google \u63a8\u51fa\u7684 Kaniko \u5de5\u5177\u6765\u8fdb\u884c\u6784\u5efa\uff0c\u8be5\u5de5\u5177\u53ef\u4ee5\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u6784\u5efa Docker \u955c\u50cf\u800c\u65e0\u9700\u4f9d\u8d56 Docker \u5b88\u62a4\u8fdb\u7a0b\u3002</p> <p>\u4f7f\u7528 Kaniko \u6784\u5efa\u955c\u50cf\u548c Docker \u547d\u4ee4\u57fa\u672c\u4e0a\u4e00\u81f4\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u63d0\u524d\u8bbe\u7f6e\u4e0b Docker Hub \u7684\u767b\u5f55\u51ed\u8bc1\uff0c\u65b9\u4fbf\u540e\u7eed\u5c06\u955c\u50cf\u63a8\u9001\u5230\u955c\u50cf\u4ed3\u5e93\u3002\u767b\u5f55\u51ed\u8bc1\u53ef\u4ee5\u4fdd\u5b58\u5230 Kubernetes \u7684 Secret \u8d44\u6e90\u5bf9\u8c61\u4e2d\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>secret.yaml</code> \u7684\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a:</p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: docker-auth\n  annotations:\n    tekton.dev/docker-0: https://index.docker.io/v1/\ntype: kubernetes.io/basic-auth\nstringData:\n    username: myusername\n    password: mypassword\n</code></pre> <p>\u8bb0\u5f97\u5c06 myusername \u548c mypassword \u66ff\u6362\u6210\u4f60\u7684 Docker Hub \u767b\u5f55\u51ed\u8bc1\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u5728 Secret \u5bf9\u8c61\u4e2d\u6dfb\u52a0\u4e86\u4e00\u4e2a <code>tekton.dev/docker-0</code> \u7684 annotation\uff0c\u8be5\u6ce8\u89e3\u4fe1\u606f\u662f\u7528\u6765\u544a\u8bc9 Tekton \u8fd9\u4e9b\u8ba4\u8bc1\u4fe1\u606f\u6240\u5c5e\u7684 Docker \u955c\u50cf\u4ed3\u5e93\u3002</p> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a ServiceAccount \u5bf9\u8c61\u6765\u4f7f\u7528\u4e0a\u9762\u7684 <code>docker-auth</code> \u8fd9\u4e2a Secret \u5bf9\u8c61\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>serviceaccount.yaml</code> \u7684\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: build-sa\nsecrets:\n- name: docker-auth\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u4e24\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f secret.yaml \nsecret/docker-auth created\n$ kubectl apply -f serviceaccount.yaml \nserviceaccount/build-sa created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u8fd0\u884c Tekton \u7684\u4efb\u52a1\u6216\u8005\u6d41\u6c34\u7ebf\u7684\u65f6\u5019\u4f7f\u7528\u4e0a\u9762\u7684 build-sa \u8fd9\u4e2a <code>ServiceAccount</code> \u5bf9\u8c61\u6765\u8fdb\u884c Docker Hub \u7684\u767b\u5f55\u8ba4\u8bc1\u4e86\u3002</p>"},{"location":"kubernetes_devops/token/#_4","title":"\u521b\u5efa\u955c\u50cf\u4efb\u52a1","text":"<p>\u73b0\u5728\u6211\u4eec\u521b\u5efa\u4e00\u4e2a Task \u4efb\u52a1\u6765\u6784\u5efa\u5e76\u63a8\u9001 Docker \u955c\u50cf\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u793a\u4f8b\u5e94\u7528\u6839\u76ee\u5f55\u4e0b\u9762\u5df2\u7ecf\u5305\u542b\u4e86\u4e00\u4e2a <code>Dockerfile</code> \u6587\u4ef6\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u76f4\u63a5 Clone \u4ee3\u7801\u5c31\u53ef\u4ee5\u83b7\u5f97\uff1a</p> <pre><code>FROM golang:14-alpine\n\nWORKDIR /go/src/app\nCOPY . .\n\nRUN go get -d -v ./...\nRUN go install -v ./...\n\nCMD [\"app\"]\n</code></pre> <p>\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>task-build-push.yaml</code> \u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: tekton.dev/v1beta1\nkind: Task\nmetadata:\n  name: build-and-push\nspec:\n  resources:\n    inputs:\n    - name: repo\n      type: git\n  steps:\n  - name: build-and-push\n    image: cnych/kaniko-executor:v0\n    env:\n    - name: DOCKER_CONFIG\n      value: /tekton/home/.docker\n    command:\n    - /kaniko/executor\n    - --dockerfile=Dockerfile\n    - --context=/workspace/repo\n    - --destination=cnych/tekton-test:latest\n</code></pre> <p>\u548c\u524d\u9762\u7684\u6d4b\u8bd5\u4efb\u52a1\u7c7b\u4f3c\uff0c\u8fd9\u91cc\u6211\u4eec\u540c\u6837\u5c06 git \u4f5c\u4e3a\u8f93\u5165\uff0c\u4e5f\u53ea\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a build-and-push \u7684\u6b65\u9aa4\uff0cKaniko \u4f1a\u5728\u540c\u4e00\u4e2a\u547d\u4ee4\u4e2d<code>\u6784\u5efa\u5e76\u63a8\u9001</code>\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u591a\u4e2a\u6b65\u9aa4\u4e86\uff0c\u6267\u884c\u7684\u547d\u4ee4\u5c31\u662f <code>/kaniko/executor</code>\uff0c\u901a\u8fc7 <code>--dockerfile</code> \u6307\u5b9a Dockerfile \u8def\u5f84\uff0c<code>--context</code> \u6307\u5b9a\u6784\u5efa\u4e0a\u4e0b\u6587\uff0c\u6211\u4eec\u8fd9\u91cc\u5f53\u7136\u5c31\u662f\u9879\u76ee\u7684\u6839\u76ee\u5f55\u4e86\uff0c\u7136\u540e <code>--destination</code> \u53c2\u6570\u6307\u5b9a\u6700\u7ec8\u6211\u4eec\u7684\u955c\u50cf\u540d\u79f0\u3002\u5176\u5b9e Tekton \u4e5f\u652f\u6301\u53c2\u6570\u5316\u7684\u5f62\u5f0f\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u907f\u514d\u6211\u4eec\u8fd9\u91cc\u76f4\u63a5\u5199\u6b7b\u4e86\uff0c\u4e0d\u8fc7\u7531\u4e8e\u6211\u4eec\u90fd\u8fd8\u662f\u521d\u5b66\u8005\uff0c\u4e3a\u4e86\u907f\u514d\u590d\u6742\uff0c\u6211\u4eec\u76f4\u63a5\u5c31\u76f4\u63a5\u786c\u7f16\u7801\u4e86\u3002</p> <p>\u6b64\u5916\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a <code>DOCKER_CONFIG</code> \u7684\u73af\u5883\u53d8\u91cf\uff0c\u8fd9\u4e2a\u53d8\u91cf\u662f\u7528\u4e8e Kaniko \u53bb\u67e5\u627e Docker \u8ba4\u8bc1\u4fe1\u606f\u7684\u3002</p> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f task-build-push.yaml \ntask.tekton.dev/build-and-push created\n</code></pre> <p>\u521b\u5efa\u4e86 Task \u4efb\u52a1\u8fc7\u540e\uff0c\u8981\u60f3\u771f\u6b63\u53bb\u6267\u884c\u8fd9\u4e2a\u4efb\u52a1\uff0c\u6211\u4eec\u5c31\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 TaskRun \u8d44\u6e90\u5bf9\u8c61\u3002</p>"},{"location":"kubernetes_devops/token/#_5","title":"\u6267\u884c\u4efb\u52a1","text":"<p>\u548c\u524d\u9762\u4e00\u6837\uff0c\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a TaskRun \u5bf9\u8c61\u6765\u89e6\u53d1\u4efb\u52a1\uff0c\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\u6211\u4eec\u9700\u8981\u6307\u5b9a Task \u65f6\u9700\u8981\u7684 ServiceAccount \u5bf9\u8c61\u3002\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a </p> <pre><code>taskrun-build-push.yaml\n</code></pre> <p>\u7684\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: tekton.dev/v1beta1\nkind: TaskRun\nmetadata:\n  name: build-and-push\nspec:\n  serviceAccountName: build-sa\n  taskRef:\n    name: build-and-push\n  resources:\n    inputs:\n    - name: repo\n      resourceRef:\n        name: cnych-tekton-example\n</code></pre> <p>\u6ce8\u610f\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>serviceAccountName</code> \u5c5e\u6027\u6307\u5b9a\u4e86 Docker \u8ba4\u8bc1\u4fe1\u606f\u7684 <code>ServiceAccount</code> \u5bf9\u8c61\uff0c\u7136\u540e\u901a\u8fc7 <code>taskRef</code> \u5f15\u7528\u6211\u4eec\u7684\u4efb\u52a1\uff0c\u4ee5\u53ca\u4e0b\u9762\u7684 <code>resourceRef</code> \u5173\u8054\u7b2c\u4e00\u90e8\u5206\u6211\u4eec\u58f0\u660e\u7684\u8f93\u5165\u8d44\u6e90\u3002</p> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f taskrun-build-push.yaml \ntaskrun.tekton.dev/build-and-push created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u5c31\u4f1a\u89e6\u53d1\u4efb\u52a1\u6267\u884c\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b Pod \u5bf9\u8c61\u72b6\u6001\u6765\u4e86\u89e3\u8fdb\u5ea6\uff1a</p> <pre><code>$ kubectl get pods \nNAME                             READY   STATUS      RESTARTS   AGE\nbuild-and-push-pod-pv6mv         0/2     Init:0/2    0          32s\n$ kubectl get taskrun\nNAME             SUCCEEDED   REASON      STARTTIME   COMPLETIONTIME\nbuild-and-push   Unknown     Pending     108s\n</code></pre> <p>\u73b0\u5728\u4efb\u52a1\u6267\u884c\u7684 Pod \u8fd8\u5728\u521d\u59cb\u5316\u5bb9\u5668\u9636\u6bb5\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 TaskRun \u7684\u72b6\u6001\u5904\u4e8e Pending\uff0c\u9694\u4e00\u4f1a\u513f\u6b63\u5e38\u6784\u5efa\u5c31\u4f1a\u6210\u529f\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u6784\u5efa\u4efb\u52a1\u7684 Pod \u65e5\u5fd7\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pods\nNAME                             READY   STATUS      RESTARTS   AGE\nbuild-and-push-pod-pv6mv         0/2     Completed   0          16m\n$  kubectl logs -f build-and-push-pod-pv6mv --all-containers\n{\"level\":\"info\",\"ts\":158890721187525,\"caller\":\"creds-init/main.go:44\",\"msg\":\"Credentials initialized.\"}\n{\"level\":\"info\",\"ts\":15889074917656,\"caller\":\"git/git.go:136\",\"msg\":\"Successfully cloned https://github.com/cnych/tekton-demo @ f840e0c390be9a1a6edad76abbde64e882047f05 (grafted, HEAD, origin/master) in path /workspace/repo\"}\n{\"level\":\"info\",\"ts\":158890740128217,\"caller\":\"git/git.go:177\",\"msg\":\"Successfully initialized and updated submodules in path /workspace/repo\"}\nINFO[0010] Retrieving image manifest golang:14-alpine\nINFO[0016] Retrieving image manifest golang:14-alpine\nINFO[0020] Built cross stage deps: map[]\nINFO[0020] Retrieving image manifest golang:14-alpine\nINFO[0023] Retrieving image manifest golang:14-alpine\nINFO[0029] Executing 0 build triggers\nINFO[0029] Unpacking rootfs as cmd COPY . . requires it.\nINFO[0259] WORKDIR /go/src/app\nINFO[0259] cmd: workdir\nINFO[0259] Changed working directory to /go/src/app\nINFO[0259] Creating directory /go/src/app\nINFO[0259] Resolving 1 paths\nINFO[0259] Taking snapshot of files...\nINFO[0259] COPY . .\nINFO[0259] Resolving 56 paths\nINFO[0259] Taking snapshot of files...\nINFO[0259] RUN go get -d -v ./...\nINFO[0259] Taking snapshot of full filesystem...\nINFO[0265] Resolving 11667 paths\nINFO[0272] cmd: /bin/sh\nINFO[0272] args: [-c go get -d -v ./...]\nINFO[0272] Running: [/bin/sh -c go get -d -v ./...]\nINFO[0272] Taking snapshot of full filesystem...\nINFO[0275] Resolving 11667 paths\nINFO[0280] RUN go install -v ./...\nINFO[0280] cmd: /bin/sh\nINFO[0280] args: [-c go install -v ./...]\nINFO[0280] Running: [/bin/sh -c go install -v ./...]\napp\nINFO[0281] Taking snapshot of full filesystem...\nINFO[0284] Resolving 11666 paths\nINFO[0288] CMD [\"app\"]\n$ kubectl get taskrun\nNAME             SUCCEEDED   REASON      STARTTIME   COMPLETIONTIME\nbuild-and-push   True        Succeeded   15m         2m24s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 TaskRun \u4efb\u52a1\u5df2\u7ecf\u6267\u884c\u6210\u529f\u4e86\u3002 \u8fd9\u4e2a\u65f6\u5019\u5176\u5b9e\u6211\u4eec\u53ef\u4ee5\u5728 Docker Hub \u4e0a\u627e\u5230\u6211\u4eec\u7684\u955c\u50cf\u4e86\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u955c\u50cf\u8fdb\u884c\u6d4b\u8bd5\uff1a </p>"},{"location":"kubernetes_devops/token/#_6","title":"\u521b\u5efa\u6d41\u6c34\u7ebf","text":"<p>\u5230\u8fd9\u91cc\u524d\u9762\u6211\u4eec\u7684\u4e24\u4e2a\u4efb\u52a1 test \u548c build-and-push \u90fd\u5df2\u7ecf\u5b8c\u6210\u4e86\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u6d41\u6c34\u7ebf\u6765\u5c06\u8fd9\u4e24\u4e2a\u4efb\u52a1\u7ec4\u7ec7\u8d77\u6765\uff0c\u9996\u5148\u8fd0\u884c test \u4efb\u52a1\uff0c\u5982\u679c\u901a\u8fc7\u4e86\u518d\u6267\u884c\u540e\u9762\u7684 build-and-push \u8fd9\u4e2a\u4efb\u52a1\u3002</p> <p>\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>pipeline.yaml</code> \u7684\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: tekton.dev/v1beta1\nkind: Pipeline\nmetadata:\n  name: test-build-push\nspec:\n  resources:\n  - name: repo\n    type: git\n  tasks:\n  # \u8fd0\u884c\u5e94\u7528\u6d4b\u8bd5\n  - name: test\n    taskRef:\n      name: test\n    resources:\n      inputs:\n      - name: repo      # Task \u8f93\u5165\u540d\u79f0 \n        resource: repo  # Pipeline \u8d44\u6e90\u540d\u79f0\n  # \u6784\u5efa\u5e76\u63a8\u9001 Docker \u955c\u50cf\n  - name: build-and-push\n    taskRef:\n      name: build-and-push\n    runAfter:\n    - test              # \u6d4b\u8bd5\u4efb\u52a1\u6267\u884c\u4e4b\u540e\n    resources:\n      inputs:\n      - name: repo      # Task \u8f93\u5165\u540d\u79f0 \n        resource: repo  # Pipeline \u8d44\u6e90\u540d\u79f0\n</code></pre> <p>\u9996\u5148\u6211\u4eec\u9700\u8981\u5b9a\u4e49\u6d41\u6c34\u7ebf\u9700\u8981\u54ea\u4e9b\u8d44\u6e90\uff0c\u53ef\u4ee5\u662f\u8f93\u5165\u6216\u8005\u8f93\u51fa\u7684\u8d44\u6e90\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u53ea\u6709\u4e00\u4e2a\u8f93\u5165\uff0c\u90a3\u5c31\u662f\u547d\u540d\u4e3a repo \u7684\u5e94\u7528\u7a0b\u5e8f\u6e90\u7801\u7684 GitHub \u4ed3\u5e93\u3002\u63a5\u4e0b\u6765\u5b9a\u4e49\u4efb\u52a1\uff0c\u6bcf\u4e2a\u4efb\u52a1\u90fd\u901a\u8fc7 taskRef \u8fdb\u884c\u5f15\u7528\uff0c\u5e76\u4f20\u9012\u4efb\u52a1\u9700\u8981\u7684\u8f93\u5165\u53c2\u6570\u3002</p> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f pipeline.yaml \npipeline.tekton.dev/test-build-push created\n</code></pre> <p>\u524d\u9762\u6211\u4eec\u63d0\u5230\u8fc7\u548c\u901a\u8fc7\u521b\u5efa TaskRun \u53bb\u89e6\u53d1 Task \u4efb\u52a1\u7c7b\u4f3c\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a <code>PipelineRun</code> \u5bf9\u8c61\u6765\u8fd0\u884c\u6d41\u6c34\u7ebf\u3002\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>pipelinerun.yaml</code> \u7684 PipelineRun \u5bf9\u8c61\u6765\u8fd0\u884c\u6d41\u6c34\u7ebf\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: tekton.dev/v1beta1\nkind: PipelineRun\nmetadata:\n  name: test-build-push-run\nspec:\n  serviceAccountName: build-sa\n  pipelineRef:\n    name: test-build-push\n  resources:\n  - name: repo\n    resourceRef:\n      name: cnych-tekton-example\n</code></pre> <p>\u5b9a\u4e49\u65b9\u5f0f\u548c TaskRun \u51e0\u4e4e\u4e00\u6837\uff0c\u901a\u8fc7 serviceAccountName \u5c5e\u6027\u6307\u5b9a ServiceAccount \u5bf9\u8c61\uff0c<code>pipelineRef</code> \u5173\u8054\u6d41\u6c34\u7ebf\u5bf9\u8c61\u3002\u540c\u6837\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\uff0c\u521b\u5efa\u540e\u5c31\u4f1a\u89e6\u53d1\u6211\u4eec\u7684\u6d41\u6c34\u7ebf\u4efb\u52a1\u4e86\uff1a</p> <pre><code>$ kubectl apply -f pipelinerun.yaml \npipelinerun.tekton.dev/test-build-push-run created\n$ kubectl get pods | grep test-build-push-run\ntest-build-push-run-build-and-push-xl7wp-pod-hdnbl   0/2     Completed   0          5m27s\ntest-build-push-run-test-4s6qh-pod-tkwzk             0/2     Completed   0          6m5s\n$ kubectl logs -f test-build-push-run-build-and-push-xl7wp-pod-hdnbl --all-containers\n{\"level\":\"info\",\"ts\":15889089442572,\"caller\":\"git/git.go:136\",\"msg\":\"Successfully cloned https://github.com/cnych/tekton-demo @ f840e0c390be9a1a6edad76abbde64e882047f05 (grafted, HEAD, origin/master) in path /workspace/repo\"}\n{\"level\":\"info\",\"ts\":15889089577377,\"caller\":\"git/git.go:177\",\"msg\":\"Successfully initialized and updated submodules in path /workspace/repo\"}\n{\"level\":\"info\",\"ts\":15889089469531,\"caller\":\"creds-init/main.go:44\",\"msg\":\"Credentials initialized.\"}\nINFO[0004] Retrieving image manifest golang:14-alpine\n......\napp\nINFO[0281] Taking snapshot of full filesystem...\nINFO[0287] Resolving 11666 paths\nINFO[0291] CMD [\"app\"]\n$ kubectl get taskrun |grep test-build-push-run\ntest-build-push-run-build-and-push-xl7wp   True        Succeeded   6m21s       65s\ntest-build-push-run-test-4s6qh             True        Succeeded   6m58s       6m21s\n</code></pre> <p>\u5230\u8fd9\u91cc\u8bc1\u660e\u6211\u4eec\u7684\u6d41\u6c34\u7ebf\u6267\u884c\u6210\u529f\u4e86\u3002\u6211\u4eec\u5c06 Tekton \u5b89\u88c5\u5728 Kubernetes \u96c6\u7fa4\u4e0a\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e2a Task\uff0c\u5e76\u901a\u8fc7 YAML \u6e05\u5355\u548c Tekton CLI \u521b\u5efa TaskRun \u5bf9\u5176\u8fdb\u884c\u4e86\u6d4b\u8bd5\u3002\u6211\u4eec\u521b\u5efa\u4e86\u7531\u4e24\u4e2a\u4efb\u52a1\u7ec4\u6210\u7684 Tektok \u6d41\u6c34\u7ebf\uff0c\u7b2c\u4e00\u4e2a\u4efb\u52a1\u662f\u4ece GitHub \u514b\u9686\u4ee3\u7801\u5e76\u8fd0\u884c\u5e94\u7528\u7a0b\u5e8f\u6d4b\u8bd5\uff0c\u7b2c\u4e8c\u4e2a\u4efb\u52a1\u662f\u6784\u5efa\u4e00\u4e2a Docker \u955c\u50cf\u5e76\u5c06\u5176\u63a8\u9001\u5230 Docker Hub \u4e0a\u3002\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 Tekton \u521b\u5efa CI/CD \u6d41\u6c34\u7ebf\u7684\u4e00\u4e2a\u7b80\u5355\u793a\u4f8b\uff0c\u4e0d\u8fc7\u8fd9\u4e2a\u793a\u4f8b\u8fd8\u6bd4\u8f83\u7b80\u5355\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u901a\u8fc7\u4e00\u4e2a\u7a0d\u5fae\u590d\u6742\u70b9\u7684\u5e94\u7528\u6765\u5b8c\u6210\u6211\u4eec\u524d\u9762\u7684 Jenkins \u6d41\u6c34\u7ebf\u3002</p>"},{"location":"kubernetes_devops/token/#_7","title":"\u89e6\u53d1\u5668\u548c\u4e8b\u4ef6\u76d1\u542c\u5668","text":"<p>\u4e0a\u9762\u6211\u4eec\u90fd\u662f\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a TaskRun \u6216\u8005\u4e00\u4e2a PipelineRun \u5bf9\u8c61\u6765\u89e6\u53d1\u4efb\u52a1\u3002\u4f46\u662f\u5728\u5b9e\u9645\u7684\u5de5\u4f5c\u4e2d\u66f4\u591a\u7684\u662f\u5f00\u53d1\u4eba\u5458\u63d0\u4ea4\u4ee3\u7801\u8fc7\u540e\u6765\u89e6\u53d1\u4efb\u52a1\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u7528\u5230 Tekton \u91cc\u9762\u7684 Triggers \u4e86\u3002</p> <p>Triggers \u540c\u6837\u901a\u8fc7\u4e0b\u9762\u7684\u51e0\u4e2a CRD \u5bf9\u8c61\u5bf9 Tekton \u8fdb\u884c\u4e86\u4e00\u4e9b\u6269\u5c55\uff1a</p> <ul> <li>TriggerTemplate: \u521b\u5efa\u8d44\u6e90\u7684\u6a21\u677f\uff0c\u6bd4\u5982\u7528\u6765\u521b\u5efa PipelineResource \u548c PipelineRun</li> <li>TriggerBinding: \u6821\u9a8c\u4e8b\u4ef6\u5e76\u63d0\u53d6\u76f8\u5173\u5b57\u6bb5\u5c5e\u6027</li> <li>ClusterTriggerBinding: \u548c TriggerBinding \u7c7b\u4f3c\uff0c\u53ea\u662f\u662f\u5168\u5c40\u7684</li> <li>EventListener: \u8fde\u63a5 TriggerBinding \u548c TriggerTemplate \u5230\u4e8b\u4ef6\u63a5\u6536\u5668\uff0c\u4f7f\u7528\u4ece\u5404\u4e2a TriggerBinding \u4e2d\u63d0\u53d6\u7684\u53c2\u6570\u6765\u521b\u5efa TriggerTemplate \u4e2d\u6307\u5b9a\u7684 resources\uff0c\u540c\u6837\u901a\u8fc7 <code>interceptor</code> \u5b57\u6bb5\u6765\u6307\u5b9a\u5916\u90e8\u670d\u52a1\u5bf9\u4e8b\u4ef6\u5c5e\u6027\u8fdb\u884c\u9884\u5904\u7406</li> </ul> <p></p> <p>\u540c\u6837\u8981\u4f7f\u7528 Tekton Triggers \u5c31\u9700\u8981\u5b89\u88c5\u5bf9\u5e94\u7684\u63a7\u5236\u5668\uff0c\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 tektoncd/triggers \u7684 GitHub \u4ed3\u5e93\u8bf4\u660e\u8fdb\u884c\u5b89\u88c5\uff0c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl apply --filename https://storage.googleapis.com/tekton-releases/triggers/latest/release.yaml\n</code></pre> <p>\u540c\u6837\u7531\u4e8e\u5b98\u65b9\u4f7f\u7528\u7684\u955c\u50cf\u662f <code>gcr</code> \u7684\u955c\u50cf\uff0c\u6240\u4ee5\u6b63\u5e38\u60c5\u51b5\u4e0b\u6211\u4eec\u662f\u83b7\u53d6\u4e0d\u5230\u7684\uff0c\u5982\u679c\u4f60\u7684\u96c6\u7fa4\u7531\u4e8e\u67d0\u4e9b\u539f\u56e0\u83b7\u53d6\u4e0d\u5230\u955c\u50cf\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u6211\u5df2\u7ecf\u5c06\u955c\u50cf\u66ff\u6362\u6210\u4e86 Docker Hub \u4e0a\u9762\u7684\u955c\u50cf\uff1a</p> <pre><code>$ kubectl apply -f https://www.qikqiak.com/k8strain/devops/manifests/tekton/trigger.yaml\n</code></pre> <p>\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u67e5\u770b Triggers \u7684\u76f8\u5173\u7ec4\u4ef6\u5b89\u88c5\u72b6\u6001\uff0c\u76f4\u5230\u90fd\u4e3a <code>Running</code> \u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods --namespace tekton-pipelines                                       \nNAME                                           READY   STATUS    RESTARTS   AGE\ntekton-dashboard-69656879d9-7bbkl              1/1     Running   0          2d6h\ntekton-pipelines-controller-67f4dc98d8-pgxrq   1/1     Running   0          22d\ntekton-pipelines-webhook-59df55445c-jw76v      1/1     Running   0          22d\ntekton-triggers-controller-779fc9f557-vj6xs    1/1     Running   0          17m\ntekton-triggers-webhook-c77f8dbd6-ctmlm        1/1     Running   0          17m\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6765\u5c06\u524d\u9762\u7684 Jenkins Pipeline \u6d41\u6c34\u7ebf\u8f6c\u6362\u6210\u4f7f\u7528 Tekton \u6765\u6784\u5efa\uff0c\u4ee3\u7801\u6211\u4eec\u5df2\u7ecf\u63a8\u9001\u5230\u4e86\u79c1\u6709\u4ed3\u5e93 GitLab\uff0c\u5730\u5740\u4e3a\uff1a</p> <pre><code>http://git.k8s.local/course/devops-demo.git\n</code></pre> <p>\u3002</p> <p>\u9996\u5148\u6211\u4eec\u9700\u8981\u5b8c\u6210\u89e6\u53d1\u5668\u7684\u914d\u7f6e\uff0c\u5f53\u6211\u4eec\u63d0\u4ea4\u6e90\u4ee3\u7801\u5230 GitLab \u7684\u65f6\u5019\uff0c\u9700\u8981\u89e6\u53d1 Tekton \u7684\u4efb\u52a1\u8fd0\u884c\u3002\u6240\u4ee5\u9996\u5148\u9700\u8981\u5b8c\u6210\u8fd9\u4e2a\u89e6\u53d1\u5668\u3002\u8fd9\u91cc\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>EventListener</code> \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u6765\u5b8c\u6210\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>gitlab-listener</code> \u7684 EventListener \u8d44\u6e90\u5bf9\u8c61\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a(gitlab-push-listener.yaml)</p> <pre><code>apiVersion: triggers.tekton.dev/v1alpha1\nkind: EventListener\nmetadata:\n  name: gitlab-listener\nspec:\n  serviceAccountName: tekton-triggers-gitlab-sa\n  triggers:\n  - name: gitlab-push-events-trigger\n    interceptors:\n    - gitlab:\n        secretRef:  # \u5f15\u7528 gitlab-secret \u7684 Secret \u5bf9\u8c61\u4e2d\u7684 secretToken \u7684\u503c\n          secretName: gitlab-secret \n          secretKey: secretToken\n        eventTypes:\n        - Push Hook  # \u53ea\u63a5\u6536 GitLab Push \u4e8b\u4ef6\n    bindings:\n    - name: gitlab-push-binding  # TriggerBinding \u5bf9\u8c61\n    template:\n      name: gitlab-echo-template  # TriggerTemplate \u5bf9\u8c61\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: el-gitlab-listener\nspec:\n  routes:\n  - match: Host(`tekton-trigger.k8s.local`)\n    kind: Rule\n    services:\n    - name: el-gitlab-listener  # \u5173\u8054 EventListener \u670d\u52a1\n      port: 8080\n</code></pre> <p>\u7531\u4e8e <code>EventListener</code> \u521b\u5efa\u5b8c\u6210\u540e\u4f1a\u751f\u6210\u4e00\u4e2a Listener \u7684\u670d\u52a1\uff0c\u7528\u6765\u5bf9\u5916\u66b4\u9732\u7528\u4e8e\u63a5\u6536\u4e8b\u4ef6\u54cd\u5e94\uff0c\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684\u5bf9\u8c61\u540d\u4e3a <code>gitlab-listener</code>\uff0c\u521b\u5efa\u5b8c\u6210\u540e\u4f1a\u751f\u6210\u4e00\u4e2a\u540d\u4e3a <code>el-gitlab-listener</code> \u7684 Service \u5bf9\u8c61\uff0c\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 IngressRoute \u5bf9\u8c61\u6765\u66b4\u9732\u8be5\u670d\u52a1\uff0c\u5f53\u7136\u76f4\u63a5\u4fee\u6539 Service \u4e3a NodePort \u7c7b\u578b\u4e5f\u53ef\u4ee5\uff0c\u5982\u679c GitLab \u4e5f\u5728\u96c6\u7fa4\u5185\u90e8\uff0c\u5f53\u7136\u6211\u4eec\u7528 Service \u7684 DNS \u5f62\u5f0f\u6765\u8bbf\u95ee <code>EventListener</code> \u5f53\u7136\u4e5f\u53ef\u4ee5\u3002</p> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u4e0a\u9762\u7684 <code>EventListener</code> \u5bf9\u8c61\u4e2d\u6211\u4eec\u6dfb\u52a0\u4e86 <code>interceptors</code> \u5c5e\u6027\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a\u5185\u7f6e\u7684 <code>gitlab</code> \u5c5e\u6027\u53ef\u4ee5\u7528\u6765\u914d\u7f6e GitLab \u76f8\u5173\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\u914d\u7f6e WebHook \u7684 <code>Secret Token</code>\uff0c\u53ef\u4ee5\u901a\u8fc7 Secret \u5bf9\u8c61\u5f15\u5165\u8fdb\u6765\uff1a</p> <pre><code>interceptors:\n- gitlab:\n    secretRef:  # \u5f15\u7528 gitlab-secret \u7684 Secret \u5bf9\u8c61\u4e2d\u7684 secretToken \u7684\u503c\n      secretName: gitlab-secret \n      secretKey: secretToken\n    eventTypes:\n    - Push Hook  # \u53ea\u63a5\u6536 GitLab Push \u4e8b\u4ef6\n</code></pre> <p>\u5bf9\u5e94\u7684 Secret \u8d44\u6e90\u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff0c\u4e00\u4e2a\u7528\u4e8e WebHook \u7684 <code>Secret Token</code>\uff0c\u53e6\u5916\u4e00\u4e2a\u662f\u7528\u4e8e GitLab \u767b\u5f55\u8ba4\u8bc1\u4f7f\u7528\u7684\uff1a(secret.yaml)</p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: gitlab-secret\ntype: Opaque\nstringData:\n  secretToken: \"1234567\"\n---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: gitlab-auth\n  annotations:\n    tekton.dev/git-0: http://git.k8s.local\ntype: kubernetes.io/basic-auth\nstringData:\n  username: myusername\n  password: mypassword\n</code></pre> <p>\u7531\u4e8e <code>EventListener</code> \u5bf9\u8c61\u9700\u8981\u8bbf\u95ee\u5176\u4ed6\u8d44\u6e90\u5bf9\u8c61\uff0c\u6240\u4ee5\u9700\u8981\u58f0\u660e RBAC\uff0c\u5982\u4e0b\u6240\u793a\uff1a\uff08rbac.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: tekton-triggers-gitlab-sa\nsecrets:\n- name: gitlab-secret\n- name: gitlab-auth\n---\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: tekton-triggers-gitlab-minimal\nrules:\n  # Permissions for every EventListener deployment to function\n  - apiGroups: [\"triggers.tekton.dev\"]\n    resources: [\"eventlisteners\", \"triggerbindings\", \"triggertemplates\"]\n    verbs: [\"get\"]\n  - apiGroups: [\"\"]\n    # secrets are only needed for Github/Gitlab interceptors, serviceaccounts only for per trigger authorization\n    resources: [\"configmaps\", \"secrets\", \"serviceaccounts\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n  # Permissions to create resources in associated TriggerTemplates\n  - apiGroups: [\"tekton.dev\"]\n    resources: [\"pipelineruns\", \"pipelineresources\", \"taskruns\"]\n    verbs: [\"create\"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: tekton-triggers-gitlab-binding\nsubjects:\n  - kind: ServiceAccount\n    name: tekton-triggers-gitlab-sa\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: tekton-triggers-gitlab-minimal\n</code></pre> <p>\u7136\u540e\u63a5\u4e0b\u6765\u5c31\u662f\u6700\u91cd\u8981\u7684 <code>TriggerBinding</code> \u548c <code>TriggerTemplate</code> \u5bf9\u8c61\u4e86\uff0c\u6211\u4eec\u5728\u4e0a\u9762\u7684 <code>EventListener</code> \u5bf9\u8c61\u4e2d\u5c06\u4e24\u4e2a\u5bf9\u8c61\u7ec4\u5408\u5728\u4e00\u8d77\uff1a</p> <pre><code>bindings:\n- name: gitlab-push-binding  # TriggerBinding \u5bf9\u8c61\ntemplate:\n  name: gitlab-echo-template  # TriggerTemplate \u5bf9\u8c61\n</code></pre> <p>\u8fd9\u6837\u5c31\u53ef\u4ee5\u5c06 <code>TriggerBinding</code> \u4e2d\u7684\u53c2\u6570\u4f20\u9012\u5230 <code>TriggerTemplate</code> \u5bf9\u8c61\u4e2d\u8fdb\u884c\u6a21\u677f\u5316\u3002\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 <code>TriggerBinding</code> \u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: triggers.tekton.dev/v1alpha1\nkind: TriggerBinding\nmetadata:\n  name: gitlab-push-binding\nspec:\n  params:\n  - name: gitrevision\n    value: $(body.checkout_sha)\n  - name: gitrepositoryurl\n    value: $(body.repository.git_http_url)\n</code></pre> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\u53c2\u6570\u7684\u503c\u6211\u4eec\u662f\u901a\u8fc7\u8bfb\u53d6 GitLab WebHook \u53d1\u9001\u8fc7\u6765\u7684\u6570\u636e\u503c\uff0c\u901a\u8fc7 <code>$()</code> \u5305\u88f9\u7684 JSONPath \u8868\u8fbe\u5f0f\u6765\u63d0\u53d6\u7684\uff0c\u5173\u4e8e\u8868\u8fbe\u5f0f\u7684\u66f4\u591a\u7528\u6cd5\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863\u8bf4\u660e\uff0c\u81f3\u4e8e\u80fd\u591f\u63d0\u53d6\u54ea\u4e9b\u53c2\u6570\u503c\uff0c\u5219\u53ef\u4ee5\u67e5\u770b WebHook \u7684\u8bf4\u660e\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u662f GitLab Webhook \u7684 Push Hook\uff0c\u5bf9\u5e94\u7684\u8bf7\u6c42\u4f53\u6570\u636e\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>{\n  \"object_kind\": \"push\",\n  \"before\": \"95790bf891e76fee5e1747ab589903a6a1f80f22\",\n  \"after\": \"da1560886d4f094c3e6c9ef40349f7d38b5d27d7\",\n  \"ref\": \"refs/heads/master\",\n  \"checkout_sha\": \"da1560886d4f094c3e6c9ef40349f7d38b5d27d7\",\n  \"user_id\": 4,\n  \"user_name\": \"John Smith\",\n  \"user_username\": \"jsmith\",\n  \"user_email\": \"john@example.com\",\n  \"user_avatar\": \"https://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=8://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=80\",\n  \"project_id\": 15,\n  \"project\":{\n    \"id\": 15,\n    \"name\":\"Diaspora\",\n    \"description\":\"\",\n    \"web_url\":\"http://example.com/mike/diaspora\",\n    \"avatar_url\":null,\n    \"git_ssh_url\":\"git@example.com:mike/diaspora.git\",\n    \"git_http_url\":\"http://example.com/mike/diaspora.git\",\n    \"namespace\":\"Mike\",\n    \"visibility_level\":0,\n    \"path_with_namespace\":\"mike/diaspora\",\n    \"default_branch\":\"master\",\n    \"homepage\":\"http://example.com/mike/diaspora\",\n    \"url\":\"git@example.com:mike/diaspora.git\",\n    \"ssh_url\":\"git@example.com:mike/diaspora.git\",\n    \"http_url\":\"http://example.com/mike/diaspora.git\"\n  },\n  \"repository\":{\n    \"name\": \"Diaspora\",\n    \"url\": \"git@example.com:mike/diaspora.git\",\n    \"description\": \"\",\n    \"homepage\": \"http://example.com/mike/diaspora\",\n    \"git_http_url\":\"http://example.com/mike/diaspora.git\",\n    \"git_ssh_url\":\"git@example.com:mike/diaspora.git\",\n    \"visibility_level\":0\n  },\n  \"commits\": [\n    {\n      \"id\": \"b6568db1bc1dcd7f8b4d5a946b0b91f9dacd7327\",\n      \"message\": \"Update Catalan translation to e38cb\\\\n\\\\nSee https://gitlab.com/gitlab-org/gitlab for more information\",\n      \"title\": \"Update Catalan translation to e38cb\",\n      \"timestamp\": \"2011-12-12T14:27:31+02:00\",\n      \"url\": \"http://example.com/mike/diaspora/commit/b6568db1bc1dcd7f8b4d5a946b0b91f9dacd7327\",\n      \"author\": {\n        \"name\": \"Jordi Mallach\",\n        \"email\": \"jordi@softcatala.org\"\n      },\n      \"added\": [\"CHANGELOG\"],\n      \"modified\": [\"app/controller/application.rb\"],\n      \"removed\": []\n    }\n  ],\n  \"total_commits_count\": 4\n}\n</code></pre> <p>\u8bf7\u6c42\u4f53\u4e2d\u7684\u4efb\u4f55\u5c5e\u6027\u90fd\u53ef\u4ee5\u63d0\u53d6\u51fa\u6765\uff0c\u4f5c\u4e3a <code>TriggerBinding</code> \u7684\u53c2\u6570\uff0c\u5982\u679c\u662f\u5176\u4ed6\u7684 Hook \u4e8b\u4ef6\uff0c\u5bf9\u5e94\u7684\u8bf7\u6c42\u4f53\u7ed3\u6784\u53ef\u4ee5\u67e5\u770b GitLab \u6587\u6863\u8bf4\u660e\u3002</p> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 <code>TriggerTemplate</code> \u5bf9\u8c61\u4e2d\u901a\u8fc7\u53c2\u6570\u6765\u8bfb\u53d6\u4e0a\u9762 <code>TriggerBinding</code> \u4e2d\u5b9a\u4e49\u7684\u53c2\u6570\u503c\u4e86\uff0c\u5b9a\u4e49\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 <code>TriggerTemplate</code> \u5bf9\u8c61\uff0c\u58f0\u660e\u4e00\u4e2a <code>TaskRun</code> \u7684\u6a21\u677f\uff0c\u5b9a\u4e49\u7684 Task \u4efb\u52a1\u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5728\u5bb9\u5668\u4e2d\u6253\u5370\u51fa\u4ee3\u7801\u7684\u76ee\u5f55\u7ed3\u6784\u5373\u53ef\uff1a</p> <pre><code>apiVersion: triggers.tekton.dev/v1alpha1\nkind: TriggerTemplate\nmetadata:\n  name: gitlab-echo-template\nspec:\n  params:  # \u5b9a\u4e49\u53c2\u6570\uff0c\u548c TriggerBinding \u4e2d\u7684\u4fdd\u6301\u4e00\u81f4\n  - name: gitrevision\n  - name: gitrepositoryurl\n  resourcetemplates:\n  - apiVersion: tekton.dev/v1alpha1\n    kind: TaskRun  # \u5b9a\u4e49 TaskRun \u6a21\u677f\n    metadata:\n      generateName: gitlab-run-  # TaskRun \u540d\u79f0\u524d\u7f00\n    spec:\n      serviceAccountName: tekton-triggers-gitlab-sa\n      taskSpec:  # Task \u4efb\u52a1\u58f0\u660e\n        inputs:\n          resources:  # \u5b9a\u4e49\u4e00\u4e2a\u540d\u4e3a source \u7684 git \u8f93\u5165\u8d44\u6e90\n          - name: source\n            type: git\n        steps:\n        - name: show-path\n          image: ubuntu  # \u5b9a\u4e49\u4e00\u4e2a\u6267\u884c\u6b65\u9aa4\uff0c\u5217\u51fa\u4ee3\u7801\u76ee\u5f55\u7ed3\u6784\n          script: |\n            #! /bin/bash\n            ls -la $(inputs.resources.source.path)\n      inputs:  # \u58f0\u660e\u5177\u4f53\u7684\u8f93\u5165\u8d44\u6e90\u53c2\u6570\n        resources:\n        - name: source  # \u548c Task \u4e2d\u7684\u8d44\u6e90\u540d\u4fdd\u6301\u4e00\u76f4\n          resourceSpec:  # \u8d44\u6e90\u58f0\u660e\n            type: git\n            params:\n            - name: revision\n              value: $(params.gitrevision)  # \u8bfb\u53d6\u53c2\u6570\u503c\n            - name: url\n              value: $(params.gitrepositoryurl)\n</code></pre> <p>\u5b9a\u4e49\u5b8c\u8fc7\u540e\uff0c\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u521b\u5efa\u5b8c\u6210\u540e\u4f1a\u81ea\u52a8\u751f\u6210 <code>EventListener</code> \u7684 Pod \u548c Service \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get svc -l eventlistener=gitlab-listener\nNAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nel-gitlab-listener   ClusterIP   1130   &lt;none&gt;        8080/TCP   91m\n$ kubectl get pod -l eventlistener=gitlab-listener\nNAME                                  READY   STATUS    RESTARTS   AGE\nel-gitlab-listener-6bff9b55bc-qdpjh   1/1     Running   0          91m\n$ kubectl get ingressroute\nNAME                 AGE\nel-gitlab-listener   74m\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u53ef\u4ee5\u5230 GitLab \u7684\u9879\u76ee\u4e2d\u914d\u7f6e WebHook\uff0c\u6ce8\u610f\u9700\u8981\u914d\u7f6e <code>Secret Token</code>\uff0c\u6211\u4eec\u5728\u4e0a\u9762\u7684 Secret \u5bf9\u8c61\u4e2d\u58f0\u660e\u8fc7\uff1a</p> <p></p> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6d4b\u8bd5\u4e0b\u8be5 WebHook \u7684 <code>Push events</code> \u4e8b\u4ef6\uff0c\u76f4\u63a5\u70b9\u51fb\u6d4b\u8bd5\u5373\u53ef\uff0c\u6b63\u5e38\u4f1a\u8fd4\u56de </p> <pre><code>Hook executed successfully: HTTP 201\n</code></pre> <p>\u7684\u63d0\u793a\u4fe1\u606f\uff0c\u8fd9\u4e2a\u65f6\u5019\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5c31\u4f1a\u51fa\u73b0\u5982\u4e0b\u6240\u793a\u7684\u4efb\u52a1 Pod\uff1a</p> <pre><code>$ kubectl get pod -l triggers.tekton.dev/eventlistener=gitlab-listener\nNAME                         READY   STATUS      RESTARTS   AGE\ngitlab-run-2jfcf-pod-8smb7   0/2     Completed   0          5m22s\n$ kubectl get taskrun -l triggers.tekton.dev/eventlistener=gitlab-listener\nNAME               SUCCEEDED   REASON      STARTTIME   COMPLETIONTIME\ngitlab-run-2jfcf   True        Succeeded   12h         12h\n$ kubectl logs -f gitlab-run-2jfcf-pod-8smb7 --all-containers\n{\"level\":\"info\",\"ts\":159071818466494,\"caller\":\"git/git.go:136\",\"msg\":\"Successfully cloned http://git.k8s.local/course/devops-demo.git @ e8b2dd4cac9bfaa79f1998215b4c3fd0e98ea84d (grafted, HEAD) in path /workspace/source\"}\n{\"level\":\"info\",\"ts\":159071819744687,\"caller\":\"git/git.go:177\",\"msg\":\"Successfully initialized and updated submodules in path /workspace/source\"}\n{\"level\":\"info\",\"ts\":159071798761587,\"caller\":\"creds-init/main.go:44\",\"msg\":\"Credentials initialized.\"}\ntotal 36\ndrwxr-xr-x 4 root root  136 May 29 10:08 .\ndrwxrwxrwx 3 root root   19 May 29 10:08 ..\ndrwxr-xr-x 8 root root 4096 May 29 10:08 .git\n-rw-r--r-- 1 root root  192 May 29 10:08 .gitignore\n-rw-r--r-- 1 root root  376 May 29 10:08 Dockerfile\n-rw-r--r-- 1 root root 4788 May 29 10:08 Jenkinsfile\n-rw-r--r-- 1 root root   42 May 29 10:08 README.md\n-rw-r--r-- 1 root root   97 May 29 10:08 go.mod\n-rw-r--r-- 1 root root 3370 May 29 10:08 go.sum\ndrwxr-xr-x 3 root root   96 May 29 10:08 helm\n-rw-r--r-- 1 root root  444 May 29 10:08 main.go\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u901a\u8fc7 GitLab \u7684 Push \u4e8b\u4ef6\u6765\u89e6\u53d1 Tekton \u7684\u4e00\u4e2a\u4efb\u52a1\u3002</p>"},{"location":"kubernetes_example/wordpress/","title":"\u5e94\u7528\u90e8\u7f72","text":""},{"location":"kubernetes_example/wordpress/#wordpress","title":"Wordpress \u793a\u4f8b","text":"<p>\u524d\u9762\u6211\u4eec\u57fa\u672c\u4e0a\u4e86\u89e3\u4e86 Kubernetes \u4e2d\u7684\u4e00\u4e9b\u5e38\u89c1\u8d44\u6e90\u5bf9\u8c61\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u7528\u4e00\u4e2a Wordpress \u793a\u4f8b\u6765\u5c3d\u53ef\u80fd\u5c06\u524d\u9762\u7684\u77e5\u8bc6\u70b9\u4e32\u8054\u8d77\u6765\uff0c\u6211\u4eec\u9700\u8981\u8fbe\u5230\u7684\u76ee\u7684\u662f\u8ba9 Wordpress \u5e94\u7528\u5177\u6709\u9ad8\u53ef\u7528\u3001\u6eda\u52a8\u66f4\u65b0\u7684\u8fc7\u7a0b\u4e2d\u4e0d\u80fd\u4e2d\u65ad\u670d\u52a1\u3001\u6570\u636e\u8981\u6301\u4e45\u5316\u4e0d\u80fd\u4e22\u5931\u3001\u5f53\u5e94\u7528\u8d1f\u8f7d\u592a\u9ad8\u7684\u65f6\u5019\u80fd\u591f\u81ea\u52a8\u8fdb\u884c\u6269\u5bb9\u3001\u5f53\u7136\u8fd8\u6709 HTTPS \u8bbf\u95ee\u7b49\u7b49\uff0c\u8fd9\u4e9b\u662f\u6211\u4eec\u7684\u5e94\u7528\u90e8\u7f72\u5230\u7ebf\u4e0a\u73af\u5883\u57fa\u672c\u4e0a\u8981\u5177\u5907\u7684\u4e00\u4e9b\u80fd\u529b\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u4e00\u6b65\u4e00\u6b65\u5b8c\u6210\u8fd9\u4e9b\u9700\u6c42\u3002</p>"},{"location":"kubernetes_example/wordpress/#_1","title":"\u539f\u7406","text":"<p>\u9996\u5148\u8981\u90e8\u7f72 Wordpress \u5e94\u7528\uff0c\u6211\u4eec\u80af\u5b9a\u9700\u8981\u77e5\u9053 Wordpress \u662f\u5982\u4f55\u8fd0\u884c\u8d77\u6765\u7684\uff0cWordpress \u662f\u4e00\u4e2a\u57fa\u4e8e PHP \u548c MySQL \u7684\u6d41\u884c\u7684\u5f00\u6e90\u5185\u5bb9\u7ba1\u7406\u7cfb\u7edf\uff0c\u62e5\u6709\u4e30\u5bcc\u7684\u63d2\u4ef6\u548c\u6a21\u677f\u7cfb\u7edf\u3002\u5230\u8fd9\u91cc\u6211\u4eec\u5e94\u8be5\u5c31\u6e05\u695a\u5e94\u8be5\u5982\u4f55\u53bb\u8fd0\u884c Wordpress \u4e86\uff0c\u4e00\u4e2a\u80fd\u591f\u89e3\u6790 PHP \u7684\u7a0b\u5e8f\uff0c\u548c MySQL \u6570\u636e\u5e93\u5c31\u53ef\u4ee5\u4e86\uff0c\u6211\u4eec\u8981\u60f3\u5728 Kubernetes \u7cfb\u7edf\u4e2d\u6765\u8fd0\u884c\uff0c\u80af\u5b9a\u9700\u8981\u4f7f\u7528\u5230 Docker \u955c\u50cf\u4e86\uff0c\u5bf9\u4e8e Wordpress \u5e94\u7528\u7a0b\u5e8f\u672c\u8eab\u5b98\u65b9\u63d0\u4f9b\u4e86\u955c\u50cf https://hub.docker.com/_/wordpress\uff0c\u4e5f\u7ed9\u51fa\u4e86\u8bf4\u660e\u5982\u4f55\u8fd0\u884c\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e00\u7cfb\u5217\u73af\u5883\u53d8\u91cf\u53bb\u6307\u5b9a MySQL \u6570\u636e\u5e93\u7684\u914d\u7f6e\uff0c\u53ea\u9700\u8981\u5c06\u8fd9\u4e9b\u53c2\u6570\u914d\u7f6e\u4e0a\u76f4\u63a5\u8fd0\u884c\u5373\u53ef\u3002\u6211\u4eec\u77e5\u9053 Wordpress \u5e94\u7528\u672c\u8eab\u4f1a\u9891\u7e41\u7684\u548c MySQL \u6570\u636e\u5e93\u8fdb\u884c\u4ea4\u4e92\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u5982\u679c\u5c06\u4e8c\u8005\u7528\u5bb9\u5668\u90e8\u7f72\u5728\u540c\u4e00\u4e2a Pod \u4e0b\u9762\u662f\u4e0d\u662f\u8981\u9ad8\u6548\u5f88\u591a\uff0c\u56e0\u4e3a\u4e00\u4e2a Pod \u4e0b\u9762\u7684\u6240\u6709\u5bb9\u5668\u662f\u5171\u4eab\u540c\u4e00\u4e2a network namespace \u7684\uff0c\u4e0b\u9762\u6211\u4eec\u5c31\u6765\u90e8\u7f72\u6211\u4eec\u7684\u5e94\u7528\uff0c\u5c06\u6211\u4eec\u7684\u5e94\u7528\u90fd\u90e8\u7f72\u5230 kube-example \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\uff0c\u6240\u4ee5\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\uff1a(namespace.yaml)</p> <pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\n  name: kube-example\n</code></pre> <p>\u7136\u540e\u7f16\u5199\u90e8\u7f72\u5230 Kubernetes \u4e0b\u9762\u7684\u8d44\u6e90\u6e05\u5355\uff1a(deployment.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: wordpress\n  namespace: kube-example\n  labels:\n    app: wordpress\nspec:\n  selector:\n    matchLabels:\n      app: wordpress\n  template:\n    metadata:\n      labels:\n        app: wordpress\n    spec:\n      containers:\n      - name: wordpress\n        image: wordpress:2-apache\n        ports:\n        - containerPort: 80\n          name: wdport\n        env:\n        - name: WORDPRESS_DB_HOST\n          value: localhost:3306\n        - name: WORDPRESS_DB_USER\n          value: wordpress\n        - name: WORDPRESS_DB_PASSWORD\n          value: wordpress\n      - name: mysql\n        image: mysql:7\n        imagePullPolicy: IfNotPresent\n        args:  # \u65b0\u7248\u672c\u955c\u50cf\u6709\u66f4\u65b0\uff0c\u9700\u8981\u4f7f\u7528\u4e0b\u9762\u7684\u8ba4\u8bc1\u63d2\u4ef6\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u624d\u4f1a\u751f\u6548\n        - --default_authentication_plugin=mysql_native_password\n        - --character-set-server=utf8mb4\n        - --collation-server=utf8mb4_unicode_ci\n        ports:\n        - containerPort: 3306\n          name: dbport\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          value: rootPassW0rd\n        - name: MYSQL_DATABASE\n          value: wordpress\n        - name: MYSQL_USER\n          value: wordpress\n        - name: MYSQL_PASSWORD\n          value: wordpress\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc MySQL \u548c Wordpress \u5728\u540c\u4e00\u4e2a Pod \u4e0b\u9762\uff0c\u6240\u4ee5\u5728 Wordpress \u4e2d\u6211\u4eec\u6307\u5b9a\u6570\u636e\u5e93\u5730\u5740\u7684\u65f6\u5019\u662f\u7528\u7684 <code>localhost:3306</code>\uff0c\u56e0\u4e3a\u8fd9\u4e24\u4e2a\u5bb9\u5668\u5df2\u7ecf\u5171\u4eab\u540c\u4e00\u4e2a network namespace \u4e86\uff0c\u8fd9\u70b9\u5f88\u91cd\u8981\uff0c\u7136\u540e\u5982\u679c\u6211\u4eec\u8981\u60f3\u628a\u8fd9\u4e2a\u670d\u52a1\u66b4\u9732\u7ed9\u5916\u90e8\u7528\u6237\u8fd8\u5f97\u521b\u5efa\u4e00\u4e2a Service \u6216\u8005 Ingress \u5bf9\u8c61\uff0c\u8fd9\u91cc\u6211\u4eec\u4e00\u6b65\u4e00\u6b65\u6765\uff0c\u6682\u65f6\u5148\u521b\u5efa\u4e00\u4e2a NodePort \u7c7b\u578b\u7684 Service\uff1a(service.yaml)</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: wordpress\n  namespace: kube-example\nspec:\n  selector:\n    app: wordpress\n  type: NodePort\n  ports:\n  - name: web\n    port: 80\n    targetPort: wdport\n</code></pre> <p>\u56e0\u4e3a\u53ea\u9700\u8981\u66b4\u9732 Wordpress \u8fd9\u4e2a\u5e94\u7528\uff0c\u6240\u4ee5\u53ea\u5339\u914d\u4e86\u4e00\u4e2a\u540d\u4e3a <code>wdport</code> \u7684\u7aef\u53e3\uff0c\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e0a\u9762\u7684\u51e0\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f namespace.yaml\n$ kubectl apply -f deployment.yaml\n$ kubectl apply -f service.yaml\n</code></pre> <p>\u63a5\u4e0b\u6765\u5c31\u662f\u7b49\u5f85\u62c9\u53d6\u955c\u50cf\uff0c\u542f\u52a8 Pod:</p> <pre><code>$ kubectl get pods -n kube-example\nNAME                         READY   STATUS    RESTARTS   AGE\nwordpress-77dcdb64c6-zdlb8   2/2     Running   0          12m\n$ kubectl get svc -n kube-example\nNAME        TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\nwordpress   NodePort   12157   &lt;none&gt;        80:30892/TCP   2m2s\n</code></pre> <p>\u5f53 Pod \u542f\u52a8\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u7684 </p> <pre><code>http://&lt;\u4efb\u610f\u8282\u70b9IP&gt;:30892\n</code></pre> <p>\u8fd9\u4e2a NodePort \u7aef\u53e3\u6765\u8bbf\u95ee\u5e94\u7528\u4e86\u3002\u6211\u4eec\u4ed4\u7ec6\u60f3\u4e00\u60f3\u8fd9\u4e00\u79cd\u65b9\u5f0f\u6709\u4ec0\u4e48\u95ee\u9898\uff1f\u9996\u5148\u4e00\u4e2a Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u5e76\u6ca1\u6709\u542f\u52a8\u7684\u5148\u540e\u987a\u5e8f\uff0c\u6240\u4ee5\u5f88\u6709\u53ef\u80fd\u5f53 wordpress \u8fd9\u4e2a\u5bb9\u5668\u542f\u52a8\u8d77\u6765\u53bb\u8fde\u63a5 mysql \u8fd9\u4e2a\u5bb9\u5668\u7684\u65f6\u5019\uff0cmysql \u8fd8\u6ca1\u6709\u542f\u52a8\u8d77\u6765\uff1b\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\u662f\u73b0\u5728\u6211\u4eec\u7684\u5e94\u7528\u662f\u4e0d\u662f\u53ea\u6709\u4e00\u4e2a\u526f\u672c\uff1f\u4f1a\u6709\u5355\u70b9\u95ee\u9898\uff0c\u5e94\u7528\u7684\u6027\u80fd\u4e5f\u662f\u4e00\u4e2a\u95ee\u9898\uff0c\u7531\u4e8e Wordpress \u5e94\u7528\u672c\u8eab\u662f\u65e0\u72b6\u6001\u5e94\u7528\uff0c\u6240\u4ee5\u8fd9\u79cd\u60c5\u51b5\u4e0b\u4e00\u822c\u6211\u4eec\u53ea\u9700\u8981\u591a\u90e8\u7f72\u51e0\u4e2a\u526f\u672c\u5373\u53ef\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u5728 Deployment \u7684 YAML \u6587\u4ef6\u4e2d\u52a0\u4e0a <code>replicas:3</code> \u8fd9\u4e2a\u5c5e\u6027\uff0c\u8fd9\u4e2a\u65f6\u5019\u6709\u4e00\u4e2a\u4ec0\u4e48\u95ee\u9898\u5462\uff1f\u7531\u4e8e MySQL \u662f\u6709\u72b6\u6001\u5e94\u7528\uff0c\u6bcf\u4e00\u4e2a Pod \u91cc\u9762\u7684\u6570\u636e\u5e93\u7684\u6570\u636e\u90fd\u662f\u72ec\u7acb\u7684\uff0c\u4ed6\u4eec\u5e76\u6ca1\u6709\u5171\u4eab\uff0c\u4e5f\u5c31\u662f\u8bf4\u8fd93\u4e2a Pod \u76f8\u5f53\u4e8e\u662f\u72ec\u7acb\u76843\u4e2a Wordpress \u5b9e\u4f8b\uff0c\u6240\u4ee5\u5e94\u8be5\u600e\u4e48\u529e\u5462\uff1f\u62c6\u5206\uff0c\u628a Wordpress \u548c MySQL \u8fd9\u4e24\u4e2a\u5bb9\u5668\u90e8\u7f72\u6210\u72ec\u7acb\u7684 Pod \u5c31\u53ef\u4ee5\u4e86\uff0c\u8fd9\u6837\u6211\u4eec\u53ea\u9700\u8981\u5bf9 Wordpress \u5e94\u7528\u589e\u52a0\u526f\u672c\uff0c\u800c\u6570\u636e\u5e93 MySQL \u8fd8\u662f\u4e00\u4e2a\u5b9e\u4f8b\uff0c\u6240\u6709\u7684\u5e94\u7528\u90fd\u8fde\u63a5\u5230\u8fd9\u4e00\u4e2a\u6570\u636e\u5e93\u4e0a\u9762\uff0c\u662f\u4e0d\u662f\u5c31\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u4e86\u3002</p>"},{"location":"kubernetes_example/wordpress/#_2","title":"\u9ad8\u53ef\u7528","text":"<p>\u73b0\u5728\u6211\u4eec\u5c06 Pod \u4e2d\u7684\u4e24\u4e2a\u5bb9\u5668\u8fdb\u884c\u62c6\u5206\uff0c\u5c06 Wordpress \u548c MySQL \u5206\u522b\u90e8\u7f72\uff0c\u7136\u540e Wordpress \u7528\u591a\u4e2a\u526f\u672c\u8fdb\u884c\u90e8\u7f72\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5e94\u7528\u7684\u9ad8\u53ef\u7528\u4e86\uff0c\u7531\u4e8e MySQL \u662f\u6709\u72b6\u6001\u5e94\u7528\uff0c\u4e00\u822c\u6765\u8bf4\u9700\u8981\u7528 StatefulSet \u6765\u8fdb\u884c\u7ba1\u7406\uff0c\u4f46\u662f\u6211\u4eec\u8fd9\u91cc\u90e8\u7f72\u7684 MySQL \u5e76\u4e0d\u662f\u96c6\u7fa4\u6a21\u5f0f\uff0c\u800c\u662f\u5355\u526f\u672c\u7684\uff0c\u6240\u4ee5\u7528 Deployment \u4e5f\u662f\u6ca1\u6709\u95ee\u9898\u7684\uff0c\u5f53\u7136\u5982\u679c\u8981\u771f\u6b63\u7528\u4e8e\u751f\u4ea7\u73af\u5883\u8fd8\u662f\u9700\u8981\u96c6\u7fa4\u6a21\u5f0f\u7684\uff1a\uff08mysql.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: wordpress-mysql\n  namespace: kube-example\n  labels:\n    app: wordpress\nspec:\n  ports:\n  - port: 3306\n    targetPort: dbport\n  selector:\n    app: wordpress\n    tier: mysql\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: wordpress-mysql\n  namespace: kube-example\n  labels:\n    app: wordpress\n    tier: mysql\nspec:\n  selector:\n    matchLabels:\n      app: wordpress\n      tier: mysql\n  template:\n    metadata:\n      labels:\n        app: wordpress\n        tier: mysql\n    spec:\n      containers:\n      - name: mysql\n        image: mysql:7\n        imagePullPolicy: IfNotPresent\n        args:  # \u65b0\u7248\u672c\u955c\u50cf\u6709\u66f4\u65b0\uff0c\u9700\u8981\u4f7f\u7528\u4e0b\u9762\u7684\u8ba4\u8bc1\u63d2\u4ef6\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u624d\u4f1a\u751f\u6548\n        - --default_authentication_plugin=mysql_native_password\n        - --character-set-server=utf8mb4\n        - --collation-server=utf8mb4_unicode_ci\n        ports:\n        - containerPort: 3306\n          name: dbport\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          value: rootPassW0rd\n        - name: MYSQL_DATABASE\n          value: wordpress\n        - name: MYSQL_USER\n          value: wordpress\n        - name: MYSQL_PASSWORD\n          value: wordpress\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u7ed9 MySQL \u5e94\u7528\u6dfb\u52a0\u4e86\u4e00\u4e2a Service \u5bf9\u8c61\uff0c\u662f\u56e0\u4e3a Wordpress \u5e94\u7528\u9700\u8981\u6765\u8fde\u63a5\u6570\u636e\u5e93\uff0c\u4e4b\u524d\u5728\u540c\u4e00\u4e2a Pod \u4e2d\u7528 <code>localhost</code> \u5373\u53ef\uff0c\u73b0\u5728\u9700\u8981\u901a\u8fc7 Service \u7684 DNS \u5f62\u5f0f\u7684\u57df\u540d\u8fdb\u884c\u8fde\u63a5\u3002\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f mysql.yaml    \nservice/wordpress-mysql created\ndeployment.apps/wordpress-mysql created\n</code></pre> <p>\u63a5\u4e0b\u6765\u521b\u5efa\u72ec\u7acb\u7684 Wordpress \u670d\u52a1\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u5bf9\u8c61\u5982\u4e0b\uff1a\uff08wordpress.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: wordpress\n  namespace: kube-example\n  labels:\n    app: wordpress\nspec:\n  selector:\n    app: wordpress\n    tier: frontend\n  type: NodePort\n  ports:\n  - name: web\n    port: 80\n    targetPort: wdport\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: wordpress\n  namespace: kube-example\n  labels:\n    app: wordpress\n    tier: frontend\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: wordpress\n      tier: frontend\n  template:\n    metadata:\n      labels:\n        app: wordpress\n        tier: frontend\n    spec:\n      containers:\n      - name: wordpress\n        image: wordpress:2-apache\n        ports:\n        - containerPort: 80\n          name: wdport\n        env:\n        - name: WORDPRESS_DB_HOST\n          value: wordpress-mysql:3306\n        - name: WORDPRESS_DB_USER\n          value: wordpress\n        - name: WORDPRESS_DB_PASSWORD\n          value: wordpress\n</code></pre> <p>\u6ce8\u610f\u8fd9\u91cc\u7684\u73af\u5883\u53d8\u91cf <code>WORDPRESS_DB_HOST</code> \u7684\u503c\u5c06\u4e4b\u524d\u7684 <code>localhost</code> \u5730\u5740\u66f4\u6539\u6210\u4e86\u4e0a\u9762 MySQL \u670d\u52a1\u7684 DNS \u5730\u5740\uff0c\u5b8c\u6574\u7684\u57df\u540d\u5e94\u8be5\u662f </p> <pre><code>wordpress-mysql.kube-example.svc.cluster.local:3306\n</code></pre> <p>\uff0c\u7531\u4e8e\u8fd9\u4e24\u4e2a\u5e94\u8be5\u90fd\u5904\u4e8e\u540c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u6240\u4ee5\u76f4\u63a5\u7b80\u5199\u6210 <code>wordpress-mysql:3306</code> \u4e5f\u662f\u53ef\u4ee5\u7684\u3002\u521b\u5efa\u4e0a\u9762\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f wordpress.yaml \nservice/wordpress created\ndeployment.apps/wordpress created\n$ kubectl get pods -l app=wordpress -n kube-example\nNAME                              READY   STATUS              RESTARTS   AGE\nwordpress-6554f9f96c-24rl7        0/1     ContainerCreating   0          6m12s\nwordpress-6554f9f96c-4qm5c        1/1     Running             0          6m12s\nwordpress-6554f9f96c-wsjhh        0/1     ContainerCreating   0          6m12s\nwordpress-mysql-8bbc78ddc-l4c28   1/1     Running             0          13m\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u90fd\u5df2\u7ecf\u662f <code>Running</code> \u72b6\u6001\u4e86\uff0c\u7136\u540e\u6211\u4eec\u9700\u8981\u600e\u4e48\u6765\u9a8c\u8bc1\u5462\uff1f\u662f\u4e0d\u662f\u6211\u4eec\u80fd\u60f3\u5230\u7684\u5c31\u662f\u53bb\u8bbf\u95ee\u4e0b\u6211\u4eec\u7684 Wordpress \u670d\u52a1\u5c31\u53ef\u4ee5\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u662f\u4f7f\u7528\u7684\u4e00\u4e2a NodePort \u7c7b\u578b\u7684 Service \u6765\u66b4\u9732\u670d\u52a1\uff1a</p> <pre><code>$ kubectl get svc -l app=wordpress -n kube-example\nNAME              TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE\nwordpress         NodePort    186   &lt;none&gt;        80:30012/TCP   8m15s\nwordpress-mysql   ClusterIP   1168   &lt;none&gt;        3306/TCP       15m\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 wordpress \u670d\u52a1\u4ea7\u751f\u4e86\u4e00\u4e2a 30012 \u7684\u7aef\u53e3\uff0c\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>http://&lt;\u4efb\u610f\u8282\u70b9\u7684NodeIP&gt;:30012\n</code></pre> <p>\u8bbf\u95ee\u6211\u4eec\u7684\u5e94\u7528\u4e86\uff0c\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\uff0c\u5982\u679c\u770b\u5230 wordpress \u8df3\u8f6c\u5230\u4e86\u5b89\u88c5\u9875\u9762\uff0c\u8bc1\u660e\u6211\u4eec\u7684\u5b89\u88c5\u662f\u6b63\u786e\u7684\uff0c\u5982\u679c\u6ca1\u6709\u51fa\u73b0\u9884\u671f\u7684\u6548\u679c\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u53bb\u67e5\u770b\u4e0b Pod \u7684\u65e5\u5fd7\u6765\u6392\u67e5\u95ee\u9898\u4e86\uff0c\u6839\u636e\u9875\u9762\u63d0\u793a\uff0c\u586b\u4e0a\u5bf9\u5e94\u7684\u4fe1\u606f\uff0c\u70b9\u51fb<code>\u5b89\u88c5</code>\u5373\u53ef\uff0c\u6700\u7ec8\u5b89\u88c5\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u5230\u719f\u6089\u7684\u9996\u9875\u754c\u9762\u4e86\uff1a</p> <p></p>"},{"location":"kubernetes_example/wordpress/#_3","title":"\u7a33\u5b9a\u6027","text":"<p>\u73b0\u5728 Wodpress \u5e94\u7528\u5df2\u7ecf\u90e8\u7f72\u6210\u529f\u4e86\uff0c\u90a3\u4e48\u5c31\u4e07\u4e8b\u5927\u5409\u4e86\u5417\uff1f\u5982\u679c\u6211\u4eec\u7684\u7f51\u7ad9\u8bbf\u95ee\u91cf\u7a81\u7136\u53d8\u5927\u4e86\u600e\u4e48\u529e\uff0c\u5982\u679c\u6211\u4eec\u8981\u66f4\u65b0\u6211\u4eec\u7684\u955c\u50cf\u8be5\u600e\u4e48\u529e\uff1f\u6240\u4ee5\u8981\u4fdd\u8bc1\u6211\u4eec\u7684\u7f51\u7ad9\u80fd\u591f\u975e\u5e38\u7a33\u5b9a\u7684\u63d0\u4f9b\u670d\u52a1\uff0c\u6211\u4eec\u505a\u5f97\u8fd8\u4e0d\u591f\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u505a\u4e9b\u4ec0\u4e48\u4e8b\u60c5\u6765\u63d0\u9ad8\u7f51\u7ad9\u7684\u7a33\u5b9a\u6027\u5462\uff1f</p>"},{"location":"kubernetes_example/wordpress/#_4","title":"\u907f\u514d\u5355\u70b9\u6545\u969c","text":"<p>\u4e3a\u4ec0\u4e48\u4f1a\u6709\u5355\u70b9\u6545\u969c\u7684\u95ee\u9898\u5462\uff1f\u6211\u4eec\u4e0d\u662f\u90e8\u7f72\u4e86\u591a\u4e2a\u526f\u672c\u7684 Wordpress \u5e94\u7528\u5417\uff1f\u5f53\u6211\u4eec\u8bbe\u7f6e <code>replicas=1</code> \u7684\u65f6\u5019\u80af\u5b9a\u4f1a\u5b58\u5728\u5355\u70b9\u6545\u969c\u95ee\u9898\uff0c\u5982\u679c\u5927\u4e8e 1 \u4f46\u662f\u6240\u6709\u526f\u672c\u90fd\u8c03\u5ea6\u5230\u4e86\u540c\u4e00\u4e2a\u8282\u70b9\u7684\u662f\u4e0d\u662f\u540c\u6837\u5c31\u4f1a\u5b58\u5728\u5355\u70b9\u95ee\u9898\u4e86\uff0c\u8fd9\u4e2a\u8282\u70b9\u6302\u4e86\u6240\u6709\u526f\u672c\u5c31\u90fd\u6302\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u4ec5\u9700\u8981\u8bbe\u7f6e\u591a\u4e2a\u526f\u672c\u6570\u91cf\uff0c\u8fd8\u9700\u8981\u8ba9\u8fd9\u4e9b\u526f\u672c\u8c03\u5ea6\u5230\u4e0d\u540c\u7684\u8282\u70b9\u4e0a\uff0c\u6765\u6253\u6563\u907f\u514d\u5355\u70b9\u6545\u969c\uff0c\u8fd9\u4e2a\u5229\u7528 Pod \u53cd\u4eb2\u548c\u6027\u6765\u5b9e\u73b0\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u52a0\u4e0a\u5982\u4e0b\u6240\u793a\u7684\u914d\u7f6e\uff1a</p> <pre><code>affinity:\n  podAntiAffinity:\n    preferredDuringSchedulingIgnoredDuringExecution:  # \u8f6f\u7b56\u7565\n    - weight: 1\n      podAffinityTerm:\n        topologyKey: kubernetes.io/hostname\n        labelSelector:\n          matchExpressions:\n          - key: app\n            operator: In\n            values:\n            - wordpress\n</code></pre> <p>\u8fd9\u91cc\u7684\u610f\u601d\u5c31\u662f\u5982\u679c\u4e00\u4e2a\u8282\u70b9\u4e0a\u9762\u6709 <code>app=wordpress</code> \u8fd9\u6837\u7684 Pod \u7684\u8bdd\uff0c\u90a3\u4e48\u6211\u4eec\u7684 Pod \u5c31\u5c3d\u53ef\u80fd\u522b\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9\u4e0a\u9762\u6765\uff0c\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u7684\u8282\u70b9\u5e76\u4e0d\u591a\uff0c\u6240\u4ee5\u6211\u4f7f\u7528\u7684\u662f\u8f6f\u7b56\u7565\uff0c\u56e0\u4e3a\u5982\u679c\u4f7f\u7528\u786c\u7b56\u7565\u7684\u8bdd\uff0c\u5982\u679c\u5e94\u7528\u526f\u672c\u6570\u8d85\u8fc7\u4e86\u8282\u70b9\u6570\u5c31\u5fc5\u7136\u4f1a\u6709 Pod \u8c03\u5ea6\u4e0d\u6210\u529f\uff0c\u5982\u679c\u4f60\u7ebf\u4e0a\u8282\u70b9\u975e\u5e38\u591a\u7684\u8bdd\uff08\u8282\u70b9\u6570\u5927\u4e8e Pod \u526f\u672c\u6570\uff09\uff0c\u5efa\u8bae\u4f7f\u7528\u786c\u7b56\u7565\uff0c\u66f4\u65b0\u540e\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e0b 3 \u4e2a\u526f\u672c\u88ab\u5206\u6563\u5728\u4e86\u4e0d\u540c\u7684\u8282\u70b9\u4e0a\u3002</p>"},{"location":"kubernetes_example/wordpress/#pdb","title":"\u4f7f\u7528 PDB","text":"<p>\u6709\u4e9b\u65f6\u5019\u7ebf\u4e0a\u7684\u67d0\u4e9b\u8282\u70b9\u9700\u8981\u505a\u4e00\u4e9b\u7ef4\u62a4\u64cd\u4f5c\uff0c\u6bd4\u5982\u8981\u5347\u7ea7\u5185\u6838\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u5c06\u8981\u7ef4\u62a4\u7684\u8282\u70b9\u8fdb\u884c\u9a71\u9010\u64cd\u4f5c\uff0c\u9a71\u9010\u8282\u70b9\u9996\u5148\u662f\u5c06\u8282\u70b9\u8bbe\u7f6e\u4e3a\u4e0d\u53ef\u8c03\u5ea6\uff0c\u8fd9\u6837\u53ef\u4ee5\u907f\u514d\u6709\u65b0\u7684 Pod \u8c03\u5ea6\u4e0a\u6765\uff0c\u7136\u540e\u5c06\u8be5\u8282\u70b9\u4e0a\u7684 Pod \u5168\u90e8\u5220\u9664\uff0cReplicaSet \u63a7\u5236\u5668\u68c0\u6d4b\u5230 Pod \u6570\u91cf\u51cf\u5c11\u4e86\u5c31\u4f1a\u91cd\u65b0\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u8c03\u5ea6\u5230\u5176\u4ed6\u8282\u70b9\u4e0a\u9762\u7684\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u662f\u5148\u5220\u9664\uff0c\u518d\u521b\u5efa\uff0c\u5e76\u975e\u662f\u6eda\u52a8\u66f4\u65b0\uff0c\u56e0\u6b64\u66f4\u65b0\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u4e00\u4e2a\u670d\u52a1\u7684\u6240\u6709\u526f\u672c\u90fd\u5728\u88ab\u9a71\u9010\u7684\u8282\u70b9\u4e0a\uff0c\u5219\u53ef\u80fd\u5bfc\u81f4\u8be5\u670d\u52a1\u4e0d\u53ef\u7528\u3002</p> <p>\u5982\u679c\u670d\u52a1\u672c\u8eab\u5b58\u5728\u5355\u70b9\u6545\u969c\uff0c\u6240\u6709\u526f\u672c\u90fd\u5728\u540c\u4e00\u4e2a\u8282\u70b9\uff0c\u9a71\u9010\u7684\u65f6\u5019\u80af\u5b9a\u5c31\u4f1a\u9020\u6210\u670d\u52a1\u4e0d\u53ef\u7528\u4e86\uff0c\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u4f7f\u7528\u4e0a\u9762\u7684\u53cd\u4eb2\u548c\u6027\u548c\u591a\u526f\u672c\u5c31\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002\u4f46\u662f\u5982\u679c\u6211\u4eec\u7684\u670d\u52a1\u672c\u8eab\u5c31\u88ab\u6253\u6563\u5728\u591a\u4e2a\u8282\u70b9\u4e0a\uff0c\u8fd9\u4e9b\u8282\u70b9\u5982\u679c\u90fd\u88ab\u540c\u65f6\u9a71\u9010\u7684\u8bdd\uff0c\u90a3\u4e48\u8fd9\u4e2a\u670d\u52a1\u7684\u6240\u6709\u5b9e\u4f8b\u90fd\u4f1a\u88ab\u540c\u65f6\u5220\u9664\uff0c\u8fd9\u4e2a\u65f6\u5019\u4e5f\u4f1a\u9020\u6210\u670d\u52a1\u4e0d\u53ef\u7528\u4e86\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e PDB\uff08PodDisruptionBudget\uff09\u5bf9\u8c61\u6765\u907f\u514d\u6240\u6709\u526f\u672c\u540c\u65f6\u88ab\u5220\u9664\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u8bbe\u7f6e\u5728\u9a71\u9010\u7684\u65f6\u5019 wordpress \u5e94\u7528\u6700\u591a\u53ea\u6709\u4e00\u4e2a\u526f\u672c\u4e0d\u53ef\u7528\uff0c\u5176\u5b9e\u5c31\u76f8\u5f53\u4e8e\u9010\u4e2a\u5220\u9664\u5e76\u5728\u5176\u5b83\u8282\u70b9\u4e0a\u91cd\u5efa\uff1a\uff08pdb.yaml\uff09</p> <pre><code>apiVersion: policy/v1beta1\nkind: PodDisruptionBudget\nmetadata:\n  name: wordpress-pdb\n  namespace: kube-example\nspec:\n  maxUnavailable: 1\n  selector:\n    matchLabels:\n      app: wordpress\n      tier: frontend\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f pdb.yaml \npoddisruptionbudget.policy/wordpress-pdb created\n$ kubectl get pdb -n kube-example\nNAME            MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE\nwordpress-pdb   N/A             1                 1                     10s\n</code></pre> <p>\u5173\u4e8e PDB \u7684\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863\uff1ahttps://kubernetes.io/docs/tasks/run-application/configure-pdb/\u3002</p>"},{"location":"kubernetes_example/wordpress/#_5","title":"\u5065\u5eb7\u68c0\u67e5","text":"<p>\u6211\u4eec\u7684\u5e94\u7528\u73b0\u5728\u8fd8\u6709\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u529f\u80fd\u6ca1\u6709\u63d0\u4f9b\uff0c\u90a3\u5c31\u662f\u5065\u5eb7\u68c0\u67e5\uff0c\u6211\u4eec\u77e5\u9053\u5065\u5eb7\u68c0\u67e5\u662f\u63d0\u9ad8\u5e94\u7528\u5065\u58ee\u6027\u975e\u5e38\u91cd\u8981\u7684\u624b\u6bb5\uff0c\u5f53\u6211\u4eec\u68c0\u6d4b\u5230\u5e94\u7528\u4e0d\u5065\u5eb7\u7684\u65f6\u5019\u6211\u4eec\u5e0c\u671b\u53ef\u4ee5\u81ea\u52a8\u91cd\u542f\u5bb9\u5668\uff0c\u5f53\u5e94\u7528\u8fd8\u6ca1\u6709\u51c6\u5907\u597d\u7684\u65f6\u5019\u6211\u4eec\u4e5f\u5e0c\u671b\u6682\u65f6\u4e0d\u8981\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u6dfb\u52a0\u6211\u4eec\u524d\u9762\u7ecf\u5e38\u63d0\u5230\u7684 <code>liveness probe</code> \u548c <code>rediness probe</code> \u4e24\u4e2a\u5065\u5eb7\u68c0\u6d4b\u63a2\u9488\uff0c\u68c0\u67e5\u63a2\u9488\u7684\u65b9\u5f0f\u6709\u5f88\u591a\uff0c\u6211\u4eec\u8fd9\u91cc\u5f53\u7136\u53ef\u4ee5\u8ba4\u4e3a\u5982\u679c\u5bb9\u5668\u7684 80 \u7aef\u53e3\u53ef\u4ee5\u6210\u529f\u8bbf\u95ee\u90a3\u4e48\u5c31\u662f\u5065\u5eb7\u7684\uff0c\u5bf9\u4e8e\u4e00\u822c\u7684\u5e94\u7528\u63d0\u4f9b\u4e00\u4e2a\u5065\u5eb7\u68c0\u67e5\u7684 URL \u4f1a\u66f4\u597d\uff0c\u8fd9\u91cc\u6211\u4eec\u6dfb\u52a0\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u53ef\u8bfb\u6027\u63a2\u9488\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u6dfb\u52a0\u5b58\u6d3b\u6027\u63a2\u9488\u5462\uff1f\u8fd9\u91cc\u5176\u5b9e\u662f\u8003\u8651\u5230\u7ebf\u4e0a\u9519\u8bef\u6392\u67e5\u7684\u4e00\u4e2a\u95ee\u9898\uff0c\u5982\u679c\u5f53\u6211\u4eec\u7684\u5e94\u7528\u51fa\u73b0\u4e86\u95ee\u9898\uff0c\u7136\u540e\u5c31\u81ea\u52a8\u91cd\u542f\u53bb\u63a9\u76d6\u9519\u8bef\u7684\u8bdd\uff0c\u53ef\u80fd\u8fd9\u4e2a\u9519\u8bef\u5c31\u4f1a\u88ab\u6c38\u8fdc\u5ffd\u7565\u6389\u4e86\uff0c\u6240\u4ee5\u5176\u5b9e\u8fd9\u662f\u4e00\u4e2a\u6298\u8877\u7684\u505a\u6cd5\uff0c\u4e0d\u4f7f\u7528\u5b58\u6d3b\u6027\u63a2\u9488\uff0c\u800c\u662f\u7ed3\u5408\u76d1\u63a7\u62a5\u8b66\uff0c\u4fdd\u7559\u9519\u8bef\u73b0\u573a\uff0c\u65b9\u4fbf\u9519\u8bef\u6392\u67e5\uff0c\u4f46\u662f\u53ef\u8bfb\u5199\u63a2\u9488\u662f\u4e00\u5b9a\u9700\u8981\u6dfb\u52a0\u7684\uff1a</p> <pre><code>readinessProbe:\n  tcpSocket:\n    port: 80\n  initialDelaySeconds: 5\n  periodSeconds: 5\n</code></pre> <p>\u589e\u52a0\u4e0a\u9762\u7684\u63a2\u9488\uff0c\u6bcf 5s \u68c0\u6d4b\u4e00\u6b21\u5e94\u7528\u662f\u5426\u53ef\u8bfb\uff0c\u8fd9\u6837\u53ea\u6709\u5f53 <code>readinessProbe</code> \u63a2\u9488\u68c0\u6d4b\u6210\u529f\u540e\u624d\u8868\u793a\u51c6\u5907\u597d\u63a5\u6536\u6d41\u91cf\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u624d\u4f1a\u66f4\u65b0 Service \u7684 Endpoints \u5bf9\u8c61\u3002</p>"},{"location":"kubernetes_example/wordpress/#qos","title":"\u670d\u52a1\u8d28\u91cf QoS","text":"<p><code>QoS</code> \u662f <code>Quality of Service</code> \u7684\u7f29\u5199\uff0c\u5373\u670d\u52a1\u8d28\u91cf\u3002\u4e3a\u4e86\u5b9e\u73b0\u8d44\u6e90\u88ab\u6709\u6548\u8c03\u5ea6\u548c\u5206\u914d\u7684\u540c\u65f6\u63d0\u9ad8\u8d44\u6e90\u5229\u7528\u7387\uff0cKubernetes \u9488\u5bf9\u4e0d\u540c\u670d\u52a1\u8d28\u91cf\u7684\u9884\u671f\uff0c\u901a\u8fc7 <code>QoS</code> \u6765\u5bf9 Pod \u8fdb\u884c\u670d\u52a1\u8d28\u91cf\u7ba1\u7406\u3002\u5bf9\u4e8e\u4e00\u4e2a Pod \u6765\u8bf4\uff0c\u670d\u52a1\u8d28\u91cf\u4f53\u73b0\u5728\u4e24\u4e2a\u5177\u4f53\u7684\u6307\u6807\uff1aCPU \u548c\u5185\u5b58\u3002\u5f53\u8282\u70b9\u4e0a\u5185\u5b58\u8d44\u6e90\u7d27\u5f20\u65f6\uff0cKubernetes \u4f1a\u6839\u636e\u9884\u5148\u8bbe\u7f6e\u7684\u4e0d\u540c <code>QoS</code> \u7c7b\u522b\u8fdb\u884c\u76f8\u5e94\u5904\u7406\u3002</p> <p><code>QoS</code> \u4e3b\u8981\u5206\u4e3a <code>Guaranteed</code>\u3001<code>Burstable</code> \u548c <code>Best-Effort</code>\u4e09\u7c7b\uff0c\u4f18\u5148\u7ea7\u4ece\u9ad8\u5230\u4f4e\u3002\u6211\u4eec\u5148\u5206\u522b\u6765\u4ecb\u7ecd\u4e0b\u8fd9\u4e09\u79cd\u670d\u52a1\u7c7b\u578b\u7684\u5b9a\u4e49\u3002</p>"},{"location":"kubernetes_example/wordpress/#guaranteed","title":"Guaranteed(\u6709\u4fdd\u8bc1\u7684)","text":"<p>\u5c5e\u4e8e\u8be5\u7ea7\u522b\u7684 Pod \u6709\u4ee5\u4e0b\u4e24\u79cd\uff1a</p> <ul> <li>Pod \u4e2d\u7684<code>\u6240\u6709\u5bb9\u5668</code>\u90fd\u4e14<code>\u4ec5</code>\u8bbe\u7f6e\u4e86 CPU \u548c\u5185\u5b58\u7684 <code>limits</code></li> <li>Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u8bbe\u7f6e\u4e86 CPU \u548c\u5185\u5b58\u7684 requests \u548c limits \uff0c\u4e14\u5355\u4e2a\u5bb9\u5668\u5185\u7684<code>requests==limits</code>\uff08requests\u4e0d\u7b49\u4e8e0\uff09</li> </ul> <p>Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u4e14\u4ec5\u8bbe\u7f6e\u4e86 limits\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>containers:\n  - name: foo\n    resources:\n      limits:\n        cpu: 10m\n        memory: 1Gi\n  - name: bar\n    resources:\n      limits:\n        cpu: 100m\n        memory: 100Mi\n</code></pre> <p>Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u8bbe\u7f6e\u4e86 requests \u548c limits\uff0c\u4e14\u5355\u4e2a\u5bb9\u5668\u5185\u7684 requests==limits \u7684\u60c5\u51b5\uff1a</p> <pre><code>containers:\n  - name: foo\n    resources:\n      limits:\n        cpu: 10m\n        memory: 1Gi\n      requests:\n        cpu: 10m\n        memory: 1Gi\n  - name: bar\n    resources:\n      limits:\n        cpu: 100m\n        memory: 100Mi\n      requests:\n        cpu: 100m\n        memory: 100Mi\n</code></pre> <p>\u5bb9\u5668 foo \u548c bar \u5185 <code>resources</code> \u7684 <code>requests</code> \u548c <code>limits</code> \u5747\u76f8\u7b49\uff0c\u8be5 Pod \u7684 <code>QoS</code> \u7ea7\u522b\u5c5e\u4e8e <code>Guaranteed</code>\u3002</p>"},{"location":"kubernetes_example/wordpress/#burstable","title":"Burstable(\u4e0d\u7a33\u5b9a\u7684)","text":"<p>Pod \u4e2d\u53ea\u8981\u6709\u4e00\u4e2a\u5bb9\u5668\u7684 requests \u548c limits \u7684\u8bbe\u7f6e\u4e0d\u76f8\u540c\uff0c\u90a3\u4e48\u8be5 Pod \u7684 QoS \u5373\u4e3a Burstable\u3002\u5982\u4e0b\u6240\u793a\u5bb9\u5668 foo \u6307\u5b9a\u4e86 resource\uff0c\u800c\u5bb9\u5668 bar \u672a\u6307\u5b9a\uff1a</p> <pre><code>containers:\n  - name: foo\n    resources:\n      limits:\n        cpu: 10m\n        memory: 1Gi\n      requests:\n        cpu: 10m\n        memory: 1Gi\n  - name: bar\n</code></pre> <p>\u5bb9\u5668 foo \u8bbe\u7f6e\u4e86\u5185\u5b58 limits\uff0c\u800c\u5bb9\u5668 bar \u8bbe\u7f6e\u4e86CPU limits\uff1a</p> <pre><code>containers:\n  - name: foo\n    resources:\n      limits:\n        memory: 1Gi\n  - name: bar\n    resources:\n      limits:\n        cpu: 100m\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u5982\u679c\u5bb9\u5668\u6307\u5b9a\u4e86 requests \u800c\u672a\u6307\u5b9a limits\uff0c\u5219 limits \u7684\u503c\u7b49\u4e8e\u8282\u70b9\u8d44\u6e90\u7684\u6700\u5927\u503c\uff0c\u5982\u679c\u5bb9\u5668\u6307\u5b9a\u4e86 limits \u800c\u672a\u6307\u5b9a requests\uff0c\u5219 requests \u7684\u503c\u7b49\u4e8e limits\u3002</p>"},{"location":"kubernetes_example/wordpress/#best-effort","title":"Best-Effort(\u5c3d\u6700\u5927\u52aa\u529b)","text":"<p>\u5982\u679c Pod \u4e2d\u6240\u6709\u5bb9\u5668\u7684 resources \u5747\u672a\u8bbe\u7f6e requests \u4e0e limits\uff0c\u8be5 Pod \u7684 QoS \u5373\u4e3a Best-Effort\u3002\u5982\u4e0b\u6240\u793a\u5bb9\u5668 foo \u548c\u5bb9\u5668 bar \u5747\u672a\u8bbe\u7f6erequests \u548c limits\uff1a</p> <pre><code>containers:\n  - name: foo\n    resources:\n  - name: bar\n    resources:\n</code></pre>"},{"location":"kubernetes_example/wordpress/#_6","title":"\u8d44\u6e90\u56de\u6536\u7b56\u7565","text":"<p>Kubernetes \u901a\u8fc7 CGroup \u7ed9 Pod\u8bbe\u7f6e QoS \u7ea7\u522b\uff0c\u5f53\u8d44\u6e90\u4e0d\u8db3\u65f6\u4f1a\u4f18\u5148 kill \u6389\u4f18\u5148\u7ea7\u4f4e\u7684 Pod\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u8fc7\u7a0b\u4e2d\uff0c\u901a\u8fc7 <code>OOM</code> \u5206\u6570\u503c\u6765\u5b9e\u73b0\uff0cOOM \u5206\u6570\u503c\u8303\u56f4\u4e3a 0-1000\uff0cOOM \u5206\u6570\u503c\u6839\u636e <code>OOM_ADJ</code>\u53c2\u6570\u8ba1\u7b97\u5f97\u51fa\u3002</p> <p>\u5bf9\u4e8e <code>Guaranteed</code> \u7ea7\u522b\u7684 Pod\uff0cOOM_ADJ \u53c2\u6570\u8bbe\u7f6e\u6210\u4e86<code>-998</code>\uff0c\u5bf9\u4e8e <code>Best-Effort</code> \u7ea7\u522b\u7684 Pod\uff0cOOM_ADJ \u53c2\u6570\u8bbe\u7f6e\u6210\u4e86<code>1000</code>\uff0c\u5bf9\u4e8e <code>Burstable</code> \u7ea7\u522b\u7684 Pod\uff0cOOM_ADJ \u53c2\u6570\u53d6\u503c\u4ece 2 \u5230 999\u3002</p> <p>QoS Pods \u88ab kill \u6389\u7684\u573a\u666f\u548c\u987a\u5e8f\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li>Best-Effort Pods\uff1a\u7cfb\u7edf\u7528\u5b8c\u4e86\u5168\u90e8\u5185\u5b58\u65f6\uff0c\u8be5\u7c7b\u578b Pods \u4f1a\u6700\u5148\u88ab kill \u6389</li> <li>Burstable Pods\uff1a\u7cfb\u7edf\u7528\u5b8c\u4e86\u5168\u90e8\u5185\u5b58\uff0c\u4e14\u6ca1\u6709 Best-Effort \u7c7b\u578b\u7684\u5bb9\u5668\u53ef\u4ee5\u88ab kill \u65f6\uff0c\u8be5\u7c7b\u578b\u7684 Pods \u4f1a\u88ab kill \u6389</li> <li>Guaranteed Pods\uff1a\u7cfb\u7edf\u7528\u5b8c\u4e86\u5168\u90e8\u5185\u5b58\uff0c\u4e14\u6ca1\u6709 Burstable \u4e0e Best-Effort \u7c7b\u578b\u7684\u5bb9\u5668\u53ef\u4ee5\u88ab kill \u65f6\uff0c\u8be5\u7c7b\u578b\u7684 pods \u4f1a\u88ab kill \u6389</li> </ul> <p>\u6240\u4ee5\u5982\u679c\u8d44\u6e90\u5145\u8db3\uff0c\u53ef\u5c06 QoS Pods \u7c7b\u578b\u8bbe\u7f6e\u4e3a Guaranteed\uff0c\u7528\u8ba1\u7b97\u8d44\u6e90\u6362\u4e1a\u52a1\u6027\u80fd\u548c\u7a33\u5b9a\u6027\uff0c\u51cf\u5c11\u6392\u67e5\u95ee\u9898\u65f6\u95f4\u548c\u6210\u672c\u3002\u5982\u679c\u60f3\u66f4\u597d\u7684\u63d0\u9ad8\u8d44\u6e90\u5229\u7528\u7387\uff0c\u4e1a\u52a1\u670d\u52a1\u53ef\u4ee5\u8bbe\u7f6e\u4e3a Guaranteed\uff0c\u800c\u5176\u4ed6\u670d\u52a1\u6839\u636e\u91cd\u8981\u7a0b\u5ea6\u53ef\u5206\u522b\u8bbe\u7f6e\u4e3a Burstable \u6216 Best-Effort\uff0c\u8fd9\u5c31\u8981\u770b\u5177\u4f53\u7684\u573a\u666f\u4e86\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5982\u679c\u60f3\u8981\u5c3d\u53ef\u80fd\u63d0\u9ad8 Wordpress \u5e94\u7528\u7684\u7a33\u5b9a\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5176\u8bbe\u7f6e\u4e3a <code>Guaranteed</code> \u7c7b\u578b\u7684 Pod\uff0c\u6211\u4eec\u73b0\u5728\u6ca1\u6709\u8bbe\u7f6e resources \u8d44\u6e90\uff0c\u6240\u4ee5\u73b0\u5728\u662f <code>Best-Effort</code> \u7c7b\u578b\u7684 Pod\u3002</p> <p>\u73b0\u5728\u5982\u679c\u8981\u60f3\u7ed9\u5e94\u7528\u8bbe\u7f6e\u8d44\u6e90\u5927\u5c0f\uff0c\u5c31\u53c8\u6709\u4e00\u4e2a\u95ee\u9898\u4e86\uff0c\u5e94\u8be5\u5982\u4f55\u8bbe\u7f6e\u5408\u9002\u7684\u8d44\u6e90\u5927\u5c0f\u5462\uff1f\u5176\u5b9e\u8fd9\u5c31\u9700\u8981\u6211\u4eec\u5bf9\u81ea\u5df1\u7684\u5e94\u7528\u975e\u5e38\u4e86\u89e3\u624d\u884c\u4e86\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u53ef\u4ee5\u5148\u4e0d\u8bbe\u7f6e\u8d44\u6e90\uff0c\u7136\u540e\u53ef\u4ee5\u6839\u636e\u6211\u4eec\u7684\u5e94\u7528\u7684\u5e76\u53d1\u548c\u8bbf\u95ee\u91cf\u6765\u8fdb\u884c\u538b\u529b\u6d4b\u8bd5\uff0c\u57fa\u672c\u4e0a\u53ef\u4ee5\u5927\u6982\u8ba1\u7b97\u51fa\u5e94\u7528\u7684\u8d44\u6e90\u4f7f\u7528\u91cf\uff0c\u6211\u4eec\u8fd9\u91cc\u53ef\u4ee5\u4f7f\u7528 Apache Bench\uff08AB Test\uff09 \u6216\u8005 Fortio\uff08Istio \u6d4b\u8bd5\u5de5\u5177\uff09 \u8fd9\u6837\u7684\u6d4b\u8bd5\u5de5\u5177\u6765\u6d4b\u8bd5\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 Fortio \u8fd9\u4e2a\u6d4b\u8bd5\u5de5\u5177\uff0c\u6bd4\u5982\u6bcf\u79d2 1000 \u4e2a\u8bf7\u6c42\u548c 8 \u4e2a\u5e76\u53d1\u7684\u8fde\u63a5\u7684\u6d4b\u8bd5\u547d\u4ee4\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ fortio load -a -c 8 -qps 1000 -t 60s \"http://k8s.qikqiak.com:30012\"\nStarting at 1000 qps with 8 thread(s) [gomax 2] for 1m0s : 7500 calls each (total 60000)\nEnded after 1m687224615s : 5005 calls. qps=472\nAggregated Sleep Time : count 5005 avg -128368 +/- 16 min -964246789 max -050576982 sum -1357482\n[......]\nSockets used: 53 (for perfect keepalive, would be 8)\nCode 200 : 5005 (10 %)\nResponse Header Sizes : count 5005 avg 217083 +/- 793 min 292 max 311 sum 1462315\nResponse Body/Total Sizes : count 5005 avg 276171 +/- 793 min 27641 max 27660 sum 138344060\nSaved result to data/2020-02-15-125121_Fortio.json (graph link)\nAll done 5005 calls 872 ms avg, 5 qps\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u901a\u8fc7\u6d4f\u89c8\u5668\u67e5\u770b\u5230\u6700\u7ec8\u6d4b\u8bd5\u7ed3\u679c\uff1a</p> <p></p> <p>\u5728\u6d4b\u8bd5\u671f\u95f4\u6211\u4eec\u53ef\u4ee5\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u67e5\u770b\u5e94\u7528\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff1a</p> <pre><code>$ kubectl top pods -l app=wordpress -n kube-example\nNAME                              CPU(cores)   MEMORY(bytes)\nwordpress-5cc66f986b-2jv7h        569m         72Mi\nwordpress-5cc66f986b-nf79l        997m         71Mi\nwordpress-d4c885d5d-gtvhd         895m         87Mi\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5185\u5b58\u57fa\u672c\u4e0a\u90fd\u662f\u5904\u4e8e 100Mi \u4ee5\u5185\uff0c\u800c CPU \u6d88\u8017\u5c31\u975e\u5e38\u5927\u4e86\uff0c\u4f46\u662f\u7531\u4e8e CPU \u662f\u53ef\u538b\u7f29\u8d44\u6e90\uff0c\u4e5f\u5c31\u662f\u8bf4\u8d85\u8fc7\u4e86\u9650\u5236\u5e94\u7528\u4e5f\u4e0d\u4f1a\u6302\u6389\u7684\uff0c\u53ea\u662f\u4f1a\u53d8\u6162\u800c\u5df2\u3002\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u53ef\u4ee5\u7ed9 Wordpress \u5e94\u7528\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u914d\u7f6e\uff0c\u5982\u679c\u4f60\u96c6\u7fa4\u8d44\u6e90\u8db3\u591f\u7684\u8bdd\u53ef\u4ee5\u9002\u5f53\u591a\u5206\u914d\u4e00\u4e9b\u8d44\u6e90\uff1a</p> <pre><code>resources:\n  limits:\n    cpu: 200m\n    memory: 100Mi\n  requests:\n    cpu: 200m\n    memory: 100Mi\n</code></pre>"},{"location":"kubernetes_example/wordpress/#_7","title":"\u6eda\u52a8\u66f4\u65b0","text":"<p>Deployment \u63a7\u5236\u5668\u9ed8\u8ba4\u7684\u5c31\u662f\u6eda\u52a8\u66f4\u65b0\u7684\u66f4\u65b0\u7b56\u7565\uff0c\u8be5\u7b56\u7565\u53ef\u4ee5\u5728\u4efb\u4f55\u65f6\u95f4\u70b9\u66f4\u65b0\u5e94\u7528\u7684\u65f6\u5019\u4fdd\u8bc1\u67d0\u4e9b\u5b9e\u4f8b\u4f9d\u7136\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\u6765\u9632\u6b62\u5e94\u7528 down \u6389\uff0c\u5f53\u65b0\u90e8\u7f72\u7684 Pod \u542f\u52a8\u5e76\u53ef\u4ee5\u5904\u7406\u6d41\u91cf\u4e4b\u540e\uff0c\u624d\u4f1a\u53bb\u6740\u6389\u65e7\u7684 Pod\u3002\u5728\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u6211\u4eec\u8fd8\u53ef\u4ee5\u6307\u5b9a Kubernetes \u5728\u66f4\u65b0\u671f\u95f4\u5982\u4f55\u5904\u7406\u591a\u4e2a\u526f\u672c\u7684\u5207\u6362\u65b9\u5f0f\uff0c\u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a3\u526f\u672c\u7684\u5e94\u7528\uff0c\u5728\u66f4\u65b0\u7684\u8fc7\u7a0b\u4e2d\u662f\u5426\u5e94\u8be5\u7acb\u5373\u521b\u5efa\u8fd93\u4e2a\u65b0\u7684 Pod \u5e76\u7b49\u5f85\u4ed6\u4eec\u5168\u90e8\u542f\u52a8\uff0c\u6216\u8005\u6740\u6389\u4e00\u4e2a\u4e4b\u5916\u7684\u6240\u6709\u65e7\u7684 Pod\uff0c\u6216\u8005\u8fd8\u662f\u8981\u4e00\u4e2a\u4e00\u4e2a\u7684 Pod \u8fdb\u884c\u66ff\u6362\uff1f</p> <p>\u5982\u679c\u6211\u4eec\u4ece\u65e7\u7248\u672c\u5230\u65b0\u7248\u672c\u8fdb\u884c\u6eda\u52a8\u66f4\u65b0\uff0c\u53ea\u662f\u7b80\u5355\u7684\u901a\u8fc7\u8f93\u51fa\u663e\u793a\u6765\u5224\u65ad\u54ea\u4e9b Pod \u662f\u5b58\u6d3b\u5e76\u51c6\u5907\u5c31\u7eea\u7684\uff0c\u90a3\u4e48\u8fd9\u4e2a\u6eda\u52a8\u66f4\u65b0\u7684\u884c\u4e3a\u770b\u4e0a\u53bb\u80af\u5b9a\u5c31\u662f\u6709\u6548\u7684\uff0c\u4f46\u662f\u5f80\u5f80\u5b9e\u9645\u60c5\u51b5\u5c31\u662f\u4ece\u65e7\u7248\u672c\u5230\u65b0\u7248\u672c\u7684\u5207\u6362\u7684\u8fc7\u7a0b\u5e76\u4e0d\u603b\u662f\u5341\u5206\u987a\u7545\u7684\uff0c\u5e94\u7528\u7a0b\u5e8f\u5f88\u6709\u53ef\u80fd\u4f1a\u4e22\u5f03\u6389\u67d0\u4e9b\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u3002\u6bd4\u5982\u6211\u4eec\u5728 Wordpress \u5e94\u7528\u4e2d\u6dfb\u52a0\u4e0a\u5982\u4e0b\u7684\u6eda\u52a8\u66f4\u65b0\u7b56\u7565\uff0c\u968f\u4fbf\u66f4\u6539\u4ee5\u4e0b Pod Template \u4e2d\u7684\u53c2\u6570\uff0c\u6bd4\u5982\u5bb9\u5668\u540d\u66f4\u6539\u4e3a blog\uff1a</p> <pre><code>strategy:\n  type: RollingUpdate\n  rollingUpdate:\n    maxSurge: 1\n    maxUnavailable: 0\n</code></pre> <p>\u7136\u540e\u66f4\u65b0\u5e94\u7528\uff0c\u540c\u65f6\u7528 Fortio \u5de5\u5177\u5728\u6eda\u52a8\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u6765\u6d4b\u8bd5\u5e94\u7528\u662f\u5426\u53ef\u7528\uff1a</p> <pre><code>$ kubectl apply -f wordpress.yaml\n$ fortio load -a -c 8 -qps 1000 -t 60s \"http://k8s.qikqiak.com:30012\"\nStarting at 1000 qps with 8 thread(s) [gomax 2] for 1m0s : 7500 calls each (total 60000)\nEnded after 1m006243654s : 5485 calls. qps=407\nAggregated Sleep Time : count 5485 avg -626081 +/- 15 min -753398956 max 000709054 sum -9660518\n[...]\nCode 200 : 5463 (6 %)\nCode 502 : 20 (4 %)\nResponse Header Sizes : count 5485 avg 214166 +/- 53 min 0 max 214 sum 1169082\nResponse Body/Total Sizes : count 5485 avg 818651 +/- 41 min 0 max 826 sum 4515178\n[...]\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u8f93\u51fa\u53ef\u4ee5\u770b\u51fa\u6709\u90e8\u5206\u8bf7\u6c42\u5904\u7406\u5931\u8d25\u4e86\uff08502\uff09\uff0c\u8981\u5f04\u6e05\u695a\u5931\u8d25\u7684\u539f\u56e0\u5c31\u9700\u8981\u5f04\u660e\u767d\u5f53\u5e94\u7528\u5728\u6eda\u52a8\u66f4\u65b0\u671f\u95f4\u91cd\u65b0\u8def\u7531\u6d41\u91cf\u65f6\uff0c\u4ece\u65e7\u7684 Pod \u5b9e\u4f8b\u5230\u65b0\u7684\u5b9e\u4f8b\u7a76\u7adf\u4f1a\u53d1\u751f\u4ec0\u4e48\uff0c\u9996\u5148\u8ba9\u6211\u4eec\u5148\u770b\u770b Kubernetes \u662f\u5982\u4f55\u7ba1\u7406\u5de5\u4f5c\u8d1f\u8f7d\u8fde\u63a5\u7684\u3002</p>"},{"location":"kubernetes_example/wordpress/#_8","title":"\u5931\u8d25\u539f\u56e0","text":"<p>\u6211\u4eec\u8fd9\u91cc\u901a\u8fc7 NodePort \u53bb\u8bbf\u95ee\u5e94\u7528\uff0c\u5b9e\u9645\u4e0a\u4e5f\u662f\u901a\u8fc7\u6bcf\u4e2a\u8282\u70b9\u4e0a\u9762\u7684 <code>kube-proxy</code> \u901a\u8fc7\u66f4\u65b0 iptables \u89c4\u5219\u6765\u5b9e\u73b0\u7684\u3002</p> <p></p> <p>Kubernetes \u4f1a\u6839\u636e Pods \u7684\u72b6\u6001\u53bb\u66f4\u65b0 Endpoints \u5bf9\u8c61\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4fdd\u8bc1 Endpoints \u4e2d\u5305\u542b\u7684\u90fd\u662f\u51c6\u5907\u597d\u5904\u7406\u8bf7\u6c42\u7684 Pod\u3002\u4e00\u65e6\u65b0\u7684 Pod \u5904\u4e8e\u6d3b\u52a8\u72b6\u6001\u5e76\u51c6\u5907\u5c31\u7eea\u540e\uff0cKubernetes \u5c31\u5c06\u4f1a\u505c\u6b62\u5c31\u7684 Pod\uff0c\u4ece\u800c\u5c06 Pod \u7684\u72b6\u6001\u66f4\u65b0\u4e3a <code>Terminating</code>\uff0c\u7136\u540e\u4ece Endpoints \u5bf9\u8c61\u4e2d\u79fb\u9664\uff0c\u5e76\u4e14\u53d1\u9001\u4e00\u4e2a <code>SIGTERM</code> \u4fe1\u53f7\u7ed9 Pod \u7684\u4e3b\u8fdb\u7a0b\u3002<code>SIGTERM</code> \u4fe1\u53f7\u5c31\u4f1a\u8ba9\u5bb9\u5668\u4ee5\u6b63\u5e38\u7684\u65b9\u5f0f\u5173\u95ed\uff0c\u5e76\u4e14\u4e0d\u63a5\u53d7\u4efb\u4f55\u65b0\u7684\u8fde\u63a5\u3002Pod \u4ece Endpoints \u5bf9\u8c61\u4e2d\u88ab\u79fb\u9664\u540e\uff0c\u524d\u9762\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u5c31\u4f1a\u5c06\u6d41\u91cf\u8def\u7531\u5230\u5176\u4ed6\uff08\u65b0\u7684\uff09Pod \u4e2d\u53bb\u3002\u56e0\u4e3a\u5728\u8d1f\u8f7d\u5747\u8861\u5668\u6ce8\u610f\u5230\u53d8\u66f4\u5e76\u66f4\u65b0\u5176\u914d\u7f6e\u4e4b\u524d\uff0c\u7ec8\u6b62\u4fe1\u53f7\u5c31\u4f1a\u53bb\u505c\u7528 Pod\uff0c\u800c\u8fd9\u4e2a\u91cd\u65b0\u914d\u7f6e\u8fc7\u7a0b\u53c8\u662f<code>\u5f02\u6b65</code>\u53d1\u751f\u7684\uff0c\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u6b63\u786e\u7684\u987a\u5e8f\uff0c\u6240\u4ee5\u5c31\u53ef\u80fd\u5bfc\u81f4\u5f88\u5c11\u7684\u8bf7\u6c42\u4f1a\u88ab\u8def\u7531\u5230\u5df2\u7ecf\u7ec8\u6b62\u7684 Pod \u4e0a\u53bb\u4e86\uff0c\u4e5f\u5c31\u51fa\u73b0\u4e86\u4e0a\u9762\u6211\u4eec\u8bf4\u7684\u60c5\u51b5\u3002</p>"},{"location":"kubernetes_example/wordpress/#_9","title":"\u96f6\u5b95\u673a","text":"<p>\u90a3\u4e48\u5982\u4f55\u589e\u5f3a\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u4ee5\u5b9e\u73b0\u771f\u6b63\u7684\u96f6\u5b95\u673a\u8fc1\u79fb\u66f4\u65b0\u5462\uff1f</p> <p>\u9996\u5148\uff0c\u8981\u5b9e\u73b0\u8fd9\u4e2a\u76ee\u6807\u7684\u5148\u51b3\u6761\u4ef6\u662f\u6211\u4eec\u7684\u5bb9\u5668\u8981\u6b63\u786e\u5904\u7406\u7ec8\u6b62\u4fe1\u53f7\uff0c\u5728 <code>SIGTERM</code> \u4fe1\u53f7\u4e0a\u5b9e\u73b0\u4f18\u96c5\u5173\u95ed\u3002\u4e0b\u4e00\u6b65\u9700\u8981\u6dfb\u52a0 <code>readiness</code> \u53ef\u8bfb\u63a2\u9488\uff0c\u6765\u68c0\u67e5\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u662f\u5426\u5df2\u7ecf\u51c6\u5907\u597d\u6765\u5904\u7406\u6d41\u91cf\u4e86\u3002\u4e3a\u4e86\u89e3\u51b3 Pod \u505c\u6b62\u7684\u65f6\u5019\u4e0d\u4f1a\u963b\u585e\u5e76\u7b49\u5230\u8d1f\u8f7d\u5747\u8861\u5668\u91cd\u65b0\u914d\u7f6e\u7684\u95ee\u9898\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u4f7f\u7528 <code>preStop</code> \u8fd9\u4e2a\u751f\u547d\u5468\u671f\u7684\u94a9\u5b50\uff0c\u5728\u5bb9\u5668\u7ec8\u6b62\u4e4b\u524d\u8c03\u7528\u8be5\u94a9\u5b50\u3002</p> <p>\u751f\u547d\u5468\u671f\u94a9\u5b50\u51fd\u6570\u662f<code>\u540c\u6b65</code>\u7684\uff0c\u6240\u4ee5\u5fc5\u987b\u5728\u5c06\u6700\u7ec8\u505c\u6b62\u4fe1\u53f7\u53d1\u9001\u5230\u5bb9\u5668\u4e4b\u524d\u5b8c\u6210\uff0c\u5728\u6211\u4eec\u7684\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528\u8be5\u94a9\u5b50\u7b80\u5355\u7684\u7b49\u5f85\uff0c\u7136\u540e <code>SIGTERM</code> \u4fe1\u53f7\u5c06\u505c\u6b62\u5e94\u7528\u7a0b\u5e8f\u8fdb\u7a0b\u3002\u540c\u65f6\uff0cKubernetes \u5c06\u4ece Endpoints \u5bf9\u8c61\u4e2d\u5220\u9664\u8be5 Pod\uff0c\u6240\u4ee5\u8be5 Pod \u5c06\u4f1a\u4ece\u6211\u4eec\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u6392\u9664\uff0c\u57fa\u672c\u4e0a\u6765\u8bf4\u6211\u4eec\u7684\u751f\u547d\u5468\u671f\u94a9\u5b50\u51fd\u6570\u7b49\u5f85\u7684\u65f6\u95f4\u53ef\u4ee5\u786e\u4fdd\u5728\u5e94\u7528\u7a0b\u5e8f\u505c\u6b62\u4e4b\u524d\u91cd\u65b0\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668\uff1a</p> <pre><code>readinessProbe:\n  # ...\nlifecycle:\n  preStop:\n    exec:\n      command: [\"/bin/bash\", \"-c\", \"sleep 20\"]\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 <code>preStop</code> \u8bbe\u7f6e\u4e86\u4e00\u4e2a 20s \u7684\u5bbd\u9650\u671f\uff0cPod \u5728\u771f\u6b63\u9500\u6bc1\u524d\u4f1a\u5148 sleep \u7b49\u5f85 20s\uff0c\u8fd9\u5c31\u76f8\u5f53\u4e8e\u7559\u4e86\u65f6\u95f4\u7ed9 Endpoints \u63a7\u5236\u5668\u548c kube-proxy \u66f4\u65b0\u53bb Endpoints \u5bf9\u8c61\u548c\u8f6c\u53d1\u89c4\u5219\uff0c\u8fd9\u6bb5\u65f6\u95f4 Pod \u867d\u7136\u5904\u4e8e Terminating \u72b6\u6001\uff0c\u5373\u4fbf\u5728\u8f6c\u53d1\u89c4\u5219\u66f4\u65b0\u5b8c\u5168\u4e4b\u524d\u6709\u8bf7\u6c42\u88ab\u8f6c\u53d1\u5230\u8fd9\u4e2a Terminating \u7684 Pod\uff0c\u4f9d\u7136\u53ef\u4ee5\u88ab\u6b63\u5e38\u5904\u7406\uff0c\u56e0\u4e3a\u5b83\u8fd8\u5728 sleep\uff0c\u6ca1\u6709\u88ab\u771f\u6b63\u9500\u6bc1\u3002</p> <p>\u73b0\u5728\uff0c\u5f53\u6211\u4eec\u53bb\u67e5\u770b\u6eda\u52a8\u66f4\u65b0\u671f\u95f4\u7684 Pod \u884c\u4e3a\u65f6\uff0c\u6211\u4eec\u5c06\u770b\u5230\u6b63\u5728\u7ec8\u6b62\u7684 Pod \u5904\u4e8e <code>Terminating</code> \u72b6\u6001\uff0c\u4f46\u662f\u5728\u7b49\u5f85\u65f6\u95f4\u7ed3\u675f\u4e4b\u524d\u4e0d\u4f1a\u5173\u95ed\u7684\uff0c\u5982\u679c\u6211\u4eec\u4f7f\u7528 <code>Fortio</code> \u91cd\u65b0\u6d4b\u8bd5\u4e0b\uff0c\u5219\u4f1a\u770b\u5230\u96f6\u5931\u8d25\u8bf7\u6c42\u7684\u7406\u60f3\u72b6\u6001\u3002</p>"},{"location":"kubernetes_example/wordpress/#hpa","title":"HPA","text":"<p>\u73b0\u5728\u5e94\u7528\u662f\u56fa\u5b9a\u76843\u4e2a\u526f\u672c\uff0c\u4f46\u662f\u5f80\u5f80\u5728\u751f\u4ea7\u73af\u5883\u6d41\u91cf\u662f\u4e0d\u53ef\u63a7\u7684\uff0c\u5f88\u6709\u53ef\u80fd\u4e00\u6b21\u6d3b\u52a8\u5c31\u4f1a\u6709\u5927\u91cf\u7684\u6d41\u91cf\uff0c3\u4e2a\u526f\u672c\u5f88\u6709\u53ef\u80fd\u6297\u4e0d\u4f4f\u5927\u91cf\u7684\u7528\u6237\u8bf7\u6c42\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u5e0c\u671b\u80fd\u591f\u81ea\u52a8\u5bf9 Pod \u8fdb\u884c\u4f38\u7f29\uff0c\u76f4\u63a5\u4f7f\u7528\u524d\u9762\u6211\u4eec\u5b66\u4e60\u7684 HPA \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5c31\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u9700\u6c42\u4e86\u3002</p> <p>\u76f4\u63a5\u4f7f\u7528<code>kubectl autoscale</code>\u547d\u4ee4\u6765\u521b\u5efa\u4e00\u4e2a <code>HPA</code> \u5bf9\u8c61</p> <pre><code>$ kubectl autoscale deployment wordpress --namespace kube-example --cpu-percent=20 --min=3 --max=6\nhorizontalpodautoscaler.autoscaling/hpa-demo autoscaled\n$ kubectl get hpa -n kube-example\nNAME        REFERENCE              TARGETS         MINPODS   MAXPODS   REPLICAS   AGE\nwordpress   Deployment/wordpress   &lt;unknown&gt;/20%   3         6         0          13s\n</code></pre> <p>\u6b64\u547d\u4ee4\u521b\u5efa\u4e86\u4e00\u4e2a\u5173\u8054\u8d44\u6e90 wordpress \u7684 HPA\uff0c\u6700\u5c0f\u7684 Pod \u526f\u672c\u6570\u4e3a3\uff0c\u6700\u5927\u4e3a6\u3002HPA \u4f1a\u6839\u636e\u8bbe\u5b9a\u7684 cpu \u4f7f\u7528\u7387\uff0820%\uff09\u52a8\u6001\u7684\u589e\u52a0\u6216\u8005\u51cf\u5c11 Pod \u6570\u91cf\u3002\u540c\u6837\uff0c\u4f7f\u7528\u4e0a\u9762\u7684 Fortio \u5de5\u5177\u6765\u8fdb\u884c\u538b\u6d4b\u4e00\u6b21\uff0c\u770b\u4e0b\u80fd\u5426\u8fdb\u884c\u81ea\u52a8\u7684\u6269\u7f29\u5bb9\uff1a</p> <pre><code>$ fortio load -a -c 8 -qps 1000 -t 60s \"http://k8s.qikqiak.com:30012\"\n</code></pre> <p>\u5728\u538b\u6d4b\u7684\u8fc7\u7a0b\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230 HPA \u7684\u72b6\u6001\u53d8\u5316\u4ee5\u53ca Pod \u6570\u91cf\u4e5f\u53d8\u6210\u4e866\u4e2a\uff1a</p> <pre><code>$ kubectl get hpa -n kube-example\nNAME        REFERENCE              TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nwordpress   Deployment/wordpress   98%/20%   3         6         6          2m40s\n$ kubectl get pods -n kube-example                \nNAME                              READY   STATUS    RESTARTS   AGE\nwordpress-79d756cbc8-f6kfm        1/1     Running   0          21m\nwordpress-79d756cbc8-kspch        1/1     Running   0          32s\nwordpress-79d756cbc8-sf5rm        1/1     Running   0          32s\nwordpress-79d756cbc8-tsjmf        1/1     Running   0          20m\nwordpress-79d756cbc8-v9p7n        1/1     Running   0          32s\nwordpress-79d756cbc8-z4wpp        1/1     Running   0          21m\nwordpress-mysql-5756ccc8b-zqstp   1/1     Running   0          3d19h\n</code></pre> <p>\u5f53\u538b\u6d4b\u505c\u6b62\u4ee5\u540e\u6b63\u5e385\u5206\u949f\u540e\u5c31\u4f1a\u81ea\u52a8\u8fdb\u884c\u7f29\u5bb9\uff0c\u53d8\u6210\u6700\u5c0f\u76843\u4e2a Pod \u526f\u672c\u3002</p>"},{"location":"kubernetes_example/wordpress/#_10","title":"\u5b89\u5168\u6027","text":"<p>\u5b89\u5168\u6027\u8fd9\u4e2a\u548c\u5177\u4f53\u7684\u4e1a\u52a1\u5e94\u7528\u6709\u5173\u7cfb\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u7684 Wordpress \u4e5f\u5c31\u662f\u6570\u636e\u5e93\u7684\u5bc6\u7801\u5c5e\u4e8e\u6bd4\u8f83\u79c1\u5bc6\u7684\u4fe1\u606f\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u4e2d\u7684 Secret \u8d44\u6e90\u5bf9\u8c61\u6765\u5b58\u50a8\u6bd4\u8f83\u79c1\u5bc6\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl create secret generic wordpress-db-pwd --from-literal=dbpwd=wordpress -n kube-example\nsecret/wordpress-db-pwd created\n</code></pre> <p>\u7136\u540e\u5c06 \bDeployment \u8d44\u6e90\u5bf9\u8c61\u4e2d\u7684\u6570\u636e\u5e93\u5bc6\u7801\u73af\u5883\u53d8\u91cf\u901a\u8fc7 Secret \u5bf9\u8c61\u8bfb\u53d6\uff1a</p> <pre><code>env:\n- name: WORDPRESS_DB_HOST\n  value: wordpress-mysql:3306\n- name: WORDPRESS_DB_USER\n  value: wordpress\n- name: WORDPRESS_DB_PASSWORD\n  valueFrom:\n    secretKeyRef:\n      name: wordpress-db-pwd\n      key: dbpwd\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u4e0d\u4f1a\u5728 YAML \u6587\u4ef6\u4e2d\u770b\u5230\u660e\u6587\u7684\u6570\u636e\u5e93\u5bc6\u7801\u4e86\uff0c\u5f53\u7136\u5b89\u5168\u6027\u90fd\u662f\u76f8\u5bf9\u7684\uff0cSecret \u8d44\u6e90\u5bf9\u8c61\u4e5f\u53ea\u662f\u7b80\u5355\u7684\u5c06\u5bc6\u7801\u505a\u4e86\u4e00\u6b21 Base64 \u7f16\u7801\u800c\u5df2\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u7279\u6b8a\u573a\u666f\u5b89\u5168\u6027\u8981\u6c42\u975e\u5e38\u9ad8\u7684\u5e94\u7528\uff0c\u5c31\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u529f\u80fd\u66f4\u52a0\u5f3a\u5927\u7684\u5bc6\u7801\u7cfb\u7edf\u6765\u8fdb\u884c\u7ba1\u7406\u4e86\uff0c\u6bd4\u5982 Vault\u3002</p>"},{"location":"kubernetes_example/wordpress/#_11","title":"\u6301\u4e45\u5316","text":"<p>\u73b0\u5728\u8fd8\u6709\u4e00\u4e2a\u6bd4\u8f83\u5927\u7684\u95ee\u9898\u5c31\u662f\u6211\u4eec\u7684\u6570\u636e\u8fd8\u6ca1\u6709\u505a\u6301\u4e45\u5316\uff0cMySQL \u6570\u636e\u5e93\u6ca1\u6709\u505a\uff0cWordpress \u5e94\u7528\u672c\u8eab\u4e5f\u6ca1\u6709\u505a\uff0c\u8fd9\u663e\u7136\u4e0d\u662f\u4e00\u4e2a\u5408\u683c\u7684\u7ebf\u4e0a\u5e94\u7528\u3002\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u4f7f\u7528\u524d\u9762\u7ae0\u8282\u4e2d\u521b\u5efa\u7684 <code>rook-ceph-block</code> \u8fd9\u4e2a StorageClass \u6765\u521b\u5efa\u6211\u4eec\u7684\u6570\u636e\u5e93\u5b58\u50a8\u540e\u7aef\uff1a(pvc.yaml)</p> <pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: mysql-pvc\n  namespace: kube-example\n  labels:\n    app: wordpress\nspec:\n  storageClassName: rook-ceph-block\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 20Gi\n</code></pre> <p>\u4f46\u662f\u7531\u4e8e Wordpress \u5e94\u7528\u662f\u591a\u4e2a\u526f\u672c\uff0c\u6240\u4ee5\u9700\u8981\u540c\u65f6\u5728\u591a\u4e2a\u8282\u70b9\u8fdb\u884c\u8bfb\u5199\uff0c\u4e5f\u5c31\u662f <code>accessModes</code> \u9700\u8981 <code>ReadWriteMany</code> \u6a21\u5f0f\uff0c\u800c Ceph RBD \u6a21\u5f0f\u662f\u4e0d\u652f\u6301 <code>RWM</code> \u7684\uff0c\u6240\u4ee5\u9700\u8981\u4f7f\u7528 CephFS\uff0c\u9996\u5148\u9700\u8981\u5728 Ceph \u4e2d\u521b\u5efa\u4e00\u4e2a Filesystem\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Rook \u7684 <code>CephFilesystem</code> \u8d44\u6e90\u5bf9\u8c61\u521b\u5efa\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: ceph.rook.io/v1\nkind: CephFilesystem\nmetadata:\n  name: myfs\n  namespace: rook-ceph\nspec:\n  metadataPool:\n    replicated:\n      size: 3\n  dataPools:\n  - replicated:\n      size: 3\n  metadataServer:\n    activeCount: 1\n    activeStandby: true\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u8fd8\u4f1a\u751f\u6210\u4e00\u4e2a\u540d\u4e3a <code>myfs-data0</code> \u7684\u5b58\u50a8\u6c60\uff0c\u4e5f\u4f1a\u81ea\u52a8\u751f\u6210\u4e24\u4e2a MDS \u7684 Pod \u670d\u52a1\uff1a</p> <pre><code>$ kubectl get pods -n rook-ceph |grep myfs\nrook-ceph-mds-myfs-a-7948557994-44c4f                  1/1     Running     0          11m\nrook-ceph-mds-myfs-b-5976b868cc-gl86g                  1/1     Running     0          11m\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u521b\u5efa\u6211\u4eec\u7684 StorageClass \u5bf9\u8c61\u4e86\uff1a</p> <pre><code>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: csi-cephfs\nprovisioner: rook-ceph.cephfs.csi.ceph.com\nparameters:\n  clusterID: rook-ceph\n  # \u4e0a\u9762\u521b\u5efa\u7684 CephFS \u6587\u4ef6\u7cfb\u7edf\u540d\u79f0\n  fsName: myfs\n  # \u81ea\u52a8\u751f\u6210\u7684\n  pool: myfs-data0 \n  # Root path of an existing CephFS volume\n  # Required for provisionVolume: \"false\"\n  # rootPath: /absolute/path\n  # The secrets contain Ceph admin credentials. These are generated automatically by the operator\n  # in the same namespace as the cluster.\n  csi.storage.k8s.io/provisioner-secret-name: rook-csi-cephfs-provisioner\n  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph\n  csi.storage.k8s.io/controller-expand-secret-name: rook-csi-cephfs-provisioner\n  csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph\n  csi.storage.k8s.io/node-stage-secret-name: rook-csi-cephfs-node\n  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph\n\nreclaimPolicy: Retain\nallowVolumeExpansion: true\nmountOptions:\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 StorageClass \u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff0c\u73b0\u5728 Wordpress \u7684 PVC \u5bf9\u8c61\u4f7f\u7528\u6211\u4eec\u8fd9\u91cc\u7684 <code>csi-cephfs</code> \u8fd9\u4e2a StorageClass \u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: wordpress-pvc\n  namespace: kube-example\n  labels:\n    app: wordpress\nspec:\n  storageClassName: csi-cephfs\n  accessModes:\n  - ReadWriteMany  # \u7531\u4e8e\u662f\u591a\u4e2aPod\u6240\u4ee5\u8981\u7528 RWM\n  resources:\n    requests:\n      storage: 2Gi\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get pvc -n kube-example\nNAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE\nmysql-pvc       Bound    pvc-93e0b186-da20-4e5e-8414-8cc73e00bf64   20Gi       RWO            rook-ceph-block   45m\nwordpress-pvc   Bound    pvc-87675c58-407a-4b7e-be9d-0733f67c4835   2Gi        RWX            csi-cephfs        5s\n</code></pre> <p>\u5728\u4f7f\u7528 CephFS \u7684\u8fc7\u7a0b\u4e2d\u9047\u5230\u4e86\u4e0a\u9762\u7684 PVC \u4e00\u76f4\u5904\u4e8e Pending \u72b6\u6001\uff0c\u7136\u540e describe \u540e\u53d1\u73b0\u6709\u5982\u4e0b\u6240\u793a\u7684\u9519\u8bef\u4fe1\u606f\uff1a</p> <p></p> <p>\u4ece\u9519\u8bef\u4fe1\u606f\u4e0a\u9762\u6765\u770b\u662f\u5728\u901a\u8fc7 StorageClass \u53bb\u81ea\u52a8\u521b\u5efa PV \u7684\u65f6\u5019\u5c31\u51fa\u73b0\u4e86\u95ee\u9898\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u53bb\u68c0\u67e5 CSI \u7684 attach \u9636\u6bb5\uff1a</p> <pre><code>$ kubectl get pods -n rook-ceph |grep csi-cephfsplugin-provisioner\ncsi-cephfsplugin-provisioner-56c8b7ddf4-4s7fd          4/4     Running     0          18m\ncsi-cephfsplugin-provisioner-56c8b7ddf4-55sg6          4/4     Running     0          39m\n</code></pre> <p>\u7136\u540e\u67e5\u770b\u8fd9\u4e24\u4e2a Pod \u7684\u65e5\u5fd7\u53d1\u73b0\u90fd\u662f\u7c7b\u4f3c\u4e8e\u4e0b\u9762\u7684\u9519\u8bef\uff1a</p> <pre><code>I0304 10:04:823171       1 leaderelection.go:246] failed to acquire lease rook-ceph/rook-ceph-cephfs-csi-ceph-com\nI0304 10:04:344109       1 leaderelection.go:350] lock is held by csi-cephfsplugin-provisioner-56c8b7ddf4-rq4t6 and has not yet expired\n</code></pre> <p>\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u6709\u4e24\u4e2a\u526f\u672c\u7684 Provisioner\uff0c\u6b63\u5e38\u5e94\u8be5\u662f\u6709\u4e00\u4e2a\u63d0\u4f9b\u670d\u52a1\uff0c\u53e6\u5916\u4e00\u4e2a\u4f5c\u4e3a\u5907\u7528\u7684\uff0c\u901a\u8fc7\u83b7\u53d6\u5230\u5206\u5e03\u5f0f\u9501\u6765\u8868\u793a\u5f53\u524d\u7684 Pod \u662f\u5426\u662f leader\uff0c\u8fd9\u91cc\u4e24\u4e2a Pod \u90fd\u6ca1\u83b7\u53d6\u5230\uff0c\u5e94\u8be5\u5c31\u662f\u51fa\u73b0\u4e86\u901a\u4fe1\u95ee\u9898\uff0c\u7136\u540e\u5c06\u4e24\u4e2a Pod \u90fd\u91cd\u5efa\u540e\uff0c\u5176\u4e2d\u4e00\u4e2a Pod \u4fbf\u83b7\u53d6\u5230\u4e86 lease \u5bf9\u8c61\uff0c\u7136\u540e PVC \u4e5f\u6210\u529f\u7ed1\u5b9a\u4e0a\u4e86 PV\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684 PVC \u5df2\u7ecf\u81ea\u52a8\u7ed1\u5b9a\u5230 PV \u4e0a\u9762\u53bb\u4e86\uff0c\u8fd9\u4e2a\u5c31\u662f\u4e0a\u9762\u7684 StorageClass \u5b8c\u6210\u7684\u5de5\u4f5c\u3002\u7136\u540e\u5728 Wordpress \u5e94\u7528\u4e0a\u6dfb\u52a0\u5bf9 <code>/var/www/html</code> \u76ee\u5f55\u7684\u6302\u8f7d\u58f0\u660e\uff1a</p> <pre><code>volumeMounts:\n  - name: wordpress-data\n    mountPath: /var/www/html\nvolumes:\n- name: wordpress-data\n  persistentVolumeClaim:\n    claimName: wordpress-pvc\n</code></pre> <p>\u5728 MySQL \u5e94\u7528\u4e0a\u6dfb\u52a0\u5bf9 <code>/var/lib/mysql</code> \u76ee\u5f55\u7684\u6302\u8f7d\u58f0\u660e\uff1a</p> <pre><code>volumeMounts:\n  - name: mysql-data\n    mountPath: /var/lib/mysql\nvolumes:\n- name: mysql-data\n  persistentVolumeClaim:\n    claimName: mysql-pvc\n</code></pre> <p>\u91cd\u65b0\u66f4\u65b0\u5e94\u7528\u5373\u53ef\uff0c\u5728\u66f4\u65b0\u7684\u8fc7\u7a0b\u4e2d\u53d1\u73b0 MySQL \u542f\u52a8\u5931\u8d25\u4e86\uff0c\u62a5\u5982\u4e0b\u6240\u793a\u7684\u9519\u8bef\uff1a</p> <pre><code>......\n[ERROR] --initialize specified but the data directory has files in it. Aborting.\n</code></pre> <p>\u610f\u601d\u5c31\u662f <code>/var/lib/mysql</code> \u76ee\u5f55\u4e0b\u9762\u5df2\u7ecf\u6709\u6570\u636e\u4e86\uff0c\u5f53\u7136\u53ef\u4ee5\u6e05\u7a7a\u8be5\u76ee\u5f55\u7136\u540e\u91cd\u65b0\u521b\u5efa\u5373\u53ef\uff0c\u8fd9\u91cc\u53ef\u80fd\u662f <code>mysql:5.7</code> \u8fd9\u4e2a\u955c\u50cf\u7684 BUG\uff0c\u6240\u4ee5\u6211\u4eec\u66f4\u6539\u6210 <code>mysql:5.6</code> \u8fd9\u4e2a\u955c\u50cf\uff0c\u53bb\u6389\u4e4b\u524d\u6dfb\u52a0\u7684\u4e00\u4e2a\u8ba4\u8bc1\u53c2\u6570\uff1a</p> <pre><code>containers:\n- image: mysql:6\n  name: mysql\n  imagePullPolicy: IfNotPresent\n  args:\n  - --character-set-server=utf8mb4\n  - --collation-server=utf8mb4_unicode_ci\n</code></pre> <p>\u91cd\u65b0\u66f4\u65b0\u5c31\u53ef\u4ee5\u6b63\u5e38\u542f\u52a8\u4e86\u3002</p>"},{"location":"kubernetes_example/wordpress/#ingress","title":"Ingress","text":"<p>\u5bf9\u4e8e\u4e00\u4e2a\u7ebf\u4e0a\u7684\u5e94\u7528\u5bf9\u5916\u66b4\u9732\u670d\u52a1\u7528\u4e00\u4e2a\u57df\u540d\u663e\u7136\u662f\u66f4\u52a0\u5408\u9002\u7684\uff0c\u4e0a\u9762\u6211\u4eec\u4f7f\u7528\u7684 NodePort \u7c7b\u578b\u7684\u670d\u52a1\u4e0d\u9002\u5408\u7528\u4e8e\u7ebf\u4e0a\u751f\u4ea7\u73af\u5883\uff0c\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 Ingress \u5bf9\u8c61\u6765\u66b4\u9732\u670d\u52a1\uff0c\u7531\u4e8e\u6211\u4eec\u4f7f\u7528\u7684\u662f Traefik2.1 \u8fd9\u4e2a Ingress \u63a7\u5236\u5668\uff0c\u6240\u4ee5\u901a\u8fc7 IngressRoute \u5bf9\u8c61\u6765\u66b4\u9732\u6211\u4eec\u7684\u670d\u52a1\uff0c\u6b64\u5916\u4e3a\u4e86\u5b89\u5168\u6211\u4eec\u8fd8\u4f7f\u7528\u4e86 ACME \u6765\u81ea\u52a8\u83b7\u53d6 https \u7684\u8bc1\u4e66\uff0c\u5e76\u4e14\u901a\u8fc7\u4e00\u4e2a\u4e2d\u95f4\u4ef6\u5c06 http \u5f3a\u5236\u8df3\u8f6c\u5230 https \u670d\u52a1\uff1a(ingressroute.yaml)</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: wordpress-https\n  namespace: kube-example\nspec:\n  entryPoints:\n    - websecure\n  routes:\n  - match: Host(`wordpress.qikqiak.com`)\n    kind: Rule\n    services:\n    - name: wordpress\n      port: 80\n  tls:\n    certResolver: ali\n    domains:\n    - main: \"*.qikqiak.com\"\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: Middleware\nmetadata:\n  name: redirect-https\n  namespace: kube-example\nspec:\n  redirectScheme:\n    scheme: https\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: wordpress-http\n  namespace: kube-example\nspec:\n  entryPoints:\n    - web\n  routes:\n  - match: Host(`wordpress.qikqiak.com`)\n    kind: Rule\n    services:\n    - name: wordpress\n      port: 80\n    middlewares: \n    - name: redirect-https\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f ingressroute.yaml \ningressroute.traefik.containo.us/wordpress-https created\nmiddleware.traefik.containo.us/redirect-https created\ningressroute.traefik.containo.us/wordpress-http created\n</code></pre> <p>\u7136\u540e\u5bf9\u57df\u540d </p> <pre><code>wordpress.qikqiak.com\n</code></pre> <p>\u52a0\u4e0a\u5bf9\u5e94\u7684 DNS \u89e3\u6790\u5373\u53ef\u6b63\u5e38\u8bbf\u95ee\u4e86\uff0c\u8fd9\u6837\u5373\u4f7f\u6211\u4eec\u7684\u6570\u636e\u5e93\u6216\u8005 Wordpress \u5e94\u7528\u6302\u6389\u4e86\u4e5f\u4e0d\u4f1a\u4e22\u5931\u6570\u636e\u4e86\uff0c\u5230\u8fd9\u91cc\u5c31\u5b8c\u6210\u4e86\u6211\u4eec\u4e00\u4e2a\u751f\u4ea7\u7ea7\u522b\u5e94\u7528\u7684\u90e8\u7f72\uff0c\u867d\u7136\u5e94\u7528\u672c\u8eab\u5f88\u7b80\u5355\uff0c\u4f46\u662f\u5982\u679c\u771f\u7684\u8981\u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\u6211\u4eec\u9700\u8981\u5173\u6ce8\u7684\u5185\u5bb9\u5c31\u6bd4\u8f83\u591a\u4e86\uff0c\u5f53\u7136\u5bf9\u4e8e\u7ebf\u4e0a\u5e94\u7528\u9664\u4e86\u4e0a\u9762\u6211\u4eec\u63d0\u5230\u7684\u8fd8\u6709\u5f88\u591a\u503c\u5f97\u6211\u4eec\u5173\u6ce8\u7684\u5730\u65b9\uff0c\u6bd4\u5982\u76d1\u63a7\u62a5\u8b66\u3001\u65e5\u5fd7\u6536\u96c6\u7b49\u65b9\u9762\u90fd\u662f\u6211\u4eec\u5173\u6ce8\u7684\u5c42\u9762\uff0c\u8fd9\u4e9b\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u518d\u6162\u6162\u53bb\u4e86\u89e3\u3002</p> <p></p>"},{"location":"kubernetes_logs/architec/","title":"Grafana","text":""},{"location":"kubernetes_logs/architec/#_1","title":"\u65e5\u5fd7\u6536\u96c6\u67b6\u6784","text":"<p>\u524d\u9762\u6211\u4eec\u5b66\u4e60\u4e86 Kubernetes \u96c6\u7fa4\u4e2d\u76d1\u63a7\u7cfb\u7edf\u7684\u642d\u5efa\uff0c\u9664\u4e86\u5bf9\u96c6\u7fa4\u7684\u76d1\u63a7\u62a5\u8b66\u4e4b\u5916\uff0c\u8fd8\u6709\u4e00\u9879\u8fd0\u7ef4\u5de5\u4f5c\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u90a3\u5c31\u662f\u65e5\u5fd7\u7684\u6536\u96c6\u3002</p> <p>\u5e94\u7528\u7a0b\u5e8f\u548c\u7cfb\u7edf\u65e5\u5fd7\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u4e86\u89e3\u96c6\u7fa4\u5185\u90e8\u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u65e5\u5fd7\u5bf9\u4e8e\u6211\u4eec\u8c03\u8bd5\u95ee\u9898\u548c\u76d1\u89c6\u96c6\u7fa4\u60c5\u51b5\u4e5f\u662f\u975e\u5e38\u6709\u7528\u7684\u3002\u800c\u4e14\u5927\u90e8\u5206\u7684\u5e94\u7528\u90fd\u4f1a\u6709\u65e5\u5fd7\u8bb0\u5f55\uff0c\u5bf9\u4e8e\u4f20\u7edf\u7684\u5e94\u7528\u5927\u90e8\u5206\u90fd\u4f1a\u5199\u5165\u5230\u672c\u5730\u7684\u65e5\u5fd7\u6587\u4ef6\u4e4b\u4e2d\u3002\u5bf9\u4e8e\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\u5219\u66f4\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5c06\u65e5\u5fd7\u4fe1\u606f\u5199\u5165\u5230 stdout \u548c stderr \u5373\u53ef\uff0c\u5bb9\u5668\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5c31\u4f1a\u628a\u8fd9\u4e9b\u65e5\u5fd7\u8f93\u51fa\u5230\u5bbf\u4e3b\u673a\u4e0a\u7684\u4e00\u4e2a JSON \u6587\u4ef6\u4e4b\u4e2d\uff0c\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>docker logs</code> \u6216\u8005 <code>kubectl logs</code> \u6765\u67e5\u770b\u5230\u5bf9\u5e94\u7684\u65e5\u5fd7\u4fe1\u606f\u3002</p> <p>\u4f46\u662f\uff0c\u901a\u5e38\u6765\u8bf4\u5bb9\u5668\u5f15\u64ce\u6216\u8fd0\u884c\u65f6\u63d0\u4f9b\u7684\u529f\u80fd\u4e0d\u8db3\u4ee5\u8bb0\u5f55\u5b8c\u6574\u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u6bd4\u5982\uff0c\u5982\u679c\u5bb9\u5668\u5d29\u6e83\u4e86\u3001Pod \u88ab\u9a71\u9010\u4e86\u6216\u8005\u8282\u70b9\u6302\u6389\u4e86\uff0c\u6211\u4eec\u4ecd\u7136\u4e5f\u5e0c\u671b\u8bbf\u95ee\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u3002\u6240\u4ee5\uff0c\u65e5\u5fd7\u5e94\u8be5\u72ec\u7acb\u4e8e\u8282\u70b9\u3001Pod \u6216\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\uff0c\u8fd9\u79cd\u8bbe\u8ba1\u65b9\u5f0f\u88ab\u79f0\u4e3a </p> <pre><code>cluster-level-logging\n</code></pre> <p>\uff0c\u5373\u5b8c\u5168\u72ec\u7acb\u4e8e Kubernetes \u7cfb\u7edf\uff0c\u9700\u8981\u81ea\u5df1\u63d0\u4f9b\u5355\u72ec\u7684\u65e5\u5fd7\u540e\u7aef\u5b58\u50a8\u3001\u5206\u6790\u548c\u67e5\u8be2\u5de5\u5177\u3002</p>"},{"location":"kubernetes_logs/architec/#kubernetes","title":"Kubernetes \u4e2d\u7684\u57fa\u672c\u65e5\u5fd7","text":"<p>\u4e0b\u9762\u8fd9\u4e2a\u793a\u4f8b\u662f Kubernetes \u4e2d\u7684\u4e00\u4e2a\u57fa\u672c\u65e5\u5fd7\u8bb0\u5f55\u7684\u793a\u4f8b\uff0c\u76f4\u63a5\u5c06\u6570\u636e\u8f93\u51fa\u5230\u6807\u51c6\u8f93\u51fa\u6d41\uff0c\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\nspec:\n  containers:\n  - name: count\n    image: busybox\n    args: [/bin/sh, -c,\n            'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done']\n</code></pre> <p>\u5c06\u4e0a\u9762\u6587\u4ef6\u4fdd\u5b58\u4e3a counter-pod.yaml\uff0c\u8be5 Pod \u6bcf\u79d2\u8f93\u51fa\u4e00\u4e9b\u6587\u672c\u4fe1\u606f\uff0c\u521b\u5efa\u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl apply -f counter-pod.yaml\npod \"counter\" created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>kubectl logs</code> \u547d\u4ee4\u67e5\u770b\u65e5\u5fd7\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl logs counter\n0: Thu Dec 27 15:47:04 UTC 2018\n1: Thu Dec 27 15:47:05 UTC 2018\n2: Thu Dec 27 15:47:06 UTC 2018\n3: Thu Dec 27 15:47:07 UTC 2018\n......\n</code></pre>"},{"location":"kubernetes_logs/architec/#kubernetes_1","title":"Kubernetes \u65e5\u5fd7\u6536\u96c6","text":"<p>Kubernetes \u96c6\u7fa4\u672c\u8eab\u4e0d\u63d0\u4f9b\u65e5\u5fd7\u6536\u96c6\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u4e00\u822c\u6765\u8bf4\u6709\u4e3b\u8981\u76843\u79cd\u65b9\u6848\u6765\u505a\u65e5\u5fd7\u6536\u96c6\uff1a</p> <ul> <li>\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a agent \u6765\u6536\u96c6\u65e5\u5fd7</li> <li>\u5728 Pod \u4e2d\u5305\u542b\u4e00\u4e2a sidecar \u5bb9\u5668\u6765\u6536\u96c6\u5e94\u7528\u65e5\u5fd7</li> <li>\u76f4\u63a5\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5c06\u65e5\u5fd7\u4fe1\u606f\u63a8\u9001\u5230\u91c7\u96c6\u540e\u7aef</li> </ul>"},{"location":"kubernetes_logs/architec/#_2","title":"\u8282\u70b9\u65e5\u5fd7\u91c7\u96c6\u4ee3\u7406","text":"<p>\u901a\u8fc7\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u65e5\u5fd7\u6536\u96c6\u7684 agent \u6765\u91c7\u96c6\u65e5\u5fd7\u6570\u636e\uff0c\u65e5\u5fd7\u91c7\u96c6 agent \u662f\u4e00\u79cd\u4e13\u7528\u5de5\u5177\uff0c\u7528\u4e8e\u5c06\u65e5\u5fd7\u6570\u636e\u63a8\u9001\u5230\u7edf\u4e00\u7684\u540e\u7aef\u3002\u4e00\u822c\u6765\u8bf4\uff0c\u8fd9\u79cd agent \u7528\u4e00\u4e2a\u5bb9\u5668\u6765\u8fd0\u884c\uff0c\u53ef\u4ee5\u8bbf\u95ee\u8be5\u8282\u70b9\u4e0a\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u7684\u65e5\u5fd7\u6587\u4ef6\u6240\u5728\u76ee\u5f55\u3002</p> <p>\u7531\u4e8e\u8fd9\u79cd agent \u5fc5\u987b\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\uff0c\u6240\u4ee5\u76f4\u63a5\u4f7f\u7528 DaemonSet \u63a7\u5236\u5668\u8fd0\u884c\u8be5\u5e94\u7528\u7a0b\u5e8f\u5373\u53ef\u3002\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u65e5\u5fd7\u6536\u96c6\u7684 agent \u8fd9\u79cd\u65b9\u5f0f\u662f\u6700\u5e38\u89c1\u7684\u4e00\u76f4\u65b9\u6cd5\uff0c\u56e0\u4e3a\u5b83\u53ea\u9700\u8981\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u4ee3\u7406\u7a0b\u5e8f\uff0c\u5e76\u4e0d\u9700\u8981\u5bf9\u8282\u70b9\u4e0a\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u66f4\u6539\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6ca1\u6709\u4efb\u4f55\u4fb5\u5165\u6027\uff0c\u4f46\u662f\u8fd9\u79cd\u65b9\u6cd5\u4e5f\u4ec5\u4ec5\u9002\u7528\u4e8e\u6536\u96c6\u8f93\u51fa\u5230 stdout \u548c stderr \u7684\u5e94\u7528\u7a0b\u5e8f\u65e5\u5fd7\u3002</p>"},{"location":"kubernetes_logs/architec/#sidecar","title":"\u4ee5 sidecar \u5bb9\u5668\u6536\u96c6\u65e5\u5fd7","text":"<p>\u6211\u4eec\u770b\u4e0a\u9762\u7684\u56fe\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a\u660e\u663e\u7684\u95ee\u9898\u5c31\u662f\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u90fd\u662f\u901a\u8fc7\u8f93\u51fa\u5230\u5bb9\u5668\u7684 stdout \u548c stderr \u91cc\u9762\u7684\u4fe1\u606f\uff0c\u8fd9\u4e9b\u4fe1\u606f\u4f1a\u5728\u672c\u5730\u7684\u5bb9\u5668\u5bf9\u5e94\u76ee\u5f55\u4e2d\u4fdd\u7559\u6210 JSON \u65e5\u5fd7\u6587\u4ef6\uff0c\u6240\u4ee5\u76f4\u63a5\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a agent \u5c31\u53ef\u4ee5\u91c7\u96c6\u5230\u65e5\u5fd7\u3002\u4f46\u662f\u5982\u679c\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u662f\u8f93\u51fa\u5230\u5bb9\u5668\u4e2d\u7684\u67d0\u4e2a\u65e5\u5fd7\u6587\u4ef6\u7684\u8bdd\u5462\uff1f\u8fd9\u79cd\u65e5\u5fd7\u6570\u636e\u663e\u7136\u53ea\u901a\u8fc7\u4e0a\u9762\u7684\u65b9\u6848\u662f\u91c7\u96c6\u4e0d\u5230\u7684\u4e86\u3002</p>"},{"location":"kubernetes_logs/architec/#sidecar_1","title":"\u7528 sidecar \u5bb9\u5668\u91cd\u65b0\u8f93\u51fa\u65e5\u5fd7","text":"<p>\u5bf9\u4e8e\u4e0a\u9762\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728 Pod \u4e2d\u542f\u52a8\u53e6\u5916\u4e00\u4e2a sidecar \u5bb9\u5668\uff0c\u76f4\u63a5\u5c06\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u901a\u8fc7\u8fd9\u4e2a\u5bb9\u5668\u91cd\u65b0\u8f93\u51fa\u5230 stdout\uff0c\u8fd9\u6837\u662f\u4e0d\u662f\u901a\u8fc7\u4e0a\u9762\u7684\u8282\u70b9\u65e5\u5fd7\u6536\u96c6\u65b9\u6848\u53c8\u53ef\u4ee5\u5b8c\u6210\u4e86\u3002</p> <p>\u7531\u4e8e\u8fd9\u4e2a sidecar \u5bb9\u5668\u7684\u4e3b\u8981\u903b\u8f91\u5c31\u662f\u5c06\u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684\u65e5\u5fd7\u8fdb\u884c\u91cd\u5b9a\u5411\u6253\u5370\uff0c\u6240\u4ee5\u80cc\u540e\u7684\u903b\u8f91\u975e\u5e38\u7b80\u5355\uff0c\u5f00\u9500\u5f88\u5c0f\uff0c\u800c\u4e14\u7531\u4e8e\u8f93\u51fa\u5230\u4e86 stdout \u6216\u8005 stderr\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 kubectl logs \u6765\u67e5\u770b\u65e5\u5fd7\u4e86\u3002</p> <p>\u4e0b\u9762\u7684\u793a\u4f8b\u662f\u5728 Pod \u4e2d\u5c06\u65e5\u5fd7\u8bb0\u5f55\u5728\u4e86\u5bb9\u5668\u7684\u4e24\u4e2a\u672c\u5730\u6587\u4ef6\u4e4b\u4e2d\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\nspec:\n  containers:\n  - name: count\n    image: busybox\n    args:\n    - /bin/sh\n    - -c\n    - &gt;\n      i=0;\n      while true;\n      do\n        echo \"$i: $(date)\" &gt;&gt; /var/log/log;\n        echo \"$(date) INFO $i\" &gt;&gt; /var/log/log;\n        i=$((i+1));\n        sleep 1;\n      done\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  volumes:\n  - name: varlog\n    emptyDir: {}\n</code></pre> <p>\u7531\u4e8e Pod \u4e2d\u5bb9\u5668\u7684\u7279\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u53e6\u5916\u4e00\u4e2a sidecar \u5bb9\u5668\u53bb\u83b7\u53d6\u5230\u53e6\u5916\u5bb9\u5668\u4e2d\u7684\u65e5\u5fd7\u6587\u4ef6\uff0c\u7136\u540e\u5c06\u65e5\u5fd7\u91cd\u5b9a\u5411\u5230\u81ea\u5df1\u7684 stdout \u6d41\u4e2d\uff0c\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u505a\u5982\u4e0b\u4fee\u6539\uff1a\uff08two-files-counter-pod-streaming-sidecar.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\nspec:\n  containers:\n  - name: count\n    image: busybox\n    args:\n    - /bin/sh\n    - -c\n    - &gt;\n      i=0;\n      while true;\n      do\n        echo \"$i: $(date)\" &gt;&gt; /var/log/log;\n        echo \"$(date) INFO $i\" &gt;&gt; /var/log/log;\n        i=$((i+1));\n        sleep 1;\n      done\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  - name: count-log-1\n    image: busybox\n    args: [/bin/sh, -c, 'tail -n+1 -f /var/log/log']\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  - name: count-log-2\n    image: busybox\n    args: [/bin/sh, -c, 'tail -n+1 -f /var/log/log']\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  volumes:\n  - name: varlog\n    emptyDir: {}\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl apply -f two-files-counter-pod-streaming-sidecar.yaml\npod \"counter\" created\n</code></pre> <p>\u8fd0\u884c\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b\u65e5\u5fd7\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl logs counter count-log-1\n0: Mon Jan  1 00:00:00 UTC 2001\n1: Mon Jan  1 00:00:01 UTC 2001\n2: Mon Jan  1 00:00:02 UTC 2001\n...\n$ kubectl logs counter count-log-2\nMon Jan  1 00:00:00 UTC 2001 INFO 0\nMon Jan  1 00:00:01 UTC 2001 INFO 1\nMon Jan  1 00:00:02 UTC 2001 INFO 2\n...\n</code></pre> <p>\u8fd9\u6837\u524d\u9762\u8282\u70b9\u4e0a\u7684\u65e5\u5fd7\u91c7\u96c6 agent \u5c31\u53ef\u4ee5\u81ea\u52a8\u83b7\u53d6\u8fd9\u4e9b\u65e5\u5fd7\u4fe1\u606f\uff0c\u800c\u4e0d\u9700\u8981\u5176\u4ed6\u914d\u7f6e\u3002</p> <p>\u8fd9\u79cd\u65b9\u6cd5\u867d\u7136\u53ef\u4ee5\u89e3\u51b3\u4e0a\u9762\u7684\u95ee\u9898\uff0c\u4f46\u662f\u4e5f\u6709\u4e00\u4e2a\u660e\u663e\u7684\u7f3a\u9677\uff0c\u5c31\u662f\u65e5\u5fd7\u4e0d\u4ec5\u4f1a\u5728\u539f\u5bb9\u5668\u6587\u4ef6\u4e2d\u4fdd\u7559\u4e0b\u6765\uff0c\u8fd8\u4f1a\u901a\u8fc7 stdout \u8f93\u51fa\u540e\u5360\u7528\u78c1\u76d8\u7a7a\u95f4\uff0c\u8fd9\u6837\u65e0\u5f62\u4e2d\u5c31\u589e\u52a0\u4e86\u4e00\u500d\u78c1\u76d8\u7a7a\u95f4\u3002</p>"},{"location":"kubernetes_logs/architec/#sidecar_agent","title":"\u4f7f\u7528 sidecar \u8fd0\u884c\u65e5\u5fd7\u91c7\u96c6 agent","text":"<p>\u5982\u679c\u4f60\u89c9\u5f97\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u65e5\u5fd7\u91c7\u96c6\u7684\u4ee3\u7406\u4e0d\u591f\u7075\u6d3b\u7684\u8bdd\uff0c\u90a3\u4e48\u4f60\u4e5f\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u65e5\u5fd7\u91c7\u96c6\u4ee3\u7406\u7a0b\u5e8f\u7684 sidecar \u5bb9\u5668\uff0c\u4e0d\u8fc7\u9700\u8981\u5355\u72ec\u914d\u7f6e\u548c\u5e94\u7528\u7a0b\u5e8f\u4e00\u8d77\u8fd0\u884c\u3002</p> <p>\u4e0d\u8fc7\u8fd9\u6837\u867d\u7136\u66f4\u52a0\u7075\u6d3b\uff0c\u4f46\u662f\u5728 sidecar \u5bb9\u5668\u4e2d\u8fd0\u884c\u65e5\u5fd7\u91c7\u96c6\u4ee3\u7406\u7a0b\u5e8f\u4f1a\u5bfc\u81f4\u5927\u91cf\u8d44\u6e90\u6d88\u8017\uff0c\u56e0\u4e3a\u4f60\u6709\u591a\u5c11\u4e2a\u8981\u91c7\u96c6\u7684 Pod\uff0c\u5c31\u9700\u8981\u8fd0\u884c\u591a\u5c11\u4e2a\u91c7\u96c6\u4ee3\u7406\u7a0b\u5e8f\uff0c\u53e6\u5916\u8fd8\u65e0\u6cd5\u4f7f\u7528 kubectl logs \u547d\u4ee4\u6765\u8bbf\u95ee\u8fd9\u4e9b\u65e5\u5fd7\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e0d\u53d7 kubelet \u63a7\u5236\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u7684 Stackdriver\uff0c\u5b83\u4f7f\u7528 fluentd \u4f5c\u4e3a\u8bb0\u5f55\u5242\u3002\u4ee5\u4e0b\u662f\u4e24\u4e2a\u53ef\u7528\u4e8e\u5b9e\u73b0\u6b64\u65b9\u6cd5\u7684\u914d\u7f6e\u6587\u4ef6\u3002\u7b2c\u4e00\u4e2a\u6587\u4ef6\u5305\u542b\u914d\u7f6e\u6d41\u5229\u7684 ConfigMap\u3002</p> <p>\u4e0b\u9762\u662f Kubernetes \u5b98\u65b9\u7684\u4e00\u4e2a fluentd \u7684\u914d\u7f6e\u6587\u4ef6\u793a\u4f8b\uff0c\u4f7f\u7528 ConfigMap \u5bf9\u8c61\u6765\u4fdd\u5b58\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: fluentd-config\ndata:\n  fluentd.conf: |\n    &lt;source&gt;\n      type tail\n      format none\n      path /var/log/log\n      pos_file /var/log/log.pos\n      tag count.format1\n    &lt;/source&gt;\n\n    &lt;source&gt;\n      type tail\n      format none\n      path /var/log/log\n      pos_file /var/log/log.pos\n      tag count.format2\n    &lt;/source&gt;\n\n    &lt;match **&gt;\n      type google_cloud\n    &lt;/match&gt;\n</code></pre> <p>\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u662f\u914d\u7f6e\u6536\u96c6\u539f\u6587\u4ef6 <code>/var/log/1.log</code> \u548c <code>/var/log/2.log</code> \u7684\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u901a\u8fc7 google_cloud \u8fd9\u4e2a\u63d2\u4ef6\u5c06\u6570\u636e\u63a8\u9001\u5230 Stackdriver \u540e\u7aef\u53bb\u3002</p> <p>\u4e0b\u9762\u662f\u6211\u4eec\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u8fd0\u884c\u4e00\u4e2a fluentd \u7684\u5bb9\u5668\u6765\u8bfb\u53d6\u65e5\u5fd7\u6570\u636e\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\nspec:\n  containers:\n  - name: count\n    image: busybox\n    args:\n    - /bin/sh\n    - -c\n    - &gt;\n      i=0;\n      while true;\n      do\n        echo \"$i: $(date)\" &gt;&gt; /var/log/log;\n        echo \"$(date) INFO $i\" &gt;&gt; /var/log/log;\n        i=$((i+1));\n        sleep 1;\n      done\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  - name: count-agent\n    image: k8s.gcr.io/fluentd-gcp:30\n    env:\n    - name: FLUENTD_ARGS\n      value: -c /etc/fluentd-config/fluentd.conf\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n    - name: config-volume\n      mountPath: /etc/fluentd-config\n  volumes:\n  - name: varlog\n    emptyDir: {}\n  - name: config-volume\n    configMap:\n      name: fluentd-config\n</code></pre> <p>\u4e0a\u9762\u7684 Pod \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u5bb9\u5668 count-agent \u5c31\u4f1a\u5c06 count \u5bb9\u5668\u4e2d\u7684\u65e5\u5fd7\u8fdb\u884c\u6536\u96c6\u7136\u540e\u4e0a\u4f20\u3002\u5f53\u7136\uff0c\u8fd9\u53ea\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\uff0c\u6211\u4eec\u4e5f\u5b8c\u5168\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u7684\u4efb\u4f55\u65e5\u5fd7\u91c7\u96c6\u5de5\u5177\u6765\u66ff\u6362 fluentd\uff0c\u6bd4\u5982 logstash\u3001fluent-bit \u7b49\u7b49\u3002</p>"},{"location":"kubernetes_logs/architec/#_3","title":"\u76f4\u63a5\u4ece\u5e94\u7528\u7a0b\u5e8f\u6536\u96c6\u65e5\u5fd7","text":"<p>\u9664\u4e86\u4e0a\u9762\u7684\u51e0\u79cd\u65b9\u6848\u4e4b\u5916\uff0c\u6211\u4eec\u4e5f\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7\u76f4\u63a5\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u53bb\u663e\u793a\u7684\u5c06\u65e5\u5fd7\u63a8\u9001\u5230\u65e5\u5fd7\u540e\u7aef\uff0c\u4f46\u662f\u8fd9\u79cd\u65b9\u5f0f\u9700\u8981\u4ee3\u7801\u5c42\u9762\u7684\u5b9e\u73b0\uff0c\u4e5f\u8d85\u51fa\u4e86 Kubernetes \u672c\u8eab\u7684\u8303\u56f4\u3002\u4e0b\u8282\u8bfe\u6211\u4eec\u7ed9\u5927\u5bb6\u6f14\u793a\u4e0b\u5177\u4f53\u7684\u65e5\u5fd7\u6536\u96c6\u7684\u64cd\u4f5c\u65b9\u6cd5\u3002</p>"},{"location":"kubernetes_logs/efk/","title":"efk","text":""},{"location":"kubernetes_logs/efk/#efk","title":"\u642d\u5efa EFK \u65e5\u5fd7\u7cfb\u7edf","text":"<p>\u524d\u9762\u5927\u5bb6\u4ecb\u7ecd\u4e86 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u51e0\u79cd\u65e5\u5fd7\u6536\u96c6\u65b9\u6848\uff0cKubernetes \u4e2d\u6bd4\u8f83\u6d41\u884c\u7684\u65e5\u5fd7\u6536\u96c6\u89e3\u51b3\u65b9\u6848\u662f Elasticsearch\u3001Fluentd \u548c Kibana\uff08EFK\uff09\u6280\u672f\u6808\uff0c\u4e5f\u662f\u5b98\u65b9\u73b0\u5728\u6bd4\u8f83\u63a8\u8350\u7684\u4e00\u79cd\u65b9\u6848\u3002</p> <p><code>Elasticsearch</code> \u662f\u4e00\u4e2a\u5b9e\u65f6\u7684\u3001\u5206\u5e03\u5f0f\u7684\u53ef\u6269\u5c55\u7684\u641c\u7d22\u5f15\u64ce\uff0c\u5141\u8bb8\u8fdb\u884c\u5168\u6587\u3001\u7ed3\u6784\u5316\u641c\u7d22\uff0c\u5b83\u901a\u5e38\u7528\u4e8e\u7d22\u5f15\u548c\u641c\u7d22\u5927\u91cf\u65e5\u5fd7\u6570\u636e\uff0c\u4e5f\u53ef\u7528\u4e8e\u641c\u7d22\u8bb8\u591a\u4e0d\u540c\u7c7b\u578b\u7684\u6587\u6863\u3002</p> <p>Elasticsearch \u901a\u5e38\u4e0e <code>Kibana</code> \u4e00\u8d77\u90e8\u7f72\uff0cKibana \u662f Elasticsearch \u7684\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u6570\u636e\u53ef\u89c6\u5316 Dashboard\uff0cKibana \u5141\u8bb8\u4f60\u901a\u8fc7 web \u754c\u9762\u6765\u6d4f\u89c8 Elasticsearch \u65e5\u5fd7\u6570\u636e\u3002</p> <p><code>Fluentd</code>\u662f\u4e00\u4e2a\u6d41\u884c\u7684\u5f00\u6e90\u6570\u636e\u6536\u96c6\u5668\uff0c\u6211\u4eec\u5c06\u5728 Kubernetes \u96c6\u7fa4\u8282\u70b9\u4e0a\u5b89\u88c5 Fluentd\uff0c\u901a\u8fc7\u83b7\u53d6\u5bb9\u5668\u65e5\u5fd7\u6587\u4ef6\u3001\u8fc7\u6ee4\u548c\u8f6c\u6362\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u5c06\u6570\u636e\u4f20\u9012\u5230 Elasticsearch \u96c6\u7fa4\uff0c\u5728\u8be5\u96c6\u7fa4\u4e2d\u5bf9\u5176\u8fdb\u884c\u7d22\u5f15\u548c\u5b58\u50a8\u3002</p> <p>\u6211\u4eec\u5148\u6765\u914d\u7f6e\u542f\u52a8\u4e00\u4e2a\u53ef\u6269\u5c55\u7684 Elasticsearch \u96c6\u7fa4\uff0c\u7136\u540e\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u521b\u5efa\u4e00\u4e2a Kibana \u5e94\u7528\uff0c\u6700\u540e\u901a\u8fc7 DaemonSet \u6765\u8fd0\u884c Fluentd\uff0c\u4ee5\u4fbf\u5b83\u5728\u6bcf\u4e2a Kubernetes \u5de5\u4f5c\u8282\u70b9\u4e0a\u90fd\u53ef\u4ee5\u8fd0\u884c\u4e00\u4e2a Pod\u3002</p> <p>\u63d0\u793a</p> <p>\u5982\u679c\u4f60\u4e86\u89e3 EFK \u7684\u57fa\u672c\u539f\u7406\uff0c\u53ea\u662f\u4e3a\u4e86\u6d4b\u8bd5\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Kubernetes \u5b98\u65b9\u63d0\u4f9b\u7684 addon \u63d2\u4ef6\u7684\u8d44\u6e90\u6e05\u5355\uff0c\u5730\u5740\uff1ahttps://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/\uff0c\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\u3002</p>"},{"location":"kubernetes_logs/efk/#elasticsearch","title":"\u521b\u5efa Elasticsearch \u96c6\u7fa4","text":"<p>\u5728\u521b\u5efa Elasticsearch \u96c6\u7fa4\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u521b\u5efa\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u6211\u4eec\u5c06\u5728\u5176\u4e2d\u5b89\u88c5\u6240\u6709\u65e5\u5fd7\u76f8\u5173\u7684\u8d44\u6e90\u5bf9\u8c61\u3002</p> <p>\u65b0\u5efa\u4e00\u4e2a kube-logging.yaml \u6587\u4ef6\uff1a</p> <pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\n  name: logging\n</code></pre> <p>\u7136\u540e\u901a\u8fc7 kubectl \u521b\u5efa\u8be5\u8d44\u6e90\u6e05\u5355\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a logging \u7684 namespace\uff1a</p> <pre><code>$ kubectl create -f kube-logging.yaml\nnamespace/logging created\n$ kubectl get ns\nNAME           STATUS    AGE\ndefault        Active    244d\nistio-system   Active    100d\nkube-ops       Active    179d\nkube-public    Active    244d\nkube-system    Active    244d\nlogging        Active    4h\nmonitoring     Active    35d\n</code></pre> <p>\u73b0\u5728\u521b\u5efa\u4e86\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u6765\u5b58\u653e\u6211\u4eec\u7684\u65e5\u5fd7\u76f8\u5173\u8d44\u6e90\uff0c\u63a5\u4e0b\u6765\u53ef\u4ee5\u90e8\u7f72 EFK \u76f8\u5173\u7ec4\u4ef6\uff0c\u9996\u5148\u5f00\u59cb\u90e8\u7f72\u4e00\u4e2a3\u8282\u70b9\u7684 Elasticsearch \u96c6\u7fa4\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u4f7f\u75283\u4e2a Elasticsearch Pod \u6765\u907f\u514d\u9ad8\u53ef\u7528\u4e0b\u591a\u8282\u70b9\u96c6\u7fa4\u4e2d\u51fa\u73b0\u7684\u8111\u88c2\u95ee\u9898\uff0c\u5f53\u4e00\u4e2a\u6216\u591a\u4e2a\u8282\u70b9\u65e0\u6cd5\u4e0e\u5176\u4ed6\u8282\u70b9\u901a\u4fe1\u65f6\u4f1a\u4ea7\u751f\u8111\u88c2\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u51e0\u4e2a\u4e3b\u8282\u70b9\u3002</p> <p>\u4e86\u89e3\u66f4\u591a Elasticsearch \u96c6\u7fa4\u8111\u88c2\u95ee\u9898\uff0c\u53ef\u4ee5\u67e5\u770b\u6587\u6863https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#split-brain</p> <p>\u4e00\u4e2a\u5173\u952e\u70b9\u662f\u60a8\u5e94\u8be5\u8bbe\u7f6e\u53c2\u6570</p> <pre><code>discover.zen.minimum_master_nodes=N/2+1\n</code></pre> <p>\uff0c\u5176\u4e2d<code>N</code>\u662f Elasticsearch \u96c6\u7fa4\u4e2d\u7b26\u5408\u4e3b\u8282\u70b9\u7684\u8282\u70b9\u6570\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc3\u4e2a\u8282\u70b9\uff0c\u610f\u5473\u7740<code>N</code>\u5e94\u8be5\u8bbe\u7f6e\u4e3a2\u3002\u8fd9\u6837\uff0c\u5982\u679c\u4e00\u4e2a\u8282\u70b9\u6682\u65f6\u4e0e\u96c6\u7fa4\u65ad\u5f00\u8fde\u63a5\uff0c\u5219\u53e6\u5916\u4e24\u4e2a\u8282\u70b9\u53ef\u4ee5\u9009\u62e9\u4e00\u4e2a\u65b0\u7684\u4e3b\u8282\u70b9\uff0c\u5e76\u4e14\u96c6\u7fa4\u53ef\u4ee5\u5728\u6700\u540e\u4e00\u4e2a\u8282\u70b9\u5c1d\u8bd5\u91cd\u65b0\u52a0\u5165\u65f6\u7ee7\u7eed\u8fd0\u884c\uff0c\u5728\u6269\u5c55 Elasticsearch \u96c6\u7fa4\u65f6\uff0c\u4e00\u5b9a\u8981\u8bb0\u4f4f\u8fd9\u4e2a\u53c2\u6570\u3002</p> <p>\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a elasticsearch \u7684\u65e0\u5934\u670d\u52a1\uff0c\u65b0\u5efa\u6587\u4ef6 elasticsearch-svc.yaml\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\n  name: elasticsearch\n  namespace: logging\n  labels:\n    app: elasticsearch\nspec:\n  selector:\n    app: elasticsearch\n  clusterIP: None\n  ports:\n    - port: 9200\n      name: rest\n    - port: 9300\n      name: inter-node\n</code></pre> <p>\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a elasticsearch \u7684 Service\uff0c\u6307\u5b9a\u6807\u7b7e <code>app=elasticsearch</code>\uff0c\u5f53\u6211\u4eec\u5c06 Elasticsearch StatefulSet \u4e0e\u6b64\u670d\u52a1\u5173\u8054\u65f6\uff0c\u670d\u52a1\u5c06\u8fd4\u56de\u5e26\u6709\u6807\u7b7e <code>app=elasticsearch</code>\u7684 Elasticsearch Pods \u7684 DNS A \u8bb0\u5f55\uff0c\u7136\u540e\u8bbe\u7f6e <code>clusterIP=None</code>\uff0c\u5c06\u8be5\u670d\u52a1\u8bbe\u7f6e\u6210\u65e0\u5934\u670d\u52a1\u3002\u6700\u540e\uff0c\u6211\u4eec\u5206\u522b\u5b9a\u4e49\u7aef\u53e39200\u30019300\uff0c\u5206\u522b\u7528\u4e8e\u4e0e REST API \u4ea4\u4e92\uff0c\u4ee5\u53ca\u7528\u4e8e\u8282\u70b9\u95f4\u901a\u4fe1\u3002</p> <p>\u4f7f\u7528 kubectl \u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u670d\u52a1\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f elasticsearch-svc.yaml\nservice/elasticsearch created\n$ kubectl get services --namespace=logging\nOutput\nNAME            TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE\nelasticsearch   ClusterIP   None         &lt;none&gt;        9200/TCP,9300/TCP   26s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u4e3a Pod \u8bbe\u7f6e\u4e86\u65e0\u5934\u670d\u52a1\u548c\u4e00\u4e2a\u7a33\u5b9a\u7684\u57df\u540d</p> <pre><code>.elasticsearch.logging.svc.cluster.local\n</code></pre> <p>\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u901a\u8fc7 StatefulSet \u6765\u521b\u5efa\u5177\u4f53\u7684 Elasticsearch \u7684 Pod \u5e94\u7528\u3002</p> <p>Kubernetes StatefulSet \u5141\u8bb8\u6211\u4eec\u4e3a Pod \u5206\u914d\u4e00\u4e2a\u7a33\u5b9a\u7684\u6807\u8bc6\u548c\u6301\u4e45\u5316\u5b58\u50a8\uff0cElasticsearch \u9700\u8981\u7a33\u5b9a\u7684\u5b58\u50a8\u6765\u4fdd\u8bc1 Pod \u5728\u91cd\u65b0\u8c03\u5ea6\u6216\u8005\u91cd\u542f\u540e\u7684\u6570\u636e\u4f9d\u7136\u4e0d\u53d8\uff0c\u6240\u4ee5\u9700\u8981\u4f7f\u7528 StatefulSet \u6765\u7ba1\u7406 Pod\u3002</p> <p>\u8981\u4e86\u89e3\u66f4\u591a\u5173\u4e8e StaefulSet \u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u67e5\u770b\u5b98\u7f51\u5173\u4e8e StatefulSet \u7684\u76f8\u5173\u6587\u6863\uff1ahttps://kubernetes.io/docs/concepts/workloads/controllers/statefulset/\u3002</p> <p>\u65b0\u5efa\u540d\u4e3a elasticsearch-statefulset.yaml \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u9996\u5148\u7c98\u8d34\u4e0b\u9762\u5185\u5bb9\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: es\n  namespace: logging\nspec:\n  serviceName: elasticsearch\n  replicas: 3\n  selector:\n    matchLabels:\n      app: elasticsearch\n  template:\n    metadata:\n      labels:\n        app: elasticsearch\n</code></pre> <p>\u8be5\u5185\u5bb9\u4e2d\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a es \u7684 StatefulSet \u5bf9\u8c61\uff0c\u7136\u540e\u5b9a\u4e49</p> <pre><code>serviceName=elasticsearch\n</code></pre> <p>\u548c\u524d\u9762\u521b\u5efa\u7684 Service \u76f8\u5173\u8054\uff0c\u8fd9\u53ef\u4ee5\u786e\u4fdd\u4f7f\u7528\u4ee5\u4e0b DNS \u5730\u5740\u8bbf\u95ee StatefulSet \u4e2d\u7684\u6bcf\u4e00\u4e2a Pod\uff1a</p> <pre><code>es-[0,1,2].elasticsearch.logging.svc.cluster.local\n</code></pre> <p>\uff0c\u5176\u4e2d[0,1,2]\u5bf9\u5e94\u4e8e\u5df2\u5206\u914d\u7684 Pod \u5e8f\u53f7\u3002</p> <p>\u7136\u540e\u6307\u5b9a3\u4e2a\u526f\u672c\uff0c\u5c06 matchLabels \u8bbe\u7f6e\u4e3a<code>app=elasticsearch</code>\uff0c\u6240\u4ee5 Pod \u7684\u6a21\u677f\u90e8\u5206</p> <pre><code>.spec.template.metadata.lables\n</code></pre> <p>\u4e5f\u5fc5\u987b\u5305\u542b<code>app=elasticsearch</code>\u6807\u7b7e\u3002</p> <p>\u7136\u540e\u5b9a\u4e49 Pod \u6a21\u677f\u90e8\u5206\u5185\u5bb9\uff1a</p> <pre><code>...\n  spec:\n    containers:\n    - name: elasticsearch\n      image: docker.elastic.co/elasticsearch/elasticsearch:2\n      resources:\n        limits:\n          cpu: 1000m\n        requests:\n          cpu: 100m\n      ports:\n      - containerPort: 9200\n        name: rest\n        protocol: TCP\n      - containerPort: 9300\n        name: inter-node\n        protocol: TCP\n      volumeMounts:\n      - name: data\n        mountPath: /usr/share/elasticsearch/data\n      env:\n        - name: cluster.name\n          value: k8s-logs\n        - name: node.name\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        - name: cluster.initial_master_nodes\n          value: \"es-0,es-1,es-2\"\n        - name: discovery.zen.minimum_master_nodes\n          value: \"2\"\n        - name: discovery.seed_hosts\n          value: \"elasticsearch\"\n        - name: ES_JAVA_OPTS\n          value: \"-Xms512m -Xmx512m\"\n        - name: network.host\n          value: \"0\"\n</code></pre> <p>\u8be5\u90e8\u5206\u662f\u5b9a\u4e49 StatefulSet \u4e2d\u7684 Pod\uff0c\u66b4\u9732\u4e869200\u548c9300\u4e24\u4e2a\u7aef\u53e3\uff0c\u6ce8\u610f\u540d\u79f0\u8981\u548c\u4e0a\u9762\u5b9a\u4e49\u7684 Service \u4fdd\u6301\u4e00\u81f4\u3002\u7136\u540e\u901a\u8fc7 volumeMount \u58f0\u660e\u4e86\u6570\u636e\u6301\u4e45\u5316\u76ee\u5f55\uff0c\u4e0b\u9762\u6211\u4eec\u518d\u6765\u5b9a\u4e49 VolumeClaims\u3002\u6700\u540e\u5c31\u662f\u6211\u4eec\u5728\u5bb9\u5668\u4e2d\u8bbe\u7f6e\u7684\u4e00\u4e9b\u73af\u5883\u53d8\u91cf\u4e86\uff1a</p> <ul> <li>cluster.name\uff1aElasticsearch \u96c6\u7fa4\u7684\u540d\u79f0\uff0c\u6211\u4eec\u8fd9\u91cc\u547d\u540d\u6210 k8s-logs\u3002</li> <li>node.name\uff1a\u8282\u70b9\u7684\u540d\u79f0\uff0c\u901a\u8fc7 <code>metadata.name</code> \u6765\u83b7\u53d6\u3002\u8fd9\u5c06\u89e3\u6790\u4e3a es-[0,1,2]\uff0c\u53d6\u51b3\u4e8e\u8282\u70b9\u7684\u6307\u5b9a\u987a\u5e8f\u3002</li> <li> <p>discovery.seed_hosts\uff1a\u6b64\u5b57\u6bb5\u7528\u4e8e\u8bbe\u7f6e\u5728 Elasticsearch \u96c6\u7fa4\u4e2d\u8282\u70b9\u76f8\u4e92\u8fde\u63a5\u7684\u53d1\u73b0\u65b9\u6cd5\u3002\u7531\u4e8e\u6211\u4eec\u4e4b\u524d\u914d\u7f6e\u7684\u65e0\u5934\u670d\u52a1\uff0c\u6211\u4eec\u7684 Pod \u5177\u6709\u552f\u4e00\u7684 DNS \u57df</p> <pre><code>es-[0,1,2].elasticsearch.logging.svc.cluster.local\n</code></pre> <p>\uff0c\u56e0\u6b64\u6211\u4eec\u76f8\u5e94\u5730\u8bbe\u7f6e\u6b64\u53d8\u91cf\u3002\u8981\u4e86\u89e3\u6709\u5173 Elasticsearch \u53d1\u73b0\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 Elasticsearch \u5b98\u65b9\u6587\u6863\uff1ahttps://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery.html\u3002 *   discovery.zen.minimum_master_nodes\uff1a\u6211\u4eec\u5c06\u5176\u8bbe\u7f6e\u4e3a<code>(N/2) + 1</code>\uff0c<code>N</code>\u662f\u6211\u4eec\u7684\u7fa4\u96c6\u4e2d\u7b26\u5408\u4e3b\u8282\u70b9\u7684\u8282\u70b9\u7684\u6570\u91cf\u3002\u6211\u4eec\u67093\u4e2a Elasticsearch \u8282\u70b9\uff0c\u56e0\u6b64\u6211\u4eec\u5c06\u6b64\u503c\u8bbe\u7f6e\u4e3a2\uff08\u5411\u4e0b\u820d\u5165\u5230\u6700\u63a5\u8fd1\u7684\u6574\u6570\uff09\u3002\u8981\u4e86\u89e3\u6709\u5173\u6b64\u53c2\u6570\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605\u5b98\u65b9 Elasticsearch \u6587\u6863\uff1ahttps://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#split-brain\u3002 *   ES_JAVA_OPTS\uff1a\u8fd9\u91cc\u6211\u4eec\u8bbe\u7f6e\u4e3a<code>-Xms512m -Xmx512m</code>\uff0c\u544a\u8bc9<code>JVM</code>\u4f7f\u7528<code>512 MB</code>\u7684\u6700\u5c0f\u548c\u6700\u5927\u5806\u3002\u60a8\u5e94\u8be5\u6839\u636e\u7fa4\u96c6\u7684\u8d44\u6e90\u53ef\u7528\u6027\u548c\u9700\u6c42\u8c03\u6574\u8fd9\u4e9b\u53c2\u6570\u3002\u8981\u4e86\u89e3\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605\u8bbe\u7f6e\u5806\u5927\u5c0f\u7684\u76f8\u5173\u6587\u6863\uff1ahttps://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html\u3002</p> </li> </ul> <p>\u63a5\u4e0b\u6765\u6dfb\u52a0\u5173\u4e8e initContainer \u7684\u5185\u5bb9\uff1a</p> <pre><code>...\n    initContainers:\n    - name: increase-vm-max-map\n      image: busybox\n      command: [\"sysctl\", \"-w\", \"vm.max_map_count=262144\"]\n      securityContext:\n        privileged: true\n    - name: increase-fd-ulimit\n      image: busybox\n      command: [\"sh\", \"-c\", \"ulimit -n 65536\"]\n      securityContext:\n        privileged: true\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e86\u51e0\u4e2a\u5728\u4e3b\u5e94\u7528\u7a0b\u5e8f\u4e4b\u524d\u8fd0\u884c\u7684 Init \u5bb9\u5668\uff0c\u8fd9\u4e9b\u521d\u59cb\u5bb9\u5668\u6309\u7167\u5b9a\u4e49\u7684\u987a\u5e8f\u4f9d\u6b21\u6267\u884c\uff0c\u6267\u884c\u5b8c\u6210\u540e\u624d\u4f1a\u542f\u52a8\u4e3b\u5e94\u7528\u5bb9\u5668\u3002</p> <p>\u7b2c\u4e00\u4e2a\u540d\u4e3a increase-vm-max-map \u7684\u5bb9\u5668\u7528\u6765\u589e\u52a0\u64cd\u4f5c\u7cfb\u7edf\u5bf9<code>mmap</code>\u8ba1\u6570\u7684\u9650\u5236\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8be5\u503c\u53ef\u80fd\u592a\u4f4e\uff0c\u5bfc\u81f4\u5185\u5b58\u4e0d\u8db3\u7684\u9519\u8bef\uff0c\u8981\u4e86\u89e3\u66f4\u591a\u5173\u4e8e\u8be5\u8bbe\u7f6e\u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u67e5\u770b Elasticsearch \u5b98\u65b9\u6587\u6863\u8bf4\u660e\uff1ahttps://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html\u3002</p> <p>\u6700\u540e\u4e00\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\u662f\u7528\u6765\u6267\u884c<code>ulimit</code>\u547d\u4ee4\u589e\u52a0\u6253\u5f00\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u6700\u5927\u6570\u91cf\u7684\u3002</p> <p>\u6b64\u5916 Elastisearch Notes for Production Use \u6587\u6863\u8fd8\u63d0\u5230\u4e86\u7531\u4e8e\u6027\u80fd\u539f\u56e0\u6700\u597d\u7981\u7528 swap\uff0c\u5f53\u7136\u5bf9\u4e8e Kubernetes \u96c6\u7fa4\u800c\u8a00\uff0c\u6700\u597d\u4e5f\u662f\u7981\u7528 swap \u5206\u533a\u7684\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u5b9a\u4e49\u4e86\u4e3b\u5e94\u7528\u5bb9\u5668\u548c\u5b83\u4e4b\u524d\u8fd0\u884c\u7684 Init Containers \u6765\u8c03\u6574\u4e00\u4e9b\u5fc5\u8981\u7684\u7cfb\u7edf\u53c2\u6570\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u6570\u636e\u76ee\u5f55\u7684\u6301\u4e45\u5316\u76f8\u5173\u7684\u914d\u7f6e\uff0c\u5728 StatefulSet \u4e2d\uff0c\u4f7f\u7528 volumeClaimTemplates \u6765\u5b9a\u4e49 volume \u6a21\u677f\u5373\u53ef\uff1a</p> <pre><code>...\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n      labels:\n        app: elasticsearch\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      storageClassName: rook-ceph-block\n      resources:\n        requests:\n          storage: 50Gi\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 volumeClaimTemplates \u6765\u5b9a\u4e49\u6301\u4e45\u5316\u6a21\u677f\uff0cKubernetes \u4f1a\u4f7f\u7528\u5b83\u4e3a Pod \u521b\u5efa PersistentVolume\uff0c\u8bbe\u7f6e\u8bbf\u95ee\u6a21\u5f0f\u4e3a<code>ReadWriteOnce</code>\uff0c\u8fd9\u610f\u5473\u7740\u5b83\u53ea\u80fd\u88ab mount \u5230\u5355\u4e2a\u8282\u70b9\u4e0a\u8fdb\u884c\u8bfb\u5199\uff0c\u7136\u540e\u6700\u91cd\u8981\u7684\u662f\u4f7f\u7528\u4e86\u4e00\u4e2a StorageClass \u5bf9\u8c61\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u76f4\u63a5\u4f7f\u7528\u524d\u9762\u521b\u5efa\u7684 Ceph RBD \u7c7b\u578b\u7684\u540d\u4e3a <code>rook-ceph-block</code> \u7684 StorageClass \u5bf9\u8c61\u5373\u53ef\u3002\u6700\u540e\uff0c\u6211\u4eec\u6307\u5b9a\u4e86\u6bcf\u4e2a PersistentVolume \u7684\u5927\u5c0f\u4e3a 50GB\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u5b9e\u9645\u9700\u8981\u8fdb\u884c\u8c03\u6574\u8be5\u503c\u3002</p> <p>\u5b8c\u6574\u7684 Elasticsearch StatefulSet \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: es\n  namespace: logging\nspec:\n  serviceName: elasticsearch\n  replicas: 3\n  selector:\n    matchLabels:\n      app: elasticsearch\n  template:\n    metadata:\n      labels: \n        app: elasticsearch\n    spec:\n      nodeSelector:\n        es: log\n      initContainers:\n      - name: increase-vm-max-map\n        image: busybox\n        command: [\"sysctl\", \"-w\", \"vm.max_map_count=262144\"]\n        securityContext:\n          privileged: true\n      - name: increase-fd-ulimit\n        image: busybox\n        command: [\"sh\", \"-c\", \"ulimit -n 65536\"]\n        securityContext:\n          privileged: true\n      containers:\n      - name: elasticsearch\n        image: docker.elastic.co/elasticsearch/elasticsearch:2\n        ports:\n        - name: rest\n          containerPort: 9200\n        - name: inter\n          containerPort: 9300\n        resources:\n          limits:\n            cpu: 1000m\n          requests:\n            cpu: 1000m\n        volumeMounts:\n        - name: data\n          mountPath: /usr/share/elasticsearch/data\n        env:\n        - name: cluster.name\n          value: k8s-logs\n        - name: node.name\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        - name: cluster.initial_master_nodes\n          value: \"es-0,es-1,es-2\"\n        - name: discovery.zen.minimum_master_nodes\n          value: \"2\"\n        - name: discovery.seed_hosts\n          value: \"elasticsearch\"\n        - name: ES_JAVA_OPTS\n          value: \"-Xms512m -Xmx512m\"\n        - name: network.host\n          value: \"0\"\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n      labels:\n        app: elasticsearch\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      storageClassName: rook-ceph-block\n      resources:\n        requests:\n          storage: 50Gi\n</code></pre> <p>\u73b0\u5728\u76f4\u63a5\u4f7f\u7528 kubectl \u5de5\u5177\u90e8\u7f72\u5373\u53ef\uff1a</p> <pre><code>$ kubectl create -f elasticsearch-statefulset.yaml\nstatefulset.apps/es created\n</code></pre> <p>\u6dfb\u52a0\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u770b\u5230 logging \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u6240\u6709\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get sts -n logging\nNAME   READY   AGE\nes     3/3     83m\n$ kubectl get pods -n logging\nNAME                      READY   STATUS    RESTARTS   AGE\nes-0                      1/1     Running   0          83m\nes-1                      1/1     Running   0          82m\nes-2                      1/1     Running   0          81m\n$ kubectl get svc -n logging\nNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE\nelasticsearch   ClusterIP   None             &lt;none&gt;        9200/TCP,9300/TCP   20h\n</code></pre> <p>Pods \u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bf7\u6c42\u4e00\u4e2a REST API \u6765\u68c0\u67e5 Elasticsearch \u96c6\u7fa4\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u3002\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5c06\u672c\u5730\u7aef\u53e39200 \u8f6c\u53d1\u5230 Elasticsearch \u8282\u70b9\uff08\u5982es-0\uff09\u5bf9\u5e94\u7684\u7aef\u53e3\uff1a</p> <pre><code>$ kubectl port-forward es-0 9200:9200 --namespace=logging\nForwarding from 11:9200 -&gt; 9200\nForwarding from [::1]:9200 -&gt; 9200\n</code></pre> <p>\u7136\u540e\uff0c\u5728\u53e6\u5916\u7684\u7ec8\u7aef\u7a97\u53e3\u4e2d\uff0c\u6267\u884c\u5982\u4e0b\u8bf7\u6c42\uff1a</p> <pre><code>$ curl http://localhost:9200/_cluster/state?pretty\n</code></pre> <p>\u6b63\u5e38\u6765\u8bf4\uff0c\u5e94\u8be5\u4f1a\u770b\u5230\u7c7b\u4f3c\u4e8e\u5982\u4e0b\u7684\u4fe1\u606f\uff1a</p> <pre><code>{\n  \"cluster_name\" : \"k8s-logs\",\n  \"compressed_size_in_bytes\" : 348,\n  \"cluster_uuid\" : \"QD06dK7CQgids-GQZooNVw\",\n  \"version\" : 3,\n  \"state_uuid\" : \"mjNIWXAzQVuxNNOQ7xR-qg\",\n  \"master_node\" : \"IdM5B7cUQWqFgIHXBp0JDg\",\n  \"blocks\" : { },\n  \"nodes\" : {\n    \"u7DoTpMmSCixOoictzHItA\" : {\n      \"name\" : \"es-1\",\n      \"ephemeral_id\" : \"ZlBflnXKRMC4RvEACHIVdg\",\n      \"transport_address\" : \"2191:9300\",\n      \"attributes\" : { }\n    },\n    \"IdM5B7cUQWqFgIHXBp0JDg\" : {\n      \"name\" : \"es-0\",\n      \"ephemeral_id\" : \"JTk1FDdFQuWbSFAtBxdxAQ\",\n      \"transport_address\" : \"2215:9300\",\n      \"attributes\" : { }\n    },\n    \"R8E7xcSUSbGbgrhAdyAKmQ\" : {\n      \"name\" : \"es-2\",\n      \"ephemeral_id\" : \"9wv6ke71Qqy9vk2LgJTqaA\",\n      \"transport_address\" : \"24:9300\",\n      \"attributes\" : { }\n    }\n  },\n...\n</code></pre> <p>\u770b\u5230\u4e0a\u9762\u7684\u4fe1\u606f\u5c31\u8868\u660e\u6211\u4eec\u540d\u4e3a k8s-logs \u7684 Elasticsearch \u96c6\u7fa4\u6210\u529f\u521b\u5efa\u4e863\u4e2a\u8282\u70b9\uff1aes-0\uff0ces-1\uff0c\u548ces-2\uff0c\u5f53\u524d\u4e3b\u8282\u70b9\u662f es-0\u3002</p>"},{"location":"kubernetes_logs/efk/#kibana","title":"\u521b\u5efa Kibana \u670d\u52a1","text":"<p>Elasticsearch \u96c6\u7fa4\u542f\u52a8\u6210\u529f\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u6765\u90e8\u7f72 Kibana \u670d\u52a1\uff0c\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a kibana.yaml \u7684\u6587\u4ef6\uff0c\u5bf9\u5e94\u7684\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: kibana\n  namespace: logging\n  labels:\n    app: kibana\nspec:\n  ports:\n  - port: 5601\n  type: NodePort\n  selector:\n    app: kibana\n\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: kibana\n  namespace: logging\n  labels:\n    app: kibana\nspec:\n  selector:\n    matchLabels:\n      app: kibana\n  template:\n    metadata:\n      labels:\n        app: kibana\n    spec:\n      nodeSelector:\n        es: log\n      containers:\n      - name: kibana\n        image: docker.elastic.co/kibana/kibana:2\n        resources:\n          limits:\n            cpu: 1000m\n          requests:\n            cpu: 1000m\n        env:\n        - name: ELASTICSEARCH_HOSTS\n          value: http://elasticsearch:9200\n        ports:\n        - containerPort: 5601\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u4e86\u4e24\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u4e00\u4e2a Service \u548c Deployment\uff0c\u4e3a\u4e86\u6d4b\u8bd5\u65b9\u4fbf\uff0c\u6211\u4eec\u5c06 Service \u8bbe\u7f6e\u4e3a\u4e86 NodePort \u7c7b\u578b\uff0cKibana Pod \u4e2d\u914d\u7f6e\u90fd\u6bd4\u8f83\u7b80\u5355\uff0c\u552f\u4e00\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u4f7f\u7528 <code>ELASTICSEARCH_HOSTS</code> \u8fd9\u4e2a\u73af\u5883\u53d8\u91cf\u6765\u8bbe\u7f6eElasticsearch \u96c6\u7fa4\u7684\u7aef\u70b9\u548c\u7aef\u53e3\uff0c\u76f4\u63a5\u4f7f\u7528 Kubernetes DNS \u5373\u53ef\uff0c\u6b64\u7aef\u70b9\u5bf9\u5e94\u670d\u52a1\u540d\u79f0\u4e3a elasticsearch\uff0c\u7531\u4e8e\u662f\u4e00\u4e2a headless service\uff0c\u6240\u4ee5\u8be5\u57df\u5c06\u89e3\u6790\u4e3a3\u4e2a Elasticsearch Pod \u7684 IP \u5730\u5740\u5217\u8868\u3002</p> <p>\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u76f4\u63a5\u4f7f\u7528 kubectl \u5de5\u5177\u521b\u5efa\uff1a</p> <pre><code>$ kubectl create -f kibana.yaml\nservice/kibana created\ndeployment.apps/kibana created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u67e5\u770b Kibana Pod \u7684\u8fd0\u884c\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods --namespace=logging\nNAME                      READY   STATUS    RESTARTS   AGE\nes-0                      1/1     Running   0          85m\nes-1                      1/1     Running   0          84m\nes-2                      1/1     Running   0          83m\nkibana-5c565c47dd-xj4bd   1/1     Running   0          80m\n$ kubectl get svc -n logging\nNAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE\nelasticsearch   ClusterIP   None            &lt;none&gt;        9200/TCP,9300/TCP   3h22m\nkibana          NodePort    1299   &lt;none&gt;        5601:31139/TCP      3h20m\n</code></pre> <p>\u5982\u679c Pod \u5df2\u7ecf\u662f Running \u72b6\u6001\u4e86\uff0c\u8bc1\u660e\u5e94\u7528\u5df2\u7ecf\u90e8\u7f72\u6210\u529f\u4e86\uff0c\u7136\u540e\u53ef\u4ee5\u901a\u8fc7 NodePort \u6765\u8bbf\u95ee Kibana \u8fd9\u4e2a\u670d\u52a1\uff0c\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00</p> <pre><code>http://&lt;\u4efb\u610f\u8282\u70b9IP&gt;:31139\n</code></pre> <p>\u5373\u53ef\uff0c\u5982\u679c\u770b\u5230\u5982\u4e0b\u6b22\u8fce\u754c\u9762\u8bc1\u660e Kibana \u5df2\u7ecf\u6210\u529f\u90e8\u7f72\u5230\u4e86 Kubernetes\u96c6\u7fa4\u4e4b\u4e2d\u3002</p> <p></p>"},{"location":"kubernetes_logs/efk/#fluentd","title":"\u90e8\u7f72 Fluentd","text":"<p><code>Fluentd</code> \u662f\u4e00\u4e2a\u9ad8\u6548\u7684\u65e5\u5fd7\u805a\u5408\u5668\uff0c\u662f\u7528 Ruby \u7f16\u5199\u7684\uff0c\u5e76\u4e14\u53ef\u4ee5\u5f88\u597d\u5730\u6269\u5c55\u3002\u5bf9\u4e8e\u5927\u90e8\u5206\u4f01\u4e1a\u6765\u8bf4\uff0cFluentd \u8db3\u591f\u9ad8\u6548\u5e76\u4e14\u6d88\u8017\u7684\u8d44\u6e90\u76f8\u5bf9\u8f83\u5c11\uff0c\u53e6\u5916\u4e00\u4e2a\u5de5\u5177<code>Fluent-bit</code>\u66f4\u8f7b\u91cf\u7ea7\uff0c\u5360\u7528\u8d44\u6e90\u66f4\u5c11\uff0c\u4f46\u662f\u63d2\u4ef6\u76f8\u5bf9 Fluentd \u6765\u8bf4\u4e0d\u591f\u4e30\u5bcc\uff0c\u6240\u4ee5\u6574\u4f53\u6765\u8bf4\uff0cFluentd \u66f4\u52a0\u6210\u719f\uff0c\u4f7f\u7528\u66f4\u52a0\u5e7f\u6cdb\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4e5f\u540c\u6837\u4f7f\u7528 Fluentd \u6765\u4f5c\u4e3a\u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u3002</p>"},{"location":"kubernetes_logs/efk/#_1","title":"\u5de5\u4f5c\u539f\u7406","text":"<p>Fluentd \u901a\u8fc7\u4e00\u7ec4\u7ed9\u5b9a\u7684\u6570\u636e\u6e90\u6293\u53d6\u65e5\u5fd7\u6570\u636e\uff0c\u5904\u7406\u540e\uff08\u8f6c\u6362\u6210\u7ed3\u6784\u5316\u7684\u6570\u636e\u683c\u5f0f\uff09\u5c06\u5b83\u4eec\u8f6c\u53d1\u7ed9\u5176\u4ed6\u670d\u52a1\uff0c\u6bd4\u5982 Elasticsearch\u3001\u5bf9\u8c61\u5b58\u50a8\u7b49\u7b49\u3002Fluentd \u652f\u6301\u8d85\u8fc7300\u4e2a\u65e5\u5fd7\u5b58\u50a8\u548c\u5206\u6790\u670d\u52a1\uff0c\u6240\u4ee5\u5728\u8fd9\u65b9\u9762\u662f\u975e\u5e38\u7075\u6d3b\u7684\u3002\u4e3b\u8981\u8fd0\u884c\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ul> <li>\u9996\u5148 Fluentd \u4ece\u591a\u4e2a\u65e5\u5fd7\u6e90\u83b7\u53d6\u6570\u636e</li> <li>\u7ed3\u6784\u5316\u5e76\u4e14\u6807\u8bb0\u8fd9\u4e9b\u6570\u636e</li> <li>\u7136\u540e\u6839\u636e\u5339\u914d\u7684\u6807\u7b7e\u5c06\u6570\u636e\u53d1\u9001\u5230\u591a\u4e2a\u76ee\u6807\u670d\u52a1\u53bb</li> </ul> <p></p>"},{"location":"kubernetes_logs/efk/#_2","title":"\u914d\u7f6e","text":"<p>\u4e00\u822c\u6765\u8bf4\u6211\u4eec\u662f\u901a\u8fc7\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u6765\u544a\u8bc9 Fluentd \u5982\u4f55\u91c7\u96c6\u3001\u5904\u7406\u6570\u636e\u7684\uff0c\u4e0b\u9762\u7b80\u5355\u548c\u5927\u5bb6\u4ecb\u7ecd\u4e0b Fluentd \u7684\u914d\u7f6e\u65b9\u6cd5\u3002</p>"},{"location":"kubernetes_logs/efk/#_3","title":"\u65e5\u5fd7\u6e90\u914d\u7f6e","text":"<p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4e3a\u4e86\u6536\u96c6 Kubernetes \u8282\u70b9\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u65e5\u5fd7\uff0c\u5c31\u9700\u8981\u505a\u5982\u4e0b\u7684\u65e5\u5fd7\u6e90\u914d\u7f6e\uff1a</p> <pre><code>&lt;source&gt;\n  @id fluentd-containers.log\n  @type tail                             # Fluentd \u5185\u7f6e\u7684\u8f93\u5165\u65b9\u5f0f\uff0c\u5176\u539f\u7406\u662f\u4e0d\u505c\u5730\u4ece\u6e90\u6587\u4ef6\u4e2d\u83b7\u53d6\u65b0\u7684\u65e5\u5fd7\u3002\n  path /var/log/containers/*.log         # \u6302\u8f7d\u7684\u670d\u52a1\u5668Docker\u5bb9\u5668\u65e5\u5fd7\u5730\u5740\n  pos_file /var/log/es-containers.log.pos\n  tag raw.kubernetes.*                   # \u8bbe\u7f6e\u65e5\u5fd7\u6807\u7b7e\n  read_from_head true\n  &lt;parse&gt;                                # \u591a\u884c\u683c\u5f0f\u5316\u6210JSON\n    @type multi_format                   # \u4f7f\u7528 multi-format-parser \u89e3\u6790\u5668\u63d2\u4ef6\n    &lt;pattern&gt;\n      format json                        # JSON \u89e3\u6790\u5668\n      time_key time                      # \u6307\u5b9a\u4e8b\u4ef6\u65f6\u95f4\u7684\u65f6\u95f4\u5b57\u6bb5\n      time_format %Y-%m-%dT%H:%M:%S.%NZ  # \u65f6\u95f4\u683c\u5f0f\n    &lt;/pattern&gt;\n    &lt;pattern&gt;\n      format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/\n      time_format %Y-%m-%dT%H:%M:%S.%N%:z\n    &lt;/pattern&gt;\n  &lt;/parse&gt;\n&lt;/source&gt;\n</code></pre> <p>\u4e0a\u9762\u914d\u7f6e\u90e8\u5206\u53c2\u6570\u8bf4\u660e\u5982\u4e0b\uff1a</p> <ul> <li>id\uff1a\u8868\u793a\u5f15\u7528\u8be5\u65e5\u5fd7\u6e90\u7684\u552f\u4e00\u6807\u8bc6\u7b26\uff0c\u8be5\u6807\u8bc6\u53ef\u7528\u4e8e\u8fdb\u4e00\u6b65\u8fc7\u6ee4\u548c\u8def\u7531\u7ed3\u6784\u5316\u65e5\u5fd7\u6570\u636e</li> <li>type\uff1aFluentd \u5185\u7f6e\u7684\u6307\u4ee4\uff0c<code>tail</code> \u8868\u793a Fluentd \u4ece\u4e0a\u6b21\u8bfb\u53d6\u7684\u4f4d\u7f6e\u901a\u8fc7 tail \u4e0d\u65ad\u83b7\u53d6\u6570\u636e\uff0c\u53e6\u5916\u4e00\u4e2a\u662f <code>http</code> \u8868\u793a\u901a\u8fc7\u4e00\u4e2a GET \u8bf7\u6c42\u6765\u6536\u96c6\u6570\u636e\u3002</li> <li>path\uff1a<code>tail</code> \u7c7b\u578b\u4e0b\u7684\u7279\u5b9a\u53c2\u6570\uff0c\u544a\u8bc9 Fluentd \u91c7\u96c6 <code>/var/log/containers</code> \u76ee\u5f55\u4e0b\u7684\u6240\u6709\u65e5\u5fd7\uff0c\u8fd9\u662f docker \u5728 Kubernetes \u8282\u70b9\u4e0a\u7528\u6765\u5b58\u50a8\u8fd0\u884c\u5bb9\u5668 stdout \u8f93\u51fa\u65e5\u5fd7\u6570\u636e\u7684\u76ee\u5f55\u3002</li> <li>pos_file\uff1a\u68c0\u67e5\u70b9\uff0c\u5982\u679c Fluentd \u7a0b\u5e8f\u91cd\u65b0\u542f\u52a8\u4e86\uff0c\u5b83\u5c06\u4f7f\u7528\u6b64\u6587\u4ef6\u4e2d\u7684\u4f4d\u7f6e\u6765\u6062\u590d\u65e5\u5fd7\u6570\u636e\u6536\u96c6\u3002</li> <li>tag\uff1a\u7528\u6765\u5c06\u65e5\u5fd7\u6e90\u4e0e\u76ee\u6807\u6216\u8005\u8fc7\u6ee4\u5668\u5339\u914d\u7684\u81ea\u5b9a\u4e49\u5b57\u7b26\u4e32\uff0cFluentd \u5339\u914d\u6e90/\u76ee\u6807\u6807\u7b7e\u6765\u8def\u7531\u65e5\u5fd7\u6570\u636e\u3002</li> </ul>"},{"location":"kubernetes_logs/efk/#_4","title":"\u8def\u7531\u914d\u7f6e","text":"<p>\u4e0a\u9762\u662f\u65e5\u5fd7\u6e90\u7684\u914d\u7f6e\uff0c\u63a5\u4e0b\u6765\u770b\u770b\u5982\u4f55\u5c06\u65e5\u5fd7\u6570\u636e\u53d1\u9001\u5230 Elasticsearch\uff1a</p> <pre><code>&lt;match **&gt;\n\n@id elasticsearch\n\n@type elasticsearch\n\n@log_level info\n\ninclude_tag_key true\n\ntype_name fluentd\n\nhost \"#{ENV['OUTPUT_HOST']}\"\n\nport \"#{ENV['OUTPUT_PORT']}\"\n\nlogstash_format true\n\n&lt;buffer&gt;\n\n@type file\n\npath /var/log/fluentd-buffers/kubernetes.system.buffer\n\nflush_mode interval\n\nretry_type exponential_backoff\n\nflush_thread_count 2\n\nflush_interval 5s\n\nretry_forever\n\nretry_max_interval 30\n\nchunk_limit_size \"#{ENV['OUTPUT_BUFFER_CHUNK_LIMIT']}\"\n\nqueue_limit_length \"#{ENV['OUTPUT_BUFFER_QUEUE_LIMIT']}\"\n\noverflow_action block\n\n&lt;/buffer&gt;\n</code></pre> <ul> <li>match\uff1a\u6807\u8bc6\u4e00\u4e2a\u76ee\u6807\u6807\u7b7e\uff0c\u540e\u9762\u662f\u4e00\u4e2a\u5339\u914d\u65e5\u5fd7\u6e90\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u6211\u4eec\u8fd9\u91cc\u60f3\u8981\u6355\u83b7\u6240\u6709\u7684\u65e5\u5fd7\u5e76\u5c06\u5b83\u4eec\u53d1\u9001\u7ed9 Elasticsearch\uff0c\u6240\u4ee5\u9700\u8981\u914d\u7f6e\u6210<code>**</code>\u3002</li> <li>id\uff1a\u76ee\u6807\u7684\u4e00\u4e2a\u552f\u4e00\u6807\u8bc6\u7b26\u3002</li> <li>type\uff1a\u652f\u6301\u7684\u8f93\u51fa\u63d2\u4ef6\u6807\u8bc6\u7b26\uff0c\u6211\u4eec\u8fd9\u91cc\u8981\u8f93\u51fa\u5230 Elasticsearch\uff0c\u6240\u4ee5\u914d\u7f6e\u6210 elasticsearch\uff0c\u8fd9\u662f Fluentd \u7684\u4e00\u4e2a\u5185\u7f6e\u63d2\u4ef6\u3002</li> <li>log_level\uff1a\u6307\u5b9a\u8981\u6355\u83b7\u7684\u65e5\u5fd7\u7ea7\u522b\uff0c\u6211\u4eec\u8fd9\u91cc\u914d\u7f6e\u6210 <code>info</code>\uff0c\u8868\u793a\u4efb\u4f55\u8be5\u7ea7\u522b\u6216\u8005\u8be5\u7ea7\u522b\u4ee5\u4e0a\uff08INFO\u3001WARNING\u3001ERROR\uff09\u7684\u65e5\u5fd7\u90fd\u5c06\u88ab\u8def\u7531\u5230 Elsasticsearch\u3002</li> <li>host/port\uff1a\u5b9a\u4e49 Elasticsearch \u7684\u5730\u5740\uff0c\u4e5f\u53ef\u4ee5\u914d\u7f6e\u8ba4\u8bc1\u4fe1\u606f\uff0c\u6211\u4eec\u7684 Elasticsearch \u4e0d\u9700\u8981\u8ba4\u8bc1\uff0c\u6240\u4ee5\u8fd9\u91cc\u76f4\u63a5\u6307\u5b9a host \u548c port \u5373\u53ef\u3002</li> <li>logstash_format\uff1aElasticsearch \u670d\u52a1\u5bf9\u65e5\u5fd7\u6570\u636e\u6784\u5efa\u53cd\u5411\u7d22\u5f15\u8fdb\u884c\u641c\u7d22\uff0c\u5c06 logstash_format \u8bbe\u7f6e\u4e3a <code>true</code>\uff0cFluentd \u5c06\u4f1a\u4ee5 logstash \u683c\u5f0f\u6765\u8f6c\u53d1\u7ed3\u6784\u5316\u7684\u65e5\u5fd7\u6570\u636e\u3002</li> <li>Buffer\uff1a Fluentd \u5141\u8bb8\u5728\u76ee\u6807\u4e0d\u53ef\u7528\u65f6\u8fdb\u884c\u7f13\u5b58\uff0c\u6bd4\u5982\uff0c\u5982\u679c\u7f51\u7edc\u51fa\u73b0\u6545\u969c\u6216\u8005 Elasticsearch \u4e0d\u53ef\u7528\u7684\u65f6\u5019\u3002\u7f13\u51b2\u533a\u914d\u7f6e\u4e5f\u6709\u52a9\u4e8e\u964d\u4f4e\u78c1\u76d8\u7684 IO\u3002</li> </ul>"},{"location":"kubernetes_logs/efk/#_5","title":"\u8fc7\u6ee4","text":"<p>\u7531\u4e8e Kubernetes \u96c6\u7fa4\u4e2d\u5e94\u7528\u592a\u591a\uff0c\u4e5f\u8fd8\u6709\u5f88\u591a\u5386\u53f2\u6570\u636e\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u53ea\u5c06\u67d0\u4e9b\u5e94\u7528\u7684\u65e5\u5fd7\u8fdb\u884c\u6536\u96c6\uff0c\u6bd4\u5982\u6211\u4eec\u53ea\u91c7\u96c6\u5177\u6709 <code>logging=true</code> \u8fd9\u4e2a Label \u6807\u7b7e\u7684 Pod \u65e5\u5fd7\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u4f7f\u7528 filter\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># \u5220\u9664\u65e0\u7528\u7684\u5c5e\u6027\n&lt;filter kubernetes.**&gt;\n  @type record_transformer\n  remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash\n&lt;/filter&gt;\n# \u53ea\u4fdd\u7559\u5177\u6709logging=true\u6807\u7b7e\u7684Pod\u65e5\u5fd7\n&lt;filter kubernetes.**&gt;\n  @id filter_log\n  @type grep\n  &lt;regexp&gt;\n    key $.kubernetes.labels.logging\n    pattern ^true$\n  &lt;/regexp&gt;\n&lt;/filter&gt;\n</code></pre>"},{"location":"kubernetes_logs/efk/#_6","title":"\u5b89\u88c5","text":"<p>\u8981\u6536\u96c6 Kubernetes \u96c6\u7fa4\u7684\u65e5\u5fd7\uff0c\u76f4\u63a5\u7528 DasemonSet \u63a7\u5236\u5668\u6765\u90e8\u7f72 Fluentd \u5e94\u7528\uff0c\u8fd9\u6837\uff0c\u5b83\u5c31\u53ef\u4ee5\u4ece Kubernetes \u8282\u70b9\u4e0a\u91c7\u96c6\u65e5\u5fd7\uff0c\u786e\u4fdd\u5728\u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a\u59cb\u7ec8\u8fd0\u884c\u4e00\u4e2a Fluentd \u5bb9\u5668\u3002\u5f53\u7136\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Helm \u6765\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\uff0c\u4e3a\u4e86\u80fd\u591f\u4e86\u89e3\u66f4\u591a\u5b9e\u73b0\u7ec6\u8282\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u662f\u91c7\u7528\u624b\u52a8\u65b9\u6cd5\u6765\u8fdb\u884c\u5b89\u88c5\u3002</p> <p>\u9996\u5148\uff0c\u6211\u4eec\u901a\u8fc7 ConfigMap \u5bf9\u8c61\u6765\u6307\u5b9a Fluentd \u914d\u7f6e\u6587\u4ef6\uff0c\u65b0\u5efa fluentd-configmap.yaml \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>kind: ConfigMap\napiVersion: v1\nmetadata:\n  name: fluentd-config\n  namespace: logging\ndata:\n  system.conf: |-\n    &lt;system&gt;\n      root_dir /tmp/fluentd-buffers/\n    &lt;/system&gt;\n  containers.input.conf: |-\n    &lt;source&gt;\n      @id fluentd-containers.log\n      @type tail                              # Fluentd \u5185\u7f6e\u7684\u8f93\u5165\u65b9\u5f0f\uff0c\u5176\u539f\u7406\u662f\u4e0d\u505c\u5730\u4ece\u6e90\u6587\u4ef6\u4e2d\u83b7\u53d6\u65b0\u7684\u65e5\u5fd7\u3002\n      path /var/log/containers/*.log          # \u6302\u8f7d\u7684\u670d\u52a1\u5668Docker\u5bb9\u5668\u65e5\u5fd7\u5730\u5740\n      pos_file /var/log/es-containers.log.pos\n      tag raw.kubernetes.*                    # \u8bbe\u7f6e\u65e5\u5fd7\u6807\u7b7e\n      read_from_head true\n      &lt;parse&gt;                                 # \u591a\u884c\u683c\u5f0f\u5316\u6210JSON\n        @type multi_format                    # \u4f7f\u7528 multi-format-parser \u89e3\u6790\u5668\u63d2\u4ef6\n        &lt;pattern&gt;\n          format json                         # JSON\u89e3\u6790\u5668\n          time_key time                       # \u6307\u5b9a\u4e8b\u4ef6\u65f6\u95f4\u7684\u65f6\u95f4\u5b57\u6bb5\n          time_format %Y-%m-%dT%H:%M:%S.%NZ   # \u65f6\u95f4\u683c\u5f0f\n        &lt;/pattern&gt;\n        &lt;pattern&gt;\n          format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/\n          time_format %Y-%m-%dT%H:%M:%S.%N%:z\n        &lt;/pattern&gt;\n      &lt;/parse&gt;\n    &lt;/source&gt;\n    # \u5728\u65e5\u5fd7\u8f93\u51fa\u4e2d\u68c0\u6d4b\u5f02\u5e38\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a\u4e00\u6761\u65e5\u5fd7\u8f6c\u53d1 \n    # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions\n    &lt;match raw.kubernetes.**&gt;           # \u5339\u914dtag\u4e3araw.kubernetes.**\u65e5\u5fd7\u4fe1\u606f\n      @id raw.kubernetes\n      @type detect_exceptions           # \u4f7f\u7528detect-exceptions\u63d2\u4ef6\u5904\u7406\u5f02\u5e38\u6808\u4fe1\u606f\n      remove_tag_prefix raw             # \u79fb\u9664 raw \u524d\u7f00\n      message log                       \n      stream stream                     \n      multiline_flush_interval 5\n      max_bytes 500000\n      max_lines 1000\n    &lt;/match&gt;\n\n    &lt;filter **&gt;  # \u62fc\u63a5\u65e5\u5fd7\n      @id filter_concat\n      @type concat                # Fluentd Filter \u63d2\u4ef6\uff0c\u7528\u4e8e\u8fde\u63a5\u591a\u4e2a\u4e8b\u4ef6\u4e2d\u5206\u9694\u7684\u591a\u884c\u65e5\u5fd7\u3002\n      key message\n      multiline_end_regexp /\\\\n$/  # \u4ee5\u6362\u884c\u7b26\u201c\\\\n\u201d\u62fc\u63a5\n      separator \"\"\n    &lt;/filter&gt; \n\n    # \u6dfb\u52a0 Kubernetes metadata \u6570\u636e\n    &lt;filter kubernetes.**&gt;\n      @id filter_kubernetes_metadata\n      @type kubernetes_metadata\n    &lt;/filter&gt;\n\n    # \u4fee\u590d ES \u4e2d\u7684 JSON \u5b57\u6bb5\n    # \u63d2\u4ef6\u5730\u5740\uff1ahttps://github.com/repeatedly/fluent-plugin-multi-format-parser\n    &lt;filter kubernetes.**&gt;\n      @id filter_parser\n      @type parser                # multi-format-parser\u591a\u683c\u5f0f\u89e3\u6790\u5668\u63d2\u4ef6\n      key_name log                # \u5728\u8981\u89e3\u6790\u7684\u8bb0\u5f55\u4e2d\u6307\u5b9a\u5b57\u6bb5\u540d\u79f0\u3002\n      reserve_data true           # \u5728\u89e3\u6790\u7ed3\u679c\u4e2d\u4fdd\u7559\u539f\u59cb\u952e\u503c\u5bf9\u3002\n      remove_key_name_field true  # key_name \u89e3\u6790\u6210\u529f\u540e\u5220\u9664\u5b57\u6bb5\u3002\n      &lt;parse&gt;\n        @type multi_format\n        &lt;pattern&gt;\n          format json\n        &lt;/pattern&gt;\n        &lt;pattern&gt;\n          format none\n        &lt;/pattern&gt;\n      &lt;/parse&gt;\n    &lt;/filter&gt;\n\n    # \u5220\u9664\u4e00\u4e9b\u591a\u4f59\u7684\u5c5e\u6027\n    &lt;filter kubernetes.**&gt;\n      @type record_transformer\n      remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash\n    &lt;/filter&gt;\n\n    # \u53ea\u4fdd\u7559\u5177\u6709logging=true\u6807\u7b7e\u7684Pod\u65e5\u5fd7\n    &lt;filter kubernetes.**&gt;\n      @id filter_log\n      @type grep\n      &lt;regexp&gt;\n        key $.kubernetes.labels.logging\n        pattern ^true$\n      &lt;/regexp&gt;\n    &lt;/filter&gt;\n\n  ###### \u76d1\u542c\u914d\u7f6e\uff0c\u4e00\u822c\u7528\u4e8e\u65e5\u5fd7\u805a\u5408\u7528 ######\n  forward.input.conf: |-\n    # \u76d1\u542c\u901a\u8fc7TCP\u53d1\u9001\u7684\u6d88\u606f\n    &lt;source&gt;\n      @id forward\n      @type forward\n    &lt;/source&gt;\n\n  output.conf: |-\n    &lt;match **&gt;\n      @id elasticsearch\n      @type elasticsearch\n      @log_level info\n      include_tag_key true\n      host elasticsearch\n      port 9200\n      logstash_format true\n      logstash_prefix k8s  # \u8bbe\u7f6e index \u524d\u7f00\u4e3a k8s\n      request_timeout    30s\n      &lt;buffer&gt;\n        @type file\n        path /var/log/fluentd-buffers/kubernetes.system.buffer\n        flush_mode interval\n        retry_type exponential_backoff\n        flush_thread_count 2\n        flush_interval 5s\n        retry_forever\n        retry_max_interval 30\n        chunk_limit_size 2M\n        queue_limit_length 8\n        overflow_action block\n      &lt;/buffer&gt;\n    &lt;/match&gt;\n</code></pre> <p>\u4e0a\u9762\u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u53ea\u914d\u7f6e\u4e86 docker \u5bb9\u5668\u65e5\u5fd7\u76ee\u5f55\uff0c\u6536\u96c6\u5230\u6570\u636e\u7ecf\u8fc7\u5904\u7406\u540e\u53d1\u9001\u5230 <code>elasticsearch:9200</code> \u670d\u52a1\u3002</p> <p>\u7136\u540e\u65b0\u5efa\u4e00\u4e2a fluentd-daemonset.yaml \u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: fluentd-es\n  namespace: logging\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\n---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: fluentd-es\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - \"namespaces\"\n  - \"pods\"\n  verbs:\n  - \"get\"\n  - \"watch\"\n  - \"list\"\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: fluentd-es\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nsubjects:\n- kind: ServiceAccount\n  name: fluentd-es\n  namespace: logging\n  apiGroup: \"\"\nroleRef:\n  kind: ClusterRole\n  name: fluentd-es\n  apiGroup: \"\"\n---\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: fluentd-es\n  namespace: logging\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nspec:\n  selector:\n    matchLabels:\n      k8s-app: fluentd-es\n  template:\n    metadata:\n      labels:\n        k8s-app: fluentd-es\n        kubernetes.io/cluster-service: \"true\"\n      # \u6b64\u6ce8\u91ca\u786e\u4fdd\u5982\u679c\u8282\u70b9\u88ab\u9a71\u9010\uff0cfluentd\u4e0d\u4f1a\u88ab\u9a71\u9010\uff0c\u652f\u6301\u5173\u952e\u7684\u57fa\u4e8e pod \u6ce8\u91ca\u7684\u4f18\u5148\u7ea7\u65b9\u6848\u3002\n      annotations:\n        scheduler.alpha.kubernetes.io/critical-pod: ''\n    spec:\n      serviceAccountName: fluentd-es\n      containers:\n      - name: fluentd-es\n        image: quay.io/fluentd_elasticsearch/fluentd:v1\n        env:\n        - name: FLUENTD_ARGS\n          value: --no-supervisor -q\n        resources:\n          limits:\n            memory: 500Mi\n          requests:\n            cpu: 100m\n            memory: 200Mi\n        volumeMounts:\n        - name: varlog\n          mountPath: /var/log\n        - name: varlibdockercontainers\n          mountPath: /data/docker/containers\n          readOnly: true\n        - name: config-volume\n          mountPath: /etc/fluent/config.d\n      nodeSelector:\n        beta.kubernetes.io/fluentd-ds-ready: \"true\"\n      tolerations:\n      - operator: Exists\n      terminationGracePeriodSeconds: 30\n      volumes:\n      - name: varlog\n        hostPath:\n          path: /var/log\n      - name: varlibdockercontainers\n        hostPath:\n          path: /data/docker/containers\n      - name: config-volume\n        configMap:\n          name: fluentd-config\n</code></pre> <p>\u6211\u4eec\u5c06\u4e0a\u9762\u521b\u5efa\u7684 fluentd-config \u8fd9\u4e2a ConfigMap \u5bf9\u8c61\u901a\u8fc7 volumes \u6302\u8f7d\u5230\u4e86 Fluentd \u5bb9\u5668\u4e2d\uff0c\u53e6\u5916\u4e3a\u4e86\u80fd\u591f\u7075\u6d3b\u63a7\u5236\u54ea\u4e9b\u8282\u70b9\u7684\u65e5\u5fd7\u53ef\u4ee5\u88ab\u6536\u96c6\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u8fd8\u6dfb\u52a0\u4e86\u4e00\u4e2a nodSelector \u5c5e\u6027\uff1a</p> <pre><code>nodeSelector:\n  beta.kubernetes.io/fluentd-ds-ready: \"true\"\n</code></pre> <p>\u610f\u601d\u5c31\u662f\u8981\u60f3\u91c7\u96c6\u8282\u70b9\u7684\u65e5\u5fd7\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u9700\u8981\u7ed9\u8282\u70b9\u6253\u4e0a\u4e0a\u9762\u7684\u6807\u7b7e\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u53ea\u7ed9\u8282\u70b94\u548c\u8282\u70b96\u6253\u4e0a\u4e86\u8be5\u6807\u7b7e\uff1a</p> <pre><code>$ kubectl get nodes --show-labels\nNAME          STATUS   ROLES    AGE    VERSION   LABELS\nydzs-master   Ready    master   170d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-master,kubernetes.io/os=linux,node-role.kubernetes.io/master=\nydzs-node1    Ready    &lt;none&gt;   170d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,es=log,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node1,kubernetes.io/os=linux\nydzs-node2    Ready    &lt;none&gt;   170d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,com=youdianzhishi,es=log,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node2,kubernetes.io/os=linux\nydzs-node3    Ready    &lt;none&gt;   169d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,es=log,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node3,kubernetes.io/os=linux,monitor=prometheus\nydzs-node4    Ready    &lt;none&gt;   169d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node4,kubernetes.io/os=linux\nydzs-node5    Ready    &lt;none&gt;   96d    v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node5,kubernetes.io/os=linux\nydzs-node6    Ready    &lt;none&gt;   96d    v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node6,kubernetes.io/os=linux\n</code></pre> <p>\u63d0\u793a</p> <p>\u5982\u679c\u4f60\u9700\u8981\u5728\u5176\u4ed6\u8282\u70b9\u4e0a\u91c7\u96c6\u65e5\u5fd7\uff0c\u5219\u9700\u8981\u7ed9\u5bf9\u5e94\u8282\u70b9\u6253\u4e0a\u6807\u7b7e\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>kubectl label nodes node\u540d beta.kubernetes.io/fluentd-ds-ready=true\n</code></pre> <p>\u3002</p> <p>\u53e6\u5916\u7531\u4e8e\u6211\u4eec\u7684\u96c6\u7fa4\u4f7f\u7528\u7684\u662f kubeadm \u642d\u5efa\u7684\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b master \u8282\u70b9\u6709\u6c61\u70b9\uff0c\u6240\u4ee5\u5982\u679c\u8981\u60f3\u4e5f\u6536\u96c6 master \u8282\u70b9\u7684\u65e5\u5fd7\uff0c\u5219\u9700\u8981\u6dfb\u52a0\u4e0a\u5bb9\u5fcd\uff1a</p> <pre><code>tolerations:\n- operator: Exists\n</code></pre> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u662f\uff0c\u6211\u8fd9\u91cc\u7684\u6d4b\u8bd5\u73af\u5883\u66f4\u6539\u4e86 docker \u7684\u6839\u76ee\u5f55\uff1a</p> <pre><code>$ docker info\n...\nDocker Root Dir: /data/docker\n...\n</code></pre> <p>\u6240\u4ee5\u4e0a\u9762\u8981\u83b7\u53d6 docker \u7684\u5bb9\u5668\u76ee\u5f55\u9700\u8981\u66f4\u6539\u6210</p> <pre><code>/data/docker/containers\n</code></pre> <p>\uff0c\u8fd9\u4e2a\u5730\u65b9\u975e\u5e38\u91cd\u8981\uff0c\u5f53\u7136\u5982\u679c\u4f60\u6ca1\u6709\u66f4\u6539 docker \u6839\u76ee\u5f55\u5219\u4f7f\u7528\u9ed8\u8ba4\u7684</p> <pre><code>/var/lib/docker/containers\n</code></pre> <p>\u76ee\u5f55\u5373\u53ef\u3002</p> <p>\u5206\u522b\u521b\u5efa\u4e0a\u9762\u7684 ConfigMap \u5bf9\u8c61\u548c DaemonSet\uff1a</p> <pre><code>$ kubectl create -f fluentd-configmap.yaml\nconfigmap \"fluentd-config\" created\n$ kubectl create -f fluentd-daemonset.yaml\nserviceaccount \"fluentd-es\" created\nclusterrole.rbac.authorization.k8s.io \"fluentd-es\" created\nclusterrolebinding.rbac.authorization.k8s.io \"fluentd-es\" created\ndaemonset.apps \"fluentd-es\" created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b\u5bf9\u5e94\u7684 Pods \u5217\u8868\uff0c\u68c0\u67e5\u662f\u5426\u90e8\u7f72\u6210\u529f\uff1a</p> <pre><code>$ kubectl get pods -n logging\nNAME                      READY   STATUS    RESTARTS   AGE\nes-0                      1/1     Running   0          108m\nes-1                      1/1     Running   0          107m\nes-2                      1/1     Running   0          106m\nfluentd-es-h4jl2          1/1     Running   0          100m\nfluentd-es-vngmd          1/1     Running   0          100m\nkibana-5c565c47dd-xj4bd   1/1     Running   0          103m\n</code></pre> <p>Fluentd \u542f\u52a8\u6210\u529f\u540e\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u53d1\u9001\u65e5\u5fd7\u5230 ES \u4e86\uff0c\u4f46\u662f\u6211\u4eec\u8fd9\u91cc\u662f\u8fc7\u6ee4\u4e86\u53ea\u91c7\u96c6\u5177\u6709 <code>logging=true</code> \u6807\u7b7e\u7684 Pod \u65e5\u5fd7\uff0c\u6240\u4ee5\u73b0\u5728\u8fd8\u6ca1\u6709\u4efb\u4f55\u6570\u636e\u4f1a\u88ab\u91c7\u96c6\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a\u7b80\u5355\u7684\u6d4b\u8bd5\u5e94\u7528\uff0c \u65b0\u5efa counter.yaml \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\n  labels:\n    logging: \"true\"  # \u4e00\u5b9a\u8981\u5177\u6709\u8be5\u6807\u7b7e\u624d\u4f1a\u88ab\u91c7\u96c6\nspec:\n  containers:\n  - name: count\n    image: busybox\n    args: [/bin/sh, -c,\n            'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done']\n</code></pre> <p>\u8be5 Pod \u53ea\u662f\u7b80\u5355\u5c06\u65e5\u5fd7\u4fe1\u606f\u6253\u5370\u5230 <code>stdout</code>\uff0c\u6240\u4ee5\u6b63\u5e38\u6765\u8bf4 Fluentd \u4f1a\u6536\u96c6\u5230\u8fd9\u4e2a\u65e5\u5fd7\u6570\u636e\uff0c\u5728 Kibana \u4e2d\u4e5f\u5c31\u53ef\u4ee5\u627e\u5230\u5bf9\u5e94\u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff0c\u4f7f\u7528 kubectl \u5de5\u5177\u521b\u5efa\u8be5 Pod\uff1a</p> <pre><code>$ kubectl create -f counter.yaml\n$ kubectl get pods\nNAME                             READY   STATUS    RESTARTS   AGE\ncounter                          1/1     Running   0          9h\n</code></pre> <p>Pod \u521b\u5efa\u5e76\u8fd0\u884c\u540e\uff0c\u56de\u5230 Kibana Dashboard \u9875\u9762\uff0c\u70b9\u51fb\u5de6\u4fa7\u6700\u4e0b\u9762\u7684 <code>management</code> \u56fe\u6807\uff0c\u7136\u540e\u70b9\u51fb Kibana \u4e0b\u9762\u7684 <code>Index Patterns</code> \u5f00\u59cb\u5bfc\u5165\u7d22\u5f15\u6570\u636e\uff1a</p> <p></p> <p>\u5728\u8fd9\u91cc\u53ef\u4ee5\u914d\u7f6e\u6211\u4eec\u9700\u8981\u7684 Elasticsearch \u7d22\u5f15\uff0c\u524d\u9762 Fluentd \u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u4f7f\u7528\u7684\u662f logstash \u683c\u5f0f\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e2a <code>k8s</code> \u7684\u524d\u7f00\uff0c\u6240\u4ee5\u8fd9\u91cc\u53ea\u9700\u8981\u5728\u6587\u672c\u6846\u4e2d\u8f93\u5165<code>k8s-*</code>\u5373\u53ef\u5339\u914d\u5230 Elasticsearch \u96c6\u7fa4\u4e2d\u91c7\u96c6\u7684 Kubernetes \u96c6\u7fa4\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u70b9\u51fb\u4e0b\u4e00\u6b65\uff0c\u8fdb\u5165\u4ee5\u4e0b\u9875\u9762\uff1a</p> <p></p> <p>\u5728\u8be5\u9875\u9762\u4e2d\u914d\u7f6e\u4f7f\u7528\u54ea\u4e2a\u5b57\u6bb5\u6309\u65f6\u95f4\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\uff0c\u5728\u4e0b\u62c9\u5217\u8868\u4e2d\uff0c\u9009\u62e9<code>@timestamp</code>\u5b57\u6bb5\uff0c\u7136\u540e\u70b9\u51fb<code>Create index pattern</code>\uff0c\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u70b9\u51fb\u5de6\u4fa7\u5bfc\u822a\u83dc\u5355\u4e2d\u7684<code>Discover</code>\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u76f4\u65b9\u56fe\u548c\u6700\u8fd1\u91c7\u96c6\u5230\u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff1a</p> <p></p> <p>\u73b0\u5728\u7684\u6570\u636e\u5c31\u662f\u4e0a\u9762 Counter \u5e94\u7528\u7684\u65e5\u5fd7\uff0c\u5982\u679c\u8fd8\u6709\u5176\u4ed6\u7684\u5e94\u7528\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u7b5b\u9009\u8fc7\u6ee4\uff1a</p> <p></p> <p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5176\u4ed6\u5143\u6570\u636e\u6765\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\uff0c\u6bd4\u5982\u60a8\u53ef\u4ee5\u5355\u51fb\u4efb\u4f55\u65e5\u5fd7\u6761\u76ee\u4ee5\u67e5\u770b\u5176\u4ed6\u5143\u6570\u636e\uff0c\u5982\u5bb9\u5668\u540d\u79f0\uff0cKubernetes \u8282\u70b9\uff0c\u547d\u540d\u7a7a\u95f4\u7b49\u3002</p>"},{"location":"kubernetes_logs/efk/#_7","title":"\u65e5\u5fd7\u5206\u6790","text":"<p>\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u53ef\u4ee5\u5c06\u5e94\u7528\u65e5\u5fd7\u6536\u96c6\u8d77\u6765\u4e86\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u4f7f\u7528\u4e00\u4e2a\u5e94\u7528\u6f14\u793a\u5982\u4f55\u5206\u6790\u91c7\u96c6\u7684\u65e5\u5fd7\u3002\u793a\u4f8b\u5e94\u7528\u4f1a\u8f93\u51fa\u5982\u4e0b\u6240\u793a\u7684 JSON \u683c\u5f0f\u7684\u65e5\u5fd7\u4fe1\u606f\uff1a</p> <pre><code>{\"LOGLEVEL\":\"WARNING\",\"serviceName\":\"msg-processor\",\"serviceEnvironment\":\"staging\",\"message\":\"WARNING client connection terminated unexpectedly.\"}\n{\"LOGLEVEL\":\"INFO\",\"serviceName\":\"msg-processor\",\"serviceEnvironment\":\"staging\",\"message\":\"\",\"eventsNumber\":5}\n{\"LOGLEVEL\":\"INFO\",\"serviceName\":\"msg-receiver-api\":\"msg-receiver-api\",\"serviceEnvironment\":\"staging\",\"volume\":14,\"message\":\"API received messages\"}\n{\"LOGLEVEL\":\"ERROR\",\"serviceName\":\"msg-receiver-api\",\"serviceEnvironment\":\"staging\",\"message\":\"ERROR Unable to upload files for processing\"}\n</code></pre> <p>\u56e0\u4e3a JSON \u683c\u5f0f\u7684\u65e5\u5fd7\u89e3\u6790\u975e\u5e38\u5bb9\u6613\uff0c\u5f53\u6211\u4eec\u5c06\u65e5\u5fd7\u7ed3\u6784\u5316\u4f20\u8f93\u5230 ES \u8fc7\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u7279\u5b9a\u7684\u5b57\u6bb5\u503c\u800c\u4e0d\u662f\u6587\u672c\u641c\u7d22\u65e5\u5fd7\u6570\u636e\uff0c\u5f53\u7136\u7eaf\u6587\u672c\u683c\u5f0f\u7684\u65e5\u5fd7\u6211\u4eec\u4e5f\u53ef\u4ee5\u8fdb\u884c\u7ed3\u6784\u5316\uff0c\u4f46\u662f\u8fd9\u6837\u6bcf\u4e2a\u5e94\u7528\u7684\u65e5\u5fd7\u683c\u5f0f\u4e0d\u7edf\u4e00\uff0c\u90fd\u9700\u8981\u5355\u72ec\u8fdb\u884c\u7ed3\u6784\u5316\uff0c\u975e\u5e38\u9ebb\u70e6\uff0c\u6240\u4ee5\u5efa\u8bae\u5c06\u65e5\u5fd7\u683c\u5f0f\u7edf\u4e00\u6210 JSON \u683c\u5f0f\u8f93\u51fa\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u7684\u793a\u4f8b\u5e94\u7528\u4f1a\u5b9a\u671f\u8f93\u51fa\u4e0d\u540c\u7c7b\u578b\u7684\u65e5\u5fd7\u6d88\u606f\uff0c\u5305\u542b\u4e0d\u540c\u65e5\u5fd7\u7ea7\u522b\uff08INFO/WARN/ERROR\uff09\u7684\u65e5\u5fd7\uff0c\u4e00\u884c JSON \u65e5\u5fd7\u5c31\u662f\u6211\u4eec\u6536\u96c6\u7684\u4e00\u6761\u65e5\u5fd7\u6d88\u606f\uff0c\u8be5\u6d88\u606f\u901a\u8fc7 fluentd \u8fdb\u884c\u91c7\u96c6\u53d1\u9001\u5230 Elasticsearch\u3002\u8fd9\u91cc\u6211\u4eec\u4f1a\u4f7f\u7528\u5230 fluentd \u91cc\u9762\u7684\u81ea\u52a8 JSON \u89e3\u6790\u63d2\u4ef6\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cfluentd \u4f1a\u5c06\u6bcf\u4e2a\u65e5\u5fd7\u6587\u4ef6\u7684\u4e00\u884c\u4f5c\u4e3a\u540d\u4e3a <code>log</code> \u7684\u5b57\u6bb5\u8fdb\u884c\u53d1\u9001\uff0c\u5e76\u81ea\u52a8\u6dfb\u52a0\u5176\u4ed6\u5b57\u6bb5\uff0c\u6bd4\u5982 <code>tag</code> \u6807\u8bc6\u5bb9\u5668\uff0c<code>stream</code> \u6807\u8bc6 stdout \u6216\u8005 stderr\u3002</p> <p>\u7531\u4e8e\u5728 fluentd \u914d\u7f6e\u4e2d\u6211\u4eec\u6dfb\u52a0\u4e86\u5982\u4e0b\u6240\u793a\u7684\u8fc7\u6ee4\u5668\uff1a</p> <pre><code>&lt;filter kubernetes.**&gt;\n  @id filter_parser\n  @type parser                # multi-format-parser\u591a\u683c\u5f0f\u89e3\u6790\u5668\u63d2\u4ef6\n  key_name log                # \u5728\u8981\u89e3\u6790\u7684\u8bb0\u5f55\u4e2d\u6307\u5b9a\u5b57\u6bb5\u540d\u79f0\n  reserve_data true           # \u5728\u89e3\u6790\u7ed3\u679c\u4e2d\u4fdd\u7559\u539f\u59cb\u952e\u503c\u5bf9\n  remove_key_name_field true  # key_name \u89e3\u6790\u6210\u529f\u540e\u5220\u9664\u5b57\u6bb5\u3002\n  &lt;parse&gt;\n    @type multi_format\n    &lt;pattern&gt;\n      format json\n    &lt;/pattern&gt;\n    &lt;pattern&gt;\n      format none\n    &lt;/pattern&gt;\n  &lt;/parse&gt;\n&lt;/filter&gt;\n</code></pre> <p>\u8be5\u8fc7\u6ee4\u5668\u4f7f\u7528 <code>json</code> \u548c <code>none</code> \u4e24\u4e2a\u63d2\u4ef6\u5c06 JSON \u6570\u636e\u8fdb\u884c\u7ed3\u6784\u5316\uff0c\u8fd9\u6837\u5c31\u4f1a\u628a JSON \u65e5\u5fd7\u91cc\u9762\u7684\u5c5e\u6027\u89e3\u6790\u6210\u4e00\u4e2a\u4e00\u4e2a\u7684\u5b57\u6bb5\uff0c\u89e3\u6790\u751f\u6548\u8fc7\u540e\u8bb0\u5f97\u5237\u65b0 Kibana \u7684\u7d22\u5f15\u5b57\u6bb5\uff0c\u5426\u5219\u4f1a\u8bc6\u522b\u4e0d\u4e86\u8fd9\u4e9b\u5b57\u6bb5\uff0c\u901a\u8fc7 <code>\u7ba1\u7406</code> -&gt; <code>Index Pattern</code> \u70b9\u51fb\u5237\u65b0\u5b57\u6bb5\u5217\u8868\u5373\u53ef\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u5c06\u793a\u4f8b\u5e94\u7528\u90e8\u7f72\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff1a(dummylogs.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: dummylogs\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: dummylogs\n  template:\n    metadata:\n      labels:\n        app: dummylogs\n        logging: \"true\"  # \u8981\u91c7\u96c6\u65e5\u5fd7\u9700\u8981\u52a0\u4e0a\u8be5\u6807\u7b7e\n    spec:\n      containers:\n      - name: dummy\n        image: cnych/dummylogs:latest\n        args:\n        - msg-processor\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: dummylogs2\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: dummylogs2\n  template:\n    metadata:\n      labels:\n        app: dummylogs2\n        logging: \"true\"  # \u8981\u91c7\u96c6\u65e5\u5fd7\u9700\u8981\u52a0\u4e0a\u8be5\u6807\u7b7e\n    spec:\n      containers:\n      - name: dummy\n        image: cnych/dummylogs:latest\n        args:\n        - msg-receiver-api\n</code></pre> <p>\u76f4\u63a5\u90e8\u7f72\u4e0a\u9762\u7684\u5e94\u7528\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f dummylogs.yaml\n$ kubectl get pods -l logging=true\nNAME                         READY   STATUS    RESTARTS   AGE\ncounter                      1/1     Running   0          22h\ndummylogs-6f7b56579d-7js8n   1/1     Running   5          15h\ndummylogs-6f7b56579d-wdnc6   1/1     Running   5          15h\ndummylogs-6f7b56579d-x4twn   1/1     Running   5          15h\ndummylogs2-d9b978d9b-bchks   1/1     Running   5          15h\ndummylogs2-d9b978d9b-wv7rj   1/1     Running   5          15h\ndummylogs2-d9b978d9b-z2r26   1/1     Running   5          15h\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e dummylogs \u548c dummylogs2 \u4e24\u4e2a\u5e94\u7528\u5c31\u4f1a\u5f00\u59cb\u8f93\u51fa\u4e0d\u540c\u7ea7\u522b\u7684\u65e5\u5fd7\u4fe1\u606f\u4e86\uff0c\u8bb0\u5f97\u8981\u7ed9\u5e94\u7528\u6240\u5728\u7684\u8282\u70b9\u6253\u4e0a </p> <pre><code>beta.kubernetes.io/fluentd-ds-ready=true\n</code></pre> <p>\u7684\u6807\u7b7e\uff0c\u5426\u5219 fluentd \u4e0d\u4f1a\u5728\u5bf9\u5e94\u7684\u8282\u70b9\u4e0a\u8fd0\u884c\u4e5f\u5c31\u4e0d\u4f1a\u6536\u96c6\u65e5\u5fd7\u4e86\u3002\u6b63\u5e38\u60c5\u51b5\u4e0b\u65e5\u5fd7\u5c31\u5df2\u7ecf\u53ef\u4ee5\u88ab\u91c7\u96c6\u5230 Elasticsearch \u5f53\u4e2d\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u524d\u5f80 Kibana \u7684 Dashboard \u9875\u9762\u67e5\u770b:</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u53ef\u7528\u7684\u5b57\u6bb5\u4e2d\u5df2\u7ecf\u5305\u542b\u6211\u4eec\u5e94\u7528\u4e2d\u7684\u4e00\u4e9b\u5b57\u6bb5\u4e86\u3002\u627e\u5230 <code>serviceName</code> \u5b57\u6bb5\u70b9\u51fb\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5df2\u7ecf\u91c7\u96c6\u4e86\u54ea\u4e9b\u670d\u52a1\u7684\u6d88\u606f\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u6536\u5230\u4e86\u6765\u81ea <code>msg-processor</code> \u548c <code>msg-receiver-api</code> \u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u5728\u6700\u8fd115\u5206\u949f\u4e4b\u5185\uff0c<code>api</code> \u670d\u52a1\u4ea7\u751f\u7684\u65e5\u5fd7\u66f4\u591a\uff0c\u70b9\u51fb\u540e\u9762\u7684\u52a0\u53f7\u5c31\u53ef\u4ee5\u53ea\u8fc7\u6ee4\u8be5\u670d\u52a1\u7684\u65e5\u5fd7\u6570\u636e\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5c55\u793a\u7684\u65e5\u5fd7\u6570\u636e\u7684\u5c5e\u6027\u6bd4\u8f83\u591a\uff0c\u6709\u65f6\u5019\u53ef\u80fd\u4e0d\u5229\u4e8e\u6211\u4eec\u67e5\u770b\u65e5\u5fd7\uff0c\u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u7b5b\u9009\u60f3\u8981\u5c55\u793a\u7684\u5b57\u6bb5:</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u9009\u62e9\u8981\u663e\u793a\u7684\u5b57\u6bb5\uff0c\u73b0\u5728\u67e5\u770b\u6d88\u606f\u7684\u65f6\u5019\u5c31\u6839\u636e\u6e05\u695a\u4e86\uff1a</p> <p></p> <p>\u6bd4\u5982\u4e3a\u4e86\u80fd\u591f\u66f4\u52a0\u6e05\u6670\u7684\u5c55\u793a\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u8fd8\u53ef\u4ee5\u5c06 <code>eventsNumber</code> \u548c <code>serviceName</code> \u5b57\u6bb5\u9009\u4e2d\u6dfb\u52a0\uff1a</p> <p></p> <p>\u7136\u540e\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u6765\u7b5b\u9009\u9700\u8981\u67e5\u770b\u7684\u65e5\u5fd7\u6570\u636e\uff1a</p> <p></p> <p>\u5982\u679c\u4f60\u7684 Elasticsearch \u7684\u67e5\u8be2\u8bed\u53e5\u6bd4\u8f83\u719f\u6089\u7684\u8bdd\uff0c\u4f7f\u7528\u67e5\u8be2\u8bed\u53e5\u80fd\u5b9e\u73b0\u7684\u7b5b\u9009\u529f\u80fd\u66f4\u52a0\u5f3a\u5927\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u67e5\u8be2 <code>mgs-processor</code> \u548c <code>msg-receiver-api</code> \u4e24\u4e2a\u670d\u52a1\u7684\u65e5\u5fd7\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u67e5\u8be2\u8bed\u53e5\uff1a</p> <pre><code>serviceName:msg-processor OR serviceName:msg-receiver-api\n</code></pre> <p>\u76f4\u63a5\u641c\u7d22\u6846\u4e2d\u8f93\u5165\u4e0a\u9762\u7684\u67e5\u8be2\u8bed\u53e5\u8fdb\u884c\u67e5\u8be2\u5373\u53ef\uff1a</p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a\u56fe\u8868\u6765\u5c55\u793a\u5df2\u7ecf\u5904\u7406\u4e86\u591a\u5c11 <code>msg-processor</code> \u670d\u52a1\u7684\u65e5\u5fd7\u4fe1\u606f\u3002\u5728 Kibana \u4e2d\u5207\u6362\u5230 <code>Visualize</code> \u9875\u9762\uff0c\u70b9\u51fb </p> <pre><code>Create new visualization\n</code></pre> <p>\u6309\u94ae\u9009\u62e9 <code>Area</code>\uff0c\u9009\u62e9 <code>k8s-*</code> \u7684\u7d22\u5f15\uff0c\u9996\u5148\u914d\u7f6e Y \u8f74\u7684\u6570\u636e\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 <code>eventsNumber</code> \u5b57\u6bb5\u7684 <code>Sum</code> \u51fd\u6570\u8fdb\u884c\u805a\u5408\uff1a</p> <p></p> <p>\u7136\u540e\u914d\u7f6e X \u8f74\u6570\u636e\u4f7f\u7528 <code>Date Histogram</code> \u7c7b\u578b\u7684 <code>@timestamp</code> \u5b57\u6bb5\uff1a</p> <p></p> <p>\u914d\u7f6e\u5b8c\u6210\u540e\u70b9\u51fb\u53f3\u4e0a\u89d2\u7684 <code>Apply Changes</code> \u6309\u94ae\u5219\u5c31\u4f1a\u5728\u53f3\u4fa7\u5c55\u793a\u51fa\u5bf9\u5e94\u7684\u56fe\u8868\u4fe1\u606f\uff1a</p> <p></p> <p>\u8fd9\u4e2a\u56fe\u8868\u5c55\u793a\u7684\u5c31\u662f\u6700\u8fd115\u5206\u949f\u5185\u88ab\u5904\u7406\u7684\u4e8b\u4ef6\u603b\u6570\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u81ea\u5df1\u9009\u62e9\u65f6\u95f4\u8303\u56f4\u3002\u6211\u4eec\u8fd8\u53ef\u4ee5\u5c06 <code>msg-receiver-api</code> \u4e8b\u4ef6\u7684\u6570\u91cf\u548c\u5df2\u5904\u7406\u7684\u6d88\u606f\u603b\u6570\u8fdb\u884c\u5173\u8054\uff0c\u5728\u8be5\u56fe\u8868\u4e0a\u6dfb\u52a0\u53e6\u5916\u4e00\u5c42\u6570\u636e\uff0c\u5728 Y \u8f74\u4e0a\u6dfb\u52a0\u4e00\u4e2a\u65b0\u6307\u6807\uff0c\u9009\u62e9 <code>Add metrics</code> \u548c <code>Y-axis</code>\uff0c\u7136\u540e\u540c\u6837\u9009\u62e9 <code>sum</code> \u805a\u5408\u5668\uff0c\u4f7f\u7528 <code>volume</code> \u5b57\u6bb5\uff1a</p> <p></p> <p>\u70b9\u51fb <code>Apply Changes</code> \u6309\u94ae\u5c31\u53ef\u4ee5\u540c\u65f6\u663e\u793a\u4e24\u4e2a\u670d\u52a1\u4e8b\u4ef6\u7684\u6570\u636e\u4e86\u3002\u6700\u540e\u70b9\u51fb\u9876\u90e8\u7684 <code>save</code> \u6765\u4fdd\u5b58\u8be5\u56fe\u8868\uff0c\u5e76\u4e3a\u5176\u6dfb\u52a0\u4e00\u4e2a\u540d\u79f0\u3002</p> <p>\u5728\u5b9e\u9645\u7684\u5e94\u7528\u4e2d\uff0c\u6211\u4eec\u53ef\u80fd\u5bf9\u5e94\u7528\u7684\u9519\u8bef\u65e5\u5fd7\u66f4\u52a0\u5173\u5fc3\uff0c\u9700\u8981\u4e86\u89e3\u5e94\u7528\u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u6240\u4ee5\u5bf9\u4e8e\u9519\u8bef\u6216\u8005\u8b66\u544a\u7ea7\u522b\u7684\u65e5\u5fd7\u8fdb\u884c\u7edf\u8ba1\u4e5f\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\u3002\u73b0\u5728\u6211\u4eec\u56de\u5230 <code>Discover</code> \u9875\u9762\uff0c\u8f93\u5165 </p> <pre><code>LOGLEVEL:ERROR OR LOGLEVEL:WARNING\n</code></pre> <p>\u67e5\u8be2\u8bed\u53e5\u6765\u8fc7\u6ee4\u6240\u6709\u7684\u9519\u8bef\u548c\u544a\u8b66\u65e5\u5fd7\uff1a</p> <p></p> <p>\u9519\u8bef\u65e5\u5fd7\u76f8\u5bf9\u8f83\u5c11\uff0c\u5b9e\u9645\u4e0a\u6211\u4eec\u8fd9\u91cc\u7684\u793a\u4f8b\u5e94\u7528\u4f1a\u6bcf 15-20 \u5206\u949f\u5de6\u53f3\u5c31\u4f1a\u629b\u51fa4\u4e2a\u9519\u8bef\u4fe1\u606f\uff0c\u5176\u4f59\u90fd\u662f\u8b66\u544a\u4fe1\u606f\u3002\u540c\u6837\u73b0\u5728\u6211\u4eec\u8fd8\u662f\u7528\u53ef\u89c6\u5316\u7684\u56fe\u8868\u6765\u5c55\u793a\u4e0b\u9519\u8bef\u65e5\u5fd7\u7684\u60c5\u51b5\u3002</p> <p>\u540c\u6837\u5207\u6362\u5230 <code>Visualize</code> \u9875\u9762\uff0c\u70b9\u51fb <code>Create visualization</code>\uff0c\u9009\u62e9 <code>Vertical Bar</code>\uff0c\u7136\u540e\u9009\u4e2d <code>k8s-*</code> \u7684 Index Pattern\u3002</p> <p></p> <p>\u73b0\u5728\u6211\u4eec\u5ffd\u7565 Y \u8f74\uff0c\u4f7f\u7528\u9ed8\u8ba4\u7684 <code>Count</code> \u8bbe\u7f6e\u6765\u663e\u793a\u6d88\u606f\u6570\u91cf\u3002\u9996\u5148\u70b9\u51fb <code>Buckets</code> \u4e0b\u9762\u7684 <code>X-axis</code>\uff0c\u7136\u540e\u540c\u6837\u9009\u62e9 <code>Date histogram</code>\uff0c\u7136\u540e\u70b9\u51fb\u4e0b\u65b9\u7684 <code>Add</code>\uff0c\u6dfb\u52a0 <code>Sub-Bueckt</code>\uff0c\u9009\u62e9 <code>Split series</code>:</p> <p></p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u7684\u5b57\u6bb5\u6765\u5206\u5272\u6761\u5f62\u56fe\uff0c\u9009\u62e9 <code>Terms</code> \u4f5c\u4e3a\u5b50\u805a\u5408\u65b9\u5f0f\uff0c\u7136\u540e\u9009\u62e9 <code>serviceName.keyword</code> \u5b57\u6bb5\uff0c\u6700\u540e\u70b9\u51fb <code>apply</code> \u751f\u6210\u56fe\u8868\uff1a</p> <p></p> <p>\u73b0\u5728\u4e0a\u9762\u7684\u56fe\u8868\u4ee5\u4e0d\u540c\u7684\u989c\u8272\u6765\u663e\u793a\u6bcf\u4e2a\u670d\u52a1\u6d88\u606f\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5728\u641c\u7d22\u6846\u4e2d\u8f93\u5165\u8981\u67e5\u627e\u7684\u5185\u5bb9\uff0c\u56e0\u4e3a\u73b0\u5728\u7684\u56fe\u8868\u662f\u6bcf\u4e2a\u670d\u52a1\u7684\u6240\u6709\u6d88\u606f\u8ba1\u6570\uff0c\u5305\u62ec\u6b63\u5e38\u548c\u9519\u8bef\u7684\u65e5\u5fd7\uff0c\u6211\u4eec\u8981\u8fc7\u6ee4\u544a\u8b66\u548c\u9519\u8bef\u7684\u65e5\u5fd7\uff0c\u540c\u6837\u8f93\u5165 </p> <pre><code>LOGLEVEL:ERROR OR LOGLEVEL:WARNING\n</code></pre> <p>\u67e5\u8be2\u8bed\u53e5\u8fdb\u884c\u641c\u7d22\u5373\u53ef\uff1a</p> <p></p> <p>\u4ece\u56fe\u8868\u4e0a\u53ef\u4ee5\u770b\u51fa\u6765 <code>msg-processor</code> \u670d\u52a1\u95ee\u9898\u8f83\u591a\uff0c\u53ea\u6709\u5c11\u91cf\u7684\u662f <code>msg-receiver-api</code> \u670d\u52a1\u7684\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u53ea\u67e5\u770b <code>ERROR</code> \u7ea7\u522b\u7684\u65e5\u5fd7\u7edf\u8ba1\u4fe1\u606f\uff1a</p> <p></p> <p>\u4ece\u56fe\u8868\u4e0a\u53ef\u4ee5\u770b\u51fa\u6765\u57fa\u672c\u4e0a\u51fa\u73b0\u9519\u8bef\u65e5\u5fd7\u7684\u60c5\u51b5\u4e0b\u4e24\u4e2a\u670d\u52a1\u90fd\u4f1a\u51fa\u73b0\uff0c\u6240\u4ee5\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u731c\u6d4b\u4e24\u4e2a\u670d\u52a1\u7684\u9519\u8bef\u662f\u975e\u5e38\u76f8\u5173\u7684\u4e86\uff0c\u8fd9\u5bf9\u4e8e\u6211\u4eec\u53bb\u6392\u67e5\u9519\u8bef\u975e\u5e38\u6709\u5e2e\u52a9\u3002\u6700\u540e\u4e5f\u5c06\u8be5\u56fe\u8868\u8fdb\u884c\u4fdd\u5b58\u3002</p> <p>\u6700\u540e\u6211\u4eec\u4e5f\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684\u4e24\u4e2a\u56fe\u8868\u6dfb\u52a0\u5230 <code>dashboard</code> \u4e2d\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u4e00\u4e2a\u9875\u9762\u4e0a\u7ec4\u5408\u5404\u79cd\u53ef\u89c6\u5316\u56fe\u8868\u3002\u5207\u6362\u5230 <code>dashboard</code> \u9875\u9762\uff0c\u7136\u540e\u70b9\u51fb <code>Create New Dashboard</code> \u6309\u94ae\uff1a</p> <p></p> <p>\u9009\u62e9 <code>Add an existing</code> \u94fe\u63a5\uff1a</p> <p></p> <p>\u7136\u540e\u9009\u62e9\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684\u4e24\u4e2a\u56fe\u8868\uff0c\u6dfb\u52a0\u5b8c\u6210\u540e\u540c\u6837\u4fdd\u5b58\u8be5 <code>dashboard</code> \u5373\u53ef\uff1a</p> <p></p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u901a\u8fc7 Fluentd \u6536\u96c6\u65e5\u5fd7\u5230 Elasticsearch\uff0c\u5e76\u901a\u8fc7 Kibana \u5bf9\u65e5\u5fd7\u8fdb\u884c\u4e86\u5206\u6790\u53ef\u89c6\u5316\u64cd\u4f5c\u3002</p>"},{"location":"kubernetes_logs/efk/#_8","title":"\u57fa\u4e8e\u65e5\u5fd7\u7684\u62a5\u8b66","text":"<p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u6211\u4eec\u5f80\u5f80\u90fd\u4f1a\u4f7f\u7528 Promethus \u5bf9\u5e94\u7528\u7684\u5404\u9879\u6307\u6807\u8fdb\u884c\u76d1\u63a7\uff0c\u4f46\u662f\u5f80\u5f80\u5e94\u7528\u7684\u65e5\u5fd7\u4e2d\u4e5f\u4f1a\u4ea7\u751f\u4e00\u4e9b\u9519\u8bef\u65e5\u5fd7\uff0c\u8fd9\u4e9b\u4fe1\u606f\u5e76\u4e0d\u662f\u90fd\u80fd\u591f\u901a\u8fc7 metrics \u63d0\u4f9b\u6570\u636e\u7684\uff0c\u6240\u4ee5\u4e3a\u4e86\u907f\u514d\u51fa\u73b0\u592a\u591a\u7684\u9519\u8bef\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u5bf9\u9519\u8bef\u65e5\u5fd7\u8fdb\u884c\u76d1\u63a7\u62a5\u8b66\u3002\u5728 Elasticsearch \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 <code>elastalert</code> \u7ec4\u4ef6\u6765\u5b8c\u6210\u8fd9\u4e2a\u5de5\u4f5c\u3002</p> <p>elastalert \u662f yelp \u4f7f\u7528 python \u5f00\u53d1\u7684 elasticsearch \u544a\u8b66\u5de5\u5177\u3002<code>elastalert</code> \u4f9d\u7167\u4e00\u5b9a\u9891\u7387\u67e5\u8be2 ES\uff0c\u5c06\u67e5\u8be2\u7ed3\u679c\u5bf9\u6bd4\u544a\u8b66\u9608\u503c\uff0c\u8d85\u8fc7\u9608\u503c\u5373\u8fdb\u884c\u544a\u8b66\u3002\u544a\u8b66\u65b9\u5f0f\u5305\u62ec\u4f46\u4e0d\u5c40\u9650\u4e8e\u90ae\u7bb1\u3001\u5fae\u4fe1\u3001\u9489\u9489\u7b49\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u5c06 <code>elastalert</code> \u90e8\u7f72\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a(elastalert.yaml)</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: elastalert-config\n  namespace: logging\n  labels:\n    app: elastalert\ndata:\n  elastalert_config: |-\n    ---\n    rules_folder: /opt/rules       # \u6307\u5b9a\u89c4\u5219\u7684\u76ee\u5f55\n    scan_subdirectories: false\n    run_every:                     # \u591a\u4e45\u4ece ES \u4e2d\u67e5\u8be2\u4e00\u6b21\n      minutes: 1\n    buffer_time:\n      minutes: 15\n    es_host: elasticsearch\n    es_port: 9200\n    writeback_index: elastalert\n    use_ssl: False\n    verify_certs: True\n    alert_time_limit:             # \u5931\u8d25\u91cd\u8bd5\u9650\u5236\n      minutes: 2880\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: elastalert-rules\n  namespace: logging\n  labels:\n    app: elastalert\ndata:\n  rule_config.yaml: |-\n    name: dummylogs error     # \u89c4\u5219\u540d\u5b57\uff0c\u552f\u4e00\u503c\n    es_host: elasticsearch\n    es_port: 9200\n\n    type: any                 # \u62a5\u8b66\u7c7b\u578b\n    index: k8s-*              # es\u7d22\u5f15\n\n    filter:                   # \u8fc7\u6ee4\n    - query:\n        query_string:\n          query: \"LOGLEVEL:ERROR\"  # \u62a5\u8b66\u6761\u4ef6\n\n    alert:                    # \u62a5\u8b66\u7c7b\u578b\n    - \"email\"\n    smtp_host: smtp.qq.com\n    smtp_port: 587\n    smtp_auth_file: /opt/auth/smtp_auth_file.yaml\n    email_reply_to: 517554016@qq.com\n    from_addr: 517554016@qq.com\n    email:                  # \u63a5\u53d7\u90ae\u7bb1\n    - \"ych_1024@1com\"\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: elastalert\n  namespace: logging\n  labels:\n    app: elastalert\nspec:\n  selector:\n    matchLabels:\n      app: elastalert\n  template:\n    metadata:\n      labels:\n        app: elastalert\n    spec:\n      containers:\n      - name: elastalert\n        image: jertel/elastalert-docker:4\n        imagePullPolicy: IfNotPresent\n        volumeMounts:\n        - name: config\n          mountPath: /opt/config\n        - name: rules\n          mountPath: /opt/rules\n        - name: auth\n          mountPath: /opt/auth\n        resources:\n          limits:\n            cpu: 50m\n            memory: 256Mi\n          requests:\n            cpu: 50m\n            memory: 256Mi\n      volumes:\n      - name: auth\n        secret:\n          secretName: smtp-auth\n      - name: rules\n        configMap:\n          name: elastalert-rules\n      - name: config\n        configMap:\n          name: elastalert-config\n          items:\n          - key: elastalert_config\n            path: elastalert_config.yaml\n</code></pre> <p>\u4f7f\u7528\u90ae\u4ef6\u8fdb\u884c\u62a5\u8b66\u7684\u65f6\u5019\uff0c\u9700\u8981\u6307\u5b9a\u4e00\u4e2a <code>smtp_auth_file</code> \u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u4e2d\u5305\u542b\u7528\u6237\u540d\u548c\u5bc6\u7801\uff1a(smtp_auth_file.yaml)</p> <pre><code>user: \"xxxxx@qq.com\"       # \u53d1\u9001\u7684\u90ae\u7bb1\u5730\u5740\npassword: \"ewwghfhdvjwnbjea\"   # \u4e0d\u662fqq\u90ae\u7bb1\u7684\u767b\u5f55\u5bc6\u7801\uff0c\u662f\u6388\u6743\u7801\n</code></pre> <p>\u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684\u6587\u4ef6\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 Secret \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create secret generic smtp-auth --from-file=smtp_auth_file.yaml -n logging\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 elastalert \u5e94\u7528\uff1a</p> <pre><code>$ kubectl apply -f elastalert.yaml\n$ kubectl get pods -n logging -l app=elastalert\nNAME                          READY   STATUS    RESTARTS   AGE\nelastalert-64ccfbffcf-gd6xz   1/1     Running   0          102s\n$ kubectl logs -f elastalert-64ccfbffcf-gd6xz -n logging\nElastic Version: 2\nReading Elastic 6 index mappings:\nReading index mapping 'es_mappings/6/silence.json'\nReading index mapping 'es_mappings/6/elastalert_status.json'\nReading index mapping 'es_mappings/6/elastalert.json'\nReading index mapping 'es_mappings/6/past_elastalert.json'\nReading index mapping 'es_mappings/6/elastalert_error.json'\nDeleting index elastalert_status.\nNew index elastalert created\nDone!\n</code></pre> <p>\u770b\u5230\u4e0a\u9762\u7684\u65e5\u5fd7\u4fe1\u606f\u5c31\u8bc1\u660e elastalert \u5e94\u7528\u90e8\u7f72\u6210\u529f\u4e86\u3002\u5728 Elasticsearch \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u51e0\u4e2a\u76f8\u5173\u7684 Index \uff1a</p> <p></p> <p>\u7531\u4e8e\u6211\u4eec\u7684\u793a\u4f8b\u5e94\u7528\u4f1a\u9694\u4e00\u6bb5\u65f6\u95f4\u5c31\u4ea7\u751f ERROR \u7ea7\u522b\u7684\u9519\u8bef\u65e5\u5fd7\uff0c\u6240\u4ee5\u6b63\u5e38\u60c5\u51b5\u4e0b\u6211\u4eec\u5c31\u53ef\u4ee5\u6536\u5230\u5982\u4e0b\u6240\u793a\u7684\u90ae\u4ef6\u4fe1\u606f\u4e86\uff1a</p> <p></p> <p>\u9664\u6b64\u4e4b\u5916\u6211\u4eec\u4e5f\u53ef\u4ee5\u914d\u7f6e\u5c06\u62a5\u8b66\u4fe1\u606f\u53d1\u5f80 \u4f01\u4e1a\u5fae\u4fe1 \u6216\u8005 \u9489\u9489\uff0c\u8fd8\u53ef\u4ee5\u5b89\u88c5\u4e00\u4e2a elastalert \u7684 Kibana \u63d2\u4ef6\uff0c\u7528\u4e8e\u5728 Kibana \u9875\u9762\u4e0a\u8fdb\u884c\u53ef\u89c6\u5316\u64cd\u4f5c\u3002</p> <p>\u5173\u4e8e elastalert \u66f4\u591a\u7684\u64cd\u4f5c\u548c\u4f7f\u7528\u8bf4\u660e\uff0c\u5927\u5bb6\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863\u4e86\u89e3\u66f4\u591a\uff1ahttps://elastalert.readthedocs.io/en/latest/\u3002</p>"},{"location":"kubernetes_maintain/reserved/","title":"\u8d44\u6e90\u9884\u7559","text":""},{"location":"kubernetes_maintain/reserved/#_1","title":"\u8d44\u6e90\u9884\u7559","text":"<p>Kubernetes \u7684\u8282\u70b9\u53ef\u4ee5\u6309\u7167\u8282\u70b9\u7684\u8d44\u6e90\u5bb9\u91cf\u8fdb\u884c\u8c03\u5ea6\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b Pod \u80fd\u591f\u4f7f\u7528\u8282\u70b9\u5168\u90e8\u53ef\u7528\u5bb9\u91cf\u3002\u8fd9\u6837\u5c31\u4f1a\u9020\u6210\u4e00\u4e2a\u95ee\u9898\uff0c\u56e0\u4e3a\u8282\u70b9\u81ea\u5df1\u901a\u5e38\u8fd0\u884c\u4e86\u4e0d\u5c11\u9a71\u52a8 OS \u548c Kubernetes \u7684\u7cfb\u7edf\u5b88\u62a4\u8fdb\u7a0b\u3002\u9664\u975e\u4e3a\u8fd9\u4e9b\u7cfb\u7edf\u5b88\u62a4\u8fdb\u7a0b\u7559\u51fa\u8d44\u6e90\uff0c\u5426\u5219\u5b83\u4eec\u5c06\u4e0e Pod \u4e89\u593a\u8d44\u6e90\u5e76\u5bfc\u81f4\u8282\u70b9\u8d44\u6e90\u77ed\u7f3a\u95ee\u9898\u3002</p> <p>\u5f53\u6211\u4eec\u5728\u7ebf\u4e0a\u4f7f\u7528 Kubernetes \u96c6\u7fa4\u7684\u65f6\u5019\uff0c\u5982\u679c\u6ca1\u6709\u5bf9\u8282\u70b9\u914d\u7f6e\u6b63\u786e\u7684\u8d44\u6e90\u9884\u7559\uff0c\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u4e00\u4e2a\u573a\u666f\uff0c\u7531\u4e8e\u67d0\u4e2a\u5e94\u7528\u65e0\u9650\u5236\u7684\u4f7f\u7528\u8282\u70b9\u7684 CPU \u8d44\u6e90\uff0c\u5bfc\u81f4\u8282\u70b9\u4e0a CPU \u4f7f\u7528\u6301\u7eed100%\u8fd0\u884c\uff0c\u800c\u4e14\u538b\u69a8\u5230\u4e86 kubelet \u7ec4\u4ef6\u7684 CPU \u4f7f\u7528\uff0c\u8fd9\u6837\u5c31\u4f1a\u5bfc\u81f4 kubelet \u548c apiserver \u7684\u5fc3\u8df3\u51fa\u95ee\u9898\uff0c\u8282\u70b9\u5c31\u4f1a\u51fa\u73b0 Not Ready \u72b6\u51b5\u4e86\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8282\u70b9 Not Ready \u8fc7\u540e\uff0c5\u5206\u949f\u540e\u4f1a\u9a71\u9010\u5e94\u7528\u5230\u5176\u4ed6\u8282\u70b9\uff0c\u5f53\u8fd9\u4e2a\u5e94\u7528\u8dd1\u5230\u5176\u4ed6\u8282\u70b9\u4e0a\u7684\u65f6\u5019\u540c\u6837100%\u7684\u4f7f\u7528 CPU\uff0c\u662f\u4e0d\u662f\u4e5f\u4f1a\u628a\u8fd9\u4e2a\u8282\u70b9\u641e\u6302\u6389\uff0c\u540c\u6837\u7684\u60c5\u51b5\u7ee7\u7eed\u4e0b\u53bb\uff0c\u4e5f\u5c31\u5bfc\u81f4\u4e86\u6574\u4e2a\u96c6\u7fa4\u7684<code>\u96ea\u5d29</code>\uff0c\u96c6\u7fa4\u5185\u7684\u8282\u70b9\u4e00\u4e2a\u4e00\u4e2a\u7684 Not Ready \u4e86\uff0c\u540e\u679c\u662f\u975e\u5e38\u4e25\u91cd\u7684\uff0c\u6216\u591a\u6216\u5c11\u7684\u4eba\u9047\u5230\u8fc7 Kubernetes \u96c6\u7fa4\u96ea\u5d29\u7684\u60c5\u51b5\uff0c\u8fd9\u4e2a\u95ee\u9898\u4e5f\u662f\u9762\u8bd5\u7684\u65f6\u5019\u955c\u50cf\u8be2\u95ee\u7684\u95ee\u9898\u3002</p> <p>\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u5c31\u9700\u8981\u4e3a Kubernetes \u96c6\u7fa4\u914d\u7f6e\u8d44\u6e90\u9884\u7559\uff0ckubelet \u66b4\u9732\u4e86\u4e00\u4e2a\u540d\u4e3a <code>Node Allocatable</code> \u7684\u7279\u6027\uff0c\u6709\u52a9\u4e8e\u4e3a\u7cfb\u7edf\u5b88\u62a4\u8fdb\u7a0b\u9884\u7559\u8ba1\u7b97\u8d44\u6e90\uff0cKubernetes \u4e5f\u662f\u63a8\u8350\u96c6\u7fa4\u7ba1\u7406\u5458\u6309\u7167\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u6765\u914d\u7f6e Node Allocatable\u3002</p> <p>\u672c\u6587\u7684\u64cd\u4f5c\u73af\u5883\u4e3a Kubernetes V1.17.11 \u7248\u672c\uff0cDocker \u548c Kubelet \u91c7\u7528\u7684 cgroup \u9a71\u52a8\u4e3a <code>systemd</code>\u3002</p>"},{"location":"kubernetes_maintain/reserved/#node_allocatable","title":"Node Allocatable","text":"<p>Kubernetes \u8282\u70b9\u4e0a\u7684 Allocatable \u88ab\u5b9a\u4e49\u4e3a Pod \u53ef\u7528\u8ba1\u7b97\u8d44\u6e90\u91cf\uff0c\u8c03\u5ea6\u5668\u4e0d\u4f1a\u8d85\u989d\u7533\u8bf7 Allocatable,\u76ee\u524d\u652f\u6301 CPU, memory \u548c ephemeral-storage \u8fd9\u51e0\u4e2a\u53c2\u6570\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>kubectl describe node\n</code></pre> <p>\u547d\u4ee4\u67e5\u770b\u8282\u70b9\u53ef\u5206\u914d\u8d44\u6e90\u7684\u6570\u636e\uff1a</p> <pre><code>$ kubectl describe node ydzs-node4\n......\nCapacity:\n  cpu:                4\n  ephemeral-storage:  17921Mi\n  hugepages-2Mi:      0\n  memory:             8008820Ki\n  pods:               110\nAllocatable:\n  cpu:                4\n  ephemeral-storage:  16912377419\n  hugepages-2Mi:      0\n  memory:             7906420Ki\n  pods:               110\n......\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5176\u4e2d\u6709 <code>Capacity</code> \u4e0e <code>Allocatable</code> \u4e24\u9879\u5185\u5bb9\uff0c\u5176\u4e2d\u7684 <code>Allocatable</code> \u5c31\u662f\u8282\u70b9\u53ef\u88ab\u5206\u914d\u7684\u8d44\u6e90\uff0c\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\u914d\u7f6e\u8d44\u6e90\u9884\u7559\uff0c\u6240\u4ee5\u9ed8\u8ba4\u60c5\u51b5\u4e0b <code>Capacity</code> \u4e0e <code>Allocatable</code> \u7684\u503c\u57fa\u672c\u4e0a\u662f\u4e00\u81f4\u7684\u3002\u4e0b\u56fe\u663e\u793a\u4e86\u53ef\u5206\u914d\u8d44\u6e90\u548c\u8d44\u6e90\u9884\u7559\u4e4b\u95f4\u7684\u5173\u7cfb\uff1a</p> <p></p> <ul> <li>Kubelet Node Allocatable \u7528\u6765\u4e3a Kube \u7ec4\u4ef6\u548c System \u8fdb\u7a0b\u9884\u7559\u8d44\u6e90\uff0c\u4ece\u800c\u4fdd\u8bc1\u5f53\u8282\u70b9\u51fa\u73b0\u6ee1\u8d1f\u8377\u65f6\u4e5f\u80fd\u4fdd\u8bc1 Kube \u548c System \u8fdb\u7a0b\u6709\u8db3\u591f\u7684\u8d44\u6e90\u3002</li> <li>\u76ee\u524d\u652f\u6301 cpu, memory, ephemeral-storage \u4e09\u79cd\u8d44\u6e90\u9884\u7559\u3002</li> <li>Node Capacity \u662f\u8282\u70b9\u7684\u6240\u6709\u786c\u4ef6\u8d44\u6e90\uff0c<code>kube-reserved</code> \u662f\u7ed9 kube \u7ec4\u4ef6\u9884\u7559\u7684\u8d44\u6e90\uff0c<code>system-reserved</code> \u662f\u7ed9\u7cfb\u7edf\u8fdb\u7a0b\u9884\u7559\u7684\u8d44\u6e90\uff0c<code>eviction-threshold</code> \u662f kubelet \u9a71\u9010\u7684\u9608\u503c\u8bbe\u5b9a\uff0callocatable \u624d\u662f\u771f\u6b63\u8c03\u5ea6\u5668\u8c03\u5ea6 Pod \u65f6\u7684\u53c2\u8003\u503c\uff08\u4fdd\u8bc1\u8282\u70b9\u4e0a\u6240\u6709 Pods \u7684 request \u8d44\u6e90\u4e0d\u8d85\u8fc7Allocatable\uff09\u3002</li> </ul> <p>\u8282\u70b9\u53ef\u5206\u914d\u8d44\u6e90\u7684\u8ba1\u7b97\u65b9\u5f0f\u4e3a\uff1a</p> <pre><code>Node Allocatable Resource = Node Capacity - Kube-reserved - system-reserved - eviction-threshold\n</code></pre>"},{"location":"kubernetes_maintain/reserved/#_2","title":"\u914d\u7f6e\u8d44\u6e90\u9884\u7559","text":""},{"location":"kubernetes_maintain/reserved/#kube","title":"Kube \u9884\u7559\u503c","text":"<p>\u9996\u5148\u6211\u4eec\u6765\u914d\u7f6e Kube \u9884\u7559\u503c\uff0ckube-reserved \u662f\u4e3a\u4e86\u7ed9\u8bf8\u5982 kubelet\u3001\u5bb9\u5668\u8fd0\u884c\u65f6\u3001node problem detector \u7b49 kubernetes \u7cfb\u7edf\u5b88\u62a4\u8fdb\u7a0b\u4e89\u53d6\u8d44\u6e90\u9884\u7559\u3002\u8981\u914d\u7f6e Kube \u9884\u7559\uff0c\u9700\u8981\u628a kubelet \u7684 </p> <pre><code>--kube-reserved-cgroup\n</code></pre> <p>\u6807\u5fd7\u7684\u503c\u8bbe\u7f6e\u4e3a kube \u5b88\u62a4\u8fdb\u7a0b\u7684\u7236\u63a7\u5236\u7ec4\u3002</p> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\uff0c\u5982\u679c </p> <pre><code>--kube-reserved-cgroup\n</code></pre> <p>\u4e0d\u5b58\u5728\uff0cKubelet \u4e0d\u4f1a\u521b\u5efa\u5b83\uff0c\u542f\u52a8 Kubelet \u5c06\u4f1a\u5931\u8d25\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4fee\u6539 node-ydzs4 \u8282\u70b9\u7684 Kube \u8d44\u6e90\u9884\u7559\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4fee\u6539 </p> <pre><code>/var/lib/kubelet/config.yaml\n</code></pre> <p>\u6587\u4ef6\u6765\u52a8\u6001\u914d\u7f6e kubelet\uff0c\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u9884\u7559\u914d\u7f6e\uff1a</p> <pre><code>apiVersion: kubelet.config.k8s.io/v1beta1\n......\nenforceNodeAllocatable:\n- pods\n- kube-reserved  # \u5f00\u542f kube \u8d44\u6e90\u9884\u7559\nkubeReserved:\n  cpu: 500m\n  memory: 1Gi\n  ephemeral-storage: 1Gi\nkubeReservedCgroup: /kubelet.slice  # \u6307\u5b9a kube \u8d44\u6e90\u9884\u7559\u7684 cgroup\n</code></pre> <p>\u4fee\u6539\u5b8c\u6210\u540e\uff0c\u91cd\u542f kubelet\uff0c\u5982\u679c\u6ca1\u6709\u521b\u5efa\u4e0a\u9762\u7684 kubelet \u7684 cgroup\uff0c\u542f\u52a8\u4f1a\u5931\u8d25\uff1a</p> <pre><code>$ systemctl restart kubelet\n$ journalctl -u kubelet -f\n......\nAug 11 15:04:13 ydzs-node4 kubelet[28843]: F0811 15:04:653476   28843 kubelet.go:1380] Failed to start ContainerManager Failed to enforce Kube Reserved Cgroup Limits on \"/kubelet.slice\": [\"kubelet\"] cgroup does not exist\n</code></pre> <p>\u4e0a\u9762\u7684\u63d0\u793a\u4fe1\u606f\u5f88\u660e\u663e\uff0c\u6211\u4eec\u6307\u5b9a\u7684 kubelet \u8fd9\u4e2a cgroup \u4e0d\u5b58\u5728\uff0c\u4f46\u662f\u7531\u4e8e\u5b50\u7cfb\u7edf\u8f83\u591a\uff0c\u5177\u4f53\u662f\u54ea\u4e00\u4e2a\u5b50\u7cfb\u7edf\u4e0d\u5b58\u5728\u4e0d\u597d\u5b9a\u4f4d\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06 kubelet \u7684\u65e5\u5fd7\u7ea7\u522b\u8c03\u6574\u4e3a <code>v=4</code>\uff0c\u5c31\u53ef\u4ee5\u770b\u5230\u5177\u4f53\u4e22\u5931\u7684 cgroup \u8def\u5f84\uff1a</p> <pre><code>$ vi /var/lib/kubelet/kubeadm-flags.env\nKUBELET_KUBEADM_ARGS=\"--v=4 --cgroup-driver=systemd --network-plugin=cni\"\n</code></pre> <p>\u7136\u540e\u518d\u6b21\u91cd\u542f kubelet\uff1a</p> <pre><code>$ systemctl daemon-reload\n$ systemctl restart kubelet\n</code></pre> <p>\u518d\u6b21\u67e5\u770b kubelet \u65e5\u5fd7\uff1a</p> <pre><code>$ journalctl -u kubelet -f\n......\nSep 09 17:57:36 ydzs-node4 kubelet[20427]: I0909 17:57:382811   20427 cgroup_manager_linux.go:273] The Cgroup [kubelet] has some missing paths: [/sys/fs/cgroup/cpu,cpuacct/kubelet.slice /sys/fs/cgroup/memory/kubelet.slice /sys/fs/cgroup/systemd/kubelet.slice /sys/fs/cgroup/pids/kubelet.slice /sys/fs/cgroup/cpu,cpuacct/kubelet.slice /sys/fs/cgroup/cpuset/kubelet.slice]\nSep 09 17:57:36 ydzs-node4 kubelet[20427]: I0909 17:57:383002   20427 factory.go:170] Factory \"systemd\" can handle container \"/system.slice/run-docker-netns-db100461211c.mount\", but ignoring.\nSep 09 17:57:36 ydzs-node4 kubelet[20427]: I0909 17:57:383025   20427 manager.go:908] ignoring container \"/system.slice/run-docker-netns-db100461211c.mount\"\nSep 09 17:57:36 ydzs-node4 kubelet[20427]: F0909 17:57:383046   20427 kubelet.go:1381] Failed to start ContainerManager Failed to enforce Kube Reserved Cgroup Limits on \"/kubelet.slice\": [\"kubelet\"] cgroup does not exist\n</code></pre> <p><code>\u6ce8\u610f</code>\uff1asystemd \u7684 cgroup \u9a71\u52a8\u5bf9\u5e94\u7684 cgroup \u540d\u79f0\u662f\u4ee5 <code>.slice</code> \u7ed3\u5c3e\u7684\uff0c\u6bd4\u5982\u5982\u679c\u4f60\u628a cgroup \u540d\u79f0<code>\u914d\u7f6e\u6210</code>kubelet.service</p> <pre><code>\uff0c\u90a3\u4e48\u5bf9\u5e94\u7684\u521b\u5efa\u7684 cgroup \u540d\u79f0\u5e94\u8be5\u4e3a\n</code></pre> <p>kubelet.service.slice`\u3002\u5982\u679c\u4f60\u914d\u7f6e\u7684\u662f cgroupfs \u7684\u9a71\u52a8\uff0c\u5219\u7528\u914d\u7f6e\u7684\u503c\u5373\u53ef\u3002\u65e0\u8bba\u54ea\u79cd\u65b9\u5f0f\uff0c\u901a\u8fc7\u67e5\u770b\u9519\u8bef\u65e5\u5fd7\u90fd\u662f\u6392\u67e5\u95ee\u9898\u6700\u597d\u7684\u65b9\u5f0f\u3002</p> <p>\u73b0\u5728\u53ef\u4ee5\u770b\u5230\u5177\u4f53\u7684 cgroup \u4e0d\u5b58\u5728\u7684\u8def\u5f84\u4fe1\u606f\u4e86\uff1a</p> <pre><code>The Cgroup [kubelet] has some missing paths: [/sys/fs/cgroup/cpu,cpuacct/kubelet.slice /sys/fs/cgroup/memory/kubelet.slice /sys/fs/cgroup/systemd/kubelet.slice /sys/fs/cgroup/pids/kubelet.slice /sys/fs/cgroup/cpu,cpuacct/kubelet.slice /sys/fs/cgroup/cpuset/kubelet.slice]\n</code></pre> <p>\u6240\u4ee5\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u4e5f\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u53ea\u9700\u8981\u521b\u5efa\u4e0a\u9762\u7684\u51e0\u4e2a\u8def\u5f84\u5373\u53ef\uff1a</p> <pre><code>$ mkdir -p /sys/fs/cgroup/cpu,cpuacct/kubelet.slice\n$ mkdir -p /sys/fs/cgroup/memory/kubelet.slice\n$ mkdir -p /sys/fs/cgroup/systemd/kubelet.slice\n$ mkdir -p /sys/fs/cgroup/pids/kubelet.slice\n$ mkdir -p /sys/fs/cgroup/cpu,cpuacct/kubelet.slice\n$ mkdir -p /sys/fs/cgroup/cpuset/kubelet.slice\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u518d\u6b21\u91cd\u542f\uff1a</p> <pre><code>$ systemctl restart kubelet\n$ journalctl -u kubelet -f\n......\nSep 09 17:59:41 ydzs-node4 kubelet[21462]: F0909 17:59:291957   21462 kubelet.go:1381] Failed to start ContainerManager Failed to enforce Kube Reserved Cgroup Limits on \"/kubelet.slice\": failed to set supported cgroup subsystems for cgroup [kubelet]: failed to set config for supported subsystems : failed to write 0 to hugetlb.2MB.limit_in_bytes: open /sys/fs/cgroup/hugetlb/kubelet.slice/hugetlb.2MB.limit_in_bytes: no such file or directory\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd8\u6709\u4e00\u4e2a <code>hugetlb</code> \u7684 cgroup \u8def\u5f84\u4e0d\u5b58\u5728\uff0c\u6240\u4ee5\u7ee7\u7eed\u521b\u5efa\u8fd9\u4e2a\u8def\u5f84\uff1a</p> <pre><code>$ mkdir -p /sys/fs/cgroup/hugetlb/kubelet.slice\n$ systemctl restart kubelet\n</code></pre> <p>\u91cd\u542f\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u6b63\u5e38\u542f\u52a8\u4e86\uff0c\u542f\u52a8\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b cgroup \u91cc\u9762\u7684\u9650\u5236\u4fe1\u606f\u6821\u9a8c\u662f\u5426\u914d\u7f6e\u6210\u529f\uff0c\u6bd4\u5982\u6211\u4eec\u67e5\u770b\u5185\u5b58\u7684\u9650\u5236\u4fe1\u606f\uff1a</p> <pre><code>$ cat /sys/fs/cgroup/memory/kubelet.slice/memory.limit_in_bytes\n1073741824  # 1Gi\n</code></pre> <p>\u73b0\u5728\u518d\u6b21\u67e5\u770b\u8282\u70b9\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe node ydzs-node4\n......\nAddresses:\n  InternalIP:  159\n  Hostname:    ydzs-node4\nCapacity:\n  cpu:                4\n  ephemeral-storage:  17921Mi\n  hugepages-2Mi:      0\n  memory:             8008820Ki\n  pods:               110\nAllocatable:\n  cpu:                3500m\n  ephemeral-storage:  15838635595\n  hugepages-2Mi:      0\n  memory:             6857844Ki\n  pods:               110\n......\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u53ef\u4ee5\u5206\u914d\u7684 Allocatable \u503c\u5c31\u53d8\u6210\u4e86 Kube \u9884\u7559\u8fc7\u540e\u7684\u503c\u4e86\uff0c\u8bc1\u660e\u6211\u4eec\u7684 Kube \u9884\u7559\u6210\u529f\u4e86\u3002</p>"},{"location":"kubernetes_maintain/reserved/#_3","title":"\u7cfb\u7edf\u9884\u7559\u503c","text":"<p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u7528\u540c\u6837\u7684\u65b9\u5f0f\u4e3a\u7cfb\u7edf\u914d\u7f6e\u9884\u7559\u503c\uff0c<code>system-reserved</code> \u7528\u4e8e\u4e3a\u8bf8\u5982 sshd\u3001udev \u7b49\u7cfb\u7edf\u5b88\u62a4\u8fdb\u7a0b\u4e89\u53d6\u8d44\u6e90\u9884\u7559\uff0csystem-reserved \u4e5f\u5e94\u8be5\u4e3a kernel \u9884\u7559 \u5185\u5b58\uff0c\u56e0\u4e3a\u76ee\u524d kernel \u4f7f\u7528\u7684\u5185\u5b58\u5e76\u4e0d\u8bb0\u5728 Kubernetes \u7684 pod \u4e0a\u3002\u4f46\u662f\u5728\u6267\u884c <code>system-reserved</code> \u9884\u7559\u64cd\u4f5c\u65f6\u8bf7\u52a0\u500d\u5c0f\u5fc3\uff0c\u56e0\u4e3a\u5b83\u53ef\u80fd\u5bfc\u81f4\u8282\u70b9\u4e0a\u7684\u5173\u952e\u7cfb\u7edf\u670d\u52a1 CPU \u8d44\u6e90\u77ed\u7f3a\u6216\u56e0\u4e3a\u5185\u5b58\u4e0d\u8db3\u800c\u88ab\u7ec8\u6b62\uff0c\u6240\u4ee5\u5982\u679c\u4e0d\u662f\u81ea\u5df1\u975e\u5e38\u6e05\u695a\u5982\u4f55\u914d\u7f6e\uff0c\u53ef\u4ee5\u4e0d\u7528\u914d\u7f6e\u7cfb\u7edf\u9884\u7559\u503c\u3002</p> <p>\u540c\u6837\u901a\u8fc7 kubelet \u7684\u53c2\u6570 <code>--system-reserved</code> \u914d\u7f6e\u7cfb\u7edf\u9884\u7559\u503c\uff0c\u4f46\u662f\u4e5f\u9700\u8981\u914d\u7f6e </p> <pre><code>--system-reserved-cgroup\n</code></pre> <p>\u53c2\u6570\u4e3a\u7cfb\u7edf\u8fdb\u7a0b\u8bbe\u7f6e cgroup\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u5982\u679c </p> <pre><code>--system-reserved-cgroup\n</code></pre> <p>\u4e0d\u5b58\u5728\uff0cKubelet \u4e0d\u4f1a\u521b\u5efa\u5b83\uff0ckubelet \u4f1a\u542f\u52a8\u5931\u8d25\u3002</p>"},{"location":"kubernetes_maintain/reserved/#_4","title":"\u9a71\u9010\u9608\u503c","text":"<p>\u4e0a\u9762\u6211\u4eec\u8fd8\u63d0\u5230\u53ef\u5206\u914d\u7684\u8d44\u6e90\u8fd8\u548c kubelet \u9a71\u9010\u7684\u9608\u503c\u6709\u5173\u3002\u8282\u70b9\u7ea7\u522b\u7684\u5185\u5b58\u538b\u529b\u5c06\u5bfc\u81f4\u7cfb\u7edf\u5185\u5b58\u4e0d\u8db3\uff0c\u8fd9\u5c06\u5f71\u54cd\u5230\u6574\u4e2a\u8282\u70b9\u53ca\u5176\u4e0a\u8fd0\u884c\u7684\u6240\u6709 Pod\uff0c\u8282\u70b9\u53ef\u4ee5\u6682\u65f6\u79bb\u7ebf\u76f4\u5230\u5185\u5b58\u5df2\u7ecf\u56de\u6536\u4e3a\u6b62\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e kubelet \u9a71\u9010\u9608\u503c\u6765\u9632\u6b62\u7cfb\u7edf\u5185\u5b58\u4e0d\u8db3\u3002\u9a71\u9010\u64cd\u4f5c\u53ea\u652f\u6301\u5185\u5b58\u548c ephemeral-storage \u4e24\u79cd\u4e0d\u53ef\u538b\u7f29\u8d44\u6e90\u3002\u5f53\u51fa\u73b0\u5185\u5b58\u4e0d\u8db3\u65f6\uff0c\u8c03\u5ea6\u5668\u4e0d\u4f1a\u8c03\u5ea6\u65b0\u7684 Best-Effort QoS Pods \u5230\u6b64\u8282\u70b9\uff0c\u5f53\u51fa\u73b0\u78c1\u76d8\u538b\u529b\u65f6\uff0c\u8c03\u5ea6\u5668\u4e0d\u4f1a\u8c03\u5ea6\u4efb\u4f55\u65b0 Pods \u5230\u6b64\u8282\u70b9\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u4e3a ydzs-node4 \u8282\u70b9\u914d\u7f6e\u5982\u4e0b\u6240\u793a\u7684\u786c\u9a71\u9010\u9608\u503c\uff1a</p> <pre><code># /var/lib/kubelet/config.yaml\n......\nevictionHard:  # \u914d\u7f6e\u786c\u9a71\u9010\u9608\u503c\n  memory.available: \"300Mi\"\n  nodefs.available: \"10%\"\nenforceNodeAllocatable:\n- pods\n- kube-reserved\nkubeReserved:\n  cpu: 500m\n  memory: 1Gi\n  ephemeral-storage: 1Gi\nkubeReservedCgroup: /kubelet.slice\n......\n</code></pre> <p>\u6211\u4eec\u901a\u8fc7 <code>--eviction-hard</code> \u9884\u7559\u4e00\u4e9b\u5185\u5b58\u540e\uff0c\u5f53\u8282\u70b9\u4e0a\u7684\u53ef\u7528\u5185\u5b58\u964d\u81f3\u4fdd\u7559\u503c\u4ee5\u4e0b\u65f6\uff0ckubelet \u5c06\u5c1d\u8bd5\u9a71\u9010 Pod\uff0c</p> <pre><code>$ kubectl describe node ydzs-node4\n......\nAddresses:\n  InternalIP:  159\n  Hostname:    ydzs-node4\nCapacity:\n  cpu:                4\n  ephemeral-storage:  17921Mi\n  hugepages-2Mi:      0\n  memory:             8008820Ki\n  pods:               110\nAllocatable:\n  cpu:                3500m\n  ephemeral-storage:  15838635595\n  hugepages-2Mi:      0\n  memory:             6653044Ki\n  pods:               110\n......\n</code></pre> <p>\u914d\u7f6e\u751f\u6548\u540e\u518d\u6b21\u67e5\u770b\u8282\u70b9\u53ef\u5206\u914d\u7684\u8d44\u6e90\u53ef\u4ee5\u770b\u5230\u5185\u5b58\u51cf\u5c11\u4e86\uff0c\u4e34\u65f6\u5b58\u50a8\u6ca1\u6709\u53d8\u5316\u662f\u56e0\u4e3a\u786c\u9a71\u9010\u7684\u9ed8\u8ba4\u503c\u5c31\u662f 10%\u3002\u4e5f\u662f\u7b26\u5408\u53ef\u5206\u914d\u8d44\u6e90\u7684\u8ba1\u7b97\u516c\u5f0f\u7684\uff1a</p> <pre><code>Node Allocatable Resource = Node Capacity - Kube-reserved - system-reserved - eviction-threshold\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86 Kubernetes \u8d44\u6e90\u9884\u7559\u7684\u914d\u7f6e\u3002</p>"},{"location":"kubernetes_maintain/skill/","title":"\u6280\u5de7","text":""},{"location":"kubernetes_maintain/skill/#_1","title":"\u6280\u5de7","text":"<p>Kubernetes \u4f7f\u7528\u8fc7\u7a0b\u4e2d\u7684\u4e00\u4e9b\u5947\u6280\u6deb\u5de7</p>"},{"location":"kubernetes_maintain/skill/#windows","title":"Windows \u7cfb\u7edf\u6700\u4f73\u5b9e\u8df5","text":"<p>\u6709\u90e8\u5206\u540c\u5b66\u662f\u4f7f\u7528\u7684 Windows \u7cfb\u7edf\uff0c\u6211\u4eec\u7684\u76f4\u64ad\u8bfe\u7a0b\u4e5f\u662f\u5728 Windows \u7cfb\u7edf\u4e0b\u9762\u8fdb\u884c\u7684\uff0c\u7136\u540e\u901a\u8fc7 SSH \u65b9\u5f0f\u8fde\u63a5\u5230 \u670d\u52a1\u5668\u4e0a\u9762\u64cd\u4f5c Kubernetes\uff0c\u7531\u4e8e\u5bf9 vim \u4e0d\u662f\u5f88\u719f\u6089\uff0c\u6240\u4ee5\u53c8\u901a\u8fc7 sftp \u7684\u65b9\u5f0f\u5728\u672c\u5730\u7f16\u5199\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u540c\u6b65\u5230\u670d\u52a1\u5668\u4e0a\u9762\u6267\u884c\u7684\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u6bd4\u8f83\u7e41\u7410\uff0c\u6548\u7387\u4e0d\u9ad8\u3002\u4e0b\u9762\u5c31\u6765\u4ecb\u7ecd\u4e0b\u5728 Windows \u7cfb\u7edf\u4e0b\u9762\u914d\u7f6e kubectl \u7684\u5b9e\u8df5\u65b9\u5f0f\uff0c\u5f53\u7136\u5982\u679c\u4f60\u662f Mac \u6216\u8005 Linux\uff0c\u601d\u8def\u57fa\u672c\u90fd\u662f\u4e00\u81f4\u7684\u3002</p>"},{"location":"kubernetes_maintain/skill/#kubectl","title":"kubectl \u914d\u7f6e","text":"<p>\u9996\u5148\uff0c\u4e0b\u8f7d Windows \u7248\u672c\u7684 kubectl \u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u5730\u5740\uff1ahttps://dl.k8s.io/v1.26.2/kubernetes-client-windows-amd64.tar.gz\u3002</p> <p>\u4e0b\u8f7d\u94fe\u63a5</p> <p>\u7531\u4e8e\u4e0a\u9762\u4e0b\u8f7d\u94fe\u63a5\u9700\u8981\u79d1\u5b66\u4e0a\u7f51\uff0c\u6240\u4ee5\u6211\u8fd9\u91cc\u79bb\u7ebf\u653e\u5230\u5230\u4e86\u767e\u5ea6\u7f51\u76d8\u4e0a\uff0c\u53ef\u4ee5\u76f4\u63a5\u4e0b\u8f7d\uff1a</p> <pre><code>\u94fe\u63a5\uff1ahttps://pan.baidu.com/s/1w_2s3mzf1OWSlvgVZFssCA\n\u63d0\u53d6\u7801\uff1afxbc\n\u590d\u5236\u8fd9\u6bb5\u5185\u5bb9\u540e\u6253\u5f00\u767e\u5ea6\u7f51\u76d8\u624b\u673aApp\uff0c\u64cd\u4f5c\u66f4\u65b9\u4fbf\u54e6\n</code></pre> <p>\u5c06 kubectl \u4e8c\u8fdb\u5236\u6587\u4ef6\u4e0b\u8f7d\u5230\u672c\u5730\uff0c\u89e3\u538b\u5230\u76ee\u5f55\uff1a<code>D:\\apps\\kubernetes</code> \u4e0b\u9762\uff0c\u7136\u540e\u8bbe\u7f6e\u8be5\u76ee\u5f55\u5230 PATH \u8def\u5f84\u4e0b\u9762\uff0c\u64cd\u4f5c\u6b65\u9aa4\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p></p> <p>\u8fd9\u6837\u8bbe\u7f6e\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u5728\u7ec8\u7aef\u4e2d\u76f4\u63a5\u76f4\u63a5 kubectl \u547d\u4ee4\u4e86\u3002\u73b0\u5728\u53ea\u9700\u8981\u914d\u7f6e kubeconfig \u6587\u4ef6\u5c31\u53ef\u4ee5\u8bbf\u95ee\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\u4e86\u3002</p> <p>\u9996\u5148\u521b\u5efa <code>.kube</code> \u76ee\u5f55\uff1a</p> <pre><code>$ mkdir ~/.kube  # \u5bf9\u5e94\u76ee\u5f55: C:\\\\Users\\\\Admin\\.kube\n</code></pre> <p>\u7136\u540e\u5c06\u670d\u52a1\u5668\u4e0a\u9762\u7684 </p> <pre><code>kubeconfig\uff08\uff5e/.kube/config\uff09\n</code></pre> <p>\u6587\u4ef6\u590d\u5236\u5230 Windows \u4e0b\u9762\u7684 <code>\uff5e/.kube</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f\u670d\u52a1\u5668\u4e0a\u9762\u7684<code>kubeconfig</code>\u914d\u7f6e\u6587\u4ef6\u91cc\u9762\u7684 apiserver \u5730\u5740\u662f<code>\u5185\u7f51\u5730\u5740</code>\uff0c\u6240\u4ee5\u6211\u4eec\u628a\u8fd9\u91cc\u7684\u5730\u5740\u6539\u6210\u5916\u7f51IP\uff0c\u4fdd\u5b58\uff0c\u7136\u540e\u6d4b\u8bd5 kubectl \u547d\u4ee4\uff1a</p> <pre><code>$ kubectl version\nClient Version: version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v2\", GitCommit:\"c97fe5036ef3df2967d086711e6c0c405941e14b\", GitTreeState:\"clean\", BuildDate:\"2019-10-15T19:18:23Z\", GoVersion:\"go10\", Compiler:\"gc\", Platform:\"windows/amd64\"}\nUnable to connect to the server: x509: certificate is valid for 1, 111, not 1111\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4f1a\u63d0\u793a\u8bc1\u4e66\u9519\u8bef\uff0c\u5927\u6982\u610f\u601d\u5c31\u662f\u670d\u52a1\u7aef\u7684\u8bc1\u4e66\u6ca1\u6709\u5305\u542b\u6211\u4eec\u7684\u5916\u7f51 IP\uff0c\u6240\u4ee5\u6211\u4eec\u901a\u8fc7\u5916\u7f51 IP \u53bb\u8bbf\u95ee\u5c31\u8bc1\u4e66\u6821\u9a8c\u5931\u8d25\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u600e\u4e48\u529e\u5462\uff1f\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u4e3b\u8981\u6709\u4e24\u4e2a\u65b9\u6cd5\uff1a</p> <p>\u7b2c\u4e00\u4e2a\u5c31\u662f\u5728\u6211\u4eec\u6700\u5f00\u59cb\u521d\u59cb\u5316\u96c6\u7fa4\u7684\u65f6\u5019\u901a\u8fc7 kubeadm \u7684\u914d\u7f6e\u6587\u4ef6\u6307\u5b9a\u53c2\u6570 apiServerCertSANs \u7684\u65f6\u5019\uff0c\u5c06\u5916\u7f51IP\u4e5f\u5305\u542b\u7740\u91cc\u9762\uff0c\u4f46\u662f\u6211\u4eec\u96c6\u7fa4\u5df2\u7ecf\u5b89\u88c5\u597d\u4e86\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u80af\u5b9a\u4e0d\u9002\u7528\u4e86\u3002</p> <p>\u7b2c\u4e8c\u4e2a\u65b9\u6cd5\u6211\u4eec\u53bb\u670d\u52a1\u5668\u4e0a\u9762\u770b\u770b\u6211\u4eec\u7684 apiserver \u8bc1\u4e66\u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text\nCertificate:\n    Data:\n        Version: 3 (0x2)\n        Serial Number: 9203698167925060590 (0x7fba1ab86f1633ee)\n    Signature Algorithm: sha256WithRSAEncryption\n        Issuer: CN=kubernetes\n        ......\n        X509v3 extensions:\n            X509v3 Key Usage: critical\n                Digital Signature, Key Encipherment\n            X509v3 Extended Key Usage:\n                TLS Web Server Authentication\n            X509v3 Subject Alternative Name:\n                DNS:ydzs-master, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:1, IP Address:111\n    Signature Algorithm: sha256WithRSAEncryption\n         01:1a:63:1a:f8:4e:f4:cd:7c:79:4b:64:2d:4e:a3:5a:13:80:\n         13:60:ca:46:ee:2d:3e:61:51:15:45:19:23:2a:09:d9:46:b3:\n        ......\n</code></pre> <p>\u6211\u4eec\u4ed4\u7ec6\u770b\u4e0a\u9762 DNS \u533a\u57df\u5c31\u662f\u5305\u542b\u7684\u6821\u9a8c\u7684\u57df\u540d\uff0c\u540e\u9762\u8fd8\u6709 IP\uff0c\u662f\u4e0d\u662f\u5176\u4e2d\u5c31\u6709\u6211\u4eec\u7684 master \u8282\u70b9\u7684 </p> <pre><code>hostname\uff08ydzs-master\uff09\n</code></pre> <p>\uff0c\u5230\u8fd9\u91cc\u5927\u5bb6\u60f3\u5230\u65b9\u6cd5\u4e86\u5417\uff1f</p> <p>\u6211\u4eec\u662f\u4e0d\u662f\u53ef\u4ee5\u76f4\u63a5\u5728\u672c\u5730\u7684 <code>/etc/hosts</code> \u91cc\u9762\u505a\u4e00\u4e2a APIServer \u7684<code>\u5916\u7f51 IP -&gt; ydzs-master</code> \u7684\u6620\u5c04\uff0c\u7136\u540e\u5728\u672c\u5730\u7684 kubeconfig \u6587\u4ef6\u4e2d\u628a apiserver \u5730\u5740\u66ff\u6362\u6210 </p> <pre><code>https://ydzs-master:6443\n</code></pre> <p>\u662f\u4e0d\u662f\u5c31 OK\u4e86\u554a\u3002</p> <p>\u6240\u4ee5\u63a5\u4e0b\u6765\u76f4\u63a5\u5728\u672c\u5730\u4fee\u6539 hosts \u6620\u5c04\u5373\u53ef\uff0c\u8981\u6ce8\u610f\u7528\u7ba1\u7406\u5458\u8eab\u4efd\u6253\u5f00\u6587\u4ef6 </p> <pre><code>C:\\Windows\\System32\\drivers\\etc\\hosts\n</code></pre> <p>\uff0c\u7136\u540e\u5728\u6587\u4ef6\u91cc\u9762\u6dfb\u52a0\u4e00\u884c\u6620\u5c04\uff1a</p> <pre><code># localhost name resolution is handled within DNS itself.\n#    11       localhost\n#    ::1             localhost\n1111 ydzs-master\n</code></pre> <p>\u7136\u540e\u4fdd\u5b58\u5373\u53ef\u3002\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u5230 powershell \u4e2d\u53bb\u6267\u884c\u4e0b kubectl \u547d\u4ee4\u5462\uff1a</p> <pre><code>$ kubectl version\nClient Version: version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v2\", GitCommit:\"c97fe5036ef3df2967d086711e6c0c405941e14b\", GitTreeState:\"clean\", BuildDate:\"2019-10-15T19:18:23Z\", GoVersion:\"go10\", Compiler:\"gc\", Platform:\"windows/amd64\"}\nServer Version: version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v2\", GitCommit:\"c97fe5036ef3df2967d086711e6c0c405941e14b\", GitTreeState:\"clean\", BuildDate:\"2019-10-15T19:09:08Z\", GoVersion:\"go10\", Compiler:\"gc\", Platform:\"linux/amd64\"}\n</code></pre> <p>\u662f\u4e0d\u662f\u5168\u90fd OK \u4e86\u5440~</p>"},{"location":"kubernetes_maintain/skill/#ide","title":"IDE \u914d\u7f6e","text":"<p>\u5f53\u7136 kubectl \u5de5\u5177\u914d\u7f6e\u597d\u4ee5\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u64cd\u4f5c\u96c6\u7fa4\u4e86\uff0c\u968f\u4fbf\u7528\u4ec0\u4e48\u5de5\u5177\u7f16\u5199 YAML \u6e05\u5355\u6587\u4ef6\u64cd\u4f5c\u90fd\u53ef\u4ee5\uff0c\u5f53\u7136\u4e3a\u4e86\u66f4\u597d\u7684\u5b9e\u8df5\u65b9\u5f0f\uff0c\u53ef\u4ee5\u9009\u62e9\u4e00\u4e9b\u6bd4\u8f83\u987a\u624b\u7684\u5de5\u5177\uff0c\u6bd4\u5982 vscode \u4e4b\u7c7b\u7684\u7f16\u8f91\u5668\uff0c\u6211\u8fd9\u91cc\u4f7f\u7528\u7684\u662f <code>Goland</code> \u8fd9\u4e2a IDE\u3002\u5bf9\u4e8e Idea \u7684 IDE \u90fd\u53ef\u4ee5\u4e00\u6837\u7684\u64cd\u4f5c\u3002</p> <ul> <li>\u4e3a\u4e86\u9875\u9762\u7f8e\u89c2\uff0c\u53ef\u4ee5\u5b89\u88c5\u4e00\u4e2a <code>Material Theme UI</code> \u7684\u4e3b\u9898\u63d2\u4ef6</li> <li>\u4e3a\u4e86\u7f16\u5199 YAML \u6587\u4ef6\u65b9\u4fbf\uff0c\u8fd8\u9700\u8981\u5b89\u88c5\u4e00\u4e2a\u540d\u4e3a <code>kubernetes</code> \u7684\u63d2\u4ef6\uff0c\u8fd9\u6837\u6211\u4eec\u5728\u7f16\u5199\u8d44\u6e90\u6e05\u5355\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u81ea\u52a8\u63d0\u793a\u4e86</li> <li> <p>\u66f4\u6539\u9ed8\u8ba4\u7684 IDE \u7684 terminal \u4e3a Powershell\uff1a</p> <pre><code>open File=&gt;Setting=&gt;Tools=&gt;Terminal\n</code></pre> <p>, \u5c06<code>cmd.exe</code>\u4fee\u6539\u4e3a<code>powershell.exe</code>\u4fdd\u5b58\uff0c\u91cd\u542f IDE \u5373\u53ef\u3002</p> </li> </ul> <p>\u6700\u7ec8\u7684\u914d\u7f6e\u6548\u679c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p>"},{"location":"kubernetes_maintain/update/","title":"\u96c6\u7fa4\u5347\u7ea7","text":"<p>K8S\u8bad\u7ec3\u8425</p> <p>GitHub</p> <ul> <li>1000 Stars</li> <li> <p>303 Forks</p> </li> <li> <p>\u4ecb\u7ecd</p> </li> <li> <p> Docker \u57fa\u7840</p> <p>Docker \u57fa\u7840</p> <ul> <li>\u7b80\u4ecb</li> <li>\u5b89\u88c5</li> <li>\u57fa\u672c\u64cd\u4f5c</li> <li>Dockerfile</li> <li>Dockerfile\u6700\u4f73\u5b9e\u8df5</li> </ul> </li> <li> <p> Kubernetes \u57fa\u7840</p> <p>Kubernetes \u57fa\u7840</p> <ul> <li>\u7b80\u4ecb</li> <li>\u5b89\u88c5</li> <li>\u8d44\u6e90\u6e05\u5355</li> <li>Pod \u539f\u7406</li> <li>Pod \u751f\u547d\u5468\u671f</li> <li>Pod \u4f7f\u7528\u8fdb\u9636</li> </ul> </li> <li> <p> Kubernetes \u63a7\u5236\u5668</p> <p>Kubernetes \u63a7\u5236\u5668</p> <ul> <li>ReplicaSet</li> <li>Deployment</li> <li>StatefulSet</li> <li>DaemonSet</li> <li>Job</li> <li>HPA</li> </ul> </li> <li> <p> Kubernetes \u914d\u7f6e\u7ba1\u7406</p> <p>Kubernetes \u914d\u7f6e\u7ba1\u7406</p> <ul> <li>ConfigMap</li> <li>Secret</li> <li>ServiceAccount</li> </ul> </li> <li> <p> Kubernetes \u5b89\u5168</p> <p>Kubernetes \u5b89\u5168</p> <ul> <li>RBAC</li> <li>Security Context</li> <li>\u51c6\u5165\u63a7\u5236\u5668</li> </ul> </li> <li> <p> Kubernetes \u7f51\u7edc</p> <p>Kubernetes \u7f51\u7edc</p> <ul> <li>\u7f51\u7edc\u63d2\u4ef6</li> <li>\u7f51\u7edc\u7b56\u7565</li> <li>Service \u670d\u52a1</li> <li> <p> Ingress</p> <p>Ingress</p> <ul> <li>NGINX Controller</li> <li>Traefik</li> </ul> </li> </ul> </li> <li> <p> Kubernetes \u8c03\u5ea6\u5668</p> <p>Kubernetes \u8c03\u5ea6\u5668</p> <ul> <li>\u8c03\u5ea6\u5668\u4ecb\u7ecd</li> <li>Pod \u8c03\u5ea6</li> </ul> </li> <li> <p> Kubernetes \u5b58\u50a8</p> <p>Kubernetes \u5b58\u50a8</p> <ul> <li>Local \u672c\u5730\u5b58\u50a8</li> <li>Ceph \u5b58\u50a8</li> <li>\u5b58\u50a8\u539f\u7406</li> </ul> </li> <li> <p> \u5e94\u7528\u793a\u4f8b</p> <p>\u5e94\u7528\u793a\u4f8b</p> <ul> <li>\u5e94\u7528\u90e8\u7f72</li> </ul> </li> <li> <p> Helm \u5305\u7ba1\u7406</p> <p>Helm \u5305\u7ba1\u7406</p> <ul> <li>Helm</li> <li>Charts</li> <li> <p> \u6a21\u677f\u5f00\u53d1</p> <p>\u6a21\u677f\u5f00\u53d1</p> <ul> <li>\u5185\u7f6e\u5bf9\u8c61</li> <li>Values</li> <li>\u51fd\u6570\u4e0e\u7ba1\u9053</li> <li>\u6d41\u7a0b\u63a7\u5236</li> <li>\u53d8\u91cf</li> <li>\u547d\u540d\u6a21\u677f</li> <li>\u8bbf\u95ee\u6587\u4ef6</li> <li>NOTES.txt</li> <li>\u5b50chart\u4e0e\u5168\u5c40\u503c</li> <li>\u6a21\u677f\u8c03\u8bd5</li> </ul> </li> <li> <p>Chart Hooks</p> </li> <li>\u793a\u4f8b</li> </ul> </li> <li> <p> Kubernetes \u76d1\u63a7</p> <p>Kubernetes \u76d1\u63a7</p> <ul> <li>Prometheus</li> <li>Grafana</li> <li>PromQL</li> <li>AlertManager</li> <li>Thanos</li> <li>Prometheus Adpater</li> <li> <p> Prometheus Operator</p> <p>Prometheus Operator</p> <ul> <li>\u5b89\u88c5</li> <li>\u81ea\u5b9a\u4e49\u76d1\u63a7\u62a5\u8b66</li> <li>\u9ad8\u7ea7\u914d\u7f6e</li> </ul> </li> </ul> </li> <li> <p> Kubernetes \u65e5\u5fd7</p> <p>Kubernetes \u65e5\u5fd7</p> <ul> <li>\u65e5\u5fd7\u6536\u96c6\u67b6\u6784</li> <li>EFK</li> </ul> </li> <li> <p> Kubernetes DevOps</p> <p>Kubernetes DevOps</p> <ul> <li>Jenkins</li> <li>GitLab</li> <li>Harbor</li> <li>Jenkins \u6d41\u6c34\u7ebf</li> <li>Tekton</li> </ul> </li> <li> <p> Service Mesh \u5b9e\u8df5</p> <p>Service Mesh \u5b9e\u8df5</p> <ul> <li>Istio \u7b80\u4ecb</li> <li>\u6d41\u91cf\u7ba1\u7406</li> <li>\u53ef\u89c2\u6d4b\u6027</li> <li>\u5b89\u5168\u7ba1\u63a7</li> <li>Certmanager</li> </ul> </li> <li> <p> Kubernetes \u591a\u79df\u6237</p> <p>Kubernetes \u591a\u79df\u6237</p> <ul> <li>\u591a\u79df\u6237\u4ecb\u7ecd</li> <li>\u8d44\u6e90\u914d\u989d</li> <li>Pod \u5b89\u5168\u7b56\u7565</li> </ul> </li> <li> <p> Operator</p> <p>Operator</p> <ul> <li>CRD</li> <li>Operator</li> </ul> </li> <li> <p> \u5b9e\u8df5\u6280\u5de7</p> <p>\u5b9e\u8df5\u6280\u5de7</p> <ul> <li>\u6280\u5de7</li> <li> <p> \u96c6\u7fa4\u5347\u7ea7 \u96c6\u7fa4\u5347\u7ea7</p> <p>\u76ee\u5f55</p> <ul> <li> <p>\u66f4\u65b0\u8bc1\u4e66</p> <ul> <li>\u624b\u52a8\u66f4\u65b0\u8bc1\u4e66</li> <li>\u7528 Kubernetes \u8bc1\u4e66 API \u66f4\u65b0\u8bc1\u4e66(\u4e0d\u63a8\u8350)</li> </ul> </li> <li> <p>\u96c6\u7fa4\u5347\u7ea7</p> </li> </ul> </li> <li> <p>\u5347\u7ea7\u4e3a\u96c6\u7fa4</p> </li> <li>\u8d44\u6e90\u9884\u7559</li> </ul> </li> <li> <p> \u6e90\u7801</p> <p>\u6e90\u7801</p> <ul> <li>kubelet \u6e90\u7801</li> <li> <p> client-go</p> <p>client-go</p> <ul> <li>workqueue</li> <li>Indexer</li> <li>DeltaFIFO</li> </ul> </li> </ul> </li> </ul> <p>\u76ee\u5f55</p> <ul> <li> <p>\u66f4\u65b0\u8bc1\u4e66</p> <ul> <li>\u624b\u52a8\u66f4\u65b0\u8bc1\u4e66</li> <li>\u7528 Kubernetes \u8bc1\u4e66 API \u66f4\u65b0\u8bc1\u4e66(\u4e0d\u63a8\u8350)</li> </ul> </li> <li> <p>\u96c6\u7fa4\u5347\u7ea7</p> </li> </ul>"},{"location":"kubernetes_maintain/update/#_1","title":"\u96c6\u7fa4\u5347\u7ea7","text":""},{"location":"kubernetes_maintain/update/#_2","title":"\u66f4\u65b0\u8bc1\u4e66","text":"<p>\u4f7f\u7528 kubeadm \u5b89\u88c5 kubernetes \u96c6\u7fa4\u975e\u5e38\u65b9\u4fbf\uff0c\u4f46\u662f\u4e5f\u6709\u4e00\u4e2a\u6bd4\u8f83\u70e6\u4eba\u7684\u95ee\u9898\u5c31\u662f\u9ed8\u8ba4\u7684\u8bc1\u4e66\u6709\u6548\u671f\u53ea\u6709\u4e00\u5e74\u65f6\u95f4\uff0c\u6240\u4ee5\u9700\u8981\u8003\u8651\u8bc1\u4e66\u5347\u7ea7\u7684\u95ee\u9898\uff0c\u672c\u6587\u7684\u6f14\u793a\u96c6\u7fa4\u7248\u672c\u4e3a v1.26.2 \u7248\u672c\uff0c\u4e0d\u4fdd\u8bc1\u4e0b\u9762\u7684\u64cd\u4f5c\u5bf9\u5176\u4ed6\u7248\u672c\u4e5f\u9002\u7528\uff0c<code>\u5728\u64cd\u4f5c\u4e4b\u524d\u4e00\u5b9a\u8981\u5148\u5bf9\u8bc1\u4e66\u76ee\u5f55\u8fdb\u884c\u5907\u4efd\uff0c\u9632\u6b62\u64cd\u4f5c\u9519\u8bef\u8fdb\u884c\u56de\u6eda</code>\u3002\u672c\u6587\u4e3b\u8981\u4ecb\u7ecd\u4e24\u79cd\u65b9\u5f0f\u6765\u66f4\u65b0\u96c6\u7fa4\u8bc1\u4e66\u3002</p>"},{"location":"kubernetes_maintain/update/#_3","title":"\u624b\u52a8\u66f4\u65b0\u8bc1\u4e66","text":"<p>\u7531 kubeadm \u751f\u6210\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u9ed8\u8ba4\u53ea\u6709\u4e00\u5e74\u6709\u6548\u671f\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>check-expiration</code> \u547d\u4ee4\u6765\u68c0\u67e5\u8bc1\u4e66\u662f\u5426\u8fc7\u671f\uff1a</p> <pre><code>$ kubeadm alpha certs check-expiration\nCERTIFICATE                EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED\nadmin.conf                 Nov 07, 2020 11:59 UTC   73d             no\napiserver                  Nov 07, 2020 11:59 UTC   73d             no\napiserver-etcd-client      Nov 07, 2020 11:59 UTC   73d             no\napiserver-kubelet-client   Nov 07, 2020 11:59 UTC   73d             no\ncontroller-manager.conf    Nov 07, 2020 11:59 UTC   73d             no\netcd-healthcheck-client    Nov 07, 2020 11:59 UTC   73d             no\netcd-peer                  Nov 07, 2020 11:59 UTC   73d             no\netcd-server                Nov 07, 2020 11:59 UTC   73d             no\nfront-proxy-client         Nov 07, 2020 11:59 UTC   73d             no\nscheduler.conf             Nov 07, 2020 11:59 UTC   73d             no\n</code></pre> <p>\u8be5\u547d\u4ee4\u663e\u793a <code>/etc/kubernetes/pki</code> \u6587\u4ef6\u5939\u4e2d\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u4ee5\u53ca kubeadm \u4f7f\u7528\u7684 <code>KUBECONFIG</code> \u6587\u4ef6\u4e2d\u5d4c\u5165\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u7684\u5230\u671f\u65f6\u95f4/\u5269\u4f59\u65f6\u95f4\u3002</p> <p>\u6ce8\u610f</p> <p><code>kubeadm</code> \u4e0d\u80fd\u7ba1\u7406\u7531\u5916\u90e8 CA \u7b7e\u540d\u7684\u8bc1\u4e66\uff0c\u5982\u679c\u662f\u5916\u90e8\u5f97\u8bc1\u4e66\uff0c\u9700\u8981\u81ea\u5df1\u624b\u52a8\u53bb\u7ba1\u7406\u8bc1\u4e66\u7684\u66f4\u65b0\u3002</p> <p>\u53e6\u5916\u9700\u8981\u8bf4\u660e\u7684\u662f\u4e0a\u9762\u7684\u5217\u8868\u4e2d\u6ca1\u6709\u5305\u542b <code>kubelet.conf</code>\uff0c\u56e0\u4e3a kubeadm \u5c06 kubelet \u914d\u7f6e\u4e3a\u81ea\u52a8\u66f4\u65b0\u8bc1\u4e66\u3002</p> <p>\u53e6\u5916 kubeadm \u4f1a\u5728\u63a7\u5236\u9762\u677f\u5347\u7ea7\u7684\u65f6\u5019\u81ea\u52a8\u66f4\u65b0\u6240\u6709\u8bc1\u4e66\uff0c\u6240\u4ee5\u4f7f\u7528 kubeadm \u642d\u5efa\u5f97\u96c6\u7fa4\u6700\u4f73\u7684\u505a\u6cd5\u662f\u7ecf\u5e38\u5347\u7ea7\u96c6\u7fa4\uff0c\u8fd9\u6837\u53ef\u4ee5\u786e\u4fdd\u4f60\u7684\u96c6\u7fa4\u4fdd\u6301\u6700\u65b0\u72b6\u6001\u5e76\u4fdd\u6301\u5408\u7406\u7684\u5b89\u5168\u6027\u3002\u4f46\u662f\u5bf9\u4e8e\u5b9e\u9645\u7684\u751f\u4ea7\u73af\u5883\u6211\u4eec\u53ef\u80fd\u5e76\u4e0d\u4f1a\u53bb\u9891\u7e41\u5f97\u5347\u7ea7\u96c6\u7fa4\uff0c\u6240\u4ee5\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u53bb\u624b\u52a8\u66f4\u65b0\u8bc1\u4e66\u3002</p> <p>\u8981\u624b\u52a8\u66f4\u65b0\u8bc1\u4e66\u4e5f\u975e\u5e38\u65b9\u4fbf\uff0c\u6211\u4eec\u53ea\u9700\u8981\u901a\u8fc7 </p> <pre><code>kubeadm alpha certs renew\n</code></pre> <p>\u547d\u4ee4\u5373\u53ef\u66f4\u65b0\u4f60\u7684\u8bc1\u4e66\uff0c\u8fd9\u4e2a\u547d\u4ee4\u7528 CA\uff08\u6216\u8005 front-proxy-CA \uff09\u8bc1\u4e66\u548c\u5b58\u50a8\u5728 <code>/etc/kubernetes/pki</code> \u4e2d\u7684\u5bc6\u94a5\u6267\u884c\u66f4\u65b0\u3002</p> <p>\u6ce8\u610f</p> <p>\u5982\u679c\u4f60\u8fd0\u884c\u4e86\u4e00\u4e2a\u9ad8\u53ef\u7528\u7684\u96c6\u7fa4\uff0c\u8fd9\u4e2a\u547d\u4ee4\u9700\u8981\u5728\u6240\u6709\u63a7\u5236\u9762\u677f\u8282\u70b9\u4e0a\u6267\u884c\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u66f4\u65b0\u6211\u4eec\u7684\u96c6\u7fa4\u8bc1\u4e66\uff0c\u4e0b\u9762\u7684\u64cd\u4f5c\u90fd\u662f\u5728 master \u8282\u70b9\u4e0a\u8fdb\u884c\uff0c\u9996\u5148\u5907\u4efd\u539f\u6709\u8bc1\u4e66\uff1a</p> <pre><code>$ mkdir /etc/kubernetes.bak\n$ cp -r /etc/kubernetes/pki/ /etc/kubernetes.bak\n$ cp /etc/kubernetes/*.conf /etc/kubernetes.bak\n</code></pre> <p>\u7136\u540e\u5907\u4efd etcd \u6570\u636e\u76ee\u5f55\uff1a</p> <pre><code>$ cp -r /var/lib/etcd /var/lib/etcd.bak\n</code></pre> <p>\u63a5\u4e0b\u6765\u6267\u884c\u66f4\u65b0\u8bc1\u4e66\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ kubeadm alpha certs renew all --config=kubeadm.yaml\nkubeadm alpha certs renew all --config=kubeadm.yaml\ncertificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed\ncertificate for serving the Kubernetes API renewed\ncertificate the apiserver uses to access etcd renewed\ncertificate for the API server to connect to kubelet renewed\ncertificate embedded in the kubeconfig file for the controller manager to use renewed\ncertificate for liveness probes to healthcheck etcd renewed\ncertificate for etcd nodes to communicate with each other renewed\ncertificate for serving etcd renewed\ncertificate for the front proxy client renewed\ncertificate embedded in the kubeconfig file for the scheduler manager to use renewed\n</code></pre> <p>\u901a\u8fc7\u4e0a\u9762\u7684\u547d\u4ee4\u8bc1\u4e66\u5c31\u4e00\u952e\u66f4\u65b0\u5b8c\u6210\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u67e5\u770b\u4e0a\u9762\u7684\u8bc1\u4e66\u53ef\u4ee5\u770b\u5230\u8fc7\u671f\u65f6\u95f4\u5df2\u7ecf\u662f\u4e00\u5e74\u540e\u7684\u65f6\u95f4\u4e86\uff1a</p> <pre><code>$ kubeadm alpha certs check-expiration\nCERTIFICATE                EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED\nadmin.conf                 Aug 26, 2021 03:47 UTC   364d            no\napiserver                  Aug 26, 2021 03:47 UTC   364d            no\napiserver-etcd-client      Aug 26, 2021 03:47 UTC   364d            no\napiserver-kubelet-client   Aug 26, 2021 03:47 UTC   364d            no\ncontroller-manager.conf    Aug 26, 2021 03:47 UTC   364d            no\netcd-healthcheck-client    Aug 26, 2021 03:47 UTC   364d            no\netcd-peer                  Aug 26, 2021 03:47 UTC   364d            no\netcd-server                Aug 26, 2021 03:47 UTC   364d            no\nfront-proxy-client         Aug 26, 2021 03:47 UTC   364d            no\nscheduler.conf             Aug 26, 2021 03:47 UTC   364d            no\n</code></pre> <p>\u7136\u540e\u8bb0\u5f97\u66f4\u65b0\u4e0b kubeconfig \u6587\u4ef6\uff1a</p> <pre><code>$ kubeadm init phase kubeconfig all --config kubeadm.yaml\n[kubeconfig] Using kubeconfig folder \"/etc/kubernetes\"\n[kubeconfig] Using existing kubeconfig file: \"/etc/kubernetes/admin.conf\"\n[kubeconfig] Using existing kubeconfig file: \"/etc/kubernetes/kubelet.conf\"\n[kubeconfig] Using existing kubeconfig file: \"/etc/kubernetes/controller-manager.conf\"\n[kubeconfig] Using existing kubeconfig file: \"/etc/kubernetes/scheduler.conf\"\n</code></pre> <p>\u5c06\u65b0\u751f\u6210\u7684 admin \u914d\u7f6e\u6587\u4ef6\u8986\u76d6\u6389\u539f\u672c\u7684 admin \u6587\u4ef6:</p> <pre><code>$ mv $HOME/.kube/config $HOME/.kube/config.old\n$ cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n$ chown $(id -u):$(id -g) $HOME/.kube/config\n</code></pre> <p>\u5b8c\u6210\u540e\u91cd\u542f kube-apiserver\u3001kube-controller\u3001kube-scheduler\u3001etcd \u8fd94\u4e2a\u5bb9\u5668\u5373\u53ef\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b apiserver \u7684\u8bc1\u4e66\u7684\u6709\u6548\u671f\u6765\u9a8c\u8bc1\u662f\u5426\u66f4\u65b0\u6210\u529f\uff1a</p> <pre><code>$ docker restart `docker ps | grep etcd  | awk '{ print $1 }'`\n$ docker restart `docker ps | grep kube-apiserver  | awk '{ print $1 }'`\n$ docker restart `docker ps | grep kube-scheduler  | awk '{ print $1 }'`\n$ docker restart `docker ps | grep kube-controller  | awk '{ print $1 }'`\nsystemctl restart kubelet\n$ echo | openssl s_client -showcerts -connect 11:6443 -servername api 2&gt;/dev/null | openssl x509 -noout -enddate\nnotAfter=Aug 26 03:47:23 2021 GMT\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u7684\u6709\u6548\u671f\u662f\u4e00\u5e74\u8fc7\u540e\u7684\uff0c\u8bc1\u660e\u5df2\u7ecf\u66f4\u65b0\u6210\u529f\u4e86\u3002</p>"},{"location":"kubernetes_maintain/update/#kubernetes_api","title":"\u7528 Kubernetes \u8bc1\u4e66 API \u66f4\u65b0\u8bc1\u4e66(\u4e0d\u63a8\u8350)","text":"<p>\u9664\u4e86\u4e0a\u8ff0\u7684\u4e00\u952e\u624b\u52a8\u66f4\u65b0\u8bc1\u4e66\u4e4b\u5916\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u8bc1\u4e66 API \u6267\u884c\u624b\u52a8\u8bc1\u4e66\u66f4\u65b0\u3002\u5bf9\u4e8e\u7ebf\u4e0a\u73af\u5883\u6211\u4eec\u53ef\u80fd\u5e76\u4e0d\u4f1a\u53bb\u5192\u9669\u7ecf\u5e38\u66f4\u65b0\u96c6\u7fa4\u6216\u8005\u53bb\u66f4\u65b0\u8bc1\u4e66\uff0c\u8fd9\u4e9b\u6bd5\u7adf\u662f\u6709\u98ce\u9669\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5e0c\u671b\u751f\u6210\u7684\u8bc1\u4e66\u6709\u6548\u671f\u8db3\u591f\u957f\uff0c\u867d\u7136\u4ece\u5b89\u5168\u6027\u89d2\u5ea6\u6765\u8bf4\u4e0d\u63a8\u8350\u8fd9\u6837\u505a\uff0c\u4f46\u662f\u5bf9\u4e8e\u67d0\u4e9b\u573a\u666f\u4e0b\u4e00\u4e2a\u8db3\u591f\u957f\u7684\u8bc1\u4e66\u6709\u6548\u671f\u4e5f\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\u3002\u6709\u5f88\u591a\u7ba1\u7406\u5458\u5c31\u662f\u53bb\u624b\u52a8\u66f4\u6539 kubeadm \u7684\u6e90\u7801\u4e3a10\u5e74\uff0c\u7136\u540e\u91cd\u65b0\u7f16\u8bd1\u6765\u521b\u5efa\u96c6\u7fa4\uff0c\u8fd9\u79cd\u65b9\u5f0f\u867d\u7136\u53ef\u4ee5\u8fbe\u5230\u76ee\u7684\uff0c\u4f46\u662f\u4e0d\u63a8\u8350\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u7279\u522b\u662f\u5f53\u4f60\u60f3\u8981\u66f4\u65b0\u96c6\u7fa4\u7684\u65f6\u5019\uff0c\u8fd8\u5f97\u7528\u65b0\u7248\u672c\u8fdb\u884c\u66f4\u65b0\u3002\u5176\u5b9e Kubernetes \u63d0\u4f9b\u4e86\u4e00\u79cd API \u7684\u65b9\u5f0f\u53ef\u4ee5\u6765\u5e2e\u52a9\u6211\u4eec\u751f\u6210\u4e00\u4e2a\u8db3\u591f\u957f\u8bc1\u4e66\u6709\u6548\u671f\u3002</p> <p>\u8981\u4f7f\u7528\u5185\u7f6e\u7684 API \u65b9\u5f0f\u6765\u7b7e\u540d\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u914d\u7f6e kube-controller-manager \u7ec4\u4ef6\u7684 </p> <pre><code>--experimental-cluster-signing-duration\n</code></pre> <p>\u53c2\u6570\uff0c\u5c06\u5176\u8c03\u6574\u4e3a10\u5e74\uff0c\u6211\u4eec\u8fd9\u91cc\u662f kubeadm \u5b89\u88c5\u7684\u96c6\u7fa4\uff0c\u6240\u4ee5\u76f4\u63a5\u4fee\u6539\u9759\u6001 Pod \u7684 yaml \u6587\u4ef6\u5373\u53ef:</p> <pre><code>$ vi /etc/kubernetes/manifests/kube-controller-manager.yaml\n......\nspec:\n  containers:\n  - command:\n    - kube-controller-manager\n    # \u8bbe\u7f6e\u8bc1\u4e66\u6709\u6548\u671f\u4e3a 10 \u5e74\n    - --experimental-cluster-signing-duration=87600h \n    - --client-ca-file=/etc/kubernetes/pki/ca.crt\n......\n</code></pre> <p>\u4fee\u6539\u5b8c\u6210\u540e kube-controller-manager \u4f1a\u81ea\u52a8\u91cd\u542f\u751f\u6548\u3002\u7136\u540e\u6211\u4eec\u9700\u8981\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e3a Kubernetes \u8bc1\u4e66 API \u521b\u5efa\u4e00\u4e2a\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\u3002\u5982\u679c\u60a8\u8bbe\u7f6e\u4f8b\u5982 <code>cert-manager</code> \u7b49\u5916\u90e8\u7b7e\u540d\u8005\uff0c\u5219\u4f1a\u81ea\u52a8\u6279\u51c6\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\uff08CSRs\uff09\u3002\u5426\u8005\uff0c\u60a8\u5fc5\u987b\u4f7f\u7528 <code>kubectl certificate</code> \u547d\u4ee4\u624b\u52a8\u6279\u51c6\u8bc1\u4e66\u3002\u4ee5\u4e0b kubeadm \u547d\u4ee4\u8f93\u51fa\u8981\u6279\u51c6\u7684\u8bc1\u4e66\u540d\u79f0\uff0c\u7136\u540e\u7b49\u5f85\u6279\u51c6\u53d1\u751f\uff1a</p> <pre><code>$ kubeadm alpha certs renew all --use-api --config kubeadm.yaml &amp;\n</code></pre> <p>\u8f93\u51fa\u7c7b\u4f3c\u4e8e\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>[1] 2890\n[certs] Certificate request \"kubeadm-cert-kubernetes-admin-pn99f\" created\n</code></pre> <p>\u7136\u540e\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u53bb\u624b\u52a8\u6279\u51c6\u8bc1\u4e66\uff1a</p> <pre><code>$ kubectl get csr\nNAME                                  AGE   REQUESTOR          CONDITION\nkubeadm-cert-kubernetes-admin-pn99f   64s   kubernetes-admin   Pending\n# \u624b\u52a8\u6279\u51c6\u8bc1\u4e66\n$ kubectl certificate approve kubeadm-cert-kubernetes-admin-pn99f\ncertificatesigningrequest.certificates.k8s.io/kubeadm-cert-kubernetes-admin-pn99f approved\n</code></pre> <p>\u7528\u540c\u6837\u7684\u65b9\u5f0f\u4e3a\u5904\u4e8e Pending \u72b6\u6001\u7684 csr \u6267\u884c\u6279\u51c6\u64cd\u4f5c\uff0c\u76f4\u5230\u6240\u6709\u7684 csr \u90fd\u6279\u51c6\u5b8c\u6210\u4e3a\u6b62\u3002\u6700\u540e\u6240\u6709\u7684 csr \u5217\u8868\u72b6\u6001\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ kubectl get csr\nNAME                                                AGE     REQUESTOR          CONDITION\nkubeadm-cert-front-proxy-client-llhrj               30s     kubernetes-admin   Approved,Issued\nkubeadm-cert-kube-apiserver-2s6kf                   2m43s   kubernetes-admin   Approved,Issued\nkubeadm-cert-kube-apiserver-etcd-client-t9pkx       2m7s    kubernetes-admin   Approved,Issued\nkubeadm-cert-kube-apiserver-kubelet-client-pjbjm    108s    kubernetes-admin   Approved,Issued\nkubeadm-cert-kube-etcd-healthcheck-client-8dcn8     64s     kubernetes-admin   Approved,Issued\nkubeadm-cert-kubernetes-admin-pn99f                 4m29s   kubernetes-admin   Approved,Issued\nkubeadm-cert-system:kube-controller-manager-mr86h   79s     kubernetes-admin   Approved,Issued\nkubeadm-cert-system:kube-scheduler-t8lnw            17s     kubernetes-admin   Approved,Issued\nkubeadm-cert-ydzs-master-cqh4s                      52s     kubernetes-admin   Approved,Issued\nkubeadm-cert-ydzs-master-lvbr5                      41s     kubernetes-admin   Approved,Issued\n</code></pre> <p>\u6279\u51c6\u5b8c\u6210\u540e\u68c0\u67e5\u8bc1\u4e66\u7684\u6709\u6548\u671f\uff1a</p> <pre><code>$ kubeadm alpha certs check-expiration\nCERTIFICATE                EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED\nadmin.conf                 Nov 05, 2029 11:53 UTC   9y              no\napiserver                  Nov 05, 2029 11:54 UTC   9y              no\napiserver-etcd-client      Nov 05, 2029 11:53 UTC   9y              no\napiserver-kubelet-client   Nov 05, 2029 11:54 UTC   9y              no\ncontroller-manager.conf    Nov 05, 2029 11:54 UTC   9y              no\netcd-healthcheck-client    Nov 05, 2029 11:53 UTC   9y              no\netcd-peer                  Nov 05, 2029 11:53 UTC   9y              no\netcd-server                Nov 05, 2029 11:54 UTC   9y              no\nfront-proxy-client         Nov 05, 2029 11:54 UTC   9y              no\nscheduler.conf             Nov 05, 2029 11:53 UTC   9y              no\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u5ef6\u957f\u5c0f10\u5e74\u4e86\uff0c\u8fd9\u662f\u56e0\u4e3a ca \u8bc1\u4e66\u7684\u6709\u6548\u671f\u53ea\u670910\u5e74\u3002</p> <p>\u4f46\u662f\u73b0\u5728\u6211\u4eec\u8fd8\u4e0d\u80fd\u76f4\u63a5\u91cd\u542f\u63a7\u5236\u9762\u677f\u7684\u51e0\u4e2a\u7ec4\u4ef6\uff0c\u8fd9\u662f\u56e0\u4e3a\u4f7f\u7528 kubeadm \u5b89\u88c5\u7684\u96c6\u7fa4\u5bf9\u5e94\u7684 etcd \u9ed8\u8ba4\u662f\u4f7f\u7528\u7684 </p> <pre><code>/etc/kubernetes/pki/etcd/ca.crt\n</code></pre> <p>\u8fd9\u4e2a\u8bc1\u4e66\u8fdb\u884c\u524d\u9762\u7684\uff0c\u800c\u4e0a\u9762\u6211\u4eec\u7528\u547d\u4ee4 </p> <pre><code>kubectl certificate approve\n</code></pre> <p>\u6279\u51c6\u8fc7\u540e\u7684\u8bc1\u4e66\u662f\u4f7f\u7528\u7684\u9ed8\u8ba4\u7684 </p> <pre><code>/etc/kubernetes/pki/ca.crt\n</code></pre> <p>\u8bc1\u4e66\u8fdb\u884c\u7b7e\u53d1\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u66ff\u6362 etcd \u4e2d\u7684 ca \u673a\u6784\u8bc1\u4e66:</p> <pre><code># \u5148\u62f7\u8d1d\u9759\u6001 Pod \u8d44\u6e90\u6e05\u5355\n$ cp -r /etc/kubernetes/manifests/ /etc/kubernetes/manifests.bak\n$ cp /etc/kubernetes/pki/ca.crt /etc/kubernetes/pki/etcd/ca.crt\n$ cp /etc/kubernetes/pki/ca.key /etc/kubernetes/pki/etcd/ca.key\n</code></pre> <p>\u9664\u6b64\u4e4b\u5916\u8fd8\u9700\u8981\u66ff\u6362 </p> <pre><code>requestheader-client-ca-file\n</code></pre> <p>\u6587\u4ef6\uff0c\u9ed8\u8ba4\u662f </p> <pre><code>/etc/kubernetes/pki/front-proxy-ca.crt\n</code></pre> <p>\u6587\u4ef6\uff0c\u73b0\u5728\u4e5f\u9700\u8981\u66ff\u6362\u6210\u9ed8\u8ba4\u7684 CA \u6587\u4ef6\uff0c\u5426\u5219\u4f7f\u7528\u805a\u5408 API\uff0c\u6bd4\u5982\u5b89\u88c5\u4e86 metrics-server \u540e\u6267\u884c <code>kubectl top</code> \u547d\u4ee4\u5c31\u4f1a\u62a5\u9519\uff1a</p> <pre><code>$ cp /etc/kubernetes/pki/ca.crt /etc/kubernetes/pki/front-proxy-ca.crt\n$ cp /etc/kubernetes/pki/ca.key /etc/kubernetes/pki/front-proxy-ca.key\n</code></pre> <p>\u7531\u4e8e\u662f\u9759\u6001 Pod\uff0c\u4fee\u6539\u5b8c\u6210\u540e\u4e0a\u9762\u7684\u7ec4\u4ef6\u90fd\u4f1a\u81ea\u52a8\u91cd\u542f\u751f\u6548\u3002\u7531\u4e8e\u6211\u4eec\u5f53\u524d\u7248\u672c\u7684 kubelet \u9ed8\u8ba4\u5f00\u542f\u4e86\u8bc1\u4e66\u81ea\u52a8\u8f6e\u8f6c\uff0c\u6240\u4ee5 kubelet \u7684\u8bc1\u4e66\u4e5f\u4e0d\u7528\u518d\u53bb\u7ba1\u7406\u4e86\uff0c\u8fd9\u6837\u6211\u5c31\u5c06\u8bc1\u4e66\u66f4\u65b0\u621010\u6709\u6548\u671f\u4e86\u3002<code>\u5728\u64cd\u4f5c\u4e4b\u524d\u4e00\u5b9a\u8981\u5148\u5bf9\u8bc1\u4e66\u76ee\u5f55\u8fdb\u884c\u5907\u4efd\uff0c\u9632\u6b62\u64cd\u4f5c\u9519\u8bef\u8fdb\u884c\u56de\u6eda</code>\u3002</p>"},{"location":"kubernetes_maintain/update/#_4","title":"\u96c6\u7fa4\u5347\u7ea7","text":"<p>\u6700\u65b0\u7684 Kubernetes \u7248\u672c\u662f v1.19.0\uff0c\u6211\u4eec\u8fd9\u91cc\u7684\u73af\u5883\u662f v1.26.2\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u7248\u672c\u8de8\u5ea6\u592a\u5927\uff0c\u4e0d\u80fd\u76f4\u63a5\u4ece 1.16.x \u66f4\u65b0\u5230 1.19.x\uff0ckubeadm \u7684\u66f4\u65b0\u662f\u4e0d\u652f\u6301\u8de8\u591a\u4e2a\u4e3b\u7248\u672c\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4e00\u4e2a\u7248\u672c\u4e00\u4e2a\u7248\u672c\u7684\u5347\u7ea7\uff0c\u4e0d\u8fc7\u7248\u672c\u66f4\u65b0\u7684\u65b9\u5f0f\u65b9\u6cd5\u57fa\u672c\u4e0a\u90fd\u662f\u4e00\u6837\u7684\uff0c\u6240\u4ee5\u540e\u9762\u8981\u66f4\u65b0\u7684\u8bdd\u4e5f\u633a\u7b80\u5355\u4e86\uff0c\u4e0b\u9762\u6211\u4eec\u5c31\u5148\u5c06\u96c6\u7fa4\u66f4\u65b0\u5230 v1.26.14 \u7248\u672c\u3002</p> <p>\u9996\u5148\u67e5\u770b\u5f53\u524d\u96c6\u7fa4\u7248\u672c\uff1a</p> <pre><code>$ kubectl version\nClient Version: version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v2\", GitCommit:\"c97fe5036ef3df2967d086711e6c0c405941e14b\", GitTreeState:\"clean\", BuildDate:\"2019-10-15T19:18:23Z\", GoVersion:\"go10\", Compiler:\"gc\", Platform:\"linux/amd64\"}\nServer Version: version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v2\", GitCommit:\"c97fe5036ef3df2967d086711e6c0c405941e14b\", GitTreeState:\"clean\", BuildDate:\"2019-10-15T19:09:08Z\", GoVersion:\"go10\", Compiler:\"gc\", Platform:\"linux/amd64\"}\n</code></pre> <p>\u9996\u5148\u6211\u4eec\u4fdd\u7559 kubeadm config \u6587\u4ef6\uff1a</p> <pre><code>$ kubeadm config view &gt; kubeadm-config.yaml\napiServer:\n  extraArgs:\n    authorization-mode: Node,RBAC\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta2\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns:\n  type: CoreDNS\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: registry.aliyuncs.com/k8sxio  # \u4fee\u6539\u6210\u963f\u91cc\u4e91\u955c\u50cf\u6e90\nkind: ClusterConfiguration\nkubernetesVersion: v14\nnetworking:\n  dnsDomain: cluster.local\n  podSubnet: 20/16\n  serviceSubnet: 0/12\nscheduler: {}\n</code></pre> <p>\u5c06\u4e0a\u9762\u7684 <code>imageRepository</code> \u503c\u66f4\u6539\u4e3a\uff1a</p> <pre><code>registry.aliyuncs.com/k8sxio\n</code></pre> <p>\uff0c\u7136\u540e\u4fdd\u5b58\u5185\u5bb9\u5230\u6587\u4ef6 kubeadm-config.yaml \u4e2d\uff08\u5f53\u7136\u5982\u679c\u4f60\u7684\u96c6\u7fa4\u53ef\u4ee5\u83b7\u53d6\u5230 grc.io \u7684\u955c\u50cf\u53ef\u4ee5\u4e0d\u7528\u66f4\u6539\uff09\u3002</p> <p>\u7136\u540e\u66f4\u65b0 kubeadm:</p> <pre><code>$ yum makecache fast &amp;&amp; yum install -y kubeadm-14-0 kubectl-14-0\n$ kubeadm version\nkubeadm version: &amp;version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v14\", GitCommit:\"d2a081c8e14e21e28fe5bdfa38a817ef9c0bb8e3\", GitTreeState:\"clean\", BuildDate:\"2020-08-13T12:31:14Z\", GoVersion:\"go15\", Compiler:\"gc\", Platform:\"linux/amd64\"}\n</code></pre> <p>\u56e0\u4e3a <code>kubeadm upgrade plan</code> \u547d\u4ee4\u6267\u884c\u8fc7\u7a0b\u4e2d\u4f1a\u53bb <code>dl.k8s.io</code> \u83b7\u53d6\u7248\u672c\u4fe1\u606f\uff0c\u8fd9\u4e2a\u5730\u5740\u662f\u9700\u8981\u79d1\u5b66\u65b9\u6cd5\u624d\u80fd\u8bbf\u95ee\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5148\u5c06 kubeadm \u66f4\u65b0\u5230\u76ee\u6807\u7248\u672c\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u67e5\u770b\u5230\u76ee\u6807\u7248\u672c\u5347\u7ea7\u7684\u4e00\u4e9b\u4fe1\u606f\u4e86\u3002</p> <p>\u6267\u884c <code>upgrade plan</code> \u547d\u4ee4\u67e5\u770b\u662f\u5426\u53ef\u4ee5\u5347\u7ea7\uff1a</p> <pre><code>$ kubeadm upgrade plan\n[upgrade/config] Making sure the configuration is correct:\n[upgrade/config] Reading configuration from the cluster...\n[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'\n[preflight] Running pre-flight checks.\n[upgrade] Making sure the cluster is healthy:\n[upgrade] Fetching available versions to upgrade to\n[upgrade/versions] Cluster version: v2\n[upgrade/versions] kubeadm version: v14\nI0827 15:46:805052   11355 version.go:251] remote version is much newer: v0; falling back to: stable-16\n[upgrade/versions] Latest stable version: v14\n[upgrade/versions] Latest version in the v16 series: v14\n\nComponents that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':\nCOMPONENT   CURRENT       AVAILABLE\nKubelet     7 x v2   v14\n\nUpgrade to the latest version in the v16 series:\n\nCOMPONENT            CURRENT   AVAILABLE\nAPI Server           v2   v14\nController Manager   v2   v14\nScheduler            v2   v14\nKube Proxy           v2   v14\nCoreDNS              2     2\nEtcd                 15    15-0\n\nYou can now apply the upgrade by executing the following command:\n\n    kubeadm upgrade apply v14\n\n_____________________________________________________________________\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u5148\u4f7f\u7528 <code>dry-run</code> \u547d\u4ee4\u67e5\u770b\u5347\u7ea7\u4fe1\u606f\uff1a</p> <pre><code>$ kubeadm upgrade apply v14 --config kubeadm-config.yaml --dry-run\n</code></pre> <p>\u6ce8\u610f\u8981\u901a\u8fc7 <code>--config</code> \u6307\u5b9a\u4e0a\u9762\u4fdd\u5b58\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u8be5\u914d\u7f6e\u6587\u4ef6\u4fe1\u606f\u5305\u542b\u4e86\u4e0a\u4e00\u4e2a\u7248\u672c\u7684\u96c6\u7fa4\u4fe1\u606f\u4ee5\u53ca\u4fee\u6539\u8fc7\u540e\u7684\u955c\u50cf\u5730\u5740\u3002</p> <p>\u67e5\u770b\u4e86\u4e0a\u9762\u7684\u5347\u7ea7\u4fe1\u606f\u786e\u8ba4\u65e0\u8bef\u540e\u5c31\u53ef\u4ee5\u6267\u884c\u5347\u7ea7\u64cd\u4f5c\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u63d0\u524d\u4e0b\u8f7d\u6240\u9700\u955c\u50cf\uff1a</p> <pre><code>$ kubeadm config images pull --config kubeadm-config.yaml\n[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-apiserver:v14\n[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-controller-manager:v14\n[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-scheduler:v14\n[config/images] Pulled registry.aliyuncs.com/k8sxio/kube-proxy:v14\n[config/images] Pulled registry.aliyuncs.com/k8sxio/pause:1\n[config/images] Pulled registry.aliyuncs.com/k8sxio/etcd:15-0\n[config/images] Pulled registry.aliyuncs.com/k8sxio/coredns:2\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u6267\u884c\u771f\u6b63\u7684\u5347\u7ea7\u547d\u4ee4\uff1a</p> <pre><code>$ kubeadm upgrade apply v14 --config kubeadm-config.yaml\nkubeadm upgrade apply v14 --config kubeadm-config.yaml\n[upgrade/config] Making sure the configuration is correct:\n[preflight] Running pre-flight checks.\n[upgrade] Making sure the cluster is healthy:\n[upgrade/version] You have chosen to change the cluster version to \"v14\"\n[upgrade/versions] Cluster version: v2\n[upgrade/versions] kubeadm version: v14\n[upgrade/confirm] Are you sure you want to proceed with the upgrade? [y/N]:y\n......\n</code></pre> <p>\u9694\u4e00\u6bb5\u65f6\u95f4\u770b\u5230\u5982\u4e0b\u4fe1\u606f\u5c31\u8bc1\u660e\u96c6\u7fa4\u5347\u7ea7\u6210\u529f\u4e86\uff1a</p> <pre><code>......\n[addons]: Migrating CoreDNS Corefile\n[addons] Applied essential addon: CoreDNS\n[addons] Applied essential addon: kube-proxy\n\n[upgrade/successful] SUCCESS! Your cluster was upgraded to \"v14\". Enjoy!\n\n[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets if you haven't already done so.\n</code></pre> <p>\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u66f4\u65b0\u8fc7 kubectl \u4e86\uff0c\u73b0\u5728\u6211\u4eec\u7528 kubectl \u6765\u67e5\u770b\u4e0b\u7248\u672c\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl version\nClient Version: version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v14\", GitCommit:\"d2a081c8e14e21e28fe5bdfa38a817ef9c0bb8e3\", GitTreeState:\"clean\", BuildDate:\"2020-08-13T12:33:34Z\", GoVersion:\"go15\", Compiler:\"gc\", Platform:\"linux/amd64\"}\nServer Version: version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v14\", GitCommit:\"d2a081c8e14e21e28fe5bdfa38a817ef9c0bb8e3\", GitTreeState:\"clean\", BuildDate:\"2020-08-13T12:24:51Z\", GoVersion:\"go15\", Compiler:\"gc\", Platform:\"linux/amd64\"}\n$ kubectl get nodes\nNAME          STATUS   ROLES    AGE    VERSION\nydzs-master   Ready    master   292d   v2\nydzs-node1    Ready    &lt;none&gt;   292d   v2\nydzs-node2    Ready    &lt;none&gt;   292d   v2\nydzs-node3    Ready    &lt;none&gt;   290d   v2\nydzs-node4    Ready    &lt;none&gt;   290d   v2\nydzs-node5    Ready    &lt;none&gt;   218d   v2\nydzs-node6    Ready    &lt;none&gt;   218d   v2\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u7248\u672c\u5e76\u6ca1\u6709\u66f4\u65b0\uff0c\u8fd9\u662f\u56e0\u4e3a\u8282\u70b9\u4e0a\u7684 kubelet \u8fd8\u6ca1\u6709\u66f4\u65b0\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 kubelet \u67e5\u770b\u4e0b\u7248\u672c\uff1a</p> <pre><code>$ kubelet --version\nKubernetes v2\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53bb\u624b\u52a8\u66f4\u65b0\u4e0b kubelet\uff1a</p> <pre><code>$ yum install -y kubelet-14-0\n# \u5b89\u88c5\u5b8c\u6210\u540e\u67e5\u770b\u4e0b\u7248\u672c\n$ kubelet --version\nKubernetes v14\n# \u7136\u540e\u91cd\u542f kubelet \u670d\u52a1\n$ systemctl daemon-reload\n$ systemctl restart kubelet\n$ kubectl get nodes\nNAME          STATUS   ROLES    AGE    VERSION\nydzs-master   Ready    master   292d   v14\nydzs-node1    Ready    &lt;none&gt;   292d   v2\nydzs-node2    Ready    &lt;none&gt;   292d   v2\nydzs-node3    Ready    &lt;none&gt;   290d   v2\nydzs-node4    Ready    &lt;none&gt;   290d   v2\nydzs-node5    Ready    &lt;none&gt;   218d   v2\nydzs-node6    Ready    &lt;none&gt;   218d   v2\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 master \u8282\u70b9\u5df2\u7ecf\u66f4\u65b0\u5230 v1.26.14 \u7248\u672c\u4e86\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u53bb\u5347\u7ea7\u8282\u70b9\u4e86\uff0c\u5347\u7ea7\u8282\u70b9\u7684\u65f6\u5019\u6700\u597d\u5148\u9a71\u9010\u8282\u70b9\uff0c\u7136\u540e\u9010\u4e2a\u5347\u7ea7\uff1a</p> <pre><code>$ kubectl drain ydzs-node1 --ignore-daemonsets\nnode/ydzs-node1 cordoned\nerror: unable to drain node \"ydzs-node1\", aborting command...\n\nThere are pending nodes to be drained:\n ydzs-node1\nerror: cannot delete Pods with local storage (use --delete-local-data to override): rook-ceph/csi-cephfsplugin-provisioner-56c8b7ddf4-n96kk, rook-ceph/csi-rbdplugin-provisioner-6ff4dd4b94-2bl82\n$ kubectl get nodes\nNAME          STATUS                     ROLES    AGE    VERSION\nydzs-master   Ready                      master   292d   v14\nydzs-node1    Ready,SchedulingDisabled   &lt;none&gt;   292d   v2\nydzs-node2    Ready                      &lt;none&gt;   292d   v2\nydzs-node3    Ready                      &lt;none&gt;   290d   v2\nydzs-node4    Ready                      &lt;none&gt;   290d   v2\nydzs-node5    Ready                      &lt;none&gt;   218d   v2\nydzs-node6    Ready                      &lt;none&gt;   218d   v2\n</code></pre> <p>\u7136\u540e\u5728 ydzs-node1 \u8282\u70b9\u4e0a\u6267\u884c\u66f4\u65b0\u547d\u4ee4\uff1a</p> <pre><code>$ kubeadm upgrade node\n[upgrade] Reading configuration from the cluster...\n[upgrade] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'\n[upgrade] Skipping phase. Not a control plane node[kubelet-start] Downloading configuration for the kubelet from the \"kubelet-config-16\" ConfigMap in the kube-system namespace\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[upgrade] The configuration for this node was successfully updated!\n[upgrade] Now you should go ahead and upgrade the kubelet package using your package manager.\n# \u66f4\u65b0\u8f6f\u4ef6\u5305\n$ yum install -y kubeadm-14-0 kubectl-14-0 kubelet-14-0\n# \u5b89\u88c5\u5b8c\u6210\u540e\u91cd\u542f kubelet\n$ systemctl daemon-reload\n$ systemctl restart kubelet\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u786e\u8ba4\u8282\u70b9\u5347\u7ea7\u6210\u529f\uff1a</p> <pre><code>$ kubectl get nodes\nNAME          STATUS                     ROLES    AGE    VERSION\nydzs-master   Ready                      master   292d   v14\nydzs-node1    Ready,SchedulingDisabled   &lt;none&gt;   292d   v14\nydzs-node2    Ready                      &lt;none&gt;   292d   v2\nydzs-node3    Ready                      &lt;none&gt;   290d   v2\nydzs-node4    Ready                      &lt;none&gt;   290d   v2\nydzs-node5    Ready                      &lt;none&gt;   218d   v2\nydzs-node6    Ready                      &lt;none&gt;   218d   v2\n</code></pre> <p>\u7136\u540e\u89e3\u9664\u7981\u6b62\u8c03\u5ea6\uff1a</p> <pre><code>$ kubectl uncordon ydzs-node1\nnode/ydzs-node1 uncordoned\n</code></pre> <p>\u7528\u540c\u6837\u7684\u65b9\u5f0f\u5347\u7ea7\u5176\u4ed6\u8282\u70b9\u5373\u53ef\u5347\u7ea7\u6210\u529f\uff1a</p> <pre><code>$ kubectl get nodes\nNAME          STATUS   ROLES    AGE    VERSION\nydzs-master   Ready    master   292d   v14\nydzs-node1    Ready    &lt;none&gt;   292d   v14\nydzs-node2    Ready    &lt;none&gt;   292d   v14\nydzs-node3    Ready    &lt;none&gt;   290d   v14\nydzs-node4    Ready    &lt;none&gt;   290d   v14\nydzs-node5    Ready    &lt;none&gt;   218d   v14\nydzs-node6    Ready    &lt;none&gt;   218d   v14\n</code></pre> <p>Copyright \u00a9 2019-2020 \u4f18\u70b9\u77e5\u8bc6</p> <p>powered by MkDocs and Material for MkDocs</p>"},{"location":"kubernetes_maintain/update_cluster/","title":"\u5347\u7ea7\u4e3a\u96c6\u7fa4","text":""},{"location":"kubernetes_maintain/update_cluster/#_1","title":"\u9ad8\u53ef\u7528","text":"<p>\u524d\u9762\u6211\u4eec\u8bfe\u7a0b\u4e2d\u7684\u96c6\u7fa4\u662f\u5355 master \u7684\u96c6\u7fa4\uff0c\u5bf9\u4e8e\u751f\u4ea7\u73af\u5883\u98ce\u9669\u592a\u5927\u4e86\uff0c\u975e\u5e38\u6709\u5fc5\u8981\u505a\u4e00\u4e2a\u9ad8\u53ef\u7528\u7684\u96c6\u7fa4\uff0c\u8fd9\u91cc\u7684\u9ad8\u53ef\u7528\u4e3b\u8981\u662f\u9488\u5bf9\u63a7\u5236\u9762\u677f\u6765\u8bf4\u7684\uff0c\u6bd4\u5982 kube-apiserver\u3001etcd\u3001kube-controller-manager\u3001kube-scheduler \u8fd9\u51e0\u4e2a\u7ec4\u4ef6\uff0c\u5176\u4e2d kube-controller-manager \u4e8e kube-scheduler \u7ec4\u4ef6\u662f Kubernetes \u96c6\u7fa4\u81ea\u5df1\u53bb\u5b9e\u73b0\u7684\u9ad8\u53ef\u7528\uff0c\u5f53\u6709\u591a\u4e2a\u7ec4\u4ef6\u5b58\u5728\u7684\u65f6\u5019\uff0c\u4f1a\u81ea\u52a8\u9009\u62e9\u4e00\u4e2a\u4f5c\u4e3a Leader \u63d0\u4f9b\u670d\u52a1\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u6211\u4eec\u624b\u52a8\u53bb\u5b9e\u73b0\u9ad8\u53ef\u7528\uff0capiserver \u548c etcd \u5c31\u9700\u8981\u624b\u52a8\u53bb\u642d\u5efa\u9ad8\u53ef\u7528\u7684\u96c6\u7fa4\u7684\u3002\u9ad8\u53ef\u7528\u7684\u67b6\u6784\u6709\u5f88\u591a\uff0c\u6bd4\u5982\u5178\u578b\u7684 haproxy + keepalived \u67b6\u6784\uff0c\u6216\u8005\u4f7f\u7528 nginx \u6765\u505a\u4ee3\u7406\u5b9e\u73b0\u3002\u6211\u4eec\u8fd9\u91cc\u4e3a\u4e86\u8bf4\u660e\u5982\u4f55\u5c06\u5355 master \u5347\u7ea7\u4e3a\u9ad8\u53ef\u7528\u7684\u96c6\u7fa4\uff0c\u91c7\u7528\u76f8\u5bf9\u66f4\u7b80\u5355\u7684 nginx \u6a21\u5f0f\uff0c\u5f53\u7136\u8fd9\u79cd\u6a21\u5f0f\u4e5f\u6709\u4e00\u4e9b\u7f3a\u70b9\uff0c\u4f46\u662f\u8db3\u4ee5\u8bf4\u660e\u9ad8\u53ef\u7528\u7684\u5b9e\u73b0\u65b9\u5f0f\u4e86\u3002\u67b6\u6784\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u4ece\u4e0a\u9762\u67b6\u6784\u56fe\u4e0a\u53ef\u4ee5\u770b\u51fa\u6765\uff0c\u6211\u4eec\u9700\u8981\u5728\u6240\u6709\u7684\u8282\u70b9\u4e0a\u5b89\u88c5\u4e00\u4e2a nginx \u6765\u4ee3\u7406 apiserver\uff0c\u8fd9\u91cc\u6211\u4eec\u51c6\u59073\u4e2a\u8282\u70b9\u4f5c\u4e3a\u63a7\u5236\u5e73\u9762\u8282\u70b9\uff1aydzs-master\u3001ydzs-master2\u3001ydzs-master3\uff0c\u8fd9\u91cc\u6211\u4eec\u9ed8\u8ba4\u6240\u6709\u8282\u70b9\u90fd\u5df2\u7ecf\u6b63\u5e38\u5b89\u88c5\u914d\u7f6e\u597d\u4e86 Docker\uff1a</p> <p></p> <p>\u5728\u5f00\u59cb\u4e0b\u9762\u7684\u64cd\u4f5c\u4e4b\u524d\uff0c\u5728<code>\u6240\u6709\u8282\u70b9</code> hosts \u4e2d\u914d\u7f6e\u5982\u4e0b\u6240\u793a\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ cat /etc/hosts\n11 api.k8s.local\n170 ydzs-master2\n171 ydzs-master3\n111 ydzs-master\n157 ydzs-node3\n159 ydzs-node4\n160 ydzs-node5\n162 ydzs-node6\n122 ydzs-node1\n123 ydzs-node2\n</code></pre>"},{"location":"kubernetes_maintain/update_cluster/#_2","title":"\u66f4\u65b0\u8bc1\u4e66","text":"<p>\u7531\u4e8e\u6211\u4eec\u8981\u5c06\u96c6\u7fa4\u66ff\u6362\u6210\u9ad8\u53ef\u7528\u7684\u96c6\u7fa4\uff0c\u90a3\u4e48\u52bf\u5fc5\u4f1a\u60f3\u5230\u6211\u4eec\u4f1a\u7528\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\u6765\u4ee3\u7406 APIServer\uff0c\u4e5f\u5c31\u662f\u8fd9\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\u8bbf\u95ee APIServer \u7684\u65f6\u5019\u8981\u80fd\u6b63\u5e38\u8bbf\u95ee\uff0c\u6240\u4ee5\u9ed8\u8ba4\u5b89\u88c5\u7684 APIServer \u8bc1\u4e66\u5c31\u9700\u8981\u66f4\u65b0\uff0c\u56e0\u4e3a\u91cc\u9762\u6ca1\u6709\u5305\u542b\u6211\u4eec\u9700\u8981\u7684\u5730\u5740\uff0c\u9700\u8981\u4fdd\u8bc1\u5728 SAN \u5217\u8868\u4e2d\u5305\u542b\u4e00\u4e9b\u989d\u5916\u7684\u540d\u79f0\u3002</p> <p>\u9996\u9875\u6211\u4eec\u4e00\u4e2a kubeadm \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5982\u679c\u4e00\u5f00\u59cb\u5b89\u88c5\u96c6\u7fa4\u7684\u65f6\u5019\u4f60\u5c31\u662f\u4f7f\u7528\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u66f4\u65b0\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u4f46\u662f\u5982\u679c\u4f60\u6ca1\u6709\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\uff0c\u76f4\u63a5\u4f7f\u7528\u7684 <code>kubeadm init</code> \u6765\u5b89\u88c5\u7684\u96c6\u7fa4\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u4ece\u96c6\u7fa4\u4e2d\u83b7\u53d6 kubeadm \u7684\u914d\u7f6e\u4fe1\u606f\u6765\u521b\u5efa\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u56e0\u4e3a kubeadm \u4f1a\u5c06\u5176\u914d\u7f6e\u5199\u5165\u5230 kube-system \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u4e00\u4e2a\u540d\u4e3a <code>kubeadm-config</code> \u7684 ConfigMap \u4e2d\u3002\u53ef\u4ee5\u76f4\u63a5\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u5c06\u8be5\u914d\u7f6e\u5bfc\u51fa\uff1a</p> <pre><code>$ kubectl -n kube-system get configmap kubeadm-config -o jsonpath='{.data.ClusterConfiguration}' &gt; kubeadm.yaml\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u5bfc\u51fa\u4e00\u4e2a\u540d\u4e3a kubeadm.yaml \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiServer:\n  extraArgs:\n    authorization-mode: Node,RBAC\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta2\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns:\n  type: CoreDNS\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: registry.aliyuncs.com/k8sxio\nkind: ClusterConfiguration\nkubernetesVersion: v11\nnetworking:\n  dnsDomain: cluster.local\n  podSubnet: 20/16\n  serviceSubnet: 0/12\nscheduler: {}\n</code></pre> <p>\u4e0a\u9762\u7684\u914d\u7f6e\u4e2d\u5e76\u6ca1\u6709\u5217\u51fa\u989d\u5916\u7684 SAN \u4fe1\u606f\uff0c\u6211\u4eec\u8981\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u6570\u636e\uff0c\u9700\u8981\u5728 <code>apiServer</code> \u5c5e\u6027\u4e0b\u9762\u6dfb\u52a0\u4e00\u4e2a <code>certsSANs</code> \u7684\u5217\u8868\u3002\u5982\u679c\u4f60\u5728\u542f\u52a8\u96c6\u7fa4\u7684\u4f7f\u7528\u5c31\u4f7f\u7528\u7684\u4e86 kubeadm \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u53ef\u80fd\u91cc\u9762\u5c31\u5df2\u7ecf\u5305\u542b certSANs \u5217\u8868\u4e86\uff0c\u5982\u679c\u6ca1\u6709\u6211\u4eec\u5c31\u9700\u8981\u6dfb\u52a0\u5b83\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u8981\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u57df\u540d <code>api.k8s.local</code> \u4ee5\u53ca ydzs-master2 \u548c ydzs-master3 \u8fd9\u4e24\u4e2a\u4e3b\u673a\u540d\u548c 10.151.30.70\u300110.151.30.71 \u8fd9\u4e24\u4e2a\u65b0\u7684 IP \u5730\u5740\uff0c\u90a3\u4e48\u6211\u4eec\u9700\u8981\u5728 apiServer \u4e0b\u9762\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u6570\u636e\uff1a</p> <pre><code>apiServer:\n  certSANs:\n  - api.k8s.local\n  - ydzs-master\n  - ydzs-master2\n  - ydzs-master3\n  - 111\n  - 170\n  - 171\n  extraArgs:\n    authorization-mode: Node,RBAC\n  timeoutForControlPlane: 4m0s\n</code></pre> <p>\u4e0a\u9762\u6211\u53ea\u5217\u51fa\u4e86 apiServer \u4e0b\u9762\u65b0\u589e\u7684 certSANs \u4fe1\u606f\uff0c\u8fd9\u4e9b\u4fe1\u606f\u662f\u5305\u62ec\u5728\u6807\u51c6\u7684 SAN \u5217\u8868\u4e4b\u5916\u7684\uff0c\u6240\u4ee5\u4e0d\u7528\u62c5\u5fc3\u8fd9\u91cc\u6ca1\u6709\u6dfb\u52a0 kubernetes\u3001kubernetes.default \u7b49\u7b49\u8fd9\u4e9b\u4fe1\u606f\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u90fd\u662f\u6807\u51c6\u7684 SAN \u5217\u8868\u4e2d\u7684\u3002</p> <p>\u66f4\u65b0\u5b8c kubeadm \u914d\u7f6e\u6587\u4ef6\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u66f4\u65b0\u8bc1\u4e66\u4e86\uff0c\u9996\u5148\u6211\u4eec\u79fb\u52a8\u73b0\u6709\u7684 APIServer \u7684\u8bc1\u4e66\u548c\u5bc6\u94a5\uff0c\u56e0\u4e3a kubeadm \u68c0\u6d4b\u5230\u4ed6\u4eec\u5df2\u7ecf\u5b58\u5728\u4e8e\u6307\u5b9a\u7684\u4f4d\u7f6e\uff0c\u5b83\u5c31\u4e0d\u4f1a\u521b\u5efa\u65b0\u7684\u4e86\u3002</p> <pre><code>$ mv /etc/kubernetes/pki/apiserver.{crt,key} ~\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u4f7f\u7528 kubeadm \u547d\u4ee4\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u8bc1\u4e66\uff1a</p> <pre><code>$ kubeadm init phase certs apiserver --config kubeadm.yaml\nW0902 10:05:006627     832 validation.go:28] Cannot validate kubelet config - no validator is available\nW0902 10:05:006754     832 validation.go:28] Cannot validate kube-proxy config - no validator is available\n[certs] Generating \"apiserver\" certificate and key\n[certs] apiserver serving cert is signed for DNS names [ydzs-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local api.k8s.local ydzs-master2 ydzs-master3] and IPs [1 1112 111 170 171]\n</code></pre> <p>\u901a\u8fc7\u4e0a\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u5230 APIServer \u7b7e\u540d\u7684 DNS \u548c IP \u5730\u5740\u4fe1\u606f\uff0c\u4e00\u5b9a\u8981\u548c\u81ea\u5df1\u7684\u76ee\u6807\u7b7e\u540d\u4fe1\u606f\u8fdb\u884c\u5bf9\u6bd4\uff0c\u5982\u679c\u7f3a\u5931\u4e86\u6570\u636e\u5c31\u9700\u8981\u5728\u4e0a\u9762\u7684 certSANs \u4e2d\u8865\u9f50\uff0c\u91cd\u65b0\u751f\u6210\u8bc1\u4e66\u3002</p> <p>\u8be5\u547d\u4ee4\u4f1a\u4f7f\u7528\u4e0a\u9762\u6307\u5b9a\u7684 kubeadm \u914d\u7f6e\u6587\u4ef6\u4e3a APIServer \u751f\u6210\u4e00\u4e2a\u65b0\u7684\u8bc1\u4e66\u548c\u5bc6\u94a5\uff0c\u7531\u4e8e\u6307\u5b9a\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u5305\u542b\u4e86 certSANs \u5217\u8868\uff0c\u90a3\u4e48 kubeadm \u4f1a\u5728\u521b\u5efa\u65b0\u8bc1\u4e66\u7684\u65f6\u5019\u81ea\u52a8\u6dfb\u52a0\u8fd9\u4e9b SANs\u3002</p> <p>\u6700\u540e\u4e00\u6b65\u662f\u91cd\u542f APIServer \u6765\u63a5\u6536\u65b0\u7684\u8bc1\u4e66\uff0c\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u76f4\u63a5\u6740\u6b7b APIServer \u7684\u5bb9\u5668\uff1a</p> <pre><code>$ docker ps | grep kube-apiserver | grep -v pause\n7fe227a5dd3c        aa63290ccd50                               \"kube-apiserver --ad\u2026\"   14 hours ago        Up 14 hours                             k8s_kube-apiserver_kube-apiserver-ydzs-master_kube-system_6aa38ee2d66b7d9b6660a88700d00581_0\n$ docker kill 7fe227a5dd3c\n7fe227a5dd3c\n</code></pre> <p>\u5bb9\u5668\u88ab\u6740\u6389\u540e\uff0ckubelet \u4f1a\u81ea\u52a8\u91cd\u542f\u5bb9\u5668\uff0c\u7136\u540e\u5bb9\u5668\u5c06\u63a5\u6536\u65b0\u7684\u8bc1\u4e66\uff0c\u4e00\u65e6 APIServer \u91cd\u542f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u65b0\u6dfb\u52a0\u7684 IP \u5730\u5740\u6216\u8005\u4e3b\u673a\u540d\u6765\u8fde\u63a5\u5b83\u4e86\uff0c\u6bd4\u5982\u6211\u4eec\u65b0\u6dfb\u52a0\u7684 <code>api.k8s.local</code>\u3002</p>"},{"location":"kubernetes_maintain/update_cluster/#_3","title":"\u9a8c\u8bc1\u8bc1\u4e66","text":"<p>\u8981\u9a8c\u8bc1\u8bc1\u4e66\u662f\u5426\u66f4\u65b0\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u53bb\u7f16\u8f91 kubeconfig \u6587\u4ef6\u4e2d\u7684 APIServer \u5730\u5740\uff0c\u5c06\u5176\u66f4\u6362\u4e3a\u65b0\u6dfb\u52a0\u7684 IP \u5730\u5740\u6216\u8005\u4e3b\u673a\u540d\uff0c\u7136\u540e\u53bb\u4f7f\u7528 kubectl \u64cd\u4f5c\u96c6\u7fa4\uff0c\u67e5\u770b\u662f\u5426\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\u3002</p> <p>\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 openssl \u547d\u4ee4\u53bb\u67e5\u770b\u751f\u6210\u7684\u8bc1\u4e66\u4fe1\u606f\u662f\u5426\u5305\u542b\u6211\u4eec\u65b0\u6dfb\u52a0\u7684 SAN \u5217\u8868\u6570\u636e\uff1a</p> <pre><code>$ openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text\nCertificate:\n            ......\n        Subject: CN=kube-apiserver\n        ......\n            X509v3 Subject Alternative Name:\n                DNS:ydzs-master, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:api.k8s.local, DNS:ydzs-master2, DNS:ydzs-master3, IP Address:1, IP Address:1112, IP Address:111, IP Address:170, IP Address:171\n......\n</code></pre> <p>\u5982\u679c\u4e0a\u9762\u7684\u64cd\u4f5c\u90fd\u4e00\u5207\u987a\u5229\uff0c\u6700\u540e\u4e00\u6b65\u662f\u5c06\u4e0a\u9762\u7684\u96c6\u7fa4\u914d\u7f6e\u4fe1\u606f\u4fdd\u5b58\u5230\u96c6\u7fa4\u7684 kubeadm-config \u8fd9\u4e2a ConfigMap \u4e2d\u53bb\uff0c\u8fd9\u4e00\u70b9\u975e\u5e38\u91cd\u8981\uff0c\u8fd9\u6837\u4ee5\u540e\u5f53\u6211\u4eec\u4f7f\u7528 kubeadm \u6765\u64cd\u4f5c\u96c6\u7fa4\u7684\u65f6\u5019\uff0c\u76f8\u5173\u7684\u6570\u636e\u4e0d\u4f1a\u4e22\u5931\uff0c\u6bd4\u5982\u5347\u7ea7\u7684\u65f6\u5019\u8fd8\u662f\u4f1a\u5e26\u4e0a certSANs \u4e2d\u7684\u6570\u636e\u8fdb\u884c\u7b7e\u540d\u7684\u3002</p> <pre><code>$ kubeadm config upload from-file --config kubeadm.yaml\n</code></pre> <p>\u4f7f\u7528\u4e0a\u9762\u7684\u547d\u4ee4\u4fdd\u5b58\u914d\u7f6e\u540e\uff0c\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u9a8c\u8bc1\u662f\u5426\u4fdd\u5b58\u6210\u529f\u4e86\uff1a</p> <pre><code>$ kubectl -n kube-system get configmap kubeadm-config -o yaml\n</code></pre> <p>\u66f4\u65b0 APIServer \u8bc1\u4e66\u7684\u540d\u79f0\u5728\u5f88\u591a\u573a\u666f\u4e0b\u90fd\u4f1a\u4f7f\u7528\u5230\uff0c\u6bd4\u5982\u5728\u63a7\u5236\u5e73\u9762\u524d\u9762\u6dfb\u52a0\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u6216\u8005\u6dfb\u52a0\u65b0\u7684 DNS \u540d\u79f0\u6216 IP \u5730\u5740\u6765\u4f7f\u7528\u63a7\u5236\u5e73\u9762\u7684\u7aef\u70b9\uff0c\u6240\u4ee5\u638c\u63e1\u66f4\u65b0\u96c6\u7fa4\u8bc1\u4e66\u7684\u65b9\u6cd5\u4e5f\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\u3002</p>"},{"location":"kubernetes_maintain/update_cluster/#_4","title":"\u4e3a\u63a7\u5236\u5e73\u9762\u521b\u5efa\u8d1f\u8f7d\u5747\u8861\u5668","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u4e3a\u63a7\u5236\u5e73\u9762\u521b\u5efa\u4e00\u4e2a\u8d1f\u8f7d\u5e73\u8861\u5668\u3002\u5982\u4f55\u8bbe\u7f6e\u548c\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u5177\u4f53\u7ec6\u8282\u56e0\u89e3\u51b3\u65b9\u6848\u4e0d\u540c\uff0c\u4f46\u662f\u4e00\u822c\u7684\u65b9\u6848\u90fd\u9700\u8981\u5305\u62ec\u4e0b\u9762\u7684\u529f\u80fd\uff1a</p> <ul> <li>\u4f7f\u75284\u5c42\u8d1f\u8f7d\u5e73\u8861\u5668\uff08TCP\u800c\u4e0d\u662fHTTP / HTTPS\uff09</li> <li>\u8fd0\u884c\u5065\u5eb7\u68c0\u67e5\u5e94\u914d\u7f6e\u4e3a SSL\uff0c\u800c\u4e0d\u662f TCP \u8fd0\u884c\u72b6\u51b5\u68c0\u67e5</li> </ul> <p>\u4e0d\u7ba1\u7528\u54ea\u4e00\u79cd\u65b9\u5f0f\uff0c\u6211\u4eec\u6700\u597d\u521b\u5efa\u4e00\u4e2a DNS CNAME \u6761\u76ee\u4ee5\u6307\u5411\u60a8\u7684\u8d1f\u8f7d\u5747\u8861\u5668\uff08\u5f3a\u70c8\u5efa\u8bae\uff09\u3002\u5982\u679c\u60a8\u9700\u8981\u66f4\u6362\u6216\u91cd\u65b0\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u89e3\u51b3\u65b9\u6848\uff0c\u8fd9\u5c06\u4e3a\u60a8\u63d0\u4f9b\u66f4\u591a\u7684\u7075\u6d3b\u6027\uff0c\u56e0\u4e3a DNS CNAME \u4fdd\u6301\u4e0d\u53d8\uff0c\u5c31\u4e0d\u7528\u518d\u6b21\u53bb\u66f4\u65b0\u8bc1\u4e66\u4e86\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u91c7\u7528\u7684\u65b9\u6848\u662f\u5728\u8282\u70b9\u4e0a\u4f7f\u7528 nginx \u6765\u4f5c\u4e3a\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u4e0b\u9762\u7684\u64cd\u4f5c\u9700\u8981\u5728<code>\u6240\u6709\u8282\u70b9</code>\u4e0a\u64cd\u4f5c\uff1a</p> <pre><code>$ mkdir -p /etc/kubernetes\n$ cat &gt; /etc/kubernetes/nginx.conf &lt;&lt; EOF\nerror_log stderr notice;\n\nworker_processes 2;\nworker_rlimit_nofile 130048;\nworker_shutdown_timeout 10s;\n\nevents {\n  multi_accept on;\n  use epoll;\n  worker_connections 16384;\n}\n\nstream {\n  upstream kube_apiserver {\n    least_conn;\n    server ydzs-master:6443;\n    server ydzs-master2:6443;\n    server ydzs-master3:6443;\n  }\n\n  server {\n    listen        8443;\n    proxy_pass    kube_apiserver;\n    proxy_timeout 10m;\n    proxy_connect_timeout 1s;\n  }\n}\n\nhttp {\n  aio threads;\n  aio_write on;\n  tcp_nopush on;\n  tcp_nodelay on;\n\n  keepalive_timeout 5m;\n  keepalive_requests 100;\n  reset_timedout_connection on;\n  server_tokens off;\n  autoindex off;\n\n  server {\n    listen 8081;\n    location /healthz {\n      access_log off;\n      return 200;\n    }\n    location /stub_status {\n      stub_status on;\n      access_log off;\n    }\n  }\n}\nEOF\n</code></pre> <p>\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u542f\u52a8\u4e00\u4e2a nginx \u5bb9\u5668\uff1a</p> <pre><code>$ docker run --restart=always \\\\\n    -v /etc/kubernetes/nginx.conf:/etc/nginx/nginx.conf \\\\\n    -v /etc/localtime:/etc/localtime:ro \\\\\n    --name k8s-ha \\\\\n    --net host \\\\\n    -d \\\\\n    nginx\n</code></pre> <p>\u542f\u52a8\u6210\u529f\u540e apiserver \u7684\u8d1f\u8f7d\u5747\u8861\u5730\u5740\u5c31\u6210\u4e86 </p> <pre><code>https://api.k8s.local:8443\n</code></pre> <p>\u3002\u7136\u540e\u6211\u4eec\u5c06 kubeconfig \u6587\u4ef6\u4e2d\u7684 apiserver \u5730\u5740\u66ff\u6362\u6210\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u5730\u5740\u3002</p> <pre><code># \u4fee\u6539 kubelet \u914d\u7f6e\n$ vi /etc/kubernetes/kubelet.conf\n......\n    server: https://api.k8s.local:8443\n  name: kubernetes\n......\n$ systemctl restart kubelet\n# \u4fee\u6539 controller-manager\n$ vi /etc/kubernetes/controller-manager.conf\n......\n    server: https://api.k8s.local:8443\n  name: kubernetes\n......\n# \u91cd\u542f\n$ docker kill $(docker ps | grep kube-controller-manager | \\\\\ngrep -v pause | cut -d' ' -f1)\n# \u4fee\u6539 scheduler\n$ vi /etc/kubernetes/scheduler.conf\n......\n    server: https://api.k8s.local:8443\n  name: kubernetes\n......\n# \u91cd\u542f\n$ docker kill $(docker ps | grep kube-scheduler | grep -v pause | \\\\\ncut -d' ' -f1)\n</code></pre> <p>\u7136\u540e\u66f4\u65b0 kube-proxy</p> <pre><code>$ kubectl -n kube-system edit cm kube-proxy\n......\n  kubeconfig.conf: |-\n    apiVersion: v1\n    kind: Config\n    clusters:\n    - cluster:\n        certificate-authority: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n        server: https://api.k8s.local:8443\n      name: default\n......\n</code></pre> <p>\u5f53\u7136\u8fd8\u6709 kubectl \u8bbf\u95ee\u96c6\u7fa4\u7684 <code>~/.kube/config</code> \u6587\u4ef6\u4e5f\u9700\u8981\u4fee\u6539\u3002</p>"},{"location":"kubernetes_maintain/update_cluster/#_5","title":"\u66f4\u65b0\u63a7\u5236\u9762\u677f","text":"<p>\u7531\u4e8e\u6211\u4eec\u73b0\u5728\u5df2\u7ecf\u5728\u63a7\u5236\u5e73\u9762\u7684\u524d\u9762\u6dfb\u52a0\u4e86\u4e00\u4e2a\u8d1f\u8f7d\u5e73\u8861\u5668\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u4f7f\u7528\u6b63\u786e\u7684\u4fe1\u606f\u66f4\u65b0\u6b64 ConfigMap\u3002\uff08\u60a8\u5f88\u5feb\u5c31\u4f1a\u5c06\u63a7\u5236\u5e73\u9762\u8282\u70b9\u6dfb\u52a0\u5230\u96c6\u7fa4\u4e2d\uff0c\u56e0\u6b64\u5728\u6b64ConfigMap\u4e2d\u62e5\u6709\u6b63\u786e\u7684\u4fe1\u606f\u5f88\u91cd\u8981\u3002\uff09</p> <p>\u9996\u5148\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4ece ConfigMap \u4e2d\u83b7\u53d6\u5f53\u524d\u914d\u7f6e\uff1a</p> <pre><code>$ kubectl -n kube-system get configmap kubeadm-config -o jsonpath='{.data.ClusterConfiguration}' &gt; kubeadm.yaml\n</code></pre> <p>\u7136\u540e\u5728\u5f53\u524d\u914d\u7f6e\u6587\u4ef6\u91cc\u9762\u91cc\u9762\u6dfb\u52a0 <code>controlPlaneEndpoint</code> \u5c5e\u6027\uff0c\u7528\u4e8e\u6307\u5b9a\u63a7\u5236\u9762\u677f\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u5730\u5740\u3002</p> <pre><code>$ vi kubeadm.yaml\ncontrolPlaneEndpoint: api.k8s.local:8443  # \u6dfb\u52a0\u6539\u914d\u7f6e\napiServer:\n  certSANs:\n  - api.k8s.local\n  - ydzs-master\n  - ydzs-master2\n  - ydzs-master3\n  - 111\n  - 170\n  - 171\n......\n</code></pre> <p>\u7f16\u8f91\u5b8c\u6587\u4ef6\u540e\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5c06\u5176\u4e0a\u4f20\u56de\u96c6\u7fa4\uff1a</p> <pre><code>$ kubeadm config upload from-file --config kubeadm.yaml\n</code></pre> <p>\u7136\u540e\u9700\u8981\u5728 <code>kube-public</code> \u547d\u540d\u7a7a\u95f4\u4e2d\u66f4\u65b0 <code>cluster-info</code> \u8fd9\u4e2a ConfigMap\uff0c\u8be5\u547d\u540d\u7a7a\u95f4\u5305\u542b\u4e00\u4e2aKubeconfig \u6587\u4ef6\uff0c\u8be5\u6587\u4ef6\u7684 <code>server:</code> \u4e00\u884c\u6307\u5411\u5355\u4e2a\u63a7\u5236\u5e73\u9762\u8282\u70b9\u3002\u53ea\u9700\u4f7f\u7528</p> <pre><code>kubectl -n kube-public edit cm cluster-info\n</code></pre> <p>\u66f4\u65b0\u8be5 <code>server:</code> \u884c\u4ee5\u6307\u5411\u63a7\u5236\u5e73\u9762\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u5373\u53ef\u3002</p> <pre><code>$ kubectl -n kube-public edit cm cluster-info\n......\n    server: https://api.k8s.local:8443\n  name: \"\"\n......\n$  kubectl cluster-info\nKubernetes master is running at https://api.k8s.local:8443\nKubeDNS is running at https://api.k8s.local:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy\nKubeDNSUpstream is running at https://api.k8s.local:8443/api/v1/namespaces/kube-system/services/kube-dns-upstream:dns/proxy\nMetrics-server is running at https://api.k8s.local:8443/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy\n\nTo further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u5c31\u53ef\u4ee5\u770b\u5230 cluster-info \u7684\u4fe1\u606f\u53d8\u6210\u4e86\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u5730\u5740\u4e86\u3002</p>"},{"location":"kubernetes_maintain/update_cluster/#_6","title":"\u6dfb\u52a0\u63a7\u5236\u5e73\u9762","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u6dfb\u52a0\u989d\u5916\u7684\u63a7\u5236\u5e73\u9762\u8282\u70b9\uff0c\u9996\u5148\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u6765\u5c06\u96c6\u7fa4\u7684\u8bc1\u4e66\u4e0a\u4f20\u5230\u96c6\u7fa4\u4e2d\uff0c\u4f9b\u5176\u4ed6\u63a7\u5236\u8282\u70b9\u4f7f\u7528\uff1a</p> <pre><code>$ kubeadm init phase upload-certs --upload-certs\nI0903 15:13:192467   20533 version.go:251] remote version is much newer: v0; falling back to: stable-17\nW0903 15:13:739892   20533 validation.go:28] Cannot validate kube-proxy config - no validator is available\nW0903 15:13:739966   20533 validation.go:28] Cannot validate kubelet config - no validator is available\n[upload-certs] Storing the certificates in Secret \"kubeadm-certs\" in the \"kube-system\" Namespace\n[upload-certs] Using certificate key:\ne71ef7ede98e49f5f094b150d604c7ad50f125279180a7320b1b14ef3ccc3a34\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u8bc1\u4e66\u5bc6\u94a5\uff0c\u4f46\u662f\u53ea\u67092\u5c0f\u65f6\u6709\u6548\u671f\u3002\u7531\u4e8e\u6211\u4eec\u73b0\u6709\u7684\u96c6\u7fa4\u5df2\u7ecf\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\u4e86\uff0c\u6240\u4ee5\u4e4b\u524d\u7684\u542f\u52a8 Token \u4e5f\u5df2\u7ecf\u5931\u6548\u4e86\uff08Token \u7684\u9ed8\u8ba4\u751f\u5b58\u671f\u4e3a24\u5c0f\u65f6\uff09\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Token \u6765\u6dfb\u52a0\u65b0\u7684\u63a7\u5236\u5e73\u9762\u8282\u70b9\uff1a</p> <pre><code>$ kubeadm token create --print-join-command --config kubeadm.yaml\nW0903 15:29:958329   25049 validation.go:28] Cannot validate kube-proxy config - no validator is available\nW0903 15:29:958457   25049 validation.go:28] Cannot validate kubelet config - no validator is available\nkubeadm join api.k8s.local:8443 --token f27w7m.adelvl3waw9kqdhp     --discovery-token-ca-cert-hash sha256:6917cbf7b0e73ecfef77217e9a27e76ef9270aa379c34af30201abd0f1088c34\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u6700\u540e\u7ed9\u51fa\u7684\u63d0\u793a\u662f\u6dfb\u52a0 node \u8282\u70b9\u7684\u547d\u4ee4\uff0c\u6211\u4eec\u8fd9\u91cc\u8981\u6dfb\u52a0\u63a7\u5236\u5e73\u9762\u8282\u70b9\u5c31\u8981\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ kubeadm join &lt;DNS CNAME of load balancer&gt;:&lt;lb port&gt; \\\\\n--token &lt;bootstrap-token&gt; \\\\\n--discovery-token-ca-cert-hash sha256:&lt;CA certificate hash&gt; \\\\\n--control-plane --certificate-key &lt;certificate-key&gt;\n</code></pre> <p>\u83b7\u5f97\u4e86\u4e0a\u9762\u7684\u6dfb\u52a0\u547d\u4ee4\u8fc7\u540e\uff0c\u767b\u5f55\u5230 ydzs-master2 \u8282\u70b9\u8fdb\u884c\u76f8\u5173\u7684\u64cd\u4f5c\uff0c\u5728 ydzs-master2 \u8282\u70b9\u4e0a\u5b89\u88c5\u8f6f\u4ef6\uff1a</p> <pre><code>$ yum install -y kubeadm-11-0 kubelet-11-0 kubectl-11-0\n</code></pre> <p>\u8981\u52a0\u5165\u63a7\u5236\u5e73\u9762\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u62c9\u53d6\u76f8\u5173\u955c\u50cf\uff1a</p> <pre><code>$ kubeadm config images pull --image-repository registry.aliyuncs.com/k8sxio\n</code></pre> <p>\u7136\u540e\u6267\u884c\u4e0a\u9762\u751f\u6210\u7684 join \u547d\u4ee4\uff0c\u5c06\u53c2\u6570\u66ff\u6362\u540e\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ kubeadm join api.k8s.local:8443 \\\\\n--token f27w7m.adelvl3waw9kqdhp \\\\\n--discovery-token-ca-cert-hash sha256:6917cbf7b0e73ecfef77217e9a27e76ef9270aa379c34af30201abd0f1088c34 \\\\\n--control-plane --certificate-key e71ef7ede98e49f5f094b150d604c7ad50f125279180a7320b1b14ef3ccc3a34\n[preflight] Running pre-flight checks\n[preflight] Reading configuration from the cluster...\n[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'\n[preflight] Running pre-flight checks before initializing the new control plane instance\n[preflight] Pulling images required for setting up a Kubernetes cluster\n[preflight] This might take a minute or two, depending on the speed of your internet connection\n[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'\n[download-certs] Downloading the certificates in Secret \"kubeadm-certs\" in the \"kube-system\" Namespace\n[certs] Using certificateDir folder \"/etc/kubernetes/pki\"\n[certs] Generating \"apiserver-kubelet-client\" certificate and key\n[certs] Generating \"apiserver\" certificate and key\n[certs] apiserver serving cert is signed for DNS names [ydzs-master2 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local api.k8s.local api.k8s.local ydzs-master2 ydzs-master3] and IPs [1 170 111 170 171]\n[certs] Generating \"front-proxy-client\" certificate and key\n[certs] Generating \"etcd/healthcheck-client\" certificate and key\n[certs] Generating \"etcd/server\" certificate and key\n[certs] etcd/server serving cert is signed for DNS names [ydzs-master2 localhost] and IPs [170 11 ::1]\n[certs] Generating \"etcd/peer\" certificate and key\n[certs] etcd/peer serving cert is signed for DNS names [ydzs-master2 localhost] and IPs [170 11 ::1]\n[certs] Generating \"apiserver-etcd-client\" certificate and key\n[certs] Valid certificates and keys now exist in \"/etc/kubernetes/pki\"\n[certs] Using the existing \"sa\" key\n[kubeconfig] Generating kubeconfig files\n[kubeconfig] Using kubeconfig folder \"/etc/kubernetes\"\n[endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address\n[kubeconfig] Writing \"admin.conf\" kubeconfig file\n[kubeconfig] Writing \"controller-manager.conf\" kubeconfig file\n[kubeconfig] Writing \"scheduler.conf\" kubeconfig file\n[control-plane] Using manifest folder \"/etc/kubernetes/manifests\"\n[control-plane] Creating static Pod manifest for \"kube-apiserver\"\nW0903 15:55:444989    4353 manifests.go:214] the default kube-apiserver authorization-mode is \"Node,RBAC\"; using \"Node,RBAC\"\n[control-plane] Creating static Pod manifest for \"kube-controller-manager\"\nW0903 15:55:457787    4353 manifests.go:214] the default kube-apiserver authorization-mode is \"Node,RBAC\"; using \"Node,RBAC\"\n[control-plane] Creating static Pod manifest for \"kube-scheduler\"\nW0903 15:55:459829    4353 manifests.go:214] the default kube-apiserver authorization-mode is \"Node,RBAC\"; using \"Node,RBAC\"\n[check-etcd] Checking that the etcd cluster is healthy\n......\nThis node has joined the cluster and a new control plane instance was created:\n\n* Certificate signing request was sent to apiserver and approval was received.\n* The Kubelet was informed of the new secure connection details.\n* Control plane (master) label and taint were applied to the new node.\n* The Kubernetes control plane instances scaled up.\n* A new etcd member was added to the local/stacked etcd cluster.\n\nTo start administering your cluster from this node, you need to run the following as a regular user:\n\n    mkdir -p $HOME/.kube\n    sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n    sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nRun 'kubectl get nodes' to see this node join the cluster.\n</code></pre> <p>\u5982\u679c\u5728 etcd \u91cc\u9762\u6709\u6b8b\u7559\u7684\u5e9f\u5f03\u8282\u70b9\u6570\u636e\uff0c\u53ef\u4ee5\u7528\u5982\u4e0b\u547d\u4ee4\u5220\u9664\uff1a</p> <pre><code># \u5217\u51fa\u6240\u6709\u6210\u5458\n$ ./etcdctl --endpoints=$ENDPOINTS member list  \n# \u5220\u9664\u6307\u5b9a\u6210\u5458\n$ ./etcdctl --endpoints=$ENDPOINTS member remove b9057cfdc8ff17ce\n</code></pre> <p>\u5230\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230 ydzs-master2 \u8282\u70b9\u5c31\u6210\u529f\u52a0\u5165\u5230\u4e86\u63a7\u5236\u5e73\u9762\u4e2d\uff0c\u7136\u540e\u6839\u636e\u4e0a\u9762\u7684\u63d0\u793a\u914d\u7f6e kubeconfig \u6587\u4ef6\u3002\u7136\u540e\u7528\u540c\u6837\u7684\u65b9\u5f0f\u6dfb\u52a0 ydzs-master3 \u8282\u70b9\uff0c\u90fd\u6dfb\u52a0\u6210\u529f\u540e\uff0c\u5728 ydzs-master3 \u8282\u70b9\u4e0a\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u6765\u9a8c\u8bc1 etcd \u96c6\u7fa4\u4f7f\u7528\u6b63\u5e38\uff1a</p> <pre><code>$ docker run --rm -it \\\\\n--net host \\\\\n-v /etc/kubernetes:/etc/kubernetes registry.aliyuncs.com/k8sxio/etcd:3-0 etcdctl \\\\\n--cert /etc/kubernetes/pki/etcd/peer.crt \\\\\n--key /etc/kubernetes/pki/etcd/peer.key \\\\\n--cacert /etc/kubernetes/pki/etcd/ca.crt \\\\\n--endpoints https://171:2379 endpoint health --cluster\n# endpoint status --write-out=table \u67e5\u770b\u72b6\u6001\nhttps://170:2379 is healthy: successfully committed proposal: took = 410192ms\nhttps://171:2379 is healthy: successfully committed proposal: took = 077275ms\nhttps://111:2379 is healthy: successfully committed proposal: took = 282643ms\n$ docker run --rm -it --net host -v /etc/kubernetes:/etc/kubernetes registry.aliyuncs.com/k8sxio/etcd:3-0 etcdctl --cert /etc/kubernetes/pki/etcd/peer.crt --key /etc/kubernetes/pki/etcd/peer.key --cacert /etc/kubernetes/pki/etcd/ca.crt --endpoints https://111:2379,https://170:2379,https://171:2379 endpoint status --write-out=table\n+---------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n|         ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |\n+---------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n| https://111:2379 |  3d1fd8983aed809 |   3 |   52 MB |     false |      false |       113 |  119502257 |          119502257 |        |\n| https://170:2379 | af2e11ae8aa72bde |   3 |   52 MB |      true |      false |       113 |  119502259 |          119502259 |        |\n| https://171:2379 | e7a7b252880befdf |   3 |   52 MB |     false |      false |       113 |  119502259 |          119502259 |        |\n+---------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n</code></pre> <p>\u6b63\u5e38\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u5230 etcd \u96c6\u7fa4\u6b63\u5e38\u4e86\uff0c\u4f46\u662f\u7531\u4e8e\u63a7\u5236\u5e73\u53f0\u76843\u4e2a\u8282\u70b9\u662f\u5148\u540e\u5b89\u88c5\u7684\uff0c\u6240\u4ee5\u524d\u9762\u4e24\u4e2a\u8282\u70b9\u7684 etcd \u4e2d\u5e76\u4e0d\u5305\u542b\u5176\u4ed6 etcd \u8282\u70b9\u7684\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u540c\u6b65\u6240\u6709\u63a7\u5236\u5e73\u9762\u8282\u70b9\u7684 etcd \u96c6\u7fa4\u914d\u7f6e\uff1a</p> <pre><code>$ cat /etc/kubernetes/manifests/etcd.yaml\n......\n- --initial-cluster=ydzs-master=https://111:2380,ydzs-master2=https://170:2380,ydzs-master3=https://171:2380\n......\n</code></pre> <p>\u6700\u540e\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u67e5\u770b\u96c6\u7fa4\u662f\u5426\u6b63\u5e38\uff1a</p> <pre><code>$ kubectl get nodes\nNAME           STATUS   ROLES    AGE    VERSION\nydzs-master    Ready    master   299d   v11\nydzs-master2   Ready    master   34m    v11\nydzs-master3   Ready    master   10m    v11\nydzs-node1     Ready    &lt;none&gt;   299d   v11\nydzs-node2     Ready    &lt;none&gt;   299d   v11\nydzs-node3     Ready    &lt;none&gt;   297d   v11\nydzs-node4     Ready    &lt;none&gt;   297d   v11\nydzs-node5     Ready    &lt;none&gt;   225d   v11\nydzs-node6     Ready    &lt;none&gt;   225d   v11\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u5230 ydzs-master\u3001ydzs-master2\u3001ydzs-master3 3\u4e2a\u8282\u70b9\u53d8\u6210\u4e86 master \u8282\u70b9\uff0c\u6211\u4eec\u4e5f\u5c31\u5b8c\u6210\u4e86\u5c06\u5355 master \u5347\u7ea7\u4e3a\u591a master \u7684\u9ad8\u53ef\u7528\u96c6\u7fa4\u4e86\u3002</p>"},{"location":"kubernetes_monitor/adapter/","title":"Prometheus Adpater","text":""},{"location":"kubernetes_monitor/adapter/#_1","title":"\u81ea\u5b9a\u4e49\u6307\u6807\u6269\u7f29\u5bb9","text":"<p>\u4f7f\u7528 Kubernetes \u8fdb\u884c\u5bb9\u5668\u7f16\u6392\u7684\u4e3b\u8981\u4f18\u70b9\u4e4b\u4e00\u662f\uff0c\u5b83\u53ef\u4ee5\u975e\u5e38\u8f7b\u677e\u5730\u5bf9\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u6c34\u5e73\u6269\u5c55\u3002Pod \u6c34\u5e73\u81ea\u52a8\u7f29\u653e\uff08HPA\uff09\u53ef\u4ee5\u6839\u636e CPU \u548c\u5185\u5b58\u4f7f\u7528\u91cf\u6765\u6269\u5c55\u5e94\u7528\uff0c\u524d\u9762\u8bb2\u89e3\u7684 HPA \u7ae0\u8282 \u6211\u4eec\u53ea\u6f14\u793a\u4e86\u57fa\u4e8e CPU \u7684\u81ea\u52a8\u7f29\u653e\uff0c\u5728\u66f4\u590d\u6742\u7684\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u80fd\u8fd8\u9700\u8981\u57fa\u4e8e\u5185\u5b58\u6216\u8005\u57fa\u4e8e\u67d0\u4e9b\u81ea\u5b9a\u4e49\u7684\u6307\u6807\u6765\u8fdb\u884c\u6269\u7f29\u5bb9\u3002</p> <p>HorizontalPodAutoscaler \u662f Kubernetes autoscaling API \u7ec4\u7684\u8d44\u6e90\uff0c\u5728\u5f53\u524d\u7a33\u5b9a\u7248\u672c <code>autoscaling/v1</code> \u4e2d\u53ea\u652f\u6301\u57fa\u4e8e CPU \u6307\u6807\u7684\u7f29\u653e\u3002\u5728 Beta \u7248\u672c <code>autoscaling/v2beta2</code>\uff0c\u5f15\u5165\u4e86\u57fa\u4e8e\u5185\u5b58\u548c\u81ea\u5b9a\u4e49\u6307\u6807\u7684\u7f29\u653e\u3002\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u9700\u8981\u4f7f\u7528 Beta \u7248\u672c\u7684 API\u3002</p> <p></p>"},{"location":"kubernetes_monitor/adapter/#_2","title":"\u5185\u5b58","text":"<p>\u8981\u4f7f\u7528\u57fa\u4e8e\u5185\u5b58\u6216\u8005\u81ea\u5b9a\u4e49\u6307\u6807\u8fdb\u884c\u6269\u7f29\u5bb9\uff0c\u73b0\u5728\u7684\u7248\u672c\u90fd\u5fc5\u987b\u4f9d\u8d56 metrics-server \u8fd9\u4e2a\u9879\u76ee\uff0c\u5982\u679c\u6ca1\u6709\u5b89\u88c5\u7684\u9700\u8981\u63d0\u524d\u5b89\u88c5\u8be5\u9879\u76ee\uff0c\u800c\u4e14\u8fd8\u9700\u8981\u5f00\u542f\u805a\u5408 API \u5c42\uff0c\u524d\u9762 HPA \u7ae0\u8282 \u90fd\u5df2\u7ecf\u8bb2\u89e3\u8fc7\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u7528 Deployment \u6765\u521b\u5efa\u4e00\u4e2a Nginx Pod\uff0c\u7136\u540e\u5229\u7528 HPA \u6765\u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\u3002\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a\uff08hpa-mem-demo.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hpa-mem-demo\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      volumes:\n      - name: increase-mem-script\n        configMap:\n          name: increase-mem-config\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n        volumeMounts:\n        - name: increase-mem-script\n          mountPath: /etc/script\n        resources:\n          requests:\n            memory: 50Mi\n            cpu: 50m\n        securityContext:\n          privileged: true\n</code></pre> <p>\u8fd9\u91cc\u548c\u524d\u9762\u666e\u901a\u7684\u5e94\u7528\u6709\u4e00\u4e9b\u533a\u522b\uff0c\u6211\u4eec\u5c06\u4e00\u4e2a\u540d\u4e3a <code>increase-mem-config</code> \u7684 ConfigMap \u8d44\u6e90\u5bf9\u8c61\u6302\u8f7d\u5230\u4e86\u5bb9\u5668\u4e2d\uff0c\u8be5\u914d\u7f6e\u6587\u4ef6\u662f\u7528\u4e8e\u540e\u9762\u589e\u52a0\u5bb9\u5668\u5185\u5b58\u5360\u7528\u7684\u811a\u672c\uff0c\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a\uff08increase-mem-cm.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: increase-mem-config\ndata:\n  increase-mem.sh: |\n    #!/bin/bash  \n    mkdir /tmp/memory  \n    mount -t tmpfs -o size=40M tmpfs /tmp/memory  \n    dd if=/dev/zero of=/tmp/memory/block  \n    sleep 60 \n    rm /tmp/memory/block  \n    umount /tmp/memory  \n    rmdir /tmp/memory\n</code></pre> <p>\u7531\u4e8e\u8fd9\u91cc\u589e\u52a0\u5185\u5b58\u7684\u811a\u672c\u9700\u8981\u4f7f\u7528\u5230 <code>mount</code> \u547d\u4ee4\uff0c\u8fd9\u9700\u8981\u58f0\u660e\u4e3a\u7279\u6743\u6a21\u5f0f\uff0c\u6240\u4ee5\u6211\u4eec\u6dfb\u52a0\u4e86 </p> <pre><code>securityContext.privileged=true\n</code></pre> <p>\u8fd9\u4e2a\u914d\u7f6e\u3002\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f increase-mem-cm.yaml\n$ kubectl apply -f hpa-mem-demo.yaml \n$ kubectl get pods -l app=nginx\nNAME                            READY   STATUS    RESTARTS   AGE\nhpa-mem-demo-66944b79bf-tqrn9   1/1     Running   0          35s\n</code></pre> <p>\u7136\u540e\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u57fa\u4e8e\u5185\u5b58\u7684 HPA \u8d44\u6e90\u5bf9\u8c61\uff1a\uff08hpa-mem.yaml\uff09</p> <pre><code>apiVersion: autoscaling/v2beta1\nkind: HorizontalPodAutoscaler\nmetadata:\n  name: nginx-hpa\nspec:\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: hpa-mem-demo\n  minReplicas: 1\n  maxReplicas: 5\n  metrics:\n  - type: Resource\n    resource:\n      name: memory\n      targetAverageUtilization: 60\n</code></pre> <p>\u8981\u6ce8\u610f\u8fd9\u91cc\u4f7f\u7528\u7684 <code>apiVersion</code> \u662f <code>autoscaling/v2beta1</code>\uff0c\u7136\u540e <code>metrics</code> \u5c5e\u6027\u91cc\u9762\u6307\u5b9a\u7684\u662f\u5185\u5b58\u7684\u914d\u7f6e\uff0c\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f hpa-mem.yaml \nhorizontalpodautoscaler.autoscaling/nginx-hpa created\n$ kubectl get hpa\nNAME        REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nnginx-hpa   Deployment/hpa-mem-demo   2%/60%    1         5         1          12s\n</code></pre> <p>\u5230\u8fd9\u91cc\u8bc1\u660e HPA \u8d44\u6e90\u5bf9\u8c61\u5df2\u7ecf\u90e8\u7f72\u6210\u529f\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5bf9\u5e94\u7528\u8fdb\u884c\u538b\u6d4b\uff0c\u5c06\u5185\u5b58\u538b\u4e0a\u53bb\uff0c\u76f4\u63a5\u6267\u884c\u4e0a\u9762\u6211\u4eec\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u7684 <code>increase-mem.sh</code> \u811a\u672c\u5373\u53ef\uff1a</p> <pre><code>$ kubectl exec -it hpa-mem-demo-66944b79bf-tqrn9 /bin/bash\nroot@hpa-mem-demo-66944b79bf-tqrn9:/# ls /etc/script/\nincrease-mem.sh\nroot@hpa-mem-demo-66944b79bf-tqrn9:/# source /etc/script/increase-mem.sh \ndd: writing to '/tmp/memory/block': No space left on device\n81921+0 records in\n81920+0 records out\n41943040 bytes (42 MB, 40 MiB) copied, 584029 s, 8 MB/s\n</code></pre> <p>\u7136\u540e\u6253\u5f00\u53e6\u5916\u4e00\u4e2a\u7ec8\u7aef\u89c2\u5bdf HPA \u8d44\u6e90\u5bf9\u8c61\u7684\u53d8\u5316\u60c5\u51b5\uff1a</p> <pre><code>$ kubectl get hpa\nNAME        REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nnginx-hpa   Deployment/hpa-mem-demo   83%/60%   1         5         1          5m3s\n$ kubectl describe hpa nginx-hpa\nName:                                                     nginx-hpa\nNamespace:                                                default\nLabels:                                                   &lt;none&gt;\nAnnotations:                                              kubectl.kubernetes.io/last-applied-configuration:\n                                                            {\"apiVersion\":\"autoscaling/v2beta1\",\"kind\":\"HorizontalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-hpa\",\"namespace\":\"default\"...\nCreationTimestamp:                                        Tue, 07 Apr 2020 13:13:59 +0800\nReference:                                                Deployment/hpa-mem-demo\nMetrics:                                                  ( current / target )\n  resource memory on pods  (as a percentage of request):  3% (1740800) / 60%\nMin replicas:                                             1\nMax replicas:                                             5\nDeployment pods:                                          2 current / 2 desired\nConditions:\n  Type            Status  Reason               Message\n  ----            ------  ------               -------\n  AbleToScale     True    ScaleDownStabilized  recent recommendations were higher than current one, applying the highest recent recommendation\n  ScalingActive   True    ValidMetricFound     the HPA was able to successfully calculate a replica count from memory resource utilization (percentage of request)\n  ScalingLimited  False   DesiredWithinRange   the desired count is within the acceptable range\nEvents:\n  Type     Reason                        Age                    From                       Message\n  ----     ------                        ----                   ----                       -------\n  Warning  FailedGetResourceMetric       5m26s (x3 over 5m58s)  horizontal-pod-autoscaler  unable to get metrics for resource memory: no metrics returned from resource metrics API\n  Warning  FailedComputeMetricsReplicas  5m26s (x3 over 5m58s)  horizontal-pod-autoscaler  invalid metrics (1 invalid out of 1), first error is: failed to get memory utilization: unable to get metrics for resource memory: no metrics returned from resource metrics API\n  Normal   SuccessfulRescale             77s                    horizontal-pod-autoscaler  New size: 2; reason: memory resource utilization (percentage of request) above target\n$ kubectl top pod hpa-mem-demo-66944b79bf-tqrn9\nNAME                            CPU(cores)   MEMORY(bytes)\nhpa-mem-demo-66944b79bf-tqrn9   0m           41Mi\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5185\u5b58\u4f7f\u7528\u5df2\u7ecf\u8d85\u8fc7\u4e86\u6211\u4eec\u8bbe\u5b9a\u7684 60% \u8fd9\u4e2a\u9608\u503c\u4e86\uff0cHPA \u8d44\u6e90\u5bf9\u8c61\u4e5f\u5df2\u7ecf\u89e6\u53d1\u4e86\u81ea\u52a8\u6269\u5bb9\uff0c\u53d8\u6210\u4e86\u4e24\u4e2a\u526f\u672c\u4e86\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx\nNAME                            READY   STATUS    RESTARTS   AGE\nhpa-mem-demo-66944b79bf-8m4d9   1/1     Running   0          2m51s\nhpa-mem-demo-66944b79bf-tqrn9   1/1     Running   0          8m11s\n</code></pre> <p>\u5f53\u5185\u5b58\u91ca\u653e\u6389\u540e\uff0ccontroller-manager \u9ed8\u8ba45\u5206\u949f\u8fc7\u540e\u4f1a\u8fdb\u884c\u7f29\u653e\uff0c\u5230\u8fd9\u91cc\u5c31\u5b8c\u6210\u4e86\u57fa\u4e8e\u5185\u5b58\u7684 HPA \u64cd\u4f5c\u3002</p>"},{"location":"kubernetes_monitor/adapter/#_3","title":"\u81ea\u5b9a\u4e49\u6307\u6807","text":"<p>\u9664\u4e86\u57fa\u4e8e CPU \u548c\u5185\u5b58\u6765\u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u6839\u636e\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7\u6307\u6807\u6765\u8fdb\u884c\u3002\u8fd9\u4e2a\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528 <code>Prometheus Adapter</code>\uff0cPrometheus \u7528\u4e8e\u76d1\u63a7\u5e94\u7528\u7684\u8d1f\u8f7d\u548c\u96c6\u7fa4\u672c\u8eab\u7684\u5404\u79cd\u6307\u6807\uff0c<code>Prometheus Adapter</code> \u53ef\u4ee5\u5e2e\u6211\u4eec\u4f7f\u7528 Prometheus \u6536\u96c6\u7684\u6307\u6807\u5e76\u4f7f\u7528\u5b83\u4eec\u6765\u5236\u5b9a\u6269\u5c55\u7b56\u7565\uff0c\u8fd9\u4e9b\u6307\u6807\u90fd\u662f\u901a\u8fc7 APIServer \u66b4\u9732\u7684\uff0c\u800c\u4e14 HPA \u8d44\u6e90\u5bf9\u8c61\u4e5f\u53ef\u4ee5\u5f88\u8f7b\u6613\u7684\u76f4\u63a5\u4f7f\u7528\u3002</p> <p></p> <p>\u9996\u5148\uff0c\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a\u793a\u4f8b\u5e94\u7528\uff0c\u5728\u8be5\u5e94\u7528\u7a0b\u5e8f\u4e0a\u6d4b\u8bd5 Prometheus \u6307\u6807\u81ea\u52a8\u7f29\u653e\uff0c\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a\uff08hpa-prome-demo.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hpa-prom-demo\nspec:\n  selector:\n    matchLabels:\n      app: nginx-server\n  template:\n    metadata:\n      labels:\n        app: nginx-server\n    spec:\n      containers:\n      - name: nginx-demo\n        image: cnych/nginx-vts:v0\n        resources:\n          limits:\n            cpu: 50m\n          requests:\n            cpu: 50m\n        ports:\n        - containerPort: 80\n          name: http\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: hpa-prom-demo\n  annotations:\n    prometheus.io/scrape: \"true\"\n    prometheus.io/port: \"80\"\n    prometheus.io/path: \"/status/format/prometheus\"\nspec:\n  ports:\n  - port: 80\n    targetPort: 80\n    name: http\n  selector:\n    app: nginx-server\n  type: NodePort\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u90e8\u7f72\u7684\u5e94\u7528\u662f\u5728 80 \u7aef\u53e3\u7684 </p> <pre><code>/status/format/prometheus\n</code></pre> <p>\u8fd9\u4e2a\u7aef\u70b9\u66b4\u9732 nginx-vts \u6307\u6807\u7684\uff0c\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u5728 Prometheus \u4e2d\u914d\u7f6e\u4e86 Endpoints \u7684\u81ea\u52a8\u53d1\u73b0\uff0c\u6240\u4ee5\u6211\u4eec\u76f4\u63a5\u5728 Service \u5bf9\u8c61\u7684 <code>annotations</code> \u4e2d\u8fdb\u884c\u914d\u7f6e\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 Prometheus \u4e2d\u91c7\u96c6\u8be5\u6307\u6807\u6570\u636e\u4e86\u3002\u4e3a\u4e86\u6d4b\u8bd5\u65b9\u4fbf\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 NodePort \u7c7b\u578b\u7684 Service\uff0c\u73b0\u5728\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f hpa-prome-demo.yaml\ndeployment.apps/hpa-prom-demo created\nservice/hpa-prom-demo created\n$ kubectl get pods -l app=nginx-server \nNAME                             READY   STATUS    RESTARTS   AGE\nhpa-prom-demo-755bb56f85-lvksr   1/1     Running   0          4m52s\n$ kubectl get svc \nNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\nhpa-prom-demo   NodePort    12158   &lt;none&gt;        80:32408/TCP   5m44s\n......\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u6d4b\u8bd5\u5e94\u7528\u662f\u5426\u6b63\u5e38\uff0c\u4ee5\u53ca\u6307\u6807\u6570\u636e\u63a5\u53e3\u80fd\u591f\u6b63\u5e38\u83b7\u53d6\uff1a</p> <pre><code>$ curl http://k8s.qikqiak.com:32408\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n$ curl http://k8s.qikqiak.com:32408/status/format/prometheus \n# HELP nginx_vts_info Nginx info\n# TYPE nginx_vts_info gauge\nnginx_vts_info{hostname=\"hpa-prom-demo-755bb56f85-lvksr\",version=\"12\"} 1\n# HELP nginx_vts_start_time_seconds Nginx start time\n# TYPE nginx_vts_start_time_seconds gauge\nnginx_vts_start_time_seconds 15862400623\n# HELP nginx_vts_main_connections Nginx connections\n# TYPE nginx_vts_main_connections gauge\nnginx_vts_main_connections{status=\"accepted\"} 5\nnginx_vts_main_connections{status=\"active\"} 3\nnginx_vts_main_connections{status=\"handled\"} 5\nnginx_vts_main_connections{status=\"reading\"} 0\nnginx_vts_main_connections{status=\"requests\"} 33\nnginx_vts_main_connections{status=\"waiting\"} 2\nnginx_vts_main_connections{status=\"writing\"} 1\n# HELP nginx_vts_main_shm_usage_bytes Shared memory [ngx_http_vhost_traffic_status] info\n# TYPE nginx_vts_main_shm_usage_bytes gauge\nnginx_vts_main_shm_usage_bytes{shared=\"max_size\"} 1048575\nnginx_vts_main_shm_usage_bytes{shared=\"used_size\"} 3510\nnginx_vts_main_shm_usage_bytes{shared=\"used_node\"} 1\n# HELP nginx_vts_server_bytes_total The request/response bytes\n# TYPE nginx_vts_server_bytes_total counter\n# HELP nginx_vts_server_requests_total The requests counter\n# TYPE nginx_vts_server_requests_total counter\n# HELP nginx_vts_server_request_seconds_total The request processing time in seconds\n# TYPE nginx_vts_server_request_seconds_total counter\n# HELP nginx_vts_server_request_seconds The average of request processing times in seconds\n# TYPE nginx_vts_server_request_seconds gauge\n# HELP nginx_vts_server_request_duration_seconds The histogram of request processing time\n# TYPE nginx_vts_server_request_duration_seconds histogram\n# HELP nginx_vts_server_cache_total The requests cache counter\n# TYPE nginx_vts_server_cache_total counter\nnginx_vts_server_bytes_total{host=\"_\",direction=\"in\"} 8025\nnginx_vts_server_bytes_total{host=\"_\",direction=\"out\"} 121608\nnginx_vts_server_requests_total{host=\"_\",code=\"1xx\"} 0\nnginx_vts_server_requests_total{host=\"_\",code=\"2xx\"} 32\nnginx_vts_server_requests_total{host=\"_\",code=\"3xx\"} 0\nnginx_vts_server_requests_total{host=\"_\",code=\"4xx\"} 0\nnginx_vts_server_requests_total{host=\"_\",code=\"5xx\"} 0\nnginx_vts_server_requests_total{host=\"_\",code=\"total\"} 32\nnginx_vts_server_request_seconds_total{host=\"_\"} 000\nnginx_vts_server_request_seconds{host=\"_\"} 000\nnginx_vts_server_cache_total{host=\"_\",status=\"miss\"} 0\nnginx_vts_server_cache_total{host=\"_\",status=\"bypass\"} 0\nnginx_vts_server_cache_total{host=\"_\",status=\"expired\"} 0\nnginx_vts_server_cache_total{host=\"_\",status=\"stale\"} 0\nnginx_vts_server_cache_total{host=\"_\",status=\"updating\"} 0\nnginx_vts_server_cache_total{host=\"_\",status=\"revalidated\"} 0\nnginx_vts_server_cache_total{host=\"_\",status=\"hit\"} 0\nnginx_vts_server_cache_total{host=\"_\",status=\"scarce\"} 0\nnginx_vts_server_bytes_total{host=\"*\",direction=\"in\"} 8025\nnginx_vts_server_bytes_total{host=\"*\",direction=\"out\"} 121608\nnginx_vts_server_requests_total{host=\"*\",code=\"1xx\"} 0\nnginx_vts_server_requests_total{host=\"*\",code=\"2xx\"} 32\nnginx_vts_server_requests_total{host=\"*\",code=\"3xx\"} 0\nnginx_vts_server_requests_total{host=\"*\",code=\"4xx\"} 0\nnginx_vts_server_requests_total{host=\"*\",code=\"5xx\"} 0\nnginx_vts_server_requests_total{host=\"*\",code=\"total\"} 32\nnginx_vts_server_request_seconds_total{host=\"*\"} 000\nnginx_vts_server_request_seconds{host=\"*\"} 000\nnginx_vts_server_cache_total{host=\"*\",status=\"miss\"} 0\nnginx_vts_server_cache_total{host=\"*\",status=\"bypass\"} 0\nnginx_vts_server_cache_total{host=\"*\",status=\"expired\"} 0\nnginx_vts_server_cache_total{host=\"*\",status=\"stale\"} 0\nnginx_vts_server_cache_total{host=\"*\",status=\"updating\"} 0\nnginx_vts_server_cache_total{host=\"*\",status=\"revalidated\"} 0\nnginx_vts_server_cache_total{host=\"*\",status=\"hit\"} 0\nnginx_vts_server_cache_total{host=\"*\",status=\"scarce\"} 0\n</code></pre> <p>\u4e0a\u9762\u7684\u6307\u6807\u6570\u636e\u4e2d\uff0c\u6211\u4eec\u6bd4\u8f83\u5173\u5fc3\u7684\u662f </p> <pre><code>nginx_vts_server_requests_total\n</code></pre> <p>\u8fd9\u4e2a\u6307\u6807\uff0c\u8868\u793a\u8bf7\u6c42\u603b\u6570\uff0c\u662f\u4e00\u4e2a <code>Counter</code> \u7c7b\u578b\u7684\u6307\u6807\uff0c\u6211\u4eec\u5c06\u4f7f\u7528\u8be5\u6307\u6807\u7684\u503c\u6765\u786e\u5b9a\u662f\u5426\u9700\u8981\u5bf9\u6211\u4eec\u7684\u5e94\u7528\u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\u3002</p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06 Prometheus-Adapter \u5b89\u88c5\u5230\u96c6\u7fa4\u4e2d\uff0c\u5e76\u6dfb\u52a0\u4e00\u4e2a\u89c4\u5219\u6765\u8ddf\u8e2a Pod \u7684\u8bf7\u6c42\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06 Prometheus \u4e2d\u7684\u4efb\u4f55\u4e00\u4e2a\u6307\u6807\u90fd\u7528\u4e8e HPA\uff0c\u4f46\u662f\u524d\u63d0\u662f\u4f60\u5f97\u901a\u8fc7\u67e5\u8be2\u8bed\u53e5\u5c06\u5b83\u62ff\u5230\uff08\u5305\u62ec\u6307\u6807\u540d\u79f0\u548c\u5176\u5bf9\u5e94\u7684\u503c\uff09\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u89c4\u5219\uff1a</p> <pre><code>rules:\n- seriesQuery: 'nginx_vts_server_requests_total'\n  seriesFilters: []\n  resources:\n    overrides:\n      kubernetes_namespace:\n        resource: namespace\n      kubernetes_pod_name:\n        resource: pod\n  name:\n    matches: \"^(.*)_total\"\n    as: \"${1}_per_second\"\n  metricsQuery: (sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}[1m])) by (&lt;&lt;.GroupBy&gt;&gt;))\n</code></pre> <p>\u8fd9\u662f\u4e00\u4e2a\u5e26\u53c2\u6570\u7684 Prometheus \u67e5\u8be2\uff0c\u5176\u4e2d\uff1a</p> <ul> <li><code>seriesQuery</code>\uff1a\u67e5\u8be2 Prometheus \u7684\u8bed\u53e5\uff0c\u901a\u8fc7\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u67e5\u8be2\u5230\u7684\u6240\u6709\u6307\u6807\u90fd\u53ef\u4ee5\u7528\u4e8e HPA</li> <li><code>seriesFilters</code>\uff1a\u67e5\u8be2\u5230\u7684\u6307\u6807\u53ef\u80fd\u4f1a\u5b58\u5728\u4e0d\u9700\u8981\u7684\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b83\u8fc7\u6ee4\u6389\u3002</li> <li> <p><code>resources</code>\uff1a\u901a\u8fc7 <code>seriesQuery</code> \u67e5\u8be2\u5230\u7684\u53ea\u662f\u6307\u6807\uff0c\u5982\u679c\u9700\u8981\u67e5\u8be2\u67d0\u4e2a Pod \u7684\u6307\u6807\uff0c\u80af\u5b9a\u8981\u5c06\u5b83\u7684\u540d\u79f0\u548c\u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u4f5c\u4e3a\u6307\u6807\u7684\u6807\u7b7e\u8fdb\u884c\u67e5\u8be2\uff0c<code>resources</code> \u5c31\u662f\u5c06\u6307\u6807\u7684\u6807\u7b7e\u548c k8s \u7684\u8d44\u6e90\u7c7b\u578b\u5173\u8054\u8d77\u6765\uff0c\u6700\u5e38\u7528\u7684\u5c31\u662f pod \u548c namespace\u3002\u6709\u4e24\u79cd\u6dfb\u52a0\u6807\u7b7e\u7684\u65b9\u5f0f\uff0c\u4e00\u79cd\u662f <code>overrides</code>\uff0c\u53e6\u4e00\u79cd\u662f <code>template</code>\u3002</p> <ul> <li> <p><code>overrides</code>\uff1a\u5b83\u4f1a\u5c06\u6307\u6807\u4e2d\u7684\u6807\u7b7e\u548c k8s \u8d44\u6e90\u5173\u8054\u8d77\u6765\u3002\u4e0a\u9762\u793a\u4f8b\u4e2d\u5c31\u662f\u5c06\u6307\u6807\u4e2d\u7684 pod \u548c namespace \u6807\u7b7e\u548c k8s \u4e2d\u7684 pod \u548c namespace \u5173\u8054\u8d77\u6765\uff0c\u56e0\u4e3a pod \u548c namespace \u90fd\u5c5e\u4e8e\u6838\u5fc3 api \u7ec4\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u6307\u5b9a api \u7ec4\u3002\u5f53\u6211\u4eec\u67e5\u8be2\u67d0\u4e2a pod \u7684\u6307\u6807\u65f6\uff0c\u5b83\u4f1a\u81ea\u52a8\u5c06 pod \u7684\u540d\u79f0\u548c\u540d\u79f0\u7a7a\u95f4\u4f5c\u4e3a\u6807\u7b7e\u52a0\u5165\u5230\u67e5\u8be2\u6761\u4ef6\u4e2d\u3002\u6bd4\u5982 </p> <pre><code>nginx: {group: \"apps\", resource: \"deployment\"}\n</code></pre> <p>\u8fd9\u4e48\u5199\u8868\u793a\u7684\u5c31\u662f\u5c06\u6307\u6807\u4e2d nginx \u8fd9\u4e2a\u6807\u7b7e\u548c apps \u8fd9\u4e2a api \u7ec4\u4e2d\u7684 <code>deployment</code> \u8d44\u6e90\u5173\u8054\u8d77\u6765\uff1b     *   template\uff1a\u901a\u8fc7 go \u6a21\u677f\u7684\u5f62\u5f0f\u3002\u6bd4\u5982</p> <pre><code>template: \"kube_&lt;&lt;.Group&gt;&gt;_&lt;&lt;.Resource&gt;&gt;\"\n</code></pre> <p>\u8fd9\u4e48\u5199\u8868\u793a\uff0c\u5047\u5982 <code>&lt;&lt;.Group&gt;&gt;</code> \u4e3a apps\uff0c<code>&lt;&lt;.Resource&gt;&gt;</code> \u4e3a deployment\uff0c\u90a3\u4e48\u5b83\u5c31\u662f\u5c06\u6307\u6807\u4e2d <code>kube_apps_deployment</code> \u6807\u7b7e\u548c deployment \u8d44\u6e90\u5173\u8054\u8d77\u6765\u3002 *   &gt; <code>name</code>\uff1a\u7528\u6765\u7ed9\u6307\u6807\u91cd\u547d\u540d\u7684\uff0c\u4e4b\u6240\u4ee5\u8981\u7ed9\u6307\u6807\u91cd\u547d\u540d\u662f\u56e0\u4e3a\u6709\u4e9b\u6307\u6807\u662f\u53ea\u589e\u7684\uff0c\u6bd4\u5982\u4ee5 total \u7ed3\u5c3e\u7684\u6307\u6807\u3002\u8fd9\u4e9b\u6307\u6807\u62ff\u6765\u505a HPA \u662f\u6ca1\u6709\u610f\u4e49\u7684\uff0c\u6211\u4eec\u4e00\u822c\u8ba1\u7b97\u5b83\u7684\u901f\u7387\uff0c\u4ee5\u901f\u7387\u4f5c\u4e3a\u503c\uff0c\u90a3\u4e48\u6b64\u65f6\u7684\u540d\u79f0\u5c31\u4e0d\u80fd\u4ee5 total \u7ed3\u5c3e\u4e86\uff0c\u6240\u4ee5\u8981\u8fdb\u884c\u91cd\u547d\u540d\u3002</p> </li> <li> <p><code>matches</code>\uff1a\u901a\u8fc7\u6b63\u5219\u8868\u8fbe\u5f0f\u6765\u5339\u914d\u6307\u6807\u540d\uff0c\u53ef\u4ee5\u8fdb\u884c\u5206\u7ec4</p> </li> <li><code>as</code>\uff1a\u9ed8\u8ba4\u503c\u4e3a <code>$1</code>\uff0c\u4e5f\u5c31\u662f\u7b2c\u4e00\u4e2a\u5206\u7ec4\u3002<code>as</code> \u4e3a\u7a7a\u5c31\u662f\u4f7f\u7528\u9ed8\u8ba4\u503c\u7684\u610f\u601d\u3002</li> <li> <p><code>metricsQuery</code>\uff1a\u8fd9\u5c31\u662f Prometheus \u7684\u67e5\u8be2\u8bed\u53e5\u4e86\uff0c\u524d\u9762\u7684 <code>seriesQuery</code> \u67e5\u8be2\u662f\u83b7\u5f97 HPA \u6307\u6807\u3002\u5f53\u6211\u4eec\u8981\u67e5\u67d0\u4e2a\u6307\u6807\u7684\u503c\u65f6\u5c31\u8981\u901a\u8fc7\u5b83\u6307\u5b9a\u7684\u67e5\u8be2\u8bed\u53e5\u8fdb\u884c\u4e86\u3002\u53ef\u4ee5\u770b\u5230\u67e5\u8be2\u8bed\u53e5\u4f7f\u7528\u4e86\u901f\u7387\u548c\u5206\u7ec4\uff0c\u8fd9\u5c31\u662f\u89e3\u51b3\u4e0a\u9762\u63d0\u5230\u7684\u53ea\u589e\u6307\u6807\u7684\u95ee\u9898\u3002</p> </li> <li> <p><code>Series</code>\uff1a\u8868\u793a\u6307\u6807\u540d\u79f0</p> </li> <li><code>LabelMatchers</code>\uff1a\u9644\u52a0\u7684\u6807\u7b7e\uff0c\u76ee\u524d\u53ea\u6709 <code>pod</code> \u548c <code>namespace</code> \u4e24\u79cd\uff0c\u56e0\u6b64\u6211\u4eec\u8981\u5728\u4e4b\u524d\u4f7f\u7528 <code>resources</code> \u8fdb\u884c\u5173\u8054</li> <li><code>GroupBy</code>\uff1a\u5c31\u662f pod \u540d\u79f0\uff0c\u540c\u6837\u9700\u8981\u4f7f\u7528 <code>resources</code> \u8fdb\u884c\u5173\u8054\u3002</li> </ul> </li> </ul> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u901a\u8fc7 Helm Chart \u6765\u90e8\u7f72 Prometheus Adapter\uff0c\u65b0\u5efa </p> <pre><code>hpa-prome-adapter-values.yaml\n</code></pre> <p>\u6587\u4ef6\u8986\u76d6\u9ed8\u8ba4\u7684 Values \u503c\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>rules:\n  default: false\n  custom:\n  - seriesQuery: 'nginx_vts_server_requests_total'\n    resources: \n      overrides:\n        kubernetes_namespace:\n          resource: namespace\n        kubernetes_pod_name:\n          resource: pod\n    name:\n      matches: \"^(.*)_total\"\n      as: \"${1}_per_second\"\n    metricsQuery: (sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}[1m])) by (&lt;&lt;.GroupBy&gt;&gt;))\n\nprometheus:\n  url: http://thanos-querier.kube-mon.svc.cluster.local\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u6761 rules \u89c4\u5219\uff0c\u7136\u540e\u6307\u5b9a\u4e86 Prometheus \u7684\u5730\u5740\uff0c\u6211\u4eec\u8fd9\u91cc\u662f\u4f7f\u7528\u4e86 Thanos \u90e8\u7f72\u7684 Promethues \u96c6\u7fa4\uff0c\u6240\u4ee5\u7528 Querier \u7684\u5730\u5740\u3002\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e00\u952e\u5b89\u88c5\uff1a</p> <pre><code>$ helm install prometheus-adapter stable/prometheus-adapter -n kube-mon -f hpa-prome-adapter-values.yaml\nNAME: prometheus-adapter\nLAST DEPLOYED: Tue Apr  7 15:26:36 2020\nNAMESPACE: kube-mon\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nprometheus-adapter has been deployed.\nIn a few minutes you should be able to list metrics using the following command(s):\n\n  kubectl get --raw /apis/custom.metrics.k8s.io/v1beta1\n</code></pre> <p>\u7b49\u4e00\u5c0f\u4f1a\u513f\uff0c\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u68c0\u6d4b\u662f\u5426\u751f\u6548\u4e86\uff1a</p> <pre><code>$ kubectl get pods -n kube-mon -l app=prometheus-adapter\nNAME                                  READY   STATUS    RESTARTS   AGE\nprometheus-adapter-58b559fc7d-l2j6t   1/1     Running   0          3m21s\n$  kubectl get --raw=\"/apis/custom.metrics.k8s.io/v1beta1\" | jq\n{\n  \"kind\": \"APIResourceList\",\n  \"apiVersion\": \"v1\",\n  \"groupVersion\": \"custom.metrics.k8s.io/v1beta1\",\n  \"resources\": [\n    {\n      \"name\": \"namespaces/nginx_vts_server_requests_per_second\",\n      \"singularName\": \"\",\n      \"namespaced\": false,\n      \"kind\": \"MetricValueList\",\n      \"verbs\": [\n        \"get\"\n      ]\n    },\n    {\n      \"name\": \"pods/nginx_vts_server_requests_per_second\",\n      \"singularName\": \"\",\n      \"namespaced\": true,\n      \"kind\": \"MetricValueList\",\n      \"verbs\": [\n        \"get\"\n      ]\n    }\n  ]\n}\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 </p> <pre><code>nginx_vts_server_requests_per_second\n</code></pre> <p>\u6307\u6807\u53ef\u7528\u3002 \u73b0\u5728\uff0c\u8ba9\u6211\u4eec\u68c0\u67e5\u8be5\u6307\u6807\u7684\u5f53\u524d\u503c\uff1a</p> <pre><code>$ kubectl get --raw \"/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/nginx_vts_server_requests_per_second\" | jq .\n{\n  \"kind\": \"MetricValueList\",\n  \"apiVersion\": \"custom.metrics.k8s.io/v1beta1\",\n  \"metadata\": {\n    \"selfLink\": \"/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/%2A/nginx_vts_server_requests_per_second\"\n  },\n  \"items\": [\n    {\n      \"describedObject\": {\n        \"kind\": \"Pod\",\n        \"namespace\": \"default\",\n        \"name\": \"hpa-prom-demo-755bb56f85-lvksr\",\n        \"apiVersion\": \"/v1\"\n      },\n      \"metricName\": \"nginx_vts_server_requests_per_second\",\n      \"timestamp\": \"2020-04-07T09:45:45Z\",\n      \"value\": \"527m\",\n      \"selector\": null\n    }\n  ]\n}\n</code></pre> <p>\u51fa\u73b0\u7c7b\u4f3c\u4e0a\u9762\u7684\u4fe1\u606f\u5c31\u8868\u660e\u5df2\u7ecf\u914d\u7f6e\u6210\u529f\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a\u9488\u5bf9\u4e0a\u9762\u7684\u81ea\u5b9a\u4e49\u6307\u6807\u7684 HAP \u8d44\u6e90\u5bf9\u8c61\uff0c\u5982\u4e0b\u6240\u793a\uff1a(hpa-prome.yaml)</p> <pre><code>apiVersion: autoscaling/v2beta1\nkind: HorizontalPodAutoscaler\nmetadata:\n  name: nginx-custom-hpa\nspec:\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: hpa-prom-demo\n  minReplicas: 2\n  maxReplicas: 5\n  metrics:\n  - type: Pods\n    pods:\n      metricName: nginx_vts_server_requests_per_second\n      targetAverageValue: 10\n</code></pre> <p>\u5982\u679c\u8bf7\u6c42\u6570\u8d85\u8fc7\u6bcf\u79d210\u4e2a\uff0c\u5219\u5c06\u5bf9\u5e94\u7528\u8fdb\u884c\u6269\u5bb9\u3002\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f hpa-prome.yaml\nhorizontalpodautoscaler.autoscaling/nginx-custom-hpa created\n$ kubectl describe hpa nginx-custom-hpa\nName:                                              nginx-custom-hpa\nNamespace:                                         default\nLabels:                                            &lt;none&gt;\nAnnotations:                                       kubectl.kubernetes.io/last-applied-configuration:\n                                                     {\"apiVersion\":\"autoscaling/v2beta1\",\"kind\":\"HorizontalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-custom-hpa\",\"namespace\":\"d...\nCreationTimestamp:                                 Tue, 07 Apr 2020 17:54:55 +0800\nReference:                                         Deployment/hpa-prom-demo\nMetrics:                                           ( current / target )\n  \"nginx_vts_server_requests_per_second\" on pods:  &lt;unknown&gt; / 10\nMin replicas:                                      2\nMax replicas:                                      5\nDeployment pods:                                   1 current / 2 desired\nConditions:\n  Type         Status  Reason            Message\n  ----         ------  ------            -------\n  AbleToScale  True    SucceededRescale  the HPA controller was able to update the target scale to 2\nEvents:\n  Type    Reason             Age   From                       Message\n  ----    ------             ----  ----                       -------\n  Normal  SuccessfulRescale  7s    horizontal-pod-autoscaler  New size: 2; reason: Current number of replicas below Spec.MinReplicas\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 HPA \u5bf9\u8c61\u5df2\u7ecf\u751f\u6548\u4e86\uff0c\u4f1a\u5e94\u7528\u6700\u5c0f\u7684\u526f\u672c\u65702\uff0c\u6240\u4ee5\u4f1a\u65b0\u589e\u4e00\u4e2a Pod \u526f\u672c\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx-server\nNAME                             READY   STATUS    RESTARTS   AGE\nhpa-prom-demo-755bb56f85-s5dzf   1/1     Running   0          67s\nhpa-prom-demo-755bb56f85-wbpfr   1/1     Running   0          3m30s\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u540c\u6837\u5bf9\u5e94\u7528\u8fdb\u884c\u538b\u6d4b\uff1a</p> <pre><code>$ while true; do wget -q -O- http://k8s.qikqiak.com:32408; done\n</code></pre> <p>\u6253\u5f00\u53e6\u5916\u4e00\u4e2a\u7ec8\u7aef\u89c2\u5bdf HPA \u5bf9\u8c61\u7684\u53d8\u5316\uff1a</p> <pre><code>$ kubectl get hpa\nNAME               REFERENCE                  TARGETS     MINPODS   MAXPODS   REPLICAS   AGE\nnginx-custom-hpa   Deployment/hpa-prom-demo   14239m/10   2         5         2          4m27s\n$ kubectl describe hpa nginx-custom-hpa\nName:                                              nginx-custom-hpa\nNamespace:                                         default\nLabels:                                            &lt;none&gt;\nAnnotations:                                       kubectl.kubernetes.io/last-applied-configuration:\n                                                     {\"apiVersion\":\"autoscaling/v2beta1\",\"kind\":\"HorizontalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-custom-hpa\",\"namespace\":\"d...\nCreationTimestamp:                                 Tue, 07 Apr 2020 17:54:55 +0800\nReference:                                         Deployment/hpa-prom-demo\nMetrics:                                           ( current / target )\n  \"nginx_vts_server_requests_per_second\" on pods:  14308m / 10\nMin replicas:                                      2\nMax replicas:                                      5\nDeployment pods:                                   3 current / 3 desired\nConditions:\n  Type            Status  Reason              Message\n  ----            ------  ------              -------\n  AbleToScale     True    ReadyForNewScale    recommended size matches current size\n  ScalingActive   True    ValidMetricFound    the HPA was able to successfully calculate a replica count from pods metric nginx_vts_server_requests_per_second\n  ScalingLimited  False   DesiredWithinRange  the desired count is within the acceptable range\nEvents:\n  Type    Reason             Age   From                       Message\n  ----    ------             ----  ----                       -------\n  Normal  SuccessfulRescale  5m2s  horizontal-pod-autoscaler  New size: 2; reason: Current number of replicas below Spec.MinReplicas\n  Normal  SuccessfulRescale  61s   horizontal-pod-autoscaler  New size: 3; reason: pods metric nginx_vts_server_requests_per_second above target\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6307\u6807 </p> <pre><code>nginx_vts_server_requests_per_second\n</code></pre> <p>\u7684\u6570\u636e\u5df2\u7ecf\u8d85\u8fc7\u9608\u503c\u4e86\uff0c\u89e6\u53d1\u6269\u5bb9\u52a8\u4f5c\u4e86\uff0c\u526f\u672c\u6570\u53d8\u6210\u4e863\uff0c\u4f46\u662f\u540e\u7eed\u5f88\u96be\u7ee7\u7eed\u6269\u5bb9\u4e86\uff0c\u8fd9\u662f\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u7684 <code>while</code> \u547d\u4ee4\u5e76\u4e0d\u591f\u5feb\uff0c3\u4e2a\u526f\u672c\u5b8c\u5168\u53ef\u4ee5\u6ee1\u8db3\u6bcf\u79d2\u4e0d\u8d85\u8fc7 10 \u4e2a\u8bf7\u6c42\u7684\u9608\u503c\u3002</p> <p></p> <p>\u5982\u679c\u9700\u8981\u66f4\u597d\u7684\u8fdb\u884c\u6d4b\u8bd5\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e9b\u538b\u6d4b\u5de5\u5177\uff0c\u6bd4\u5982 ab\u3001fortio \u7b49\u5de5\u5177\u3002\u5f53\u6211\u4eec\u4e2d\u65ad\u6d4b\u8bd5\u540e\uff0c\u9ed8\u8ba45\u5206\u949f\u8fc7\u540e\u5c31\u4f1a\u81ea\u52a8\u7f29\u5bb9\uff1a</p> <pre><code>$ kubectl describe hpa nginx-custom-hpa\nName:                                              nginx-custom-hpa\nNamespace:                                         default\nLabels:                                            &lt;none&gt;\nAnnotations:                                       kubectl.kubernetes.io/last-applied-configuration:\n                                                     {\"apiVersion\":\"autoscaling/v2beta1\",\"kind\":\"HorizontalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-custom-hpa\",\"namespace\":\"d...\nCreationTimestamp:                                 Tue, 07 Apr 2020 17:54:55 +0800\nReference:                                         Deployment/hpa-prom-demo\nMetrics:                                           ( current / target )\n  \"nginx_vts_server_requests_per_second\" on pods:  533m / 10\nMin replicas:                                      2\nMax replicas:                                      5\nDeployment pods:                                   2 current / 2 desired\nConditions:\n  Type            Status  Reason            Message\n  ----            ------  ------            -------\n  AbleToScale     True    ReadyForNewScale  recommended size matches current size\n  ScalingActive   True    ValidMetricFound  the HPA was able to successfully calculate a replica count from pods metric nginx_vts_server_requests_per_second\n  ScalingLimited  True    TooFewReplicas    the desired replica count is less than the minimum replica count\nEvents:\n  Type    Reason             Age   From                       Message\n  ----    ------             ----  ----                       -------\n  Normal  SuccessfulRescale  23m   horizontal-pod-autoscaler  New size: 2; reason: Current number of replicas below Spec.MinReplicas\n  Normal  SuccessfulRescale  19m   horizontal-pod-autoscaler  New size: 3; reason: pods metric nginx_vts_server_requests_per_second above target\n  Normal  SuccessfulRescale  4m2s  horizontal-pod-autoscaler  New size: 2; reason: All metrics below target\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u6307\u6807\u5bf9\u5e94\u7528\u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\u7684\u64cd\u4f5c\u3002\u5982\u679c Prometheus \u5b89\u88c5\u5728\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\u4e4b\u5916\uff0c\u5219\u53ea\u9700\u8981\u786e\u4fdd\u53ef\u4ee5\u4ece\u96c6\u7fa4\u8bbf\u95ee\u5230\u67e5\u8be2\u7684\u7aef\u70b9\uff0c\u5e76\u5728 adapter \u7684\u90e8\u7f72\u6e05\u5355\u4e2d\u5bf9\u5176\u8fdb\u884c\u66f4\u65b0\u5373\u53ef\u3002\u5728\u66f4\u590d\u6742\u7684\u573a\u666f\u4e2d\uff0c\u53ef\u4ee5\u83b7\u53d6\u591a\u4e2a\u6307\u6807\u7ed3\u5408\u4f7f\u7528\u6765\u5236\u5b9a\u6269\u5c55\u7b56\u7565\u3002</p>"},{"location":"kubernetes_monitor/alertmanager/","title":"Alertmanager","text":""},{"location":"kubernetes_monitor/alertmanager/#alertmanager","title":"Alertmanager","text":"<p>\u524d\u9762\u6211\u4eec\u5b66\u4e60 Prometheus \u7684\u65f6\u5019\u4e86\u89e3\u5230 Prometheus \u5305\u542b\u4e00\u4e2a\u62a5\u8b66\u6a21\u5757\uff0c\u5c31\u662f\u6211\u4eec\u7684 <code>AlertManager</code>\uff0cAlertmanager \u4e3b\u8981\u7528\u4e8e\u63a5\u6536 Prometheus \u53d1\u9001\u7684\u544a\u8b66\u4fe1\u606f\uff0c\u5b83\u652f\u6301\u4e30\u5bcc\u7684\u544a\u8b66\u901a\u77e5\u6e20\u9053\uff0c\u800c\u4e14\u5f88\u5bb9\u6613\u505a\u5230\u544a\u8b66\u4fe1\u606f\u8fdb\u884c\u53bb\u91cd\uff0c\u964d\u566a\uff0c\u5206\u7ec4\u7b49\uff0c\u662f\u4e00\u6b3e\u524d\u536b\u7684\u544a\u8b66\u901a\u77e5\u7cfb\u7edf\u3002</p> <p>\u901a\u8fc7\u5728 Prometheus \u4e2d\u5b9a\u4e49\u544a\u8b66\u89c4\u5219\uff0cPrometheus\u4f1a\u5468\u671f\u6027\u7684\u5bf9\u544a\u8b66\u89c4\u5219\u8fdb\u884c\u8ba1\u7b97\uff0c\u5982\u679c\u6ee1\u8db3\u544a\u8b66\u89e6\u53d1\u6761\u4ef6\u5c31\u4f1a\u5411Alertmanager \u53d1\u9001\u544a\u8b66\u4fe1\u606f\u3002</p> <p></p> <p>\u5728 Prometheus \u4e2d\u4e00\u6761\u544a\u8b66\u89c4\u5219\u4e3b\u8981\u7531\u4ee5\u4e0b\u51e0\u90e8\u5206\u7ec4\u6210\uff1a</p> <ul> <li>\u544a\u8b66\u540d\u79f0\uff1a\u7528\u6237\u9700\u8981\u4e3a\u544a\u8b66\u89c4\u5219\u547d\u540d\uff0c\u5f53\u7136\u5bf9\u4e8e\u547d\u540d\u800c\u8a00\uff0c\u9700\u8981\u80fd\u591f\u76f4\u63a5\u8868\u8fbe\u51fa\u8be5\u544a\u8b66\u7684\u4e3b\u8981\u5185\u5bb9</li> <li>\u544a\u8b66\u89c4\u5219\uff1a\u544a\u8b66\u89c4\u5219\u5b9e\u9645\u4e0a\u4e3b\u8981\u7531 <code>PromQL</code> \u8fdb\u884c\u5b9a\u4e49\uff0c\u5176\u5b9e\u9645\u610f\u4e49\u662f\u5f53\u8868\u8fbe\u5f0f\uff08PromQL\uff09\u67e5\u8be2\u7ed3\u679c\u6301\u7eed\u591a\u957f\u65f6\u95f4\uff08During\uff09\u540e\u51fa\u53d1\u544a\u8b66</li> </ul> <p>\u5728 Prometheus \u4e2d\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7 Group\uff08\u544a\u8b66\u7ec4\uff09\u5bf9\u4e00\u7ec4\u76f8\u5173\u7684\u544a\u8b66\u8fdb\u884c\u7edf\u4e00\u5b9a\u4e49\u3002Alertmanager \u4f5c\u4e3a\u4e00\u4e2a\u72ec\u7acb\u7684\u7ec4\u4ef6\uff0c\u8d1f\u8d23\u63a5\u6536\u5e76\u5904\u7406\u6765\u81ea Prometheus Server \u7684\u544a\u8b66\u4fe1\u606f\u3002Alertmanager \u53ef\u4ee5\u5bf9\u8fd9\u4e9b\u544a\u8b66\u4fe1\u606f\u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u5904\u7406\uff0c\u6bd4\u5982\u5f53\u63a5\u6536\u5230\u5927\u91cf\u91cd\u590d\u544a\u8b66\u65f6\u80fd\u591f\u6d88\u9664\u91cd\u590d\u7684\u544a\u8b66\u4fe1\u606f\uff0c\u540c\u65f6\u5bf9\u544a\u8b66\u4fe1\u606f\u8fdb\u884c\u5206\u7ec4\u5e76\u4e14\u8def\u7531\u5230\u6b63\u786e\u7684\u901a\u77e5\u65b9\uff0cPrometheus \u5185\u7f6e\u4e86\u5bf9\u90ae\u4ef6\u3001Slack \u591a\u79cd\u901a\u77e5\u65b9\u5f0f\u7684\u652f\u6301\uff0c\u540c\u65f6\u8fd8\u652f\u6301\u4e0e Webhook \u7684\u96c6\u6210\uff0c\u4ee5\u652f\u6301\u66f4\u591a\u5b9a\u5236\u5316\u7684\u573a\u666f\u3002\u4f8b\u5982\uff0c\u76ee\u524d Alertmanager \u8fd8\u4e0d\u652f\u6301\u9489\u9489\uff0c\u7528\u6237\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7 Webhook \u4e0e\u9489\u9489\u673a\u5668\u4eba\u8fdb\u884c\u96c6\u6210\uff0c\u4ece\u800c\u901a\u8fc7\u9489\u9489\u63a5\u6536\u544a\u8b66\u4fe1\u606f\u3002\u540c\u65f6 AlertManager \u8fd8\u63d0\u4f9b\u4e86\u9759\u9ed8\u548c\u544a\u8b66\u6291\u5236\u673a\u5236\u6765\u5bf9\u544a\u8b66\u901a\u77e5\u884c\u4e3a\u8fdb\u884c\u4f18\u5316\u3002</p>"},{"location":"kubernetes_monitor/alertmanager/#_1","title":"\u5b89\u88c5","text":"<p>\u4ece\u5b98\u65b9\u6587\u6863 https://prometheus.io/docs/alerting/configuration/ \u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0b\u8f7d AlertManager \u4e8c\u8fdb\u5236\u6587\u4ef6\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u8fd0\u884c\uff1a</p> <pre><code>$ ./alertmanager --config.file=simple.yml\n</code></pre> <p>\u5176\u4e2d <code>-config.file</code> \u53c2\u6570\u662f\u7528\u6765\u6307\u5b9a\u5bf9\u5e94\u7684\u914d\u7f6e\u6587\u4ef6\u7684\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u540c\u6837\u8981\u8fd0\u884c\u5230 Kubernetes \u96c6\u7fa4\u4e2d\u6765\uff0c\u6240\u4ee5\u6211\u4eec\u4f7f\u7528 Docker \u955c\u50cf\u7684\u65b9\u5f0f\u6765\u5b89\u88c5\uff0c\u4f7f\u7528\u7684\u955c\u50cf\u662f\uff1a</p> <pre><code>prom/alertmanager:v0\n</code></pre> <p>\u3002</p> <p>\u9996\u5148\uff0c\u6307\u5b9a\u914d\u7f6e\u6587\u4ef6\uff0c\u540c\u6837\u7684\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e00\u4e2a ConfigMap \u8d44\u6e90\u5bf9\u8c61\uff1a(alertmanager-config.yaml)</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: alert-config\n  namespace: kube-mon\ndata:\n  config.yml: |-\n    global:\n      # \u5f53alertmanager\u6301\u7eed\u591a\u957f\u65f6\u95f4\u672a\u63a5\u6536\u5230\u544a\u8b66\u540e\u6807\u8bb0\u544a\u8b66\u72b6\u6001\u4e3a resolved\n      resolve_timeout: 5m\n      # \u914d\u7f6e\u90ae\u4ef6\u53d1\u9001\u4fe1\u606f\n      smtp_smarthost: 'smtp.1com:25'\n      smtp_from: 'ych_1024@1com'\n      smtp_auth_username: 'ych_1024@1com'\n      smtp_auth_password: '&lt;\u90ae\u7bb1\u5bc6\u7801&gt;'\n      smtp_hello: '1com'\n      smtp_require_tls: false\n    # \u6240\u6709\u62a5\u8b66\u4fe1\u606f\u8fdb\u5165\u540e\u7684\u6839\u8def\u7531\uff0c\u7528\u6765\u8bbe\u7f6e\u62a5\u8b66\u7684\u5206\u53d1\u7b56\u7565\n    route:\n      # \u8fd9\u91cc\u7684\u6807\u7b7e\u5217\u8868\u662f\u63a5\u6536\u5230\u62a5\u8b66\u4fe1\u606f\u540e\u7684\u91cd\u65b0\u5206\u7ec4\u6807\u7b7e\uff0c\u4f8b\u5982\uff0c\u63a5\u6536\u5230\u7684\u62a5\u8b66\u4fe1\u606f\u91cc\u9762\u6709\u8bb8\u591a\u5177\u6709 cluster=A \u548c alertname=LatncyHigh \u8fd9\u6837\u7684\u6807\u7b7e\u7684\u62a5\u8b66\u4fe1\u606f\u5c06\u4f1a\u6279\u91cf\u88ab\u805a\u5408\u5230\u4e00\u4e2a\u5206\u7ec4\u91cc\u9762\n      group_by: ['alertname', 'cluster']\n      # \u5f53\u4e00\u4e2a\u65b0\u7684\u62a5\u8b66\u5206\u7ec4\u88ab\u521b\u5efa\u540e\uff0c\u9700\u8981\u7b49\u5f85\u81f3\u5c11 group_wait \u65f6\u95f4\u6765\u521d\u59cb\u5316\u901a\u77e5\uff0c\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u786e\u4fdd\u60a8\u80fd\u6709\u8db3\u591f\u7684\u65f6\u95f4\u4e3a\u540c\u4e00\u5206\u7ec4\u6765\u83b7\u53d6\u591a\u4e2a\u8b66\u62a5\uff0c\u7136\u540e\u4e00\u8d77\u89e6\u53d1\u8fd9\u4e2a\u62a5\u8b66\u4fe1\u606f\u3002\n      group_wait: 30s\n\n      # \u76f8\u540c\u7684group\u4e4b\u95f4\u53d1\u9001\u544a\u8b66\u901a\u77e5\u7684\u65f6\u95f4\u95f4\u9694\n      group_interval: 30s\n\n      # \u5982\u679c\u4e00\u4e2a\u62a5\u8b66\u4fe1\u606f\u5df2\u7ecf\u53d1\u9001\u6210\u529f\u4e86\uff0c\u7b49\u5f85 repeat_interval \u65f6\u95f4\u6765\u91cd\u65b0\u53d1\u9001\u4ed6\u4eec\uff0c\u4e0d\u540c\u7c7b\u578b\u544a\u8b66\u53d1\u9001\u9891\u7387\u9700\u8981\u5177\u4f53\u914d\u7f6e\n      repeat_interval: 1h\n\n      # \u9ed8\u8ba4\u7684receiver\uff1a\u5982\u679c\u4e00\u4e2a\u62a5\u8b66\u6ca1\u6709\u88ab\u4e00\u4e2aroute\u5339\u914d\uff0c\u5219\u53d1\u9001\u7ed9\u9ed8\u8ba4\u7684\u63a5\u6536\u5668\n      receiver: default\n\n      # \u4e0a\u9762\u6240\u6709\u7684\u5c5e\u6027\u90fd\u7531\u6240\u6709\u5b50\u8def\u7531\u7ee7\u627f\uff0c\u5e76\u4e14\u53ef\u4ee5\u5728\u6bcf\u4e2a\u5b50\u8def\u7531\u4e0a\u8fdb\u884c\u8986\u76d6\u3002\n      routes:\n      - receiver: email\n        group_wait: 10s\n        match:\n          team: node\n    receivers:\n    - name: 'default'\n      email_configs:\n      - to: '517554016@qq.com'\n        send_resolved: true  # \u63a5\u53d7\u544a\u8b66\u6062\u590d\u7684\u901a\u77e5\n    - name: 'email'\n      email_configs:\n      - to: '517554016@qq.com'\n        send_resolved: true\n</code></pre> <p>\u5206\u7ec4</p> <p>\u5206\u7ec4\u673a\u5236\u53ef\u4ee5\u5c06\u8be6\u7ec6\u7684\u544a\u8b66\u4fe1\u606f\u5408\u5e76\u6210\u4e00\u4e2a\u901a\u77e5\uff0c\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6bd4\u5982\u7531\u4e8e\u7cfb\u7edf\u5b95\u673a\u5bfc\u81f4\u5927\u91cf\u7684\u544a\u8b66\u88ab\u540c\u65f6\u89e6\u53d1\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u5206\u7ec4\u673a\u5236\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u88ab\u89e6\u53d1\u7684\u544a\u8b66\u5408\u5e76\u4e3a\u4e00\u4e2a\u544a\u8b66\u901a\u77e5\uff0c\u907f\u514d\u4e00\u6b21\u6027\u63a5\u53d7\u5927\u91cf\u7684\u544a\u8b66\u901a\u77e5\uff0c\u800c\u65e0\u6cd5\u5bf9\u95ee\u9898\u8fdb\u884c\u5feb\u901f\u5b9a\u4f4d\u3002</p> <p>\u8fd9\u662f AlertManager \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u6211\u4eec\u5148\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a ConfigMap \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f alertmanager-config.yaml\nconfigmap/alert-config created\n</code></pre> <p>\u7136\u540e\u914d\u7f6e AlertManager \u7684\u5bb9\u5668\uff0c\u76f4\u63a5\u4f7f\u7528\u4e00\u4e2a Deployment \u6765\u8fdb\u884c\u7ba1\u7406\u5373\u53ef\uff0c\u5bf9\u5e94\u7684 YAML \u8d44\u6e90\u58f0\u660e\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: alertmanager\n  namespace: kube-mon\n  labels:\n    app: alertmanager\nspec:\n  selector:\n    matchLabels:\n      app: alertmanager\n  template:\n    metadata:\n      labels:\n        app: alertmanager\n    spec:\n      volumes:\n      - name: alertcfg\n        configMap:\n          name: alert-config\n      containers:\n      - name: alertmanager\n        image: prom/alertmanager:v0\n        imagePullPolicy: IfNotPresent\n        args:\n        - \"--config.file=/etc/alertmanager/config.yml\"\n        ports:\n        - containerPort: 9093\n          name: http\n        volumeMounts:\n        - mountPath: \"/etc/alertmanager\"\n          name: alertcfg\n        resources:\n          requests:\n            cpu: 100m\n            memory: 256Mi\n          limits:\n            cpu: 100m\n            memory: 256Mi\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5c06\u4e0a\u9762\u521b\u5efa\u7684 <code>alert-config</code> \u8fd9\u4e2a ConfigMap \u8d44\u6e90\u5bf9\u8c61\u4ee5 Volume \u7684\u5f62\u5f0f\u6302\u8f7d\u5230 <code>/etc/alertmanager</code> \u76ee\u5f55\u4e0b\u53bb\uff0c\u7136\u540e\u5728\u542f\u52a8\u53c2\u6570\u4e2d\u6307\u5b9a\u4e86\u914d\u7f6e\u6587\u4ef6 </p> <pre><code>--config.file=/etc/alertmanager/config.yml\n</code></pre> <p>\uff0c\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u6765\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f alertmanager-deploy.yaml\ndeployment.apps/alertmanager created\n</code></pre> <p>\u4e3a\u4e86\u53ef\u4ee5\u8bbf\u95ee\u5230 AlertManager\uff0c\u540c\u6837\u9700\u8981\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 Service \u5bf9\u8c61\uff1a(alertmanager-svc.yaml)</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: alertmanager\n  namespace: kube-mon\n  labels:\n    app: alertmanager\nspec:\n  selector:\n    app: alertmanager\n  type: NodePort\n  ports:\n    - name: web\n      port: 9093\n      targetPort: http\n</code></pre> <p>\u4f7f\u7528 NodePort \u7c7b\u578b\u4e5f\u662f\u4e3a\u4e86\u65b9\u4fbf\u6d4b\u8bd5\uff0c\u521b\u5efa\u4e0a\u9762\u7684 Service \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f alertmanager-svc.yaml\nservice/alertmanager created\n</code></pre> <p>AlertManager \u7684\u5bb9\u5668\u542f\u52a8\u8d77\u6765\u540e\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u5728 Prometheus \u4e2d\u914d\u7f6e\u4e0b AlertManager \u7684\u5730\u5740\uff0c\u8ba9 Prometheus \u80fd\u591f\u8bbf\u95ee\u5230 AlertManager\uff0c\u5728 Prometheus \u7684 ConfigMap \u8d44\u6e90\u6e05\u5355\u4e2d\u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>alerting:\n  alertmanagers:\n    - static_configs:\n      - targets: [\"alertmanager:9093\"]\n</code></pre> <p>\u66f4\u65b0\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u540e\uff0c\u7a0d\u7b49\u4e00\u5c0f\u4f1a\u513f\uff0c\u6267\u884c reload \u64cd\u4f5c\u5373\u53ef\u3002</p>"},{"location":"kubernetes_monitor/alertmanager/#_2","title":"\u62a5\u8b66\u89c4\u5219","text":"<p>\u73b0\u5728\u6211\u4eec\u53ea\u662f\u628a AlertManager \u5bb9\u5668\u8fd0\u884c\u8d77\u6765\u4e86\uff0c\u4e5f\u548c Prometheus \u8fdb\u884c\u4e86\u5173\u8054\uff0c\u4f46\u662f\u73b0\u5728\u6211\u4eec\u5e76\u4e0d\u77e5\u9053\u8981\u505a\u4ec0\u4e48\u62a5\u8b66\uff0c\u56e0\u4e3a\u6ca1\u6709\u4efb\u4f55\u5730\u65b9\u544a\u8bc9\u6211\u4eec\u8981\u62a5\u8b66\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u9700\u8981\u914d\u7f6e\u4e00\u4e9b\u62a5\u8b66\u89c4\u5219\u6765\u544a\u8bc9\u6211\u4eec\u5bf9\u54ea\u4e9b\u6570\u636e\u8fdb\u884c\u62a5\u8b66\u3002</p> <p>\u8b66\u62a5\u89c4\u5219\u5141\u8bb8\u4f60\u57fa\u4e8e Prometheus \u8868\u8fbe\u5f0f\u8bed\u8a00\u7684\u8868\u8fbe\u5f0f\u6765\u5b9a\u4e49\u62a5\u8b66\u62a5\u6761\u4ef6\uff0c\u5e76\u5728\u89e6\u53d1\u8b66\u62a5\u65f6\u53d1\u9001\u901a\u77e5\u7ed9\u5916\u90e8\u7684\u63a5\u6536\u8005\u3002</p> <p>\u540c\u6837\u5728 Prometheus \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u62a5\u8b66\u89c4\u5219\u914d\u7f6e\uff1a</p> <pre><code>rule_files:\n- /etc/prometheus/rules.yml\n</code></pre> <p>\u5176\u4e2d <code>rule_files</code> \u5c31\u662f\u7528\u6765\u6307\u5b9a\u62a5\u8b66\u89c4\u5219\u7684\uff0c\u8fd9\u91cc\u6211\u4eec\u540c\u6837\u5c06 <code>rules.yml</code> \u6587\u4ef6\u7528 ConfigMap \u7684\u5f62\u5f0f\u6302\u8f7d\u5230 <code>/etc/prometheus</code> \u76ee\u5f55\u4e0b\u9762\u5373\u53ef\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u89c4\u5219\uff1a\uff08alert-rules.yml\uff09</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n  namespace: kube-mon\ndata:\n  prometheus.yml: |\n    global:\n      scrape_interval: 15s\n      scrape_timeout: 15s\n      evaluation_interval: 30s  # \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6bcf\u5206\u949f\u5bf9\u544a\u8b66\u89c4\u5219\u8fdb\u884c\u8ba1\u7b97\n    alerting:\n      alertmanagers:\n      - static_configs:\n        - targets: [\"alertmanager:9093\"]\n    rule_files:\n    - /etc/prometheus/rules.yml\n  ...... # \u7701\u7565prometheus\u5176\u4ed6\u90e8\u5206\n  rules.yml: |\n    groups:\n    - name: test-node-mem\n      rules:\n      - alert: NodeMemoryUsage\n        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 20\n        for: 2m\n        labels:\n          team: node\n        annotations:\n          summary: \"{{$labels.instance}}: High Memory usage detected\"\n          description: \"{{$labels.instance}}: Memory usage is above 20% (current value is: {{ $value }}\"\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a <code>NodeMemoryUsage</code> \u7684\u62a5\u8b66\u89c4\u5219\uff0c\u4e00\u6761\u62a5\u8b66\u89c4\u5219\u4e3b\u8981\u7531\u4ee5\u4e0b\u51e0\u90e8\u5206\u7ec4\u6210\uff1a</p> <ul> <li><code>alert</code>\uff1a\u544a\u8b66\u89c4\u5219\u7684\u540d\u79f0</li> <li><code>expr</code>\uff1a\u662f\u7528\u4e8e\u8fdb\u884c\u62a5\u8b66\u89c4\u5219 PromQL \u67e5\u8be2\u8bed\u53e5</li> <li><code>for</code>\uff1a\u8bc4\u4f30\u7b49\u5f85\u65f6\u95f4\uff08Pending Duration\uff09\uff0c\u7528\u4e8e\u8868\u793a\u53ea\u6709\u5f53\u89e6\u53d1\u6761\u4ef6\u6301\u7eed\u4e00\u6bb5\u65f6\u95f4\u540e\u624d\u53d1\u9001\u544a\u8b66\uff0c\u5728\u7b49\u5f85\u671f\u95f4\u65b0\u4ea7\u751f\u7684\u544a\u8b66\u72b6\u6001\u4e3a<code>pending</code></li> <li><code>labels</code>\uff1a\u81ea\u5b9a\u4e49\u6807\u7b7e\uff0c\u5141\u8bb8\u7528\u6237\u6307\u5b9a\u989d\u5916\u7684\u6807\u7b7e\u5217\u8868\uff0c\u628a\u5b83\u4eec\u9644\u52a0\u5728\u544a\u8b66\u4e0a</li> <li><code>annotations</code>\uff1a\u6307\u5b9a\u4e86\u53e6\u4e00\u7ec4\u6807\u7b7e\uff0c\u5b83\u4eec\u4e0d\u88ab\u5f53\u505a\u544a\u8b66\u5b9e\u4f8b\u7684\u8eab\u4efd\u6807\u8bc6\uff0c\u5b83\u4eec\u7ecf\u5e38\u7528\u4e8e\u5b58\u50a8\u4e00\u4e9b\u989d\u5916\u7684\u4fe1\u606f\uff0c\u7528\u4e8e\u62a5\u8b66\u4fe1\u606f\u7684\u5c55\u793a\u4e4b\u7c7b\u7684</li> </ul> <p>for \u5c5e\u6027</p> <p>\u8fd9\u4e2a\u53c2\u6570\u4e3b\u8981\u7528\u4e8e\u964d\u566a\uff0c\u5f88\u591a\u7c7b\u4f3c\u54cd\u5e94\u65f6\u95f4\u8fd9\u6837\u7684\u6307\u6807\u90fd\u662f\u6709\u6296\u52a8\u7684\uff0c\u901a\u8fc7\u6307\u5b9a <code>Pending Duration</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u8fc7\u6ee4\u6389\u8fd9\u4e9b\u77ac\u65f6\u6296\u52a8\uff0c\u53ef\u4ee5\u8ba9\u6211\u4eec\u80fd\u591f\u628a\u6ce8\u610f\u529b\u653e\u5728\u771f\u6b63\u6709\u6301\u7eed\u5f71\u54cd\u7684\u95ee\u9898\u4e0a\u3002</p> <p>\u4e3a\u4e86\u8ba9\u544a\u8b66\u4fe1\u606f\u5177\u6709\u66f4\u597d\u7684\u53ef\u8bfb\u6027\uff0cPrometheus \u652f\u6301\u6a21\u677f\u5316 <code>label</code> \u548c <code>annotations</code> \u4e2d\u7684\u6807\u7b7e\u7684\u503c\uff0c\u901a\u8fc7 <code>$labels.\u53d8\u91cf</code> \u53ef\u4ee5\u8bbf\u95ee\u5f53\u524d\u544a\u8b66\u5b9e\u4f8b\u4e2d\u6307\u5b9a\u6807\u7b7e\u7684\u503c\uff0c<code>$value</code> \u5219\u53ef\u4ee5\u83b7\u53d6\u5f53\u524d PromQL \u8868\u8fbe\u5f0f\u8ba1\u7b97\u7684\u6837\u672c\u503c\u3002</p> <p>\u4e3a\u4e86\u65b9\u4fbf\u6f14\u793a\uff0c\u6211\u4eec\u5c06\u7684\u8868\u8fbe\u5f0f\u5224\u65ad\u62a5\u8b66\u4e34\u754c\u503c\u8bbe\u7f6e\u4e3a 20\uff0c\u91cd\u65b0\u66f4\u65b0 ConfigMap \u8d44\u6e90\u5bf9\u8c61\uff0c\u7531\u4e8e\u6211\u4eec\u5728 Prometheus \u7684 Pod \u4e2d\u5df2\u7ecf\u901a\u8fc7 Volume \u7684\u5f62\u5f0f\u5c06 prometheus-config \u8fd9\u4e2a\u4e00\u4e2a ConfigMap \u5bf9\u8c61\u6302\u8f7d\u5230\u4e86 <code>/etc/prometheus</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u6240\u4ee5\u66f4\u65b0\u540e\uff0c\u8be5\u76ee\u5f55\u4e0b\u9762\u4e5f\u4f1a\u51fa\u73b0 <code>rules.yml</code> \u6587\u4ef6\uff0c\u6240\u4ee5\u524d\u9762\u914d\u7f6e\u7684 <code>rule_files</code> \u8def\u5f84\u4e5f\u662f\u6b63\u5e38\u7684\uff0c\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u91cd\u65b0\u6267\u884c reload \u64cd\u4f5c\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53bb Prometheus \u7684 Dashboard \u4e2d\u5207\u6362\u5230 alerts \u8def\u5f84\u4e0b\u9762\u5c31\u53ef\u4ee5\u770b\u5230\u6709\u62a5\u8b66\u914d\u7f6e\u89c4\u5219\u7684\u6570\u636e\u4e86\uff1a</p> <p></p> <p>\u9875\u9762\u4e2d\u51fa\u73b0\u4e86\u6211\u4eec\u521a\u521a\u5b9a\u4e49\u7684\u62a5\u8b66\u89c4\u5219\u4fe1\u606f\uff0c\u800c\u4e14\u62a5\u8b66\u4fe1\u606f\u4e2d\u8fd8\u6709\u72b6\u6001\u663e\u793a\uff0c\u4e00\u4e2a\u62a5\u8b66\u4fe1\u606f\u5728\u751f\u547d\u5468\u671f\u5185\u6709\u4e0b\u97623\u79cd\u72b6\u6001\uff1a</p> <ul> <li><code>pending</code>: \u8868\u793a\u5728\u8bbe\u7f6e\u7684\u9608\u503c\u65f6\u95f4\u8303\u56f4\u5185\u88ab\u6fc0\u6d3b\u4e86</li> <li><code>firing</code>: \u8868\u793a\u8d85\u8fc7\u8bbe\u7f6e\u7684\u9608\u503c\u65f6\u95f4\u88ab\u6fc0\u6d3b\u4e86</li> <li><code>inactive</code>: \u8868\u793a\u5f53\u524d\u62a5\u8b66\u4fe1\u606f\u5904\u4e8e\u975e\u6d3b\u52a8\u72b6\u6001</li> </ul> <p>\u540c\u65f6\u5bf9\u4e8e\u5df2\u7ecf <code>pending</code> \u6216\u8005 <code>firing</code> \u7684\u544a\u8b66\uff0cPrometheus \u4e5f\u4f1a\u5c06\u5b83\u4eec\u5b58\u50a8\u5230\u65f6\u95f4\u5e8f\u5217<code>ALERTS{}</code>\u4e2d\u3002\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8868\u8fbe\u5f0f\u53bb\u67e5\u8be2\u544a\u8b66\u5b9e\u4f8b\uff1a</p> <pre><code>ALERTS{alertname=\"&lt;alert name&gt;\", alertstate=\"pending|firing\", &lt;additional alert labels&gt;}\n</code></pre> <p>\u6837\u672c\u503c\u4e3a<code>1</code>\u8868\u793a\u5f53\u524d\u544a\u8b66\u5904\u4e8e\u6d3b\u52a8\u72b6\u6001\uff08pending \u6216\u8005 firing\uff09\uff0c\u5f53\u544a\u8b66\u4ece\u6d3b\u52a8\u72b6\u6001\u8f6c\u6362\u4e3a\u975e\u6d3b\u52a8\u72b6\u6001\u65f6\uff0c\u6837\u672c\u503c\u5219\u4e3a0\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u7684\u72b6\u6001\u73b0\u5728\u662f <code>firing</code> \u5c31\u8868\u793a\u8fd9\u4e2a\u62a5\u8b66\u5df2\u7ecf\u88ab\u6fc0\u6d3b\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u7684\u62a5\u8b66\u4fe1\u606f\u6709\u4e00\u4e2a <code>team=node</code> \u8fd9\u6837\u7684\u6807\u7b7e\uff0c\u800c\u6700\u4e0a\u9762\u6211\u4eec\u914d\u7f6e alertmanager \u7684\u65f6\u5019\u5c31\u6709\u5982\u4e0b\u7684\u8def\u7531\u914d\u7f6e\u4fe1\u606f\u4e86\uff1a</p> <pre><code>routes:\n- receiver: email\n  group_wait: 10s\n  match:\n    team: node\n</code></pre> <p>\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u7684\u62a5\u8b66\u4fe1\u606f\u4f1a\u88ab email \u8fd9\u4e2a\u63a5\u6536\u5668\u6765\u8fdb\u884c\u62a5\u8b66\uff0c\u6211\u4eec\u4e0a\u9762\u914d\u7f6e\u7684\u662f\u90ae\u7bb1\uff0c\u6240\u4ee5\u6b63\u5e38\u6765\u8bf4\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u4f1a\u6536\u5230\u4e00\u5c01\u5982\u4e0b\u7684\u62a5\u8b66\u90ae\u4ef6\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6536\u5230\u7684\u90ae\u4ef6\u5185\u5bb9\u4e2d\u5305\u542b\u4e00\u4e2a <code>View In AlertManager</code> \u7684\u94fe\u63a5\uff0c\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u901a\u8fc7 NodePort \u7684\u5f62\u5f0f\u53bb\u8bbf\u95ee\u5230 AlertManager \u7684 Dashboard \u9875\u9762\uff1a</p> <pre><code>$ kubectl get svc -n kube-mon\nNAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE\nalertmanager   NodePort    195     &lt;none&gt;        9093:31194/TCP      141m\n</code></pre> <p>\u7136\u540e\u901a\u8fc7 <code>&lt;\u4efb\u4e00Node\u8282\u70b9&gt;:31194</code> \u8fdb\u884c\u8bbf\u95ee\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u5230 AlertManager \u7684 Dashboard \u9875\u9762\uff0c\u5728\u8fd9\u4e2a\u9875\u9762\u4e2d\u6211\u4eec\u53ef\u4ee5\u8fdb\u884c\u4e00\u4e9b\u64cd\u4f5c\uff0c\u6bd4\u5982\u8fc7\u6ee4\u3001\u5206\u7ec4\u7b49\u7b49\uff0c\u91cc\u9762\u8fd8\u6709\u4e24\u4e2a\u65b0\u7684\u6982\u5ff5\uff1a<code>Inhibition(\u6291\u5236)</code> \u548c <code>Silences(\u9759\u9ed8)</code>\u3002</p> <ul> <li>Inhibition\uff1a\u5982\u679c\u67d0\u4e9b\u5176\u4ed6\u8b66\u62a5\u5df2\u7ecf\u89e6\u53d1\u4e86\uff0c\u5219\u5bf9\u4e8e\u67d0\u4e9b\u8b66\u62a5\uff0cInhibition \u662f\u4e00\u4e2a\u6291\u5236\u901a\u77e5\u7684\u6982\u5ff5\u3002\u4f8b\u5982\uff1a\u4e00\u4e2a\u8b66\u62a5\u5df2\u7ecf\u89e6\u53d1\uff0c\u5b83\u6b63\u5728\u901a\u77e5\u6574\u4e2a\u96c6\u7fa4\u662f\u4e0d\u53ef\u8fbe\u7684\u65f6\uff0cAlertmanager \u5219\u53ef\u4ee5\u914d\u7f6e\u6210\u5173\u5fc3\u8fd9\u4e2a\u96c6\u7fa4\u7684\u5176\u4ed6\u8b66\u62a5\u65e0\u6548\u3002\u8fd9\u53ef\u4ee5\u9632\u6b62\u4e0e\u5b9e\u9645\u95ee\u9898\u65e0\u5173\u7684\u6570\u767e\u6216\u6570\u5343\u4e2a\u89e6\u53d1\u8b66\u62a5\u7684\u901a\u77e5\uff0cInhibition \u9700\u8981\u901a\u8fc7\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u914d\u7f6e\u3002</li> <li>Silences\uff1a\u9759\u9ed8\u662f\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5728\u7ed9\u5b9a\u65f6\u95f4\u5185\u7b80\u5355\u5730\u5ffd\u7565\u6240\u6709\u8b66\u62a5\u3002Silences \u57fa\u4e8e matchers\u914d\u7f6e\uff0c\u7c7b\u4f3c\u8def\u7531\u6811\u3002\u6765\u5230\u7684\u8b66\u544a\u5c06\u4f1a\u88ab\u68c0\u67e5\uff0c\u5224\u65ad\u5b83\u4eec\u662f\u5426\u548c\u6d3b\u8dc3\u7684 Silences \u76f8\u7b49\u6216\u8005\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u3002\u5982\u679c\u5339\u914d\u6210\u529f\uff0c\u5219\u4e0d\u4f1a\u5c06\u8fd9\u4e9b\u8b66\u62a5\u53d1\u9001\u7ed9\u63a5\u6536\u8005\u3002</li> </ul> <p>\u7531\u4e8e\u5168\u5c40\u914d\u7f6e\u4e2d\u6211\u4eec\u914d\u7f6e\u7684 <code>repeat_interval: 1h</code>\uff0c\u6240\u4ee5\u6b63\u5e38\u6765\u8bf4\uff0c\u4e0a\u9762\u7684\u6d4b\u8bd5\u62a5\u8b66\u5982\u679c\u4e00\u76f4\u6ee1\u8db3\u62a5\u8b66\u6761\u4ef6(\u5185\u5b58\u4f7f\u7528\u7387\u5927\u4e8e20%)\u7684\u8bdd\uff0c\u90a3\u4e48\u6bcf1\u5c0f\u65f6\u6211\u4eec\u5c31\u53ef\u4ee5\u6536\u5230\u4e00\u6761\u62a5\u8b66\u90ae\u4ef6\u3002</p> <p>\u4e00\u6761\u544a\u8b66\u4ea7\u751f\u540e\uff0c\u8fd8\u8981\u7ecf\u8fc7 Alertmanager \u7684\u5206\u7ec4\u3001\u6291\u5236\u5904\u7406\u3001\u9759\u9ed8\u5904\u7406\u3001\u53bb\u91cd\u5904\u7406\u548c\u964d\u566a\u5904\u7406\u6700\u540e\u518d\u53d1\u9001\u7ed9\u63a5\u6536\u8005\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u4f1a\u56e0\u4e3a\u5404\u79cd\u539f\u56e0\u4f1a\u5bfc\u81f4\u544a\u8b66\u4ea7\u751f\u4e86\u5374\u6700\u7ec8\u6ca1\u6709\u8fdb\u884c\u901a\u77e5\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u56fe\u4e86\u89e3\u6574\u4e2a\u544a\u8b66\u7684\u751f\u547d\u5468\u671f\uff1a</p> <p></p>"},{"location":"kubernetes_monitor/alertmanager/#webhook","title":"WebHook \u63a5\u6536\u5668","text":"<p>\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u7684\u662f AlertManager \u81ea\u5e26\u7684\u90ae\u4ef6\u62a5\u8b66\u6a21\u677f\uff0c\u6211\u4eec\u4e5f\u8bf4\u4e86 AlertManager \u652f\u6301\u5f88\u591a\u4e2d\u62a5\u8b66\u63a5\u6536\u5668\uff0c\u6bd4\u5982 slack\u3001\u5fae\u4fe1\u4e4b\u7c7b\u7684\uff0c\u5176\u4e2d\u6700\u4e3a\u7075\u6d3b\u7684\u65b9\u5f0f\u5f53\u7136\u662f\u4f7f\u7528 webhook \u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a webhook \u6765\u63a5\u6536\u62a5\u8b66\u4fe1\u606f\uff0c\u7136\u540e\u5728 webhook \u91cc\u9762\u53bb\u8fdb\u884c\u5904\u7406\uff0c\u9700\u8981\u53d1\u9001\u600e\u6837\u7684\u62a5\u8b66\u4fe1\u606f\u6211\u4eec\u81ea\u5b9a\u4e49\u5c31\u53ef\u4ee5\u3002</p> <p>\u6211\u8fd9\u91cc\u5b9e\u73b0\u4e86\u4e00\u4e2a\u7b80\u5355\u7684 webhook \u7a0b\u5e8f\uff0c\u4ee3\u7801\u4ed3\u5e93\u5730\u5740\uff1agithub.com/cnych/alertmanager-dingtalk-hook</p> <p>\u5f53\u7136\u6211\u4eec\u5f97\u5c06\u4e0a\u9762\u8fd9\u4e2a\u670d\u52a1\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\u6765\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\uff1a(dingtalk-hook.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: dingtalk-hook\n  namespace: kube-mon\nspec:\n  selector:\n    matchLabels:\n      app: dingtalk-hook\n  template:\n    metadata:\n      labels:\n        app: dingtalk-hook\n    spec:\n      containers:\n      - name: dingtalk-hook\n        image: cnych/alertmanager-dingtalk-hook:v2\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 5000\n          name: http\n        env:\n        - name: PROME_URL\n          value: k8s.qikqiak.com:30980\n        - name: LOG_LEVEL\n          value: debug\n        - name: ROBOT_TOKEN\n          valueFrom:\n            secretKeyRef:\n              name: dingtalk-secret\n              key: token\n        - name: ROBOT_SECRET\n          valueFrom:\n            secretKeyRef:\n              name: dingtalk-secret\n              key: secret\n        resources:\n          requests:\n            cpu: 50m\n            memory: 100Mi\n          limits:\n            cpu: 50m\n            memory: 100Mi\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: dingtalk-hook\n  namespace: kube-mon\nspec:\n  selector:\n    app: dingtalk-hook\n  ports:\n  - name: hook\n    port: 5000\n    targetPort: http\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u6709\u4e00\u4e9b\u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff1a</p> <ul> <li>ROBOT_TOKEN\uff1a\u9489\u9489\u673a\u5668\u4eba TOKEN</li> <li>PROME_URL\uff1a\u624b\u52a8\u6307\u5b9a\u8df3\u8f6c\u540e\u7684 Promethues \u5730\u5740\uff0c\u9ed8\u8ba4\u4f1a\u662f Pod \u7684\u5730\u5740</li> <li>LOG_LEVEL\uff1a\u65e5\u5fd7\u7ea7\u522b\uff0c\u8bbe\u7f6e\u6210 <code>debug</code> \u53ef\u4ee5\u770b\u5230 AlertManager WebHook \u53d1\u9001\u7684\u6570\u636e\uff0c\u65b9\u4fbf\u8c03\u8bd5\u4f7f\u7528\uff0c\u4e0d\u9700\u8c03\u8bd5\u53ef\u4ee5\u4e0d\u8bbe\u7f6e\u8be5\u73af\u5883\u53d8\u91cf</li> <li>ROBOT_SECRET\uff1a\u4e3a\u9489\u9489\u673a\u5668\u4eba\u7684\u5b89\u5168\u8bbe\u7f6e\u5bc6\u94a5\uff0c\u673a\u5668\u4eba\u5b89\u5168\u8bbe\u7f6e\u9875\u9762\uff0c\u52a0\u7b7e\u4e00\u680f\u4e0b\u9762\u663e\u793a\u7684 SEC \u5f00\u5934\u7684\u5b57\u7b26\u4e32</li> </ul> <p></p> <p>\u4e0a\u9762\u6211\u4eec\u58f0\u660e\u7684 ROBOT_TOKEN \u548c ROBOT_SECRET \u73af\u5883\u53d8\u91cf\uff0c\u7531\u4e8e\u8fd9\u662f\u4e00\u4e2a\u76f8\u5bf9\u4e8e\u79c1\u5bc6\u7684\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4ece\u4e00\u4e2a Secret \u5bf9\u8c61\u4e2d\u53bb\u83b7\u53d6\uff0c\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a dingtalk-secret \u7684 Secret \u5bf9\u8c61\uff0c\u7136\u540e\u90e8\u7f72\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl create secret generic dingtalk-secret --from-literal=token=&lt;\u9489\u9489\u7fa4\u804a\u7684\u673a\u5668\u4ebaTOKEN&gt; --from-literal=secret=&lt;\u9489\u9489\u7fa4\u804a\u673a\u5668\u4eba\u7684SECRET&gt; -n kube-mon\nsecret \"dingtalk-secret\" created\n$ kubectl apply -f dingtalk-hook.yaml\ndeployment.apps \"dingtalk-hook\" created\nservice \"dingtalk-hook\" created\n$ kubectl get pods -n kube-mon\nNAME                            READY     STATUS      RESTARTS   AGE\ndingtalk-hook-c4fcd8cd6-6r2b6   1/1       Running     0          45m\n......\n</code></pre> <p>\u90e8\u7f72\u6210\u529f\u540e\uff0c\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u7ed9 AlertManager \u914d\u7f6e\u4e00\u4e2a webhook \u4e86\uff0c\u5728\u4e0a\u9762\u7684\u914d\u7f6e\u4e2d\u589e\u52a0\u4e00\u4e2a\u8def\u7531\u63a5\u6536\u5668</p> <pre><code>routes:\n  - receiver: webhook\n    match:\n      filesystem: node\nreceivers:\n- name: 'webhook'\n  webhook_configs:\n  - url: 'http://dingtalk-hook:5000'\n    send_resolved: true\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u914d\u7f6e\u4e86\u4e00\u4e2a\u540d\u4e3a webhook \u7684\u63a5\u6536\u5668\uff0c\u5730\u5740\u4e3a\uff1a</p> <pre><code>http://dingtalk-hook:5000\n</code></pre> <p>\uff0c\u8fd9\u4e2a\u5730\u5740\u5f53\u7136\u5c31\u662f\u4e0a\u9762\u6211\u4eec\u90e8\u7f72\u7684\u9489\u9489\u7684 webhook \u7684\u63a5\u6536\u7a0b\u5e8f\u7684 Service \u5730\u5740\u3002</p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u66f4\u65b0 AlertManager \u548c Prometheus \u7684 ConfigMap \u8d44\u6e90\u5bf9\u8c61\uff0c\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u9694\u4e00\u4f1a\u513f\u6267\u884c reload \u64cd\u4f5c\u662f\u66f4\u65b0\u751f\u6548\uff0c\u5982\u679c\u6709\u62a5\u8b66\u89e6\u53d1\u7684\u8bdd\uff0c\u9694\u4e00\u4f1a\u513f\u5173\u4e8e\u8fd9\u4e2a\u8282\u70b9\u6587\u4ef6\u7cfb\u7edf\u7684\u62a5\u8b66\u5c31\u4f1a\u88ab\u89e6\u53d1\u4e86\uff0c\u7531\u4e8e\u8fd9\u4e2a\u62a5\u8b66\u4fe1\u606f\u5305\u542b\u4e00\u4e2a<code>team=node</code> \u7684 label \u6807\u7b7e\uff0c\u6240\u4ee5\u4f1a\u88ab\u8def\u7531\u5230 webhook \u8fd9\u4e2a\u63a5\u6536\u5668\u4e2d\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u8fd9\u4e2a dingtalk-hook\uff0c\u89e6\u53d1\u540e\u53ef\u4ee5\u89c2\u5bdf\u8fd9\u4e2a Pod \u7684\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs -f dingtalk-hook-cc677c46d-gf26f -n kube-mon\n * Serving Flask app \"app\" (lazy loading)\n * Environment: production\n   WARNING: Do not use the development server in a production environment.\n   Use a production WSGI server instead.\n * Debug mode: off\n * Running on http://0:5000/ (Press CTRL+C to quit)\n\n2019-12-15 08:11:30,051 DEBUG Starting new HTTPS connection (1): oapi.dingtalk.com:443\n2019-12-15 08:11:30,781 DEBUG https://oapi.dingtalk.com:443 \"POST /robot/send?access_token=ff5067c95035185a752eb0fe90a1e52fd16f596c8ca89712e18ac2a3e1b7ee89&amp;timestamp=1576397489986&amp;sign=wOggfoW%2BAVgvi2BiHnlKd79Tvjf7S3boRAs1BoDhhTE%3D HTTP/1\" 200 None\n2019-12-15 08:11:30,951 INFO 2129 - - [15/Dec/2019 08:11:30] \"POST / HTTP/1\" 200 -\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 POST \u8bf7\u6c42\u5df2\u7ecf\u6210\u529f\u4e86\uff0c\u540c\u65f6\u8fd9\u4e2a\u65f6\u5019\u6b63\u5e38\u6765\u8bf4\u5c31\u53ef\u4ee5\u6536\u5230\u4e00\u6761\u9489\u9489\u6d88\u606f\u4e86\uff1a</p> <p></p> <p>\u7531\u4e8e\u6211\u4eec\u7a0b\u5e8f\u4e2d\u662f\u7528\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684 markdown \u5f62\u5f0f\u76f4\u63a5\u8f6c\u53d1\u7684\uff0c\u6240\u4ee5\u8fd9\u91cc\u62a5\u8b66\u4fe1\u606f\u4e0d\u591f\u53cb\u597d\uff0c\u6ca1\u5173\u7cfb\uff0c\u6709\u4e86\u8fd9\u4e2a\u793a\u4f8b\u6211\u4eec\u5b8c\u5168\u5c31\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u8981\u6765\u5b9a\u5236\u6d88\u606f\u6a21\u677f\u4e86\uff0c\u53ef\u4ee5\u53c2\u8003\u9489\u9489\u81ea\u5b9a\u4e49\u673a\u5668\u4eba\u6587\u6863\uff1ahttps://open-doc.dingtalk.com/microapp/serverapi2/qf2nxq</p>"},{"location":"kubernetes_monitor/alertmanager/#_3","title":"\u81ea\u5b9a\u4e49\u6a21\u677f","text":"<p>\u544a\u8b66\u901a\u77e5\u4f7f\u7528\u7684\u662f\u9ed8\u8ba4\u6a21\u7248\uff0c\u56e0\u4e3a\u5b83\u5df2\u7ecf\u7f16\u8bd1\u5230\u4e8c\u8fdb\u5236\u5305\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u9700\u8981\u989d\u5916\u914d\u7f6e\u3002\u5982\u679c\u6211\u4eec\u60f3\u81ea\u5b9a\u4e49\u6a21\u7248\uff0c\u8fd9\u53c8\u8be5\u5982\u4f55\u914d\u7f6e\u5462\uff1f</p> <p>\u6b65\u9aa4\u4e00\uff1a \u4e0b\u8f7d\u5b98\u65b9\u9ed8\u8ba4\u6a21\u7248</p> <pre><code>$ wget https://raw.githubusercontent.com/prometheus/alertmanager/master/template/default.tmpl\n</code></pre> <p>\u6b65\u9aa4\u4e8c\uff1a \u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u4fee\u6539\u6a21\u7248\uff0c\u4e3b\u8981\u662f\u4e0b\u9762\u8fd9\u4e00\u6bb5</p> <pre><code>define \"email.default.html\" \n.... // \u4fee\u6539\u5185\u5bb9\nend\n</code></pre> <p>\u6b65\u9aa4\u4e09: \u4fee\u6539 alertmanger.yml\uff0c\u6dfb\u52a0 templates \u914d\u7f6e\u53c2\u6570</p> <pre><code>templates:\n- './template/*.tmpl'  #  \u81ea\u5b9a\u4e49\u6a21\u7248\u8def\u5f84\n</code></pre> <p>\u6700\u540e\u4fdd\u5b58\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u5373\u53ef\u3002</p>"},{"location":"kubernetes_monitor/alertmanager/#_4","title":"\u8bb0\u5f55\u89c4\u5219","text":"<p>\u901a\u8fc7 <code>PromQL</code> \u53ef\u4ee5\u5b9e\u65f6\u5bf9 Prometheus \u4e2d\u91c7\u96c6\u5230\u7684\u6837\u672c\u6570\u636e\u8fdb\u884c\u67e5\u8be2\uff0c\u805a\u5408\u4ee5\u53ca\u5176\u5b83\u5404\u79cd\u8fd0\u7b97\u64cd\u4f5c\u3002\u800c\u5728\u67d0\u4e9b PromQL \u8f83\u4e3a\u590d\u6742\u4e14\u8ba1\u7b97\u91cf\u8f83\u5927\u65f6\uff0c\u76f4\u63a5\u4f7f\u7528 PromQL \u53ef\u80fd\u4f1a\u5bfc\u81f4 Prometheus \u54cd\u5e94\u8d85\u65f6\u7684\u60c5\u51b5\u3002\u8fd9\u65f6\u9700\u8981\u4e00\u79cd\u80fd\u591f\u7c7b\u4f3c\u4e8e\u540e\u53f0\u6279\u5904\u7406\u7684\u673a\u5236\u5728\u540e\u53f0\u5b8c\u6210\u8fd9\u4e9b\u590d\u6742\u8fd0\u7b97\u7684\u8ba1\u7b97\uff0c\u5bf9\u4e8e\u4f7f\u7528\u8005\u800c\u8a00\u53ea\u9700\u8981\u67e5\u8be2\u8fd9\u4e9b\u8fd0\u7b97\u7ed3\u679c\u5373\u53ef\u3002Prometheus \u901a\u8fc7<code>Recoding Rule</code> \u89c4\u5219\u652f\u6301\u8fd9\u79cd\u540e\u53f0\u8ba1\u7b97\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u590d\u6742\u67e5\u8be2\u7684\u6027\u80fd\u4f18\u5316\uff0c\u63d0\u9ad8\u67e5\u8be2\u6548\u7387\u3002</p> <p>\u5728 Prometheus \u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>rule_files</code> \u5b9a\u4e49 <code>recoding rule</code> \u89c4\u5219\u6587\u4ef6\u7684\u8bbf\u95ee\u8def\u5f84\u3002</p> <pre><code>rule_files:\n  [ - &lt;filepath_glob&gt; ... ]\n</code></pre> <p>\u6bcf\u4e00\u4e2a\u89c4\u5219\u6587\u4ef6\u901a\u8fc7\u4ee5\u4e0b\u683c\u5f0f\u8fdb\u884c\u5b9a\u4e49\uff1a</p> <pre><code>groups:\n  [ - &lt;rule_group&gt; ]\n</code></pre> <p>\u4e00\u4e2a\u7b80\u5355\u7684\u89c4\u5219\u6587\u4ef6\u53ef\u80fd\u662f\u8fd9\u4e2a\u6837\u5b50\u7684\uff1a</p> <pre><code>groups:\n- name: example\n  rules:\n  - record: job:http_inprogress_requests:sum\n    expr: sum(http_inprogress_requests) by (job)\n</code></pre> <p>rule_group \u7684\u5177\u4f53\u914d\u7f6e\u9879\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># \u5206\u7ec4\u7684\u540d\u79f0\uff0c\u5728\u4e00\u4e2a\u6587\u4ef6\u4e2d\u5fc5\u987b\u662f\u552f\u4e00\u7684\nname: &lt;string&gt;\n\n# \u8bc4\u4f30\u5206\u7ec4\u4e2d\u89c4\u5219\u7684\u9891\u7387\n[ interval: &lt;duration&gt; | default = global.evaluation_interval ]\n\nrules:\n  [ - &lt;rule&gt; ... ]\n</code></pre> <p>\u4e0e\u544a\u8b66\u89c4\u5219\u4e00\u81f4\uff0c\u4e00\u4e2a group \u4e0b\u53ef\u4ee5\u5305\u542b\u591a\u6761\u89c4\u5219 rule\u3002</p> <pre><code># \u8f93\u51fa\u7684\u65f6\u95f4\u5e8f\u5217\u540d\u79f0\uff0c\u5fc5\u987b\u662f\u4e00\u4e2a\u6709\u6548\u7684 metric \u540d\u79f0\nrecord: &lt;string&gt;\n\n# \u8981\u8ba1\u7b97\u7684 PromQL \u8868\u8fbe\u5f0f\uff0c\u6bcf\u4e2a\u8bc4\u4f30\u5468\u671f\u90fd\u662f\u5728\u5f53\u524d\u65f6\u95f4\u8fdb\u884c\u8bc4\u4f30\u7684\uff0c\u7ed3\u679c\u8bb0\u5f55\u4e3a\u4e00\u7ec4\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\uff0cmetrics \u540d\u79f0\u7531 record \u8bbe\u7f6e\nexpr: &lt;string&gt;\n\n# \u6dfb\u52a0\u6216\u8005\u8986\u76d6\u7684\u6807\u7b7e\nlabels:\n  [ &lt;labelname&gt;: &lt;labelvalue&gt; ]\n</code></pre> <p>\u6839\u636e\u89c4\u5219\u4e2d\u7684\u5b9a\u4e49\uff0cPrometheus \u4f1a\u5728\u540e\u53f0\u5b8c\u6210 <code>expr</code> \u4e2d\u5b9a\u4e49\u7684 PromQL \u8868\u8fbe\u5f0f\u8ba1\u7b97\uff0c\u5e76\u4e14\u5c06\u8ba1\u7b97\u7ed3\u679c\u4fdd\u5b58\u5230\u65b0\u7684\u65f6\u95f4\u5e8f\u5217 <code>record</code> \u4e2d\uff0c\u540c\u65f6\u8fd8\u53ef\u4ee5\u901a\u8fc7 labels \u6807\u7b7e\u4e3a\u8fd9\u4e9b\u6837\u672c\u6dfb\u52a0\u989d\u5916\u7684\u6807\u7b7e\u3002</p> <p>\u8fd9\u4e9b\u89c4\u5219\u6587\u4ef6\u7684\u8ba1\u7b97\u9891\u7387\u4e0e\u544a\u8b66\u89c4\u5219\u8ba1\u7b97\u9891\u7387\u4e00\u81f4\uff0c\u90fd\u901a\u8fc7 </p> <pre><code>global.evaluation_interval\n</code></pre> <p>\u8fdb\u884c\u5b9a\u4e49:</p> <pre><code>global:\n  [ evaluation_interval: &lt;duration&gt; | default = 1m ]\n</code></pre>"},{"location":"kubernetes_monitor/grafana/","title":"Grafana","text":""},{"location":"kubernetes_monitor/grafana/#grafana","title":"Grafana","text":"<p>\u524d\u9762\u6211\u4eec\u4f7f\u7528 Prometheus \u91c7\u96c6\u4e86 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u4e00\u4e9b\u76d1\u63a7\u6570\u636e\u6307\u6807\uff0c\u6211\u4eec\u4e5f\u5c1d\u8bd5\u4f7f\u7528 promQL \u8bed\u53e5\u67e5\u8be2\u51fa\u4e86\u4e00\u4e9b\u6570\u636e\uff0c\u5e76\u4e14\u5728 Prometheus \u7684 Dashboard \u4e2d\u8fdb\u884c\u4e86\u5c55\u793a\uff0c\u4f46\u662f\u660e\u663e\u53ef\u4ee5\u611f\u89c9\u5230 Prometheus \u7684\u56fe\u8868\u529f\u80fd\u76f8\u5bf9\u8f83\u5f31\uff0c\u6240\u4ee5\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u4f1a\u4e00\u4e2a\u7b2c\u4e09\u65b9\u7684\u5de5\u5177\u6765\u5c55\u793a\u8fd9\u4e9b\u6570\u636e\uff0c\u4eca\u5929\u6211\u4eec\u8981\u548c\u5927\u5bb6\u4f7f\u7528\u5230\u7684\u5c31\u662f Grafana\u3002</p> <p>Grafana \u662f\u4e00\u4e2a\u53ef\u89c6\u5316\u9762\u677f\uff0c\u6709\u7740\u975e\u5e38\u6f02\u4eae\u7684\u56fe\u8868\u548c\u5e03\u5c40\u5c55\u793a\uff0c\u529f\u80fd\u9f50\u5168\u7684\u5ea6\u91cf\u4eea\u8868\u76d8\u548c\u56fe\u5f62\u7f16\u8f91\u5668\uff0c\u652f\u6301 Graphite\u3001zabbix\u3001InfluxDB\u3001Prometheus\u3001OpenTSDB\u3001Elasticsearch \u7b49\u4f5c\u4e3a\u6570\u636e\u6e90\uff0c\u6bd4 Prometheus \u81ea\u5e26\u7684\u56fe\u8868\u5c55\u793a\u529f\u80fd\u5f3a\u5927\u592a\u591a\uff0c\u66f4\u52a0\u7075\u6d3b\uff0c\u6709\u4e30\u5bcc\u7684\u63d2\u4ef6\uff0c\u529f\u80fd\u66f4\u52a0\u5f3a\u5927\u3002</p>"},{"location":"kubernetes_monitor/grafana/#_1","title":"\u5b89\u88c5","text":"<p>\u540c\u6837\u7684\u6211\u4eec\u5c06 grafana \u5b89\u88c5\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u7b2c\u4e00\u6b65\u53bb\u67e5\u770b grafana \u7684 docker \u955c\u50cf\u7684\u4ecb\u7ecd\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 dockerhub \u4e0a\u53bb\u641c\u7d22\uff0c\u4e5f\u53ef\u4ee5\u5728\u5b98\u7f51\u53bb\u67e5\u770b\u76f8\u5173\u8d44\u6599\uff0c\u955c\u50cf\u5730\u5740\u5982\u4e0b\uff1ahttps://hub.docker.com/r/grafana/grafana/\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4ecb\u7ecd\u4e2d\u8fd0\u884c grafana \u5bb9\u5668\u7684\u547d\u4ee4\u975e\u5e38\u7b80\u5355\uff1a</p> <pre><code>$ docker run -d --name=grafana -p 3000:3000 grafana/grafana\n</code></pre> <p>\u4f46\u662f\u8fd8\u6709\u4e00\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u662f Changelog \u4e2dv5.1.0\u7248\u672c\u7684\u66f4\u65b0\u4ecb\u7ecd\uff1a</p> <pre><code>Major restructuring of the container\nUsage of chown removed\nFile permissions incompatibility with previous versions\nuser id changed from 104 to 472\ngroup id changed from 107 to 472\nRuns as the grafana user by default (instead of root)\nAll default volumes removed\n</code></pre> <p>\u7279\u522b\u9700\u8981\u6ce8\u610f\u7b2c3\u6761\uff0cuserid \u548c groupid \u90fd\u6709\u6240\u53d8\u5316\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u8fd0\u884c\u7684\u5bb9\u5668\u7684\u65f6\u5019\u9700\u8981\u6ce8\u610f\u8fd9\u4e2a\u53d8\u5316\u3002\u73b0\u5728\u6211\u4eec\u5c06\u8fd9\u4e2a\u5bb9\u5668\u8f6c\u5316\u6210 Kubernetes \u4e2d\u7684 Pod\uff1a(grafana.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: grafana\n  namespace: kube-mon\nspec:\n  selector:\n    matchLabels:\n      app: grafana\n  template:\n    metadata:\n      labels:\n        app: grafana\n    spec:\n      volumes:\n      - name: storage\n        hostPath:\n          path: /data/grafana/\n      nodeSelector:\n        monitor: prometheus\n      securityContext:\n        runAsUser: 0\n      containers:\n      - name: grafana\n        image: grafana/grafana:1\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 3000\n          name: grafana\n        env:\n        - name: GF_SECURITY_ADMIN_USER\n          value: admin\n        - name: GF_SECURITY_ADMIN_PASSWORD\n          value: admin321\n        readinessProbe:\n          failureThreshold: 10\n          httpGet:\n            path: /api/health\n            port: 3000\n            scheme: HTTP\n          initialDelaySeconds: 60\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 30\n        livenessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /api/health\n            port: 3000\n            scheme: HTTP\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 1\n        resources:\n          limits:\n            cpu: 150m\n            memory: 512Mi\n          requests:\n            cpu: 150m\n            memory: 512Mi\n        volumeMounts:\n        - mountPath: /var/lib/grafana\n          name: storage\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: grafana\n  namespace: kube-mon\nspec:\n  type: NodePort\n  ports:\n    - port: 3000\n  selector:\n    app: grafana\n</code></pre> <p>\u6211\u4eec\u4f7f\u7528\u4e86\u6700\u65b0\u7684\u955c\u50cf </p> <pre><code>grafana/grafana:2\n</code></pre> <p>\uff0c\u7136\u540e\u6dfb\u52a0\u4e86\u5065\u5eb7\u68c0\u67e5\u3001\u8d44\u6e90\u58f0\u660e\uff0c\u53e6\u5916\u4e24\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u73af\u5883\u53d8\u91cf</p> <pre><code>GF_SECURITY_ADMIN_USER\n</code></pre> <p>\u548c </p> <pre><code>GF_SECURITY_ADMIN_PASSWORD\n</code></pre> <p>\uff0c\u7528\u6765\u914d\u7f6e grafana \u7684\u7ba1\u7406\u5458\u7528\u6237\u548c\u5bc6\u7801\u7684\uff0c\u7531\u4e8e grafana \u5c06 dashboard\u3001\u63d2\u4ef6\u8fd9\u4e9b\u6570\u636e\u4fdd\u5b58\u5728 <code>/var/lib/grafana</code> \u8fd9\u4e2a\u76ee\u5f55\u4e0b\u9762\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u5982\u679c\u9700\u8981\u505a\u6570\u636e\u6301\u4e45\u5316\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u9488\u5bf9\u8fd9\u4e2a\u76ee\u5f55\u8fdb\u884c volume \u6302\u8f7d\u58f0\u660e\uff0c\u548c Prometheus \u4e00\u6837\uff0c\u6211\u4eec\u5c06 grafana \u56fa\u5b9a\u5728\u4e00\u4e2a\u5177\u6709 <code>monitor: prometheus</code> \u6807\u7b7e\u7684\u8282\u70b9\uff0c\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u521a\u521a\u63d0\u5230\u7684 Changelog \u4e2d grafana \u7684 userid \u548c groupid \u6709\u6240\u53d8\u5316\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u589e\u52a0\u4e00\u4e2a <code>securityContext</code> \u7684\u58f0\u660e\u6765\u8fdb\u884c\u58f0\u660e\u4f7f\u7528 root \u7528\u6237\u8fd0\u884c\u3002\u6700\u540e\uff0c\u6211\u4eec\u9700\u8981\u5bf9\u5916\u66b4\u9732 grafana \u8fd9\u4e2a\u670d\u52a1\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u5bf9\u5e94\u7684 Service \u5bf9\u8c61\uff0c\u5f53\u7136\u7528 NodePort \u6216\u8005\u518d\u5efa\u7acb\u4e00\u4e2a ingress \u5bf9\u8c61\u90fd\u662f\u53ef\u884c\u7684\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f grafana.yaml\ndeployment.apps \"grafana\" created\nservice \"grafana\" created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b grafana \u5bf9\u5e94\u7684 Pod \u662f\u5426\u6b63\u5e38\uff1a</p> <pre><code>$ kubectl get pods -n kube-mon -l app=grafana         \nNAME                       READY   STATUS    RESTARTS   AGE\ngrafana-5579769f64-vfn7q   1/1     Running   0          77s\n$ kubectl logs -f grafana-5579769f64-vfn7q -n kube-mon\n......\nlogger=settings var=\"GF_SECURITY_ADMIN_USER=admin\"\nt=2019-12-13T06:35:08+0000 lvl=info msg=\"Config overridden from Environment variable\"\n......\nt=2019-12-13T06:35:08+0000 lvl=info msg=\"Initializing Stream Manager\"\nt=2019-12-13T06:35:08+0000 lvl=info msg=\"HTTP Server Listen\" logger=http.server address=[::]:3000 protocol=http subUrl= socket=\n</code></pre> <p>\u770b\u5230\u4e0a\u9762\u7684\u65e5\u5fd7\u4fe1\u606f\u5c31\u8bc1\u660e\u6211\u4eec\u7684 grafana \u7684 Pod \u5df2\u7ecf\u6b63\u5e38\u542f\u52a8\u8d77\u6765\u4e86\u3002\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u67e5\u770b Service \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get svc -n kube-mon\nNAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE\ngrafana      NodePort    1158   &lt;none&gt;        3000:31548/TCP      12m\n......\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u4f7f\u7528 </p> <pre><code>http://&lt;\u4efb\u610f\u8282\u70b9IP:31548&gt;\n</code></pre> <p>\u6765\u8bbf\u95ee grafana \u8fd9\u4e2a\u670d\u52a1\u4e86\uff1a</p> <p></p> <p>\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u4e86\u7ba1\u7406\u5458\u7684\uff0c\u6240\u4ee5\u7b2c\u4e00\u6b21\u6253\u5f00\u7684\u65f6\u5019\u4f1a\u8df3\u8f6c\u5230\u767b\u5f55\u754c\u9762\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u7528\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u7684\u4e24\u4e2a\u73af\u5883\u53d8\u91cf\u7684\u503c\u6765\u8fdb\u884c\u767b\u5f55\u4e86\uff0c\u767b\u5f55\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u8fdb\u5165\u5230\u4e0b\u9762 Grafana \u7684\u9996\u9875\uff0c\u7136\u540e\u70b9\u51fb<code>Add data source</code>\u8fdb\u5165\u6dfb\u52a0\u6570\u636e\u6e90\u754c\u9762\u3002</p> <p>\u6211\u4eec\u8fd9\u4e2a\u5730\u65b9\u914d\u7f6e\u7684\u6570\u636e\u6e90\u662f <code>Prometheus</code>\uff0c\u6211\u4eec\u8fd9\u91cc Prometheus \u548c Grafana \u90fd\u5904\u4e8e kube-mon \u8fd9\u540c\u4e00\u4e2a namespace \u4e0b\u9762\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u7684\u6570\u636e\u6e90\u5730\u5740\uff1a</p> <pre><code>http://prometheus:9090\n</code></pre> <p>\uff08\u56e0\u4e3a\u5728\u540c\u4e00\u4e2a namespace \u4e0b\u9762\u6240\u4ee5\u76f4\u63a5\u7528 Service \u540d\u4e5f\u53ef\u4ee5\uff09\uff0c\u7136\u540e\u5176\u4ed6\u7684\u914d\u7f6e\u4fe1\u606f\u5c31\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u4e86\uff0c\u6bd4\u5982 Auth \u8ba4\u8bc1\uff0c\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\uff0c\u6240\u4ee5\u8df3\u8fc7\u5373\u53ef\uff0c\u70b9\u51fb\u6700\u4e0b\u65b9\u7684 <code>Save &amp; Test</code> \u63d0\u793a\u6210\u529f\u8bc1\u660e\u6211\u4eec\u7684\u6570\u636e\u6e90\u914d\u7f6e\u6b63\u786e\uff1a</p> <p></p>"},{"location":"kubernetes_monitor/grafana/#_2","title":"\u63d2\u4ef6","text":"<p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u5b89\u88c5\u4e00\u4e9b\u5176\u4ed6\u63d2\u4ef6\uff0c\u6bd4\u5982 grafana \u5c31\u6709\u4e00\u4e2a\u4e13\u95e8\u9488\u5bf9 Kubernetes \u96c6\u7fa4\u76d1\u63a7\u7684\u63d2\u4ef6\uff1agrafana-kubernetes-app\uff0c\u4f46\u662f\u8be5\u63d2\u4ef6\u5f88\u4e45\u6ca1\u6709\u66f4\u65b0\u4e86\uff0c\u8fd9\u91cc\u6211\u4eec\u4ecb\u7ecd\u4e00\u4e2a\u529f\u80fd\u66f4\u52a0\u5f3a\u5927\u7684\u63d2\u4ef6 DevOpsProdigy KubeGraf\uff0c\u5b83\u662f Grafana \u5b98\u65b9\u7684 Kubernetes \u63d2\u4ef6 \u7684\u5347\u7ea7\u7248\u672c\uff0c\u8be5\u63d2\u4ef6\u53ef\u4ee5\u7528\u6765\u53ef\u89c6\u5316\u548c\u5206\u6790 Kubernetes \u96c6\u7fa4\u7684\u6027\u80fd\uff0c\u901a\u8fc7\u5404\u79cd\u56fe\u5f62\u76f4\u89c2\u7684\u5c55\u793a\u4e86 Kubernetes \u96c6\u7fa4\u7684\u4e3b\u8981\u670d\u52a1\u7684\u6307\u6807\u548c\u7279\u5f81\uff0c\u8fd8\u53ef\u4ee5\u7528\u4e8e\u68c0\u67e5\u5e94\u7528\u7a0b\u5e8f\u7684\u751f\u547d\u5468\u671f\u548c\u9519\u8bef\u65e5\u5fd7\u3002</p> <p>\u8981\u5b89\u88c5\u8fd9\u4e2a\u63d2\u4ef6\uff0c\u9700\u8981\u5230 grafana \u7684 Pod \u91cc\u9762\u53bb\u6267\u884c\u5b89\u88c5\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl exec -it grafana-5579769f64-7729f -n kube-mon /bin/bash\nbash-0# grafana-cli plugins install devopsprodigy-kubegraf-app\n\ninstalling devopsprodigy-kubegraf-app @ 0\nfrom: https://grafana.com/api/plugins/devopsprodigy-kubegraf-app/versions/0/download\ninto: /var/lib/grafana/plugins\n\n\u2714 Installed devopsprodigy-kubegraf-app successfully \n\nRestart grafana after installing plugins . &lt;service grafana-server restart&gt;\n# \u7531\u4e8e\u8be5\u63d2\u4ef6\u4f9d\u8d56\u53e6\u5916\u4e00\u4e2a Grafana-piechart-panel \u63d2\u4ef6\uff0c\u6240\u4ee5\u5982\u679c\u6ca1\u6709\u5b89\u88c5\uff0c\u540c\u6837\u9700\u8981\u5148\u5b89\u88c5\u8be5\u63d2\u4ef6\u3002\nbash-0# grafana-cli plugins install Grafana-piechart-panel\n......\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u9700\u8981\u91cd\u542f grafana \u624d\u4f1a\u751f\u6548\uff0c\u6211\u4eec\u8fd9\u91cc\u76f4\u63a5\u5220\u9664 Pod\uff0c\u91cd\u5efa\u5373\u53ef\u3002Pod \u5220\u9664\u91cd\u5efa\u5b8c\u6210\u540e\u63d2\u4ef6\u5c31\u5b89\u88c5\u6210\u529f\u4e86\u3002\u7136\u540e\u901a\u8fc7\u6d4f\u89c8\u5668\u6253\u5f00 Grafana \u627e\u5230\u8be5\u63d2\u4ef6\uff0c\u70b9\u51fb <code>enable</code> \u542f\u7528\u63d2\u4ef6\u3002</p> <p></p> <p>\u70b9\u51fb </p> <pre><code>Set up your first k8s-cluster\n</code></pre> <p>\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Kubernetes \u96c6\u7fa4:</p> <ul> <li>URL \u4f7f\u7528 Kubernetes Service \u5730\u5740\u5373\u53ef\uff1ahttps://kubernetes.default:443</li> <li>Access \u8bbf\u95ee\u6a21\u5f0f\u4f7f\u7528\uff1a<code>Server(default)</code></li> <li>\u7531\u4e8e\u63d2\u4ef6\u8bbf\u95ee Kubernetes \u96c6\u7fa4\u7684\u5404\u79cd\u8d44\u6e90\u5bf9\u8c61\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u914d\u7f6e\u8bbf\u95ee\u6743\u9650\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u4f7f\u7528 kubectl \u7684 <code>kubeconfig</code> \u6765\u8fdb\u884c\u914d\u7f6e\u5373\u53ef\u3002</li> <li>\u52fe\u9009 Auth \u4e0b\u9762\u7684 <code>TLS Client Auth</code> \u548c <code>With CA Cert</code> \u4e24\u4e2a\u9009\u9879</li> <li>\u5176\u4e2d <code>TLS Auth Details</code> \u4e0b\u9762\u7684\u503c\u5c31\u5bf9\u5e94 <code>kubeconfig</code> \u91cc\u9762\u7684\u8bc1\u4e66\u4fe1\u606f\u3002\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u7684 <code>kubeconfig</code> \u6587\u4ef6\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a</li> </ul> <pre><code>apiVersion: v1\nclusters:\n- cluster:\n    certificate-authority-data: &lt;certificate-authority-data&gt;\n    server: https://ydzs-master:6443\n  name: kubernetes\ncontexts:\n- context:\n    cluster: kubernetes\n    user: kubernetes-admin\n  name: kubernetes-admin@kubernetes\ncurrent-context: 'kubernetes-admin@kubernetes'\nkind: Config\npreferences: {}\nusers:\n- name: kubernetes-admin\n  user:\n    client-certificate-data: &lt;client-certificate-data&gt;\n    client-key-data: &lt;client-key-data&gt;\n</code></pre> <p>\u90a3\u4e48 <code>CA Cert</code> \u7684\u503c\u5c31\u5bf9\u5e94 <code>kubeconfig</code> \u91cc\u9762\u7684 </p> <pre><code>&lt;certificate-authority-data&gt;\n</code></pre> <p>\u8fdb\u884c base64 \u89e3\u7801\u8fc7\u540e\u7684\u503c\uff1b<code>Client Cert</code> \u7684\u503c\u5bf9\u5e94 </p> <pre><code>&lt;client-certificate-data&gt;\n</code></pre> <p>\u8fdb\u884c base64 \u89e3\u7801\u8fc7\u540e\u7684\u503c\uff1b<code>Client Key</code> \u7684\u503c\u5c31\u5bf9\u5e94 <code>&lt;client-key-data&gt;</code> \u8fdb\u884c base64 \u89e3\u7801\u8fc7\u540e\u7684\u503c\u3002</p> <p>base64 \u89e3\u7801</p> <p>\u5bf9\u4e8e base64 \u89e3\u7801\u63a8\u8350\u4f7f\u7528\u4e00\u4e9b\u5728\u7ebf\u7684\u670d\u52a1\uff0c\u6bd4\u5982 https://www.base64decode.org/\uff0c\u975e\u5e38\u65b9\u4fbf\u3002</p> <ul> <li> <p>\u6700\u540e\u5728 </p> <pre><code>additional datasources\n</code></pre> <p>\u4e0b\u62c9\u5217\u8868\u4e2d\u9009\u62e9 prometheus \u7684\u6570\u636e\u6e90\u3002 *   \u70b9\u51fb <code>Save &amp; Test</code> \u6b63\u5e38\u5c31\u53ef\u4ee5\u4fdd\u5b58\u6210\u529f\u4e86\u3002</p> </li> </ul> <p>\u63d2\u4ef6\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u5728\u5de6\u4fa7\u4fa7\u8fb9\u680f\u5c31\u4f1a\u51fa\u73b0 </p> <pre><code>DevOpsProdigy KubeGraf\n</code></pre> <p>\u63d2\u4ef6\u7684\u5165\u53e3\uff0c\u901a\u8fc7\u63d2\u4ef6\u9875\u9762\u53ef\u4ee5\u67e5\u770b\u6574\u4e2a\u96c6\u7fa4\u7684\u72b6\u6001\u3002</p> <p></p> <p>\u8fd8\u6709\u51e0\u4e2a\u6f02\u4eae\u7684 Dashboard \u53ef\u4ee5\u4f9b\u6211\u4eec\u6765\u8fdb\u884c\u76d1\u63a7\u56fe\u8868\u7684\u5c55\u793a\uff1a</p> <p></p>"},{"location":"kubernetes_monitor/grafana/#dashboard","title":"\u5bfc\u5165 Dashboard","text":"<p>\u4e3a\u4e86\u80fd\u591f\u5feb\u901f\u5bf9\u7cfb\u7edf\u8fdb\u884c\u76d1\u63a7\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u590d\u7528\u522b\u4eba\u7684 Grafana Dashboard\uff0c\u5728 Grafana \u7684\u5b98\u65b9\u7f51\u7ad9\u4e0a\u5c31\u6709\u5f88\u591a\u975e\u5e38\u4f18\u79c0\u7684\u7b2c\u4e09\u65b9 Dashboard\uff0c\u6211\u4eec\u5b8c\u5168\u53ef\u4ee5\u76f4\u63a5\u5bfc\u5165\u8fdb\u6765\u5373\u53ef\u3002\u6bd4\u5982\u6211\u4eec\u60f3\u8981\u5bf9\u6240\u6709\u7684\u96c6\u7fa4\u8282\u70b9\u8fdb\u884c\u76d1\u63a7\uff0c\u4e5f\u5c31\u662f node-exporter \u91c7\u96c6\u7684\u6570\u636e\u8fdb\u884c\u5c55\u793a\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u53ef\u4ee5\u5bfc\u5165 https://grafana.com/grafana/dashboards/8919 \u8fd9\u4e2a Dashboard\u3002</p> <p>\u5728\u4fa7\u8fb9\u680f\u70b9\u51fb \"+\"\uff0c\u9009\u62e9 <code>Import</code>\uff0c\u5728 Grafana Dashboard \u7684\u6587\u672c\u6846\u4e2d\u8f93\u5165 8919 \u5373\u53ef\u5bfc\u5165\uff1a</p> <p></p> <p>\u8fdb\u5165\u5bfc\u5165 Dashboard \u7684\u9875\u9762\uff0c\u53ef\u4ee5\u7f16\u8f91\u540d\u79f0\uff0c\u9009\u62e9 Prometheus \u7684\u6570\u636e\u6e90\uff1a</p> <p></p> <p>\u4fdd\u5b58\u540e\u5373\u53ef\u8fdb\u5165\u5bfc\u5165\u7684 Dashboard \u9875\u9762\u3002\u7531\u4e8e\u8be5 Dashboard \u66f4\u65b0\u6bd4\u8f83\u53ca\u65f6\uff0c\u6240\u4ee5\u57fa\u672c\u4e0a\u5bfc\u5165\u8fdb\u6765\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u4e86\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5bf9\u9875\u9762\u8fdb\u884c\u4e00\u4e9b\u8c03\u6574\uff0c\u5982\u679c\u6709\u7684\u56fe\u8868\u6ca1\u6709\u51fa\u73b0\u5bf9\u5e94\u7684\u56fe\u5f62\uff0c\u5219\u53ef\u4ee5\u7f16\u8f91\u6839\u636e\u67e5\u8be2\u8bed\u53e5\u53bb DEBUG\u3002</p> <p></p>"},{"location":"kubernetes_monitor/grafana/#_3","title":"\u81ea\u5b9a\u4e49\u56fe\u8868","text":"<p>\u5bfc\u5165\u73b0\u6210\u7684\u7b2c\u4e09\u65b9 Dashboard \u6216\u8bb8\u80fd\u89e3\u51b3\u6211\u4eec\u5927\u90e8\u5206\u95ee\u9898\uff0c\u4f46\u662f\u6bd5\u7adf\u8fd8\u4f1a\u6709\u9700\u8981\u5b9a\u5236\u56fe\u8868\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u4e86\u89e3\u5982\u4f55\u53bb\u81ea\u5b9a\u4e49\u56fe\u8868\u4e86\u3002</p> <p>\u540c\u6837\u5728\u4fa7\u8fb9\u680f\u70b9\u51fb \"+\"\uff0c\u9009\u62e9 Dashboard\uff0c\u7136\u540e\u9009\u62e9 <code>Choose Visualization</code> \u521b\u5efa\u4e00\u4e2a\u53ef\u89c6\u5316\u7684\u56fe\u8868\uff1a</p> <p></p> <p>\u53ef\u4ee5\u6839\u636e\u9700\u8981\u9009\u62e9\u5404\u79cd\u7c7b\u578b\u7684\u56fe\u8868\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u9009\u62e9\u4e00\u4e2a <code>Graph</code> \u7c7b\u578b\u7684\uff1a</p> <p></p> <p>\u7136\u540e\u9009\u62e9\u5de6\u4fa7\u56fe\u6807\u4e2d\u7684\u7b2c\u4e00\u4e2a <code>Queries</code> tab\uff0c\u7136\u540e\u9009\u62e9 <code>Prometheus</code> \u8fd9\u4e2a\u6570\u636e\u6e90\uff1a</p> <p></p> <p>\u7136\u540e\u5728 <code>Metrics</code> \u533a\u57df\u8f93\u5165\u6211\u4eec\u8981\u67e5\u8be2\u7684\u76d1\u63a7 PromQL \u8bed\u53e5\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u60f3\u8981\u67e5\u8be2\u96c6\u7fa4\u8282\u70b9 CPU \u7684\u4f7f\u7528\u7387\uff1a</p> <pre><code>(1 - sum(increase(node_cpu_seconds_total{mode=\"idle\", instance=~\"$node\"}[1m])) by (instance) / sum(increase(node_cpu_seconds_total{instance=~\"$node\"}[1m])) by (instance)) * 100\n</code></pre> <p>\u867d\u7136\u6211\u4eec\u73b0\u5728\u8fd8\u6ca1\u6709\u5177\u4f53\u7684\u5b66\u4e60\u8fc7 PromQL \u8bed\u53e5\uff0c\u4f46\u5176\u5b9e\u6211\u4eec\u4ed4\u7ec6\u5206\u6790\u4e0a\u9762\u7684\u8bed\u53e5\u4e5f\u4e0d\u662f\u5f88\u56f0\u96be\uff0c\u96c6\u7fa4\u8282\u70b9\u7684 CPU \u4f7f\u7528\u7387\u5b9e\u9645\u4e0a\u5c31\u76f8\u5f53\u4e8e\u6392\u9664\u7a7a\u95f2 CPU \u7684\u4f7f\u7528\u7387\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f18\u5148\u8ba1\u7b97\u7a7a\u95f2 CPU \u7684\u4f7f\u7528\u65f6\u957f\uff0c\u9664\u4ee5\u603b\u7684 CPU \u65f6\u957f\u5c31\u662f\u4f7f\u7528\u7387\u4e86\uff0c\u7528 1 \u51cf\u6389\u8fc7\u540e\u5c31\u662f CPU \u7684\u4f7f\u7528\u7387\u4e86\uff0c\u5982\u679c\u60f3\u7528\u767e\u5206\u6bd4\u6765\u8868\u793a\u7684\u8bdd\u5219\u4e58\u4ee5 100 \u5373\u53ef\u3002</p> <p>\u8fd9\u91cc\u6709\u4e00\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u662f\u5728 PromQL \u8bed\u53e5\u4e2d\u6709\u4e00\u4e2a <code>install=~\"$node\"</code> \u7684\u6807\u7b7e\uff0c\u5176\u5b9e\u610f\u601d\u5c31\u662f\u6839\u636e <code>$node</code> \u8fd9\u4e2a\u53c2\u6570\u6765\u8fdb\u884c\u8fc7\u6ee4\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5e0c\u671b\u5728 Grafana \u91cc\u9762\u901a\u8fc7\u53c2\u6570\u5316\u6765\u63a7\u5236\u6bcf\u4e00\u6b21\u8ba1\u7b97\u54ea\u4e00\u4e2a\u8282\u70b9\u7684 CPU \u4f7f\u7528\u7387\u3002</p> <p>\u6240\u4ee5\u8fd9\u91cc\u5c31\u6d89\u53ca\u5230 Grafana \u91cc\u9762\u7684\u53c2\u6570\u4f7f\u7528\u3002\u70b9\u51fb\u9875\u9762\u9876\u90e8\u7684 <code>Dashboard Settings</code> \u6309\u94ae\u8fdb\u5165\u914d\u7f6e\u9875\u9762\uff1a</p> <p></p> <p>\u5728\u5de6\u4fa7 tab \u680f\u70b9\u51fb <code>Variables</code> \u8fdb\u5165\u53c2\u6570\u914d\u7f6e\u9875\u9762\uff0c\u5982\u679c\u8fd8\u6ca1\u6709\u4efb\u4f55\u53c2\u6570\uff0c\u53ef\u4ee5\u901a\u8fc7\u70b9\u51fb <code>Add Variable</code> \u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u53d8\u91cf\uff1a</p> <p></p> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\u53d8\u91cf\u7684\u540d\u79f0 <code>node</code> \u5c31\u662f\u4e0a\u9762\u6211\u4eec\u5728 PromQL \u8bed\u53e5\u91cc\u9762\u4f7f\u7528\u7684 <code>$node</code> \u8fd9\u4e2a\u53c2\u6570\uff0c\u8fd9\u4e24\u4e2a\u5730\u65b9\u5fc5\u987b\u4fdd\u6301\u4e00\u81f4\uff0c\u7136\u540e\u6700\u91cd\u8981\u7684\u5c31\u662f\u53c2\u6570\u7684\u83b7\u53d6\u65b9\u5f0f\u4e86\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>Prometheus</code> \u8fd9\u4e2a\u6570\u636e\u6e90\uff0c\u901a\u8fc7 <code>kubelet_node_name</code> \u8fd9\u4e2a\u6307\u6807\u6765\u83b7\u53d6\uff0c\u5728 Prometheus \u91cc\u9762\u6211\u4eec\u53ef\u4ee5\u67e5\u8be2\u8be5\u6307\u6807\u83b7\u53d6\u5230\u7684\u503c\u4e3a\uff1a</p> <p></p> <p>\u6211\u4eec\u5176\u5b9e\u53ea\u662f\u60f3\u8981\u83b7\u53d6\u8282\u70b9\u7684\u540d\u79f0\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u53bb\u5339\u914d <code>node=xxx</code> \u8fd9\u4e2a\u6807\u7b7e\uff0c\u5c06\u5339\u914d\u7684\u503c\u4f5c\u4e3a\u53c2\u6570\u7684\u503c\u5373\u53ef:</p> <p></p> <p>\u5728\u6700\u4e0b\u9762\u7684 <code>Preview of values</code> \u91cc\u9762\u4f1a\u6709\u83b7\u53d6\u7684\u53c2\u6570\u503c\u7684\u9884\u89c8\u7ed3\u679c\u3002\u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u66f4\u65b9\u4fbf\u7684 <code>labe_values</code> \u51fd\u6570\u6765\u83b7\u53d6\uff0c\u8be5\u51fd\u6570\u53ef\u4ee5\u7528\u6765\u76f4\u63a5\u83b7\u53d6\u67d0\u4e2a\u6307\u6807\u7684 label \u503c\uff1a</p> <p></p> <p>\u53e6\u5916\u7531\u4e8e\u6211\u4eec\u5e0c\u671b\u80fd\u591f\u8ba9\u7528\u6237\u81ea\u7531\u9009\u62e9\u4e00\u6b21\u6027\u53ef\u4ee5\u67e5\u8be2\u591a\u5c11\u4e2a\u8282\u70b9\u7684\u6570\u636e\uff0c\u6240\u4ee5\u6211\u4eec\u5c06 <code>Multi-value</code> \u4ee5\u53ca <code>Include All option</code> \u90fd\u52fe\u9009\u4e0a\u4e86\uff0c\u6700\u540e\u8bb0\u5f97\u4fdd\u5b58\uff0c\u4fdd\u5b58\u540e\u8df3\u8f6c\u5230 Dashboard \u9875\u9762\u5c31\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u56fe\u8868\u4fe1\u606f\uff1a</p> <p></p> <p>\u800c\u4e14\u8fd8\u53ef\u4ee5\u6839\u636e\u53c2\u6570\u9009\u62e9\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u8282\u70b9\uff0c\u5f53\u7136\u56fe\u8868\u7684\u6807\u9898\u548c\u5927\u5c0f\u90fd\u53ef\u4ee5\u81ea\u7531\u53bb\u66f4\u6539\uff1a</p> <p></p>"},{"location":"kubernetes_monitor/prometheus/","title":"Prometheus","text":""},{"location":"kubernetes_monitor/prometheus/#prometheus","title":"Prometheus","text":"<p>\u6211\u4eec\u77e5\u9053\u76d1\u63a7\u662f\u4fdd\u8bc1\u7cfb\u7edf\u8fd0\u884c\u5fc5\u4e0d\u53ef\u5c11\u7684\u529f\u80fd\uff0c\u7279\u522b\u662f\u5bf9\u4e8e Kubernetes \u8fd9\u79cd\u6bd4\u8f83\u5e9e\u5927\u7684\u7cfb\u7edf\u6765\u8bf4\uff0c\u76d1\u63a7\u62a5\u8b66\u66f4\u662f\u4e0d\u53ef\u6216\u7f3a\uff0c\u6211\u4eec\u9700\u8981\u65f6\u523b\u4e86\u89e3\u7cfb\u7edf\u7684\u5404\u79cd\u8fd0\u884c\u6307\u6807\uff0c\u4e5f\u9700\u8981\u65f6\u523b\u4e86\u89e3\u6211\u4eec\u7684 Pod \u7684\u5404\u79cd\u6307\u6807\uff0c\u66f4\u9700\u8981\u5728\u51fa\u73b0\u95ee\u9898\u7684\u65f6\u5019\u6709\u62a5\u8b66\u4fe1\u606f\u901a\u77e5\u5230\u6211\u4eec\u3002</p> <p>\u5728\u65e9\u671f\u7684\u7248\u672c\u4e2d Kubernetes \u63d0\u4f9b\u4e86 heapster\u3001influxDB\u3001grafana \u7684\u7ec4\u5408\u6765\u76d1\u63a7\u7cfb\u7edf\uff0c\u5728\u73b0\u5728\u7684\u7248\u672c\u4e2d\u5df2\u7ecf\u79fb\u9664\u6389\u4e86 heapster\uff0c\u73b0\u5728\u66f4\u52a0\u6d41\u884c\u7684\u76d1\u63a7\u5de5\u5177\u662f Prometheus\uff0cPrometheus \u662f Google \u5185\u90e8\u76d1\u63a7\u62a5\u8b66\u7cfb\u7edf\u7684\u5f00\u6e90\u7248\u672c\uff0c\u662f Google SRE \u601d\u60f3\u5728\u5176\u5185\u90e8\u4e0d\u65ad\u5b8c\u5584\u7684\u4ea7\u7269\uff0c\u5b83\u7684\u5b58\u5728\u662f\u4e3a\u4e86\u66f4\u5feb\u548c\u9ad8\u6548\u7684\u53d1\u73b0\u95ee\u9898\uff0c\u5feb\u901f\u7684\u63a5\u5165\u901f\u5ea6\uff0c\u7b80\u5355\u7075\u6d3b\u7684\u914d\u7f6e\u90fd\u5f88\u597d\u7684\u89e3\u51b3\u4e86\u8fd9\u4e00\u5207\uff0c\u800c\u4e14\u662f\u5df2\u7ecf\u6bd5\u4e1a\u7684 CNCF \u9879\u76ee\u3002</p>"},{"location":"kubernetes_monitor/prometheus/#_1","title":"\u7b80\u4ecb","text":"<p>Prometheus \u6700\u521d\u662f SoundCloud \u6784\u5efa\u7684\u5f00\u6e90\u7cfb\u7edf\u76d1\u63a7\u548c\u62a5\u8b66\u5de5\u5177\uff0c\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u5f00\u6e90\u9879\u76ee\uff0c\u4e8e2016\u5e74\u52a0\u5165\u4e86 CNCF \u57fa\u91d1\u4f1a\uff0c\u4f5c\u4e3a\u7ee7 Kubernetes \u4e4b\u540e\u7684\u7b2c\u4e8c\u4e2a\u6258\u7ba1\u9879\u76ee\u3002Prometheus \u76f8\u6bd4\u4e8e\u5176\u4ed6\u4f20\u7edf\u76d1\u63a7\u5de5\u5177\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u4e2a\u7279\u70b9\uff1a</p> <ul> <li>\u5177\u6709\u7531 metric \u540d\u79f0\u548c\u952e/\u503c\u5bf9\u6807\u8bc6\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u7684\u591a\u7ef4\u6570\u636e\u6a21\u578b</li> <li>\u6709\u4e00\u4e2a\u7075\u6d3b\u7684\u67e5\u8be2\u8bed\u8a00</li> <li>\u4e0d\u4f9d\u8d56\u5206\u5e03\u5f0f\u5b58\u50a8\uff0c\u53ea\u548c\u672c\u5730\u78c1\u76d8\u6709\u5173</li> <li>\u901a\u8fc7 HTTP \u7684\u670d\u52a1\u62c9\u53d6\u65f6\u95f4\u5e8f\u5217\u6570\u636e</li> <li>\u4e5f\u652f\u6301\u63a8\u9001\u7684\u65b9\u5f0f\u6765\u6dfb\u52a0\u65f6\u95f4\u5e8f\u5217\u6570\u636e</li> <li>\u8fd8\u652f\u6301\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u6216\u9759\u6001\u914d\u7f6e\u53d1\u73b0\u76ee\u6807</li> <li>\u591a\u79cd\u56fe\u5f62\u548c\u4eea\u8868\u677f\u652f\u6301</li> </ul> <p>Prometheus \u7531\u591a\u4e2a\u7ec4\u4ef6\u7ec4\u6210\uff0c\u4f46\u662f\u5176\u4e2d\u6709\u4e9b\u7ec4\u4ef6\u662f\u53ef\u9009\u7684\uff1a</p> <ul> <li><code>Prometheus Server</code>\uff1a\u7528\u4e8e\u6293\u53d6\u6307\u6807\u3001\u5b58\u50a8\u65f6\u95f4\u5e8f\u5217\u6570\u636e</li> <li><code>exporter</code>\uff1a\u66b4\u9732\u6307\u6807\u8ba9\u4efb\u52a1\u6765\u6293</li> <li><code>pushgateway</code>\uff1apush \u7684\u65b9\u5f0f\u5c06\u6307\u6807\u6570\u636e\u63a8\u9001\u5230\u8be5\u7f51\u5173</li> <li><code>alertmanager</code>\uff1a\u5904\u7406\u62a5\u8b66\u7684\u62a5\u8b66\u7ec4\u4ef6 <code>adhoc</code>\uff1a\u7528\u4e8e\u6570\u636e\u67e5\u8be2</li> </ul> <p>\u5927\u591a\u6570 Prometheus \u7ec4\u4ef6\u90fd\u662f\u7528 Go \u7f16\u5199\u7684\uff0c\u56e0\u6b64\u5f88\u5bb9\u6613\u6784\u5efa\u548c\u90e8\u7f72\u4e3a\u9759\u6001\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u3002\u4e0b\u56fe\u662f Prometheus \u5b98\u65b9\u63d0\u4f9b\u7684\u67b6\u6784\u53ca\u5176\u4e00\u4e9b\u76f8\u5173\u7684\u751f\u6001\u7cfb\u7edf\u7ec4\u4ef6\uff1a</p> <p></p> <p>\u6574\u4f53\u6d41\u7a0b\u6bd4\u8f83\u7b80\u5355\uff0cPrometheus \u76f4\u63a5\u63a5\u6536\u6216\u8005\u901a\u8fc7\u4e2d\u95f4\u7684 Pushgateway \u7f51\u5173\u88ab\u52a8\u83b7\u53d6\u6307\u6807\u6570\u636e\uff0c\u5728\u672c\u5730\u5b58\u50a8\u6240\u6709\u7684\u83b7\u53d6\u7684\u6307\u6807\u6570\u636e\uff0c\u5e76\u5bf9\u8fd9\u4e9b\u6570\u636e\u8fdb\u884c\u4e00\u4e9b\u89c4\u5219\u6574\u7406\uff0c\u7528\u6765\u751f\u6210\u4e00\u4e9b\u805a\u5408\u6570\u636e\u6216\u8005\u62a5\u8b66\u4fe1\u606f\uff0cGrafana \u6216\u8005\u5176\u4ed6\u5de5\u5177\u7528\u6765\u53ef\u89c6\u5316\u8fd9\u4e9b\u6570\u636e\u3002</p>"},{"location":"kubernetes_monitor/prometheus/#_2","title":"\u5b89\u88c5","text":"<p>\u7531\u4e8e Prometheus \u662f Golang \u7f16\u5199\u7684\u7a0b\u5e8f\uff0c\u6240\u4ee5\u8981\u5b89\u88c5\u7684\u8bdd\u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5c06\u4e8c\u8fdb\u5236\u6587\u4ef6\u4e0b\u8f7d\u4e0b\u6765\u76f4\u63a5\u6267\u884c\u5373\u53ef\uff0c\u524d\u5f80\u5730\u5740\uff1ahttps://prometheus.io/download \u4e0b\u8f7d\u6700\u65b0\u7248\u672c\u5373\u53ef\u3002</p> <p>Prometheus \u662f\u901a\u8fc7\u4e00\u4e2a YAML \u914d\u7f6e\u6587\u4ef6\u6765\u8fdb\u884c\u542f\u52a8\u7684\uff0c\u5982\u679c\u6211\u4eec\u4f7f\u7528\u4e8c\u8fdb\u5236\u7684\u65b9\u5f0f\u6765\u542f\u52a8\u7684\u8bdd\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ ./prometheus --config.file=prometheus.yml\n</code></pre> <p>\u5176\u4e2d <code>prometheus.yml</code> \u6587\u4ef6\u7684\u57fa\u672c\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>global:\n  scrape_interval:     15s\n  evaluation_interval: 15s\n\nrule_files:\n  # - \"first.rules\"\n  # - \"second.rules\"\n\nscrape_configs:\n  - job_name: prometheus\n    static_configs:\n      - targets: ['localhost:9090']\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\u4e2d\u5305\u542b\u4e863\u4e2a\u6a21\u5757\uff1a<code>global</code>\u3001<code>rule_files</code> \u548c <code>scrape_configs</code>\u3002</p> <ul> <li> <p><code>global</code> \u6a21\u5757\u63a7\u5236 <code>Prometheus Server</code> \u7684\u5168\u5c40\u914d\u7f6e\uff1a</p> <ul> <li><code>scrape_interval</code>\uff1a\u8868\u793a prometheus \u6293\u53d6\u6307\u6807\u6570\u636e\u7684\u9891\u7387\uff0c\u9ed8\u8ba4\u662f15s\uff0c\u6211\u4eec\u53ef\u4ee5\u8986\u76d6\u8fd9\u4e2a\u503c</li> <li><code>evaluation_interval</code>\uff1a\u7528\u6765\u63a7\u5236\u8bc4\u4f30\u89c4\u5219\u7684\u9891\u7387\uff0cprometheus \u4f7f\u7528\u89c4\u5219\u4ea7\u751f\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u6216\u8005\u4ea7\u751f\u8b66\u62a5</li> <li> <p><code>rule_files</code>\uff1a\u6307\u5b9a\u4e86\u62a5\u8b66\u89c4\u5219\u6240\u5728\u7684\u4f4d\u7f6e\uff0cprometheus \u53ef\u4ee5\u6839\u636e\u8fd9\u4e2a\u914d\u7f6e\u52a0\u8f7d\u89c4\u5219\uff0c\u7528\u4e8e\u751f\u6210\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u6216\u8005\u62a5\u8b66\u4fe1\u606f\uff0c\u5f53\u524d\u6211\u4eec\u6ca1\u6709\u914d\u7f6e\u4efb\u4f55\u62a5\u8b66\u89c4\u5219\u3002</p> </li> </ul> </li> <li> <p><code>scrape_configs</code> \u7528\u4e8e\u63a7\u5236 prometheus \u76d1\u63a7\u54ea\u4e9b\u8d44\u6e90\u3002</p> </li> </ul> <p>\u7531\u4e8e prometheus \u901a\u8fc7 HTTP \u7684\u65b9\u5f0f\u6765\u66b4\u9732\u7684\u5b83\u672c\u8eab\u7684\u76d1\u63a7\u6570\u636e\uff0cprometheus \u4e5f\u80fd\u591f\u76d1\u63a7\u672c\u8eab\u7684\u5065\u5eb7\u60c5\u51b5\u3002\u5728\u9ed8\u8ba4\u7684\u914d\u7f6e\u91cc\u6709\u4e00\u4e2a\u5355\u72ec\u7684 job\uff0c\u53eb\u505a prometheus\uff0c\u5b83\u91c7\u96c6 prometheus \u670d\u52a1\u672c\u8eab\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u3002\u8fd9\u4e2a job \u5305\u542b\u4e86\u4e00\u4e2a\u5355\u72ec\u7684\u3001\u9759\u6001\u914d\u7f6e\u7684\u76ee\u6807\uff1a\u76d1\u542c localhost \u4e0a\u7684 9090 \u7aef\u53e3\u3002prometheus \u9ed8\u8ba4\u4f1a\u901a\u8fc7\u76ee\u6807\u7684 <code>/metrics</code> \u8def\u5f84\u91c7\u96c6 metrics\u3002\u6240\u4ee5\uff0c\u9ed8\u8ba4\u7684 job \u901a\u8fc7 URL\uff1a</p> <pre><code>http://localhost:9090/metrics\n</code></pre> <p>\u91c7\u96c6 metrics\u3002\u6536\u96c6\u5230\u7684\u65f6\u95f4\u5e8f\u5217\u5305\u542b prometheus \u670d\u52a1\u672c\u8eab\u7684\u72b6\u6001\u548c\u6027\u80fd\u3002\u5982\u679c\u6211\u4eec\u8fd8\u6709\u5176\u4ed6\u7684\u8d44\u6e90\u9700\u8981\u76d1\u63a7\u7684\u8bdd\uff0c\u76f4\u63a5\u914d\u7f6e\u5728 <code>scrape_configs</code> \u6a21\u5757\u4e0b\u9762\u5c31\u53ef\u4ee5\u4e86\u3002</p>"},{"location":"kubernetes_monitor/prometheus/#_3","title":"\u793a\u4f8b\u5e94\u7528","text":"<p>\u6bd4\u5982\u6211\u4eec\u5728\u672c\u5730\u542f\u52a8\u4e00\u4e9b\u6837\u4f8b\u6765\u8ba9 Prometheus \u91c7\u96c6\u3002Go \u5ba2\u6237\u7aef\u5e93\u5305\u542b\u4e00\u4e2a\u793a\u4f8b\uff0c\u8be5\u793a\u4f8b\u4e3a\u5177\u6709\u4e0d\u540c\u5ef6\u8fdf\u5206\u5e03\u7684\u4e09\u4e2a\u670d\u52a1\u66b4\u9732 RPC \u5ef6\u8fdf\u3002</p> <p>\u9996\u5148\u786e\u4fdd\u5df2\u7ecf\u5b89\u88c5\u4e86 Go \u73af\u5883\u5e76\u542f\u7528 go modules\uff0c\u4e0b\u8f7d Prometheus \u7684 Go \u5ba2\u6237\u7aef\u5e93\u5e76\u8fd0\u884c\u8fd9\u4e09\u4e2a\u793a\u4f8b\uff1a</p> <pre><code>$ git clone https://github.com/prometheus/client_golang.git\n$ cd client_golang/examples/random\n$ export GO111MODULE=on   \n$ export GOPROXY=https://goproxy.cn\n$ go build\n</code></pre> <p>\u7136\u540e\u57283\u4e2a\u72ec\u7acb\u7684\u7ec8\u7aef\u91cc\u9762\u8fd0\u884c3\u4e2a\u670d\u52a1\uff1a</p> <pre><code>$ ./random -listen-address=:8080\n$ ./random -listen-address=:8081\n$ ./random -listen-address=:8082\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u5f97\u52303\u4e2a\u4e0d\u540c\u7684\u76d1\u63a7\u63a5\u53e3\uff1ahttp://localhost:8080/metrics\u3001http://localhost:8081/metrics \u548c http://localhost:8082/metrics\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u914d\u7f6e Prometheus \u6765\u91c7\u96c6\u8fd9\u4e9b\u65b0\u7684\u76ee\u6807\uff0c\u8ba9\u6211\u4eec\u5c06\u8fd9\u4e09\u4e2a\u76ee\u6807\u5206\u7ec4\u5230\u4e00\u4e2a\u540d\u4e3a example-random \u7684\u4efb\u52a1\u3002\u5047\u8bbe\u524d\u4e24\u4e2a\u7aef\u70b9\uff08\u5373\uff1ahttp://localhost:8080/metrics\u3001http://localhost:8081/metrics \uff09\u90fd\u662f\u751f\u4ea7\u7ea7\u76ee\u6807\u5e94\u7528\uff0c\u7b2c\u4e09\u4e2a\u7aef\u70b9\uff08\u5373\uff1ahttp://localhost:8082/metrics \uff09\u4e3a\u91d1\u4e1d\u96c0\u5b9e\u4f8b\u3002\u8981\u5728 Prometheus \u4e2d\u5bf9\u6b64\u8fdb\u884c\u5efa\u6a21\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u591a\u7ec4\u7aef\u70b9\u6dfb\u52a0\u5230\u5355\u4e2a\u4efb\u52a1\u4e2d\uff0c\u4e3a\u6bcf\u7ec4\u76ee\u6807\u6dfb\u52a0\u989d\u5916\u7684\u6807\u7b7e\u3002 \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u5c06 <code>group =production</code> \u6807\u7b7e\u6dfb\u52a0\u5230\u7b2c\u4e00\u7ec4\u76ee\u6807\uff0c\u540c\u65f6\u5c06 <code>group=canary</code>\u6dfb\u52a0\u5230\u7b2c\u4e8c\u7ec4\u3002\u5c06\u4ee5\u4e0b\u914d\u7f6e\u6dfb\u52a0\u5230 <code>prometheus.yml</code> \u4e2d\u7684 <code>scrape_configs</code> \u90e8\u5206\uff0c\u7136\u540e\u91cd\u65b0\u542f\u52a8 Prometheus \u5b9e\u4f8b\uff1a</p> <pre><code>scrape_configs:\n  - job_name: 'example-random'\n    # Override the global default and scrape targets from this job every 5 seconds.\n    scrape_interval: 5s\n    static_configs:\n      - targets: ['localhost:8080', 'localhost:8081']\n        labels:\n          group: 'production'\n      - targets: ['localhost:8082']\n        labels:\n          group: 'canary'\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u5230\u6d4f\u89c8\u5668\u4e2d\u67e5\u770b Prometheus \u7684\u914d\u7f6e\u662f\u5426\u6709\u65b0\u589e\u7684\u4efb\u52a1\uff0c\u8fd9\u5c31\u662f Prometheus \u6dfb\u52a0\u76d1\u63a7\u914d\u7f6e\u6700\u57fa\u672c\u7684\u914d\u7f6e\u65b9\u5f0f\u4e86\uff0c\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u63d0\u4f9b\u4e00\u4e2a\u7b26\u5408 metrics \u683c\u5f0f\u7684\u53ef\u8bbf\u95ee\u7684\u63a5\u53e3\u914d\u7f6e\u7ed9 Prometheus \u5c31\u53ef\u4ee5\u4e86\u3002</p> <p>\u4f46\u662f\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u662f\u8981\u8fd0\u884c\u5728 Kubernetes \u7cfb\u7edf\u4e2d\uff0c\u6240\u4ee5\u6211\u4eec\u76f4\u63a5\u7528 Docker \u955c\u50cf\u7684\u65b9\u5f0f\u8fd0\u884c\u3002</p> <p>\u547d\u540d\u7a7a\u95f4</p> <p>\u4e3a\u4e86\u65b9\u4fbf\u7ba1\u7406\uff0c\u6211\u4eec\u5c06\u76d1\u63a7\u76f8\u5173\u7684\u6240\u6709\u8d44\u6e90\u5bf9\u8c61\u90fd\u5b89\u88c5\u5728 <code>kube-mon</code> \u8fd9\u4e2a namespace \u4e0b\u9762\uff0c\u6ca1\u6709\u7684\u8bdd\u53ef\u4ee5\u63d0\u524d\u521b\u5efa\u3002</p> <p>\u4e3a\u4e86\u80fd\u591f\u65b9\u4fbf\u7684\u7ba1\u7406\u914d\u7f6e\u6587\u4ef6\uff0c\u6211\u4eec\u8fd9\u91cc\u5c06 <code>prometheus.yml</code> \u6587\u4ef6\u7528 ConfigMap \u7684\u5f62\u5f0f\u8fdb\u884c\u7ba1\u7406\uff1a\uff08prometheus-cm.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n  namespace: kube-mon\ndata:\n  prometheus.yml: |\n    global:\n      scrape_interval: 15s\n      scrape_timeout: 15s\n    scrape_configs:\n    - job_name: 'prometheus'\n      static_configs:\n      - targets: ['localhost:9090']\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u6682\u65f6\u53ea\u914d\u7f6e\u4e86\u5bf9 prometheus \u672c\u8eab\u7684\u76d1\u63a7\uff0c\u76f4\u63a5\u521b\u5efa\u8be5\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f prometheus-cm.yaml\nconfigmap \"prometheus-config\" created\n</code></pre> <p>\u914d\u7f6e\u6587\u4ef6\u521b\u5efa\u5b8c\u6210\u4e86\uff0c\u4ee5\u540e\u5982\u679c\u6211\u4eec\u6709\u65b0\u7684\u8d44\u6e90\u9700\u8981\u88ab\u76d1\u63a7\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5c06\u4e0a\u9762\u7684 ConfigMap \u5bf9\u8c61\u66f4\u65b0\u5373\u53ef\u3002\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa prometheus \u7684 Pod \u8d44\u6e90\uff1a(prometheus-deploy.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: prometheus\n  namespace: kube-mon\n  labels:\n    app: prometheus\nspec:\n  selector:\n    matchLabels:\n      app: prometheus\n  template:\n    metadata:\n      labels:\n        app: prometheus\n    spec:\n      serviceAccountName: prometheus\n      nodeSelector:\n        monitor: prometheus\n      containers:\n      - image: prom/prometheus:v0\n        name: prometheus\n        args:\n        - \"--config.file=/etc/prometheus/prometheus.yml\"\n        - \"--storage.tsdb.path=/prometheus\"  # \u6307\u5b9atsdb\u6570\u636e\u8def\u5f84\n        - \"--storage.tsdb.retention.time=24h\"\n        - \"--web.enable-admin-api\"  # \u63a7\u5236\u5bf9admin HTTP API\u7684\u8bbf\u95ee\uff0c\u5176\u4e2d\u5305\u62ec\u5220\u9664\u65f6\u95f4\u5e8f\u5217\u7b49\u529f\u80fd\n        - \"--web.enable-lifecycle\"  # \u652f\u6301\u70ed\u66f4\u65b0\uff0c\u76f4\u63a5\u6267\u884clocalhost:9090/-/reload\u7acb\u5373\u751f\u6548\n        - \"--web.console.libraries=/usr/share/prometheus/console_libraries\"\n        - \"--web.console.templates=/usr/share/prometheus/consoles\"\n        ports:\n        - containerPort: 9090\n          name: http\n        volumeMounts:\n        - mountPath: \"/etc/prometheus\"\n          name: config-volume\n        - mountPath: \"/prometheus\"\n          name: data\n        resources:\n          requests:\n            cpu: 100m\n            memory: 512Mi\n          limits:\n            cpu: 100m\n            memory: 512Mi\n      volumes:\n      - name: data\n        hostPath:\n          path: /data/prometheus/\n      - configMap:\n          name: prometheus-config\n        name: config-volume\n</code></pre> <p>\u53e6\u5916\u4e3a\u4e86 prometheus \u7684\u6027\u80fd\u548c\u6570\u636e\u6301\u4e45\u5316\u6211\u4eec\u8fd9\u91cc\u662f\u76f4\u63a5\u5c06\u901a\u8fc7 hostPath \u7684\u65b9\u5f0f\u6765\u8fdb\u884c\u6570\u636e\u6301\u4e45\u5316\u7684\uff0c\u901a\u8fc7 </p> <pre><code>--storage.tsdb.path=/prometheus\n</code></pre> <p>\u6307\u5b9a\u6570\u636e\u76ee\u5f55\uff0c\u7136\u540e\u5c06\u8be5\u76ee\u5f55\u58f0\u660e\u6302\u8f7d\u5230 <code>/data/prometheus</code> \u8fd9\u4e2a\u4e3b\u673a\u76ee\u5f55\u4e0b\u9762\uff0c\u4e3a\u4e86\u9632\u6b62 Pod \u6f02\u79fb\uff0c\u6240\u4ee5\u6211\u4eec\u4f7f\u7528 <code>nodeSelector</code> \u5c06 Pod \u56fa\u5b9a\u5230\u4e86\u4e00\u4e2a\u5177\u6709 <code>monitor=prometheus</code> \u6807\u7b7e\u7684\u8282\u70b9\u4e0a\uff0c\u5982\u679c\u6ca1\u6709\u8fd9\u4e2a\u6807\u7b7e\u5219\u9700\u8981\u4e3a\u4f60\u7684\u76ee\u6807\u8282\u70b9\u6253\u4e0a\u8fd9\u4e2a\u6807\u7b7e\uff1a</p> <pre><code>$ kubectl label node ydzs-node3 monitor=prometheus\nnode/ydzs-node3 labeled\n</code></pre> <p>\u7531\u4e8e prometheus \u53ef\u4ee5\u8bbf\u95ee Kubernetes \u7684\u4e00\u4e9b\u8d44\u6e90\u5bf9\u8c61\uff0c\u6240\u4ee5\u9700\u8981\u914d\u7f6e rbac \u76f8\u5173\u8ba4\u8bc1\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e86\u4e00\u4e2a\u540d\u4e3a prometheus \u7684 serviceAccount \u5bf9\u8c61\uff1a(prometheus-rbac.yaml)</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus\n  namespace: kube-mon\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: prometheus\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - nodes\n  - services\n  - endpoints\n  - pods\n  - nodes/proxy\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - \"extensions\"\n  resources:\n    - ingresses\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - \"\"\n  resources:\n  - configmaps\n  - nodes/metrics\n  verbs:\n  - get\n- nonResourceURLs:\n  - /metrics\n  verbs:\n  - get\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: prometheus\nsubjects:\n- kind: ServiceAccount\n  name: prometheus\n  namespace: kube-mon\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u8981\u83b7\u53d6\u7684\u8d44\u6e90\u4fe1\u606f\uff0c\u5728\u6bcf\u4e00\u4e2a namespace \u4e0b\u9762\u90fd\u6709\u53ef\u80fd\u5b58\u5728\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f <code>ClusterRole</code> \u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u503c\u5f97\u4e00\u63d0\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u7684\u6743\u9650\u89c4\u5219\u58f0\u660e\u4e2d\u6709\u4e00\u4e2a <code>nonResourceURLs</code> \u7684\u5c5e\u6027\uff0c\u662f\u7528\u6765\u5bf9\u975e\u8d44\u6e90\u578b metrics \u8fdb\u884c\u64cd\u4f5c\u7684\u6743\u9650\u58f0\u660e\uff0c\u8fd9\u4e2a\u5728\u4ee5\u524d\u6211\u4eec\u5f88\u5c11\u9047\u5230\u8fc7\uff0c\u7136\u540e\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f prometheus-rbac.yaml\nserviceaccount \"prometheus\" created\nclusterrole.rbac.authorization.k8s.io \"prometheus\" created\nclusterrolebinding.rbac.authorization.k8s.io \"prometheus\" created\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u6dfb\u52a0 promethues \u7684\u8d44\u6e90\u5bf9\u8c61\u4e86\uff1a</p> <pre><code>$ kubectl apply -f prometheus-deploy.yaml \ndeployment.apps/prometheus created\n$ kubectl get pods -n kube-mon\nNAME                         READY   STATUS             RESTARTS   AGE\nprometheus-df4f47d95-vksmc   0/1     CrashLoopBackOff   3          98s\n$ kubectl logs -f prometheus-df4f47d95-vksmc -n kube-mon\nlevel=info ts=2019-12-12T03:08:424Z caller=main.go:332 msg=\"Starting Prometheus\" version=\"(version=0, branch=HEAD, revision=edeb7a44cbf745f1d8be4ea6f215e79e651bfe19)\"\nlevel=info ts=2019-12-12T03:08:424Z caller=main.go:333 build_context=\"(go=go4, user=root@df2327081015, date=20191111-14:27:12)\"\nlevel=info ts=2019-12-12T03:08:425Z caller=main.go:334 host_details=\"(Linux 0-10elx86_64 #1 SMP Fri Oct 18 17:15:30 UTC 2019 x86_64 prometheus-df4f47d95-vksmc (none))\"\nlevel=info ts=2019-12-12T03:08:425Z caller=main.go:335 fd_limits=\"(soft=1048576, hard=1048576)\"\nlevel=info ts=2019-12-12T03:08:425Z caller=main.go:336 vm_limits=\"(soft=unlimited, hard=unlimited)\"\nlevel=error ts=2019-12-12T03:08:425Z caller=query_logger.go:85 component=activeQueryTracker msg=\"Error opening query log file\" file=/prometheus/queries.active err=\"open /prometheus/queries.active: permission denied\"\npanic: Unable to create mmap-ed active query log\n\ngoroutine 1 [running]:\ngithub.com/prometheus/prometheus/promql.NewActiveQueryTracker(0x7ffd8cf6ec5d, 0xb, 0x14, 0x2b4f400, 0xc0006f33b0, 0x2b4f400)\n        /app/promql/query_logger.go:115 +0x48c\nmain.main()\n        /app/cmd/prometheus/main.go:364 +0x5229\n</code></pre> <p>\u521b\u5efa Pod \u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5e76\u6ca1\u6709\u6210\u529f\u8fd0\u884c\uff0c\u51fa\u73b0\u4e86 </p> <pre><code>open /prometheus/queries.active: permission denied\n</code></pre> <p>\u8fd9\u6837\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u7684 prometheus \u7684\u955c\u50cf\u4e2d\u662f\u4f7f\u7528\u7684 nobody \u8fd9\u4e2a\u7528\u6237\uff0c\u7136\u540e\u73b0\u5728\u6211\u4eec\u901a\u8fc7 hostPath \u6302\u8f7d\u5230\u5bbf\u4e3b\u673a\u4e0a\u9762\u7684\u76ee\u5f55\u7684 <code>ownership</code> \u5374\u662f <code>root</code>\uff1a</p> <pre><code>$ ls -la /data/\ntotal 36\ndrwxr-xr-x   6 root root  4096 Dec 12 11:07 .\ndr-xr-xr-x. 19 root root  4096 Nov  9 23:19 ..\ndrwxr-xr-x   2 root root  4096 Dec 12 11:07 prometheus\n</code></pre> <p>\u6240\u4ee5\u5f53\u7136\u4f1a\u51fa\u73b0\u64cd\u4f5c\u6743\u9650\u95ee\u9898\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>securityContext</code> \u6765\u4e3a Pod \u8bbe\u7f6e\u4e0b volumes \u7684\u6743\u9650\uff0c\u901a\u8fc7\u8bbe\u7f6e <code>runAsUser=0</code> \u6307\u5b9a\u8fd0\u884c\u7684\u7528\u6237\u4e3a root\uff1a</p> <pre><code>......\nsecurityContext:\n  runAsUser: 0\nvolumes:\n- name: data\n  hostPath:\n    path: /data/prometheus/\n- configMap:\n    name: prometheus-config\n  name: config-volume\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u91cd\u65b0\u66f4\u65b0\u4e0b prometheus\uff1a</p> <pre><code>$ kubectl apply -f prometheus-deploy.yaml\ndeployment.apps/prometheus configured\n$ kubectl get pods -n kube-mon                              \nNAME                          READY   STATUS    RESTARTS   AGE\nprometheus-79b8774f68-7m8zr   1/1     Running   0          56s\n$ kubectl logs -f prometheus-79b8774f68-7m8zr -n kube-mon\nlevel=info ts=2019-12-12T03:17:228Z caller=main.go:332 msg=\"Starting Prometheus\" version=\"(version=0, branch=HEAD, revision=edeb7a44cbf745f1d8be4ea6f215e79e651bfe19)\"\n......\nlevel=info ts=2019-12-12T03:17:822Z caller=main.go:673 msg=\"TSDB started\"\nlevel=info ts=2019-12-12T03:17:822Z caller=main.go:743 msg=\"Loading configuration file\" filename=/etc/prometheus/prometheus.yml\nlevel=info ts=2019-12-12T03:17:827Z caller=main.go:771 msg=\"Completed loading of configuration file\" filename=/etc/prometheus/prometheus.yml\nlevel=info ts=2019-12-12T03:17:827Z caller=main.go:626 msg=\"Server is ready to receive web requests.\"\n</code></pre> <p>Pod \u521b\u5efa\u6210\u529f\u540e\uff0c\u4e3a\u4e86\u80fd\u591f\u5728\u5916\u90e8\u8bbf\u95ee\u5230 prometheus \u7684 webui \u670d\u52a1\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u521b\u5efa\u4e00\u4e2a Service \u5bf9\u8c61\uff1a(prometheus-svc.yaml)</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: prometheus\n  namespace: kube-mon\n  labels:\n    app: prometheus\nspec:\n  selector:\n    app: prometheus\n  type: NodePort\n  ports:\n    - name: web\n      port: 9090\n      targetPort: http\n</code></pre> <p>\u4e3a\u4e86\u65b9\u4fbf\u6d4b\u8bd5\uff0c\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u4e00\u4e2a <code>NodePort</code> \u7c7b\u578b\u7684\u670d\u52a1\uff0c\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a <code>Ingress</code>\u5bf9\u8c61\uff0c\u901a\u8fc7\u57df\u540d\u6765\u8fdb\u884c\u8bbf\u95ee\uff1a</p> <pre><code>$ $ kubectl apply -f prometheus-svc.yaml\nservice \"prometheus\" created\n$ kubectl get svc -n kube-mon\nNAME         TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE\nprometheus   NodePort   129   &lt;none&gt;        9090:30980/TCP   13h\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>http://\u4efb\u610f\u8282\u70b9IP:30980</code> \u8bbf\u95ee prometheus \u7684 webui \u670d\u52a1\u4e86\uff1a</p> <p></p> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u76d1\u63a7\u7cfb\u7edf\u4e2d\u7684\u4e00\u4e9b\u76d1\u63a7\u76ee\u6807\uff08Status -&gt; Targets\uff09\uff1a</p> <p></p> <p>\u7531\u4e8e\u6211\u4eec\u73b0\u5728\u8fd8\u6ca1\u6709\u914d\u7f6e\u4efb\u4f55\u7684\u62a5\u8b66\u4fe1\u606f\uff0c\u6240\u4ee5 <code>Alerts</code> \u83dc\u5355\u4e0b\u9762\u73b0\u5728\u6ca1\u6709\u4efb\u4f55\u6570\u636e\uff0c\u9694\u4e00\u4f1a\u513f\uff0c\u6211\u4eec\u53ef\u4ee5\u53bb <code>Graph</code> \u83dc\u5355\u4e0b\u9762\u67e5\u770b\u6211\u4eec\u6293\u53d6\u7684 prometheus \u672c\u8eab\u7684\u4e00\u4e9b\u76d1\u63a7\u6570\u636e\u4e86\uff0c\u5176\u4e2d</p> <pre><code>- insert metrics at cursor -\n</code></pre> <p>\u4e0b\u9762\u5c31\u6709\u6211\u4eec\u641c\u96c6\u5230\u7684\u4e00\u4e9b\u76d1\u63a7\u6307\u6807\u6570\u636e\uff1a</p> <p></p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5c31\u9009\u62e9 </p> <pre><code>scrape_duration_seconds\n</code></pre> <p>\u8fd9\u4e2a\u6307\u6807\uff0c\u7136\u540e\u70b9\u51fb <code>Execute</code>\uff0c\u5c31\u53ef\u4ee5\u770b\u5230\u7c7b\u4f3c\u4e8e\u4e0b\u9762\u7684\u56fe\u8868\u6570\u636e\u4e86\uff1a</p> <p></p> <p>\u9664\u4e86\u7b80\u5355\u7684\u76f4\u63a5\u4f7f\u7528\u91c7\u96c6\u5230\u7684\u4e00\u4e9b\u76d1\u63a7\u6307\u6807\u6570\u636e\u4e4b\u5916\uff0c\u8fd9\u4e2a\u65f6\u5019\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5f3a\u5927\u7684 <code>PromQL</code> \u5de5\u5177\uff0c<code>PromQL</code> \u5176\u5b9e\u5c31\u662f prometheus \u4fbf\u4e8e\u6570\u636e\u805a\u5408\u5c55\u793a\u5f00\u53d1\u7684\u4e00\u5957 <code>ad hoc</code> \u67e5\u8be2\u8bed\u8a00\u7684\uff0c\u4f60\u60f3\u8981\u67e5\u4ec0\u4e48\u627e\u5bf9\u5e94\u51fd\u6570\u53d6\u4f60\u7684\u6570\u636e\u597d\u4e86\u3002</p>"},{"location":"kubernetes_monitor/prometheus/#_4","title":"\u5e94\u7528\u76d1\u63a7","text":"<p>\u524d\u9762\u6211\u4eec\u548c\u5927\u5bb6\u4ecb\u7ecd\u4e86 Prometheus \u7684\u6570\u636e\u6307\u6807\u662f\u901a\u8fc7\u4e00\u4e2a\u516c\u5f00\u7684 HTTP(S) \u6570\u636e\u63a5\u53e3\u83b7\u53d6\u5230\u7684\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u5355\u72ec\u5b89\u88c5\u76d1\u63a7\u7684 agent\uff0c\u53ea\u9700\u8981\u66b4\u9732\u4e00\u4e2a metrics \u63a5\u53e3\uff0cPrometheus \u5c31\u4f1a\u5b9a\u671f\u53bb\u62c9\u53d6\u6570\u636e\uff1b\u5bf9\u4e8e\u4e00\u4e9b\u666e\u901a\u7684 HTTP \u670d\u52a1\uff0c\u6211\u4eec\u5b8c\u5168\u53ef\u4ee5\u76f4\u63a5\u91cd\u7528\u8fd9\u4e2a\u670d\u52a1\uff0c\u6dfb\u52a0\u4e00\u4e2a <code>/metrics</code> \u63a5\u53e3\u66b4\u9732\u7ed9 Prometheus\uff1b\u800c\u4e14\u83b7\u53d6\u5230\u7684\u6307\u6807\u6570\u636e\u683c\u5f0f\u662f\u975e\u5e38\u6613\u61c2\u7684\uff0c\u4e0d\u9700\u8981\u592a\u9ad8\u7684\u5b66\u4e60\u6210\u672c\u3002</p> <p>\u73b0\u5728\u5f88\u591a\u670d\u52a1\u4ece\u4e00\u5f00\u59cb\u5c31\u5185\u7f6e\u4e86\u4e00\u4e2a <code>/metrics</code> \u63a5\u53e3\uff0c\u6bd4\u5982 Kubernetes \u7684\u5404\u4e2a\u7ec4\u4ef6\u3001istio \u670d\u52a1\u7f51\u683c\u90fd\u76f4\u63a5\u63d0\u4f9b\u4e86\u6570\u636e\u6307\u6807\u63a5\u53e3\u3002\u6709\u4e00\u4e9b\u670d\u52a1\u5373\u4f7f\u6ca1\u6709\u539f\u751f\u96c6\u6210\u8be5\u63a5\u53e3\uff0c\u4e5f\u5b8c\u5168\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e9b <code>exporter</code> \u6765\u83b7\u53d6\u5230\u6307\u6807\u6570\u636e\uff0c\u6bd4\u5982 <code>mysqld_exporter</code>\u3001<code>node_exporter</code>\uff0c\u8fd9\u4e9b <code>exporter</code> \u5c31\u6709\u70b9\u7c7b\u4f3c\u4e8e\u4f20\u7edf\u76d1\u63a7\u670d\u52a1\u4e2d\u7684 agent\uff0c\u4f5c\u4e3a\u670d\u52a1\u4e00\u76f4\u5b58\u5728\uff0c\u7528\u6765\u6536\u96c6\u76ee\u6807\u670d\u52a1\u7684\u6307\u6807\u6570\u636e\u7136\u540e\u76f4\u63a5\u66b4\u9732\u7ed9 Prometheus\u3002</p>"},{"location":"kubernetes_monitor/prometheus/#_5","title":"\u666e\u901a\u5e94\u7528","text":"<p>\u5bf9\u4e8e\u666e\u901a\u5e94\u7528\u53ea\u9700\u8981\u80fd\u591f\u63d0\u4f9b\u4e00\u4e2a\u6ee1\u8db3 prometheus \u683c\u5f0f\u8981\u6c42\u7684 <code>/metrics</code> \u63a5\u53e3\u5c31\u53ef\u4ee5\u8ba9 Prometheus \u6765\u63a5\u7ba1\u76d1\u63a7\uff0c\u6bd4\u5982 Kubernetes \u96c6\u7fa4\u4e2d\u975e\u5e38\u91cd\u8981\u7684 CoreDNS \u63d2\u4ef6\uff0c\u4e00\u822c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5c31\u5f00\u542f\u4e86 <code>/metrics</code> \u63a5\u53e3\uff1a</p> <pre><code>$ kubectl get cm coredns -n kube-system -o yaml\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health\n        ready\n        kubernetes cluster.local in-addr.arpa iparpa {\n           pods insecure\n           fallthrough in-addr.arpa iparpa\n           ttl 30\n        }\n        prometheus :9153\n        forward . /etc/resolv.conf\n        cache 30\n        loop\n        reload\n        loadbalance\n    }\nkind: ConfigMap\nmetadata:\n  creationTimestamp: \"2019-11-08T11:59:49Z\"\n  name: coredns\n  namespace: kube-system\n  resourceVersion: \"188\"\n  selfLink: /api/v1/namespaces/kube-system/configmaps/coredns\n  uid: 21966186-c2d9-467a-b87f-d061c5c9e4d7\n</code></pre> <p>\u4e0a\u9762 ConfigMap \u4e2d <code>prometheus :9153</code> \u5c31\u662f\u5f00\u542f prometheus \u7684\u63d2\u4ef6\uff1a</p> <pre><code>$ kubectl get pods -n kube-system -l k8s-app=kube-dns -o wide\nNAME                       READY   STATUS    RESTARTS   AGE     IP            NODE         NOMINATED NODE   READINESS GATES\ncoredns-667f964f9b-sthqq   1/1     Running   0          4d20h   215   ydzs-node1   &lt;none&gt;           &lt;none&gt;\ncoredns-667f964f9b-zj4r4   1/1     Running   0          4d20h   2127   ydzs-node3   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u5148\u5c1d\u8bd5\u624b\u52a8\u8bbf\u95ee\u4e0b <code>/metrics</code> \u63a5\u53e3\uff0c\u5982\u679c\u80fd\u591f\u624b\u52a8\u8bbf\u95ee\u5230\u90a3\u8bc1\u660e\u63a5\u53e3\u662f\u6ca1\u6709\u4efb\u4f55\u95ee\u9898\u7684\uff1a</p> <pre><code>$ curl http://215:9153/metrics\n# HELP coredns_build_info A metric with a constant '1' value labeled by version, revision, and goversion from which CoreDNS was built.\n# TYPE coredns_build_info gauge\ncoredns_build_info{goversion=\"go8\",revision=\"795a3eb\",version=\"2\"} 1\n# HELP coredns_cache_hits_total The count of cache hits.\n# TYPE coredns_cache_hits_total counter\ncoredns_cache_hits_total{server=\"dns://:53\",type=\"success\"} 4\n# HELP coredns_cache_misses_total The count of cache misses.\n# TYPE coredns_cache_misses_total counter\ncoredns_cache_misses_total{server=\"dns://:53\"} 15\n# HELP coredns_cache_size The number of elements in the cache.\n# TYPE coredns_cache_size gauge\ncoredns_cache_size{server=\"dns://:53\",type=\"denial\"} 5\ncoredns_cache_size{server=\"dns://:53\",type=\"success\"} 4\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\u5230\uff0c\u4ece\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230 CoreDNS \u7684\u76d1\u63a7\u6570\u636e\u63a5\u53e3\u662f\u6b63\u5e38\u7684\u4e86\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06\u8fd9\u4e2a <code>/metrics</code> \u63a5\u53e3\u914d\u7f6e\u5230 <code>prometheus.yml</code> \u4e2d\u53bb\u4e86\uff0c\u76f4\u63a5\u52a0\u5230\u9ed8\u8ba4\u7684 prometheus \u8fd9\u4e2a <code>job</code> \u4e0b\u9762\uff1a(prome-cm.yaml)</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n  namespace: kube-mon\ndata:\n  prometheus.yml: |\n    global:\n      scrape_interval: 15s\n      scrape_timeout: 15s\n\n    scrape_configs:\n    - job_name: 'prometheus'\n      static_configs:\n        - targets: ['localhost:9090']\n\n    - job_name: 'coredns'\n      static_configs:\n        - targets: ['215:9153', '2127:9153']\n</code></pre> <p>\u5f53\u7136\uff0c\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u4e00\u4e2a\u5f88\u7b80\u5355\u7684\u914d\u7f6e\uff0c<code>scrape_configs</code> \u4e0b\u9762\u53ef\u4ee5\u652f\u6301\u5f88\u591a\u53c2\u6570\uff0c\u4f8b\u5982\uff1a</p> <ul> <li><code>basic_auth</code> \u548c <code>bearer_token</code>\uff1a\u6bd4\u5982\u6211\u4eec\u63d0\u4f9b\u7684 <code>/metrics</code> \u63a5\u53e3\u9700\u8981 basic \u8ba4\u8bc1\u7684\u65f6\u5019\uff0c\u901a\u8fc7\u4f20\u7edf\u7684\u7528\u6237\u540d/\u5bc6\u7801\u6216\u8005\u5728\u8bf7\u6c42\u7684 header \u4e2d\u6dfb\u52a0\u5bf9\u5e94\u7684 token \u90fd\u53ef\u4ee5\u652f\u6301</li> <li> <p><code>kubernetes_sd_configs</code></p> <p>\u6216 <code>consul_sd_configs</code>\uff1a\u53ef\u4ee5\u7528\u6765\u81ea\u52a8\u53d1\u73b0\u4e00\u4e9b\u5e94\u7528\u7684\u76d1\u63a7\u6570\u636e</p> </li> </ul> <p>\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u66f4\u65b0\u8fd9\u4e2a ConfigMap \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f prometheus-cm.yaml\nconfigmap/prometheus-config configured\n</code></pre> <p>\u73b0\u5728 Prometheus \u7684\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u5df2\u7ecf\u66f4\u6539\u4e86\uff0c\u9694\u4e00\u4f1a\u513f\u88ab\u6302\u8f7d\u5230 Pod \u4e2d\u7684 prometheus.yml \u6587\u4ef6\u4e5f\u4f1a\u66f4\u65b0\uff0c\u7531\u4e8e\u6211\u4eec\u4e4b\u524d\u7684 Prometheus \u542f\u52a8\u53c2\u6570\u4e2d\u6dfb\u52a0\u4e86 </p> <pre><code>--web.enable-lifecycle\n</code></pre> <p>\u53c2\u6570\uff0c\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u53ea\u9700\u8981\u6267\u884c\u4e00\u4e2a <code>reload</code> \u547d\u4ee4\u5373\u53ef\u8ba9\u914d\u7f6e\u751f\u6548\uff1a</p> <pre><code>$ kubectl get pods -n kube-mon -o wide\nNAME                          READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES\nprometheus-79b8774f68-7m8zr   1/1     Running   0          28m   2174   ydzs-node3   &lt;none&gt;           &lt;none&gt;\n$ curl -X POST \"http://2174:9090/-/reload\"\n</code></pre> <p>\u70ed\u66f4\u65b0</p> <p>\u7531\u4e8e ConfigMap \u901a\u8fc7 Volume \u7684\u5f62\u5f0f\u6302\u8f7d\u5230 Pod \u4e2d\u53bb\u7684\u70ed\u66f4\u65b0\u9700\u8981\u4e00\u5b9a\u7684\u95f4\u9694\u65f6\u95f4\u624d\u4f1a\u751f\u6548\uff0c\u6240\u4ee5\u9700\u8981\u7a0d\u5fae\u7b49\u4e00\u5c0f\u4f1a\u513f\u3002</p> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u53bb\u770b Prometheus \u7684 Dashboard \u4e2d\u67e5\u770b\u91c7\u96c6\u7684\u76ee\u6807\u6570\u636e\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u521a\u521a\u6dfb\u52a0\u7684 coredns \u8fd9\u4e2a\u4efb\u52a1\u5df2\u7ecf\u51fa\u73b0\u4e86\uff0c\u7136\u540e\u540c\u6837\u7684\u6211\u4eec\u53ef\u4ee5\u5207\u6362\u5230 Graph \u4e0b\u9762\u53bb\uff0c\u6211\u4eec\u53ef\u4ee5\u627e\u5230\u4e00\u4e9b CoreDNS \u7684\u6307\u6807\u6570\u636e\uff0c\u81f3\u4e8e\u8fd9\u4e9b\u6307\u6807\u6570\u636e\u4ee3\u8868\u4ec0\u4e48\u610f\u4e49\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u53bb\u67e5\u770b\u5bf9\u5e94\u7684 <code>/metrics</code> \u63a5\u53e3\uff0c\u91cc\u9762\u4e00\u822c\u60c5\u51b5\u4e0b\u90fd\u4f1a\u6709\u5bf9\u5e94\u7684\u6ce8\u91ca\u3002</p> <p></p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5728 Prometheus \u4e0a\u914d\u7f6e\u4e86\u7b2c\u4e00\u4e2a Kubernetes \u5e94\u7528\u3002</p>"},{"location":"kubernetes_monitor/prometheus/#exporter","title":"\u4f7f\u7528 exporter \u76d1\u63a7","text":"<p>\u4e0a\u9762\u6211\u4eec\u4e5f\u8bf4\u8fc7\u6709\u4e00\u4e9b\u5e94\u7528\u53ef\u80fd\u6ca1\u6709\u81ea\u5e26 <code>/metrics</code> \u63a5\u53e3\u4f9b Prometheus \u4f7f\u7528\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5c31\u9700\u8981\u5229\u7528 <code>exporter</code> \u670d\u52a1\u6765\u4e3a Prometheus \u63d0\u4f9b\u6307\u6807\u6570\u636e\u4e86\u3002Prometheus \u5b98\u65b9\u4e3a\u8bb8\u591a\u5e94\u7528\u5c31\u63d0\u4f9b\u4e86\u5bf9\u5e94\u7684 <code>exporter</code> \u5e94\u7528\uff0c\u4e5f\u6709\u8bb8\u591a\u7b2c\u4e09\u65b9\u7684\u5b9e\u73b0\uff0c\u6211\u4eec\u53ef\u4ee5\u524d\u5f80\u5b98\u65b9\u7f51\u7ad9\u8fdb\u884c\u67e5\u770b\uff1aexporters\uff0c\u5f53\u7136\u5982\u679c\u4f60\u7684\u5e94\u7528\u672c\u8eab\u4e5f\u6ca1\u6709 exporter \u5b9e\u73b0\uff0c\u90a3\u4e48\u5c31\u8981\u6211\u4eec\u81ea\u5df1\u60f3\u529e\u6cd5\u53bb\u5b9e\u73b0\u4e00\u4e2a <code>/metrics</code> \u63a5\u53e3\u4e86\uff0c\u53ea\u8981\u4f60\u80fd\u63d0\u4f9b\u4e00\u4e2a\u5408\u6cd5\u7684 <code>/metrics</code> \u63a5\u53e3\uff0cPrometheus \u5c31\u53ef\u4ee5\u76d1\u63a7\u4f60\u7684\u5e94\u7528\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u901a\u8fc7\u4e00\u4e2a redis-exporter \u7684\u670d\u52a1\u6765\u76d1\u63a7 redis \u670d\u52a1\uff0c\u5bf9\u4e8e\u8fd9\u7c7b\u5e94\u7528\uff0c\u6211\u4eec\u4e00\u822c\u4f1a\u4ee5 <code>sidecar</code> \u7684\u5f62\u5f0f\u548c\u4e3b\u5e94\u7528\u90e8\u7f72\u5728\u540c\u4e00\u4e2a Pod \u4e2d\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u6765\u90e8\u7f72\u4e00\u4e2a redis \u5e94\u7528\uff0c\u5e76\u7528 redis-exporter \u7684\u65b9\u5f0f\u6765\u91c7\u96c6\u76d1\u63a7\u6570\u636e\u4f9b Prometheus \u4f7f\u7528\uff0c\u5982\u4e0b\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a\uff08prome-redis.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: redis\n  namespace: kube-mon\nspec:\n  selector:\n    matchLabels:\n      app: redis\n  template:\n    metadata:\n      annotations:\n        prometheus.io/scrape: \"true\"\n        prometheus.io/port: \"9121\"\n      labels:\n        app: redis\n    spec:\n      containers:\n      - name: redis\n        image: redis:4\n        resources:\n          requests:\n            cpu: 100m\n            memory: 100Mi\n        ports:\n        - containerPort: 6379\n      - name: redis-exporter\n        image: oliver006/redis_exporter:latest\n        resources:\n          requests:\n            cpu: 100m\n            memory: 100Mi\n        ports:\n        - containerPort: 9121\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: redis\n  namespace: kube-mon\nspec:\n  selector:\n    app: redis\n  ports:\n  - name: redis\n    port: 6379\n    targetPort: 6379\n  - name: prom\n    port: 9121\n    targetPort: 9121\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u6211\u4eec\u5728 redis \u8fd9\u4e2a Pod \u4e2d\u5305\u542b\u4e86\u4e24\u4e2a\u5bb9\u5668\uff0c\u4e00\u4e2a\u5c31\u662f redis \u672c\u8eab\u7684\u4e3b\u5e94\u7528\uff0c\u53e6\u5916\u4e00\u4e2a\u5bb9\u5668\u5c31\u662f redis_exporter\u3002\u73b0\u5728\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u5e94\u7528\uff1a</p> <pre><code>$ kubectl apply -f prome-redis.yaml\ndeployment.apps/redis created\nservice/redis created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 redis \u7684 Pod \u91cc\u9762\u5305\u542b\u6709\u4e24\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>$ kubectl get pods -n kube-mon\nNAME                          READY   STATUS    RESTARTS   AGE\nprometheus-79b8774f68-7m8zr   1/1     Running   0          54m\nredis-7c8bdd45cc-ssjbz        2/2     Running   0          2m1s\n$ kubectl get svc -n kube-mon\nNAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE\nprometheus   NodePort    129   &lt;none&gt;        9090:30980/TCP      15h\nredis        ClusterIP   169   &lt;none&gt;        6379/TCP,9121/TCP   2m14s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 9121 \u7aef\u53e3\u6765\u6821\u9a8c\u662f\u5426\u80fd\u591f\u91c7\u96c6\u5230\u6570\u636e\uff1a</p> <pre><code>$ curl 169:9121/metrics\n# HELP go_gc_duration_seconds A summary of the GC invocation durations.\n# TYPE go_gc_duration_seconds summary\ngo_gc_duration_seconds{quantile=\"0\"} 0\ngo_gc_duration_seconds{quantile=\"25\"} 0\ngo_gc_duration_seconds{quantile=\"5\"} 0\ngo_gc_duration_seconds{quantile=\"75\"} 0\ngo_gc_duration_seconds{quantile=\"1\"} 0\ngo_gc_duration_seconds_sum 0\ngo_gc_duration_seconds_count 0\n......\n# HELP redis_up Information about the Redis instance\n# TYPE redis_up gauge\nredis_up 1\n# HELP redis_uptime_in_seconds uptime_in_seconds metric\n# TYPE redis_uptime_in_seconds gauge\nredis_uptime_in_seconds 100\n</code></pre> <p>\u540c\u6837\u7684\uff0c\u73b0\u5728\u6211\u4eec\u53ea\u9700\u8981\u66f4\u65b0 Prometheus \u7684\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>- job_name: 'redis'\n  static_configs:\n  - targets: ['redis:9121']\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u662f\u901a\u8fc7 Service \u53bb\u914d\u7f6e\u7684 redis \u670d\u52a1\uff0c\u5f53\u7136\u76f4\u63a5\u914d\u7f6e Pod IP \u4e5f\u662f\u53ef\u4ee5\u7684\uff0c\u56e0\u4e3a\u548c Prometheus \u5904\u4e8e\u540c\u4e00\u4e2a namespace\uff0c\u6240\u4ee5\u6211\u4eec\u76f4\u63a5\u4f7f\u7528 servicename \u5373\u53ef\u3002\u914d\u7f6e\u6587\u4ef6\u66f4\u65b0\u540e\uff0c\u91cd\u65b0\u52a0\u8f7d\uff1a</p> <pre><code>$ kubectl apply -f prometheus-cm.yaml\nconfigmap/prometheus-config configured\n# \u9694\u4e00\u4f1a\u513f\u6267\u884creload\u64cd\u4f5c\n$ curl -X POST \"http://2174:9090/-/reload\"\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u53bb\u770b Prometheus \u7684 Dashboard \u4e2d\u67e5\u770b\u91c7\u96c6\u7684\u76ee\u6807\u6570\u636e\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u914d\u7f6e\u7684 redis \u8fd9\u4e2a job \u5df2\u7ecf\u751f\u6548\u4e86\u3002\u5207\u6362\u5230 Graph \u4e0b\u9762\u53ef\u4ee5\u770b\u5230\u5f88\u591a\u5173\u4e8e redis \u7684\u6307\u6807\u6570\u636e\uff0c\u6211\u4eec\u9009\u62e9\u4efb\u610f\u4e00\u4e2a\u6307\u6807\uff0c\u6bd4\u5982 </p> <pre><code>redis_exporter_scrapes_total\n</code></pre> <p>\uff0c\u7136\u540e\u70b9\u51fb\u6267\u884c\u5c31\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684\u6570\u636e\u56fe\u8868\u4e86\uff1a</p> <p></p>"},{"location":"kubernetes_monitor/prometheus/#_6","title":"\u96c6\u7fa4\u8282\u70b9","text":"<p>\u524d\u9762\u6211\u4eec\u548c\u5927\u5bb6\u5b66\u4e60\u4e86\u600e\u6837\u7528 Promethues \u6765\u76d1\u63a7 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u5e94\u7528\uff0c\u4f46\u662f\u5bf9\u4e8e Kubernetes \u96c6\u7fa4\u672c\u8eab\u7684\u76d1\u63a7\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u6211\u4eec\u9700\u8981\u65f6\u65f6\u523b\u523b\u4e86\u89e3\u96c6\u7fa4\u7684\u8fd0\u884c\u72b6\u6001\u3002</p> <p>\u5bf9\u4e8e\u96c6\u7fa4\u7684\u76d1\u63a7\u4e00\u822c\u6211\u4eec\u9700\u8981\u8003\u8651\u4ee5\u4e0b\u51e0\u4e2a\u65b9\u9762\uff1a</p> <ul> <li>Kubernetes \u8282\u70b9\u7684\u76d1\u63a7\uff1a\u6bd4\u5982\u8282\u70b9\u7684 cpu\u3001load\u3001disk\u3001memory \u7b49\u6307\u6807</li> <li>\u5185\u90e8\u7cfb\u7edf\u7ec4\u4ef6\u7684\u72b6\u6001\uff1a\u6bd4\u5982 kube-scheduler\u3001kube-controller-manager\u3001kubedns/coredns \u7b49\u7ec4\u4ef6\u7684\u8be6\u7ec6\u8fd0\u884c\u72b6\u6001</li> <li>\u7f16\u6392\u7ea7\u7684 metrics\uff1a\u6bd4\u5982 Deployment \u7684\u72b6\u6001\u3001\u8d44\u6e90\u8bf7\u6c42\u3001\u8c03\u5ea6\u548c API \u5ef6\u8fdf\u7b49\u6570\u636e\u6307\u6807</li> </ul> <p>Kubernetes \u96c6\u7fa4\u7684\u76d1\u63a7\u65b9\u6848\u76ee\u524d\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u79cd\u65b9\u6848\uff1a</p> <ul> <li>Heapster\uff1aHeapster \u662f\u4e00\u4e2a\u96c6\u7fa4\u8303\u56f4\u7684\u76d1\u63a7\u548c\u6570\u636e\u805a\u5408\u5de5\u5177\uff0c\u4ee5 Pod \u7684\u5f62\u5f0f\u8fd0\u884c\u5728\u96c6\u7fa4\u4e2d\u3002 heapster \u9664\u4e86 Kubelet/cAdvisor \u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u5411 Heapster \u6dfb\u52a0\u5176\u4ed6\u6307\u6807\u6e90\u6570\u636e\uff0c\u6bd4\u5982 kube-state-metrics\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f Heapster \u5df2\u7ecf\u88ab\u5e9f\u5f03\u4e86\uff0c\u540e\u7eed\u7248\u672c\u4e2d\u4f1a\u4f7f\u7528 metrics-server \u4ee3\u66ff\u3002</li> <li>cAdvisor\uff1acAdvisor \u662f Google \u5f00\u6e90\u7684\u5bb9\u5668\u8d44\u6e90\u76d1\u63a7\u548c\u6027\u80fd\u5206\u6790\u5de5\u5177\uff0c\u5b83\u662f\u4e13\u95e8\u4e3a\u5bb9\u5668\u800c\u751f\uff0c\u672c\u8eab\u4e5f\u652f\u6301 Docker \u5bb9\u5668\u3002</li> <li>kube-state-metrics\uff1akube-state-metrics \u901a\u8fc7\u76d1\u542c API Server \u751f\u6210\u6709\u5173\u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u6307\u6807\uff0c\u6bd4\u5982 Deployment\u3001Node\u3001Pod\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f kube-state-metrics \u53ea\u662f\u7b80\u5355\u63d0\u4f9b\u4e00\u4e2a metrics \u6570\u636e\uff0c\u5e76\u4e0d\u4f1a\u5b58\u50a8\u8fd9\u4e9b\u6307\u6807\u6570\u636e\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Prometheus \u6765\u6293\u53d6\u8fd9\u4e9b\u6570\u636e\u7136\u540e\u5b58\u50a8\u3002</li> <li>metrics-server\uff1ametrics-server \u4e5f\u662f\u4e00\u4e2a\u96c6\u7fa4\u8303\u56f4\u5185\u7684\u8d44\u6e90\u6570\u636e\u805a\u5408\u5de5\u5177\uff0c\u662f Heapster \u7684\u66ff\u4ee3\u54c1\uff0c\u540c\u6837\u7684\uff0cmetrics-server \u4e5f\u53ea\u662f\u663e\u793a\u6570\u636e\uff0c\u5e76\u4e0d\u63d0\u4f9b\u6570\u636e\u5b58\u50a8\u670d\u52a1\u3002</li> </ul> <p>\u4e0d\u8fc7 kube-state-metrics \u548c metrics-server \u4e4b\u95f4\u8fd8\u662f\u6709\u5f88\u5927\u4e0d\u540c\u7684\uff0c\u4e8c\u8005\u7684\u4e3b\u8981\u533a\u522b\u5982\u4e0b\uff1a</p> <ul> <li>kube-state-metrics \u4e3b\u8981\u5173\u6ce8\u7684\u662f\u4e1a\u52a1\u76f8\u5173\u7684\u4e00\u4e9b\u5143\u6570\u636e\uff0c\u6bd4\u5982 Deployment\u3001Pod\u3001\u526f\u672c\u72b6\u6001\u7b49</li> <li>metrics-server \u4e3b\u8981\u5173\u6ce8\u7684\u662f\u8d44\u6e90\u5ea6\u91cf API \u7684\u5b9e\u73b0\uff0c\u6bd4\u5982 CPU\u3001\u6587\u4ef6\u63cf\u8ff0\u7b26\u3001\u5185\u5b58\u3001\u8bf7\u6c42\u5ef6\u65f6\u7b49\u6307\u6807\u3002</li> </ul>"},{"location":"kubernetes_monitor/prometheus/#_7","title":"\u76d1\u63a7\u96c6\u7fa4\u8282\u70b9","text":"<p>\u8981\u76d1\u63a7\u8282\u70b9\u5176\u5b9e\u6211\u4eec\u5df2\u7ecf\u6709\u5f88\u591a\u975e\u5e38\u6210\u719f\u7684\u65b9\u6848\u4e86\uff0c\u6bd4\u5982 Nagios\u3001zabbix\uff0c\u751a\u81f3\u6211\u4eec\u81ea\u5df1\u6765\u6536\u96c6\u6570\u636e\u4e5f\u53ef\u4ee5\uff0c\u6211\u4eec\u8fd9\u91cc\u901a\u8fc7 Prometheus \u6765\u91c7\u96c6\u8282\u70b9\u7684\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u53ef\u4ee5\u901a\u8fc7 node_exporter \u6765\u83b7\u53d6\uff0c\u987e\u540d\u601d\u4e49\uff0c<code>node_exporter</code> \u5c31\u662f\u6293\u53d6\u7528\u4e8e\u91c7\u96c6\u670d\u52a1\u5668\u8282\u70b9\u7684\u5404\u79cd\u8fd0\u884c\u6307\u6807\uff0c\u76ee\u524d <code>node_exporter</code> \u652f\u6301\u51e0\u4e4e\u6240\u6709\u5e38\u89c1\u7684\u76d1\u63a7\u70b9\uff0c\u6bd4\u5982 conntrack\uff0ccpu\uff0cdiskstats\uff0cfilesystem\uff0cloadavg\uff0cmeminfo\uff0cnetstat \u7b49\uff0c\u8be6\u7ec6\u7684\u76d1\u63a7\u70b9\u5217\u8868\u53ef\u4ee5\u53c2\u8003\u5176 Github \u4ed3\u5e93\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 DaemonSet \u63a7\u5236\u5668\u6765\u90e8\u7f72\u8be5\u670d\u52a1\uff0c\u8fd9\u6837\u6bcf\u4e00\u4e2a\u8282\u70b9\u90fd\u4f1a\u81ea\u52a8\u8fd0\u884c\u4e00\u4e2a\u8fd9\u6837\u7684 Pod\uff0c\u5982\u679c\u6211\u4eec\u4ece\u96c6\u7fa4\u4e2d\u5220\u9664\u6216\u8005\u6dfb\u52a0\u8282\u70b9\u540e\uff0c\u4e5f\u4f1a\u8fdb\u884c\u81ea\u52a8\u6269\u5c55\u3002</p> <p>\u5728\u90e8\u7f72 <code>node-exporter</code> \u7684\u65f6\u5019\u6709\u4e00\u4e9b\u7ec6\u8282\u9700\u8981\u6ce8\u610f\uff0c\u5982\u4e0b\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a(prome-node-exporter.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: node-exporter\n  namespace: kube-mon\n  labels:\n    app: node-exporter\nspec:\n  selector:\n    matchLabels:\n      app: node-exporter\n  template:\n    metadata:\n      labels:\n        app: node-exporter\n    spec:\n      hostPID: true\n      hostIPC: true\n      hostNetwork: true\n      nodeSelector:\n        kubernetes.io/os: linux\n      containers:\n      - name: node-exporter\n        image: prom/node-exporter:v1\n        args:\n        - --web.listen-address=$(HOSTIP):9100\n        - --path.procfs=/host/proc\n        - --path.sysfs=/host/sys\n        - --path.rootfs=/host/root\n        - --collector.filesystem.ignored-mount-points=^/(dev|proc|sys|var/lib/docker/.+)($|/)\n        - --collector.filesystem.ignored-fs-types=^(autofs|binfmt_misc|cgroup|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|mqueue|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|sysfs|tracefs)$\n        ports:\n        - containerPort: 9100\n        env:\n        - name: HOSTIP\n          valueFrom:\n            fieldRef:\n              fieldPath: status.hostIP\n        resources:\n          requests:\n            cpu: 150m\n            memory: 180Mi\n          limits:\n            cpu: 150m\n            memory: 180Mi\n        securityContext:\n          runAsNonRoot: true\n          runAsUser: 65534\n        volumeMounts:\n        - name: proc\n          mountPath: /host/proc\n        - name: sys\n          mountPath: /host/sys\n        - name: root\n          mountPath: /host/root\n          mountPropagation: HostToContainer\n          readOnly: true\n      tolerations:\n      - operator: \"Exists\"\n      volumes:\n      - name: proc\n        hostPath:\n          path: /proc\n      - name: dev\n        hostPath:\n          path: /dev\n      - name: sys\n        hostPath:\n          path: /sys\n      - name: root\n        hostPath:\n          path: /\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u8981\u83b7\u53d6\u5230\u7684\u6570\u636e\u662f\u4e3b\u673a\u7684\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u800c\u6211\u4eec\u7684 <code>node-exporter</code> \u662f\u8fd0\u884c\u5728\u5bb9\u5668\u4e2d\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5728 Pod \u4e2d\u9700\u8981\u914d\u7f6e\u4e00\u4e9b Pod \u7684\u5b89\u5168\u7b56\u7565\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u6dfb\u52a0\u4e86 <code>hostPID: true</code>\u3001<code>hostIPC: true</code>\u3001<code>hostNetwork: true</code> 3\u4e2a\u7b56\u7565\uff0c\u7528\u6765\u4f7f\u7528\u4e3b\u673a\u7684 <code>PID namespace</code>\u3001<code>IPC namespace</code> \u4ee5\u53ca\u4e3b\u673a\u7f51\u7edc\uff0c\u8fd9\u4e9b namespace \u5c31\u662f\u7528\u4e8e\u5bb9\u5668\u9694\u79bb\u7684\u5173\u952e\u6280\u672f\uff0c\u8981\u6ce8\u610f\u8fd9\u91cc\u7684 namespace \u548c\u96c6\u7fa4\u4e2d\u7684 namespace \u662f\u4e24\u4e2a\u5b8c\u5168\u4e0d\u76f8\u540c\u7684\u6982\u5ff5\u3002</p> <p>\u53e6\u5916\u6211\u4eec\u8fd8\u5c06\u4e3b\u673a\u7684 <code>/dev</code>\u3001<code>/proc</code>\u3001<code>/sys</code>\u8fd9\u4e9b\u76ee\u5f55\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\uff0c\u8fd9\u4e9b\u56e0\u4e3a\u6211\u4eec\u91c7\u96c6\u7684\u5f88\u591a\u8282\u70b9\u6570\u636e\u90fd\u662f\u901a\u8fc7\u8fd9\u4e9b\u6587\u4ef6\u5939\u4e0b\u9762\u7684\u6587\u4ef6\u6765\u83b7\u53d6\u5230\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u5728\u4f7f\u7528 <code>top</code> \u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u5f53\u524d cpu \u4f7f\u7528\u60c5\u51b5\uff0c\u6570\u636e\u5c31\u6765\u6e90\u4e8e\u6587\u4ef6 <code>/proc/stat</code>\uff0c\u4f7f\u7528 <code>free</code> \u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\uff0c\u5176\u6570\u636e\u6765\u6e90\u662f\u6765\u81ea <code>/proc/meminfo</code> \u6587\u4ef6\u3002</p> <p>\u53e6\u5916\u7531\u4e8e\u6211\u4eec\u96c6\u7fa4\u4f7f\u7528\u7684\u662f <code>kubeadm</code> \u642d\u5efa\u7684\uff0c\u6240\u4ee5\u5982\u679c\u5e0c\u671b master \u8282\u70b9\u4e5f\u4e00\u8d77\u88ab\u76d1\u63a7\uff0c\u5219\u9700\u8981\u6dfb\u52a0\u76f8\u5e94\u7684\u5bb9\u5fcd\uff0c\u7136\u540e\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f prome-node-exporter.yaml\ndaemonset.apps/node-exporter created\n$ kubectl get pods -n kube-mon -l app=node-exporter -o wide\nNAME                  READY   STATUS    RESTARTS   AGE    IP             NODE          NOMINATED NODE   READINESS GATES\nnode-exporter-cd2cq   1/1     Running   0          107s   157   ydzs-node3    &lt;none&gt;           &lt;none&gt;\nnode-exporter-l6jv6   1/1     Running   0          107s   123   ydzs-node2    &lt;none&gt;           &lt;none&gt;\nnode-exporter-qv4x5   1/1     Running   0          107s   159   ydzs-node4    &lt;none&gt;           &lt;none&gt;\nnode-exporter-vbbhc   1/1     Running   0          107s   111   ydzs-master   &lt;none&gt;           &lt;none&gt;\nnode-exporter-wlgnz   1/1     Running   0          107s   122   ydzs-node1    &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u57285\u4e2a\u8282\u70b9\u4e0a\u90fd\u8fd0\u884c\u4e86\u4e00\u4e2a Pod\uff0c\u7531\u4e8e\u6211\u4eec\u6307\u5b9a\u4e86 <code>hostNetwork=true</code>\uff0c\u6240\u4ee5\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u5c31\u4f1a\u7ed1\u5b9a\u4e00\u4e2a\u7aef\u53e3 9100\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u7aef\u53e3\u53bb\u83b7\u53d6\u5230\u76d1\u63a7\u6307\u6807\u6570\u636e\uff1a</p> <pre><code>$ curl 111:9100/metrics\n...\nnode_filesystem_device_error{device=\"shm\",fstype=\"tmpfs\",mountpoint=\"/rootfs/var/lib/docker/containers/aefe8b1b63c3aa5f27766053ec817415faf8f6f417bb210d266fef0c2da64674/shm\"} 1\nnode_filesystem_device_error{device=\"shm\",fstype=\"tmpfs\",mountpoint=\"/rootfs/var/lib/docker/containers/c8652ca72230496038a07e4fe4ee47046abb5f88d9d2440f0c8a923d5f3e133c/shm\"} 1\nnode_filesystem_device_error{device=\"tmpfs\",fstype=\"tmpfs\",mountpoint=\"/dev\"} 0\nnode_filesystem_device_error{device=\"tmpfs\",fstype=\"tmpfs\",mountpoint=\"/dev/shm\"} 0\n...\n</code></pre> <p>\u5f53\u7136\u5982\u679c\u4f60\u89c9\u5f97\u4e0a\u9762\u7684\u624b\u52a8\u5b89\u88c5\u65b9\u5f0f\u6bd4\u8f83\u9ebb\u70e6\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 Helm \u7684\u65b9\u5f0f\u6765\u5b89\u88c5\uff1a</p> <pre><code>$ helm upgrade --install node-exporter --namespace kube-mon stable/prometheus-node-exporter\n</code></pre>"},{"location":"kubernetes_monitor/prometheus/#_8","title":"\u670d\u52a1\u53d1\u73b0","text":"<p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u6bcf\u4e2a\u8282\u70b9\u4e0a\u9762\u90fd\u8fd0\u884c\u4e86 <code>node-exporter</code> \u7a0b\u5e8f\uff0c\u5982\u679c\u6211\u4eec\u901a\u8fc7\u4e00\u4e2a Service \u6765\u5c06\u6570\u636e\u6536\u96c6\u5230\u4e00\u8d77\u7528\u9759\u6001\u914d\u7f6e\u7684\u65b9\u5f0f\u914d\u7f6e\u5230 Prometheus \u53bb\u4e2d\uff0c\u5c31\u53ea\u4f1a\u663e\u793a\u4e00\u6761\u6570\u636e\uff0c\u6211\u4eec\u5f97\u81ea\u5df1\u5728\u6307\u6807\u6570\u636e\u4e2d\u53bb\u8fc7\u6ee4\u6bcf\u4e2a\u8282\u70b9\u7684\u6570\u636e\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u624b\u52a8\u7684\u628a\u6240\u6709\u8282\u70b9\u7528\u9759\u6001\u7684\u65b9\u5f0f\u914d\u7f6e\u5230 Prometheus \u4e2d\u53bb\uff0c\u4f46\u662f\u4ee5\u540e\u8981\u65b0\u589e\u6216\u8005\u53bb\u6389\u8282\u70b9\u7684\u65f6\u5019\u5c31\u8fd8\u5f97\u624b\u52a8\u53bb\u914d\u7f6e\uff0c\u90a3\u4e48\u6709\u6ca1\u6709\u4e00\u79cd\u65b9\u5f0f\u53ef\u4ee5\u8ba9 Prometheus \u53bb\u81ea\u52a8\u53d1\u73b0\u6211\u4eec\u8282\u70b9\u7684 <code>node-exporter</code> \u7a0b\u5e8f\uff0c\u5e76\u4e14\u6309\u8282\u70b9\u8fdb\u884c\u5206\u7ec4\u5462\uff1f\u8fd9\u5c31\u662f Prometheus \u91cc\u9762\u975e\u5e38\u91cd\u8981\u7684<code>\u670d\u52a1\u53d1\u73b0</code>\u529f\u80fd\u4e86\u3002</p> <p>\u5728 Kubernetes \u4e0b\uff0cPromethues \u901a\u8fc7\u4e0e Kubernetes API \u96c6\u6210\uff0c\u4e3b\u8981\u652f\u63015\u4e2d\u670d\u52a1\u53d1\u73b0\u6a21\u5f0f\uff0c\u5206\u522b\u662f\uff1a<code>Node</code>\u3001<code>Service</code>\u3001<code>Pod</code>\u3001<code>Endpoints</code>\u3001<code>Ingress</code>\u3002</p> <p>\u6211\u4eec\u901a\u8fc7 kubectl \u547d\u4ee4\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u83b7\u53d6\u5230\u5f53\u524d\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u8282\u70b9\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get nodes\nNAME          STATUS   ROLES    AGE   VERSION\nydzs-master   Ready    master   33d   v2\nydzs-node1    Ready    &lt;none&gt;   33d   v2\nydzs-node2    Ready    &lt;none&gt;   33d   v2\nydzs-node3    Ready    &lt;none&gt;   31d   v2\nydzs-node4    Ready    &lt;none&gt;   31d   v2\n</code></pre> <p>\u4f46\u662f\u8981\u8ba9 Prometheus \u4e5f\u80fd\u591f\u83b7\u53d6\u5230\u5f53\u524d\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u8282\u70b9\u4fe1\u606f\u7684\u8bdd\uff0c\u6211\u4eec\u5c31\u9700\u8981\u5229\u7528 Node \u7684\u670d\u52a1\u53d1\u73b0\u6a21\u5f0f\uff0c\u540c\u6837\u7684\uff0c\u5728 <code>prometheus.yml</code> \u6587\u4ef6\u4e2d\u914d\u7f6e\u5982\u4e0b\u7684 job \u4efb\u52a1\u5373\u53ef\uff1a</p> <pre><code>- job_name: 'kubernetes-nodes'\n  kubernetes_sd_configs:\n  - role: node\n</code></pre> <p>\u901a\u8fc7\u6307\u5b9a </p> <pre><code>kubernetes_sd_configs\n</code></pre> <p>\u7684\u6a21\u5f0f\u4e3a<code>node</code>\uff0cPrometheus \u5c31\u4f1a\u81ea\u52a8\u4ece Kubernetes \u4e2d\u53d1\u73b0\u6240\u6709\u7684 node \u8282\u70b9\u5e76\u4f5c\u4e3a\u5f53\u524d job \u76d1\u63a7\u7684\u76ee\u6807\u5b9e\u4f8b\uff0c\u53d1\u73b0\u7684\u8282\u70b9 <code>/metrics</code> \u63a5\u53e3\u662f\u9ed8\u8ba4\u7684 kubelet \u7684 HTTP \u63a5\u53e3\u3002</p> <p>prometheus \u7684 ConfigMap \u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u540c\u6837\u7684\u6211\u4eec\u6267\u884c reload \u64cd\u4f5c\uff0c\u8ba9\u914d\u7f6e\u751f\u6548\uff1a</p> <pre><code>$ kubectl apply -f prometheus-cm.yaml\nconfigmap/prometheus-config configured\n# \u9694\u4e00\u4f1a\u513f\u6267\u884creload\u64cd\u4f5c\n$ curl -X POST \"http://2174:9090/-/reload\"\n</code></pre> <p>\u914d\u7f6e\u751f\u6548\u540e\uff0c\u6211\u4eec\u518d\u53bb prometheus \u7684 dashboard \u4e2d\u67e5\u770b Targets \u662f\u5426\u80fd\u591f\u6b63\u5e38\u6293\u53d6\u6570\u636e\uff0c\u8bbf\u95ee<code>http://\u4efb\u610f\u8282\u70b9IP:30980</code>\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684 <code>kubernetes-nodes</code> \u8fd9\u4e2a job \u4efb\u52a1\u5df2\u7ecf\u81ea\u52a8\u53d1\u73b0\u4e86\u6211\u4eec5\u4e2a node \u8282\u70b9\uff0c\u4f46\u662f\u5728\u83b7\u53d6\u6570\u636e\u7684\u65f6\u5019\u5931\u8d25\u4e86\uff0c\u51fa\u73b0\u4e86\u7c7b\u4f3c\u4e8e\u4e0b\u9762\u7684\u9519\u8bef\u4fe1\u606f\uff1a</p> <pre><code>server returned HTTP status 400 Bad Request\n</code></pre> <p>\u8fd9\u4e2a\u662f\u56e0\u4e3a prometheus \u53bb\u53d1\u73b0 Node \u6a21\u5f0f\u7684\u670d\u52a1\u7684\u65f6\u5019\uff0c\u8bbf\u95ee\u7684\u7aef\u53e3\u9ed8\u8ba4\u662f10250\uff0c\u800c\u9ed8\u8ba4\u662f\u9700\u8981\u8ba4\u8bc1\u7684 https \u534f\u8bae\u624d\u6709\u6743\u8bbf\u95ee\u7684\uff0c\u4f46\u5b9e\u9645\u4e0a\u6211\u4eec\u5e76\u4e0d\u662f\u5e0c\u671b\u8ba9\u53bb\u8bbf\u95ee10250\u7aef\u53e3\u7684 <code>/metrics</code> \u63a5\u53e3\uff0c\u800c\u662f <code>node-exporter</code> \u7ed1\u5b9a\u5230\u8282\u70b9\u7684 9100 \u7aef\u53e3\uff0c\u6240\u4ee5\u6211\u4eec\u5e94\u8be5\u5c06\u8fd9\u91cc\u7684 <code>10250</code> \u66ff\u6362\u6210 <code>9100</code>\uff0c\u4f46\u662f\u5e94\u8be5\u600e\u6837\u66ff\u6362\u5462\uff1f</p> <p>\u8fd9\u91cc\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528\u5230 Prometheus \u63d0\u4f9b\u7684 <code>relabel_configs</code> \u4e2d\u7684 <code>replace</code> \u80fd\u529b\u4e86\uff0c<code>relabel</code> \u53ef\u4ee5\u5728 Prometheus \u91c7\u96c6\u6570\u636e\u4e4b\u524d\uff0c\u901a\u8fc7 Target \u5b9e\u4f8b\u7684 <code>Metadata</code> \u4fe1\u606f\uff0c\u52a8\u6001\u91cd\u65b0\u5199\u5165 Label \u7684\u503c\u3002\u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u80fd\u6839\u636e Target \u5b9e\u4f8b\u7684 <code>Metadata</code> \u4fe1\u606f\u9009\u62e9\u662f\u5426\u91c7\u96c6\u6216\u8005\u5ffd\u7565\u8be5 Target \u5b9e\u4f8b\u3002\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5c31\u53ef\u4ee5\u53bb\u5339\u914d <code>__address__</code> \u8fd9\u4e2a Label \u6807\u7b7e\uff0c\u7136\u540e\u66ff\u6362\u6389\u5176\u4e2d\u7684\u7aef\u53e3\uff0c\u5982\u679c\u4f60\u4e0d\u77e5\u9053\u6709\u54ea\u4e9b Label \u6807\u7b7e\u53ef\u4ee5\u64cd\u4f5c\u7684\u8bdd\uff0c\u53ef\u4ee5\u5c06\u9f20\u6807\ud83c\udf92\u79fb\u52a8\u5230 Targets \u7684\u6807\u7b7e\u533a\u57df\uff0c\u5176\u4e2d\u663e\u793a\u7684 <code>Before relabeling</code> \u533a\u57df\u90fd\u662f\u6211\u4eec\u53ef\u4ee5\u64cd\u4f5c\u7684\u6807\u7b7e\uff1a</p> <p></p> <p>\u73b0\u5728\u6211\u4eec\u6765\u66ff\u6362\u6389\u7aef\u53e3\uff0c\u4fee\u6539 ConfigMap\uff1a</p> <pre><code>- job_name: 'kubernetes-nodes'\n  kubernetes_sd_configs:\n  - role: node\n  relabel_configs:\n  - source_labels: [__address__]\n    regex: '(.*):10250'\n    replacement: '${1}:9100'\n    target_label: __address__\n    action: replace\n</code></pre> <p>\u8fd9\u91cc\u5c31\u662f\u4e00\u4e2a\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u53bb\u5339\u914d <code>__address__</code> \u8fd9\u4e2a\u6807\u7b7e\uff0c\u7136\u540e\u5c06 host \u90e8\u5206\u4fdd\u7559\u4e0b\u6765\uff0cport \u66ff\u6362\u6210\u4e86 9100\uff0c\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u66f4\u65b0\u914d\u7f6e\u6587\u4ef6\uff0c\u6267\u884c reload \u64cd\u4f5c\uff0c\u7136\u540e\u518d\u53bb\u770b Prometheus \u7684 Dashboard \u7684 Targets \u8def\u5f84\u4e0b\u9762 kubernetes-nodes \u8fd9\u4e2a job \u4efb\u52a1\u662f\u5426\u6b63\u5e38\u4e86\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u5df2\u7ecf\u6b63\u5e38\u4e86\uff0c\u4f46\u662f\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\u6211\u4eec\u91c7\u96c6\u7684\u6307\u6807\u6570\u636e Label \u6807\u7b7e\u5c31\u53ea\u6709\u4e00\u4e2a\u8282\u70b9\u7684 hostname\uff0c\u8fd9\u5bf9\u4e8e\u6211\u4eec\u5728\u8fdb\u884c\u76d1\u63a7\u5206\u7ec4\u5206\u7c7b\u67e5\u8be2\u7684\u65f6\u5019\u5e26\u6765\u4e86\u5f88\u591a\u4e0d\u65b9\u4fbf\u7684\u5730\u65b9\uff0c\u8981\u662f\u6211\u4eec\u80fd\u591f\u5c06\u96c6\u7fa4\u4e2d Node \u8282\u70b9\u7684 Label \u6807\u7b7e\u4e5f\u80fd\u83b7\u53d6\u5230\u5c31\u5f88\u597d\u4e86\u3002\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>labelmap</code> \u8fd9\u4e2a\u5c5e\u6027\u6765\u5c06 Kubernetes \u7684 Label \u6807\u7b7e\u6dfb\u52a0\u4e3a Prometheus \u7684\u6307\u6807\u6570\u636e\u7684\u6807\u7b7e\uff1a</p> <pre><code>- job_name: 'kubernetes-nodes'\n  kubernetes_sd_configs:\n  - role: node\n  relabel_configs:\n  - source_labels: [__address__]\n    regex: '(.*):10250'\n    replacement: '${1}:9100'\n    target_label: __address__\n    action: replace\n  - action: labelmap\n    regex: __meta_kubernetes_node_label_(.+)\n</code></pre> <p>\u6dfb\u52a0\u4e86\u4e00\u4e2a action \u4e3a <code>labelmap</code>\uff0c\u6b63\u5219\u8868\u8fbe\u5f0f\u662f </p> <pre><code>__meta_kubernetes_node_label_(.+)\n</code></pre> <p>\u7684\u914d\u7f6e\uff0c\u8fd9\u91cc\u7684\u610f\u601d\u5c31\u662f\u8868\u8fbe\u5f0f\u4e2d\u5339\u914d\u90fd\u7684\u6570\u636e\u4e5f\u6dfb\u52a0\u5230\u6307\u6807\u6570\u636e\u7684 Label \u6807\u7b7e\u4e2d\u53bb\u3002</p> <p>\u5bf9\u4e8e </p> <pre><code>kubernetes_sd_configs\n</code></pre> <p>\u4e0b\u9762\u53ef\u7528\u7684\u5143\u4fe1\u606f\u6807\u7b7e\u5982\u4e0b\uff1a</p> <ul> <li> <p><code>__meta_kubernetes_node_name</code></p> <p>\uff1a\u8282\u70b9\u5bf9\u8c61\u7684\u540d\u79f0 *   <code>_meta_kubernetes_node_label</code></p> <p>\uff1a\u8282\u70b9\u5bf9\u8c61\u4e2d\u7684\u6bcf\u4e2a\u6807\u7b7e *   <code>_meta_kubernetes_node_annotation</code></p> <p>\uff1a\u6765\u81ea\u8282\u70b9\u5bf9\u8c61\u7684\u6bcf\u4e2a\u6ce8\u91ca *   <code>_meta_kubernetes_node_address</code></p> <p>\uff1a\u6bcf\u4e2a\u8282\u70b9\u5730\u5740\u7c7b\u578b\u7684\u7b2c\u4e00\u4e2a\u5730\u5740\uff08\u5982\u679c\u5b58\u5728\uff09</p> </li> </ul> <p>\u5173\u4e8e kubernets_sd_configs \u66f4\u591a\u4fe1\u606f\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863\uff1akubernetes_sd_config</p> <p>\u53e6\u5916\u7531\u4e8e kubelet \u4e5f\u81ea\u5e26\u4e86\u4e00\u4e9b\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u5c31\u4e0a\u9762\u6211\u4eec\u63d0\u5230\u7684 10250 \u7aef\u53e3\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4e5f\u628a kubelet \u7684\u76d1\u63a7\u4efb\u52a1\u4e5f\u4e00\u5e76\u914d\u7f6e\u4e0a\uff1a</p> <pre><code>- job_name: 'kubernetes-kubelet'\n  kubernetes_sd_configs:\n  - role: node\n  scheme: https\n  tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n    insecure_skip_verify: true\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n  relabel_configs:\n  - action: labelmap\n    regex: __meta_kubernetes_node_label_(.+)\n</code></pre> <p>\u4f46\u662f\u8fd9\u91cc\u9700\u8981\u7279\u522b\u6ce8\u610f\u7684\u662f\u8fd9\u91cc\u5fc5\u987b\u4f7f\u7528 <code>https</code> \u534f\u8bae\u8bbf\u95ee\uff0c\u8fd9\u6837\u5c31\u5fc5\u7136\u9700\u8981\u63d0\u4f9b\u8bc1\u4e66\uff0c\u6211\u4eec\u8fd9\u91cc\u662f\u901a\u8fc7\u914d\u7f6e </p> <pre><code>insecure_skip_verify: true\n</code></pre> <p>\u6765\u8df3\u8fc7\u4e86\u8bc1\u4e66\u6821\u9a8c\uff0c\u4f46\u662f\u9664\u6b64\u4e4b\u5916\uff0c\u8981\u8bbf\u95ee\u96c6\u7fa4\u7684\u8d44\u6e90\uff0c\u8fd8\u5fc5\u987b\u8981\u6709\u5bf9\u5e94\u7684\u6743\u9650\u624d\u53ef\u4ee5\uff0c\u4e5f\u5c31\u662f\u5bf9\u5e94\u7684 ServiceAccount \u68d2\u7684 \u6743\u9650\u5141\u8bb8\u624d\u53ef\u4ee5\uff0c\u6211\u4eec\u8fd9\u91cc\u90e8\u7f72\u7684 prometheus \u5173\u8054\u7684 ServiceAccount \u5bf9\u8c61\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u63d0\u5230\u8fc7\u4e86\uff0c\u8fd9\u91cc\u6211\u4eec\u53ea\u9700\u8981\u5c06 Pod \u4e2d\u81ea\u52a8\u6ce8\u5165\u7684 </p> <pre><code>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n</code></pre> <p>\u548c </p> <pre><code>/var/run/secrets/kubernetes.io/serviceaccount/token\n</code></pre> <p>\u6587\u4ef6\u914d\u7f6e\u4e0a\uff0c\u5c31\u53ef\u4ee5\u83b7\u53d6\u5230\u5bf9\u5e94\u7684\u6743\u9650\u4e86\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u518d\u53bb\u66f4\u65b0\u4e0b\u914d\u7f6e\u6587\u4ef6\uff0c\u6267\u884c reload \u64cd\u4f5c\uff0c\u8ba9\u914d\u7f6e\u751f\u6548\uff0c\u7136\u540e\u8bbf\u95ee Prometheus \u7684 Dashboard \u67e5\u770b Targets \u8def\u5f84\uff1a</p> <p></p> <p>\u73b0\u5728\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u4e0a\u9762\u6dfb\u52a0\u7684 <code>kubernetes-kubelet</code> \u548c <code>kubernetes-nodes</code> \u8fd9\u4e24\u4e2a job \u4efb\u52a1\u90fd\u5df2\u7ecf\u914d\u7f6e\u6210\u529f\u4e86\uff0c\u800c\u4e14\u4e8c\u8005\u7684 Labels \u6807\u7b7e\u90fd\u548c\u96c6\u7fa4\u7684 node \u8282\u70b9\u6807\u7b7e\u4fdd\u6301\u4e00\u81f4\u4e86\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u5207\u6362\u5230 Graph \u8def\u5f84\u4e0b\u9762\u67e5\u770b\u91c7\u96c6\u7684\u4e00\u4e9b\u6307\u6807\u6570\u636e\u4e86\uff0c\u6bd4\u5982\u67e5\u8be2 node_load1 \u6307\u6807\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5c065\u4e2a\u8282\u70b9\u5bf9\u5e94\u7684 <code>node_load1</code> \u6307\u6807\u6570\u636e\u90fd\u67e5\u8be2\u51fa\u6765\u4e86\uff0c\u540c\u6837\u7684\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 <code>PromQL</code> \u8bed\u53e5\u6765\u8fdb\u884c\u66f4\u590d\u6742\u7684\u4e00\u4e9b\u805a\u5408\u67e5\u8be2\u64cd\u4f5c\uff0c\u8fd8\u53ef\u4ee5\u6839\u636e\u6211\u4eec\u7684 Labels \u6807\u7b7e\u5bf9\u6307\u6807\u6570\u636e\u8fdb\u884c\u805a\u5408\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u53ea\u67e5\u8be2 <code>ydzs-node3</code> \u8282\u70b9\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u4f7f\u7528\u8868\u8fbe\u5f0f </p> <pre><code>node_load1{instance=\"ydzs-node3\"}\n</code></pre> <p>\u6765\u8fdb\u884c\u67e5\u8be2\uff1a</p> <p></p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u628a Kubernetes \u96c6\u7fa4\u8282\u70b9\u4f7f\u7528 Prometheus \u76d1\u63a7\u8d77\u6765\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u6765\u548c\u5927\u5bb6\u5b66\u4e60\u4e0b\u600e\u6837\u76d1\u63a7 Pod \u6216\u8005 Service \u4e4b\u7c7b\u7684\u8d44\u6e90\u5bf9\u8c61\u3002</p>"},{"location":"kubernetes_monitor/prometheus/#_9","title":"\u5bb9\u5668\u76d1\u63a7","text":"<p>\u8bf4\u5230\u5bb9\u5668\u76d1\u63a7\u6211\u4eec\u81ea\u7136\u4f1a\u60f3\u5230 <code>cAdvisor</code>\uff0c\u6211\u4eec\u524d\u9762\u4e5f\u8bf4\u8fc7cAdvisor\u5df2\u7ecf\u5185\u7f6e\u5728\u4e86 kubelet \u7ec4\u4ef6\u4e4b\u4e2d\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u9700\u8981\u5355\u72ec\u53bb\u5b89\u88c5\uff0c<code>cAdvisor</code> \u7684\u6570\u636e\u8def\u5f84\u4e3a </p> <pre><code>/api/v1/nodes/&lt;node&gt;/proxy/metrics\n</code></pre> <p>\uff0c\u540c\u6837\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 node \u7684\u670d\u52a1\u53d1\u73b0\u6a21\u5f0f\uff0c\u56e0\u4e3a\u6bcf\u4e00\u4e2a\u8282\u70b9\u4e0b\u9762\u90fd\u6709 kubelet\uff0c\u81ea\u7136\u90fd\u6709 <code>cAdvisor</code> \u91c7\u96c6\u5230\u7684\u6570\u636e\u6307\u6807\uff0c\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>- job_name: 'kubernetes-cadvisor'\n  kubernetes_sd_configs:\n  - role: node\n  scheme: https\n  tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n  relabel_configs:\n  - action: labelmap\n    regex: __meta_kubernetes_node_label_(.+)\n  - target_label: __address__\n    replacement: kubernetes.default.svc:443\n  - source_labels: [__meta_kubernetes_node_name]\n    regex: (.+)\n    target_label: __metrics_path__\n    replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor\n</code></pre> <p>\u4e0a\u9762\u7684\u914d\u7f6e\u548c\u6211\u4eec\u4e4b\u524d\u914d\u7f6e <code>node-exporter</code> \u7684\u65f6\u5019\u51e0\u4e4e\u662f\u4e00\u6837\u7684\uff0c\u533a\u522b\u662f\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e86 https \u7684\u534f\u8bae\uff0c\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u914d\u7f6e\u4e86 ca.cart \u548c token \u8fd9\u4e24\u4e2a\u6587\u4ef6\uff0c\u8fd9\u4e24\u4e2a\u6587\u4ef6\u662f Pod \u542f\u52a8\u540e\u81ea\u52a8\u6ce8\u5165\u8fdb\u6765\u7684\uff0c\u901a\u8fc7\u8fd9\u4e24\u4e2a\u6587\u4ef6\u6211\u4eec\u53ef\u4ee5\u5728 Pod \u4e2d\u8bbf\u95ee apiserver\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u7684 <code>__address__</code> \u4e0d\u518d\u662f nodeip \u4e86\uff0c\u800c\u662f kubernetes \u5728\u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u5730\u5740\uff0c\u7136\u540e\u52a0\u4e0a<code>__metrics_path__</code> \u7684\u8bbf\u95ee\u8def\u5f84 </p> <pre><code>/api/v1/nodes/${1}/proxy/metrics/cadvisor\n</code></pre> <p>\uff0c\u56e0\u4e3a\u6211\u4eec\u73b0\u5728\u662f\u901a\u8fc7 kubernetes \u7684 apiserver \u5730\u5740\u53bb\u8fdb\u884c\u8bbf\u95ee\u7684\uff0c\u73b0\u5728\u540c\u6837\u66f4\u65b0\u4e0b\u914d\u7f6e\uff0c\u7136\u540e\u67e5\u770b Targets \u8def\u5f84\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u5207\u6362\u5230 Graph \u8def\u5f84\u4e0b\u9762\u67e5\u8be2\u5bb9\u5668\u76f8\u5173\u6570\u636e\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u6765\u67e5\u8be2\u96c6\u7fa4\u4e2d\u6240\u6709 Pod \u7684 CPU \u4f7f\u7528\u60c5\u51b5\uff0ckubelet \u4e2d\u7684 cAdvisor \u91c7\u96c6\u7684\u6307\u6807\u548c\u542b\u4e49\uff0c\u53ef\u4ee5\u67e5\u770b Monitoring cAdvisor with Prometheus \u8bf4\u660e\uff0c\u5176\u4e2d\u6709\u4e00\u9879\uff1a</p> <pre><code>container_cpu_usage_seconds_total   Counter     Cumulative cpu time consumed    seconds\n</code></pre> <p>``` container_cpu_usage_seconds_total <pre><code> \u662f\u5bb9\u5668\u7d2f\u8ba1\u4f7f\u7528\u7684 CPU \u65f6\u95f4\uff0c\u7528\u5b83\u9664\u4ee5 CPU \u7684\u603b\u65f6\u95f4\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230\u5bb9\u5668\u7684 CPU \u4f7f\u7528\u7387\u4e86\uff1a\n\n&gt; \u9996\u5148\u8ba1\u7b97\u5bb9\u5668\u7684 CPU \u5360\u7528\u65f6\u95f4\uff0c\u7531\u4e8e\u8282\u70b9\u4e0a\u7684 CPU \u6709\u591a\u4e2a\uff0c\u6240\u4ee5\u9700\u8981\u5c06\u5bb9\u5668\u5728\u6bcf\u4e2a CPU \u4e0a\u5360\u7528\u7684\u65f6\u95f4\u7d2f\u52a0\u8d77\u6765\uff0cPod \u5728 1m \u5185\u7d2f\u79ef\u4f7f\u7528\u7684 CPU \u65f6\u95f4\u4e3a\uff1a(\u6839\u636e pod \u548c namespace \u8fdb\u884c\u5206\u7ec4\u67e5\u8be2)\n</code></pre> sum(rate(container_cpu_usage_seconds_total{image!=\"\",pod!=\"\"}[1m])) by (namespace, pod) <pre><code>&gt; metrics \u53d8\u5316\n\n&gt; \u5728 Kubernetes 1.16 \u7248\u672c\u4e2d\u79fb\u9664\u4e86 cadvisor metrics \u7684 pod_name \u548c container_name \u8fd9\u4e24\u4e2a\u6807\u7b7e\uff0c\u6539\u6210\u4e86 pod \u548c container\u3002\n\n&gt; Removed cadvisor metric labels pod_name and container_name to match instrumentation guidelines. Any Prometheus queries that match pod_name and container_name labels (e.g. cadvisor or kubelet probe metrics) must be updated to use pod and container instead. (#80376, @ehashman)\n\n&gt; \u7136\u540e\u8ba1\u7b97 CPU \u7684\u603b\u65f6\u95f4\uff0c\u8fd9\u91cc\u7684 CPU \u6570\u91cf\u662f\u5bb9\u5668\u5206\u914d\u5230\u7684 CPU \u6570\u91cf\uff0c\n</code></pre> container_spec_cpu_quota <pre><code> \u662f\u5bb9\u5668\u7684 CPU \u914d\u989d\uff0c\u5b83\u7684\u503c\u662f\u5bb9\u5668\u6307\u5b9a\u7684 `CPU \u4e2a\u6570 * 100000`\uff0c\u6240\u4ee5 Pod \u5728 1s \u5185 CPU \u7684\u603b\u65f6\u95f4\u4e3a\uff1aPod \u7684 CPU \u6838\u6570 * 1s\uff1a\n</code></pre> sum(container_spec_cpu_quota{image!=\"\", pod!=\"\"}) by(namespace, pod) / 100000 <pre><code>&gt; CPU \u914d\u989d\n\n&gt; \u7531\u4e8e \n</code></pre> container_spec_cpu_quota <pre><code> \u662f\u5bb9\u5668\u7684 CPU \u914d\u989d\uff0c\u6240\u4ee5\u53ea\u6709\u914d\u7f6e\u4e86 resource-limit CPU \u7684 Pod \u624d\u53ef\u4ee5\u83b7\u5f97\u8be5\u6307\u6807\u6570\u636e\u3002\n\n&gt; \u5c06\u4e0a\u9762\u8fd9\u4e24\u4e2a\u8bed\u53e5\u7684\u7ed3\u679c\u76f8\u9664\uff0c\u5c31\u5f97\u5230\u4e86\u5bb9\u5668\u7684 CPU \u4f7f\u7528\u7387\uff1a\n</code></pre> (sum(rate(container_cpu_usage_seconds_total{image!=\"\",pod!=\"\"}[1m])) by (namespace, pod)) / (sum(container_spec_cpu_quota{image!=\"\", pod!=\"\"}) by(namespace, pod) / 100000) * 100 <pre><code>&gt; \u5728 promethues \u91cc\u9762\u6267\u884c\u4e0a\u9762\u7684 promQL \u8bed\u53e5\u53ef\u4ee5\u5f97\u5230\u4e0b\u9762\u7684\u7ed3\u679c\uff1a\n\n&gt; ![prometheus cadvisor cpu rate](../assets/img/kubernetes_monitor/prometheus-webui-cadvisor-cpu-rate.png)\n\n&gt; Pod \u5185\u5b58\u4f7f\u7528\u7387\u7684\u8ba1\u7b97\u5c31\u7b80\u5355\u591a\u4e86\uff0c\u76f4\u63a5\u7528\u5185\u5b58\u5b9e\u9645\u4f7f\u7528\u91cf\u9664\u4ee5\u5185\u5b58\u9650\u5236\u4f7f\u7528\u91cf\u5373\u53ef\uff1a\n</code></pre> sum(container_memory_rss{image!=\"\"}) by(namespace, pod) / sum(container_spec_memory_limit_bytes{image!=\"\"}) by(namespace, pod) * 100 != +inf <pre><code>&gt; \u5728 promethues \u91cc\u9762\u6267\u884c\u4e0a\u9762\u7684 promQL \u8bed\u53e5\u53ef\u4ee5\u5f97\u5230\u4e0b\u9762\u7684\u7ed3\u679c\uff1a\n\n&gt; ![prometheus cadvisor memory rate](../assets/img/kubernetes_monitor/prometheus-webui-cadvisor-memory-rate.png)\n\n### \u76d1\u63a7 apiserver\n\n&gt; apiserver \u4f5c\u4e3a Kubernetes \u6700\u6838\u5fc3\u7684\u7ec4\u4ef6\uff0c\u5f53\u7136\u4ed6\u7684\u76d1\u63a7\u4e5f\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\uff0c\u5bf9\u4e8e apiserver \u7684\u76d1\u63a7\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 kubernetes \u7684 Service \u6765\u83b7\u53d6\uff1a\n</code></pre> $ kubectl get svc NAME             TYPE           CLUSTER-IP       EXTERNAL-IP             PORT(S)          AGE kubernetes       ClusterIP      1                          443/TCP          33d <pre><code>&gt; \u4e0a\u9762\u8fd9\u4e2a Service \u5c31\u662f\u6211\u4eec\u96c6\u7fa4\u7684 apiserver \u5728\u96c6\u7fa4\u5185\u90e8\u7684 Service \u5730\u5740\uff0c\u8981\u81ea\u52a8\u53d1\u73b0 Service \u7c7b\u578b\u7684\u670d\u52a1\uff0c\u6211\u4eec\u5c31\u9700\u8981\u7528\u5230 role \u4e3a Endpoints \u7684 \n</code></pre> kubernetes_sd_configs <pre><code>\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 ConfigMap \u5bf9\u8c61\u4e2d\u6dfb\u52a0\u4e0a\u4e00\u4e2a Endpoints \u7c7b\u578b\u7684\u670d\u52a1\u7684\u76d1\u63a7\u4efb\u52a1\uff1a\n</code></pre> - job_name: 'kubernetes-apiservers'   kubernetes_sd_configs:   - role: endpoints <pre><code>&gt; \u4e0a\u9762\u8fd9\u4e2a\u4efb\u52a1\u662f\u5b9a\u4e49\u7684\u4e00\u4e2a\u7c7b\u578b\u4e3a endpoints \u7684 kubernetes_sd_configs \uff0c\u6dfb\u52a0\u5230 Prometheus \u7684 ConfigMap \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u7136\u540e\u66f4\u65b0\u914d\u7f6e\uff1a\n</code></pre> $ kubectl apply -f prometheus-cm.yaml configmap/prometheus-config configured"},{"location":"kubernetes_monitor/prometheus/#reload","title":"\u9694\u4e00\u4f1a\u513f\u6267\u884creload\u64cd\u4f5c","text":"<p>$ curl -X POST \"http://2174:9090/-/reload\" <pre><code>&gt; \u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u518d\u53bb\u67e5\u770b Prometheus \u7684 Dashboard \u7684 target \u9875\u9762\uff1a\n\n&gt; ![prometheus webui apiserver](../assets/img/kubernetes_monitor/prometheus-webui-apiserver.png)\n\n&gt; \u6211\u4eec\u53ef\u4ee5\u770b\u5230 kubernetes-apiservers \u4e0b\u9762\u51fa\u73b0\u4e86\u5f88\u591a\u5b9e\u4f8b\uff0c\u8fd9\u662f\u56e0\u4e3a\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684\u662f Endpoints \u7c7b\u578b\u7684\u670d\u52a1\u53d1\u73b0\uff0c\u6240\u4ee5 Prometheus \u628a\u6240\u6709\u7684 Endpoints \u670d\u52a1\u90fd\u6293\u53d6\u8fc7\u6765\u4e86\uff0c\u540c\u6837\u7684\uff0c\u4e0a\u9762\u6211\u4eec\u9700\u8981\u7684\u670d\u52a1\u540d\u4e3a `kubernetes` \u8fd9\u4e2a apiserver \u7684\u670d\u52a1\u4e5f\u5728\u8fd9\u4e2a\u5217\u8868\u4e4b\u4e2d\uff0c\u90a3\u4e48\u6211\u4eec\u5e94\u8be5\u600e\u6837\u6765\u8fc7\u6ee4\u51fa\u8fd9\u4e2a\u670d\u52a1\u6765\u5462\uff1f\u8fd8\u8bb0\u5f97\u524d\u9762\u7684 `relabel_configs` \u5417\uff1f\u6ca1\u9519\uff0c\u540c\u6837\u6211\u4eec\u9700\u8981\u4f7f\u7528\u8fd9\u4e2a\u914d\u7f6e\uff0c\u53ea\u662f\u6211\u4eec\u8fd9\u91cc\u4e0d\u662f\u4f7f\u7528 `replace` \u8fd9\u4e2a\u52a8\u4f5c\u4e86\uff0c\u800c\u662f `keep`\uff0c\u5c31\u662f\u53ea\u628a\u7b26\u5408\u6211\u4eec\u8981\u6c42\u7684\u7ed9\u4fdd\u7559\u4e0b\u6765\uff0c\u54ea\u4e9b\u624d\u662f\u7b26\u5408\u6211\u4eec\u8981\u6c42\u7684\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u628a\u9f20\u6807\u653e\u7f6e\u5728\u4efb\u610f\u4e00\u4e2a target \u4e0a\uff0c\u53ef\u4ee5\u67e5\u770b\u5230`Before relabeling`\u91cc\u9762\u6240\u6709\u7684\u5143\u6570\u636e\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u8fc7\u6ee4\u7684\u670d\u52a1\u662f `default` \u8fd9\u4e2a namespace \u4e0b\u9762\uff0c\u670d\u52a1\u540d\u4e3a `kubernetes` \u7684\u5143\u6570\u636e\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u5c31\u53ef\u4ee5\u6839\u636e\u5bf9\u5e94\u7684 \n</code></pre> meta_kubernetes_namespace <pre><code> \u548c \n</code></pre> __meta_kubernetes_service_name <pre><code> \u8fd9\u4e24\u4e2a\u5143\u6570\u636e\u6765 relabel\uff0c\u53e6\u5916\u7531\u4e8e kubernetes \u8fd9\u4e2a\u670d\u52a1\u5bf9\u5e94\u7684\u7aef\u53e3\u662f 443\uff0c\u9700\u8981\u4f7f\u7528 https \u534f\u8bae\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u4f7f\u7528 https \u7684\u534f\u8bae\uff0c\u5bf9\u5e94\u7684\u5c31\u9700\u8981\u5c06 ca \u8bc1\u4e66\u914d\u7f6e\u4e0a\uff0c\u5982\u4e0b\u6240\u793a\uff1a\n</code></pre> - job_name: 'kubernetes-apiservers'   kubernetes_sd_configs:   - role: endpoints   scheme: https   tls_config:     ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt   bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token   relabel_configs:   - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]     action: keep     regex: default;kubernetes;https <pre><code>&gt; \u73b0\u5728\u91cd\u65b0\u66f4\u65b0\u914d\u7f6e\u6587\u4ef6\u3001\u91cd\u65b0\u52a0\u8f7d Prometheus\uff0c\u5207\u6362\u5230 Prometheus \u7684 Targets \u8def\u5f84\u4e0b\u67e5\u770b\uff1a\n\n&gt; ![prometheus apiserver target](../assets/img/kubernetes_monitor/prometheus-webui-apiserver-target.png)\n\n&gt; \u73b0\u5728\u53ef\u4ee5\u770b\u5230 `kubernetes-apiserver` \u8fd9\u4e2a\u4efb\u52a1\u4e0b\u9762\u53ea\u6709 apiserver \u8fd9\u4e00\u4e2a\u5b9e\u4f8b\u4e86\uff0c\u8bc1\u660e\u6211\u4eec\u7684 `relabel` \u662f\u6210\u529f\u7684\uff0c\u73b0\u5728\u6211\u4eec\u5207\u6362\u5230 Graph \u8def\u5f84\u4e0b\u9762\u67e5\u770b\u4e0b\u91c7\u96c6\u5230\u7684\u6570\u636e\uff0c\u6bd4\u5982\u67e5\u8be2 apiserver \u7684\u603b\u7684\u8bf7\u6c42\u6570\uff1a\n\n&gt; ![prometheus apiserver rate](../assets/img/kubernetes_monitor/prometheus-webui-apiserver-rate.png)\n\n&gt; \u8fd9\u6837\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u5bf9 Kubernetes APIServer \u7684\u76d1\u63a7\u3002\n\n&gt; \u53e6\u5916\u5982\u679c\u6211\u4eec\u8981\u6765\u76d1\u63a7\u5176\u4ed6\u7cfb\u7edf\u7ec4\u4ef6\uff0c\u6bd4\u5982 kube-controller-manager\u3001kube-scheduler \u7684\u8bdd\u5e94\u8be5\u600e\u4e48\u505a\u5462\uff1f\u7531\u4e8e apiserver \u670d\u52a1 namespace \u5728 default \u4f7f\u7528\u9ed8\u8ba4\u7684 Service kubernetes\uff0c\u800c\u5176\u4f59\u7ec4\u4ef6\u670d\u52a1\u5728 kube-system \u8fd9\u4e2a namespace \u4e0b\u9762\uff0c\u5982\u679c\u6211\u4eec\u60f3\u8981\u6765\u76d1\u63a7\u8fd9\u4e9b\u7ec4\u4ef6\u7684\u8bdd\uff0c\u9700\u8981\u624b\u52a8\u521b\u5efa\u5355\u72ec\u7684 Service\uff0c\u5176\u4e2d kube-sheduler \u7684\u6307\u6807\u6570\u636e\u7aef\u53e3\u4e3a 10251\uff0ckube-controller-manager \u5bf9\u5e94\u7684\u7aef\u53e3\u4e3a 10252\uff0c\u5927\u5bb6\u53ef\u4ee5\u5c1d\u8bd5\u4e0b\u81ea\u5df1\u6765\u914d\u7f6e\u4e0b\u8fd9\u51e0\u4e2a\u7cfb\u7edf\u7ec4\u4ef6\u3002\n\n### \u76d1\u63a7 Pod\n\n&gt; \u4e0a\u9762\u7684 apiserver \u5b9e\u9645\u4e0a\u5c31\u662f\u4e00\u79cd\u7279\u6b8a\u7684 Endpoints\uff0c\u73b0\u5728\u6211\u4eec\u540c\u6837\u6765\u914d\u7f6e\u4e00\u4e2a\u4efb\u52a1\u7528\u6765\u4e13\u95e8\u53d1\u73b0\u666e\u901a\u7c7b\u578b\u7684 Endpoint\uff0c\u5176\u5b9e\u5c31\u662f Service \u5173\u8054\u7684 Pod \u5217\u8868\uff1a\n</code></pre> - job_name: 'kubernetes-endpoints'   kubernetes_sd_configs:   - role: endpoints   relabel_configs:   - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]     action: keep     regex: true   - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]     action: replace     target_label: __scheme     regex: (https?)   - source_labels: [meta_kubernetes_service_annotation_prometheus_io_path]     action: replace     target_label: __metrics_path     regex: (.+)   - source_labels: [address, meta_kubernetes_service_annotation_prometheus_io_port]     action: replace     target_label: __address     regex: ([^:]+)(?::\\d+)?;(\\d+)     replacement: 1:2   - action: labelmap     regex: __meta_kubernetes_service_label_(.+)   - source_labels: [__meta_kubernetes_namespace]     action: replace     target_label: kubernetes_namespace   - source_labels: [__meta_kubernetes_service_name]     action: replace     target_label: kubernetes_name   - source_labels: [__meta_kubernetes_pod_name]     action: replace     target_label: kubernetes_pod_name <pre><code>&gt; \u6ce8\u610f\u6211\u4eec\u8fd9\u91cc\u5728 `relabel_configs` \u533a\u57df\u505a\u4e86\u5927\u91cf\u7684\u914d\u7f6e\uff0c\u7279\u522b\u662f\u7b2c\u4e00\u4e2a\u4fdd\u7559\n</code></pre> __meta_kubernetes_service_annotation_prometheus_io_scrape <pre><code> \u4e3a true \u7684\u624d\u4fdd\u7559\u4e0b\u6765\uff0c\u8fd9\u5c31\u662f\u8bf4\u8981\u60f3\u81ea\u52a8\u53d1\u73b0\u96c6\u7fa4\u4e2d\u7684 Endpoint\uff0c\u5c31\u9700\u8981\u6211\u4eec\u5728 Service \u7684 `annotation` \u533a\u57df\u6dfb\u52a0 \n</code></pre> prometheus.io/scrape=true <pre><code> \u7684\u58f0\u660e\uff0c\u73b0\u5728\u6211\u4eec\u5148\u5c06\u4e0a\u9762\u7684\u914d\u7f6e\u66f4\u65b0\uff0c\u67e5\u770b\u4e0b\u6548\u679c\uff1a\n\n&gt; ![prometheus k8s endpoints](../assets/img/kubernetes_monitor/prometheus-webui-endpoints.png)\n\n&gt; \u6211\u4eec\u53ef\u4ee5\u770b\u5230 `kubernetes-endpoints` \u8fd9\u4e00\u4e2a\u4efb\u52a1\u4e0b\u9762\u53ea\u53d1\u73b0\u4e86\u4e24\u4e2a\u670d\u52a1\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u5728 `relabel_configs` \u4e2d\u8fc7\u6ee4\u4e86 `annotation` \u6709 \n</code></pre> prometheus.io/scrape=true <pre><code> \u7684 Service\uff0c\u800c\u73b0\u5728\u6211\u4eec\u7cfb\u7edf\u4e2d\u53ea\u6709\u8fd9\u6837\u4e00\u4e2a `kube-dns` \u670d\u52a1\u7b26\u5408\u8981\u6c42\uff0c\u8be5 Service \u4e0b\u9762\u6709\u4e24\u4e2a\u5b9e\u4f8b\uff0c\u6240\u4ee5\u51fa\u73b0\u4e86\u4e24\u4e2a\u5b9e\u4f8b\uff1a\n</code></pre> $ kubectl get svc kube-dns -n kube-system -o yaml apiVersion: v1 kind: Service metadata:   annotations:     prometheus.io/port: \"9153\"  # metrics \u63a5\u53e3\u7684\u7aef\u53e3     prometheus.io/scrape: \"true\"  # \u8fd9\u4e2a\u6ce8\u89e3\u53ef\u4ee5\u8ba9prometheus\u81ea\u52a8\u53d1\u73b0   creationTimestamp: \"2019-11-08T11:59:50Z\"   labels:     k8s-app: kube-dns     kubernetes.io/cluster-service: \"true\"     kubernetes.io/name: KubeDNS   name: kube-dns   namespace: kube-system ...... <pre><code>&gt; \u73b0\u5728\u6211\u4eec\u5728\u4e4b\u524d\u521b\u5efa\u7684 redis \u8fd9\u4e2a Service \u4e2d\u6dfb\u52a0\u4e0a \n</code></pre> prometheus.io/scrape=true <pre><code> \u8fd9\u4e2a annotation\uff1a(prome-redis.yaml)\n</code></pre> kind: Service apiVersion: v1 metadata:   name: redis   namespace: kube-mon   annotations:     prometheus.io/scrape: \"true\"     prometheus.io/port: \"9121\" spec:   selector:     app: redis   ports:   - name: redis     port: 6379     targetPort: 6379   - name: prom     port: 9121     targetPort: 9121 <pre><code>&gt; \u7531\u4e8e redis \u670d\u52a1\u7684 metrics \u63a5\u53e3\u5728 9121 \u8fd9\u4e2a redis-exporter \u670d\u52a1\u4e0a\u9762\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a \n</code></pre> prometheus.io/port=9121 <pre><code> \u8fd9\u6837\u7684 annotations\uff0c\u7136\u540e\u66f4\u65b0\u8fd9\u4e2a Service\uff1a\n</code></pre> $ kubectl apply -f prome-redis.yaml deployment.apps \"redis\" unchanged service \"redis\" changed ```</p> <p>\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u53bb Prometheus \u67e5\u770b Targets \u8def\u5f84\uff0c\u53ef\u4ee5\u770b\u5230 redis \u670d\u52a1\u81ea\u52a8\u51fa\u73b0\u5728\u4e86 <code>kubernetes-endpoints</code> \u8fd9\u4e2a\u4efb\u52a1\u4e0b\u9762\uff1a</p> <p></p> <p>\u8fd9\u6837\u4ee5\u540e\u6211\u4eec\u6709\u4e86\u65b0\u7684\u670d\u52a1\uff0c\u670d\u52a1\u672c\u8eab\u63d0\u4f9b\u4e86 <code>/metrics</code> \u63a5\u53e3\uff0c\u6211\u4eec\u5c31\u5b8c\u5168\u4e0d\u9700\u8981\u7528\u9759\u6001\u7684\u65b9\u5f0f\u53bb\u914d\u7f6e\u4e86\uff0c\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06\u4e4b\u524d\u914d\u7f6e\u7684 redis \u7684\u9759\u6001\u914d\u7f6e\u53bb\u6389\u4e86\u3002</p>"},{"location":"kubernetes_monitor/promql/","title":"Promql","text":""},{"location":"kubernetes_monitor/promql/#promql","title":"PromQL","text":"<p>Prometheus \u901a\u8fc7\u6307\u6807\u540d\u79f0\uff08metrics name\uff09\u4ee5\u53ca\u5bf9\u5e94\u7684\u4e00\u7ec4\u6807\u7b7e\uff08label\uff09\u552f\u4e00\u5b9a\u4e49\u4e00\u6761\u65f6\u95f4\u5e8f\u5217\u3002\u6307\u6807\u540d\u79f0\u53cd\u6620\u4e86\u76d1\u63a7\u6837\u672c\u7684\u57fa\u672c\u6807\u8bc6\uff0c\u800c label \u5219\u5728\u8fd9\u4e2a\u57fa\u672c\u7279\u5f81\u4e0a\u4e3a\u91c7\u96c6\u5230\u7684\u6570\u636e\u63d0\u4f9b\u4e86\u591a\u79cd\u7279\u5f81\u7ef4\u5ea6\u3002\u7528\u6237\u53ef\u4ee5\u57fa\u4e8e\u8fd9\u4e9b\u7279\u5f81\u7ef4\u5ea6\u8fc7\u6ee4\u3001\u805a\u5408\u3001\u7edf\u8ba1\u4ece\u800c\u4ea7\u751f\u65b0\u7684\u8ba1\u7b97\u540e\u7684\u4e00\u6761\u65f6\u95f4\u5e8f\u5217\u3002</p> <p><code>PromQL</code> \u662f Prometheus \u5185\u7f6e\u7684\u6570\u636e\u67e5\u8be2\u8bed\u8a00\uff0c\u5176\u63d0\u4f9b\u5bf9\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u4e30\u5bcc\u7684\u67e5\u8be2\uff0c\u805a\u5408\u4ee5\u53ca\u903b\u8f91\u8fd0\u7b97\u80fd\u529b\u7684\u652f\u6301\u3002\u5e76\u4e14\u88ab\u5e7f\u6cdb\u5e94\u7528\u5728 Prometheus \u7684\u65e5\u5e38\u5e94\u7528\u5f53\u4e2d\uff0c\u5305\u62ec\u5bf9\u6570\u636e\u67e5\u8be2\u3001\u53ef\u89c6\u5316\u3001\u544a\u8b66\u5904\u7406\u3002\u53ef\u4ee5\u8fd9\u4e48\u8bf4\uff0c<code>PromQL</code> \u662f Prometheus \u6240\u6709\u5e94\u7528\u573a\u666f\u7684\u57fa\u7840\uff0c\u7406\u89e3\u548c\u638c\u63e1 <code>PromQL</code> \u662f\u6211\u4eec\u4f7f\u7528 Prometheus \u5fc5\u5907\u7684\u6280\u80fd\u3002</p>"},{"location":"kubernetes_monitor/promql/#_1","title":"\u65f6\u95f4\u5e8f\u5217","text":"<p>\u524d\u9762\u6211\u4eec\u901a\u8fc7 node-exporter \u66b4\u9732\u7684 metrics \u670d\u52a1\uff0cPrometheus \u53ef\u4ee5\u91c7\u96c6\u5230\u5f53\u524d\u4e3b\u673a\u6240\u6709\u76d1\u63a7\u6307\u6807\u7684\u6837\u672c\u6570\u636e\u3002\u4f8b\u5982\uff1a</p> <pre><code># HELP node_cpu_seconds_total Seconds the cpus spent in each mode.\n# TYPE node_cpu_seconds_total counter\nnode_cpu_seconds_total{cpu=\"0\",mode=\"idle\"} 62885731e+06\n# HELP node_load1 1m load average.\n# TYPE node_load1 gauge\nnode_load1 29\n</code></pre> <p>\u5176\u4e2d\u975e <code>#</code> \u5f00\u5934\u7684\u6bcf\u4e00\u884c\u8868\u793a\u5f53\u524d node-exporter \u91c7\u96c6\u5230\u7684\u4e00\u4e2a\u76d1\u63a7\u6837\u672c\uff1a</p> <pre><code>node_cpu_seconds_total\n</code></pre> <p>\u548c <code>node_load1</code> \u8868\u660e\u4e86\u5f53\u524d\u6307\u6807\u7684\u540d\u79f0\u3001\u5927\u62ec\u53f7\u4e2d\u7684\u6807\u7b7e\u5219\u53cd\u6620\u4e86\u5f53\u524d\u6837\u672c\u7684\u4e00\u4e9b\u7279\u5f81\u548c\u7ef4\u5ea6\u3001\u6d6e\u70b9\u6570\u5219\u662f\u8be5\u76d1\u63a7\u6837\u672c\u7684\u5177\u4f53\u503c\u3002</p> <p>Prometheus \u4f1a\u5c06\u6240\u6709\u91c7\u96c6\u5230\u7684\u6837\u672c\u6570\u636e\u4ee5\u65f6\u95f4\u5e8f\u5217\u7684\u65b9\u5f0f\u4fdd\u5b58\u5728<code>\u5185\u5b58\u6570\u636e\u5e93</code>\u4e2d\uff0c\u5e76\u4e14\u5b9a\u65f6\u4fdd\u5b58\u5230\u786c\u76d8\u4e0a\u3002\u65f6\u95f4\u5e8f\u5217\u662f\u6309\u7167\u65f6\u95f4\u6233\u548c\u503c\u7684\u5e8f\u5217\u987a\u5e8f\u5b58\u653e\u7684\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a\u5411\u91cf(vector)\uff0c\u6bcf\u6761\u65f6\u95f4\u5e8f\u5217\u901a\u8fc7\u6307\u6807\u540d\u79f0(metrics name)\u548c\u4e00\u7ec4\u6807\u7b7e\u96c6(labelset)\u547d\u540d\u3002\u5982\u4e0b\u6240\u793a\uff0c\u53ef\u4ee5\u5c06\u65f6\u95f4\u5e8f\u5217\u7406\u89e3\u4e3a\u4e00\u4e2a\u4ee5\u65f6\u95f4\u4e3a X \u8f74\u7684\u6570\u5b57\u77e9\u9635\uff1a</p> <pre><code>^\n  \u2502   . . . . . . . . . . . . . . . . .   . .   node_cpu_seconds_total{cpu=\"cpu0\",mode=\"idle\"}\n  \u2502     . . . . . . . . . . . . . . . . . . .   node_cpu_seconds_total{cpu=\"cpu0\",mode=\"system\"}\n  \u2502     . . . . . . . . . .   . . . . . . . .   node_load1{}\n  \u2502     . . . . . . . . . . . . . . . .   . .  \n  v\n    &lt;------------------ \u65f6\u95f4 ----------------&gt;\n</code></pre> <p>\u5728\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684\u6bcf\u4e00\u4e2a\u70b9\u79f0\u4e3a\u4e00\u4e2a\u6837\u672c\uff08sample\uff09\uff0c\u6837\u672c\u7531\u4ee5\u4e0b\u4e09\u90e8\u5206\u7ec4\u6210\uff1a</p> <ul> <li>\u6307\u6807(metric)\uff1ametric name \u548c\u63cf\u8ff0\u5f53\u524d\u6837\u672c\u7279\u5f81\u7684 labelsets</li> <li>\u65f6\u95f4\u6233(timestamp)\uff1a\u4e00\u4e2a\u7cbe\u786e\u5230\u6beb\u79d2\u7684\u65f6\u95f4\u6233</li> <li>\u6837\u672c\u503c(value)\uff1a \u4e00\u4e2a float64 \u7684\u6d6e\u70b9\u578b\u6570\u636e\u8868\u793a\u5f53\u524d\u6837\u672c\u7684\u503c</li> </ul> <p>\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>&lt;--------------- metric ---------------------&gt;&lt;-timestamp -&gt;&lt;-value-&gt;\nhttp_request_total{status=\"200\", method=\"GET\"}@1434417560938 =&gt; 94355\nhttp_request_total{status=\"200\", method=\"GET\"}@1434417561287 =&gt; 94334\n\nhttp_request_total{status=\"404\", method=\"GET\"}@1434417560938 =&gt; 38473\nhttp_request_total{status=\"404\", method=\"GET\"}@1434417561287 =&gt; 38544\n\nhttp_request_total{status=\"200\", method=\"POST\"}@1434417560938 =&gt; 4748\nhttp_request_total{status=\"200\", method=\"POST\"}@1434417561287 =&gt; 4785\n</code></pre> <p>\u5728\u5f62\u5f0f\u4e0a\uff0c\u6240\u6709\u7684\u6307\u6807(Metric)\u90fd\u901a\u8fc7\u5982\u4e0b\u683c\u5f0f\u8868\u793a\uff1a</p> <pre><code>&lt;metric name&gt;{&lt;label name&gt; = &lt;label value&gt;, ...}\n</code></pre> <ul> <li> <p>\u6307\u6807\u7684\u540d\u79f0(metric name)\u53ef\u4ee5\u53cd\u6620\u88ab\u76d1\u63a7\u6837\u672c\u7684\u542b\u4e49\uff08\u6bd4\u5982\uff0chttp_request_total - \u8868\u793a\u5f53\u524d\u7cfb\u7edf\u63a5\u6536\u5230\u7684 HTTP \u8bf7\u6c42\u603b\u91cf\uff09\u3002\u6307\u6807\u540d\u79f0\u53ea\u80fd\u7531 ASCII \u5b57\u7b26\u3001\u6570\u5b57\u3001\u4e0b\u5212\u7ebf\u4ee5\u53ca\u5192\u53f7\u7ec4\u6210\u5e76\u5fc5\u987b\u7b26\u5408\u6b63\u5219\u8868\u8fbe\u5f0f</p> <pre><code>[a-zA-Z_:][a-zA-Z0-9_:]*\n</code></pre> <p>\u3002</p> </li> <li> <p>\u6807\u7b7e(label)\u53cd\u6620\u4e86\u5f53\u524d\u6837\u672c\u7684\u7279\u5f81\u7ef4\u5ea6\uff0c\u901a\u8fc7\u8fd9\u4e9b\u7ef4\u5ea6 Prometheus \u53ef\u4ee5\u5bf9\u6837\u672c\u6570\u636e\u8fdb\u884c\u8fc7\u6ee4\uff0c\u805a\u5408\u7b49\u3002\u6807\u7b7e\u7684\u540d\u79f0\u53ea\u80fd\u7531 ASCII \u5b57\u7b26\u3001\u6570\u5b57\u4ee5\u53ca\u4e0b\u5212\u7ebf\u7ec4\u6210\u5e76\u6ee1\u8db3\u6b63\u5219\u8868\u8fbe\u5f0f </p> <pre><code>[a-zA-Z_][a-zA-Z0-9_]*\n</code></pre> <p>\u3002</p> </li> </ul> <p>\u6bcf\u4e2a\u4e0d\u540c\u7684 <code>metric_name</code>\u548c <code>label</code> \u7ec4\u5408\u90fd\u79f0\u4e3a<code>\u65f6\u95f4\u5e8f\u5217</code>\uff0c\u5728 Prometheus \u7684\u8868\u8fbe\u5f0f\u8bed\u8a00\u4e2d\uff0c\u8868\u8fbe\u5f0f\u6216\u5b50\u8868\u8fbe\u5f0f\u5305\u62ec\u4ee5\u4e0b\u56db\u79cd\u7c7b\u578b\u4e4b\u4e00\uff1a</p> <ul> <li>\u77ac\u65f6\u5411\u91cf\uff08Instant vector\uff09\uff1a\u4e00\u7ec4\u65f6\u95f4\u5e8f\u5217\uff0c\u6bcf\u4e2a\u65f6\u95f4\u5e8f\u5217\u5305\u542b\u5355\u4e2a\u6837\u672c\uff0c\u5b83\u4eec\u5171\u4eab\u76f8\u540c\u7684\u65f6\u95f4\u6233\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8868\u8fbe\u5f0f\u7684\u8fd4\u56de\u503c\u4e2d\u53ea\u4f1a\u5305\u542b\u8be5\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684\u6700\u65b0\u7684\u4e00\u4e2a\u6837\u672c\u503c\u3002\u800c\u76f8\u5e94\u7684\u8fd9\u6837\u7684\u8868\u8fbe\u5f0f\u79f0\u4e4b\u4e3a\u77ac\u65f6\u5411\u91cf\u8868\u8fbe\u5f0f\u3002</li> <li>\u533a\u95f4\u5411\u91cf\uff08Range vector\uff09\uff1a\u4e00\u7ec4\u65f6\u95f4\u5e8f\u5217\uff0c\u6bcf\u4e2a\u65f6\u95f4\u5e8f\u5217\u5305\u542b\u4e00\u6bb5\u65f6\u95f4\u8303\u56f4\u5185\u7684\u6837\u672c\u6570\u636e\uff0c\u8fd9\u4e9b\u662f\u901a\u8fc7\u5c06\u65f6\u95f4\u9009\u62e9\u5668\u9644\u52a0\u5230\u65b9\u62ec\u53f7\u4e2d\u7684\u77ac\u65f6\u5411\u91cf\uff08\u4f8b\u5982[5m]5\u5206\u949f\uff09\u800c\u751f\u6210\u7684\u3002</li> <li>\u6807\u91cf\uff08Scalar\uff09\uff1a\u4e00\u4e2a\u7b80\u5355\u7684\u6570\u5b57\u6d6e\u70b9\u503c\u3002</li> <li>\u5b57\u7b26\u4e32\uff08String\uff09\uff1a\u4e00\u4e2a\u7b80\u5355\u7684\u5b57\u7b26\u4e32\u503c\u3002</li> </ul> <p>\u6240\u6709\u8fd9\u4e9b\u6307\u6807\u90fd\u662f Prometheus \u5b9a\u671f\u4ece metrics \u63a5\u53e3\u90a3\u91cc\u91c7\u96c6\u8fc7\u6765\u7684\u3002\u91c7\u96c6\u7684\u95f4\u9694\u65f6\u95f4\u7684\u8bbe\u7f6e\u7531 <code>prometheus.yaml</code> \u914d\u7f6e\u4e2d\u7684 <code>scrape_interval</code> \u6307\u5b9a\u3002\u6700\u591a\u6293\u53d6\u95f4\u9694\u4e3a30\u79d2\uff0c\u8fd9\u610f\u5473\u7740\u81f3\u5c11\u6bcf30\u79d2\u5c31\u4f1a\u6709\u4e00\u4e2a\u5e26\u6709\u65b0\u65f6\u95f4\u6233\u8bb0\u5f55\u7684\u65b0\u6570\u636e\u70b9\uff0c\u8fd9\u4e2a\u503c\u53ef\u80fd\u4f1a\u66f4\u6539\uff0c\u4e5f\u53ef\u80fd\u4e0d\u4f1a\u66f4\u6539\uff0c\u4f46\u662f\u6bcf\u9694 <code>scrape_interval</code> \u90fd\u4f1a\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u70b9\u3002</p>"},{"location":"kubernetes_monitor/promql/#_2","title":"\u6307\u6807\u7c7b\u578b","text":"<p>\u4ece\u5b58\u50a8\u4e0a\u6765\u8bb2\u6240\u6709\u7684\u76d1\u63a7\u6307\u6807 metric \u90fd\u662f\u76f8\u540c\u7684\uff0c\u4f46\u662f\u5728\u4e0d\u540c\u7684\u573a\u666f\u4e0b\u8fd9\u4e9b metric \u53c8\u6709\u4e00\u4e9b\u7ec6\u5fae\u7684\u5dee\u5f02\u3002 \u4f8b\u5982\uff0c\u5728 Node Exporter \u8fd4\u56de\u7684\u6837\u672c\u4e2d\u6307\u6807 <code>node_load1</code> \u53cd\u5e94\u7684\u662f\u5f53\u524d\u7cfb\u7edf\u7684\u8d1f\u8f7d\u72b6\u6001\uff0c\u968f\u7740\u65f6\u95f4\u7684\u53d8\u5316\u8fd9\u4e2a\u6307\u6807\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u662f\u5728\u4e0d\u65ad\u53d8\u5316\u7684\u3002\u800c\u6307\u6807 </p> <pre><code>node_cpu_seconds_total\n</code></pre> <p>\u6240\u83b7\u53d6\u5230\u7684\u6837\u672c\u6570\u636e\u5374\u4e0d\u540c\uff0c\u5b83\u662f\u4e00\u4e2a\u6301\u7eed\u589e\u5927\u7684\u503c\uff0c\u56e0\u4e3a\u5176\u53cd\u5e94\u7684\u662f CPU \u7684\u7d2f\u8ba1\u4f7f\u7528\u65f6\u95f4\uff0c\u4ece\u7406\u8bba\u4e0a\u8bb2\u53ea\u8981\u7cfb\u7edf\u4e0d\u5173\u673a\uff0c\u8fd9\u4e2a\u503c\u662f\u4f1a\u4e00\u76f4\u53d8\u5927\u3002</p> <p>\u4e3a\u4e86\u80fd\u591f\u5e2e\u52a9\u7528\u6237\u7406\u89e3\u548c\u533a\u5206\u8fd9\u4e9b\u4e0d\u540c\u76d1\u63a7\u6307\u6807\u4e4b\u95f4\u7684\u5dee\u5f02\uff0cPrometheus \u5b9a\u4e49\u4e864\u79cd\u4e0d\u540c\u7684\u6307\u6807\u7c7b\u578b\uff1aCounter\uff08\u8ba1\u6570\u5668\uff09\u3001Gauge\uff08\u4eea\u8868\u76d8\uff09\u3001Histogram\uff08\u76f4\u65b9\u56fe\uff09\u3001Summary\uff08\u6458\u8981\uff09\u3002</p> <p>\u5728 node-exporter \u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\uff0c\u5176\u6ce8\u91ca\u4e2d\u4e5f\u5305\u542b\u4e86\u8be5\u6837\u672c\u7684\u7c7b\u578b\u3002\u4f8b\u5982\uff1a</p> <pre><code># HELP node_cpu_seconds_total Seconds the cpus spent in each mode.\n# TYPE node_cpu_seconds_total counter\nnode_cpu_seconds_total{cpu=\"cpu0\",mode=\"idle\"} 36287890625\n</code></pre>"},{"location":"kubernetes_monitor/promql/#counter","title":"Counter","text":"<p><code>Counter</code> (\u53ea\u589e\u4e0d\u51cf\u7684\u8ba1\u6570\u5668) \u7c7b\u578b\u7684\u6307\u6807\u5176\u5de5\u4f5c\u65b9\u5f0f\u548c\u8ba1\u6570\u5668\u4e00\u6837\uff0c\u53ea\u589e\u4e0d\u51cf\u3002\u5e38\u89c1\u7684\u76d1\u63a7\u6307\u6807\uff0c\u5982 <code>http_requests_total</code>\u3001</p> <pre><code>node_cpu_seconds_total\n</code></pre> <p>\u90fd\u662f <code>Counter</code> \u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\u3002</p> <p><code>Counter</code> \u662f\u4e00\u4e2a\u7b80\u5355\u4f46\u53c8\u5f3a\u5927\u7684\u5de5\u5177\uff0c\u4f8b\u5982\u6211\u4eec\u53ef\u4ee5\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u8bb0\u5f55\u67d0\u4e9b\u4e8b\u4ef6\u53d1\u751f\u7684\u6b21\u6570\uff0c\u901a\u8fc7\u4ee5\u65f6\u95f4\u5e8f\u5217\u7684\u5f62\u5f0f\u5b58\u50a8\u8fd9\u4e9b\u6570\u636e\uff0c\u6211\u4eec\u53ef\u4ee5\u8f7b\u677e\u7684\u4e86\u89e3\u8be5\u4e8b\u4ef6\u4ea7\u751f\u7684\u901f\u7387\u53d8\u5316\u3002<code>PromQL</code> \u5185\u7f6e\u7684\u805a\u5408\u64cd\u4f5c\u548c\u51fd\u6570\u53ef\u4ee5\u8ba9\u7528\u6237\u5bf9\u8fd9\u4e9b\u6570\u636e\u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u5206\u6790\uff0c\u4f8b\u5982\uff0c\u901a\u8fc7 <code>rate()</code> \u51fd\u6570\u83b7\u53d6 HTTP \u8bf7\u6c42\u91cf\u7684\u589e\u957f\u7387\uff1a</p> <pre><code>rate(http_requests_total[5m])\n</code></pre> <p>\u67e5\u8be2\u5f53\u524d\u7cfb\u7edf\u4e2d\uff0c\u8bbf\u95ee\u91cf\u524d 10 \u7684 HTTP \u8bf7\u6c42\uff1a</p> <pre><code>topk(10, http_requests_total)\n</code></pre>"},{"location":"kubernetes_monitor/promql/#gauge","title":"Gauge","text":"<p>\u4e0e <code>Counter</code> \u4e0d\u540c\uff0c<code>Gauge</code>\uff08\u53ef\u589e\u53ef\u51cf\u7684\u4eea\u8868\u76d8\uff09\u7c7b\u578b\u7684\u6307\u6807\u4fa7\u91cd\u4e8e\u53cd\u5e94\u7cfb\u7edf\u7684\u5f53\u524d\u72b6\u6001\u3002\u56e0\u6b64\u8fd9\u7c7b\u6307\u6807\u7684\u6837\u672c\u6570\u636e\u53ef\u589e\u53ef\u51cf\u3002\u5e38\u89c1\u6307\u6807\u5982\uff1a</p> <pre><code>node_memory_MemFree_bytes\n</code></pre> <p>\uff08\u4e3b\u673a\u5f53\u524d\u7a7a\u95f2\u7684\u5185\u5b58\u5927\u5c0f\uff09\u3001</p> <pre><code>node_memory_MemAvailable_bytes\n</code></pre> <p>\uff08\u53ef\u7528\u5185\u5b58\u5927\u5c0f\uff09\u90fd\u662f <code>Gauge</code> \u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\u3002\u901a\u8fc7 <code>Gauge</code> \u6307\u6807\uff0c\u7528\u6237\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b\u7cfb\u7edf\u7684\u5f53\u524d\u72b6\u6001\uff1a</p> <pre><code>node_memory_MemFree_bytes\n</code></pre> <p>\u5bf9\u4e8e <code>Gauge</code> \u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\uff0c\u901a\u8fc7 <code>PromQL</code> \u5185\u7f6e\u51fd\u6570 <code>delta()</code> \u53ef\u4ee5\u83b7\u53d6\u6837\u672c\u5728\u4e00\u6bb5\u65f6\u95f4\u8303\u56f4\u5185\u7684\u53d8\u5316\u60c5\u51b5\u3002\u4f8b\u5982\uff0c\u8ba1\u7b97 CPU \u6e29\u5ea6\u5728\u4e24\u4e2a\u5c0f\u65f6\u5185\u7684\u5dee\u5f02\uff1a</p> <pre><code>delta(cpu_temp_celsius{host=\"zeus\"}[2h])\n</code></pre> <p>\u8fd8\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>predict_linear()</code> \u5bf9\u6570\u636e\u7684\u53d8\u5316\u8d8b\u52bf\u8fdb\u884c\u9884\u6d4b\u3002\u4f8b\u5982\uff0c\u9884\u6d4b\u7cfb\u7edf\u78c1\u76d8\u7a7a\u95f4\u57284\u4e2a\u5c0f\u65f6\u4e4b\u540e\u7684\u5269\u4f59\u60c5\u51b5\uff1a</p> <pre><code>predict_linear(node_filesystem_free_bytes[1h], 4 * 3600)\n</code></pre>"},{"location":"kubernetes_monitor/promql/#histogram_summary","title":"Histogram \u548c Summary","text":"<p>\u9664\u4e86 <code>Counter</code> \u548c <code>Gauge</code> \u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\u4ee5\u5916\uff0cPrometheus \u8fd8\u5b9a\u4e49\u4e86 <code>Histogram</code> \u548c <code>Summary</code> \u7684\u6307\u6807\u7c7b\u578b\u3002<code>Histogram</code> \u548c <code>Summary</code> \u4e3b\u7528\u7528\u4e8e\u7edf\u8ba1\u548c\u5206\u6790\u6837\u672c\u7684\u5206\u5e03\u60c5\u51b5\u3002</p> <p>\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u4eba\u4eec\u90fd\u503e\u5411\u4e8e\u4f7f\u7528\u67d0\u4e9b\u91cf\u5316\u6307\u6807\u7684\u5e73\u5747\u503c\uff0c\u4f8b\u5982 CPU \u7684\u5e73\u5747\u4f7f\u7528\u7387\u3001\u9875\u9762\u7684\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\uff0c\u8fd9\u79cd\u65b9\u5f0f\u4e5f\u6709\u5f88\u660e\u663e\u7684\u95ee\u9898\uff0c\u4ee5\u7cfb\u7edf API \u8c03\u7528\u7684\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\u4e3a\u4f8b\uff1a\u5982\u679c\u5927\u591a\u6570 API \u8bf7\u6c42\u90fd\u7ef4\u6301\u5728 100ms \u7684\u54cd\u5e94\u65f6\u95f4\u8303\u56f4\u5185\uff0c\u800c\u4e2a\u522b\u8bf7\u6c42\u7684\u54cd\u5e94\u65f6\u95f4\u9700\u8981 5s\uff0c\u90a3\u4e48\u5c31\u4f1a\u5bfc\u81f4\u67d0\u4e9b WEB \u9875\u9762\u7684\u54cd\u5e94\u65f6\u95f4\u843d\u5230<code>\u4e2d\u4f4d\u6570</code>\u4e0a\uff0c\u800c\u8fd9\u79cd\u73b0\u8c61\u88ab\u79f0\u4e3a<code>\u957f\u5c3e\u95ee\u9898</code>\u3002</p> <p>\u4e3a\u4e86\u533a\u5206\u662f\u5e73\u5747\u7684\u6162\u8fd8\u662f\u957f\u5c3e\u7684\u6162\uff0c\u6700\u7b80\u5355\u7684\u65b9\u5f0f\u5c31\u662f\u6309\u7167\u8bf7\u6c42\u5ef6\u8fdf\u7684\u8303\u56f4\u8fdb\u884c\u5206\u7ec4\u3002\u4f8b\u5982\uff0c\u7edf\u8ba1\u5ef6\u8fdf\u5728 0~10ms \u4e4b\u95f4\u7684\u8bf7\u6c42\u6570\u6709\u591a\u5c11\u800c 10~20ms \u4e4b\u95f4\u7684\u8bf7\u6c42\u6570\u53c8\u6709\u591a\u5c11\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u5feb\u901f\u5206\u6790\u7cfb\u7edf\u6162\u7684\u539f\u56e0\u3002<code>Histogram</code> \u548c <code>Summary</code> \u90fd\u662f\u4e3a\u4e86\u80fd\u591f\u89e3\u51b3\u8fd9\u6837\u7684\u95ee\u9898\u5b58\u5728\u7684\uff0c\u901a\u8fc7 <code>Histogram</code> \u548c<code>Summary</code> \u7c7b\u578b\u7684\u76d1\u63a7\u6307\u6807\uff0c\u6211\u4eec\u53ef\u4ee5\u5feb\u901f\u4e86\u89e3\u76d1\u63a7\u6837\u672c\u7684\u5206\u5e03\u60c5\u51b5\u3002</p> <p>\u4f8b\u5982\uff0c\u6307\u6807 </p> <pre><code>prometheus_tsdb_wal_fsync_duration_seconds\n</code></pre> <p>\u7684\u6307\u6807\u7c7b\u578b\u4e3a Summary\u3002\u5b83\u8bb0\u5f55\u4e86 Prometheus Server \u4e2d <code>wal_fsync</code> \u7684\u5904\u7406\u65f6\u95f4\uff0c\u901a\u8fc7\u8bbf\u95ee Prometheus Server \u7684 <code>/metrics</code> \u5730\u5740\uff0c\u53ef\u4ee5\u83b7\u53d6\u5230\u4ee5\u4e0b\u76d1\u63a7\u6837\u672c\u6570\u636e\uff1a</p> <pre><code># HELP prometheus_tsdb_wal_fsync_duration_seconds Duration of WAL fsync.\n# TYPE prometheus_tsdb_wal_fsync_duration_seconds summary\nprometheus_tsdb_wal_fsync_duration_seconds{quantile=\"5\"} 012352463\nprometheus_tsdb_wal_fsync_duration_seconds{quantile=\"9\"} 014458005\nprometheus_tsdb_wal_fsync_duration_seconds{quantile=\"99\"} 017316173\nprometheus_tsdb_wal_fsync_duration_seconds_sum 888716127000002\nprometheus_tsdb_wal_fsync_duration_seconds_count 216\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u6837\u672c\u4e2d\u53ef\u4ee5\u5f97\u77e5\u5f53\u524d Prometheus Server \u8fdb\u884c <code>wal_fsync</code> \u64cd\u4f5c\u7684\u603b\u6b21\u6570\u4e3a216\u6b21\uff0c\u8017\u65f62.888716127000002s\u3002\u5176\u4e2d\u4e2d\u4f4d\u6570\uff08quantile=0.5\uff09\u7684\u8017\u65f6\u4e3a0.012352463\uff0c9\u5206\u4f4d\u6570\uff08quantile=0.9\uff09\u7684\u8017\u65f6\u4e3a0.014458005s\u3002</p> <p>\u5728 Prometheus Server \u81ea\u8eab\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\uff0c\u6211\u4eec\u8fd8\u80fd\u627e\u5230\u7c7b\u578b\u4e3a Histogram \u7684\u76d1\u63a7\u6307\u6807</p> <pre><code>prometheus_tsdb_compaction_chunk_range_seconds_bucket\n</code></pre> <p>\uff1a</p> <pre><code># HELP prometheus_tsdb_compaction_chunk_range_seconds Final time range of chunks on their first compaction\n# TYPE prometheus_tsdb_compaction_chunk_range_seconds histogram\nprometheus_tsdb_compaction_chunk_range_seconds_bucket{le=\"100\"} 71\nprometheus_tsdb_compaction_chunk_range_seconds_bucket{le=\"400\"} 71\nprometheus_tsdb_compaction_chunk_range_seconds_bucket{le=\"1600\"} 71\nprometheus_tsdb_compaction_chunk_range_seconds_bucket{le=\"6400\"} 71\nprometheus_tsdb_compaction_chunk_range_seconds_bucket{le=\"25600\"} 405\nprometheus_tsdb_compaction_chunk_range_seconds_bucket{le=\"102400\"} 25690\nprometheus_tsdb_compaction_chunk_range_seconds_bucket{le=\"409600\"} 71863\nprometheus_tsdb_compaction_chunk_range_seconds_bucket{le=\"6384e+06\"} 115928\nprometheus_tsdb_compaction_chunk_range_seconds_bucket{le=\"5536e+06\"} 5687892e+07\nprometheus_tsdb_compaction_chunk_range_seconds_bucket{le=\"62144e+07\"} 5687896e+07\nprometheus_tsdb_compaction_chunk_range_seconds_bucket{le=\"+Inf\"} 5687896e+07\nprometheus_tsdb_compaction_chunk_range_seconds_sum 7728699529576e+13\nprometheus_tsdb_compaction_chunk_range_seconds_count 5687896e+07\n</code></pre> <p>\u4e0e <code>Summary</code> \u7c7b\u578b\u7684\u6307\u6807\u76f8\u4f3c\u4e4b\u5904\u5728\u4e8e <code>Histogram</code> \u7c7b\u578b\u7684\u6837\u672c\u540c\u6837\u4f1a\u53cd\u5e94\u5f53\u524d\u6307\u6807\u7684\u8bb0\u5f55\u7684\u603b\u6570(\u4ee5 <code>_count</code> \u4f5c\u4e3a\u540e\u7f00)\u4ee5\u53ca\u5176\u503c\u7684\u603b\u91cf\uff08\u4ee5 <code>_sum</code> \u4f5c\u4e3a\u540e\u7f00\uff09\u3002\u4e0d\u540c\u5728\u4e8e <code>Histogram</code> \u6307\u6807\u76f4\u63a5\u53cd\u5e94\u4e86\u5728\u4e0d\u540c\u533a\u95f4\u5185\u6837\u672c\u7684\u4e2a\u6570\uff0c\u533a\u95f4\u901a\u8fc7\u6807\u7b7e le \u8fdb\u884c\u5b9a\u4e49\u3002</p>"},{"location":"kubernetes_monitor/promql/#_3","title":"\u67e5\u8be2","text":"<p>\u5f53 Prometheus \u91c7\u96c6\u5230\u76d1\u63a7\u6307\u6807\u6837\u672c\u6570\u636e\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 PromQL \u5bf9\u76d1\u63a7\u6837\u672c\u6570\u636e\u8fdb\u884c\u67e5\u8be2\u3002\u57fa\u672c\u7684 Prometheus \u67e5\u8be2\u7684\u7ed3\u6784\u975e\u5e38\u7c7b\u4f3c\u4e8e\u4e00\u4e2a metric \u6307\u6807\uff0c\u4ee5\u6307\u6807\u540d\u79f0\u5f00\u59cb\u3002</p>"},{"location":"kubernetes_monitor/promql/#_4","title":"\u67e5\u8be2\u7ed3\u6784","text":"<p>\u6bd4\u5982\u53ea\u67e5\u8be2 </p> <pre><code>node_cpu_seconds_total\n</code></pre> <p>\u5219\u4f1a\u8fd4\u56de\u6240\u6709\u91c7\u96c6\u8282\u70b9\u7684\u6240\u6709\u7c7b\u578b\u7684 CPU \u65f6\u957f\u6570\u636e\uff0c\u5f53\u7136\u5982\u679c\u6570\u636e\u91cf\u7279\u522b\u7279\u522b\u5927\u7684\u65f6\u5019\uff0c\u76f4\u63a5\u5728 Grafana \u6267\u884c\u8be5\u67e5\u8be2\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u5219\u53ef\u80fd\u5bfc\u81f4\u6d4f\u89c8\u5668\u5d29\u6e83\uff0c\u56e0\u4e3a\u5b83\u540c\u65f6\u9700\u8981\u6e32\u67d3\u7684\u6570\u636e\u70b9\u592a\u591a\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u53ef\u4ee5\u4f7f\u7528\u6807\u7b7e\u8fdb\u884c\u8fc7\u6ee4\u67e5\u8be2\uff0c\u6807\u7b7e\u8fc7\u6ee4\u5668\u652f\u63014\u79cd\u8fd0\u7b97\u7b26\uff1a</p> <ul> <li><code>=</code> \u7b49\u4e8e</li> <li><code>!=</code> \u4e0d\u7b49\u4e8e</li> <li><code>=~</code> \u5339\u914d\u6b63\u5219\u8868\u8fbe\u5f0f</li> <li><code>!~</code> \u4e0e\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0d\u5339\u914d</li> </ul> <p>\u6807\u7b7e\u8fc7\u6ee4\u5668\u90fd\u4f4d\u4e8e\u6307\u6807\u540d\u79f0\u540e\u9762\u7684<code>{}</code>\u5185\uff0c\u6bd4\u5982\u8fc7\u6ee4 master \u8282\u70b9\u7684 CPU \u4f7f\u7528\u6570\u636e\u53ef\u7528\u5982\u4e0b\u67e5\u8be2\u8bed\u53e5\uff1a</p> <pre><code>node_cpu_seconds_total{instance=\"ydzs-master\"}\n</code></pre> <p>\u6b63\u5219\u5339\u914d</p> <p>PromQL \u67e5\u8be2\u8bed\u53e5\u4e2d\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u4f7f\u7528 RE2\u8bed\u6cd5\u3002</p> <p>\u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u591a\u4e2a\u6807\u7b7e\u8fc7\u6ee4\u5668\uff0c\u4ee5\u9017\u53f7\u5206\u9694\u3002\u591a\u4e2a\u6807\u7b7e\u8fc7\u6ee4\u5668\u4e4b\u95f4\u662f <code>AND</code> \u7684\u5173\u7cfb\uff0c\u6240\u4ee5\u4f7f\u7528\u591a\u4e2a\u6807\u7b7e\u8fdb\u884c\u8fc7\u6ee4\uff0c\u8fd4\u56de\u7684\u6307\u6807\u6570\u636e\u5fc5\u987b\u548c\u6240\u6709\u6807\u7b7e\u8fc7\u6ee4\u5668\u5339\u914d\u3002</p> <p>\u4f8b\u5982\u5982\u4e0b\u67e5\u8be2\u8bed\u53e5\u5c06\u8fd4\u56de\u6240\u6709\u4ee5 <code>ydzs-</code>\u4e3a\u524d\u7f00\u7684\u8282\u70b9\u7684\u5e76\u4e14\u662f <code>idle</code> \u6a21\u5f0f\u4e0b\u9762\u7684\u8282\u70b9 CPU \u4f7f\u7528\u65f6\u957f\u6307\u6807\uff1a</p> <pre><code>node_cpu_seconds_total{instance=~\"ydzs-.*\", mode=\"idle\"}\n</code></pre>"},{"location":"kubernetes_monitor/promql/#_5","title":"\u8303\u56f4\u9009\u62e9\u5668","text":"<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5c06\u65f6\u95f4\u8303\u56f4\u9009\u62e9\u5668\uff08[]\uff09\u9644\u52a0\u5230\u67e5\u8be2\u8bed\u53e5\u4e2d\uff0c\u6307\u5b9a\u4e3a\u6bcf\u4e2a\u8fd4\u56de\u7684\u533a\u95f4\u5411\u91cf\u6837\u672c\u503c\u4e2d\u63d0\u53d6\u591a\u957f\u7684\u65f6\u95f4\u8303\u56f4\u3002\u6bcf\u4e2a\u65f6\u95f4\u6233\u7684\u503c\u90fd\u662f\u6309\u65f6\u95f4\u5012\u5e8f\u8bb0\u5f55\u5728\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684\uff0c\u8be5\u503c\u662f\u4ece\u65f6\u95f4\u8303\u56f4\u5185\u7684\u65f6\u95f4\u6233\u83b7\u53d6\u7684\u5bf9\u5e94\u7684\u503c\u3002</p> <p>\u65f6\u95f4\u8303\u56f4\u901a\u8fc7\u6570\u5b57\u6765\u8868\u793a\uff0c\u5355\u4f4d\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u5176\u4e2d\u4e4b\u4e00\u7684\u65f6\u95f4\u5355\u4f4d\uff1a</p> <ul> <li>s - \u79d2</li> <li>m - \u5206\u949f</li> <li>h - \u5c0f\u65f6</li> <li>d - \u5929</li> <li>w - \u5468</li> <li>y - \u5e74</li> </ul> <p>\u6bd4\u5982 </p> <pre><code>node_cpu_seconds_total{instance=\"ydzs-master\", mode=\"idle\"}\n</code></pre> <p>\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\uff0c\u5982\u679c\u6dfb\u52a0\u4e0a <code>[1m]</code> \u8fd9\u4e2a\u65f6\u95f4\u8303\u56f4\u9009\u62e9\u5668\uff0c\u5219\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u4fe1\u606f\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u4e24\u4e2a\u65f6\u95f4\u5e8f\u5217\u90fd\u67094\u4e2a\u503c\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec Prometheus \u4e2d\u914d\u7f6e\u7684\u6293\u53d6\u95f4\u9694\u662f15\u79d2\uff0c\u6240\u4ee5\uff0c\u6211\u4eec\u4ece\u56fe\u4e2d\u7684 <code>@</code> \u7b26\u53f7\u540e\u9762\u7684\u65f6\u95f4\u6233\u53ef\u4ee5\u770b\u51fa\uff0c\u5b83\u4eec\u4e4b\u95f4\u7684\u95f4\u9694\u57fa\u672c\u4e0a\u5c31\u662f15\u79d2\u3002</p> <p>\u4f46\u662f\u73b0\u5728\u5982\u679c\u6211\u4eec\u5728 Prometheus \u7684\u9875\u9762\u4e2d\u67e5\u8be2\u4e0a\u9762\u7684\u8bed\u53e5\uff0c\u7136\u540e\u5207\u6362\u5230 <code>Graph</code> \u9009\u9879\u5361\u7684\u65f6\u5019\uff0c\u5219\u4f1a\u51fa\u73b0\u5982\u4e0b\u6240\u793a\u7684\u9519\u8bef\u4fe1\u606f\uff1a </p> <p>\u8fd9\u662f\u56e0\u4e3a\u73b0\u5728\u6bcf\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u4e2d\u90fd\u6709\u591a\u4e2a\u65f6\u95f4\u6233\u591a\u4e2a\u503c\uff0c\u6240\u4ee5\u6ca1\u529e\u6cd5\u6e32\u67d3\uff0c\u5fc5\u987b\u662f\u6807\u91cf\u6216\u8005\u77ac\u65f6\u5411\u91cf\u624d\u53ef\u4ee5\u7ed8\u5236\u56fe\u5f62\u3002</p> <p>\u4e0d\u8fc7\u901a\u5e38\u533a\u95f4\u5411\u91cf\u90fd\u4f1a\u5e94\u7528\u4e00\u4e2a\u51fd\u6570\u540e\u53d8\u6210\u53ef\u4ee5\u7ed8\u5236\u7684\u77ac\u65f6\u5411\u91cf\uff0cPrometheus \u4e2d\u5bf9\u77ac\u65f6\u5411\u91cf\u548c\u533a\u95f4\u5411\u91cf\u6709\u5f88\u591a\u64cd\u4f5c\u7684\u51fd\u6570\uff0c\u4e0d\u8fc7\u5bf9\u4e8e\u533a\u95f4\u5411\u91cf\u6765\u8bf4\u6700\u5e38\u7528\u7684\u51fd\u6570\u5e76\u4e0d\u591a\uff0c\u4f7f\u7528\u6700\u9891\u7e41\u7684\u6709\u5982\u4e0b\u51e0\u4e2a\u51fd\u6570\uff1a</p> <ul> <li><code>rate()</code>: \u8ba1\u7b97\u6574\u4e2a\u65f6\u95f4\u8303\u56f4\u5185\u533a\u95f4\u5411\u91cf\u4e2d\u65f6\u95f4\u5e8f\u5217\u7684\u6bcf\u79d2\u5e73\u5747\u589e\u957f\u7387</li> <li><code>irate()</code>: \u4ec5\u4f7f\u7528\u65f6\u95f4\u8303\u56f4\u4e2d\u7684<code>\u6700\u540e\u4e24\u4e2a\u6570\u636e\u70b9</code>\u6765\u8ba1\u7b97\u533a\u95f4\u5411\u91cf\u4e2d\u65f6\u95f4\u5e8f\u5217\u7684\u6bcf\u79d2\u5e73\u5747\u589e\u957f\u7387\uff0c<code>irate</code> \u53ea\u80fd\u7528\u4e8e\u7ed8\u5236\u5feb\u901f\u53d8\u5316\u7684\u5e8f\u5217\uff0c\u5728\u957f\u671f\u8d8b\u52bf\u5206\u6790\u6216\u8005\u544a\u8b66\u4e2d\u66f4\u63a8\u8350\u4f7f\u7528 <code>rate</code> \u51fd\u6570</li> <li><code>increase()</code>: \u8ba1\u7b97\u6240\u9009\u65f6\u95f4\u8303\u56f4\u5185\u65f6\u95f4\u5e8f\u5217\u7684\u589e\u91cf\uff0c\u5b83\u57fa\u672c\u4e0a\u662f\u901f\u7387\u4e58\u4ee5\u65f6\u95f4\u8303\u56f4\u9009\u62e9\u5668\u4e2d\u7684\u79d2\u6570</li> </ul> <p>\u6211\u4eec\u9009\u62e9\u7684\u65f6\u95f4\u8303\u56f4\u6301\u7eed\u65f6\u95f4\u5c06\u786e\u5b9a\u56fe\u8868\u7684\u7c92\u5ea6\uff0c\u6bd4\u5982\uff0c\u6301\u7eed\u65f6\u95f4 <code>[1m]</code> \u4f1a\u7ed9\u51fa\u975e\u5e38\u5c16\u9510\u7684\u56fe\u8868\uff0c\u4ece\u800c\u5f88\u96be\u76f4\u89c2\u7684\u663e\u793a\u51fa\u8d8b\u52bf\u6765\uff0c\u770b\u8d77\u6765\u50cf\u8fd9\u6837\uff1a</p> <p></p> <p>\u5bf9\u4e8e\u4e00\u4e2a\u4e00\u5c0f\u65f6\u7684\u56fe\u8868\uff0c<code>[5m]</code> \u663e\u793a\u7684\u56fe\u8868\u770b\u4e0a\u53bb\u8981\u66f4\u52a0\u5408\u9002\u4e00\u4e9b\uff0c\u66f4\u80fd\u663e\u793a\u51fa CPU \u4f7f\u7528\u7684\u8d8b\u52bf\uff1a</p> <p></p> <p>\u5bf9\u4e8e\u66f4\u957f\u7684\u65f6\u95f4\u8de8\u5ea6\uff0c\u53ef\u80fd\u9700\u8981\u8bbe\u7f6e\u66f4\u957f\u7684\u6301\u7eed\u65f6\u95f4\uff0c\u4ee5\u4fbf\u6d88\u9664\u6ce2\u5cf0\u5e76\u83b7\u5f97\u66f4\u591a\u7684\u957f\u671f\u8d8b\u52bf\u56fe\u8868\u3002\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u6bd4\u8f83\u6301\u7eed\u65f6\u95f4\u4e3a<code>[5m]</code> \u548c <code>[30m]</code> \u7684\u4e00\u5929\u5185\u7684\u56fe\u8868\uff1a</p> <p></p> <p></p> <p>\u6709\u7684\u65f6\u5019\u53ef\u80fd\u60f3\u8981\u67e5\u770b5\u5206\u949f\u524d\u6216\u8005\u6628\u5929\u4e00\u5929\u7684\u533a\u95f4\u5185\u7684\u6837\u672c\u6570\u636e\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u7528\u5230\u4f4d\u79fb\u64cd\u4f5c\u4e86\uff0c\u4f4d\u79fb\u64cd\u4f5c\u7684\u5173\u952e\u5b57\u662f <code>offset</code>\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u67e5\u8be230\u5206\u949f\u4e4b\u524d\u7684 master \u8282\u70b9 CPU \u7684\u7a7a\u95f2\u6307\u6807\u6570\u636e\uff1a</p> <pre><code>node_cpu_seconds_total{instance=\"ydzs-master\", mode=\"idle\"} offset 30m\n</code></pre> <p>\u6ce8\u610f</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f <code>offset</code> \u5173\u952e\u5b57\u9700\u8981\u7d27\u8ddf\u5728\u9009\u62e9\u5668(<code>{}</code>)\u540e\u9762\u3002</p> <p>\u540c\u6837\u4f4d\u79fb\u64cd\u4f5c\u4e5f\u9002\u7528\u4e8e\u533a\u95f4\u5411\u91cf\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u67e5\u8be2\u6628\u5929\u7684\u524d5\u5206\u949f\u7684 CPU \u7a7a\u95f2\u589e\u957f\u7387\uff1a</p> <p></p>"},{"location":"kubernetes_monitor/promql/#_6","title":"\u5173\u8054\u67e5\u8be2","text":"<p>Prometheus \u6ca1\u6709\u63d0\u4f9b\u7c7b\u4f3c\u4e0e SQL \u8bed\u53e5\u7684\u5173\u8054\u67e5\u8be2\u7684\u6982\u5ff5\uff0c\u4f46\u662f\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728 Prometheus \u4e0a\u4f7f\u7528 \u8fd0\u7b97\u7b26 \u6765\u7ec4\u5408\u65f6\u95f4\u5e8f\u5217\uff0c\u53ef\u4ee5\u5e94\u7528\u4e8e\u591a\u4e2a\u65f6\u95f4\u5e8f\u5217\u6216\u6807\u91cf\u503c\u7684\u5e38\u89c4\u8ba1\u7b97\u3001\u6bd4\u8f83\u548c\u903b\u8f91\u8fd0\u7b97\u3002</p> <p>\u6ce8\u610f</p> <p>\u5982\u679c\u5c06\u8fd0\u7b97\u7b26\u5e94\u7528\u4e8e\u4e24\u4e2a\u77ac\u65f6\u5411\u91cf\uff0c\u5219\u5b83\u5c06\u4ec5\u5e94\u7528\u4e8e\u5339\u914d\u7684\u65f6\u95f4\u5e8f\u5217\uff0c\u5f53\u4e14\u4ec5\u5f53\u65f6\u95f4\u5e8f\u5217\u5177\u6709\u5b8c\u5168\u76f8\u540c\u7684\u6807\u7b7e\u96c6\u7684\u65f6\u5019\uff0c\u624d\u8ba4\u4e3a\u662f\u5339\u914d\u7684\u3002\u5f53\u8868\u8fbe\u5f0f\u5de6\u4fa7\u7684\u6bcf\u4e2a\u5e8f\u5217\u548c\u53f3\u4fa7\u7684\u4e00\u4e2a\u5e8f\u5217\u5b8c\u5168\u5339\u914d\u7684\u65f6\u5019\uff0c\u5728\u5e8f\u5217\u4e0a\u4f7f\u7528\u8fd9\u4e9b\u8fd0\u7b97\u7b26\u624d\u53ef\u4ee5\u5b9e\u73b0\u4e00\u5bf9\u4e00\u5339\u914d\u3002</p> <p>\u6bd4\u5982\u5982\u4e0b\u7684\u4e24\u4e2a\u77ac\u65f6\u5411\u91cf\uff1a</p> <pre><code>node_cpu_seconds_total{instance=\"ydzs-master\", cpu=\"0\", mode=\"idle\"}\n</code></pre> <p>\u548c</p> <pre><code>node_cpu_seconds_total{instance=\"ydzs-node1\", cpu=\"0\", mode=\"idle\"}\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u5bf9\u8fd9\u4e24\u4e2a\u5e8f\u5217\u505a\u52a0\u6cd5\u8fd0\u7b97\u6765\u5c1d\u8bd5\u83b7\u53d6 master \u548c node1 \u8282\u70b9\u7684\u603b\u7684\u7a7a\u95f2 CPU \u65f6\u957f\uff0c\u5219\u4e0d\u4f1a\u8fd4\u56de\u4efb\u4f55\u5185\u5bb9\u4e86\uff1a</p> <p></p> <p>\u8fd9\u662f\u56e0\u4e3a\u8fd9\u4e24\u4e2a\u65f6\u95f4\u5e8f\u5217\u6ca1\u6709\u5b8c\u5168\u5339\u914d\u6807\u7b7e\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>on</code> \u5173\u952e\u5b57\u6307\u5b9a\u53ea\u5e0c\u671b\u5728 <code>mode</code> \u6807\u7b7e\u4e0a\u8fdb\u884c\u5339\u914d\uff0c\u5c31\u53ef\u4ee5\u8ba1\u7b97\u51fa\u7ed3\u679c\u6765\uff1a</p> <p></p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u65b0\u7684\u77ac\u65f6\u5411\u91cf\u5305\u542b\u5355\u4e2a\u5e8f\u5217\uff0c\u5176\u4e2d\u4ec5\u5305\u542b <code>on</code> \u5173\u952e\u5b57\u4e2d\u6307\u5b9a\u7684\u6807\u7b7e\u3002</p> <p>\u4e0d\u8fc7\u5728 Prometheus \u4e2d\u8fd8\u6709\u5f88\u591a \u805a\u5408\u64cd\u4f5c\uff0c\u6240\u4ee5\uff0c\u5982\u679c\u6211\u4eec\u771f\u7684\u60f3\u8981\u83b7\u53d6\u8282\u70b9\u7684 CPU \u603b\u65f6\u957f\uff0c\u6211\u4eec\u5b8c\u5168\u4e0d\u7528\u8fd9\u4e48\u64cd\u4f5c\uff0c\u4f7f\u7528 <code>sum</code> \u64cd\u4f5c\u8981\u7b80\u5355\u5f97\u591a\uff1a</p> <pre><code>sum(node_cpu_seconds_total{mode=\"idle\"}) by (instance)\n</code></pre> <p><code>on</code> \u5173\u952e\u5b57\u53ea\u80fd\u7528\u4e8e\u4e00\u5bf9\u4e00\u7684\u5339\u914d\u4e2d\uff0c\u5982\u679c\u662f\u591a\u5bf9\u4e00\u6216\u8005\u4e00\u5bf9\u591a\u7684\u5339\u914d\u60c5\u51b5\u4e0b\uff0c\u5c31\u4e0d\u884c\u4e86\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 kube-state-metrics \u8fd9\u4e2a\u5de5\u5177\u6765\u83b7\u53d6 Kubernetes \u96c6\u7fa4\u7684\u5404\u79cd\u72b6\u6001\u6307\u6807\uff0c\u5305\u62ec Pod \u7684\u57fa\u672c\u4fe1\u606f\uff0c\u6bd4\u5982\u6211\u4eec\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u67e5\u8be2\u8bed\u53e5\uff1a</p> <pre><code>container_cpu_user_seconds_total{namespace=\"kube-system\"} * on (pod) kube_pod_info\n</code></pre> <p>\u5c31\u4f1a\u51fa\u73b0 </p> <pre><code>Error executing query: multiple matches for labels: many-to-one matching must be explicit (group_left/group_right)\n</code></pre> <p>\u8fd9\u6837\u7684\u9519\u8bef\u63d0\u793a\uff0c\u8fd9\u662f\u56e0\u4e3a\u5de6\u4fa7\u7684\u5e8f\u5217\u6570\u636e\u5728\u540c\u4e00\u4e2a Pod \u4e0a\u9762\u6709\u53ef\u80fd\u4f1a\u6709\u591a\u6761\u65f6\u95f4\u5e8f\u5217\uff0c\u6240\u4ee5\u4e0d\u80fd\u7b80\u5355\u901a\u8fc7 <code>on (pod)</code> \u6765\u8fdb\u884c\u67e5\u8be2\u3002</p> <p>\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>group_left</code> \u6216<code>group_right</code> \u5173\u952e\u5b57\u3002\u8fd9\u4e24\u4e2a\u5173\u952e\u5b57\u5c06\u5339\u914d\u5206\u522b\u8f6c\u6362\u4e3a<code>\u591a\u5bf9\u4e00</code>\u6216<code>\u4e00\u5bf9\u591a</code>\u5339\u914d\u3002\u5de6\u4fa7\u548c\u53f3\u4fa7\u8868\u793a\u57fa\u6570\u8f83\u9ad8\u7684\u4e00\u4fa7\u3002\u56e0\u6b64\uff0c<code>group_left</code> \u610f\u5473\u7740\u5de6\u4fa7\u7684\u591a\u4e2a\u5e8f\u5217\u53ef\u4ee5\u4e0e\u53f3\u4fa7\u7684\u5355\u4e2a\u5e8f\u5217\u5339\u914d\u3002\u7ed3\u679c\u662f\uff0c\u8fd4\u56de\u7684\u77ac\u65f6\u5411\u91cf\u5305\u542b\u57fa\u6570\u8f83\u9ad8\u7684\u4e00\u4fa7\u7684\u6240\u6709\u6807\u7b7e\uff0c\u5373\u4f7f\u5b83\u4eec\u4e0e\u53f3\u4fa7\u7684\u4efb\u4f55\u6807\u7b7e\u90fd\u4e0d\u5339\u914d\u3002</p> <p>\u4f8b\u5982\u5982\u4e0b\u6240\u793a\u7684\u67e5\u8be2\u8bed\u53e5\u5c31\u53ef\u4ee5\u6b63\u5e38\u83b7\u53d6\u5230\u7ed3\u679c\uff0c\u800c\u4e14\u83b7\u53d6\u5230\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5305\u542b\u6240\u6709\u7684\u6807\u7b7e:</p> <pre><code>container_cpu_user_seconds_total{namespace=\"kube-system\"} * on (pod) group_left() kube_pod_info\n</code></pre>"},{"location":"kubernetes_monitor/promql/#_7","title":"\u77ac\u65f6\u5411\u91cf\u548c\u6807\u91cf\u7ed3\u5408","text":"<p>\u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u5c06\u77ac\u65f6\u5411\u91cf\u548c\u6807\u91cf\u503c\u76f8\u7ed3\u5408\uff0c\u8fd9\u4e2a\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u7b80\u5355\u7684\u6570\u5b66\u8ba1\u7b97\uff0c\u6bd4\u5982\uff1a</p> <pre><code>node_cpu_seconds_total{instance=\"ydzs-master\"} * 10\n</code></pre> <p>\u4f1a\u4e3a\u77ac\u65f6\u5411\u91cf\u4e2d\u6bcf\u4e2a\u5e8f\u5217\u7684\u6bcf\u4e2a\u503c\u90fd\u5269\u4ee510\u3002\u8fd9\u5bf9\u4e8e\u8ba1\u7b97\u6bd4\u7387\u548c\u767e\u5206\u6bd4\u5f97\u65f6\u5019\u975e\u5e38\u6709\u7528\u3002</p> <ul> <li>\u9664\u4e86 <code>*</code> \u4e4b\u5916\uff0c\u5176\u4ed6\u5e38\u7528\u7684\u7b97\u6570\u8fd0\u7b97\u7b26\u5f53\u7136\u4e5f\u652f\u6301\uff1a<code>+</code>\u3001<code>-</code>\u3001<code>*</code>\u3001<code>/</code>\u3001<code>%</code>\u3001<code>^</code>\u3002</li> <li>\u8fd8\u6709\u5176\u4ed6\u7684\u6bd4\u8f83\u8fd0\u7b97\u7b26\uff1a<code>==</code>\u3001<code>!=</code>\u3001<code>&gt;</code>\u3001<code>&lt;</code>\u3001<code>&gt;=</code>\u3001<code>&lt;=</code>\u3002</li> <li>\u903b\u8f91\u8fd0\u7b97\u7b26\uff1a<code>and</code>\u3001<code>or</code>\u3001<code>unless</code>\uff0c\u4e0d\u8fc7\u903b\u8f91\u8fd0\u7b97\u7b26\u53ea\u80fd\u7528\u4e8e\u77ac\u65f6\u5411\u91cf\u4e4b\u95f4\u3002</li> </ul> <p>\u9664\u4e86\u8fd9\u4e9b\u5173\u4e8e <code>PromQL</code> \u6700\u57fa\u672c\u7684\u77e5\u8bc6\u70b9\u4e4b\u5916\uff0c\u8fd8\u6709\u5f88\u591a\u76f8\u5173\u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u53ef\u4ee5\u53c2\u8003\u5b98\u7f51\u76f8\u5173\u4ecb\u7ecd\uff1ahttps://prometheus.io/docs/prometheus/latest/querying/basics/\u3002</p>"},{"location":"kubernetes_monitor/thanos/","title":"Prometheus Thanos","text":""},{"location":"kubernetes_monitor/thanos/#prometheus","title":"Prometheus \u9ad8\u53ef\u7528","text":"<p>\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u4e86 Prometheus \u7684\u4f7f\u7528\uff0c\u4e86\u89e3\u4e86\u57fa\u672c\u7684 PromQL \u8bed\u53e5\u4ee5\u53ca\u7ed3\u5408 Grafana \u6765\u8fdb\u884c\u76d1\u63a7\u56fe\u8868\u5c55\u793a\uff0c\u901a\u8fc7 AlertManager \u6765\u8fdb\u884c\u62a5\u8b66\uff0c\u8fd9\u4e9b\u5de5\u5177\u7ed3\u5408\u8d77\u6765\u5df2\u7ecf\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u642d\u5efa\u4e00\u5957\u6bd4\u8f83\u5b8c\u6574\u7684\u76d1\u63a7\u62a5\u8b66\u7cfb\u7edf\u4e86\uff0c\u4f46\u662f\u4e5f\u4ec5\u4ec5\u5c40\u9650\u4e8e\u6d4b\u8bd5\u73af\u5883\uff0c\u5bf9\u4e8e\u751f\u4ea7\u73af\u5883\u6765\u8bf4\u5219\u8fd8\u6709\u8bb8\u591a\u9700\u8981\u6539\u8fdb\u7684\u5730\u65b9\uff0c\u5176\u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u5c31\u662f Prometheus \u7684\u9ad8\u53ef\u7528\u3002</p> <p>\u5355\u53f0\u7684 Prometheus \u5b58\u5728\u5355\u70b9\u6545\u969c\u7684\u98ce\u9669\uff0c\u968f\u7740\u76d1\u63a7\u89c4\u6a21\u7684\u6269\u5927\uff0cPrometheus \u4ea7\u751f\u7684\u6570\u636e\u91cf\u4e5f\u4f1a\u975e\u5e38\u5927\uff0c\u6027\u80fd\u548c\u5b58\u50a8\u90fd\u4f1a\u9762\u4e34\u95ee\u9898\u3002\u6bcb\u5eb8\u7f6e\u7591\uff0c\u6211\u4eec\u9700\u8981\u4e00\u5957\u9ad8\u53ef\u7528\u7684 Prometheus \u96c6\u7fa4\u3002</p>"},{"location":"kubernetes_monitor/thanos/#_1","title":"\u53ef\u7528\u6027","text":"<p>\u6211\u4eec\u77e5\u9053 Prometheus \u662f\u91c7\u7528\u7684 Pull \u673a\u5236\u83b7\u53d6\u76d1\u63a7\u6570\u636e\uff0c\u5373\u4f7f\u4f7f\u7528 <code>Push Gateway</code> \u5bf9\u4e8e Prometheus \u4e5f\u662f Pull\uff0c\u4e3a\u4e86\u786e\u4fdd Prometheus \u670d\u52a1\u7684\u53ef\u7528\u6027\uff0c\u6211\u4eec\u53ea\u9700\u8981\u90e8\u7f72\u591a\u4e2a Prometheus \u5b9e\u4f8b\uff0c\u7136\u540e\u91c7\u96c6\u76f8\u540c\u7684 metrics \u6570\u636e\u5373\u53ef\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u8fd9\u4e2a\u65b9\u5f0f\u6765\u6ee1\u8db3\u670d\u52a1\u7684\u53ef\u7528\u6027\u5e94\u8be5\u662f\u5e73\u65f6\u6211\u4eec\u4f7f\u7528\u5f97\u6700\u591a\u7684\u4e00\u79cd\u65b9\u5f0f\uff0c\u5f53\u4e00\u4e2a\u5b9e\u4f8b\u6302\u6389\u540e\u4ece LB \u91cc\u9762\u81ea\u52a8\u5254\u9664\u6389\uff0c\u800c\u4e14\u8fd8\u6709\u8d1f\u8f7d\u5747\u8861\u7684\u4f5c\u7528\uff0c\u53ef\u4ee5\u964d\u4f4e\u4e00\u4e2a Prometheus \u7684\u538b\u529b\uff0c\u4f46\u8fd9\u79cd\u6a21\u5f0f\u7f3a\u70b9\u4e5f\u662f\u975e\u5e38\u660e\u663e\u7684\uff0c\u5c31\u662f\u4e0d\u6ee1\u8db3\u6570\u636e\u4e00\u81f4\u6027\u4ee5\u53ca\u6301\u4e45\u5316\u95ee\u9898\uff0c\u56e0\u4e3a Prometheus \u662f Pull \u7684\u65b9\u5f0f\uff0c\u5373\u4f7f\u591a\u4e2a\u5b9e\u4f8b\u6293\u53d6\u7684\u662f\u76f8\u540c\u7684\u76d1\u63a7\u6307\u6807\uff0c\u4e5f\u4e0d\u80fd\u4fdd\u8bc1\u6293\u53d6\u8fc7\u6765\u7684\u503c\u5c31\u662f\u4e00\u81f4\u7684\uff0c\u66f4\u4f55\u51b5\u5728\u5b9e\u9645\u7684\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u8fd8\u4f1a\u9047\u5230\u4e00\u4e9b\u7f51\u7edc\u5ef6\u8fdf\u95ee\u9898\uff0c\u6240\u4ee5\u4f1a\u9020\u6210\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\uff0c\u4e0d\u8fc7\u5bf9\u4e8e\u76d1\u63a7\u62a5\u8b66\u8fd9\u4e2a\u573a\u666f\u6765\u8bf4\uff0c\u4e00\u822c\u4e5f\u4e0d\u4f1a\u8981\u6c42\u6570\u636e\u5f3a\u4e00\u81f4\u6027\uff0c\u6240\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u4ece\u4e1a\u52a1\u4e0a\u6765\u8bf4\u662f\u53ef\u4ee5\u63a5\u53d7\u7684\uff0c\u56e0\u4e3a\u8fd9\u79cd\u6570\u636e\u4e0d\u4e00\u81f4\u6027\u5f71\u54cd\u57fa\u672c\u4e0a\u6ca1\u4ec0\u4e48\u5f71\u54cd\u3002\u8fd9\u79cd\u573a\u666f\u9002\u5408\u76d1\u63a7\u89c4\u6a21\u4e0d\u5927\uff0c\u53ea\u9700\u8981\u4fdd\u5b58\u77ed\u5468\u671f\u76d1\u63a7\u6570\u636e\u7684\u573a\u666f\u3002</p>"},{"location":"kubernetes_monitor/thanos/#_2","title":"\u6570\u636e\u6301\u4e45\u5316","text":"<p>\u4f7f\u7528\u4e0a\u9762\u7684\u57fa\u672c HA \u7684\u6a21\u5f0f\u57fa\u672c\u4e0a\u662f\u53ef\u4ee5\u6ee1\u8db3\u76d1\u63a7\u8fd9\u4e2a\u573a\u666f\uff0c\u4f46\u662f\u8fd8\u6709\u4e00\u4e2a\u6570\u636e\u6301\u4e45\u5316\u7684\u95ee\u9898\uff0c\u5982\u679c\u5176\u4e2d\u4e00\u4e2a\u5b9e\u4f8b\u6570\u636e\u4e22\u4e86\u5c31\u6ca1\u529e\u6cd5\u5462\u6062\u590d\u56de\u6765\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u4e3a Prometheus \u6dfb\u52a0\u8fdc\u7a0b\u5b58\u50a8\u6765\u4fdd\u8bc1\u6570\u636e\u6301\u4e45\u5316\u3002</p> <p></p> <p>\u5728\u7ed9 Prometheus \u914d\u7f6e\u4e0a\u8fdc\u7a0b\u5b58\u50a8\u8fc7\u540e\uff0c\u6211\u4eec\u5c31\u4e0d\u7528\u62c5\u5fc3\u6570\u636e\u4e22\u5931\u7684\u95ee\u9898\u4e86\uff0c\u5373\u4f7f\u5f53\u4e00\u4e2a Prometheus \u5b9e\u4f8b\u5b95\u673a\u6216\u8005\u6570\u636e\u4e22\u5931\u8fc7\u540e\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8fdc\u7a0b\u5b58\u50a8\u7684\u6570\u636e\u8fdb\u884c\u6062\u590d\u3002</p>"},{"location":"kubernetes_monitor/thanos/#leader","title":"\u901a\u8fc7\u9501\u83b7\u53d6 Leader","text":"<p>\u5176\u5b9e\u4e0a\u9762\u7684\u57fa\u672c HA \u52a0\u4e0a\u8fdc\u7a0b\u5b58\u50a8\u7684\u65b9\u5f0f\u57fa\u672c\u4e0a\u53ef\u4ee5\u6ee1\u8db3 Prometheus \u7684\u9ad8\u53ef\u7528\u4e86\uff0c\u8fd9\u79cd\u65b9\u5f0f\u7684\u591a\u4e2a Prometheus \u5b9e\u4f8b\u90fd\u4f1a\u53bb\u5b9a\u65f6\u62c9\u53d6\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u7136\u540e\u5c06\u70ed\u6570\u636e\u5b58\u50a8\u5728\u672c\u5730\uff0c\u7136\u540e\u51b7\u6570\u636e\u540c\u6b65\u5230\u8fdc\u7a0b\u5b58\u50a8\u4e2d\u53bb\uff0c\u5bf9\u4e8e\u5927\u578b\u96c6\u7fa4\u6765\u8bf4\u9891\u7e41\u7684\u53bb\u62c9\u53d6\u6307\u6807\u6570\u636e\u52bf\u5fc5\u4f1a\u5bf9\u7f51\u7edc\u9020\u6210\u66f4\u5927\u7684\u538b\u529b\u3002\u6240\u4ee5\u6211\u4eec\u4e5f\u901a\u8fc7\u670d\u52a1\u6ce8\u518c\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0 Prometheus \u7684\u9ad8\u53ef\u7528\u6027\uff0c\u96c6\u7fa4\u542f\u52a8\u7684\u65f6\u5019\u6bcf\u4e2a\u8282\u70b9\u90fd\u5c1d\u8bd5\u53bb\u83b7\u53d6\u9501\uff0c\u83b7\u53d6\u6210\u529f\u7684\u8282\u70b9\u6210\u4e3a Leader \u6267\u884c\u4efb\u52a1\uff0c\u82e5\u4e3b\u8282\u70b9\u5b95\u673a\uff0c\u4ece\u8282\u70b9\u83b7\u53d6\u9501\u6210\u4e3a Leader \u5e76\u63a5\u7ba1\u670d\u52a1\u3002</p> <p></p> <p>\u4e0d\u8fc7\u8fd9\u79cd\u65b9\u6848\u9700\u8981\u6211\u4eec\u901a\u8fc7\u53bb\u5199\u4ee3\u7801\u8fdb\u884c\u6539\u9020\uff0c\u5982\u679c\u5728 Kubernetes \u4e2d\u6211\u4eec\u5b8c\u5168\u53ef\u4ee5\u4f7f\u7528\u81ea\u5e26\u7684 Lease \u5bf9\u8c61\u6765\u83b7\u53d6\u5206\u5e03\u5f0f\u9501\ud83d\udd12\uff0c\u8fd9\u4e0d\u662f\u5f88\u56f0\u96be\uff0c\u53ea\u662f\u4ee5\u540e\u8981\u66f4\u65b0\u7248\u672c\u7a0d\u5fae\u9ebb\u70e6\u70b9\u3002</p> <p>\u4e0a\u9762\u7684\u51e0\u79cd\u65b9\u6848\u57fa\u672c\u4e0a\u90fd\u53ef\u4ee5\u6ee1\u8db3\u57fa\u672c\u7684 Prometheus \u9ad8\u53ef\u7528\uff0c\u4f46\u662f\u5bf9\u4e8e\u5927\u578b\u96c6\u7fa4\u6765\u8bf4\uff0c\u4e00\u4e2a Prometheus \u5b9e\u4f8b\u7684\u538b\u529b\u59cb\u7ec8\u975e\u5e38\u5927\u3002</p>"},{"location":"kubernetes_monitor/thanos/#_3","title":"\u8054\u90a6\u96c6\u7fa4","text":"<p>\u5f53\u5355\u4e2a Promthues \u5b9e\u4f8b \u65e0\u6cd5\u5904\u7406\u5927\u91cf\u7684\u91c7\u96c6\u4efb\u52a1\u65f6\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u57fa\u4e8e Prometheus \u8054\u90a6\u96c6\u7fa4\u7684\u65b9\u5f0f\u6765\u5c06\u76d1\u63a7\u4efb\u52a1\u5212\u5206\u5230\u4e0d\u540c\u7684 Prometheus \u5b9e\u4f8b\u4e2d\u53bb\u3002</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u5c06\u4e0d\u540c\u7c7b\u578b\u7684\u91c7\u96c6\u4efb\u52a1\u5212\u5206\u5230\u4e0d\u540c\u7684 Prometheus \u5b9e\u4f8b\u4e2d\u53bb\u6267\u884c\uff0c\u8fdb\u884c\u529f\u80fd\u5206\u7247\uff0c\u6bd4\u5982\u4e00\u4e2a Prometheus \u8d1f\u8d23\u91c7\u96c6\u8282\u70b9\u7684\u6307\u6807\u6570\u636e\uff0c\u53e6\u5916\u4e00\u4e2a Prometheus \u8d1f\u8d23\u91c7\u96c6\u5e94\u7528\u4e1a\u52a1\u76f8\u5173\u7684\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u6700\u540e\u5728\u4e0a\u5c42\u901a\u8fc7\u4e00\u4e2a Prometheus \u5bf9\u6570\u636e\u8fdb\u884c\u6c47\u603b\u3002</p> <p>\u5177\u4f53\u7684\u91c7\u96c6\u4efb\u52a1\u5982\u4f55\u53bb\u8fdb\u884c\u5206\u533a\u4e5f\u6ca1\u6709\u56fa\u5b9a\u7684\u6807\u51c6\uff0c\u9700\u8981\u7ed3\u5408\u5b9e\u9645\u7684\u4e1a\u52a1\u8fdb\u884c\u8003\u8651\uff0c\u9664\u4e86\u4e0a\u9762\u7684\u65b9\u5f0f\u4e4b\u5916\uff0c\u8fd8\u6709\u4e00\u79cd\u60c5\u51b5\u5c31\u662f\u5355\u4e2a\u7684\u91c7\u96c6\u6570\u636e\u91cf\u5c31\u975e\u5e38\u975e\u5e38\u5927\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u91c7\u96c6\u4e0a\u4e07\u4e2a\u8282\u70b9\u7684\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u8fd9\u79cd\u60c5\u51b5\u5373\u4f7f\u6211\u4eec\u5df2\u7ecf\u8fdb\u884c\u4e86\u5206\u533a\uff0c\u4f46\u662f\u5bf9\u4e8e\u5355\u4e2a Prometheus \u6765\u8bf4\u538b\u529b\u4e5f\u662f\u975e\u5e38\u5927\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u6309\u7167\u4efb\u52a1\u7684\u4e0d\u540c\u5b9e\u4f8b\u8fdb\u884c\u5212\u5206\uff0c\u6211\u4eec\u901a\u8fc7 Prometheus \u7684 <code>relabel</code> \u529f\u80fd\uff0c\u901a\u8fc7 hash \u53d6\u6a21\u7684\u65b9\u5f0f\u53ef\u4ee5\u786e\u4fdd\u5f53\u524d Prometheus \u53ea\u91c7\u96c6\u5f53\u524d\u4efb\u52a1\u7684\u4e00\u90e8\u5206\u5b9e\u4f8b\u7684\u76d1\u63a7\u6307\u6807\u3002</p> <pre><code># \u7701\u7565\u5176\u4ed6\u914d\u7f6e......\nrelabel_configs:\n- source_labels: [__address__]\n  modulus: 4   # \u5c06\u8282\u70b9\u5206\u7247\u6210 4 \u4e2a\u7ec4\n  target_label: __tmp_hash\n  action: hashmod\n- source_labels: [__tmp_hash]\n  regex: ^1$  # \u53ea\u6293\u7b2c2\u4e2a\u7ec4\u4e2d\u8282\u70b9\u7684\u6570\u636e(\u5e8f\u53f70\u4e3a\u7b2c1\u4e2a\u7ec4)\n  action: keep\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u57fa\u672c\u4e0a\u5c31\u5b8c\u6210\u4e86 Prometheus \u9ad8\u53ef\u7528\u7684\u6539\u9020\u3002\u5bf9\u4e8e\u5c0f\u89c4\u6a21\u96c6\u7fa4\u548c\u5927\u89c4\u6a21\u96c6\u7fa4\u53ef\u4ee5\u91c7\u7528\u4e0d\u540c\u7684\u65b9\u6848\uff0c\u4f46\u662f\u5176\u4e2d\u6709\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u90e8\u5206\u5c31\u662f\u8fdc\u7a0b\u5b58\u50a8\uff0c\u6211\u4eec\u9700\u8981\u4fdd\u8bc1\u6570\u636e\u7684\u6301\u4e45\u5316\u5c31\u5fc5\u987b\u4f7f\u7528\u8fdc\u7a0b\u5b58\u50a8\u3002\u6240\u4ee5\u4e0b\u9762\u6211\u4eec\u5c06\u91cd\u70b9\u4ecb\u7ecd\u4e0b\u8fdc\u7a0b\u5b58\u50a8\u7684\u65f6\u5019\uff0c\u8fd9\u91cc\u6211\u4eec\u4e3b\u8981\u8bb2\u89e3\u76ee\u524d\u6bd4\u8f83\u6d41\u884c\u7684\u65b9\u6848\uff1aThanos\uff0c\u5b83\u5b8c\u5168\u517c\u5bb9 Prometheus API\uff0c\u63d0\u4f9b\u7edf\u4e00\u67e5\u8be2\u805a\u5408\u5206\u5e03\u5f0f\u90e8\u7f72 Prometheus \u6570\u636e\u7684\u80fd\u529b\uff0c\u540c\u65f6\u4e5f\u652f\u6301\u6570\u636e\u957f\u671f\u5b58\u50a8\u5230\u5404\u79cd\u5bf9\u8c61\u5b58\u50a8\uff08\u6bd4\u5982 S3\u3001\u963f\u91cc\u4e91 OSS \u9093\uff09\u4ee5\u53ca\u964d\u4f4e\u91c7\u6837\u7387\u6765\u52a0\u901f\u5927\u65f6\u95f4\u8303\u56f4\u7684\u6570\u636e\u67e5\u8be2\u3002</p>"},{"location":"kubernetes_monitor/thanos/#thanos","title":"Thanos","text":"<p>Thanos \u662f\u4e00\u4e2a\u57fa\u4e8e Prometheus \u5b9e\u73b0\u7684\u76d1\u63a7\u65b9\u6848\uff0c\u5176\u4e3b\u8981\u8bbe\u8ba1\u76ee\u7684\u662f\u89e3\u51b3\u539f\u751f Prometheus \u4e0a\u7684\u75db\u70b9\uff0c\u5e76\u4e14\u505a\u8fdb\u4e00\u6b65\u7684\u63d0\u5347\uff0c\u4e3b\u8981\u7684\u7279\u6027\u6709\uff1a<code>\u5168\u5c40\u67e5\u8be2\uff0c\u9ad8\u53ef\u7528\uff0c\u52a8\u6001\u62d3\u5c55\uff0c\u957f\u671f\u5b58\u50a8</code>\u3002\u4e0b\u56fe\u662f Thanos \u5b98\u65b9\u7684\u67b6\u6784\u56fe\uff1a</p> <p></p> <p>Thanos \u4e3b\u8981\u7531\u5982\u4e0b\u51e0\u4e2a\u7279\u5b9a\u529f\u80fd\u7684\u7ec4\u4ef6\u7ec4\u6210\uff1a</p> <ul> <li>\u8fb9\u8f66\u7ec4\u4ef6\uff08Sidecar\uff09\uff1a\u8fde\u63a5 Prometheus\uff0c\u5e76\u628a Prometheus \u66b4\u9732\u7ed9\u67e5\u8be2\u7f51\u5173\uff08Querier/Query\uff09\uff0c\u4ee5\u4f9b\u5b9e\u65f6\u67e5\u8be2\uff0c\u5e76\u4e14\u53ef\u4ee5\u4e0a\u4f20 Prometheus \u6570\u636e\u7ed9\u4e91\u5b58\u50a8\uff0c\u4ee5\u4f9b\u957f\u671f\u4fdd\u5b58</li> <li>\u67e5\u8be2\u7f51\u5173\uff08Querier/Query\uff09\uff1a\u5b9e\u73b0\u4e86 Prometheus API\uff0c\u4e0e\u6c47\u96c6\u5e95\u5c42\u7ec4\u4ef6\uff08\u5982\u8fb9\u8f66\u7ec4\u4ef6 Sidecar\uff0c\u6216\u662f\u5b58\u50a8\u7f51\u5173 Store Gateway\uff09\u7684\u6570\u636e</li> <li>\u5b58\u50a8\u7f51\u5173\uff08Store Gateway\uff09\uff1a\u5c06\u4e91\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u5185\u5bb9\u66b4\u9732\u51fa\u6765</li> <li>\u538b\u7f29\u5668\uff08Compactor\uff09\uff1a\u5c06\u4e91\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u538b\u7f29\u548c\u4e0b\u91c7\u6837</li> <li>\u63a5\u6536\u5668\uff08Receiver\uff09\uff1a\u4ece Prometheus \u7684 remote-write WAL\uff08Prometheus \u8fdc\u7a0b\u9884\u5199\u5f0f\u65e5\u5fd7\uff09\u83b7\u53d6\u6570\u636e\uff0c\u66b4\u9732\u51fa\u53bb\u6216\u8005\u4e0a\u4f20\u5230\u4e91\u5b58\u50a8</li> <li>\u89c4\u5219\u7ec4\u4ef6\uff08Ruler\uff09\uff1a\u9488\u5bf9\u76d1\u63a7\u6570\u636e\u8fdb\u884c\u8bc4\u4f30\u548c\u62a5\u8b66</li> <li>Bucket\uff1a\u4e3b\u8981\u7528\u4e8e\u5c55\u793a\u5bf9\u8c61\u5b58\u50a8\u4e2d\u5386\u53f2\u6570\u636e\u7684\u5b58\u50a8\u60c5\u51b5\uff0c\u67e5\u770b\u6bcf\u4e2a\u6307\u6807\u6e90\u4e2d\u6570\u636e\u5757\u7684\u538b\u7f29\u7ea7\u522b\uff0c\u89e3\u6790\u5ea6\uff0c\u5b58\u50a8\u65f6\u6bb5\u548c\u65f6\u95f4\u957f\u5ea6\u7b49\u4fe1\u606f\u3002</li> </ul>"},{"location":"kubernetes_monitor/thanos/#_4","title":"\u5de5\u4f5c\u6d41\u7a0b","text":"<p>Thanos \u662f\u540c\u65f6\u652f\u6301 Prometheus \u8bfb\u548c\u5199\u7684\u8fdc\u7a0b\u5b58\u50a8\u65b9\u6848\uff0c\u9996\u5148\u6211\u4eec\u5148\u770b\u4e0b\u6307\u6807\u5199\u5165\u7684\u6574\u4e2a\u6d41\u7a0b\uff1a</p> <ul> <li>\u9996\u5148 Prometheus \u4ece\u6240\u91c7\u96c6\u670d\u52a1\u7684 metrics \u63a5\u53e3\u6293\u53d6\u6307\u6807\u6570\u636e\uff0c\u540c\u65f6\u6839\u636e\u81ea\u8eab\u6240\u914d\u7f6e\u7684 <code>recording rules</code> \u5b9a\u671f\u5bf9\u6293\u53d6\u5230\u7684\u6307\u6807\u6570\u636e\u8fdb\u884c\u8bc4\u4f30\uff0c\u5c06\u7ed3\u679c\u4ee5 TSDB \u683c\u5f0f\u5206\u5757\u5b58\u50a8\u5230\u672c\u5730\uff0c\u6bcf\u4e2a\u6570\u636e\u5757\u7684\u5b58\u50a8\u65f6\u957f\u4e3a2\u5c0f\u65f6\uff0c\u4e14\u9ed8\u8ba4\u7981\u7528\u4e86\u538b\u7f29\u529f\u80fd\u3002</li> <li>\u7136\u540e <code>sidecar</code> \u55c5\u63a2\u5230 Prometheus \u7684\u6570\u636e\u5b58\u50a8\u76ee\u5f55\u751f\u6210\u4e86\u65b0\u7684\u53ea\u8bfb\u6570\u636e\u5757\u65f6\uff0c\u4f1a\u5c06\u8be5\u6570\u636e\u5757\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u6876\u4e2d\u505a\u4e3a\u957f\u671f\u5386\u53f2\u6570\u636e\u4fdd\u5b58\uff0c\u5728\u4e0a\u4f20\u65f6\u4f1a\u5c06\u6570\u636e\u5757\u4e2d\u7684 <code>meta.json</code> \u8fdb\u884c\u4fee\u6539\u6dfb\u52a0 thanos \u76f8\u5173\u7684\u5b57\u6bb5\uff0c\u5982 <code>external_labels</code>\u3002</li> <li><code>rule</code> \u6839\u636e\u6240\u914d\u7f6e\u7684 <code>recording rules</code> \u5b9a\u671f\u5730\u5411 <code>query</code> \u53d1\u8d77\u67e5\u8be2\u83b7\u53d6\u8bc4\u4f30\u6240\u9700\u7684\u6307\u6807\u503c\uff0c\u5e76\u5c06\u7ed3\u679c\u4ee5 TSDB\u683c\u5f0f\u5206\u5757\u5b58\u50a8\u5230\u672c\u5730\u3002\u6bcf\u4e2a\u6570\u636e\u5757\u7684\u5b58\u50a8\u65f6\u957f\u4e3a2\u5c0f\u65f6\uff0c\u4e14\u9ed8\u8ba4\u7981\u7528\u4e86\u538b\u7f29\u529f\u80fd\uff0c\u6bcf\u4e2a\u6570\u636e\u5757\u7684 <code>meta.json</code> \u4e5f\u9644\u5e26\u4e86 thanos \u62d3\u5c55\u7684 <code>external_lables</code> \u5b57\u6bb5\u3002\u5f53\u672c\u5730\u751f\u6210\u4e86\u65b0\u7684\u53ea\u8bfb\u6570\u636e\u5757\u65f6\uff0c\u5176\u81ea\u8eab\u4f1a\u5c06\u8be5\u6570\u636e\u5757\u4e0a\u4f20\u5230\u8fdc\u7aef\u5bf9\u8c61\u5b58\u50a8\u6876\u4e2d\u505a\u4e3a\u957f\u671f\u5386\u53f2\u6570\u636e\u4fdd\u5b58\u3002</li> <li><code>compact</code> \u5b9a\u671f\u5c06\u5bf9\u8c61\u5b58\u50a8\u4e2d\u5730\u6570\u636e\u5757\u8fdb\u884c\u538b\u7f29\u548c\u964d\u51c6\u91c7\u6837\uff0c\u8fdb\u884c\u538b\u7f29\u65f6\u6570\u636e\u5757\u4e2d\u7684 truck \u4f1a\u8fdb\u884c\u5408\u5e76\uff0c\u5bf9\u5e94\u7684 <code>meta.json</code> \u4e2d\u7684 level \u4e5f\u4f1a\u4e00\u540c\u589e\u957f\uff0c\u6bcf\u6b21\u538b\u7f29\u7d2f\u52a01\uff0c\u521d\u59cb\u503c\u4e3a1\u3002\u5728\u8fdb\u884c\u964d\u51c6\u91c7\u6837\u65f6\u4f1a\u521b\u5efa\u65b0\u7684\u6570\u636e\u5757\uff0c\u6839\u636e\u91c7\u6837\u6b65\u957f\u4ece\u539f\u6709\u7684\u6570\u636e\u5757\u4e2d\u62bd\u53d6\u503c\u5b58\u50a8\u5230\u65b0\u7684\u6570\u636e\u5757\u4e2d\uff0c\u5728 <code>meta.json</code> \u4e2d\u8bb0\u5f55 <code>resolution</code> \u4e3a\u91c7\u6837\u6b65\u957f\u3002</li> </ul> <p>\u8bfb\u53d6\u6307\u6807\u7684\u6d41\u7a0b\u4e3a\uff1a</p> <ul> <li>\u9996\u5148\u5ba2\u6237\u7aef\u901a\u8fc7 <code>query API</code> \u5411 <code>query</code> \u53d1\u8d77\u67e5\u8be2\uff0c<code>query</code> \u5c06\u8bf7\u6c42\u8f6c\u6362\u6210 <code>StoreAPI</code> \u53d1\u9001\u5230\u5176\u4ed6\u7684 <code>query</code>\u3001<code>sidecar</code>\u3001<code>rule</code> \u548c <code>store</code> \u4e0a\u3002</li> <li><code>sidecar</code> \u63a5\u6536\u5230\u6765\u81ea\u4e8e <code>query</code> \u53d1\u8d77\u7684\u67e5\u8be2\u8bf7\u6c42\u540e\u5c06\u5176\u8f6c\u6362\u6210 <code>query API</code> \u8bf7\u6c42\uff0c\u53d1\u9001\u7ed9\u5176\u7ed1\u5b9a\u7684 Prometheus\uff0c\u7531Prometheus \u4ece\u672c\u5730\u8bfb\u53d6\u6570\u636e\u5e76\u54cd\u5e94\uff0c\u8fd4\u56de\u77ed\u671f\u7684\u672c\u5730\u91c7\u96c6\u548c\u8bc4\u4f30\u6570\u636e\u3002</li> <li><code>rule</code> \u63a5\u6536\u5230\u6765\u81ea\u4e8e <code>query</code> \u53d1\u8d77\u7684\u67e5\u8be2\u8bf7\u6c42\u540e\u76f4\u63a5\u4ece\u672c\u5730\u8bfb\u53d6\u6570\u636e\u5e76\u54cd\u5e94\uff0c\u8fd4\u56de\u77ed\u671f\u7684\u672c\u5730\u8bc4\u4f30\u6570\u636e\u3002</li> <li><code>store</code> \u63a5\u6536\u5230\u6765\u81ea\u4e8e <code>query</code> \u53d1\u8d77\u7684\u67e5\u8be2\u8bf7\u6c42\u540e\u9996\u5148\u4ece\u5bf9\u8c61\u5b58\u50a8\u6876\u4e2d\u904d\u5386\u6570\u636e\u5757\u7684 <code>meta.json</code>\uff0c\u6839\u636e\u5176\u4e2d\u8bb0\u5f55\u7684\u65f6\u95f4\u8303\u56f4\u548c\u6807\u7b7e\u5148\u8fdb\u884c\u4e00\u6b21\u8fc7\u6ee4\u3002\u63a5\u4e0b\u6765\u4ece\u5bf9\u8c61\u5b58\u50a8\u6876\u4e2d\u8bfb\u53d6\u6570\u636e\u5757\u7684 <code>index</code> \u548c <code>chunks</code> \u8fdb\u884c\u67e5\u8be2\uff0c\u90e8\u5206\u67e5\u8be2\u9891\u7387\u8f83\u9ad8\u7684<code>index</code> \u4f1a\u88ab\u7f13\u5b58\u4e0b\u6765\uff0c\u4e0b\u6b21\u67e5\u8be2\u4f7f\u7528\u5230\u65f6\u53ef\u4ee5\u76f4\u63a5\u8bfb\u53d6\u3002\u6700\u7ec8\u8fd4\u56de\u957f\u671f\u7684\u5386\u53f2\u91c7\u96c6\u548c\u8bc4\u4f30\u6307\u6807\u3002</li> </ul> <p>\u5bf9\u4e8e\u53d1\u9001\u62a5\u8b66\u7684\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li>Prometheus \u6839\u636e\u81ea\u8eab\u914d\u7f6e\u7684 <code>alerting</code> \u89c4\u5219\u5b9a\u671f\u5730\u5bf9\u81ea\u8eab\u91c7\u96c6\u7684\u6307\u6807\u8fdb\u884c\u8bc4\u4f30\uff0c\u5f53\u544a\u8b66\u6761\u4ef6\u6ee1\u8db3\u7684\u60c5\u51b5\u4e0b\u53d1\u8d77\u544a\u8b66\u5230 Alertmanager \u4e0a\u3002</li> <li><code>rule</code> \u6839\u636e\u81ea\u8eab\u914d\u7f6e\u7684 <code>alerting</code> \u89c4\u5219\u5b9a\u671f\u7684\u5411 <code>query</code> \u53d1\u8d77\u67e5\u8be2\u8bf7\u6c42\u83b7\u53d6\u8bc4\u4f30\u6240\u9700\u7684\u6307\u6807\uff0c\u5f53\u544a\u8b66\u6761\u4ef6\u6ee1\u8db3\u7684\u60c5\u51b5\u4e0b\u53d1\u8d77\u544a\u8b66\u5230 Alertmanager \u4e0a\u3002</li> <li>Alertmanager \u63a5\u6536\u5230\u6765\u81ea\u4e8e Prometheus \u548c <code>rule</code> \u7684\u544a\u8b66\u6d88\u606f\u540e\u8fdb\u884c\u5206\u7ec4\u5408\u5e76\u540e\u53d1\u51fa\u544a\u8b66\u901a\u77e5\u3002</li> </ul>"},{"location":"kubernetes_monitor/thanos/#_5","title":"\u7279\u6027","text":"<p>Thanos \u76f8\u6bd4\u8d77\u539f\u751f\u7684 Prometheus \u5177\u6709\u4ee5\u4e0b\u7684\u4e00\u4e9b\u4f18\u52bf\uff1a</p> <ul> <li>\u7edf\u4e00\u67e5\u8be2\u5165\u53e3\u2014\u2014\u4ee5 <code>Querier</code> \u4f5c\u4e3a\u7edf\u4e00\u7684\u67e5\u8be2\u5165\u53e3\uff0c\u5176\u81ea\u8eab\u5b9e\u73b0\u4e86 Prometheus \u7684\u67e5\u8be2\u63a5\u53e3\u548c <code>StoreAPI</code>\uff0c\u53ef\u4e3a\u5176\u4ed6\u7684 <code>Querier</code> \u63d0\u4f9b\u67e5\u8be2\u670d\u52a1\uff0c\u5728\u67e5\u8be2\u65f6\u4f1a\u4ece\u6bcf\u4e2a Prometheus \u5b9e\u4f8b\u7684 <code>Sidecar</code> \u548c <code>Store Gateway</code> \u83b7\u53d6\u5230\u6307\u6807\u6570\u636e\u3002</li> <li>\u67e5\u8be2\u53bb\u91cd\u2014\u2014\u6bcf\u4e2a\u6570\u636e\u5757\u90fd\u4f1a\u5e26\u6709\u7279\u5b9a\u7684\u96c6\u7fa4\u6807\u7b7e\uff0c <code>Querier</code> \u5728\u505a\u67e5\u8be2\u65f6\u4f1a\u53bb\u9664\u96c6\u7fa4\u6807\u7b7e\uff0c\u5c06\u6307\u6807\u540d\u79f0\u548c\u6807\u7b7e\u4e00\u81f4\u7684\u5e8f\u5217\u6839\u636e\u65f6\u95f4\u6392\u5e8f\u5408\u5e76\u3002\u867d\u7136\u6307\u6807\u6570\u636e\u6765\u81ea\u4e0d\u540c\u7684\u91c7\u96c6\u6e90\uff0c\u4f46\u662f\u53ea\u4f1a\u54cd\u5e94\u4e00\u4efd\u7ed3\u679c\u800c\u4e0d\u662f\u591a\u4efd\u91cd\u590d\u7684\u7ed3\u679c\u3002</li> <li>\u9ad8\u7a7a\u95f4\u5229\u7528\u7387\u2014\u2014\u6bcf\u4e2a Prometheus \u672c\u8eab\u4e0d\u5b58\u50a8\u957f\u65f6\u95f4\u7684\u6570\u636e\uff0c<code>Sidecar</code> \u4f1a\u5c06 Prometheus \u5df2\u7ecf\u6301\u4e45\u5316\u7684\u6570\u636e\u5757\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u4e2d\u3002<code>Compactor</code> \u4f1a\u5b9a\u65f6\u5c06\u8fdc\u7aef\u5bf9\u8c61\u5b58\u50a8\u4e2d\u7684\u957f\u671f\u6570\u636e\u8fdb\u884c\u538b\u7f29\uff0c\u5e76\u4e14\u6839\u636e\u91c7\u6837\u65f6\u957f\u505a\u6e05\u7406\uff0c\u8282\u7ea6\u5b58\u50a8\u7a7a\u95f4\u3002</li> <li>\u9ad8\u53ef\u7528\u2014\u2014<code>Querier</code> \u662f\u65e0\u72b6\u6001\u670d\u52a1\uff0c\u5929\u751f\u652f\u6301\u6c34\u5e73\u62d3\u5c55\u548c\u9ad8\u53ef\u7528\u3002<code>Store</code>\u3001<code>Rule</code> \u548c <code>Sidecar</code> \u662f\u6709\u72b6\u6001\u670d\u52a1\uff0c\u5728\u591a\u526f\u672c\u90e8\u7f72\u7684\u60c5\u51b5\u4e0b\u4e5f\u652f\u6301\u9ad8\u53ef\u7528\uff0c\u4e0d\u8fc7\u4f1a\u4ea7\u751f\u6570\u636e\u5197\u4f59\uff0c\u9700\u8981\u727a\u7272\u5b58\u50a8\u7a7a\u95f4\u3002</li> <li>\u5b58\u50a8\u957f\u671f\u6570\u636e\u2014\u2014Prometheus \u5b9e\u4f8b\u7684 <code>Sidecar</code> \u4f1a\u5c06\u672c\u5730\u6570\u636e\u4e0a\u4f20\u5230\u8fdc\u7aef\u5bf9\u8c61\u5b58\u50a8\u4e2d\u4f5c\u4e3a\u957f\u671f\u6570\u636e</li> <li>\u6a2a\u5411\u62d3\u5c55\u2014\u2014\u5f53 Prometheus \u7684\u6307\u6807\u91c7\u96c6\u538b\u529b\u8fc7\u5927\u65f6\uff0c\u53ef\u4ee5\u521b\u5efa\u65b0\u7684 Prometheus \u5b9e\u4f8b\uff0c\u5c06 <code>scrape job</code> \u62c6\u5206\u7ed9\u591a\u4e2a Prometheus\uff0c<code>Querier</code> \u4ece\u591a\u4e2a Prometheus \u67e5\u8be2\u6c47\u805a\u7ed3\u679c\uff0c\u964d\u4f4e\u5355\u4e2a Prometheus \u7684\u538b\u529b</li> <li>\u8de8\u96c6\u7fa4\u67e5\u8be2\u2014\u2014\u9700\u8981\u5408\u5e76\u591a\u4e2a\u96c6\u7fa4\u7684\u67e5\u8be2\u7ed3\u679c\u65f6\uff0c\u4ec5\u9700\u8981\u5728\u6bcf\u4e2a\u96c6\u7fa4\u7684 <code>Querier</code> \u4e4b\u4e0a\u518d\u6dfb\u52a0\u4e00\u5c42 <code>Querier</code> \u5373\u53ef\uff0c\u8fd9\u6837\u7684\u5c42\u5c42\u5d4c\u5957\uff0c\u53ef\u4ee5\u4f7f\u5f97\u96c6\u7fa4\u89c4\u6a21\u65e0\u9650\u5236\u62d3\u5c55\u3002</li> </ul>"},{"location":"kubernetes_monitor/thanos/#sidecar","title":"Sidecar \u7ec4\u4ef6","text":"<p>\u9996\u5148\u5c06\u524d\u9762\u7ae0\u8282\u4e2d\u7684 Prometheus \u76f8\u5173\u7684\u8d44\u6e90\u5bf9\u8c61\u5168\u90e8\u5220\u9664\uff0c\u7136\u540e\u6211\u4eec\u9700\u8981\u5728 Prometheus \u4e2d\u53bb\u81ea\u52a8\u53d1\u73b0\u96c6\u7fa4\u7684\u4e00\u4e9b\u8d44\u6e90\u5bf9\u8c61\uff0c\u6240\u4ee5\u4f9d\u7136\u9700\u8981\u5bf9\u5e94\u7684 RBAC \u6743\u9650\u58f0\u660e\uff1a(rbac.yaml)</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus\n  namespace: kube-mon\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: prometheus\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - nodes\n  - services\n  - endpoints\n  - pods\n  - nodes/proxy\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - \"extensions\"\n  resources:\n    - ingresses\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - \"\"\n  resources:\n  - configmaps\n  - nodes/metrics\n  verbs:\n  - get\n- nonResourceURLs:\n  - /metrics\n  verbs:\n  - get\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: prometheus\nsubjects:\n- kind: ServiceAccount\n  name: prometheus\n  namespace: kube-mon\n</code></pre> <p>\u7136\u540e\u9700\u8981\u90e8\u7f72 Prometheus \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u4e0b\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u662f\u521b\u5efa Prometheus \u914d\u7f6e\u6587\u4ef6\u7684\u6a21\u677f\uff0c\u8be5\u6a21\u677f\u5c06\u7531 Thanos sidecar \u7ec4\u4ef6\u8fdb\u884c\u8bfb\u53d6\uff0c\u6700\u7ec8\u4f1a\u901a\u8fc7\u8be5\u6a21\u677f\u751f\u6210\u5b9e\u9645\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5728\u540c\u4e00\u4e2a Pod \u4e2d\u7684 Prometheus \u5bb9\u5668\u5c06\u8bfb\u53d6\u6700\u7ec8\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0 <code>external_labels</code> \u6807\u7b7e\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4ee5\u4fbf\u8ba9 <code>Queirer</code> \u53ef\u4ee5\u57fa\u4e8e\u8fd9\u4e9b\u6807\u7b7e\u5bf9\u6570\u636e\u8fdb\u884c\u53bb\u91cd\u5904\u7406\uff1a\uff08configmap.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n  namespace: kube-mon\ndata:\n  prometheus.yaml.tmpl: |  # \u6ce8\u610f\u8fd9\u91cc\u7684\u540d\u79f0\u662f prometheus.yaml.tmpl \n    global:\n      scrape_interval: 15s\n      scrape_timeout: 15s\n      external_labels:\n        cluster: ydzs-test\n        replica: $(POD_NAME)  # \u6bcf\u4e2a Prometheus \u6709\u4e00\u4e2a\u552f\u4e00\u7684\u6807\u7b7e\n\n    rule_files:  # \u62a5\u8b66\u89c4\u5219\u6587\u4ef6\u914d\u7f6e\n    - /etc/prometheus/rules/*rules.yaml\n\n    alerting:\n      alert_relabel_configs:  # \u6211\u4eec\u5e0c\u671b\u544a\u8b66\u4ece\u4e0d\u540c\u7684\u526f\u672c\u4e2d\u4e5f\u662f\u53bb\u91cd\u7684\n      - regex: replica\n        action: labeldrop\n      alertmanagers:\n      - scheme: http\n        path_prefix: /\n        static_configs:\n        - targets: ['alertmanager:9093']\n\n    scrape_configs:\n    ......  # \u5176\u4ed6\u6293\u53d6\u4efb\u52a1\u914d\u7f6e\u548c\u524d\u9762\u7ae0\u8282\u4e2d\u7684\u914d\u7f6e\u4fdd\u6301\u4e00\u81f4\u5373\u53ef\n</code></pre> <p>\u4e0a\u9762\u914d\u7f6e\u4e86\u62a5\u8b66\u89c4\u5219\u6587\u4ef6\uff0c\u7531\u4e8e\u8fd9\u91cc\u914d\u7f6e\u6587\u4ef6\u592a\u5927\u4e86\uff0c\u6240\u4ee5\u4e3a\u4e86\u66f4\u52a0\u6e05\u6670\uff0c\u6211\u4eec\u5c06\u62a5\u8b66\u89c4\u5219\u6587\u4ef6\u62c6\u5206\u5230\u53e6\u5916\u7684 ConfigMap \u5bf9\u8c61\u4e2d\u6765\uff0c\u4e0b\u9762\u6211\u4eec\u914d\u7f6e\u4e86\u4e24\u4e2a\u62a5\u8b66\u89c4\u5219\uff1a\uff08rules-configmap.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-rules\n  namespace: kube-mon\ndata:\n  alert-rules.yaml: |-\n    groups:\n      - name: Deployment\n        rules:\n        - alert: Deployment at 0 Replicas\n          annotations:\n            summary: Deployment {{$labels.deployment}} in {{$labels.namespace}} is currently having no pods running\n          expr: |\n            sum(kube_deployment_status_replicas) by (deployment,namespace)  &lt; 1\n          for: 1m\n          labels:\n            team: node\n      - name: Pods\n        rules:\n        - alert: Container restarted\n          annotations:\n            summary: Container named {{$labels.container}} in {{$labels.pod}} in {{$labels.namespace}} was restarted\n          expr: |\n            sum(increase(kube_pod_container_status_restarts_total[1m])) by (pod,namespace,container) &gt; 0\n          for: 0m\n          labels:\n            team: node\n</code></pre> <p>Thanos \u901a\u8fc7 Sidecar \u548c\u73b0\u6709\u7684 Prometheus \u8fdb\u884c\u96c6\u6210\uff0c\u5c06 Prometheus \u7684\u6570\u636e\u5907\u4efd\u5230\u5bf9\u8c61\u5b58\u50a8\u4e2d\uff0c\u6240\u4ee5\u9996\u5148\u6211\u4eec\u9700\u8981\u5c06 Prometheus \u548c Sidecar \u90e8\u7f72\u5728\u540c\u4e00\u4e2a Pod \u4e2d\uff0c\u53e6\u5916 Prometheus \u4e2d\u4e00\u5b9a\u8981\u5f00\u542f\u4e0b\u9762\u4e24\u4e2a\u53c2\u6570\uff1a</p> <ul> <li> <p><code>--web.enable-admin-api</code></p> <p>\u5141\u8bb8 Thanos \u7684 Sidecar \u4ece Prometheus \u83b7\u53d6\u5143\u6570\u636e\u3002 *   <code>--web.enable-lifecycle</code></p> <p>\u5141\u8bb8 Thanos \u7684 Sidecar \u91cd\u65b0\u52a0\u8f7d Promehtues \u7684\u914d\u7f6e\u548c\u89c4\u5219\u6587\u4ef6\u3002</p> </li> </ul> <p>\u7531\u4e8e Prometheus \u9ed8\u8ba4\u6bcf2h\u751f\u6210\u4e00\u4e2a TSDB \u6570\u636e\u5757\uff0c\u6240\u4ee5\u4ecd\u7136\u5e76\u4e0d\u610f\u5473\u7740 Prometheus \u53ef\u4ee5\u662f\u5b8c\u5168\u65e0\u72b6\u6001\u7684\uff0c\u56e0\u4e3a\u5982\u679c\u5b83\u5d29\u6e83\u5e76\u91cd\u65b0\u542f\u52a8\uff0c\u6211\u4eec\u5c06\u4e22\u5931\u301c2\u4e2a\u5c0f\u65f6\u7684\u6307\u6807\uff0c\u56e0\u6b64\u5f3a\u70c8\u5efa\u8bae\u4f9d\u7136\u5bf9 Prometheus \u505a\u6570\u636e\u6301\u4e45\u5316\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e86 <code>StatefulSet</code> \u6765\u7ba1\u7406\u8fd9\u4e2a\u5e94\u7528\uff0c\u6dfb\u52a0 <code>volumeClaimTemplates</code> \u6765\u58f0\u660e\u4e86\u6570\u636e\u6301\u4e45\u5316\u7684 PVC \u6a21\u677f\uff1a(sidecar.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: prometheus\n  namespace: kube-mon\n  labels:\n    app: prometheus\nspec:\n  serviceName: \"prometheus\"\n  replicas: 2\n  selector:\n    matchLabels:\n      app: prometheus\n      thanos-store-api: \"true\"\n  template:\n    metadata:\n      labels: \n        app: prometheus\n        thanos-store-api: \"true\"\n    spec:\n      serviceAccountName: prometheus\n      volumes:\n      - name: prometheus-config\n        configMap:\n          name: prometheus-config\n      - name: prometheus-rules\n        configMap:\n          name: prometheus-rules\n      - name: prometheus-config-shared\n        emptyDir: {}\n      containers:\n      - name: prometheus\n        image: prom/prometheus:v0\n        imagePullPolicy: IfNotPresent\n        args:\n        - \"--config.file=/etc/prometheus-shared/prometheus.yaml\"\n        - \"--storage.tsdb.path=/prometheus\"\n        - \"--storage.tsdb.retention.time=6h\"\n        - \"--storage.tsdb.no-lockfile\"\n        - \"--storage.tsdb.min-block-duration=2h\"  # Thanos\u5904\u7406\u6570\u636e\u538b\u7f29\n        - \"--storage.tsdb.max-block-duration=2h\"\n        - \"--web.enable-admin-api\"  # \u901a\u8fc7\u4e00\u4e9b\u547d\u4ee4\u53bb\u7ba1\u7406\u6570\u636e\n        - \"--web.enable-lifecycle\"  # \u652f\u6301\u70ed\u66f4\u65b0  localhost:9090/-/reload \u52a0\u8f7d\n        ports:\n        - name: http\n          containerPort: 9090\n        resources:\n          requests:\n            memory: \"2Gi\"\n            cpu: \"1\"\n          limits:\n            memory: \"2Gi\"\n            cpu: \"1\"\n        volumeMounts:\n        - name: prometheus-config-shared\n          mountPath: /etc/prometheus-shared/\n        - name: prometheus-rules\n          mountPath: /etc/prometheus/rules\n        - name: data\n          mountPath: \"/prometheus\"\n      - name: thanos\n        image: thanosio/thanos:v0\n        imagePullPolicy: IfNotPresent\n        args:\n        - sidecar\n        - --log.level=debug\n        - --tsdb.path=/prometheus\n        - --prometheus.url=http://localhost:9090\n        - --reloader.config-file=/etc/prometheus/prometheus.yaml.tmpl\n        - --reloader.config-envsubst-file=/etc/prometheus-shared/prometheus.yaml\n        - --reloader.rule-dir=/etc/prometheus/rules/\n        ports:\n        - name: http-sidecar\n          containerPort: 10902\n        - name: grpc\n          containerPort: 10901\n        env:\n        - name: POD_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        resources:\n          requests:\n            memory: \"2Gi\"\n            cpu: \"1\"\n          limits:\n            memory: \"2Gi\"\n            cpu: \"1\"\n        volumeMounts:\n        - name: prometheus-config-shared\n          mountPath: /etc/prometheus-shared/\n        - name: prometheus-config\n          mountPath: /etc/prometheus\n        - name: prometheus-rules\n          mountPath: /etc/prometheus/rules\n        - name: data\n          mountPath: \"/prometheus\"\n  volumeClaimTemplates:  # \u7531\u4e8eprometheus\u6bcf2h\u751f\u6210\u4e00\u4e2aTSDB\u6570\u636e\u5757\uff0c\u6240\u4ee5\u8fd8\u662f\u9700\u8981\u4fdd\u5b58\u672c\u5730\u7684\u6570\u636e\n  - metadata:\n      name: data\n      labels:\n        app: prometheus\n    spec:\n      storageClassName: rook-ceph-block\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: 2Gi\n</code></pre> <p>\u7531\u4e8e Prometheus \u548c Thanos \u7684 Sidecar \u5728\u540c\u4e00\u4e2a Pod \u4e2d\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u5b8c\u5168\u53ef\u4ee5\u7528 <code>localhost</code> \u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230\u4e86\uff0c\u7136\u540e\u5c06\u6570\u636e\u76ee\u5f55\u505a\u4e86\u58f0\u660e\u6302\u8f7d\uff0c\u6240\u4ee5\u540c\u6837\u53ef\u4ee5\u5728\u4e24\u4e2a\u5bb9\u5668\u4e2d\u5171\u4eab\u6570\u636e\u76ee\u5f55\u4e86\uff0c\u4e00\u5b9a\u8981\u6ce8\u610f\u51e0\u4e2a\u914d\u7f6e\u6587\u4ef6\u7684\u6302\u8f7d\u65b9\u5f0f\u3002\u6b64\u5916\u5728\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u901a\u8fc7 <code>POD_NAME</code> \u8fd9\u4e2a\u73af\u5883\u53d8\u91cf\u4f5c\u4e3a <code>external</code> \u6807\u7b7e\u9644\u52a0\u5230\u4e86 Prometheus \u5b9e\u4f8b\u4e0a\uff0c\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>Downward API</code> \u53bb\u8bbe\u7f6e\u8be5\u73af\u5883\u53d8\u91cf\u3002</p> <p>\u7531\u4e8e\u73b0\u5728\u4f7f\u7528\u7684\u662f <code>StatefulSet</code> \u63a7\u5236\u5668\uff0c\u6240\u4ee5\u9700\u8981\u521b\u5efa\u4e00\u4e2a Headless Service\uff0c\u800c\u4e14\u540e\u9762\u7684 Thanos Query \u8fd8\u5c06\u4f7f\u7528\u8be5\u65e0\u5934\u670d\u52a1\u6765\u67e5\u8be2\u6240\u6709 Prometheus \u5b9e\u4f8b\u4e2d\u7684\u6570\u636e\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u4e3a\u6bcf\u4e00\u4e2a Prometheus \u5b9e\u4f8b\u53bb\u521b\u5efa\u4e00\u4e2a Service \u5bf9\u8c61\u4fbf\u4e8e\u8c03\u8bd5\uff0c\u5f53\u7136\u8fd9\u4e2a\u4e0d\u662f\u5fc5\u987b\u7684\uff1a\uff08headless.yaml\uff09</p> <pre><code># \u8be5\u670d\u52a1\u4e3a\u67e5 querier \u521b\u5efa srv \u8bb0\u5f55\uff0c\u4ee5\u4fbf\u67e5\u627e store-api \u7684\u4fe1\u606f\napiVersion: v1\nkind: Service\nmetadata:\n  name: thanos-store-gateway\n  namespace: kube-mon\nspec:\n  type: ClusterIP\n  clusterIP: None\n  ports:\n  - name: grpc\n    port: 10901\n    targetPort: grpc\n  selector:\n    thanos-store-api: \"true\"\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684\u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u6765\u521b\u5efa\u5e26\u6709 Thanos Sidecar \u5bb9\u5668\u7684\u9ad8\u53ef\u7528 Prometheus \u5e94\u7528\u4e86\uff1a</p> <pre><code>$ kubectl apply -f rbac.yaml\n$ kubectl apply -f configmap.yaml\n$ kubectl apply -f rules-configmap.yaml\n$ kubectl apply -f headless.yaml\n$ kubectl apply -f sidecar.yaml\n$ kubectl get pods -n kube-mon -l app=prometheus\nNAME           READY   STATUS    RESTARTS   AGE\nprometheus-0   2/2     Running   0          86s\nprometheus-1   2/2     Running   0          74s\n</code></pre>"},{"location":"kubernetes_monitor/thanos/#querier","title":"Querier \u7ec4\u4ef6","text":"<p>\u73b0\u5728\u6211\u4eec\u5c31\u521b\u5efa\u6210\u529f\u4e86\u4e24\u4e2a Prometheus \u5b9e\u4f8b\uff0c\u4f46\u662f\u6211\u4eec\u771f\u6b63\u53bb\u4f7f\u7528\u7684\u65f6\u5019\u5e76\u4e0d\u662f\u50cf\u4e0a\u9762\u63d0\u5230\u7684\u5728\u524d\u9762\u52a0\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\u53bb\u67e5\u8be2\u76d1\u63a7\u6570\u636e\uff0c\u800c\u662f\u4f7f\u7528 Thanos \u7684 <code>Querier</code> \u7ec4\u4ef6\u6765\u63d0\u4f9b\u4e00\u4e2a\u5168\u5c40\u7684\u7edf\u4e00\u67e5\u8be2\u5165\u53e3\u3002\u5bf9\u4e8e <code>Quierier</code> \u6700\u91cd\u8981\u7684\u5c31\u662f\u8981\u914d\u7f6e\u4e0a Thanos \u7684 Sidecar \u5730\u5740\uff0c\u6211\u4eec\u8fd9\u91cc\u5b8c\u5168\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Headless Service \u53bb\u81ea\u52a8\u53d1\u73b0\uff1a(querier.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: thanos-querier\n  namespace: kube-mon\n  labels:\n    app: thanos-querier\nspec:\n  selector:\n    matchLabels:\n      app: thanos-querier\n  template:\n    metadata:\n      labels:\n        app: thanos-querier\n    spec:\n      containers:\n      - name: thanos\n        image: thanosio/thanos:v0\n        args:\n        - query\n        - --log.level=debug\n        - --query.replica-label=replica\n        # Discover local store APIs using DNS SRV.\n        - --store=dnssrv+thanos-store-gateway:10901\n        ports:\n        - name: http\n          containerPort: 10902\n        - name: grpc\n          containerPort: 10901\n        resources:\n          requests:\n            memory: \"2Gi\"\n            cpu: \"1\"\n          limits:\n            memory: \"2Gi\"\n            cpu: \"1\"\n        livenessProbe:\n          httpGet:\n            path: /-/healthy\n            port: http\n          initialDelaySeconds: 10\n        readinessProbe:\n          httpGet:\n            path: /-/healthy\n            port: http\n          initialDelaySeconds: 15\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: thanos-querier\n  namespace: kube-mon\n  labels:\n    app: thanos-querier\nspec:\n  ports:\n  - port: 9090\n    protocol: TCP\n    targetPort: http\n    name: http\n  selector:\n    app: thanos-querier\n  type: NodePort\n</code></pre> <p>\u5bb9\u5668\u4e2d\u7684\u53c2\u6570 </p> <pre><code>--store=dnssrv+thanos-store-gateway:10901\n</code></pre> <p>\u53ef\u4ee5\u5e2e\u52a9\u81ea\u52a8\u53d1\u73b0\u53ef\u4ee5\u67e5\u8be2\u6307\u6807\u6570\u636e\u7684\u6240\u6709\u7ec4\u4ef6\uff1b\u7136\u540e\u521b\u5efa\u4e00\u4e2a <code>thanos-querier</code> \u7684 Serivce \u5bf9\u8c61\u53ef\u4ee5\u6765\u63d0\u4f9b\u4e00\u4e2a\u8fd0\u884c <code>PromQL</code> \u7684 web \u9875\u9762\uff0c\u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2a\u662f\u5426\u5bf9\u4e0d\u540c\u96c6\u7fa4\u6570\u636e\u8fdb\u884c\u53bb\u91cd\u7684\u5165\u53e3\u3002\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f querier.yaml\n$ kubectl get pods -n kube-mon -l app=thanos-querier\nNAME                             READY   STATUS    RESTARTS   AGE\nthanos-querier-cf566866b-r4jcj   1/1     Running   0          3m26s\n$ kubectl get svc -n kube-mon -l app=thanos-querier\nNAME             TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE\nthanos-querier   NodePort   1111   &lt;none&gt;        9090:31854/TCP   3m30s\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>http://&lt;\u4efb\u610f\u8282\u70b9IP&gt;:31854\n</code></pre> <p>\u53bb\u8bbf\u95ee <code>Querier</code> \u4e86\uff0c\u5728 <code>Stores</code> \u9875\u9762\u4e0b\u9762\u5c31\u4f1a\u663e\u793a\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u83b7\u53d6\u5230\u7684 Sidecar \u4fe1\u606f\uff1a</p> <p></p> <p>\u5728 <code>Graph</code> \u9875\u9762\u4e0b\u540c\u6837\u53ef\u4ee5\u53bb\u4f7f\u7528 <code>PromQL</code> \u8bed\u53e5\u6765\u67e5\u8be2\u76d1\u63a7\u4fe1\u606f\uff0c\u8fd9\u4e2a\u9875\u9762\u548c Prometheus \u539f\u751f\u7684\u9875\u9762\u51e0\u4e4e\u662f\u4e00\u81f4\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u67e5\u8be2 master \u8282\u70b9\u7684\u8282\u70b9\u4fe1\u606f\uff1a</p> <p></p> <p>\u8fd9\u91cc\u6211\u6ca1\u6709\u52fe\u4e0a <code>deduplication</code>\uff0c\u6240\u4ee5 Thanos \u4e0d\u4f1a\u5e2e\u6211\u5408\u5e76\u6570\u636e\uff0c\u6240\u4ee5\u80fd\u591f\u770b\u5230 <code>prometheus-0</code> \u548c <code>prometheus-1</code> \u4e24\u6761\u6570\u636e\uff0c\u56e0\u4e3a\u6211\u4eec\u6709\u4e24\u4e2a\u526f\u672c\u53bb\u6293\u53d6\u76d1\u63a7\u6570\u636e\u3002</p> <p>\u5982\u679c\u5c06 <code>deduplication</code> \u9009\u4e2d\uff0c\u7ed3\u679c\u4f1a\u6839\u636e <code>replica</code> \u8fd9\u4e2a\u6807\u7b7e\u8fdb\u884c\u5408\u5e76\uff0c\u5982\u679c\u4e24\u4e2a\u526f\u672c\u90fd\u6709\u5bf9\u5e94\u7684\u6570\u636e\uff0c<code>Querier</code> \u4f1a\u53d6 timestamp \u66f4\u5c0f\u7684\u7ed3\u679c\uff1a</p> <p></p> <p>\u5f53\u7136\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5728\u524d\u9762\u7ae0\u8282\u4e2d Grafana \u91cc\u9762\u914d\u7f6e\u7684 Prometheus \u7684\u6570\u636e\u6e90\u4e5f\u5c31\u5931\u6548\u4e86\uff0c\u56e0\u4e3a\u73b0\u5728\u76d1\u63a7\u6570\u636e\u7684\u6765\u6e90\u662f <code>Thanos Querier</code>\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u91cd\u65b0\u914d\u7f6e Prometheus \u7684\u6570\u636e\u6e90\u5730\u5740\u4e3a </p> <pre><code>http://thanos-querier:9090\n</code></pre> <p>\uff1a</p> <p></p> <p>\u4e4b\u524d\u7684\u76d1\u63a7\u56fe\u8868\u4e5f\u53ef\u4ee5\u6b63\u5e38\u663e\u793a\u4e86\uff1a</p> <p></p>"},{"location":"kubernetes_monitor/thanos/#ruler","title":"Ruler \u7ec4\u4ef6","text":"<p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u6d4b\u8bd5\u4e0b Prometheus \u91cc\u9762\u914d\u7f6e\u7684\u76d1\u63a7\u62a5\u8b66\u89c4\u5219\u662f\u5426\u751f\u6548\uff0c\u6bd4\u5982\u5bf9\u4e8e </p> <pre><code>Deployment at 0 Replicas\n</code></pre> <p>\u8fd9\u4e2a\u62a5\u8b66\u89c4\u5219\uff0c\u5f53\u96c6\u7fa4\u4e2d\u6709 Deployment \u7684\u526f\u672c\u6570\u53d8\u62100\u8fc7\u540e\u5c31\u4f1a\u89e6\u53d1\u62a5\u8b66\uff1a</p> <pre><code>$ kubectl get deploy\nNAME                     READY   UP-TO-DATE   AVAILABLE   AGE\nvault-demo               1/1     1            1           41d\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u624b\u52a8\u5c06\u67d0\u4e2a Deployment \u7684\u526f\u672c\u6570\u7f29\u51cf\u4e3a0\uff1a</p> <pre><code>$ kubectl scale --replicas=0 deployment/vault-demo\ndeployment.apps/vault-demo scaled\n$ kubectl get deploy                              \nNAME                     READY   UP-TO-DATE   AVAILABLE   AGE\nvault-demo               0/0     0            0           41d\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019 Alertmanager \u540c\u6837\u4e5f\u4f1a\u6839\u636e\u5916\u90e8\u7684 replica \u6807\u7b7e\u5bf9\u544a\u8b66\u8fdb\u884c\u53bb\u91cd\uff0c\u4e0a\u9762\u7684\u62a5\u8b66\u89c4\u5219\u4e2d\u6211\u4eec\u6dfb\u52a0\u4e86 <code>team=node</code> \u8fd9\u6837\u7684\u6807\u7b7e\uff0c\u6240\u4ee5\u4f1a\u901a\u8fc7\u524d\u9762\u7ae0\u8282\u4e2d\u7684 webhook \u63a5\u6536\u5668\u53d1\u9001\u7ed9\u9489\u9489\u8fdb\u884c\u544a\u8b66\uff1a</p> <p></p> <p>\u5f53\u7136\u9664\u4e86\u76f4\u63a5\u4f7f\u7528 Prometheus \u505a\u62a5\u8b66\u548c\u8bb0\u5f55\u89c4\u5219\u4e4b\u5916\uff0c\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 Thanos \u7684 Ruler \u7ec4\u4ef6\uff0c\u8be5\u7ec4\u4ef6\u672c\u8eab\u4e0d\u4f1a\u6293\u53d6 metrics \u63a5\u53e3\u6570\u636e\uff0c\u800c\u662f\u901a\u8fc7 <code>query API</code> \u4ece query \u7ec4\u4ef6\u5b9a\u671f\u5730\u83b7\u53d6\u6307\u6807\u6570\u636e\uff0c\u5982\u679c\u914d\u7f6e\u4e86\u591a\u4e2a query \u5730\u5740\uff0c\u5219\u4f1a\u91c7\u7528\u8f6e\u8be2\u65b9\u5f0f\u83b7\u53d6\u3002</p> <p>Ruler \u7ec4\u4ef6\u83b7\u53d6\u8bc4\u4f30\u6570\u636e\u7684\u8def\u5f84\u4e3a </p> <pre><code>rule --&gt; query --&gt; sidecar --&gt; prometheus\n</code></pre> <p>\u9700\u8981\u7ecf\u8fc7\u4e00\u6574\u4e2a\u67e5\u8be2\u94fe\u6761\uff0c\u8fd9\u4e5f\u63d0\u5347\u4e86\u53d1\u751f\u6545\u969c\u7684\u98ce\u9669\uff0c\u4e14\u8bc4\u4f30\u539f\u672c\u5c31\u53ef\u4ee5\u5728 Prometheus \u4e2d\u8fdb\u884c\uff0c\u6240\u4ee5\u975e\u5fc5\u8981\u7684\u60c5\u51b5\u4e0b\u8fd8\u662f\u66f4\u52a0\u63a8\u8350\u4f7f\u7528 Prometheus \u6765\u76f4\u63a5\u505a alerting \u548c recording \u8bc4\u4f30\uff0c\u5bf9\u4e8e Ruler \u7ec4\u4ef6\u7684\u5177\u4f53\u4f7f\u7528\u65b9\u5f0f\u611f\u5174\u8da3\u7684\u4e5f\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b\u5b98\u65b9\u6587\u6863 https://thanos.io/components/rule.md/ \u4e86\u89e3\u66f4\u591a\u7ec6\u8282\u3002</p>"},{"location":"kubernetes_monitor/thanos/#store","title":"Store \u7ec4\u4ef6","text":"<p>\u4e0a\u9762\u6211\u4eec\u5b89\u88c5\u4e86 Thanos \u7684 Sidecar \u548c Querier \u7ec4\u4ef6\uff0c\u5df2\u7ecf\u53ef\u4ee5\u505a\u5230 Prometheus \u7684\u9ad8\u53ef\u7528\uff0c\u901a\u8fc7 Querier \u63d0\u4f9b\u4e00\u4e2a\u7edf\u4e00\u7684\u5165\u53e3\u6765\u67e5\u8be2\u76d1\u63a7\u6570\u636e\uff0c\u800c\u4e14\u8fd8\u53ef\u4ee5\u5bf9\u76d1\u63a7\u6570\u636e\u81ea\u52a8\u53bb\u91cd\uff0c\u4f46\u662f\u8fd8\u6709\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u5730\u65b9\u662f\u8fd8\u6ca1\u6709\u914d\u7f6e\u5bf9\u8c61\u5b58\u50a8\uff0c\u5982\u679c\u60f3\u8981\u67e5\u770b\u5386\u53f2\u76d1\u63a7\u6570\u636e\u5c31\u4e0d\u884c\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u53bb\u914d\u7f6e Thanos Store \u7ec4\u4ef6\uff0c\u5c06\u5386\u53f2\u76d1\u63a7\u6307\u6807\u5b58\u50a8\u5728\u5bf9\u8c61\u5b58\u50a8\u4e2d\u53bb\u3002</p> <p>\u76ee\u524d Thanos \u652f\u6301\u7684\u5bf9\u8c61\u5b58\u50a8\u6709\uff1a</p> <p></p> <p>\u8981\u5728\u751f\u4ea7\u73af\u5883\u4f7f\u7528\u6700\u597d\u4f7f\u7528 <code>Stable</code> \u72b6\u6001\u7684\uff0c\u6bd4\u5982 S3 \u6216\u8005\u517c\u5bb9 S3 \u7684\u670d\u52a1\uff0c\u6bd4\u5982 Ceph\u3001Minio \u7b49\u7b49\u3002</p> <p>\u5bf9\u4e8e\u56fd\u5185\u7528\u6237\u5f53\u7136\u6700\u65b9\u4fbf\u7684\u8fd8\u662f\u76f4\u63a5\u4f7f\u7528\u963f\u91cc\u4e91 OSS \u6216\u8005\u817e\u8baf\u4e91 COS \u8fd9\u6837\u7684\u670d\u52a1\uff0c\u5f88\u591a\u65f6\u5019\u53ef\u80fd\u6211\u4eec\u7684\u670d\u52a1\u5e76\u4e0d\u662f\u8dd1\u5728\u516c\u6709\u4e91\u4e0a\u9762\u7684\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u7528 Minio \u6765\u90e8\u7f72\u4e00\u4e2a\u517c\u5bb9 S3 \u534f\u8bae\u7684\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\u3002</p>"},{"location":"kubernetes_monitor/thanos/#minio","title":"\u5b89\u88c5 Minio","text":"<p>MinIO \u662f\u4e00\u4e2a\u57fa\u4e8e Apache License v2.0 \u5f00\u6e90\u534f\u8bae\u7684\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\u3002\u5b83\u517c\u5bb9\u4e9a\u9a6c\u900a S3 \u4e91\u5b58\u50a8\u670d\u52a1\u63a5\u53e3\uff0c\u975e\u5e38\u9002\u5408\u4e8e\u5b58\u50a8\u5927\u5bb9\u91cf\u975e\u7ed3\u6784\u5316\u7684\u6570\u636e\uff0c\u4f8b\u5982\u56fe\u7247\u3001\u89c6\u9891\u3001\u65e5\u5fd7\u6587\u4ef6\u3001\u5907\u4efd\u6570\u636e\u548c\u5bb9\u5668/\u865a\u62df\u673a\u955c\u50cf\u7b49\uff0c\u800c\u4e00\u4e2a\u5bf9\u8c61\u6587\u4ef6\u53ef\u4ee5\u662f\u4efb\u610f\u5927\u5c0f\uff0c\u4ece\u51e0 kb \u5230\u6700\u5927 5T \u4e0d\u7b49\u3002</p> <p>\u8981\u5b89\u88c5 Minio \u975e\u5e38\u5bb9\u6613\u7684\uff0c\u540c\u6837\u6211\u4eec\u8fd9\u91cc\u5c06 Minio \u5b89\u88c5\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u53ef\u4ee5\u76f4\u63a5\u53c2\u8003\u5b98\u65b9\u6587\u6863 \u4f7f\u7528Kubernetes\u90e8\u7f72MinIO\uff0c\u5728 Kubernetes \u96c6\u7fa4\u4e0b\u9762\u53ef\u4ee5\u90e8\u7f72\u72ec\u7acb\u3001\u5206\u5e03\u5f0f\u6216\u5171\u4eab\u51e0\u79cd\u6a21\u5f0f\uff0c\u53ef\u4ee5\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u90e8\u7f72\uff0c\u6211\u4eec\u8fd9\u91cc\u4e3a\u4e86\u7b80\u5355\u76f4\u63a5\u90e8\u7f72\u72ec\u7acb\u6a21\u5f0f\u3002</p> <p>\u4e3a\u4e86\u65b9\u4fbf\u7ba1\u7406\uff0c\u5c06\u6240\u6709\u7684\u8d44\u6e90\u5bf9\u8c61\u90fd\u90e8\u7f72\u5728\u4e00\u4e2a\u540d\u4e3a minio \u7684\u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u5982\u679c\u6ca1\u6709\u7684\u8bdd\u9700\u8981\u624b\u52a8\u521b\u5efa\u3002\u76f4\u63a5\u4f7f\u7528 Deployment \u6765\u7ba1\u7406 Minio \u7684\u670d\u52a1\uff1a\uff08minio-deploy.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: minio\n  namespace: minio\nspec:\n  selector:\n    matchLabels:\n      app: minio \n  strategy:\n    type: Recreate\n  template:\n    metadata:\n      labels:\n        app: minio\n    spec:\n      volumes:\n      - name: data\n        persistentVolumeClaim:\n          claimName: minio-pvc\n      containers:\n      - name: minio\n        volumeMounts:\n        - name: data \n          mountPath: \"/data\"\n        image: minio/minio:RELEASE.2020-03-25T07-03-04Z\n        args:\n        - server\n        - /data\n        env:\n        - name: MINIO_ACCESS_KEY\n          value: \"minio\"\n        - name: MINIO_SECRET_KEY\n          value: \"minio123\"\n        ports:\n        - containerPort: 9000\n        readinessProbe:\n          httpGet:\n            path: /minio/health/ready\n            port: 9000\n          initialDelaySeconds: 90\n          periodSeconds: 10\n        livenessProbe:\n          httpGet:\n            path: /minio/health/live\n            port: 9000\n          initialDelaySeconds: 30\n          periodSeconds: 10\n</code></pre> <p>\u901a\u8fc7\u4e00\u4e2a\u540d\u4e3a <code>minio-pvc</code> \u7684 PVC \u5bf9\u8c61\u5c06\u6570\u636e\u6301\u4e45\u5316\uff0c\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u9759\u6001\u7684 PV \u6765\u63d0\u4f9b\u5b58\u50a8\uff0c\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u4f7f\u7528\u524d\u9762\u7684 Ceph RBD \u6765\u63d0\u4f9b\u5b58\u50a8\u670d\u52a1\uff0c\u4f7f\u7528 <code>rook-ceph-block</code> \u8fd9\u4e2a StorageClass \u5bf9\u8c61\u6765\u63d0\u4f9b\u52a8\u6001 PV\uff0c\u5bf9\u4e8e\u8fd9\u91cc\u4e0d\u719f\u6089\u7684\u53ef\u4ee5\u67e5\u770b\u524d\u9762\u6211\u4eec\u8bb2\u89e3\u7684\u5b58\u50a8\u7ae0\u8282\u5185\u5bb9\uff1a\uff08minio-pvc.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: minio-pvc\n  namespace: minio\nspec:\n  storageClassName: rook-ceph-block\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 50Gi\n</code></pre> <p>\u6700\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Service \u548c Ingress \u5bf9\u8c61\u5c06 Minio \u66b4\u9732\u7ed9\u5916\u90e8\u7528\u6237\u4f7f\u7528\uff1a\uff08minio-ingress.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: minio\n  namespace: minio\nspec:\n  ports:\n  - port: 9000\n    targetPort: 9000\n    protocol: TCP\n  selector:\n    app: minio\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: Middleware\nmetadata:\n  name: redirect-https\n  namespace: minio\nspec:\n  redirectScheme:\n    scheme: https\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: minio\n  namespace: minio\nspec:\n  entryPoints:\n  - web   \n  routes:\n  - kind: Rule\n    match: Host(`minio.qikqiak.com`)\n    services:\n    - kind: Service\n      name: minio\n      port: 9000\n    middlewares: \n    - name: redirect-https\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: minio-https\n  namespace: minio\nspec:\n  entryPoints:\n  - websecure    \n  routes:\n  - kind: Rule\n    match: Host(`minio.qikqiak.com`)\n    services:\n    - kind: Service\n      name: minio\n      port: 9000\n  tls:\n    certResolver: ali\n    domains:\n    - main: \"*.qikqiak.com\"\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684\u662f Traefik2.X \u7248\u672c\u7684 Ingress \u63a7\u5236\u5668\uff0c\u4f7f\u7528 IngressRoute \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u6765\u5b9a\u4e49 Ingress \u4fe1\u606f\uff0c\u5bf9\u4e8e\u8fd9\u90e8\u5206\u5185\u5bb9\u4e0d\u719f\u6089\u7684\u53ef\u4ee5\u67e5\u770b\u524d\u9762\u7684\u7f51\u7edc\u7ae0\u8282\u90e8\u5206\u7684\u5185\u5bb9\u3002\u7136\u540e\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl create ns minio\n$ kubectl apply -f minio-deploy.yaml\n$ kubectl apply -f minio-pvc.yaml\n$ kubectl apply -f minio-ingress.yaml\n</code></pre> <p>\u90e8\u7f72\u6210\u529f\u540e\uff0c\u5c06\u57df\u540d <code>minio.qikqiak.com</code> \u89e3\u6790\u5230 Ingress \u63a7\u5236\u5668\u6240\u5728\u7684\u8282\u70b9\u5373\u53ef\u901a\u8fc7\u6d4f\u89c8\u5668\u8bbf\u95ee\u5230 MinIO \u670d\u52a1\u4e86\uff0c\u901a\u8fc7\u4e0a\u9762\u5b9a\u4e49\u7684 <code>MINIO_ACCESS_KEY</code> \u548c <code>MINIO_SECRET_KEY</code> \u5373\u53ef\u767b\u5f55\uff1a</p> <p></p>"},{"location":"kubernetes_monitor/thanos/#thanos_store","title":"\u5b89\u88c5 Thanos Store","text":"<p>\u73b0\u5728\u5bf9\u8c61\u5b58\u50a8\u51c6\u5907\u597d\u4e86\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u6765\u4e0d\u662f Store \u7ec4\u4ef6\u4e86\uff0c\u8be5\u7ec4\u4ef6\u4f1a\u4ece\u5bf9\u8c61\u5b58\u50a8\u5230\u7ed9 Querier \u63d0\u4f9b metrics \u6570\u636e\u3002</p> <p>\u9996\u5148\u767b\u5f55 MinIO \u521b\u5efa\u4e00\u4e2a thanos \u7684 bucket\u3002\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u5bf9\u8c61\u5b58\u50a8\u914d\u7f6e\u6587\u4ef6\uff1a\uff08thanos-storage-minio.yaml\uff09</p> <pre><code>type: s3\nconfig:\n  bucket: thanos\n  endpoint: minio.minio.svc.cluster.local:9000\n  access_key: minio\n  secret_key: minio123\n  insecure: true\n  signature_version2: false\n</code></pre> <p>\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u6765\u521b\u5efa\u4e00\u4e2a Secret \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create secret generic thanos-objectstorage --from-file=thanos.yaml=thanos-storage-minio.yaml -n kube-mon\nsecret/thanos-objectstorage created\n</code></pre> <p>\u7136\u540e\u521b\u5efa Store \u7ec4\u4ef6\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u8fd9\u91cc\u6709\u4e00\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u662f\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a </p> <pre><code>thanos-store-api: \"true\"\n</code></pre> <p>\u7684\u6807\u7b7e\uff0c\u8fd9\u6837\u524d\u9762\u6211\u4eec\u521b\u5efa\u7684 <code>thanos-store-gateway</code> \u8fd9\u4e2a Headless Service \u5c31\u53ef\u4ee5\u81ea\u52a8\u53d1\u73b0\u5230\u8fd9\u4e2a\u670d\u52a1\uff0cQuerier \u7ec4\u4ef6\u67e5\u8be2\u6570\u636e\u7684\u65f6\u5019\u9664\u4e86\u53ef\u4ee5\u901a\u8fc7 Sidecar \u53bb\u83b7\u53d6\u6570\u636e\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a Store \u7ec4\u4ef6\u53bb\u5bf9\u8c61\u5b58\u50a8\u91cc\u9762\u83b7\u53d6\u6570\u636e\u4e86\u3002\u5c06\u4e0a\u9762\u7684 Secret \u5bf9\u8c61\u901a\u8fc7 Volume \u5f62\u5f0f\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u7684 <code>/etc/secret</code> \u76ee\u5f55\u4e0b\uff0c\u901a\u8fc7 <code>objstore.config-file</code> \u53c2\u6570\u6307\u5b9a\u5373\u53ef\uff1a\uff08store.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: thanos-store-gateway\n  namespace: kube-mon\n  labels:\n    app: thanos-store-gateway\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: thanos-store-gateway\n  serviceName: thanos-store-gateway\n  template:\n    metadata:\n      labels:\n        app: thanos-store-gateway\n        thanos-store-api: \"true\"\n    spec:\n      containers:\n        - name: thanos\n          image: thanosio/thanos:v0\n          args:\n          - \"store\"\n          - \"--log.level=debug\"\n          - \"--data-dir=/data\"\n          - \"--objstore.config-file=/etc/secret/thanos.yaml\"\n          - \"--index-cache-size=500MB\"\n          - \"--chunk-pool-size=500MB\"\n          ports:\n          - name: http\n            containerPort: 10902\n          - name: grpc\n            containerPort: 10901\n          livenessProbe:\n            httpGet:\n              port: 10902\n              path: /-/healthy\n          readinessProbe:\n            httpGet:\n              port: 10902\n              path: /-/ready\n          volumeMounts:\n            - name: object-storage-config\n              mountPath: /etc/secret\n              readOnly: false\n      volumes:\n        - name: object-storage-config\n          secret:\n            secretName: thanos-objectstorage\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f store.yaml\n$ kubectl get pods -n kube-mon -l thanos-store-api=true   \nNAME                     READY   STATUS    RESTARTS   AGE\nprometheus-0             2/2     Running   0          15h\nprometheus-1             2/2     Running   0          15h\nthanos-store-gateway-0   1/1     Running   0          100s\n</code></pre> <p>\u90e8\u7f72\u6210\u529f\u540e\u8fd9\u4e2a\u65f6\u5019\u53bb Thano \u7684 Querier \u9875\u9762\u4e0a\u67e5\u770b Store \u4fe1\u606f\u5c31\u53ef\u4ee5\u53d1\u73b0\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u7684 Store \u7ec4\u4ef6\u4e86\uff1a</p> <p></p> <p>\u5230\u8fd9\u91cc\u8bc1\u660e\u6211\u4eec\u7684 Thanos \u7ec4\u4ef6\u4e5f\u914d\u7f6e\u6210\u529f\u4e86\u3002\u4f46\u662f\u8fd8\u6709\u4e00\u4e2a\u660e\u663e\u7684\u95ee\u9898\u662f\u8fd9\u91cc\u6211\u4eec\u53ea\u662f\u914d\u7f6e\u53bb\u5bf9\u8c61\u5b58\u50a8\u4e2d\u67e5\u8be2\u6570\u636e\u7684\u7ec4\u4ef6\uff0c\u90a3\u4ec0\u4e48\u5730\u65b9\u5f80\u5bf9\u8c61\u5b58\u50a8\u4e2d\u5199\u5165\u6570\u636e\u5462\uff1f\u5f53\u7136\u8fd8\u662f\u5728 Sidecar \u7ec4\u4ef6\u91cc\u9762\u4e86\u3002\u6240\u4ee5\u540c\u6837\u6211\u4eec\u9700\u8981\u628a <code>objstore.config-file</code> \u53c2\u6570\u548c Secret \u5bf9\u8c61\u4e5f\u8981\u914d\u7f6e\u5230 Sidecar \u7ec4\u4ef6\u4e2d\u53bb\uff1a</p> <pre><code>......\nvolumes:\n- name: object-storage-config\n  secret:\n    secretName: thanos-objectstorage\n......\nargs:\n- sidecar\n- --log.level=debug\n- --tsdb.path=/prometheus\n- --prometheus.url=http://localhost:9090\n- --reloader.config-file=/etc/prometheus/prometheus.yaml.tmpl\n- --reloader.config-envsubst-file=/etc/prometheus-shared/prometheus.yaml\n- --reloader.rule-dir=/etc/prometheus/rules/\n- --objstore.config-file=/etc/secret/thanos.yaml\n......\nvolumeMounts:\n- name: object-storage-config\n  mountPath: /etc/secret\n  readOnly: false\n......\n</code></pre> <p>\u914d\u7f6e\u5b8c\u6210\u540e\u91cd\u65b0\u66f4\u65b0 Sidecar \u7ec4\u4ef6\u5373\u53ef\u3002\u914d\u7f6e\u751f\u6548\u8fc7\u540e\u6b63\u5e38\u7684\u8bdd\u5c31\u4f1a\u6709\u6570\u636e\u4f20\u5165\u5230 MinIO \u91cc\u9762\u53bb\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u53bb MinIO \u7684\u9875\u9762\u4e0a\u67e5\u770b\u9a8c\u8bc1\uff1a</p> <p></p>"},{"location":"kubernetes_monitor/thanos/#compactor","title":"Compactor \u7ec4\u4ef6","text":"<p>\u73b0\u5728\u5386\u53f2\u76d1\u63a7\u6570\u636e\u5df2\u7ecf\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u4e2d\u53bb\u4e86\uff0c\u4f46\u662f\u7531\u4e8e\u76d1\u63a7\u6570\u636e\u91cf\u975e\u5e38\u5e9e\u5927\uff0c\u6240\u4ee5\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u4f1a\u53bb\u5b89\u88c5\u4e00\u4e2a Thanos \u7684 Compactor \u7ec4\u4ef6\uff0c\u7528\u6765\u5c06\u5bf9\u8c61\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u538b\u7f29\u548c\u4e0b\u91c7\u6837\u3002Compactor \u7ec4\u4ef6\u7684\u90e8\u7f72\u548c Store \u975e\u5e38\u7c7b\u4f3c\uff0c\u6307\u5b9a\u5bf9\u8c61\u5b58\u50a8\u7684\u914d\u7f6e\u6587\u4ef6\u5373\u53ef\uff0c\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a\uff08compactor.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: thanos-compactor\n  namespace: kube-mon\n  labels:\n    app: thanos-compactor\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: thanos-compactor\n  serviceName: thanos-compactor\n  template:\n    metadata:\n      labels:\n        app: thanos-compactor\n    spec:\n      containers:\n      - name: thanos\n        image: thanosio/thanos:v0\n        args:\n        - \"compact\"\n        - \"--log.level=debug\"\n        - \"--data-dir=/data\"\n        - \"--objstore.config-file=/etc/secret/thanos.yaml\"\n        - \"--wait\"\n        ports:\n        - name: http\n          containerPort: 10902\n        livenessProbe:\n          httpGet:\n            port: 10902\n            path: /-/healthy\n          initialDelaySeconds: 10\n        readinessProbe:\n          httpGet:\n            port: 10902\n            path: /-/ready\n          initialDelaySeconds: 15\n        volumeMounts:\n        - name: object-storage-config\n          mountPath: /etc/secret\n          readOnly: false\n      volumes:\n      - name: object-storage-config\n        secret:\n          secretName: thanos-objectstorage\n</code></pre> <p>\u6700\u91cd\u8981\u7684\u8fd8\u662f\u63d0\u4f9b\u5bf9\u8c61\u5b58\u50a8\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u7136\u540e\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a</p> <pre><code>$ kubectl apply -f compactor.yaml\n$ kubectl get pods -n kube-mon -l app=thanos-compactor\nNAME                 READY   STATUS    RESTARTS   AGE\nthanos-compactor-0   1/1     Running   0          68s\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 Thanos \u6765\u90e8\u7f72\u9ad8\u53ef\u7528\u7684 Prometheus \u96c6\u7fa4\uff0c\u5f53\u7136 Thanos \u8fd8\u6709\u5176\u4ed6\u7684\u4e00\u4e9b\u7ec4\u4ef6\uff0c\u6bd4\u5982 Check\u3001Bucket\u3001Receiver \u7b49\uff0c\u5bf9\u4e8e\u8fd9\u4e9b\u7ec4\u4ef6\u7684\u4f7f\u7528\u611f\u5174\u8da3\u7684\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863 https://thanos.io/\u3002</p> <p>\u5c06 Thanos \u4e0e Prometheus \u96c6\u6210\u53ef\u8ba9\u6211\u4eec\u5bf9 Prometheus \u8fdb\u884c\u6c34\u5e73\u4f38\u7f29\u3002\u7531\u4e8e <code>Thanos Querier</code> \u53ef\u4ee5\u4ece\u5176\u4ed6\u67e5\u8be2\u5668\u5b9e\u4f8b\u4e2d\u63d0\u53d6\u6307\u6807\uff0c\u56e0\u6b64\u6211\u4eec\u4e5f\u53ef\u4ee5\u8de8\u96c6\u7fa4\u63d0\u53d6\u6307\u6807\u5e76\u5728 Grafana \u4e2d\u53ef\u89c6\u5316\u5b83\u4eec\uff0cThanos \u4f7f\u6211\u4eec\u53ef\u4ee5\u5c06\u5ea6\u91cf\u6807\u51c6\u6570\u636e\u5f52\u6863\u5230\u5bf9\u8c61\u5b58\u50a8\u4e2d\uff0c\u8be5\u5bf9\u8c61\u5b58\u50a8\u4e3a\u6211\u4eec\u7684\u76d1\u63a7\u7cfb\u7edf\u63d0\u4f9b\u4e86\u65e0\u9650\u7684\u5b58\u50a8\u7a7a\u95f4\uff0c\u800c\u4e14\u5b83\u8fd8\u53ef\u4ee5\u4ece\u5bf9\u8c61\u5b58\u50a8\u4e2d\u63d0\u4f9b\u6307\u6807\uff0c\u5982\u679c\u6211\u4eec\u5bf9\u8fd9\u4e9b\u5bf9\u8c61\u5b58\u50a8\u8bbe\u7f6e\u4e00\u4e9b\u9002\u5f53\u7684\u4fdd\u7559\u7b56\u7565\uff0c\u8fd8\u53ef\u4ee5\u5c06\u8d39\u7528\u964d\u5230\u66f4\u4f4e\u3002</p>"},{"location":"kubernetes_monitor/operator/advance/","title":"\u9ad8\u7ea7\u914d\u7f6e","text":""},{"location":"kubernetes_monitor/operator/advance/#_1","title":"\u9ad8\u7ea7\u914d\u7f6e","text":"<p>\u524d\u9762\u6211\u4eec\u4e00\u8d77\u5b66\u4e60\u4e86\u5982\u4f55\u5728 Prometheus Operator \u4e0b\u9762\u81ea\u5b9a\u4e49\u4e00\u4e2a\u76d1\u63a7\u9879\uff0c\u4ee5\u53ca\u81ea\u5b9a\u4e49\u62a5\u8b66\u89c4\u5219\u7684\u4f7f\u7528\u3002\u90a3\u4e48\u6211\u4eec\u8fd8\u80fd\u591f\u76f4\u63a5\u4f7f\u7528\u524d\u9762\u8bfe\u7a0b\u4e2d\u7684\u81ea\u52a8\u53d1\u73b0\u529f\u80fd\u5417\uff1f\u5982\u679c\u5728\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\u4e2d\u6709\u4e86\u5f88\u591a\u7684 Service/Pod\uff0c\u90a3\u4e48\u6211\u4eec\u90fd\u9700\u8981\u4e00\u4e2a\u4e00\u4e2a\u7684\u53bb\u5efa\u7acb\u4e00\u4e2a\u5bf9\u5e94\u7684 <code>ServiceMonitor</code> \u5bf9\u8c61\u6765\u8fdb\u884c\u76d1\u63a7\u5417\uff1f\u8fd9\u6837\u5c82\u4e0d\u662f\u53c8\u53d8\u5f97\u9ebb\u70e6\u8d77\u6765\u4e86\uff1f</p>"},{"location":"kubernetes_monitor/operator/advance/#_2","title":"\u81ea\u52a8\u53d1\u73b0\u914d\u7f6e","text":"<p>\u4e3a\u89e3\u51b3\u4e0a\u9762\u7684\u95ee\u9898\uff0cPrometheus Operator \u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u989d\u5916\u7684\u6293\u53d6\u914d\u7f6e\u7684\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0\u989d\u5916\u7684\u914d\u7f6e\u6765\u8fdb\u884c\u670d\u52a1\u53d1\u73b0\u8fdb\u884c\u81ea\u52a8\u76d1\u63a7\u3002\u548c\u524d\u9762\u81ea\u5b9a\u4e49\u7684\u65b9\u5f0f\u4e00\u6837\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 Prometheus Operator \u5f53\u4e2d\u53bb\u81ea\u52a8\u53d1\u73b0\u5e76\u76d1\u63a7\u5177\u6709</p> <pre><code>prometheus.io/scrape=true\n</code></pre> <p>\u8fd9\u4e2a <code>annotations</code> \u7684 Service\uff0c\u4e4b\u524d\u6211\u4eec\u5b9a\u4e49\u7684 Prometheus \u7684\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>- job_name: 'kubernetes-endpoints'\n  kubernetes_sd_configs:\n  - role: endpoints\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]\n    action: keep\n    regex: true\n  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]\n    action: replace\n    target_label: __scheme__\n    regex: (https?)\n  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\n    action: replace\n    target_label: __metrics_path__\n    regex: (.+)\n  - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]\n    action: replace\n    target_label: __address__\n    regex: ([^:]+)(?::\\\\d+)?;(\\\\d+)\n    replacement: $1:$2\n  - action: labelmap\n    regex: __meta_kubernetes_service_label_(.+)\n  - source_labels: [__meta_kubernetes_namespace]\n    action: replace\n    target_label: kubernetes_namespace\n  - source_labels: [__meta_kubernetes_service_name]\n    action: replace\n    target_label: kubernetes_name\n  - source_labels: [__meta_kubernetes_pod_name]\n    action: replace\n    target_label: kubernetes_pod_name\n</code></pre> <p>\u5982\u679c\u4f60\u5bf9\u4e0a\u9762\u8fd9\u4e2a\u914d\u7f6e\u8fd8\u4e0d\u662f\u5f88\u719f\u6089\u7684\u8bdd\uff0c\u5efa\u8bae\u53bb\u67e5\u770b\u4e0b\u524d\u9762\u5173\u4e8e Kubernetes \u5e38\u7528\u8d44\u6e90\u5bf9\u8c61\u76d1\u63a7\u7ae0\u8282\u7684\u4ecb\u7ecd\uff0c\u8981\u60f3\u81ea\u52a8\u53d1\u73b0\u96c6\u7fa4\u4e2d\u7684 Service\uff0c\u5c31\u9700\u8981\u6211\u4eec\u5728 Service \u7684 annotation \u533a\u57df\u6dfb\u52a0 </p> <pre><code>prometheus.io/scrape=true\n</code></pre> <p>\u7684\u58f0\u660e\uff0c\u5c06\u4e0a\u9762\u6587\u4ef6\u76f4\u63a5\u4fdd\u5b58\u4e3a </p> <pre><code>prometheus-additional.yaml\n</code></pre> <p>\uff0c\u7136\u540e\u901a\u8fc7\u8fd9\u4e2a\u6587\u4ef6\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 Secret \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create secret generic additional-configs --from-file=prometheus-additional.yaml -n monitoring\nsecret \"additional-configs\" created\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u9700\u8981\u5728\u58f0\u660e prometheus \u7684\u8d44\u6e90\u5bf9\u8c61\u6587\u4ef6\u4e2d\u901a\u8fc7 </p> <pre><code>additionalScrapeConfigs\n</code></pre> <p>\u5c5e\u6027\u6dfb\u52a0\u4e0a\u8fd9\u4e2a\u989d\u5916\u7684\u914d\u7f6e\uff1a(prometheus-prometheus.yaml)</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  labels:\n    prometheus: k8s\n  name: k8s\n  namespace: monitoring\nspec:\n  alerting:\n    alertmanagers:\n    - name: alertmanager-main\n      namespace: monitoring\n      port: web\n  image: quay.io/prometheus/prometheus:v2\n  nodeSelector:\n    kubernetes.io/os: linux\n  podMonitorNamespaceSelector: {}\n  podMonitorSelector: {}\n  replicas: 2\n  resources:\n    requests:\n      memory: 400Mi\n  ruleSelector:\n    matchLabels:\n      prometheus: k8s\n      role: alert-rules\n  securityContext:\n    fsGroup: 2000\n    runAsNonRoot: true\n    runAsUser: 1000\n  serviceAccountName: prometheus-k8s\n  serviceMonitorNamespaceSelector: {}\n  serviceMonitorSelector: {}\n  version: v2\n  additionalScrapeConfigs:\n    name: additional-configs\n    key: prometheus-additional.yaml\n</code></pre> <p>\u5173\u4e8e </p> <pre><code>additionalScrapeConfigs\n</code></pre> <p>\u5c5e\u6027\u7684\u5177\u4f53\u4ecb\u7ecd\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>kubectl explain</code> \u547d\u4ee4\u6765\u4e86\u89e3\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl explain prometheus.spec.additionalScrapeConfigs\nKIND:     Prometheus\nVERSION:  monitoring.coreos.com/v1\n\nRESOURCE: additionalScrapeConfigs &lt;Object&gt;\n\nDESCRIPTION:\n     AdditionalScrapeConfigs allows specifying a key of a Secret containing\n     additional Prometheus scrape configurations. Scrape configurations\n     specified are appended to the configurations generated by the Prometheus\n     Operator. Job configurations specified must have the form as specified in\n     the official Prometheus documentation:\n     https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config.\n     As scrape configs are appended, the user is responsible to make sure it is\n     valid. Note that using this feature may expose the possibility to break\n     upgrades of Prometheus. It is advised to review Prometheus release notes to\n     ensure that no incompatible scrape configs are going to break Prometheus\n     after the upgrade.\n\nFIELDS:\n   key  &lt;string&gt; -required-\n     The key of the secret to select from. Must be a valid secret key.\n\n   name &lt;string&gt;\n     Name of the referent. More info:\n     https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names\n     TODO: Add other useful fields. apiVersion, kind, uid?\n\n   optional     &lt;boolean&gt;\n     Specify whether the Secret or its key must be defined\n</code></pre> <p>\u6dfb\u52a0\u5b8c\u6210\u540e\uff0c\u76f4\u63a5\u66f4\u65b0 prometheus \u8fd9\u4e2a CRD \u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f prometheus-prometheus.yaml\nprometheus.monitoring.coreos.com \"k8s\" configured\n</code></pre> <p>\u9694\u4e00\u5c0f\u4f1a\u513f\uff0c\u53ef\u4ee5\u524d\u5f80 Prometheus \u7684 Dashboard \u4e2d\u67e5\u770b\u914d\u7f6e\u5df2\u7ecf\u751f\u6548\u4e86\uff1a </p> <p>\u4f46\u662f\u6211\u4eec\u5207\u6362\u5230 targets \u9875\u9762\u4e0b\u9762\u5374\u5e76\u6ca1\u6709\u53d1\u73b0\u5bf9\u5e94\u7684\u76d1\u63a7\u4efb\u52a1\uff0c\u67e5\u770b Prometheus \u7684 Pod \u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs -f prometheus-k8s-0 prometheus -n monitoring\n......\nlevel=error ts=2020-04-18T02:38:800Z caller=klog.go:94 component=k8s_client_runtime func=ErrorDepth msg=\"/app/discovery/kubernetes/kubernetes.go:261: Failed to list *vEndpoints: endpoints is forbidden: User \\\\\"system:serviceaccount:monitoring:prometheus-k8s\\\\\" cannot list resource \\\\\"endpoints\\\\\" in API group \\\\\"\\\\\" at the cluster scope\"\nlevel=error ts=2020-04-18T02:38:801Z caller=klog.go:94 component=k8s_client_runtime func=ErrorDepth msg=\"/app/discovery/kubernetes/kubernetes.go:263: Failed to list *vPod: pods is forbidden: User \\\\\"system:serviceaccount:monitoring:prometheus-k8s\\\\\" cannot list resource \\\\\"pods\\\\\" in API group \\\\\"\\\\\" at the cluster scope\"\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6709\u5f88\u591a\u9519\u8bef\u65e5\u5fd7\u51fa\u73b0\uff0c\u90fd\u662f <code>xxx is forbidden</code>\uff0c\u8fd9\u8bf4\u660e\u662f RBAC \u6743\u9650\u7684\u95ee\u9898\uff0c\u901a\u8fc7 prometheus \u8d44\u6e90\u5bf9\u8c61\u7684\u914d\u7f6e\u53ef\u4ee5\u77e5\u9053 Prometheus \u7ed1\u5b9a\u4e86\u4e00\u4e2a\u540d\u4e3a <code>prometheus-k8s</code> \u7684 ServiceAccount \u5bf9\u8c61\uff0c\u800c\u8fd9\u4e2a\u5bf9\u8c61\u7ed1\u5b9a\u7684\u662f\u4e00\u4e2a\u540d\u4e3a <code>prometheus-k8s</code> \u7684 ClusterRole\uff1a\uff08prometheus-clusterRole.yaml\uff09</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: prometheus-k8s\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - nodes/metrics\n  verbs:\n  - get\n- nonResourceURLs:\n  - /metrics\n  verbs:\n  - get\n</code></pre> <p>\u4e0a\u9762\u7684\u6743\u9650\u89c4\u5219\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u660e\u663e\u6ca1\u6709\u5bf9 Service \u6216\u8005 Pod \u7684 <code>list</code> \u6743\u9650\uff0c\u6240\u4ee5\u62a5\u9519\u4e86\uff0c\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u53ea\u9700\u8981\u6dfb\u52a0\u4e0a\u9700\u8981\u7684\u6743\u9650\u5373\u53ef\uff1a</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: prometheus-k8s\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - nodes\n  - services\n  - endpoints\n  - pods\n  - nodes/proxy\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - \"\"\n  resources:\n  - configmaps\n  - nodes/metrics\n  verbs:\n  - get\n- nonResourceURLs:\n  - /metrics\n  verbs:\n  - get\n</code></pre> <p>\u66f4\u65b0\u4e0a\u9762\u7684 <code>ClusterRole</code> \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u7136\u540e\u91cd\u5efa\u4e0b Prometheus \u7684\u6240\u6709 Pod\uff0c\u6b63\u5e38\u5c31\u53ef\u4ee5\u770b\u5230 targets \u9875\u9762\u4e0b\u9762\u6709 <code>kubernetes-endpoints</code> \u8fd9\u4e2a\u76d1\u63a7\u4efb\u52a1\u4e86\uff1a </p> <p>\u8fd9\u91cc\u53d1\u73b0\u7684\u51e0\u4e2a\u6293\u53d6\u76ee\u6807\u662f\u56e0\u4e3a Service \u4e2d\u90fd\u6709 </p> <pre><code>prometheus.io/scrape=true\n</code></pre> <p>\u8fd9\u4e2a annotation\u3002</p>"},{"location":"kubernetes_monitor/operator/advance/#_3","title":"\u6570\u636e\u6301\u4e45\u5316","text":"<p>\u4e0a\u9762\u6211\u4eec\u5728\u4fee\u6539\u5b8c\u6743\u9650\u7684\u65f6\u5019\uff0c\u91cd\u542f\u4e86 Prometheus \u7684 Pod\uff0c\u5982\u679c\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u7684\u8bdd\u4f1a\u53d1\u73b0\u6211\u4eec\u4e4b\u524d\u91c7\u96c6\u7684\u6570\u636e\u5df2\u7ecf\u6ca1\u6709\u4e86\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u901a\u8fc7 prometheus \u8fd9\u4e2a CRD \u521b\u5efa\u7684 Prometheus \u5e76\u6ca1\u6709\u505a\u6570\u636e\u7684\u6301\u4e45\u5316\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b\u751f\u6210\u7684 Prometheus Pod \u7684\u6302\u8f7d\u60c5\u51b5\u5c31\u6e05\u695a\u4e86\uff1a</p> <pre><code>$ kubectl get pod prometheus-k8s-0 -n monitoring -o yaml\n......\n    volumeMounts:\n    - mountPath: /etc/prometheus/config_out\n      name: config-out\n      readOnly: true\n    - mountPath: /prometheus\n      name: prometheus-k8s-db\n......\n  volumes:\n......\n  - emptyDir: {}\n    name: prometheus-k8s-db\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Prometheus \u7684\u6570\u636e\u76ee\u5f55 <code>/prometheus</code> \u5b9e\u9645\u4e0a\u662f\u901a\u8fc7 <code>emptyDir</code> \u8fdb\u884c\u6302\u8f7d\u7684\uff0c\u6211\u4eec\u77e5\u9053 emptyDir \u6302\u8f7d\u7684\u6570\u636e\u7684\u751f\u547d\u5468\u671f\u548c Pod \u751f\u547d\u5468\u671f\u4e00\u81f4\u7684\uff0c\u6240\u4ee5\u5982\u679c Pod \u6302\u6389\u4e86\uff0c\u6570\u636e\u4e5f\u5c31\u4e22\u5931\u4e86\uff0c\u8fd9\u4e5f\u5c31\u662f\u4e3a\u4ec0\u4e48\u6211\u4eec\u91cd\u5efa Pod \u540e\u4e4b\u524d\u7684\u6570\u636e\u5c31\u6ca1\u6709\u4e86\u7684\u539f\u56e0\uff0c\u5bf9\u5e94\u7ebf\u4e0a\u7684\u76d1\u63a7\u6570\u636e\u80af\u5b9a\u9700\u8981\u505a\u6570\u636e\u7684\u6301\u4e45\u5316\u7684\uff0c\u540c\u6837\u7684 prometheus \u8fd9\u4e2a CRD \u8d44\u6e90\u4e5f\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u6570\u636e\u6301\u4e45\u5316\u7684\u914d\u7f6e\u65b9\u6cd5\uff0c\u7531\u4e8e\u6211\u4eec\u7684 Prometheus \u6700\u7ec8\u662f\u901a\u8fc7 Statefulset \u63a7\u5236\u5668\u8fdb\u884c\u90e8\u7f72\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u901a\u8fc7 <code>storageclass</code> \u6765\u505a\u6570\u636e\u6301\u4e45\u5316\uff0c\u540c\u6837\u8fd8\u662f\u76f4\u63a5\u4f7f\u7528\u524d\u9762\u8bfe\u7a0b\u4e2d\u7684 <code>Ceph RBD</code> \u7684 <code>rook-ceph-block</code> \u8fd9\u4e2aStorageClass \u5bf9\u8c61\uff0c\u6b64\u5916\u7531\u4e8e Prometheus \u672c\u8eab\u5bf9 NFS \u5b58\u50a8\u6ca1\u6709\u505a\u76f8\u5173\u7684\u652f\u6301\uff0c\u6240\u4ee5\u7ebf\u4e0a\u4e00\u5b9a\u4e0d\u8981\u7528 NFS \u6765\u505a\u6570\u636e\u6301\u4e45\u5316\uff0c\u5bf9\u4e8e\u5982\u4f55\u53bb\u4e3a prometheus \u8fd9\u4e2a CRD \u5bf9\u8c61\u914d\u7f6e\u5b58\u50a8\u6570\u636e\uff0c\u6211\u4eec\u53ef\u4ee5\u53bb\u67e5\u770b\u5b98\u65b9\u6587\u6863 API\uff0c\u4e5f\u53ef\u4ee5\u7528 <code>kubectl explain</code> \u547d\u4ee4\u53bb\u4e86\u89e3\uff1a</p> <pre><code>$ kubectl explain prometheus.spec.storage\nKIND:     Prometheus\nVERSION:  monitoring.coreos.com/v1\n\nRESOURCE: storage &lt;Object&gt;\n\nDESCRIPTION:\n     Storage spec to specify how storage shall be used.\n\nFIELDS:\n   emptyDir     &lt;Object&gt;\n     EmptyDirVolumeSource to be used by the Prometheus StatefulSets. If\n     specified, used in place of any volumeClaimTemplate. More info:\n     https://kubernetes.io/docs/concepts/storage/volumes/#emptydir\n\n   volumeClaimTemplate  &lt;Object&gt;\n     A PVC spec to be used by the Prometheus StatefulSets.\n</code></pre> <p>\u6240\u4ee5\u6211\u4eec\u5728 prometheus \u7684 CRD \u5bf9\u8c61\u4e2d\u901a\u8fc7 <code>storage</code> \u5c5e\u6027\u914d\u7f6e <code>volumeClaimTemplate</code> \u5bf9\u8c61\u5373\u53ef\uff1a(prometheus-prometheus.yaml)</p> <pre><code>......\nstorage:\n  volumeClaimTemplate:\n    spec:\n      storageClassName: rook-ceph-block\n      resources:\n        requests:\n          storage: 20Gi\n</code></pre> <p>\u7136\u540e\u66f4\u65b0 prometheus \u8fd9\u4e2a CRD \u8d44\u6e90\uff0c\u66f4\u65b0\u5b8c\u6210\u540e\u4f1a\u81ea\u52a8\u751f\u6210\u4e24\u4e2a PVC \u548c PV \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f prometheus-prometheus.yaml \nprometheus.monitoring.coreos.com/k8s configured\n$ kubectl get pvc -n monitoring                              \nNAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE\nprometheus-k8s-db-prometheus-k8s-0   Bound    pvc-79ad4856-2ab0-4445-814f-958a4699fab9   20Gi       RWO            rook-ceph-block   56s\nprometheus-k8s-db-prometheus-k8s-1   Bound    pvc-8eae438e-bf7f-41a3-ae58-d7018c727866   20Gi       RWO            rook-ceph-block   55s\n$ kubectl get pv |grep monitoring\npvc-79ad4856-2ab0-4445-814f-958a4699fab9   20Gi       RWO            Retain           Bound      monitoring/prometheus-k8s-db-prometheus-k8s-0          rook-ceph-block            90s\npvc-8eae438e-bf7f-41a3-ae58-d7018c727866   20Gi       RWO            Retain           Bound      monitoring/prometheus-k8s-db-prometheus-k8s-1          rook-ceph-block            90s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u518d\u53bb\u770b Prometheus Pod \u7684\u6570\u636e\u76ee\u5f55\u5c31\u53ef\u4ee5\u770b\u5230\u662f\u5173\u8054\u5230\u4e00\u4e2a PVC \u5bf9\u8c61\u4e0a\u4e86\uff1a</p> <pre><code>$ kubectl get pod prometheus-k8s-0 -n monitoring -o yaml\n......\n    volumeMounts:\n    - mountPath: /etc/prometheus/config_out\n      name: config-out\n      readOnly: true\n    - mountPath: /prometheus\n      name: prometheus-k8s-db\n......\n  volumes:\n......\n  - name: prometheus-k8s-db\n    persistentVolumeClaim:\n      claimName: prometheus-k8s-db-prometheus-k8s-0\n......\n</code></pre> <p>\u73b0\u5728\u5373\u4f7f\u6211\u4eec\u7684 Pod \u6302\u6389\u4e86\uff0c\u6570\u636e\u4e5f\u4e0d\u4f1a\u4e22\u5931\u4e86\u3002\u5230\u8fd9\u91cc Prometheus Operator \u7684\u4e00\u4e9b\u57fa\u672c\u914d\u7f6e\u5c31\u7b97\u5b8c\u6210\u4e86\uff0c\u5bf9\u4e8e\u5927\u578b\u7684\u76d1\u63a7\u96c6\u7fa4\u8fd8\u9700\u8981\u505a\u4e00\u4e9b\u5176\u4ed6\u914d\u7f6e\uff0c\u6bd4\u5982\u524d\u9762\u6211\u4eec\u5b66\u4e60\u7684\u4f7f\u7528 <code>Thanos</code> \u6765\u505a Prometheus \u96c6\u7fa4\u7684\u9ad8\u53ef\u7528\u5df2\u7ecf\u6570\u636e\u8fdc\u7a0b\u5b58\u50a8\uff0c\u5bf9\u4e8e Prometheus Operator \u6765\u8bf4\uff0c\u8981\u914d\u7f6e <code>Thanos</code> \u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c\u56e0\u4e3a prometheus \u8fd9\u4e2a CRD \u5bf9\u8c61\u672c\u8eab\u4e5f\u652f\u6301\u7684\uff1a</p> <pre><code>$ kubectl explain prometheus.spec.thanos                     \nKIND:     Prometheus\nVERSION:  monitoring.coreos.com/v1\n\nRESOURCE: thanos &lt;Object&gt;\n\nDESCRIPTION:\n     Thanos configuration allows configuring various aspects of a Prometheus\n     server in a Thanos environment. This section is experimental, it may change\n     significantly without deprecation notice in any release. This is\n     experimental and may change significantly without backward compatibility in\n     any release.\n\nFIELDS:\n   baseImage    &lt;string&gt;\n     Thanos base image if other than default.\n\n   grpcServerTlsConfig  &lt;Object&gt;\n     GRPCServerTLSConfig configures the gRPC server from which Thanos Querier\n     reads recorded rule data. Note: Currently only the CAFile, CertFile, and\n     KeyFile fields are supported. Maps to the '--grpc-server-tls-*' CLI args.\n\n   image        &lt;string&gt;\n     Image if specified has precedence over baseImage, tag and sha combinations.\n     Specifying the version is still necessary to ensure the Prometheus Operator\n     knows what version of Thanos is being configured.\n\n   listenLocal  &lt;boolean&gt;\n     ListenLocal makes the Thanos sidecar listen on loopback, so that it does\n     not bind against the Pod IP.\n\n   objectStorageConfig  &lt;Object&gt;\n     ObjectStorageConfig configures object storage in Thanos.\n\n   resources    &lt;Object&gt;\n     Resources defines the resource requirements for the Thanos sidecar. If not\n     provided, no requests/limits will be set\n\n   sha  &lt;string&gt;\n     SHA of Thanos container image to be deployed. Defaults to the value of\n     `version`. Similar to a tag, but the SHA explicitly deploys an immutable\n     container image. Version and Tag are ignored if SHA is set.\n\n   tag  &lt;string&gt;\n     Tag of Thanos sidecar container image to be deployed. Defaults to the value\n     of `version`. Version is ignored if Tag is set.\n\n   tracingConfig        &lt;Object&gt;\n     TracingConfig configures tracing in Thanos. This is an experimental\n     feature, it may change in any upcoming release in a breaking way.\n\n   version      &lt;string&gt;\n     Version describes the version of Thanos to use.\n</code></pre> <p>\u6587\u6863</p> <p>\u5173\u4e8e prometheus operator \u4e2d\u5982\u4f55\u914d\u7f6e thanos\uff0c\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863\u7684\u4ecb\u7ecd\uff1ahttps://github.com/coreos/prometheus-operator/blob/master/Documentation/thanos.md\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u5c5e\u6027\u4e2d\u6709\u4e00\u4e2a <code>objectStorageConfig</code> \u5b57\u6bb5\uff0c\u8be5\u5b57\u6bb5\u4e5f\u5c31\u662f\u7528\u6765\u6307\u5b9a\u5bf9\u8c61\u5b58\u50a8\u76f8\u5173\u914d\u7f6e\u7684\uff0c\u8fd9\u91cc\u540c\u6837\u6211\u4eec\u4f7f\u7528\u524d\u9762 <code>Thanos</code> \u7ae0\u8282\u4e2d\u7684\u5bf9\u8c61\u5b58\u50a8\u914d\u7f6e\u5373\u53ef\uff1a(thanos-storage-minio.yaml)</p> <pre><code>type: s3\nconfig:\n  bucket: promethes-operator-data  # \u8bb0\u5f97\u5728 minio \u4e2d\u521b\u5efa\u8fd9\u4e2a bucket\n  endpoint: minio.minio.svc.cluster.local:9000\n  access_key: minio\n  secret_key: minio123\n  insecure: true\n  signature_version2: false\n</code></pre> <p>\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 Secret \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl -n monitoring create secret generic thanos-objectstorage --from-file=thanos.yaml=thanos-storage-minio.yaml\nsecret/thanos-objectstorage created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u5728 prometheus \u7684 CRD \u5bf9\u8c61\u4e2d\u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\uff1a(prometheus-prometheus.yaml )</p> <pre><code>thanos:\n  objectStorageConfig:\n    key: thanos.yaml\n    name: thanos-objectstorage\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u66f4\u65b0 prometheus \u8fd9\u4e2a CRD \u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f prometheus-prometheus.yaml \nprometheus.monitoring.coreos.com/k8s configured\n$ kubectl get pods -n monitoring -l app=prometheus\nNAME               READY   STATUS    RESTARTS   AGE\nprometheus-k8s-0   4/4     Running   1          11m\nprometheus-k8s-1   4/4     Running   0          11m\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u770b\u5230 Prometheus \u7684 Pod \u53d8\u6210\u4e864\u4e2a\u5bb9\u5668\uff0c\u65b0\u589e\u4e86\u4e00\u4e2a sidecar \u5bb9\u5668\uff1a</p> <pre><code>$ kubectl get pod prometheus-k8s-0 -n monitoring -o yaml\n......\n  - args:\n    - sidecar\n    - --prometheus.url=http://localhost:9090/\n    - --tsdb.path=/prometheus\n    - --grpc-address=[$(POD_IP)]:10901\n    - --http-address=[$(POD_IP)]:10902\n    - --objstore.config=$(OBJSTORE_CONFIG)\n    env:\n    - name: POD_IP\n      valueFrom:\n        fieldRef:\n          apiVersion: v1\n          fieldPath: status.podIP\n    - name: OBJSTORE_CONFIG\n      valueFrom:\n        secretKeyRef:\n          key: thanos.yaml\n          name: thanos-objectstorage\n    image: quay.io/thanos/thanos:v0\n    imagePullPolicy: IfNotPresent\n    name: thanos-sidecar\n    ports:\n    - containerPort: 10902\n      name: http\n      protocol: TCP\n    - containerPort: 10901\n      name: grpc\n      protocol: TCP\n......\n</code></pre> <p>\u8fd9\u4e2a\u5176\u5b9e\u548c\u524d\u9762\u8bfe\u7a0b\u4e2d\u5b66\u4e60\u7684\u624b\u52a8\u65b9\u5f0f\u90e8\u7f72 Thanos \u975e\u5e38\u7c7b\u4f3c\uff0c\u73b0\u5728\u76f8\u5f53\u4e8e\u6211\u4eec\u5c06 Prometheus \u7684\u6570\u636e\u8f93\u51fa\u5230\u4e86\u8fdc\u7a0b\u5bf9\u8c61\u5b58\u50a8\u4e0a\u9762\u53bb\u4e86\uff0c\u4f46\u662f\u8fd9\u8fd8\u53ea\u662f\u7b2c\u4e00\u6b65\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u90e8\u7f72\u5176\u4ed6\u7684 Thanos \u7ec4\u4ef6\uff0c\u6bd4\u5982 Querier\u3001Store\u3001Compactor \u7b49\uff0c\u8fd9\u4e9b\u5185\u5bb9\u5176\u5b9e\u524d\u9762\u7ae0\u8282\u6211\u4eec\u5df2\u7ecf\u8be6\u7ec6\u8bb2\u89e3\u8fc7\u4e86\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u4e0d\u518d\u8d58\u8ff0\u4e86\u3002</p> <p>\u6700\u540e\u6211\u4eec\u67e5\u770b\u4e0b\u9762\u6211\u4eec\u7684 prometheus \u7684 CRD \u5bf9\u8c61\u7684\u5b8c\u6574\u914d\u7f6e\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  labels:\n    prometheus: k8s\n  name: k8s\n  namespace: monitoring\nspec:\n  alerting:\n    alertmanagers:\n    - name: alertmanager-main\n      namespace: monitoring\n      port: web\n  image: quay.io/prometheus/prometheus:v2\n  nodeSelector:\n    kubernetes.io/os: linux\n  podMonitorNamespaceSelector: {}\n  podMonitorSelector: {}\n  replicas: 2\n  retention: 6h  # \u672c\u5730\u53ea\u4fdd\u75596h\u5c0f\u65f6\u7684\u6570\u636e\n  resources:\n    requests:\n      memory: 400Mi\n  ruleSelector:\n    matchLabels:\n      prometheus: k8s\n      role: alert-rules\n  securityContext:\n    fsGroup: 2000\n    runAsNonRoot: true\n    runAsUser: 1000\n  serviceAccountName: prometheus-k8s\n  serviceMonitorNamespaceSelector: {}\n  serviceMonitorSelector: {}\n  version: v2\n  additionalScrapeConfigs:  # \u6dfb\u52a0\u670d\u52a1\u53d1\u73b0\u7684\u914d\u7f6e\n    name: additional-configs\n    key: prometheus-additional.yaml\n  storage:  # \u6dfb\u52a0\u672c\u5730\u6570\u636e\u6301\u4e45\u5316\n    volumeClaimTemplate:\n      spec:\n        storageClassName: rook-ceph-block\n        resources:\n          requests:\n            storage: 20Gi\n  thanos:  #  \u6dfb\u52a0 thanos \u914d\u7f6e\n    objectStorageConfig: \n      key: thanos.yaml\n      name: thanos-objectstorage  # \u5bf9\u8c61\u5b58\u50a8\u5bf9\u5e94\u7684 secret \u8d44\u6e90\u5bf9\u8c61\n</code></pre> <p>\u5f53\u7136\u5982\u679c\u6700\u540e\u914d\u7f6e\u4e86 Thanos\uff0c\u90a3\u4e48 Grafana \u7684\u6570\u636e\u6e90\u4e5f\u9700\u8981\u66f4\u6539\u6210 Querier \u7ec4\u4ef6\u7684\u5730\u5740\uff0c\u5426\u5219\u5c31\u53ea\u662f\u672c\u5730\u7684\u6570\u636e\u3002</p>"},{"location":"kubernetes_monitor/operator/custom/","title":"\u81ea\u5b9a\u4e49\u76d1\u63a7\u62a5\u8b66","text":""},{"location":"kubernetes_monitor/operator/custom/#_1","title":"\u81ea\u5b9a\u4e49\u76d1\u63a7\u62a5\u8b66","text":"<p>\u4e0a\u8282\u8bfe\u548c\u5927\u5bb6\u8bb2\u89e3\u4e86 Prometheus Operator \u7684\u5b89\u88c5\u548c\u57fa\u672c\u4f7f\u7528\u65b9\u6cd5\uff0c\u8fd9\u8282\u8bfe\u7ed9\u5927\u5bb6\u4ecb\u7ecd\u5982\u4f55\u5728 <code>Prometheus Operator</code> \u4e2d\u6dfb\u52a0\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7\u9879\u3002</p> <p>\u9664\u4e86 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u4e00\u4e9b\u8d44\u6e90\u5bf9\u8c61\u3001\u8282\u70b9\u4ee5\u53ca\u7ec4\u4ef6\u9700\u8981\u76d1\u63a7\uff0c\u6709\u7684\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u8fd8\u9700\u8981\u6839\u636e\u5b9e\u9645\u7684\u4e1a\u52a1\u9700\u6c42\u53bb\u6dfb\u52a0\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7\u9879\uff0c\u6dfb\u52a0\u4e00\u4e2a\u81ea\u5b9a\u4e49\u76d1\u63a7\u7684\u6b65\u9aa4\u4e5f\u662f\u975e\u5e38\u7b80\u5355\u7684\u3002</p> <ul> <li>\u7b2c\u4e00\u6b65\u5efa\u7acb\u4e00\u4e2a ServiceMonitor \u5bf9\u8c61\uff0c\u7528\u4e8e Prometheus \u6dfb\u52a0\u76d1\u63a7\u9879</li> <li>\u7b2c\u4e8c\u6b65\u4e3a ServiceMonitor \u5bf9\u8c61\u5173\u8054 metrics \u6570\u636e\u63a5\u53e3\u7684\u4e00\u4e2a Service \u5bf9\u8c61</li> <li>\u7b2c\u4e09\u6b65\u786e\u4fdd Service \u5bf9\u8c61\u53ef\u4ee5\u6b63\u786e\u83b7\u53d6\u5230 metrics \u6570\u636e</li> </ul> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u4e3a\u5927\u5bb6\u6f14\u793a\u5982\u4f55\u6dfb\u52a0 <code>etcd</code> \u96c6\u7fa4\u7684\u76d1\u63a7\u3002\u65e0\u8bba\u662f Kubernetes \u96c6\u7fa4\u5916\u7684\u8fd8\u662f\u4f7f\u7528 Kubeadm \u5b89\u88c5\u5728\u96c6\u7fa4\u5185\u90e8\u7684 etcd \u96c6\u7fa4\uff0c\u6211\u4eec\u8fd9\u91cc\u90fd\u5c06\u5176\u89c6\u4f5c\u96c6\u7fa4\u5916\u7684\u72ec\u7acb\u96c6\u7fa4\uff0c\u56e0\u4e3a\u5bf9\u4e8e\u4e8c\u8005\u7684\u4f7f\u7528\u65b9\u6cd5\u6ca1\u4ec0\u4e48\u7279\u6b8a\u4e4b\u5904\u3002</p>"},{"location":"kubernetes_monitor/operator/custom/#etcd","title":"etcd \u76d1\u63a7","text":"<p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u6f14\u793a\u73af\u5883\u4f7f\u7528\u7684\u662f Kubeadm \u642d\u5efa\u7684\u96c6\u7fa4\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 kubectl \u5de5\u5177\u53bb\u83b7\u53d6 etcd \u542f\u52a8\u7684\u76f8\u5173\u53c2\u6570\uff1a</p> <pre><code>$ kubectl get pods -n kube-system -l component=etcd\nNAME               READY   STATUS    RESTARTS   AGE\netcd-ydzs-master   1/1     Running   3          157d\n$ kubectl get pods etcd-ydzs-master -n kube-system -o yaml\n......\nspec:\n  containers:\n  - command:\n    - etcd\n    - --advertise-client-urls=https://111:2379\n    - --cert-file=/etc/kubernetes/pki/etcd/server.crt\n    - --client-cert-auth=true\n    - --data-dir=/var/lib/etcd\n    - --initial-advertise-peer-urls=https://111:2380\n    - --initial-cluster=ydzs-master=https://111:2380\n    - --key-file=/etc/kubernetes/pki/etcd/server.key\n    - --listen-client-urls=https://11:2379,https://111:2379\n    - --listen-metrics-urls=http://11:2381\n    - --listen-peer-urls=https://111:2380\n    - --name=ydzs-master\n    - --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt\n    - --peer-client-cert-auth=true\n    - --peer-key-file=/etc/kubernetes/pki/etcd/peer.key\n    - --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt\n    - --snapshot-count=10000\n    - --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt\n......\n    volumeMounts:\n    - mountPath: /var/lib/etcd\n      name: etcd-data\n    - mountPath: /etc/kubernetes/pki/etcd\n      name: etcd-certs\n......\n  volumes:\n  - hostPath:\n      path: /etc/kubernetes/pki/etcd\n      type: DirectoryOrCreate\n    name: etcd-certs\n  - hostPath:\n      path: /var/lib/etcd\n      type: DirectoryOrCreate\n    name: etcd-data\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u542f\u52a8\u53c2\u6570\u91cc\u9762\u6709\u4e00\u4e2a </p> <pre><code>--listen-metrics-urls=http://11:2381\n</code></pre> <p>\u7684\u914d\u7f6e\uff0c\u8be5\u53c2\u6570\u5c31\u662f\u6765\u6307\u5b9a metrics \u63a5\u53e3\u8fd0\u884c\u5728 2381 \u7aef\u53e3\u4e0b\u9762\u7684\uff0c\u800c\u4e14\u662f http \u7684\u534f\u8bae\uff0c\u6240\u4ee5\u4e5f\u4e0d\u9700\u8981\u4ec0\u4e48\u8bc1\u4e66\u914d\u7f6e\uff0c\u8fd9\u5c31\u6bd4\u4ee5\u524d\u7684\u7248\u672c\u8981\u7b80\u5355\u8bb8\u591a\u4e86\uff0c\u4ee5\u524d\u7684\u7248\u672c\u9700\u8981\u7528 https \u534f\u8bae\u8bbf\u95ee\uff0c\u6240\u4ee5\u8981\u914d\u7f6e\u5bf9\u5e94\u7684\u8bc1\u4e66\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u76f4\u63a5\u521b\u5efa\u5bf9\u5e94\u7684 ServiceMonitor \u5bf9\u8c61\u5373\u53ef\uff08prometheus-serviceMonitorEtcd.yaml\uff09:</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: etcd-k8s\n  namespace: monitoring\n  labels:\n    k8s-app: etcd-k8s\nspec:\n  jobLabel: k8s-app\n  endpoints:\n  - port: port\n    interval: 15s\n  selector:\n    matchLabels:\n      k8s-app: etcd\n  namespaceSelector:\n    matchNames:\n    - kube-system\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u5728 monitoring \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u521b\u5efa\u4e86\u540d\u4e3a etcd-k8s \u7684 ServiceMonitor \u5bf9\u8c61\uff0c\u57fa\u672c\u5c5e\u6027\u548c\u524d\u9762\u7ae0\u8282\u4e2d\u7684\u4e00\u81f4\uff0c\u5339\u914d kube-system \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u5177\u6709 <code>k8s-app=etcd</code> \u8fd9\u4e2a label \u6807\u7b7e\u7684 Service\uff0c<code>jobLabel</code> \u8868\u793a\u7528\u4e8e\u68c0\u7d22 job \u4efb\u52a1\u540d\u79f0\u7684\u6807\u7b7e\uff0c\u7531\u4e8e etcd \u7684 metrics \u63a5\u53e3\u5728 2381 \u7aef\u53e3\u4e0b\u9762\uff0c\u4e0d\u9700\u8981 https \u5b89\u5168\u8ba4\u8bc1\uff0c\u6240\u4ee5\u7528\u9ed8\u8ba4\u7684\u914d\u7f6e\u5373\u53ef\u3002\u5173\u4e8e ServiceMonitor \u66f4\u591a\u7684\u914d\u7f6e\u5c5e\u6027\uff0c\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u7684 API \u6587\u6863\u7684\u63cf\u8ff0\u3002</p> <p>\u7136\u540e\u6211\u4eec\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a ServiceMonitor \u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f prometheus-serviceMonitorEtcd.yaml\nservicemonitor.monitoring.coreos.com \"etcd-k8s\" created\n</code></pre> <p>\u4f46\u5b9e\u9645\u4e0a\u73b0\u5728\u5e76\u4e0d\u80fd\u76d1\u63a7\u5230 etcd \u96c6\u7fa4\uff0c\u56e0\u4e3a\u5e76\u6ca1\u6709\u4e00\u4e2a\u6ee1\u8db3 ServiceMonitor \u6761\u4ef6\u7684 Service \u5bf9\u8c61\u4e0e\u4e4b\u5173\u8054\uff1a</p> <pre><code>$ kubectl get svc -n kube-system -l k8s-app=etcd\nNo resources found.\n</code></pre> <p>\u6240\u4ee5\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u6ee1\u8db3\u4e0a\u9762\u6761\u4ef6\u7684 Service \u5bf9\u8c61\uff0c\u7531\u4e8e\u6211\u4eec\u628a etcd \u5f53\u6210\u662f\u96c6\u7fa4\u5916\u90e8\u7684\u670d\u52a1\uff0c\u6240\u4ee5\u8981\u5f15\u5165\u5230\u96c6\u7fa4\u4e2d\u6765\u6211\u4eec\u5c31\u9700\u8981\u81ea\u5b9a\u4e49 Endpoints \u5bf9\u8c61\u6765\u521b\u5efa Service \u5bf9\u8c61\u4e86\uff1a(etcd-service.yaml)</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: etcd-k8s\n  namespace: kube-system\n  labels:\n    k8s-app: etcd\nspec:\n  type: ClusterIP\n  clusterIP: None  # \u4e00\u5b9a\u8981\u8bbe\u7f6e clusterIP:None\n  ports:\n  - name: port\n    port: 2381\n---\napiVersion: v1\nkind: Endpoints\nmetadata:\n  name: etcd-k8s\n  namespace: kube-system\n  labels:\n    k8s-app: etcd\nsubsets:\n- addresses:\n  - ip: 111  # \u6307\u5b9aetcd\u8282\u70b9\u5730\u5740\uff0c\u5982\u679c\u662f\u96c6\u7fa4\u5219\u7ee7\u7eed\u5411\u4e0b\u6dfb\u52a0\n    nodeName: etc-master\n  ports:\n  - name: port\n    port: 2381\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u7684 Service \u6ca1\u6709\u91c7\u7528\u524d\u9762\u901a\u8fc7 label \u6807\u7b7e\u7684\u5f62\u5f0f\u53bb\u5339\u914d Pod \u7684\u505a\u6cd5\uff0c\u56e0\u4e3a\u524d\u9762\u6211\u4eec\u8bf4\u8fc7\u5f88\u591a\u65f6\u5019\u6211\u4eec\u521b\u5efa\u7684 etcd \u96c6\u7fa4\u662f\u72ec\u7acb\u4e8e\u96c6\u7fa4\u4e4b\u5916\u7684\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u9762\u6211\u4eec\u5c31\u9700\u8981\u81ea\u5b9a\u4e49\u4e00\u4e2a Endpoints\uff0c\u8981\u6ce8\u610f <code>metadata</code> \u533a\u57df\u7684\u5185\u5bb9\u8981\u548c Service \u4fdd\u6301\u4e00\u81f4\uff0cService \u7684 clusterIP \u8bbe\u7f6e\u4e3a None\uff0c\u65b0\u7248\u672c\u7684 etcd \u5c06 metrics \u63a5\u53e3\u6570\u636e\u653e\u7f6e\u5230\u4e86 2381 \u7aef\u53e3\u3002\u76f4\u63a5\u521b\u5efa\u8be5\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f etcd-service.yaml\nservice/etcd-k8s configured\nendpoints/etcd-k8s configured\n$ kubectl get svc -n kube-system -l k8s-app=etcd\nNAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE\netcd-k8s   ClusterIP   None         &lt;none&gt;        2381/TCP   128d\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u9694\u4e00\u4f1a\u513f\u53bb Prometheus \u7684 Dashboard \u4e2d\u67e5\u770b targets\uff0c\u4fbf\u4f1a\u6709 etcd \u7684\u76d1\u63a7\u9879\u4e86\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a\u660e\u663e\u7684\u9519\u8bef\uff0c2381 \u7aef\u53e3\u94fe\u63a5\u88ab\u62d2\u7edd\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u7684 etcd \u7684 metrics \u63a5\u53e3\u662f\u76d1\u542c\u5728 <code>127.0.0.1</code> \u8fd9\u4e2a IP \u4e0a\u9762\u7684\uff0c\u6240\u4ee5\u8bbf\u95ee\u4f1a\u62d2\u7edd\uff1a</p> <pre><code>--listen-metrics-urls=http://11:2381\n</code></pre> <p>\u6211\u4eec\u53ea\u9700\u8981\u5728 </p> <pre><code>/etc/kubernetes/manifest/\n</code></pre> <p>\u76ee\u5f55\u4e0b\u9762\uff08\u9759\u6001 Pod \u9ed8\u8ba4\u7684\u76ee\u5f55\uff09\u7684 <code>etcd.yaml</code> \u6587\u4ef6\u4e2d\u5c06\u4e0a\u9762\u7684<code>listen-metrics-urls</code> \u66f4\u6539\u6210\u8282\u70b9 IP \u5373\u53ef\uff1a</p> <pre><code>--listen-metrics-urls=http://0:2381\n</code></pre> <p>\u5f53 etcd \u91cd\u542f\u751f\u6548\u540e\uff0c\u67e5\u770b etcd \u8fd9\u4e2a\u76d1\u63a7\u4efb\u52a1\u5c31\u6b63\u5e38\u4e86\uff1a</p> <p></p> <p>\u6570\u636e\u91c7\u96c6\u5230\u540e\uff0c\u53ef\u4ee5\u5728 grafana \u4e2d\u5bfc\u5165\u7f16\u53f7\u4e3a <code>3070</code> \u7684 dashboard\uff0c\u5c31\u53ef\u4ee5\u83b7\u53d6\u5230 etcd \u7684\u76d1\u63a7\u56fe\u8868\uff1a</p> <p></p>"},{"location":"kubernetes_monitor/operator/custom/#prometheusrule","title":"\u914d\u7f6e PrometheusRule","text":"<p>\u73b0\u5728\u6211\u4eec\u77e5\u9053\u600e\u4e48\u81ea\u5b9a\u4e49\u4e00\u4e2a <code>ServiceMonitor</code> \u5bf9\u8c61\u4e86\uff0c\u4f46\u662f\u5982\u679c\u9700\u8981\u81ea\u5b9a\u4e49\u4e00\u4e2a\u62a5\u8b66\u89c4\u5219\u7684\u8bdd\u5462\uff1f\u6211\u4eec\u53bb\u67e5\u770b Prometheus Dashboard \u7684 Alert \u9875\u9762\u4e0b\u9762\u5c31\u5df2\u7ecf\u6709\u5f88\u591a\u62a5\u8b66\u89c4\u5219\u4e86\uff0c\u8fd9\u4e00\u7cfb\u5217\u7684\u89c4\u5219\u5176\u5b9e\u90fd\u6765\u81ea\u4e8e\u9879\u76ee https://github.com/kubernetes-monitoring/kubernetes-mixin\uff0c\u6211\u4eec\u90fd\u901a\u8fc7 Prometheus Operator \u5b89\u88c5\u914d\u7f6e\u4e0a\u4e86\u3002</p> <p>\u4f46\u662f\u8fd9\u4e9b\u62a5\u8b66\u4fe1\u606f\u662f\u54ea\u91cc\u6765\u7684\u5462\uff1f\u4ed6\u4eec\u5e94\u8be5\u7528\u600e\u6837\u7684\u65b9\u5f0f\u901a\u77e5\u6211\u4eec\u5462\uff1f\u6211\u4eec\u77e5\u9053\u4e4b\u524d\u6211\u4eec\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u65b9\u5f0f\u53ef\u4ee5\u5728 Prometheus \u7684\u914d\u7f6e\u6587\u4ef6\u4e4b\u4e2d\u6307\u5b9a AlertManager \u5b9e\u4f8b\u548c \u62a5\u8b66\u7684 rules \u6587\u4ef6\uff0c\u73b0\u5728\u6211\u4eec\u901a\u8fc7 Operator \u90e8\u7f72\u7684\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u5728 Prometheus Dashboard \u7684 Config \u9875\u9762\u4e0b\u9762\u67e5\u770b\u5173\u4e8e AlertManager \u7684\u914d\u7f6e\uff1a</p> <pre><code>alerting:\n  alert_relabel_configs:\n  - separator: ;\n    regex: prometheus_replica\n    replacement: $1\n    action: labeldrop\n  alertmanagers:\n  - kubernetes_sd_configs:\n    - role: endpoints\n      namespaces:\n        names:\n        - monitoring\n    scheme: http\n    path_prefix: /\n    timeout: 10s\n    api_version: v1\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_service_name]\n      separator: ;\n      regex: alertmanager-main\n      replacement: $1\n      action: keep\n    - source_labels: [__meta_kubernetes_endpoint_port_name]\n      separator: ;\n      regex: web\n      replacement: $1\n      action: keep\nrule_files:\n- /etc/prometheus/rules/prometheus-k8s-rulefiles-0/*.yaml\n</code></pre> <p>\u4e0a\u9762 <code>alertmanagers</code> \u7684\u914d\u7f6e\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u662f\u901a\u8fc7 role \u4e3a <code>endpoints</code> \u7684 kubernetes \u7684\u81ea\u52a8\u53d1\u73b0\u673a\u5236\u83b7\u53d6\u7684\uff0c\u5339\u914d\u7684\u662f\u670d\u52a1\u540d\u4e3a <code>alertmanager-main</code>\uff0c\u7aef\u53e3\u540d\u4e3a web \u7684 Service \u670d\u52a1\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e0b alertmanager-main \u8fd9\u4e2a Service\uff1a</p> <pre><code>$ kubectl describe svc alertmanager-main -n monitoring\nName:                     alertmanager-main\nNamespace:                monitoring\nLabels:                   alertmanager=main\nAnnotations:              kubectl.kubernetes.io/last-applied-configuration:\n                            {\"apiVersion\":\"v1\",\"kind\":\"Service\",\"metadata\":{\"annotations\":{},\"labels\":{\"alertmanager\":\"main\"},\"name\":\"alertmanager-main\",\"namespace\":\"...\nSelector:                 alertmanager=main,app=alertmanager\nType:                     NodePort\nIP:                       1233\nPort:                     web  9093/TCP\nTargetPort:               web/TCP\nNodePort:                 web  31742/TCP\nEndpoints:                2119:9093,2112:9093,2164:9093\nSession Affinity:         ClientIP\nExternal Traffic Policy:  Cluster\nEvents:                   &lt;none&gt;\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u670d\u52a1\u540d\u6b63\u662f <code>alertmanager-main</code>\uff0cPort \u5b9a\u4e49\u7684\u540d\u79f0\u4e5f\u662f <code>web</code>\uff0c\u7b26\u5408\u4e0a\u9762\u7684\u89c4\u5219\uff0c\u6240\u4ee5 Prometheus \u548c AlertManager \u7ec4\u4ef6\u5c31\u6b63\u786e\u5173\u8054\u4e0a\u4e86\u3002\u800c\u5bf9\u5e94\u7684\u62a5\u8b66\u89c4\u5219\u6587\u4ef6\u4f4d\u4e8e\uff1a</p> <pre><code>/etc/prometheus/rules/prometheus-k8s-rulefiles-0/\n</code></pre> <p>\u76ee\u5f55\u4e0b\u9762\u6240\u6709\u7684 YAML \u6587\u4ef6\u3002\u6211\u4eec\u53ef\u4ee5\u8fdb\u5165 Prometheus \u7684 Pod \u4e2d\u9a8c\u8bc1\u4e0b\u8be5\u76ee\u5f55\u4e0b\u9762\u662f\u5426\u6709 YAML \u6587\u4ef6\uff1a</p> <pre><code>$ kubectl exec -it prometheus-k8s-0 /bin/sh -n monitoring\nDefaulting container name to prometheus.\nUse 'kubectl describe pod/prometheus-k8s-0 -n monitoring' to see all of the containers in this pod.\n/prometheus $ ls /etc/prometheus/rules/prometheus-k8s-rulefiles-0/\nmonitoring-prometheus-k8s-rules.yaml\n/prometheus $ cat /etc/prometheus/rules/prometheus-k8s-rulefiles-0/monitoring-pr\nometheus-k8s-rules.yaml\ngroups:\n- name: k8s.rules\n  rules:\n  - expr: |\n      sum(rate(container_cpu_usage_seconds_total{job=\"kubelet\", image!=\"\", container_name!=\"\"}[5m])) by (namespace)\n    record: namespace:container_cpu_usage_seconds_total:sum_rate\n......\n</code></pre> <p>\u8fd9\u4e2a YAML \u6587\u4ef6\u5b9e\u9645\u4e0a\u5c31\u662f\u6211\u4eec\u4e4b\u524d\u521b\u5efa\u7684\u4e00\u4e2a <code>PrometheusRule</code> \u6587\u4ef6\u5305\u542b\u7684\u5185\u5bb9\uff1a</p> <pre><code>$ cat prometheus-rules.yaml\napiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: k8s\n    role: alert-rules\n  name: prometheus-k8s-rules\n  namespace: monitoring\nspec:\n  groups:\n  - name: node-exporter.rules\n    rules:\n    - expr: |\n        count without (cpu) (\n          count without (mode) (\n            node_cpu_seconds_total{job=\"node-exporter\"}\n          )\n        )\n      record: instance:node_num_cpu:sum\n    - expr: |\n......\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u7684 <code>PrometheusRule</code> \u7684 name \u4e3a <code>prometheus-k8s-rules</code>\uff0cnamespace \u4e3a <code>monitoring</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u731c\u60f3\u5230\u6211\u4eec\u521b\u5efa\u4e00\u4e2a PrometheusRule \u8d44\u6e90\u5bf9\u8c61\u540e\uff0c\u4f1a\u81ea\u52a8\u5728\u4e0a\u9762\u7684 </p> <pre><code>prometheus-k8s-rulefiles-0\n</code></pre> <p>\u76ee\u5f55\u4e0b\u9762\u751f\u6210\u4e00\u4e2a\u5bf9\u5e94\u7684 </p> <pre><code>&lt;namespace&gt;-&lt;name&gt;.yaml\n</code></pre> <p>\u6587\u4ef6\uff0c\u6240\u4ee5\u5982\u679c\u4ee5\u540e\u6211\u4eec\u9700\u8981\u81ea\u5b9a\u4e49\u4e00\u4e2a\u62a5\u8b66\u9009\u9879\u7684\u8bdd\uff0c\u53ea\u9700\u8981\u5b9a\u4e49\u4e00\u4e2a <code>PrometheusRule</code> \u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\u3002\u81f3\u4e8e\u4e3a\u4ec0\u4e48 Prometheus \u80fd\u591f\u8bc6\u522b\u8fd9\u4e2a PrometheusRule \u8d44\u6e90\u5bf9\u8c61\u5462\uff1f\u8fd9\u5c31\u9700\u8981\u67e5\u770b\u6211\u4eec\u521b\u5efa\u7684 prometheus \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u4e86\uff0c\u91cc\u9762\u6709\u975e\u5e38\u91cd\u8981\u7684\u4e00\u4e2a\u5c5e\u6027 <code>ruleSelector</code>\uff0c\u7528\u6765\u5339\u914d rule \u89c4\u5219\u7684\u8fc7\u6ee4\u5668\uff0c\u8981\u6c42\u5339\u914d\u5177\u6709 <code>prometheus=k8s</code> \u548c <code>role=alert-rules</code> \u6807\u7b7e\u7684 <code>PrometheusRule</code> \u8d44\u6e90\u5bf9\u8c61\uff0c\u73b0\u5728\u660e\u767d\u4e86\u5427\uff1f</p> <pre><code>ruleSelector:\n  matchLabels:\n    prometheus: k8s\n    role: alert-rules\n</code></pre> <p>\u6240\u4ee5\u6211\u4eec\u8981\u60f3\u81ea\u5b9a\u4e49\u4e00\u4e2a\u62a5\u8b66\u89c4\u5219\uff0c\u53ea\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5177\u6709 <code>prometheus=k8s</code> \u548c <code>role=alert-rules</code> \u6807\u7b7e\u7684 <code>PrometheusRule</code> \u5bf9\u8c61\u5c31\u884c\u4e86\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6dfb\u52a0\u4e00\u4e2a etcd \u662f\u5426\u53ef\u7528\u7684\u62a5\u8b66\uff0c\u6211\u4eec\u77e5\u9053 etcd \u6574\u4e2a\u96c6\u7fa4\u6709\u4e00\u534a\u4ee5\u4e0a\u7684\u8282\u70b9\u53ef\u7528\u7684\u8bdd\u96c6\u7fa4\u5c31\u662f\u53ef\u7528\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5224\u65ad\u5982\u679c\u4e0d\u53ef\u7528\u7684 etcd \u6570\u91cf\u8d85\u8fc7\u4e86\u4e00\u534a\u90a3\u4e48\u5c31\u89e6\u53d1\u62a5\u8b66\uff0c\u521b\u5efa\u6587\u4ef6 </p> <pre><code>prometheus-etcdRules.yaml\n</code></pre> <p>\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: k8s\n    role: alert-rules\n  name: etcd-rules\n  namespace: monitoring\nspec:\n  groups:\n  - name: etcd\n    rules:\n    - alert: EtcdClusterUnavailable\n      annotations:\n        summary: etcd cluster small\n        description: If one more etcd peer goes down the cluster will be unavailable\n      expr: |\n        count(up{job=\"etcd\"} == 0) &gt; (count(up{job=\"etcd\"}) / 2 - 1)\n      for: 3m\n      labels:\n        severity: critical\n</code></pre> <p>\u6ce8\u610f label \u6807\u7b7e\u4e00\u5b9a\u81f3\u5c11\u8981\u6709 <code>prometheus=k8s</code> \u548c <code>role=alert-rules</code>\uff0c\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u9694\u4e00\u4f1a\u513f\u518d\u53bb\u5bb9\u5668\u4e2d\u67e5\u770b\u4e0b rules \u6587\u4ef6\u5939\uff1a</p> <pre><code>$ kubectl apply -f prometheus-etcdRules.yaml\nprometheusrule.monitoring.coreos.com/etcd-rules created\n$ kubectl exec -it prometheus-k8s-0 /bin/sh -n monitoring\nDefaulting container name to prometheus.\nUse 'kubectl describe pod/prometheus-k8s-0 -n monitoring' to see all of the containers in this pod.\n/prometheus $ ls /etc/prometheus/rules/prometheus-k8s-rulefiles-0/\nmonitoring-etcd-rules.yaml            monitoring-prometheus-k8s-rules.yaml\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u521b\u5efa\u7684 rule \u6587\u4ef6\u5df2\u7ecf\u88ab\u6ce8\u5165\u5230\u4e86\u5bf9\u5e94\u7684 <code>rulefiles</code> \u6587\u4ef6\u5939\u4e0b\u9762\u4e86\uff0c\u8bc1\u660e\u6211\u4eec\u4e0a\u9762\u7684\u8bbe\u60f3\u662f\u6b63\u786e\u7684\u3002\u7136\u540e\u518d\u53bb Prometheus Dashboard \u7684 Alert \u9875\u9762\u4e0b\u9762\u5c31\u53ef\u4ee5\u67e5\u770b\u5230\u4e0a\u9762\u6211\u4eec\u65b0\u5efa\u7684\u62a5\u8b66\u89c4\u5219\u4e86\uff1a</p> <p></p>"},{"location":"kubernetes_monitor/operator/custom/#_2","title":"\u914d\u7f6e\u62a5\u8b66","text":"<p>\u6211\u4eec\u77e5\u9053\u4e86\u5982\u4f55\u53bb\u6dfb\u52a0\u4e00\u4e2a\u62a5\u8b66\u89c4\u5219\u914d\u7f6e\u9879\uff0c\u4f46\u662f\u8fd9\u4e9b\u62a5\u8b66\u4fe1\u606f\u7528\u600e\u6837\u7684\u65b9\u5f0f\u53bb\u53d1\u9001\u5462\uff1f\u524d\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u77e5\u9053\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 AlertManager \u7684\u914d\u7f6e\u6587\u4ef6\u53bb\u914d\u7f6e\u5404\u79cd\u62a5\u8b66\u63a5\u6536\u5668\uff0c\u73b0\u5728\u6211\u4eec\u662f\u901a\u8fc7 Operator \u63d0\u4f9b\u7684 alertmanager \u8d44\u6e90\u5bf9\u8c61\u521b\u5efa\u7684\u7ec4\u4ef6\uff0c\u5e94\u8be5\u600e\u6837\u53bb\u4fee\u6539\u914d\u7f6e\u5462\uff1f</p> <p>\u9996\u5148\u6211\u4eec\u53bb Alertmanager \u7684\u9875\u9762\u4e0a <code>status</code> \u8def\u5f84\u4e0b\u9762\u67e5\u770b AlertManager \u7684\u914d\u7f6e\u4fe1\u606f:</p> <p></p> <p>\u8fd9\u4e9b\u914d\u7f6e\u4fe1\u606f\u5b9e\u9645\u4e0a\u662f\u6765\u81ea\u4e8e\u524d\u9762\u521b\u5efa\u7684 </p> <pre><code>alertmanager-secret.yaml\n</code></pre> <p>\u6587\u4ef6\uff1a</p> <pre><code>apiVersion: v1\ndata: {}\nkind: Secret\nmetadata:\n  name: alertmanager-main\n  namespace: monitoring\nstringData:\n  alertmanager.yaml: |-\n    \"global\":\n      \"resolve_timeout\": \"5m\"\n    \"inhibit_rules\":\n    - \"equal\":\n      - \"namespace\"\n      - \"alertname\"\n      \"source_match\":\n        \"severity\": \"critical\"\n      \"target_match_re\":\n        \"severity\": \"warning|info\"\n    - \"equal\":\n      - \"namespace\"\n      - \"alertname\"\n      \"source_match\":\n        \"severity\": \"warning\"\n      \"target_match_re\":\n        \"severity\": \"info\"\n    \"receivers\":\n    - \"name\": \"Default\"\n    - \"name\": \"Watchdog\"\n    - \"name\": \"Critical\"\n    \"route\":\n      \"group_by\":\n      - \"namespace\"\n      \"group_interval\": \"5m\"\n      \"group_wait\": \"30s\"\n      \"receiver\": \"Default\"\n      \"repeat_interval\": \"12h\"\n      \"routes\":\n      - \"match\":\n          \"alertname\": \"Watchdog\"\n        \"receiver\": \"Watchdog\"\n      - \"match\":\n          \"severity\": \"critical\"\n        \"receiver\": \"Critical\"\ntype: Opaque\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5185\u5bb9\u548c\u4e0a\u9762\u67e5\u770b\u7684\u914d\u7f6e\u4fe1\u606f\u662f\u4e00\u81f4\u7684\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u60f3\u8981\u6dfb\u52a0\u81ea\u5df1\u7684\u63a5\u6536\u5668\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u66f4\u6539\u8fd9\u4e2a\u6587\u4ef6\uff0c\u6bd4\u5982\u6211\u4eec\u5c06 <code>Critical</code> \u8fd9\u4e2a\u63a5\u6536\u5668\u7684\u62a5\u8b66\u4fe1\u606f\u90fd\u53d1\u9001\u5230\u9489\u9489\u8fdb\u884c\u62a5\u8b66\u3002</p> <p>\u9996\u5148\u5728 monitoring \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u90e8\u7f72\u4e00\u4e2a\u7b80\u5355\u7684\u9489\u9489 webhook \u5904\u7406\u5668\uff0c\u524d\u9762 Alertmanager \u7ae0\u8282\u5df2\u7ecf\u5b66\u4e60\u8fc7\uff0c\u8fd9\u91cc\u5c31\u4e0d\u8d58\u8ff0\u4e86\u3002</p> <p>\u7136\u540e\u4fee\u6539\u62a5\u8b66\u914d\u7f6e\u6587\u4ef6 </p> <pre><code>alertmanager-secret.yaml\n</code></pre> <p>\uff0c\u6211\u4eec\u5c06 <code>Critial</code> \u8fd9\u4e2a\u63a5\u6536\u5668\u914d\u7f6e\u6210\u4e86 webhook\uff0c\u5176\u4ed6\u4fdd\u6301\u4e0d\u53d8\uff1a</p> <pre><code>- \"name\": \"Critical\"\n  \"webhook_configs\":\n  - \"url\": \"http://dingtalk-hook:5000\"\n    \"send_resolved\": true\n\"route\":\n  \"group_by\":\n  - \"namespace\"\n</code></pre> <p>\u4fee\u6539\u5b8c\u6210\u540e\uff0c\u91cd\u65b0\u66f4\u65b0\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code># \u5220\u9664\u7136\u540e\u91cd\u65b0\u521b\u5efa\u76f8\u5f53\u4e8e\u5f3a\u5236\u66f4\u65b0\n$ kubectl delete -f alertmanager-secret.yaml\nsecret \"alertmanager-main\" deleted\n$ kubectl apply -f alertmanager-secret.yaml\nsecret/alertmanager-main configured\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u5f88\u5feb\u6211\u4eec\u5c31\u4f1a\u6536\u5230\u9489\u9489\u7684\u62a5\u8b66\u6d88\u606f\u4e86\uff0c\u800c\u4e14 AlertManager \u9875\u9762\u7684 status \u9875\u9762\u7684\u914d\u7f6e\u4fe1\u606f\u53ef\u4ee5\u770b\u5230\u4e5f\u5df2\u7ecf\u53d8\u6210\u4e0a\u9762\u6211\u4eec\u7684\u914d\u7f6e\u4fe1\u606f\u4e86\uff1a</p> <p></p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86 Prometheus Operator \u7684\u81ea\u5b9a\u4e49\u76d1\u63a7\u548c\u62a5\u8b66\u3002</p>"},{"location":"kubernetes_monitor/operator/install/","title":"\u5b89\u88c5","text":""},{"location":"kubernetes_monitor/operator/install/#_1","title":"\u5b89\u88c5\u914d\u7f6e","text":"<p>\u524d\u9762\u7684\u7ae0\u8282\u4e2d\u6211\u4eec\u5b66\u4e60\u4e86\u7528\u81ea\u5b9a\u4e49\u7684\u65b9\u5f0f\u6765\u5bf9 Kubernetes \u96c6\u7fa4\u8fdb\u884c\u76d1\u63a7\uff0c\u57fa\u672c\u4e0a\u4e5f\u80fd\u591f\u5b8c\u6210\u76d1\u63a7\u62a5\u8b66\u7684\u9700\u6c42\u4e86\u3002\u4f46\u5b9e\u9645\u4e0a\u5bf9\u4e0a Kubernetes \u6765\u8bf4\uff0c\u8fd8\u6709\u66f4\u7b80\u5355\u65b9\u5f0f\u6765\u76d1\u63a7\u62a5\u8b66\uff0c\u90a3\u5c31\u662f Prometheus Operator\u3002Prometheus Operator \u4e3a\u76d1\u63a7 Kubernetes \u8d44\u6e90\u548c Prometheus \u5b9e\u4f8b\u7684\u7ba1\u7406\u63d0\u4f9b\u4e86\u7b80\u5355\u7684\u5b9a\u4e49\uff0c\u7b80\u5316\u5728 Kubernetes \u4e0a\u90e8\u7f72\u3001\u7ba1\u7406\u548c\u8fd0\u884c Prometheus \u548c Alertmanager \u96c6\u7fa4\u3002</p>"},{"location":"kubernetes_monitor/operator/install/#_2","title":"\u4ecb\u7ecd","text":"<p>\u9996\u5148\u6211\u4eec\u5148\u6765\u4e86\u89e3\u4e0b Prometheus-Operator \u7684\u67b6\u6784\u56fe\uff1a</p> <p></p> <p>\u4e0a\u56fe\u662f Prometheus-Operator \u5b98\u65b9\u63d0\u4f9b\u7684\u67b6\u6784\u56fe\uff0c\u5404\u7ec4\u4ef6\u4ee5\u4e0d\u540c\u7684\u65b9\u5f0f\u8fd0\u884c\u5728 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u5176\u4e2d Operator \u662f\u6700\u6838\u5fc3\u7684\u90e8\u5206\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u63a7\u5236\u5668\uff0c\u4ed6\u4f1a\u53bb\u521b\u5efaPrometheus\u3001ServiceMonitor\u3001AlertManager \u4ee5\u53ca PrometheusRule 4\u4e2a CRD \u8d44\u6e90\u5bf9\u8c61\uff0c\u7136\u540e\u4f1a\u4e00\u76f4\u76d1\u63a7\u5e76\u7ef4\u6301\u8fd94\u4e2a\u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u3002</p> <ul> <li><code>Operator</code>\uff1a\u6839\u636e\u81ea\u5b9a\u4e49\u8d44\u6e90\u6765\u90e8\u7f72\u548c\u7ba1\u7406 Prometheus Server\uff0c\u540c\u65f6\u76d1\u63a7\u8fd9\u4e9b\u81ea\u5b9a\u4e49\u8d44\u6e90\u4e8b\u4ef6\u7684\u53d8\u5316\u6765\u505a\u76f8\u5e94\u7684\u5904\u7406\uff0c\u662f\u6574\u4e2a\u7cfb\u7edf\u7684\u63a7\u5236\u4e2d\u5fc3\u3002</li> <li><code>Prometheus</code>\uff1a\u58f0\u660e Prometheus \u8d44\u6e90\u5bf9\u8c61\u671f\u671b\u7684\u72b6\u6001\uff0cOperator \u786e\u4fdd\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u8fd0\u884c\u65f6\u4e00\u76f4\u4e0e\u5b9a\u4e49\u4fdd\u6301\u4e00\u81f4\u3002</li> <li><code>Prometheus Server</code>\uff1aOperator \u6839\u636e\u81ea\u5b9a\u4e49\u8d44\u6e90 Prometheus \u7c7b\u578b\u4e2d\u5b9a\u4e49\u7684\u5185\u5bb9\u800c\u90e8\u7f72\u7684 Prometheus Server \u96c6\u7fa4\uff0c\u8fd9\u4e9b\u81ea\u5b9a\u4e49\u8d44\u6e90\u53ef\u4ee5\u770b\u4f5c\u662f\u7528\u6765\u7ba1\u7406 Prometheus Server \u96c6\u7fa4\u7684 StatefulSets \u8d44\u6e90\u3002</li> <li><code>ServiceMonitor</code>\uff1a\u58f0\u660e\u6307\u5b9a\u76d1\u63a7\u7684\u670d\u52a1\uff0c\u63cf\u8ff0\u4e86\u4e00\u7ec4\u88ab Prometheus \u76d1\u63a7\u7684\u76ee\u6807\u5217\u8868\uff0c\u5c31\u662f exporter \u7684\u62bd\u8c61\uff0c\u7528\u6765\u63d0\u4f9b metrics \u6570\u636e\u63a5\u53e3\u7684\u5de5\u5177\u3002\u8be5\u8d44\u6e90\u901a\u8fc7 Labels \u6765\u9009\u53d6\u5bf9\u5e94\u7684 Service Endpoint\uff0c\u8ba9 Prometheus Server \u901a\u8fc7\u9009\u53d6\u7684 Service \u6765\u83b7\u53d6 Metrics \u4fe1\u606f\u3002</li> <li><code>Service</code>\uff1a\u7b80\u5355\u7684\u8bf4\u5c31\u662f Prometheus \u76d1\u63a7\u7684\u5bf9\u8c61\u3002</li> <li><code>Alertmanager</code>\uff1a\u5b9a\u4e49 AlertManager \u8d44\u6e90\u5bf9\u8c61\u671f\u671b\u7684\u72b6\u6001\uff0cOperator \u786e\u4fdd\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u8fd0\u884c\u65f6\u4e00\u76f4\u4e0e\u5b9a\u4e49\u4fdd\u6301\u4e00\u81f4\u3002</li> </ul> <p>\u8fd9\u6837\u6211\u4eec\u8981\u5728\u96c6\u7fa4\u4e2d\u76d1\u63a7\u4ec0\u4e48\u6570\u636e\uff0c\u5c31\u53d8\u6210\u4e86\u76f4\u63a5\u53bb\u64cd\u4f5c Kubernetes \u96c6\u7fa4\u7684\u8d44\u6e90\u5bf9\u8c61\u4e86\uff0c\u662f\u4e0d\u662f\u65b9\u4fbf\u5f88\u591a\u4e86\u3002</p>"},{"location":"kubernetes_monitor/operator/install/#_3","title":"\u5b89\u88c5","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Helm \u6765\u5feb\u901f\u5b89\u88c5 Prometheus Operator\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7 https://github.com/coreos/kube-prometheus \u9879\u76ee\u6765\u624b\u52a8\u5b89\u88c5\uff0c\u6211\u4eec\u8fd9\u91cc\u91c7\u7528\u624b\u52a8\u5b89\u88c5\u7684\u65b9\u5f0f\u53ef\u4ee5\u53bb\u4e86\u89e3\u66f4\u591a\u7684\u5b9e\u73b0\u7ec6\u8282\u3002</p> <p>\u9996\u5148 clone \u9879\u76ee\u4ee3\u7801\uff1a</p> <pre><code>$ git clone https://github.com/coreos/kube-prometheus.git\n$ cd manifests\n</code></pre> <p>\u8fdb\u5165\u5230 <code>manifests</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u5b89\u88c5 <code>setup</code> \u76ee\u5f55\u4e0b\u9762\u7684 CRD \u548c Operator \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f setup/\n$ kubectl get pods -n monitoring\nNAME                                   READY   STATUS    RESTARTS   AGE\nprometheus-operator-6694b5cb64-z64ns   2/2     Running   0          114s\n$ kubectl get crd |grep coreos\nalertmanagers.monitoring.coreos.com              2020-04-10T07:00:12Z\npodmonitors.monitoring.coreos.com                2020-04-10T07:00:13Z\nprometheuses.monitoring.coreos.com               2020-04-10T07:00:14Z\nprometheusrules.monitoring.coreos.com            2020-04-10T07:00:15Z\nservicemonitors.monitoring.coreos.com            2020-04-10T07:00:16Z\nthanosrulers.monitoring.coreos.com               2020-04-10T07:00:17Z\n</code></pre> <p>\u8fd9\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>monitoring</code> \u7684\u547d\u540d\u7a7a\u95f4\uff0c\u4ee5\u53ca\u76f8\u5173\u7684 CRD \u8d44\u6e90\u5bf9\u8c61\u58f0\u660e\u548c Prometheus Operator \u63a7\u5236\u5668\u3002\u524d\u9762\u7ae0\u8282\u4e2d\u6211\u4eec\u8bb2\u89e3\u8fc7 CRD \u548c Operator \u7684\u4f7f\u7528\uff0c\u5f53\u6211\u4eec\u58f0\u660e\u5b8c CRD \u8fc7\u540e\uff0c\u5c31\u53ef\u4ee5\u6765\u81ea\u5b9a\u4e49\u8d44\u6e90\u6e05\u5355\u4e86\uff0c\u4f46\u662f\u8981\u8ba9\u6211\u4eec\u58f0\u660e\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90\u5bf9\u8c61\u751f\u6548\u5c31\u9700\u8981\u5b89\u88c5\u5bf9\u5e94\u7684 Operator \u63a7\u5236\u5668\uff0c\u8fd9\u91cc\u6211\u4eec\u90fd\u5df2\u7ecf\u5b89\u88c5\u4e86\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u6765\u7528 CRD \u521b\u5efa\u771f\u6b63\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90\u5bf9\u8c61\u4e86\u3002\u5176\u5b9e\u5728 <code>manifests</code> \u76ee\u5f55\u4e0b\u9762\u7684\u5c31\u662f\u6211\u4eec\u8981\u53bb\u521b\u5efa\u7684 Prometheus\u3001Alertmanager \u4ee5\u53ca\u5404\u79cd\u76d1\u63a7\u5bf9\u8c61\u7684\u8d44\u6e90\u6e05\u5355\u3002</p> <p>\u6ca1\u6709\u7279\u6b8a\u7684\u5b9a\u5236\u9700\u6c42\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4e00\u952e\u5b89\u88c5\uff1a</p> <p><code>$ kubectl apply -f .</code></p> <p>\u8fd9\u4f1a\u81ea\u52a8\u5b89\u88c5 node-exporter\u3001kube-state-metrics\u3001grafana\u3001prometheus-adapter \u4ee5\u53ca prometheus \u548c alertmanager \u7ec4\u4ef6\uff0c\u800c\u4e14 prometheus \u548c alertmanager \u8fd8\u662f\u591a\u526f\u672c\u7684\u3002</p> <pre><code>$ kubectl get pods -n monitoring\nNAME                                   READY   STATUS              RESTARTS   AGE\nalertmanager-main-0                    2/2     Running             0          10m\nalertmanager-main-1                    2/2     Running             0          10m\nalertmanager-main-2                    2/2     Running             0          10m\ngrafana-86b55cb79f-jpnmr               1/1     Running             0          9m53s\nkube-state-metrics-dbb85dfd5-hl2sn     3/3     Running             0          9m49s\nnode-exporter-482tf                    2/2     Running             0          95s\nnode-exporter-9g2cv                    2/2     Running             0          9m47s\nnode-exporter-dxr2d                    2/2     Running             0          9m47s\nnode-exporter-h4f6c                    2/2     Running             0          9m47s\nnode-exporter-hxwqb                    2/2     Running             0          9m47s\nnode-exporter-lzdw2                    2/2     Running             0          9m47s\nnode-exporter-n2qj6                    2/2     Running             0          9m47s\nprometheus-adapter-5cd5798d96-4r6lx    1/1     Running             0          9m40s\nprometheus-k8s-0                       3/3     Running             0          9m27s\nprometheus-k8s-1                       3/3     Running             1          9m25s\nprometheus-operator-6694b5cb64-z64ns   2/2     Running             0          18m\n$ kubectl get svc -n monitoring\nNAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE\nalertmanager-main       ClusterIP   1173    &lt;none&gt;        9093/TCP                     12m\nalertmanager-operated   ClusterIP   None             &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP   12m\ngrafana                 ClusterIP   32      &lt;none&gt;        3000/TCP                     11m\nkube-state-metrics      ClusterIP   None             &lt;none&gt;        8443/TCP,9443/TCP            11m\nnode-exporter           ClusterIP   None             &lt;none&gt;        9100/TCP                     11m\nprometheus-adapter      ClusterIP   11211   &lt;none&gt;        443/TCP                      11m\nprometheus-k8s          ClusterIP   11155   &lt;none&gt;        9090/TCP                     11m\nprometheus-operated     ClusterIP   None             &lt;none&gt;        9090/TCP                     11m\nprometheus-operator     ClusterIP   None             &lt;none&gt;        8443/TCP                     20m\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u9488\u5bf9 grafana\u3001alertmanager \u548c prometheus \u90fd\u521b\u5efa\u4e86\u4e00\u4e2a\u7c7b\u578b\u4e3a ClusterIP \u7684 Service\uff0c\u5f53\u7136\u5982\u679c\u6211\u4eec\u60f3\u8981\u5728\u5916\u7f51\u8bbf\u95ee\u8fd9\u4e24\u4e2a\u670d\u52a1\u7684\u8bdd\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u5bf9\u5e94\u7684 Ingress \u5bf9\u8c61\u6216\u8005\u4f7f\u7528 NodePort \u7c7b\u578b\u7684 Service\uff0c\u6211\u4eec\u8fd9\u91cc\u4e3a\u4e86\u7b80\u5355\uff0c\u76f4\u63a5\u4f7f\u7528 NodePort \u7c7b\u578b\u7684\u670d\u52a1\u5373\u53ef\uff0c\u7f16\u8f91 grafana\u3001alertmanager-main \u548c prometheus-k8s \u8fd93\u4e2a Service\uff0c\u5c06\u670d\u52a1\u7c7b\u578b\u66f4\u6539\u4e3a NodePort:</p> <pre><code># \u5c06 type: ClusterIP \u66f4\u6539\u4e3a type: NodePort\n$ kubectl edit svc grafana -n monitoring  \n$ kubectl edit svc alertmanager-main -n monitoring\n$ kubectl edit svc prometheus-k8s -n monitoring\n$ kubectl get svc -n monitoring\nNAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE\nalertmanager-main       NodePort    1173    &lt;none&gt;        9093:30733/TCP               18m\ngrafana                 NodePort    32      &lt;none&gt;        3000:32150/TCP               17m\nprometheus-k8s          NodePort    11155   &lt;none&gt;        9090:30206/TCP               17m\n......\n</code></pre> <p>\u66f4\u6539\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u7684 NodePort \u53bb\u8bbf\u95ee\u5bf9\u5e94\u7684\u670d\u52a1\u4e86\uff0c\u6bd4\u5982\u67e5\u770b prometheus \u7684\u670d\u52a1\u53d1\u73b0\u9875\u9762\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u76d1\u63a7\u4e0a\u4e86\u5f88\u591a\u6307\u6807\u6570\u636e\u4e86\uff0c\u4e0a\u9762\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Prometheus \u662f\u4e24\u4e2a\u526f\u672c\uff0c\u6211\u4eec\u8fd9\u91cc\u901a\u8fc7 Service \u53bb\u8bbf\u95ee\uff0c\u6309\u6b63\u5e38\u6765\u8bf4\u8bf7\u6c42\u662f\u4f1a\u53bb\u8f6e\u8be2\u8bbf\u95ee\u540e\u7aef\u7684\u4e24\u4e2a Prometheus \u5b9e\u4f8b\u7684\uff0c\u4f46\u5b9e\u9645\u4e0a\u6211\u4eec\u8fd9\u91cc\u8bbf\u95ee\u7684\u65f6\u5019\u59cb\u7ec8\u662f\u8def\u7531\u5230\u540e\u7aef\u7684\u4e00\u4e2a\u5b9e\u4f8b\u4e0a\u53bb\uff0c\u56e0\u4e3a\u8fd9\u91cc\u7684 Service \u5728\u521b\u5efa\u7684\u65f6\u5019\u6dfb\u52a0\u4e86 </p> <pre><code>sessionAffinity: ClientIP\n</code></pre> <p>\u8fd9\u6837\u7684\u5c5e\u6027\uff0c\u4f1a\u6839\u636e <code>ClientIP</code> \u6765\u505a session \u4eb2\u548c\u6027\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u7528\u62c5\u5fc3\u8bf7\u6c42\u4f1a\u5230\u4e0d\u540c\u7684\u526f\u672c\u4e0a\u53bb\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    prometheus: k8s\n  name: prometheus-k8s\n  namespace: monitoring\nspec:\n  ports:\n  - name: web\n    port: 9090\n    targetPort: web\n  selector:\n    app: prometheus\n    prometheus: k8s\n  sessionAffinity: ClientIP\n</code></pre>"},{"location":"kubernetes_monitor/operator/install/#_4","title":"\u914d\u7f6e","text":"<p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u76d1\u63a7\u6307\u6807\u5927\u90e8\u5206\u7684\u914d\u7f6e\u90fd\u662f\u6b63\u5e38\u7684\uff0c\u53ea\u6709\u4e24\u4e09\u4e2a\u6ca1\u6709\u7ba1\u7406\u5230\u5bf9\u5e94\u7684\u76d1\u63a7\u76ee\u6807\uff0c\u6bd4\u5982 </p> <pre><code>kube-controller-manager\n</code></pre> <p>\u548c <code>kube-scheduler</code> \u8fd9\u4e24\u4e2a\u7cfb\u7edf\u7ec4\u4ef6\u3002</p> <p></p> <p>\u8fd9\u5176\u5b9e\u5c31\u548c <code>ServiceMonitor</code> \u7684\u5b9a\u4e49\u6709\u5173\u7cfb\u4e86\uff0c\u6211\u4eec\u5148\u6765\u67e5\u770b\u4e0b kube-scheduler \u7ec4\u4ef6\u5bf9\u5e94\u7684 ServiceMonitor \u8d44\u6e90\u7684\u5b9a\u4e49\uff0c</p> <pre><code>manifests/prometheus-serviceMonitorKubeScheduler.yaml\n</code></pre> <p>\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  labels:\n    k8s-app: kube-scheduler\n  name: kube-scheduler\n  namespace: monitoring\nspec:\n  endpoints:\n  - interval: 30s  # \u6bcf30s\u83b7\u53d6\u4e00\u6b21\u4fe1\u606f\n    port: http-metrics  # \u5bf9\u5e94 service \u7684\u7aef\u53e3\u540d\n  jobLabel: k8s-app\n  namespaceSelector:  # \u8868\u793a\u53bb\u5339\u914d\u67d0\u4e00\u547d\u540d\u7a7a\u95f4\u4e2d\u7684service\uff0c\u5982\u679c\u60f3\u4ece\u6240\u6709\u7684namespace\u4e2d\u5339\u914d\u7528any: true\n    matchNames:\n    - kube-system\n  selector:  # \u5339\u914d\u7684 Service \u7684 labels\uff0c\u5982\u679c\u4f7f\u7528 mathLabels\uff0c\u5219\u4e0b\u9762\u7684\u6240\u6709\u6807\u7b7e\u90fd\u5339\u914d\u65f6\u624d\u4f1a\u5339\u914d\u8be5 service\uff0c\u5982\u679c\u4f7f\u7528 matchExpressions\uff0c\u5219\u81f3\u5c11\u5339\u914d\u4e00\u4e2a\u6807\u7b7e\u7684 service \u90fd\u4f1a\u88ab\u9009\u62e9\n    matchLabels:\n      k8s-app: kube-scheduler\n</code></pre> <p>\u4e0a\u9762\u662f\u4e00\u4e2a\u5178\u578b\u7684 <code>ServiceMonitor</code> \u8d44\u6e90\u5bf9\u8c61\u7684\u58f0\u660e\u65b9\u5f0f\uff0c\u4e0a\u9762\u6211\u4eec\u901a\u8fc7 <code>selector.matchLabels</code> \u5728 <code>kube-system</code> \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u5339\u914d\u5177\u6709 </p> <pre><code>k8s-app=kube-scheduler\n</code></pre> <p>\u8fd9\u6837\u7684 Service\uff0c\u4f46\u662f\u6211\u4eec\u7cfb\u7edf\u4e2d\u6839\u672c\u5c31\u6ca1\u6709\u5bf9\u5e94\u7684 Service\uff1a</p> <pre><code>$ kubectl get svc -n kube-system -l k8s-app=kube-scheduler\nNo resources found.\n</code></pre> <p>\u6240\u4ee5\u6211\u4eec\u9700\u8981\u53bb\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 Service \u5bf9\u8c61\uff0c\u624d\u80fd\u6838 <code>ServiceMonitor</code> \u8fdb\u884c\u5173\u8054\uff1a(prometheus-kubeSchedulerService.yaml)</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  namespace: kube-system\n  name: kube-scheduler\n  labels:\n    k8s-app: kube-scheduler\nspec:\n  selector:\n    component: kube-scheduler\n  ports:\n  - name: http-metrics\n    port: 10251\n    targetPort: 10251\n</code></pre> <p>\u5176\u4e2d\u6700\u91cd\u8981\u7684\u662f\u4e0a\u9762 labels \u548c selector \u90e8\u5206\uff0clabels \u533a\u57df\u7684\u914d\u7f6e\u5fc5\u987b\u548c\u6211\u4eec\u4e0a\u9762\u7684 ServiceMonitor \u5bf9\u8c61\u4e2d\u7684 selector \u4fdd\u6301\u4e00\u81f4\uff0cselector \u4e0b\u9762\u914d\u7f6e\u7684\u662f </p> <pre><code>component=kube-scheduler\n</code></pre> <p>\uff0c\u4e3a\u4ec0\u4e48\u4f1a\u662f\u8fd9\u4e2a label \u6807\u7b7e\u5462\uff0c\u6211\u4eec\u53ef\u4ee5\u53bb describe \u4e0b kube-scheduler \u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl describe pod kube-scheduler-ydzs-master -n kube-system\nName:               kube-scheduler-ydzs-master\nNamespace:          kube-system\nPriority:           2000000000\nPriorityClassName:  system-cluster-critical\nNode:               ydzs-master/111\nStart Time:         Sat, 04 Jan 2020 17:42:05 +0800\nLabels:             component=kube-scheduler\n                    tier=control-plane\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a Pod \u5177\u6709 </p> <pre><code>component=kube-scheduler\n</code></pre> <p>\u548c <code>tier=control-plane</code> \u8fd9\u4e24\u4e2a\u6807\u7b7e\uff0c\u800c\u524d\u9762\u8fd9\u4e2a\u6807\u7b7e\u5177\u6709\u66f4\u552f\u4e00\u7684\u7279\u6027\uff0c\u6240\u4ee5\u4f7f\u7528\u524d\u9762\u8fd9\u4e2a\u6807\u7b7e\u8f83\u597d\uff0c\u8fd9\u6837\u4e0a\u9762\u521b\u5efa\u7684 Service \u5c31\u53ef\u4ee5\u548c\u6211\u4eec\u7684 Pod \u8fdb\u884c\u5173\u8054\u4e86\uff0c\u76f4\u63a5\u521b\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f prometheus-kubeSchedulerService.yaml\n$ kubectl get svc -n kube-system -l k8s-app=kube-scheduler\nNAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)     AGE\nkube-scheduler   ClusterIP   12244   &lt;none&gt;        10251/TCP   13s\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u9694\u4e00\u5c0f\u4f1a\u513f\u540e\u53bb Prometheus \u9875\u9762\u4e0a\u67e5\u770b targets \u4e0b\u9762 kube-scheduler \u5df2\u7ecf\u53ef\u4ee5\u91c7\u96c6\u5230\u6307\u6807\u6570\u636e\u4e86\u3002\u53ef\u4ee5\u7528\u540c\u6837\u7684\u65b9\u5f0f\u6765\u4fee\u590d\u4e0b kube-controller-manager \u7ec4\u4ef6\u7684\u76d1\u63a7\uff0c\u53ea\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 Service \u5bf9\u8c61\uff0c\u53ea\u662f\u7aef\u53e3\u6539\u6210 10252 \u5373\u53ef\uff1a(prometheus-kubeControllerManagerService.yaml)</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  namespace: kube-system\n  name: kube-controller-manager\n  labels:\n    k8s-app: kube-controller-manager\nspec:\n  selector:\n    component: kube-controller-manager\n  ports:\n  - name: http-metrics\n    port: 10252\n    targetPort: 10252\n</code></pre> <p></p> <p>\u4e0a\u9762\u7684\u76d1\u63a7\u6570\u636e\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u53bb\u67e5\u770b\u4e0b Grafana \u4e0b\u9762\u7684\u76d1\u63a7\u56fe\u8868\u4e86\uff0c\u540c\u6837\u4f7f\u7528\u4e0a\u9762\u7684 NodePort \u8bbf\u95ee\u5373\u53ef\uff0c\u7b2c\u4e00\u6b21\u767b\u5f55\u4f7f\u7528 <code>admin:admin</code> \u767b\u5f55\u5373\u53ef\uff0c\u8fdb\u5165\u9996\u9875\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u5176\u5b9e Grafana \u5df2\u7ecf\u6709\u5f88\u591a\u914d\u7f6e\u597d\u7684\u76d1\u63a7\u56fe\u8868\u4e86\u3002</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u968f\u4fbf\u9009\u62e9\u4e00\u4e2a Dashboard \u67e5\u770b\u76d1\u63a7\u56fe\u8868\u4fe1\u606f\u3002</p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u6765\u5b66\u4e60\u5982\u4f55\u5b8c\u5168\u81ea\u5b9a\u4e49\u4e00\u4e2a <code>ServiceMonitor</code> \u4ee5\u53ca AlertManager \u76f8\u5173\u7684\u914d\u7f6e\u3002</p>"},{"location":"kubernetes_network/flannel/","title":"\u7f51\u7edc\u63d2\u4ef6","text":""},{"location":"kubernetes_network/flannel/#flannel","title":"Flannel","text":"<p>\u6211\u4eec\u77e5\u9053 Docker \u7684\u7f51\u7edc\u6a21\u5f0f\u53ef\u4ee5\u89e3\u51b3\u4e00\u4e2a\u8282\u70b9\u4e0a\u7684\u5bb9\u5668\u4e4b\u95f4\u7684\u7f51\u7edc\u901a\u4fe1\u95ee\u9898\uff0c\u4f46\u662f\u5bf9\u4e8e\u8de8\u4e3b\u673a\u7684\u5bb9\u5668\u4e4b\u95f4\u7684\u901a\u4fe1\u5c31\u65e0\u80fd\u4e3a\u529b\u4e86\uff0c\u5c31\u9700\u8981\u501f\u52a9\u7b2c\u4e09\u65b9\u7684\u5de5\u5177\u6765\u5b9e\u73b0\u5bb9\u5668\u7684\u8de8\u4e3b\u673a\u901a\u4fe1\u3002\u4e3a\u89e3\u51b3\u5bb9\u5668\u8de8\u4e3b\u673a\u901a\u4fe1\u95ee\u9898\uff0c\u793e\u533a\u51fa\u73b0\u4e86\u5f88\u591a\u79cd\u7f51\u7edc\u89e3\u51b3\u65b9\u6848\uff0c\u4e0d\u540c\u7684\u65b9\u6848\u5de5\u4f5c\u539f\u7406\u5404\u6709\u4e0d\u540c\uff0c\u5bf9\u4e8e\u7f51\u7edc\u73af\u5883\u7684\u8981\u6c42\u4e5f\u5404\u6709\u4e0d\u540c\uff0c\u6211\u4eec\u8fd9\u91cc\u4ee5\u4f7f\u7528\u6700\u591a\u7684 <code>Flannel</code> \u8fd9\u4e2a\u7f51\u7edc\u63d2\u4ef6\u4e3a\u4f8b\uff0c\u6765\u7ed9\u5927\u5bb6\u8bb2\u89e3\u8be5\u7ecf\u5178\u7f51\u7edc\u63d2\u4ef6\u7684\u5de5\u4f5c\u539f\u7406\u3002</p> <p><code>Flannel</code> \u662f CoreOS\uff08Etcd \u7684\u516c\u53f8\uff09\u63a8\u51fa\u7684\u4e00\u4e2a Overlay \u7c7b\u578b\u7684\u5bb9\u5668\u7f51\u7edc\u63d2\u4ef6\uff0c\u76ee\u524d\u652f\u6301\u4e09\u79cd\u540e\u7aef\u5b9e\u73b0\uff1a<code>UDP</code>\u3001<code>VXLAN</code>\u3001<code>host-gw</code> \u4e09\u79cd\u65b9\u5f0f\u3002UDP \u662f\u6700\u5f00\u59cb\u652f\u6301\u7684\u6700\u7b80\u5355\u7684\u4f46\u662f\u5374\u662f\u6027\u80fd\u6700\u5dee\u7684\u4e00\u79cd\u65b9\u5f0f\uff0c\u56e0\u6b64\u57fa\u672c\u4e0a\u5728\u6b63\u5f0f\u4f7f\u7528\u7684\u65f6\u5019\u4e0d\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u4e0d\u8fc7\u8be5\u65b9\u5f0f\u7531\u4e8e\u975e\u5e38\u7b80\u5355\u6240\u6709\u53ef\u4ee5\u6709\u52a9\u4e8e\u6211\u4eec\u6765\u7406\u89e3\u5bb9\u5668\u8de8\u4e3b\u673a\u7f51\u7edc\u901a\u4fe1\u7684\u5b9e\u73b0\u539f\u7406\uff0c\u6240\u4ee5\u6211\u4eec\u5148\u6765\u548c\u5927\u5bb6\u4e86\u89e3\u4e0b UDP \u65b9\u5f0f\u7684\u5b9e\u73b0\u65b9\u5f0f\u3002</p>"},{"location":"kubernetes_network/flannel/#udp","title":"UDP \u65b9\u5f0f","text":"<p>\u8fd8\u662f\u8981 <code>UDP</code> \u6a21\u5f0f\u6211\u4eec\u9700\u8981\u5728 Flannel \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a <code>Backend type</code> \u4e3a <code>UDP</code>\uff0c\u53ef\u4ee5\u76f4\u63a5\u4fee\u6539 Flannel \u7684\u65b9\u5f0f\u5b9e\u73b0\uff1a</p> <pre><code>$ kubectl edit cm kube-flannel-cfg -n kube-system\napiVersion: v1\ndata:\n  cni-conf.json: |\n    {\n      \"cniVersion\": \"0\",\n      \"name\": \"cbr0\",\n      \"plugins\": [\n        {\n          \"type\": \"flannel\",\n          \"delegate\": {\n            \"hairpinMode\": true,\n            \"isDefaultGateway\": true\n          }\n        },\n        {\n          \"type\": \"portmap\",\n          \"capabilities\": {\n            \"portMappings\": true\n          }\n        }\n      ]\n    }\n  net-conf.json: |\n    {\n        {\n      \"Network\": \"20/16\",\n      \"Backend\": {\n        \"Type\": \"udp\"  # \u4fee\u6539\u540e\u7aef\u7c7b\u578b\u4e3a UDP\n      }\n    }\nkind: ConfigMap\n......\n</code></pre> <p>\u9700\u8981\u5c06 <code>Backend</code> \u7684\u7c7b\u578b\u66f4\u6539\u4e3a <code>udp</code>\uff0c\u91c7\u7528 UDP \u6a21\u5f0f\u65f6\u540e\u7aef\u9ed8\u8ba4\u4e3a\u7aef\u53e3\u4e3a 8285\uff0c\u5373 Flanneld \u7684\u76d1\u542c\u7aef\u53e3\u3002\u5f53\u91c7\u7528 UDP \u6a21\u5f0f\u65f6\uff0cFlanneld \u8fdb\u7a0b\u5728\u542f\u52a8\u65f6\u4f1a\u901a\u8fc7\u6253\u5f00 <code>/dev/net/tun</code> \u7684\u65b9\u5f0f\u751f\u6210\u4e00\u4e2a <code>TUN</code> \u8bbe\u5907\uff0c<code>TUN</code> \u8bbe\u5907\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a Linux \u5f53\u4e2d\u63d0\u4f9b\u7684\u4e00\u79cd\u5185\u6838\u7f51\u7edc\u4e0e\u7528\u6237\u7a7a\u95f4\u901a\u4fe1\u7684\u4e00\u79cd\u673a\u5236\uff0c\u5373\u5e94\u7528\u53ef\u4ee5\u901a\u8fc7\u76f4\u63a5\u8bfb\u5199 TUN \u8bbe\u5907\u7684\u65b9\u5f0f\u6536\u53d1 RAW IP \u5305\u3002\u6240\u4ee5\u6211\u4eec\u8fd8\u9700\u8981\u5c06\u5bbf\u4e3b\u673a\u7684 <code>/dev/net/tun</code> \u6587\u4ef6\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u53bb\uff1a</p> <pre><code>$ kubectl edit ds kube-flannel-ds-amd64 -n kube-system\n......\n  volumeMounts:\n    - mountPath: /run/flannel\n    name: run\n    - mountPath: /etc/kube-flannel/\n    name: flannel-cfg\n    - mountPath: /dev/net\n    name: tun\n......\nvolumes:\n- hostPath:\n    path: /run/flannel\n    type: \"\"\n  name: run\n- hostPath:\n    path: /etc/cni/net.d\n    type: \"\"\n  name: cni\n- hostPath:\n    path: /dev/net  # \u6302\u8f7d\u5bbf\u4e3b\u673a\u7684 /dev/net/tun \u6587\u4ef6\n    type: \"\"\n  name: tun\n......\n</code></pre> <p>\u7136\u540e Flanneld \u7684 Pod \u4f1a\u81ea\u52a8\u91cd\u5efa\uff0c\u91cd\u5efa\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u968f\u4fbf\u67e5\u770b\u4e00\u4e2a Pod \u7684\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs -f kube-flannel-ds-amd64-5bk4dmd64 -n kube-system\nI1128 08:26:663566       1 main.go:527] Using interface with name eth0 and address 111\nI1128 08:26:663838       1 main.go:544] Defaulting external address to interface address (111)\nI1128 08:26:857634       1 kube.go:126] Waiting 10m0s for node controller to sync\nI1128 08:26:857805       1 kube.go:309] Starting kube subnet manager\nI1128 08:26:858137       1 kube.go:133] Node controller sync successful\nI1128 08:26:858324       1 main.go:244] Created subnet manager: Kubernetes Subnet Manager - ydzs-master\nI1128 08:26:858357       1 main.go:247] Installing signal handlers\nI1128 08:26:858933       1 main.go:386] Found network config - Backend type: udp\nI1128 08:26:089114       1 main.go:317] Wrote subnet file to /run/flannel/subnet.env\nI1128 08:26:089177       1 main.go:321] Running backend.\nI1128 08:26:089227       1 main.go:339] Waiting for all goroutines to exit\nI1128 08:26:089280       1 udp_network_amdgo:100] Watching for new subnet leases\nI1128 08:26:089350       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:26:089443       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:26:089487       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:26:089518       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:27:936553       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:27:341176       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:27:136280       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:27:863379       1 udp_network_amdgo:195] Subnet added: 20/24\n</code></pre> <p>\u770b\u5230</p> <pre><code>Found network config - Backend type: udp\n</code></pre> <p>\u8fd9\u4e2a\u4fe1\u606f\u8bc1\u660e\u6211\u4eec\u73b0\u5728\u5df2\u7ecf\u53d8\u6210\u4e86 <code>UDP</code> \u6a21\u5f0f\u4e86\u3002</p> <p>Flanneld \u8fdb\u7a0b\u542f\u52a8\u540e\u901a\u8fc7 <code>ip a</code> \u547d\u4ee4\u53ef\u4ee5\u53d1\u73b0\u8282\u70b9\u5f53\u4e2d\u5df2\u7ecf\u591a\u4e86\u4e00\u4e2a\u53eb <code>flannel0</code> \u7684\u7f51\u7edc\u8bbe\u5907\uff1a</p> <pre><code>$ ip -d link show flannel0\n210: flannel0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1472 qdisc pfifo_fast state UNKNOWN mode DEFAULT group default qlen 500\n    link/none  promiscuity 0\n    tun addrgenmode random numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535\n</code></pre> <p>\u7531\u4e8e\u662f UDP \u7684\u670d\u52a1\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u901a\u8fc7 <code>netstat -ulnp</code> \u547d\u4ee4\u67e5\u770b\u8fdb\u7a0b\uff1a</p> <pre><code>$ netstat -ulnp | grep flanneld\nudp        0      0 111:8285       0:*                           24844/flanneld\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6709\u4e24\u4e2a Pod\uff0c\u5206\u522b\u5728\u8282\u70b9 ydzs-node1 \u548c\u8282\u70b9 ydzs-node2 \u4e0a\u9762\uff0c\u73b0\u5728\u8ba9 pod-a\uff0810.244.1.236\uff09\u5411 pod-b\uff0810.244.2.123\uff09\u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\u62a5\u6587\uff08ping\uff09\uff0c\u6211\u4eec\u6765\u5206\u6790\u4ee5\u4e0b\u62a5\u6587\u662f\u5982\u4f55\u4ece pod-a \u5230\u8fbe pod-b \u7684\uff1a</p> <pre><code>$ kubectl get pods -o wide\nNAME                        READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES\npod-a                       1/1     Running   0          73s     2236   ydzs-node1   &lt;none&gt;           &lt;none&gt;\npod-b                       1/1     Running   0          38s     2123   ydzs-node2   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>1\u3001\u5728 pod-a \u5f53\u4e2d\u53d1\u51fa ICMP \u8bf7\u6c42\u62a5\u6587\uff0c\u5176\u6e90\u5730\u5740\u5c31\u662f 10.244.1.236\uff0c\u76ee\u6807\u5730\u5740\u662f 10.244.2.123\uff0c\u6b64\u65f6\u901a\u8fc7 pod-a \u5185\u7684\u8def\u7531\u8868\u5339\u914d\u5230\u5e94\u8be5\u5c06\u8be5 IP \u5305\u53d1\u9001\u5230 ydzs-node1 \u8282\u70b9\u4e0a\u7f51\u5173 10.244.1.1\uff08<code>cni0</code>\u7f51\u6865\uff09\u3002</p> <pre><code>$ kubectl exec pod-a -- route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0         21      0         UG    0      0        0 eth0\n20      21      220     UG    0      0        0 eth0\n20      0         2220   U     0      0        0 eth0\n</code></pre> <p>\u5728 ydzs-node1 \u8282\u70b9\u4e0a\u53ef\u4ee5\u67e5\u770b\u5230 pod-a \u4e2d\u7684\u7f51\u5173 10.244.1.1 \u5c31\u662f\u8282\u70b9\u4e0a\u7684 <code>cni0</code> \u7f51\u6865\uff1a</p> <pre><code>[root@ydzs-node1 ~]# ifconfig -a\ncni0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450\n        inet 21  netmask 2220  broadcast 0\n        inet6 fe80::64c2:65ff:fe15:3669  prefixlen 64  scopeid 0x20&lt;link&gt;\n        ether f6:f9:99:71:81:a2  txqueuelen 1000  (Ethernet)\n        RX packets 33385207  bytes 24883992070 (1 GiB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 31653673  bytes 19703556786 (3 GiB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n......\n</code></pre> <p>2\u3001\u8fd9\u4e2a\u65f6\u5019\uff0cIP \u5305\u7684\u4e0b\u4e00\u4e2a\u76ee\u7684\u5730\uff0c\u5c31\u53d6\u51b3\u4e8e\u5bbf\u4e3b\u673a\u4e0a\u9762\u7684\u8def\u7531\u89c4\u5219\u4e86\uff0cFlanneld \u8fdb\u7a0b\u5df2\u7ecf\u5728\u5bbf\u4e3b\u673a\u4e0a\u9762\u521b\u5efa\u4e86\u4e00\u7cfb\u5217\u7684\u8def\u7531\u89c4\u5219\uff0c\u6bd4\u5982\u5f53\u524d\u7684 ydzs-node1 \u8282\u70b9\uff1a</p> <pre><code>[root@ydzs-node1 ~]# ip route\ndefault via 111 dev eth0  proto static  metric 100\n10/24 dev eth0  proto kernel  scope link  src 122  metric 100\n20/16 dev flannel0\n20/24 dev cni0  proto kernel  scope link  src 21\n10/16 dev docker0  proto kernel  scope link  src 11\n</code></pre> <p>\u6b64\u65f6\u5230\u8fbe <code>cni0</code> \u7684 IP \u5305\u76ee\u6807\u5730\u5740 10.244.2.123 \u5339\u914d\u4e0d\u5230\u672c\u673a\u7684 <code>cni0</code> \u7f51\u6865\u5bf9\u5e94\u7684 <code>10.244.1.0/24</code> \u7f51\u6bb5\uff0c\u53ea\u80fd\u5339\u914d\u5230\u7b2c\u4e09\u6761 <code>10.244.0.0/16</code> \u5bf9\u5e94\u7684\u8fd9\u6761\u8def\u7531\u89c4\u5219\uff0c\u8fd9\u4e2a\u65f6\u5019\u5185\u6838\u5c06 RAW IP \u5305\u53d1\u9001\u7ed9 <code>flannel0</code> \u8bbe\u5907\u3002</p> <p><code>flannel0</code> \u8bbe\u5907\u5b83\u662f\u4e00\u4e2a <code>TUN</code> \u8bbe\u5907\uff08Tunnel \u8bbe\u5907\uff09\u3002\u5728 Linux \u4e2d\uff0cTUN \u8bbe\u5907\u662f\u4e00\u79cd\u5de5\u4f5c\u5728\u4e09\u5c42\uff08Network Layer\uff09\u7684\u865a\u62df\u7f51\u7edc\u8bbe\u5907\uff0cTUN \u8bbe\u5907\u7684\u529f\u80fd\u975e\u5e38\u7b80\u5355\uff0c\u5373\uff1a<code>\u5728\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u548c\u7528\u6237\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u4f20\u9012 IP \u5305</code>\u3002</p> <p>3\u3001\u7531\u4e8e <code>flannel0</code> \u662f\u4e00\u4e2a <code>TUN</code> \u8bbe\u5907\uff0c\u53d1\u9001\u7ed9 <code>flannel0</code> \u63a5\u53e3\u7684 <code>RAW IP</code> \u5305\u5c06\u88ab Flanneld \u8fdb\u7a0b\u63a5\u6536\u5230\uff0c\u7136\u540e\u5728\u539f\u6709\u7684\u57fa\u7840\u4e0a\u8fdb\u884c UDP \u5c01\u5305\uff0c\u7136\u540e\u53d1\u9001\u5230 ydzs-node2 \u8282\u70b9\u4e0a\u7684 <code>Flanneld</code> \u8fdb\u884c\u89e3\u5305\u3002</p> <p>\u5c01\u5305</p> <p>UDP \u5c01\u5305\u7684\u5f62\u5f0f\u4e3a\uff1a10.151.30.22:src port -&gt; 10.151.30.23:8285\u3002</p> <p>\u8fd9\u91cc\u6700\u5173\u952e\u7684\u5c31\u662f UDP \u5c01\u5305\u53d1\u9001\u5230\u6211\u4eec\u7684\u76ee\u6807 IP 10.244.2.123 \u8fd9\u4e2a\u5bb9\u5668\u6240\u5728\u7684\u8282\u70b9\uff0c\u4f46\u662f\u662f\u5982\u4f55\u77e5\u9053\u8fd9\u4e2a\u8282\u70b9\u7684\u5462\uff1f</p> <p>\u8fd9\u4e2a\u5c31\u9700\u8981\u4e86\u89e3\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u6982\u5ff5*\u5b50\u7f51\uff08Subnet\uff09\uff0cFlannel \u7ba1\u7406\u7684\u5bb9\u5668\u7f51\u7edc\uff0c\u4e00\u53f0\u5bbf\u4e3b\u673a\u4e0a\u7684\u6240\u6709\u5bb9\u5668\uff0c\u90fd\u5c5e\u4e8e\u8be5\u5bbf\u4e3b\u673a\u88ab\u5206\u914d\u7684\u4e00\u4e2a\u5b50\u7f51\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u7684 ydzs-node1 \u8282\u70b9\u7684\u5b50\u7f51\u662f <code>10.244.1.0/24</code>\uff0810.244.1.1-10.244.1.254\uff09\uff0cpod-a \u7684 IP \u5730\u5740\u662f <code>10.244.1.236</code>\uff1bydzs-node2 \u8282\u70b9\u7684\u5b50\u7f51\u662f <code>10.244.2.0/24</code>\uff0810.244.2.1-10.244.2.254\uff09\uff0cpod-b \u7684 IP \u5730\u5740\u662f <code>10.244.2.123</code>\uff0c\u8fd9\u4e9b\u5b50\u7f51\u4fe1\u606f\u662f\u5f53 Flanneld \u8fdb\u7a0b\u5728\u542f\u52a8\u65f6\u901a\u8fc7 api-server \u4fdd\u5b58\u5230 etcd \u5f53\u4e2d\uff0c\u6240\u4ee5\u5728\u53d1\u9001\u62a5\u6587\u65f6\u53ef\u4ee5\u901a\u8fc7\u76ee\u7684\u5730\u5740 <code>10.244.2.123</code> \u5339\u914d\u5230\u5bf9\u5e94\u7684\u5b50\u7f51\u662f <code>10.244.2.0/24</code>\uff0c\u8fd9\u4e2a\u65f6\u5019\u67e5\u8be2 etcd \u5f97\u5230\u8fd9\u4e2a\u5b50\u7f51\u5bf9\u5e94\u7684\u5bbf\u4e3b\u673a\u7684 IP \u5730\u5740 10.151.30.23\uff0c\u4e5f\u5c31\u662f ydzs-node2 \u8282\u70b9\u3002</p> <p>4\u3001ydzs-node2 \u8282\u70b9\u6536\u5230 UDP \u62a5\u6587\u8fc7\u540e\u7ecf\u8fc7 Linux \u5185\u6838\u901a\u8fc7 UDP \u7aef\u53e3 8285 \u5c06\u5305\u4ea4\u7ed9\u8282\u70b9\u4e0a\u7684 Flanneld \u8fdb\u7a0b\u3002</p> <p>5\u3001\u7136\u540e ydzs-node2 \u8282\u70b9\u4e0a\u7684 Flanneld \u8fdb\u7a0b\u5c06\u63a5\u6536\u5230\u7684 UDP \u5305\u89e3\u5305\u540e\u5f97\u5230 RAW IP \u5305\uff1a</p> <pre><code>2236 -&gt; 2123\n</code></pre> <p>\u3002</p> <p>6\u3001\u89e3\u5305\u540e\u7684 RAW IP \u5305\u5339\u914d\u5230 ydzs-node2 \u8282\u70b9\u4e0a\u7684\u8def\u7531\u89c4\u5219\uff0810.244.2.0/24\uff09\uff0c\u5185\u6838\u5c06 RAW IP \u5305\u53d1\u9001\u7ed9 <code>cni0</code> \u8bbe\u5907</p> <pre><code>[root@ydzs-node2 ~]# ip route\ndefault via 111 dev eth0  proto static  metric 100\n10/24 dev eth0  proto kernel  scope link  src 123  metric 100\n20/16 dev flannel0\n20/24 dev cni0  proto kernel  scope link  src 21\n10/16 dev docker0  proto kernel  scope link  src 11\n</code></pre> <p>7\u3001<code>cni0</code> \u5c06 IP \u5305\u8f6c\u53d1\u7ed9\u8fde\u63a5\u5728 <code>cni0</code> \u7f51\u6865\u4e0a\u7684 pod-b\uff0c\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u8fd9\u4e2a\u901a\u4fe1\u8fc7\u7a0b\uff1a</p> <pre><code>$ kubectl exec pod-a ping 2123\nPING 2123 (2123): 56 data bytes\n64 bytes from 2123: seq=0 ttl=62 time=452 ms\n64 bytes from 2123: seq=1 ttl=62 time=160 ms\n64 bytes from 2123: seq=2 ttl=62 time=853 ms\n</code></pre> <p>\u4e0a\u9762\u5c31\u662f\u57fa\u4e8e Flannel UDP \u6a21\u5f0f\u7684\u8de8\u4e3b\u901a\u4fe1\u7684\u57fa\u672c\u6d41\u7a0b\u4e86\uff0c\u4ece\u4e0a\u9762\u7684\u6574\u4e2a\u6d41\u7a0b\u6765\u770b\uff0c<code>Flanneld</code> \u4e3b\u8981\u6709\u4e24\u65b9\u9762\u7684\u529f\u80fd\uff1a</p> <ul> <li>UDP \u5c01\u5305\u89e3\u5305</li> <li>\u8282\u70b9\u4e0a\u7684\u8def\u7531\u8868\u7684\u52a8\u6001\u66f4\u65b0</li> </ul> <p>\u6211\u4eec\u53ef\u4ee5\u660e\u663e\u770b\u51fa\u6765\u6570\u636e\u5305\u662f\u901a\u8fc7 tun \u8bbe\u5907\u4ece\u5185\u6838\u6001\u590d\u5236\u5230\u7528\u6237\u6001\u7684\u5e94\u7528\u4e2d\u7684\uff0c\u7136\u540e\u518d\u901a\u8fc7\u7528\u6237\u6001\u590d\u5236\u5230\u5185\u6838\u6001\uff0c\u4ec5\u4e00\u6b21\u7f51\u7edc\u4f20\u8f93\u5c31\u8fdb\u884c\u4e86\u4e24\u6b21\u7528\u6237\u6001\u548c\u5185\u6838\u6001\u7684\u5207\u6362\uff0c\u663e\u7136\u8fd9\u79cd\u6548\u7387\u662f\u4e0d\u4f1a\u5f88\u9ad8\u7684\uff0c\u7531\u4e8e\u4f4e\u6548\u7387\u6240\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u57fa\u672c\u4e0a\u4e0d\u662f\u5440\uff0c\u8981\u63d0\u9ad8\u6548\u7387\u6700\u7b80\u5355\u7684\u65b9\u5f0f\u5c31\u662f\u628a\u5c01\u5305\u89e3\u5305\u8fd9\u4e9b\u4e8b\u60c5\u90fd\u4ea4\u7ed9\u5185\u6838\u53bb\u5e72\u597d\u4e86\uff0c\u4e8b\u5b9e\u4e0a Linux \u5185\u6838\u672c\u8eab\u4e5f\u63d0\u4f9b\u4e86\u6bd4\u8f83\u6210\u719f\u7684\u7f51\u7edc\u5c01\u5305\u89e3\u5305\uff08\u96a7\u9053\u4f20\u8f93\uff09\u5b9e\u73b0\u65b9\u6848 <code>VXLAN</code>\uff0cFlanneld \u4e5f\u5b9e\u73b0\u4e86\u57fa\u4e8e <code>VXLAN</code> \u7684\u65b9\u6848\uff0c\u8be5\u65b9\u6848\u5728\u6211\u4eec\u65e5\u5e38\u4f7f\u7528\u7684\u65f6\u5019\u4e5f\u662f\u6700\u666e\u904d\u7684\u3002</p>"},{"location":"kubernetes_network/flannel/#vxlan","title":"VXLAN \u65b9\u5f0f","text":"<p><code>VXLAN</code>\uff0c\u5373 Virtual Extensible LAN\uff08\u865a\u62df\u53ef\u6269\u5c55\u5c40\u57df\u7f51\uff09\uff0c\u662f Linux \u5185\u6838\u672c\u8eab\u5c31\u652f\u6301\u7684\u4e00\u79cd\u7f51\u7edc\u865a\u4f3c\u5316\u6280\u672f\u3002\u6240\u4ee5\u8bf4\uff0cVXLAN \u53ef\u4ee5\u5b8c\u5168\u5728\u5185\u6838\u6001\u5b9e\u73b0\u4e0a\u8ff0\u5c01\u88c5\u548c\u89e3\u5c01\u88c5\u7684\u5de5\u4f5c\uff0c\u4ece\u800c\u901a\u8fc7\u4e0e\u524d\u9762\u76f8\u4f3c\u7684\u96a7\u9053\u673a\u5236\uff0c\u6784\u5efa\u51fa\u8986\u76d6\u7f51\u7edc\uff08Overlay Network\uff09\u3002</p> <p>\u540c\u6837\u7684\u5f53\u6211\u4eec\u4f7f\u7528 <code>VXLAN</code> \u6a21\u5f0f\u7684\u65f6\u5019\u9700\u8981\u5c06 Flanneld \u7684 Backend \u7c7b\u578b\u4fee\u6539\u4e3a <code>vxlan</code>\uff1a</p> <pre><code>$ kubectl edit cm kube-flannel-cfg -n kube-system\napiVersion: v1\ndata:\n  cni-conf.json: |\n    {\n      \"cniVersion\": \"0\",\n      \"name\": \"cbr0\",\n      \"plugins\": [\n        {\n          \"type\": \"flannel\",\n          \"delegate\": {\n            \"hairpinMode\": true,\n            \"isDefaultGateway\": true\n          }\n        },\n        {\n          \"type\": \"portmap\",\n          \"capabilities\": {\n            \"portMappings\": true\n          }\n        }\n      ]\n    }\n  net-conf.json: |\n    {\n        {\n      \"Network\": \"20/16\",\n      \"Backend\": {\n        \"Type\": \"vxlan\"  # \u4fee\u6539\u540e\u7aef\u7c7b\u578b\u4e3a vxlan\n      }\n    }\nkind: ConfigMap\n......\n</code></pre> <p>\u5c06\u7c7b\u578b\u4fee\u6539\u4e3a <code>vxlan</code> \u8fc7\u540e\uff0c\u9700\u8981\u91cd\u5efa\u4e0b Flanneld \u7684\u6240\u6709 Pod \u624d\u80fd\u751f\u6548\uff1a</p> <pre><code>$ kubectl delete pod -n kube-system -l app=flannel\n</code></pre> <p>\u91cd\u5efa\u5b8c\u6210\u540e\u540c\u6837\u53ef\u4ee5\u968f\u4fbf\u67e5\u770b\u4e00\u4e2a Pod \u7684\u65e5\u5fd7\uff0c\u51fa\u73b0\u5982\u4e0b</p> <pre><code>Found network config - Backend type: vxlan\n</code></pre> <p>\u7684\u65e5\u5fd7\u4fe1\u606f\u5c31\u8bc1\u660e\u5df2\u7ecf\u914d\u7f6e\u6210\u529f\u4e86\uff1a</p> <pre><code>$ kubectl logs -f kube-flannel-ds-amd64-pfb8h -n kube-system\nI1129 03:33:588549       1 main.go:527] Using interface with name eth0 and address 123\nI1129 03:33:588893       1 main.go:544] Defaulting external address to interface address (123)\nI1129 03:33:698562       1 kube.go:126] Waiting 10m0s for node controller to sync\nI1129 03:33:698726       1 kube.go:309] Starting kube subnet manager\nI1129 03:33:698910       1 kube.go:133] Node controller sync successful\nI1129 03:33:698980       1 main.go:244] Created subnet manager: Kubernetes Subnet Manager - ydzs-node2\nI1129 03:33:699000       1 main.go:247] Installing signal handlers\nI1129 03:33:699375       1 main.go:386] Found network config - Backend type: vxlan\nI1129 03:33:699553       1 vxlan.go:120] VXLAN config: VNI=1 Port=0 GBP=false DirectRouting=false\nI1129 03:33:703715       1 main.go:317] Wrote subnet file to /run/flannel/subnet.env\nI1129 03:33:703785       1 main.go:321] Running backend.\nI1129 03:33:703825       1 main.go:339] Waiting for all goroutines to exit\nI1129 03:33:703940       1 vxlan_network.go:60] watching for new subnet leases\n</code></pre> <p>Flanneld \u5728\u542f\u52a8\u65f6\u4f1a\u901a\u8fc7 <code>Netlink</code> \u673a\u5236\u4e0e Linux \u5185\u6838\u901a\u4fe1\uff0c\u5efa\u7acb\u4e00\u4e2a </p> <pre><code>VTEP\uff08Virtual Tunnel Access End Point\uff09\n</code></pre> <p>\u8bbe\u5907 <code>flannel.1</code>\uff08\u547d\u540d\u89c4\u5219\u4e3a<code>flannel.[VNI]</code>\uff0cVNI \u9ed8\u8ba4\u4e3a1\uff09\uff0c\u7c7b\u4f3c\u4e8e\u4ea4\u6362\u673a\u5f53\u4e2d\u7684\u4e00\u4e2a\u7f51\u53e3\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>ip -d link</code> \u547d\u4ee4\u67e5\u770b <code>VTEP</code> \u8bbe\u5907 <code>flannel.1</code> \u7684\u914d\u7f6e\u4fe1\u606f\uff1a</p> <pre><code>$ ip -d link show flannel.1\n6: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT\n    link/ether 72:f7:e9:40:97:1e brd ff:ff:ff:ff:ff:ff promiscuity 0\n    vxlan id 1 local 122 dev eth0 srcport 0 0 dstport 8472 nolearning ageing 300 addrgenmode eui64\n</code></pre> <p>\u4ece\u4e0a\u9762\u8f93\u51fa\u53ef\u4ee5\u770b\u5230\uff0c<code>VTEP</code> \u7684 local IP \u4e3a 10.151.30.22\uff0cdestination port \u4e3a <code>8472</code>\u3002\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728\u8282\u70b9\u4e0a\u67e5\u770b\u8fdb\u7a0b\u76d1\u542c\u60c5\u51b5\uff1a</p> <pre><code>$ netstat -ulnp | grep 8472\nudp        0      0 0:8472            0:*                           -\n</code></pre> <p>\u6211\u4eec\u4ed4\u7ec6\u770b\u548c UDP \u6a21\u5f0f\u4e0b\u67e5\u770b Flanneld \u76d1\u542c\u7684\u7aef\u53e3\u662f\u6709\u533a\u522b\u7684\uff0c\u6700\u540e\u4e00\u680f\u663e\u793a\u7684\u4e0d\u662f\u8fdb\u7a0b\u7684 ID \u548c\u540d\u79f0\uff0c\u800c\u662f\u4e00\u4e2a\u7834\u6298\u53f7<code>-</code>\uff0c\u8fd9\u8bf4\u660e UDP \u76848472\u7aef\u53e3\u4e0d\u662f\u7531\u7528\u6237\u6001\u7684\u8fdb\u7a0b\u5728\u76d1\u542c\u7684\uff0c\u4e5f\u8bc1\u5b9e\u4e86<code>VXLAN</code>\u6a21\u5757\u5de5\u4f5c\u5728\u5185\u6838\u6001\u6a21\u5f0f\u4e0b\u3002</p> <p>\u5728 UDP \u6a21\u5f0f\u4e0b\u7531 Flanneld \u8fdb\u7a0b\u8fdb\u884c\u7f51\u7edc\u5305\u7684\u5c01\u5305\u548c\u89e3\u5305\u7684\u5de5\u4f5c\uff0c\u800c\u5728 <code>VXLAN</code> \u6a21\u5f0f\u4e0b\u89e3\u5c01\u5305\u7684\u4e8b\u60c5\u4ea4\u7531\u5185\u6838\u5904\u7406\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u770b\u4e0b Flanneld \u540e\u7aef\u7684\u5177\u4f53\u5de5\u5177\u6d41\u7a0b\u3002\u5f53 Flanneld \u542f\u52a8\u65f6\u5c06\u521b\u5efa <code>VTEP</code> \u8bbe\u5907 <code>flannel.1</code>\uff0c\u5e76\u5c06 <code>VTEP</code> \u8bbe\u5907\u7684\u76f8\u5173\u4fe1\u606f\u4e0a\u62a5\u5230 etcd \u5f53\u4e2d\uff0c\u800c\u5f53\u5728 Flannel \u7f51\u7edc\u4e2d\u6709\u65b0\u7684\u8282\u70b9\u53d1\u73b0\u65f6\uff0c\u5404\u4e2a\u8282\u70b9\u4e0a\u7684 Flanneld \u8fdb\u7a0b\u5c06\u4f9d\u6b21\u6267\u884c\u4ee5\u4e0b\u6d41\u7a0b\uff1a</p> <p>1\u3001\u5728\u8282\u70b9\u5f53\u4e2d\u521b\u5efa\u4e00\u6761\u8be5\u8282\u70b9\u6240\u5c5e\u7f51\u6bb5\u7684\u8def\u7531\u8868\uff0c\u4e3b\u8981\u662f\u80fd\u8ba9 Pod \u5f53\u4e2d\u7684\u6d41\u91cf\u8def\u7531\u5230 <code>flannel.1</code> \u63a5\u53e3\u3002\u901a\u8fc7<code>route -n</code>\u53ef\u4ee5\u67e5\u770b\u5230\u8282\u70b9\u5f53\u4e2d\u5df2\u7ecf\u6709\u56db\u6761 <code>flannel.1</code> \u63a5\u53e3\u7684\u8def\u7531\uff1a</p> <pre><code>$ route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0         111    0         UG    100    0        0 eth0\n10     0         2220   U     100    0        0 eth0\n20      20      2220   UG    0      0        0 flannel.1\n20      0         2220   U     0      0        0 cni0\n20      20      2220   UG    0      0        0 flannel.1\n20      20      2220   UG    0      0        0 flannel.1\n20      20      2220   UG    0      0        0 flannel.1\n10      0         220     U     0      0        0 docker0\n</code></pre> <p>\u6bd4\u5982 <code>10.244.2.0</code> \u8fd9\u6761\u8def\u7531\u89c4\u5219\uff0c\u4ed6\u7684\u610f\u601d\u5c31\u662f\u53d1\u5f80 <code>10.244.2.0/24</code> \u7f51\u6bb5\u7684 IP \u5305\uff0c\u90fd\u9700\u8981\u7ecf\u8fc7 <code>flannel.1</code> \u8bbe\u5907\u53d1\u51fa\uff0c\u800c\u4e14\u6700\u540e\u88ab\u53d1\u9001\u5230\u7684\u7f51\u5173\u5730\u5740\u662f <code>10.244.2.0</code>\u3002\u800c\u5176\u5b9e\u8fd9\u4e2a\u7f51\u5173\u5730\u5740\u5c31\u662f ydzs-node2 \u8282\u70b9\u4e0a\u7684 VTEP \u8bbe\u5907\uff08\u4e5f\u5c31\u662f flannel.1\uff09\u7684 IP \u5730\u5740\uff1a</p> <pre><code>[root@ydzs-node2 ~]# ifconfig\nflannel.1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450\n        inet 20  netmask 222255  broadcast 0\n        inet6 fe80::2467:52ff:fe6b:1bf9  prefixlen 64  scopeid 0x20&lt;link&gt;\n        ether 26:67:52:6b:1b:f9  txqueuelen 0  (Ethernet)\n        RX packets 42050890  bytes 27691009839 (7 GiB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 36287976  bytes 46894346975 (6 GiB)\n        TX errors 0  dropped 163 overruns 0  carrier 0  collisions 0\n......\n</code></pre> <p>2\u3001\u4e0a\u9762\u77e5\u9053\u4e86\u76ee\u7684 VTEP \u8bbe\u5907\u7684 IP \u5730\u5740\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u77e5\u9053\u76ee\u7684 MAC \u5730\u5740\uff0c\u624d\u80fd\u628a\u6570\u636e\u5305\u53d1\u9001\u8fc7\u53bb\uff0c\u8fd9\u4e2a\u65f6\u5019\u5176\u5b9e Flanneld \u8fdb\u7a0b\u5c31\u4f1a\u5728\u8282\u70b9\u5f53\u4e2d\u7ef4\u62a4\u6240\u6709\u8282\u70b9\u7684 IP \u4ee5\u53ca <code>VTEP</code> \u8bbe\u5907\u7684\u9759\u6001 <code>ARP</code> \u7f13\u5b58\u3002\u53ef\u901a\u8fc7 <code>arp -n</code> \u547d\u4ee4\u67e5\u770b\u5230\u5f53\u524d\u8282\u70b9\u5f53\u4e2d\u5df2\u7ecf\u7f13\u5b58\u4e86\u53e6\u5916\u56db\u4e2a\u8282\u70b9\u4ee5\u53ca <code>VTEP</code> \u7684 ARP \u4fe1\u606f\u3002</p> <pre><code>$ arp -n\nAddress                  HWtype  HWaddress           Flags Mask            Iface\n20               ether   32:f1:e0:a9:97:ab   CM                    flannel.1\n20               ether   26:67:52:6b:1b:f9   CM                    flannel.1\n20               ether   0a:24:5e:40:ff:da   CM                    flannel.1\n20               ether   4a:09:1f:42:ed:c1   CM                    flannel.1\n......\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u770b\u5230 IP \u5730\u5740 <code>10.244.2.0</code> \u5bf9\u5e94\u7684 MAC \u5730\u5740\u662f <code>26:67:52:6b:1b:f9</code>\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u77e5\u9053\u4e86\u76ee\u7684 VTEP \u8bbe\u5907\u7684 MAC \u5730\u5740\u3002\u4f46\u662f\u73b0\u5728\u6211\u4eec\u53ea\u662f\u77e5\u9053\u4e86\u76ee\u6807\u8bbe\u5907\u7684 MAC \u5730\u5740\uff0c\u5374\u4e0d\u77e5\u9053\u5bf9\u5e94\u7684\u5bbf\u4e3b\u673a\u7684\u5730\u5740\u662f\u4ec0\u4e48\uff1f</p> <p>3\u3001\u8fd9\u4e2a\u65f6\u5019 Flanneld \u8fdb\u7a0b\u8fd8\u4f1a\u5728\u8282\u70b9\u5f53\u4e2d\u6dfb\u52a0\u4e00\u6761\u8be5\u8282\u70b9\u7684\u8f6c\u53d1\u8868\uff0c\u901a\u8fc7 <code>bridge</code> \u547d\u4ee4\u67e5\u770b\u8282\u70b9\u4e0a\u7684 VXLAN \u8f6c\u53d1\u8868\uff08FDB entry\uff09\uff0cMAC \u4e3a <code>VTEP</code> \u8bbe\u5907\u5373 <code>flannel.1</code> \u7684 MAC \u5730\u5740\uff0cIP \u4e3a VTEP \u5bf9\u5e94\u7684\u5bf9\u5916 IP\uff08\u53ef\u901a\u8fc7 Flanneld \u7684\u542f\u52a8\u53c2\u6570 <code>--iface=eth0</code> \u6307\u5b9a\uff0c\u82e5\u4e0d\u6307\u5b9a\u5219\u6309\u9ed8\u8ba4\u7f51\u5173\u67e5\u627e\u7f51\u7edc\u63a5\u53e3\u5bf9\u5e94\u7684 IP\uff09\uff0c\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6709\u56db\u6761\u8f6c\u53d1\u8868\u3002</p> <pre><code>$ bridge fdb show dev flannel.1\n32:f1:e0:a9:97:ab dst 157 self permanent\n26:67:52:6b:1b:f9 dst 123 self permanent\n4a:09:1f:42:ed:c1 dst 159 self permanent\n0a:24:5e:40:ff:da dst 111 self permanent\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u627e\u5230\u4e86\u4e0a\u9762\u76ee\u7684 VTEP \u8bbe\u5907\u7684 MAC \u5730\u5740\u5bf9\u5e94\u7684 IP \u5730\u5740\u4e3a 10.151.30.23 \u7684\u4e3b\u673a\uff0c\u8fd9\u5c31\u662f\u6211\u4eec\u7684 ydzs-node2 \u8282\u70b9\uff0c\u6240\u4ee5\u6211\u4eec\u5c31\u627e\u5230\u4e86\u8981\u53d1\u5f80\u7684\u76ee\u7684\u5730\u5740\u3002</p> <p>\u8fd9\u4e2a\u65f6\u5019\u5bb9\u5668\u8de8\u8282\u70b9\u7f51\u7edc\u901a\u4fe1\u5b9e\u73b0\u7684\u5b8c\u6574\u6d41\u7a0b\u4e3a\uff1a</p> <ul> <li>\u548c UDP \u6a21\u5f0f\u4e00\u6837\uff0cpod-a\uff0810.244.1.236\uff09\u5f53\u4e2d\u7684 IP \u5305\u901a\u8fc7 pod-a \u5185\u7684\u8def\u7531\u8868\u88ab\u53d1\u9001\u5230 <code>cni0</code></li> <li>\u5230\u8fbe <code>cni0</code> \u5f53\u4e2d\u7684 IP \u5305\u901a\u8fc7\u5339\u914d\u8282\u70b9 ydzs-node1 \u5f53\u4e2d\u7684\u8def\u7531\u8868\u53d1\u73b0\u901a\u5f80 10.244.2.13 \u7684 IP \u5305\u5e94\u8be5\u4ea4\u7ed9 <code>flannel.1</code> \u63a5\u53e3</li> <li><code>flannel.1</code> \u4f5c\u4e3a\u4e00\u4e2a VTEP \u8bbe\u5907\uff0c\u6536\u5230\u62a5\u6587\u540e\u5c06\u6309\u7167 <code>VTEP</code> \u7684\u914d\u7f6e\u8fdb\u884c\u5c01\u5305\uff0c\u901a\u8fc7 ydzs-node1 \u8282\u70b9\u4e0a\u7684 arp \u548c\u8f6c\u53d1\u8868\u5f97\u77e5 10.244.2.123 \u5c5e\u4e8e\u8282\u70b9 ydzs-node2\uff0c\u5e76\u4e14\u4f1a\u5c06 ydzs-node2 \u8282\u70b9\u5bf9\u5e94\u7684 VTEP \u8bbe\u5907\u7684 MAC \u5730\u5740\uff0c\u6839\u636e <code>flannel.1</code> \u8bbe\u5907\u521b\u5efa\u65f6\u7684\u8bbe\u7f6e\u7684\u53c2\u6570\uff08VNI\u3001local IP\u3001Port\uff09\u8fdb\u884c VXLAN \u5c01\u5305</li> <li>\u901a\u8fc7\u8282\u70b9 ydzs-node2 \u8ddf ydzs-node1 \u4e4b\u95f4\u7684\u7f51\u7edc\u8fde\u63a5\uff0cVXLAN \u5305\u5230\u8fbe ydzs-node2 \u7684 eth0 \u63a5\u53e3</li> <li>\u901a\u8fc7\u7aef\u53e3 8472\uff0cVXLAN \u5305\u88ab\u8f6c\u53d1\u7ed9 VTEP \u8bbe\u5907 <code>flannel.1</code> \u8fdb\u884c\u89e3\u5305</li> <li>\u89e3\u5c01\u88c5\u540e\u7684 IP \u5305\u5339\u914d\u8282\u70b9 ydzs-node2 \u5f53\u4e2d\u7684\u8def\u7531\u8868\uff0810.244.2.0\uff09\uff0c\u5185\u6838\u5c06 IP \u5305\u8f6c\u53d1\u7ed9<code>cni0</code></li> <li><code>cni0</code>\u5c06 IP \u5305\u8f6c\u53d1\u7ed9\u8fde\u63a5\u5728 <code>cni0</code> \u4e0a\u7684 pod-b</li> </ul>"},{"location":"kubernetes_network/flannel/#host-gw","title":"host-gw","text":"<p><code>host-gw</code> \u5373 Host Gateway\uff0c\u4ece\u540d\u5b57\u4e2d\u5c31\u53ef\u4ee5\u60f3\u5230\u8fd9\u79cd\u65b9\u5f0f\u662f\u901a\u8fc7\u628a\u4e3b\u673a\u5f53\u4f5c\u7f51\u5173\u6765\u5b9e\u73b0\u8de8\u8282\u70b9\u7f51\u7edc\u901a\u4fe1\u7684\u3002\u90a3\u4e48\u5177\u4f53\u5982\u4f55\u5b9e\u73b0\u8de8\u8282\u70b9\u901a\u4fe1\u5462\uff1f</p> <p>\u540c\u7406 UDP \u6a21\u5f0f\u548c VXLAN \u6a21\u5f0f\uff0c\u9996\u5148\u5c06 Backend \u4e2d\u7684 type \u6539\u4e3a<code>host-gw</code>\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u8d58\u8ff0\uff0c\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u968f\u4fbf\u67e5\u770b\u4e00\u4e2a flannel \u7684 Pod \u65e5\u5fd7\uff0c\u5982\u679c\u51fa\u73b0\u5982\u4e0b\u6240\u793a\u7684 </p> <pre><code>Found network config - Backend type: host-gw\n</code></pre> <p>\u65e5\u5fd7\u5c31\u8bc1\u660e\u5df2\u7ecf\u662f <code>host-gw</code> \u6a21\u5f0f\u4e86\uff1a</p> <pre><code>$ kubectl logs -f kube-flannel-ds-amd64-642l6 -n kube-system\nI1129 04:53:309992       1 main.go:527] Using interface with name eth0 and address 159\nI1129 04:53:310292       1 main.go:544] Defaulting external address to interface address (159)\nI1129 04:53:510618       1 kube.go:126] Waiting 10m0s for node controller to sync\nI1129 04:53:607860       1 kube.go:309] Starting kube subnet manager\nI1129 04:53:511530       1 kube.go:133] Node controller sync successful\nI1129 04:53:511624       1 main.go:244] Created subnet manager: Kubernetes Subnet Manager - ydzs-node4\nI1129 04:53:511646       1 main.go:247] Installing signal handlers\nI1129 04:53:511899       1 main.go:386] Found network config - Backend type: host-gw\nI1129 04:53:611040       1 main.go:317] Wrote subnet file to /run/flannel/subnet.env\nI1129 04:53:611120       1 main.go:321] Running backend.\nI1129 04:53:611165       1 main.go:339] Waiting for all goroutines to exit\nI1129 04:53:611280       1 route_network.go:53] Watching for new subnet leases\nI1129 04:53:611768       1 route_network.go:85] Subnet added: 20/24 via 111\nW1129 04:53:612268       1 route_network.go:102] Replacing existing route to 20/24 via 20 dev index 6 with 20/24 via 111 dev index \nI1129 04:53:612705       1 route_network.go:85] Subnet added: 20/24 via 122\nW1129 04:53:612777       1 route_network.go:88] Ignoring non-host-gw subnet: type=vxlan\nI1129 04:53:612829       1 route_network.go:85] Subnet added: 20/24 via 123\nW1129 04:53:612868       1 route_network.go:88] Ignoring non-host-gw subnet: type=vxlan\nI1129 04:53:612935       1 route_network.go:85] Subnet added: 20/24 via 157\nW1129 04:53:612995       1 route_network.go:88] Ignoring non-host-gw subnet: type=vxlan\nI1129 04:53:808989       1 route_network.go:85] Subnet added: 20/24 via 157\nW1129 04:53:809279       1 route_network.go:102] Replacing existing route to 20/24 via 20 dev index 6 with 20/24 via 157 dev index \nI1129 04:53:012832       1 route_network.go:85] Subnet added: 20/24 via 122\nW1129 04:53:013132       1 route_network.go:102] Replacing existing route to 20/24 via 20 dev index 6 with 20/24 via 122 dev index \nI1129 04:53:713684       1 route_network.go:85] Subnet added: 20/24 via 123\nW1129 04:53:714022       1 route_network.go:102] Replacing existing route to 20/24 via 20 dev index 6 with 20/24 via 123 dev index\n</code></pre> <p>\u91c7\u7528 <code>host-gw</code> \u6a21\u5f0f\u540e Flanneld \u7684\u552f\u4e00\u4f5c\u7528\u5c31\u662f<code>\u8d1f\u8d23\u4e3b\u673a\u4e0a\u8def\u7531\u8868\u7684\u52a8\u6001\u66f4\u65b0</code>\uff0c\u5176\u5b9e\u5c31\u662f\u5c06\u6bcf\u4e2a Flannel \u5b50\u7f51\uff08Flannel Subnet\uff0c\u6bd4\u5982\uff1a10.244.1.0/24\uff09\u7684<code>\u4e0b\u4e00\u8df3</code>\uff0c\u8bbe\u7f6e\u6210\u4e86\u8be5\u5b50\u7f51\u5bf9\u5e94\u7684\u5bbf\u4e3b\u673a\u7684 IP \u5730\u5740\uff0c\u5f53\u7136\uff0cFlannel \u5b50\u7f51\u548c\u4e3b\u673a\u7684\u4fe1\u606f\uff0c\u90fd\u662f\u4fdd\u5b58\u5728 etcd \u5f53\u4e2d\u7684\u3002Fanneld \u53ea\u9700\u8981 WACTH \u8fd9\u4e9b\u6570\u636e\u7684\u53d8\u5316\uff0c\u7136\u540e\u5b9e\u65f6\u66f4\u65b0\u8def\u7531\u8868\u5373\u53ef\u3002\u4e3b\u8981\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a</p> <p>1\u3001\u540c UDP\u3001VXLAN \u6a21\u5f0f\u4e00\u81f4\uff0c\u901a\u8fc7\u5bb9\u5668A \u7684\u8def\u7531\u8868 IP \u5305\u5230\u8fbe<code>cni0</code> 2\u3001\u5230\u8fbe <code>cni0</code> \u7684 IP \u5305\u5339\u914d\u5230 ydzs-node1 \u5f53\u4e2d\u7684\u8def\u7531\u89c4\u5219\uff0810.244.2.0\uff09\uff0c\u5e76\u4e14\u7f51\u5173\u4e3a 10.151.30.23\uff0c\u5373\u8282\u70b9 ydzs-node2\uff0c\u6240\u4ee5\u5185\u6838\u5c06 IP \u5305\u53d1\u9001\u7ed9\u8282\u70b9 ydzs-node2\uff0810.151.30.23\uff09:</p> <pre><code>$ route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0         111    0         UG    100    0        0 eth0\n10     0         2220   U     100    0        0 eth0\n20      111    2220   UG    0      0        0 eth0\n20      0         2220   U     0      0        0 cni0\n20      123    2220   UG    0      0        0 eth0\n20      157    2220   UG    0      0        0 eth0\n20      159    2220   UG    0      0        0 eth0\n10      0         220     U     0      0        0 docker0\n</code></pre> <p>3\u3001IP \u5305\u901a\u8fc7\u7269\u7406\u7f51\u7edc\u5230\u8fbe\u8282\u70b9\u7684 ydzs-node2 \u7684 eth0 \u8bbe\u5907 4\u3001\u5230\u8fbe ydzs-node2 \u8282\u70b9 eth0 \u7684 IP \u5305\u5339\u914d\u5230\u8282\u70b9\u5f53\u4e2d\u7684\u8def\u7531\u8868\uff0810.244.2.0/24\uff09\uff0cIP \u5305\u88ab\u8f6c\u53d1\u7ed9 <code>cni0</code> \u8bbe\u5907 5\u3001<code>cni0</code> \u5c06 IP \u5305\u8f6c\u53d1\u7ed9\u8fde\u63a5\u5728 <code>cni0</code> \u4e0a\u7684 pod-b</p> <p>\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u6574\u4e2a\u8de8\u4e3b\u673a\u901a\u4fe1\u6d41\u7a0b\uff0c\u8fd9\u4e2a\u6d41\u7a0b\u53ef\u80fd\u662f\u6700\u7b80\u5355\u6700\u5bb9\u5668\u7406\u89e3\u7684\u6a21\u5f0f\u4e86\uff0c\u800c\u4e14\u5bb9\u5668\u901a\u4fe1\u7684\u8fc7\u7a0b\u8fd8\u514d\u9664\u4e86\u989d\u5916\u7684\u5c01\u5305\u548c\u89e3\u5305\u5e26\u6765\u7684\u6027\u80fd\u635f\u8017\uff0c\u6240\u4ee5\u7406\u8bba\u4e0a\u6027\u80fd\u80af\u5b9a\u8981\u66f4\u597d\uff0c\u4f46\u662f\u8be5\u6a21\u5f0f\u662f\u901a\u8fc7\u8282\u70b9\u4e0a\u7684<code>\u8def\u7531\u8868</code>\u6765\u5b9e\u73b0\u5404\u4e2a\u8282\u70b9\u4e4b\u95f4\u7684\u8de8\u8282\u70b9\u7f51\u7edc\u901a\u4fe1\uff0c\u90a3\u4e48\u5c31\u5f97\u4fdd\u8bc1\u4e24\u4e2a\u8282\u70b9\u662f\u53ef\u4ee5<code>\u76f4\u63a5\u8def\u7531</code>\u8fc7\u53bb\u7684\u3002\u6309\u7167\u5185\u6838\u5f53\u4e2d\u7684\u8def\u7531\u89c4\u5219\uff0c\u7f51\u5173\u5fc5\u987b\u5728\u8ddf\u4e3b\u673a\u5f53\u4e2d\u81f3\u5c11\u4e00\u4e2a IP \u5904\u4e8e\u540c\u4e00\u7f51\u6bb5\uff0c\u6545\u9020\u6210\u7684\u7ed3\u679c\u5c31\u662f\u91c7\u7528<code>host-gw</code> \u8fd9\u79cd\u6a21\u5f0f\u7684\u65f6\u5019\uff0c\u96c6\u7fa4\u4e2d\u6240\u6709\u7684\u8282\u70b9\u5fc5\u987b\u5904\u4e8e\u540c\u4e00\u4e2a\u7f51\u7edc\u5f53\u4e2d\uff0c\u8fd9\u5bf9\u4e8e\u96c6\u7fa4\u89c4\u6a21\u6bd4\u8f83\u5927\u65f6\u9700\u8981\u5bf9\u8282\u70b9\u8fdb\u884c\u7f51\u6bb5\u5212\u5206\u7684\u8bdd\u4f1a\u5b58\u5728\u4e00\u5b9a\u7684\u5c40\u9650\u6027\uff0c\u53e6\u5916\u4e00\u4e2a\u5219\u662f\u968f\u7740\u96c6\u7fa4\u5f53\u4e2d\u8282\u70b9\u89c4\u6a21\u7684\u589e\u5927\uff0cFlanneld \u9700\u8981\u7ef4\u62a4\u4e3b\u673a\u4e0a\u6210\u5343\u4e0a\u4e07\u6761\u8def\u7531\u8868\u7684\u52a8\u6001\u66f4\u65b0\u4e5f\u662f\u4e00\u4e2a\u4e0d\u5c0f\u7684\u538b\u529b\u3002</p> <p>\u9664\u4e86 Flannel \u4e4b\u5916\uff0c<code>Calico</code> \u8fd9\u79cd\u7f51\u7edc\u63d2\u4ef6\u548c Flannel \u7684 <code>host-gw</code> \u6a21\u5f0f\u57fa\u672c\u4e0a\u662f\u4e00\u6837\u7684\uff0c\u90fd\u662f\u5728\u6bcf\u53f0\u4e66\u4e3b\u673a\u4e0a\u9762\u6dfb\u52a0\u5b50\u7f51\u548c\u5bf9\u5e94\u7684\u4e66\u4e3b\u673a\u7684 IP \u5730\u5740\u4e3a\u7f51\u5173\u8fd9\u6837\u7684\u8def\u7531\u4fe1\u606f\uff0c\u4e0d\u8fc7\uff0c\u4e0d\u540c\u4e8e Flannel \u901a\u8fc7 Etcd \u548c\u5bbf\u4e3b\u673a\u4e0a\u7684 flanneld \u6765\u7ef4\u62a4\u8def\u7531\u4fe1\u606f\u7684\u505a\u6cd5\uff0cCalico \u4f7f\u7528 <code>bgp</code> \u6765\u81ea\u52a8\u5730\u5728\u6574\u4e2a\u96c6\u7fa4\u4e2d\u5206\u53d1\u8def\u7531\u4fe1\u606f\u3002</p>"},{"location":"kubernetes_network/policy/","title":"\u7f51\u7edc\u7b56\u7565","text":""},{"location":"kubernetes_network/policy/#networkpolicy","title":"NetworkPolicy","text":"<p>\u5728 Kubernetes \u4e2d\u8981\u5b9e\u73b0\u5bb9\u5668\u4e4b\u95f4\u7f51\u7edc\u7684\u9694\u79bb\uff0c\u662f\u901a\u8fc7\u4e00\u4e2a\u4e13\u95e8\u7684 API \u5bf9\u8c61 <code>NetworkPolicy</code>\uff08\u7f51\u7edc\u7b56\u7565\uff09\u6765\u5b9e\u73b0\u7684\uff0c\u8981\u8ba9\u7f51\u7edc\u7b56\u7565\u751f\u6548\uff0c\u5c31\u9700\u8981\u7279\u5b9a\u7684\u7f51\u7edc\u63d2\u4ef6\u652f\u6301\uff0c\u76ee\u524d\u5df2\u7ecf\u5b9e\u73b0\u4e86 <code>NetworkPolicy</code> \u7684\u7f51\u7edc\u63d2\u4ef6\u5305\u62ec Calico\u3001Weave \u548c kube-router \u7b49\u9879\u76ee\uff0c\u4f46\u662f\u5e76\u4e0d\u5305\u62ec Flannel \u9879\u76ee\u3002\u6240\u4ee5\u8bf4\uff0c\u5982\u679c\u60f3\u8981\u5728\u4f7f\u7528 Flannel \u7684\u540c\u65f6\u8fd8\u4f7f\u7528 NetworkPolicy \u7684\u8bdd\uff0c\u4f60\u5c31\u9700\u8981\u518d\u989d\u5916\u5b89\u88c5\u4e00\u4e2a\u7f51\u7edc\u63d2\u4ef6\uff0c\u6bd4\u5982 Calico \u9879\u76ee\uff0c\u6765\u8d1f\u8d23\u6267\u884c NetworkPolicy\u3002\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f Flannel \u7f51\u7edc\u63d2\u4ef6\uff0c\u6240\u4ee5\u9996\u5148\u9700\u8981\u5b89\u88c5 Calico \u6765\u8d1f\u8d23\u7f51\u7edc\u7b56\u7565\u3002</p>"},{"location":"kubernetes_network/policy/#calico","title":"\u5b89\u88c5 Calico","text":"<p>\u9996\u5148\u786e\u5b9a kube-controller-manager \u914d\u7f6e\u4e86\u5982\u4e0b\u7684\u4e24\u4e2a\u53c2\u6570\uff1a</p> <pre><code>......\nspec:\n  containers:\n  - command:\n    - kube-controller-manager\n    - --allocate-node-cidrs=true\n    - --cluster-cidr=20/16\n......\n</code></pre> <p>\u7136\u540e\u4e0b\u8f7d\u9700\u8981\u4f7f\u7528\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a</p> <pre><code>$ curl https://docs.projectcalico.org/v10/manifests/canal.yaml -O\n</code></pre> <p>\u5982\u679c\u4e4b\u524d\u914d\u7f6e\u7684 pod CIDR \u5c31\u662f <code>10.244.0.0/16</code> \u7f51\u6bb5\uff0c\u5219\u53ef\u4ee5\u8df3\u8fc7\u4e0b\u9762\u7684\u914d\u7f6e\uff0c\u5982\u679c\u4e0d\u540c\u5219\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f\u8fdb\u884c\u66ff\u6362\uff1a</p> <pre><code>$ POD_CIDR=\"&lt;your-pod-cidr&gt;\" \\\\\n$ sed -i -e \"s?20/16?$POD_CIDR?g\" canal.yaml\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f canal.yaml\n</code></pre>"},{"location":"kubernetes_network/policy/#_1","title":"\u7f51\u7edc\u7b56\u7565","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b Pod \u662f\u53ef\u4ee5\u63a5\u6536\u6765\u81ea\u4efb\u4f55\u53d1\u9001\u65b9\u7684\u8bf7\u6c42\uff0c\u4e5f\u53ef\u4ee5\u5411\u4efb\u4f55\u63a5\u6536\u65b9\u53d1\u9001\u8bf7\u6c42\u3002\u800c\u5982\u679c\u6211\u4eec\u8981\u5bf9\u8fd9\u4e2a\u60c5\u51b5\u4f5c\u51fa\u9650\u5236\uff0c\u5c31\u5fc5\u987b\u901a\u8fc7 <code>NetworkPolicy</code> \u5bf9\u8c61\u6765\u6307\u5b9a\u3002</p> <p>\u5982\u4e0b\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u6240\u793a\uff0c\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7f51\u7edc\u7b56\u7565\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a(test-networkpolicy.yaml)</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: test-network-policy\n  namespace: default\nspec:\n  podSelector:\n    matchLabels:\n      role: db\n  policyTypes:\n  - Ingress\n  - Egress\n  ingress:\n  - from:\n    - ipBlock:\n        cidr: 10/16\n        except:\n        - 10/24\n    - namespaceSelector:\n        matchLabels:\n          project: myproject\n    - podSelector:\n        matchLabels:\n          role: frontend\n  - ports:\n    - protocol: TCP\n      port: 80\n  egress:\n  - to:\n    - ipBlock:\n        cidr: 0/24\n    ports:\n    - protocol: TCP\n      port: 5978\n</code></pre> <p>\u4e0e\u6240\u6709\u5176\u4ed6\u7684 Kubernetes \u8d44\u6e90\u5bf9\u8c61\u4e00\u6837\uff0cNetworkPolicy \u9700\u8981 <code>apiVersion</code>\u3001<code>kind</code> \u548c <code>metadata</code> \u5b57\u6bb5\uff0c\u6211\u4eec\u901a\u8fc7 <code>spec.podSelector</code> \u5b57\u6bb5\u5b9a\u4e49\u8fd9\u4e2a NetworkPolicy \u7684\u9650\u5236\u8303\u56f4\uff0c\u56e0\u4e3a NetworkPolicy \u76ee\u524d\u53ea\u652f\u6301\u5b9a\u4e49 <code>ingress</code> \u89c4\u5219\uff0c\u6240\u4ee5\u8fd9\u91cc\u7684 <code>podSelector</code> \u672c\u8d28\u4e0a\u662f\u4e3a\u8be5\u7b56\u7565\u5b9a\u4e49 \u76ee\u6807pod, \u6bd4\u5982\u6211\u4eec\u8fd9\u91cc <code>matchLabels:role=db</code> \u8868\u793a\u7684\u5c31\u662f\u5f53\u524d Namespace \u91cc\u643a\u5e26\u4e86 <code>role=db</code> \u6807\u7b7e\u7684 Pod\u3002\u800c\u5982\u679c\u4f60\u628a <code>podSelector</code> \u5b57\u6bb5\u7559\u7a7a\uff1a</p> <pre><code>spec: \n  podSelector: {}\n</code></pre> <p>\u90a3\u4e48\u8fd9\u4e2a NetworkPolicy \u5c31\u4f1a\u4f5c\u7528\u4e8e\u5f53\u524d Namespace \u4e0b\u7684\u6240\u6709 Pod\u3002</p> <p>\u7136\u540e\u6bcf\u4e2a NetworkPolicy \u5305\u542b\u4e00\u4e2a <code>policyTypes</code> \u5217\u8868\uff0c\u53ef\u4ee5\u662f\u4e00\u4e2a <code>Ingress</code>\u3001<code>Egress</code> \u6216\u8005\u90fd\u5305\u542b\uff0c\u8be5\u5b57\u6bb5\u8868\u793a\u7ed9\u5f53\u524d\u7b56\u7565\u662f\u5426\u5e94\u7528\u4e8e\u6240\u5339\u914d\u7684 Pod \u7684\u5165\u53e3\u6d41\u91cf\u3001\u51fa\u53e3\u6d41\u91cf\u6216\u8005\u4e8c\u8005\u90fd\u5305\u542b\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a <code>policyTypes</code>\uff0c\u5219\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8868\u793a <code>Ingress</code> \u5165\u53e3\u6d41\u91cf\uff0c\u5982\u679c\u914d\u7f6e\u4e86\u4efb\u4f55\u51fa\u53e3\u6d41\u91cf\u89c4\u5219\uff0c\u5219\u5c06\u6307\u5b9a\u4e3a <code>Egress</code>\u3002</p> <p>\u89c4\u5219</p> <p>\u4e00\u65e6 Pod \u88ab NetworkPolicy \u9009\u4e2d\uff0c\u90a3\u4e48\u8fd9\u4e2a Pod \u5c31\u4f1a\u8fdb\u5165<code>\u62d2\u7edd\u6240\u6709\uff08Deny All\uff09</code>\u7684\u72b6\u6001\uff0c\u5373\u8fd9\u4e2a Pod \u65e2\u4e0d\u5141\u8bb8\u88ab\u5916\u754c\u8bbf\u95ee\uff0c\u4e5f\u4e0d\u5141\u8bb8\u5bf9\u5916\u754c\u53d1\u8d77\u8bbf\u95ee\uff0c\u6240\u4ee5 NetworkPolicy \u5b9a\u4e49\u7684\u89c4\u5219\uff0c\u5176\u5b9e\u5c31\u662f\u767d\u540d\u5355\u4e86\u3002</p> <p>\u6bd4\u5982\u4e0a\u9762\u793a\u4f8b\u8868\u793a\u7684\u662f\u8be5\u9694\u79bb\u89c4\u5219\u53ea\u5bf9 default \u547d\u540d\u7a7a\u95f4\u4e0b\u7684\uff0c\u643a\u5e26\u4e86 <code>role=db</code> \u6807\u7b7e\u7684 Pod \u6709\u6548\u3002\u9650\u5236\u7684\u8bf7\u6c42\u7c7b\u578b\u5305\u62ec ingress\uff08\u6d41\u5165\uff09\u548c egress\uff08\u6d41\u51fa\uff09\u3002</p> <p><code>ingress</code>: \u6bcf\u4e2a NetworkPolicy \u5305\u542b\u4e00\u4e2a ingress \u89c4\u5219\u7684\u767d\u540d\u5355\u5217\u8868\u3002\u5176\u4e2d\u7684\u89c4\u5219\u5141\u8bb8\u540c\u65f6\u5339\u914d <code>from</code> \u548c <code>ports</code> \u90e8\u5206\u7684\u6d41\u91cf\u3002\u6bd4\u5982\u4e0a\u9762\u793a\u4f8b\u4e2d\u6211\u4eec\u914d\u7f6e\u7684\u5165\u53e3\u6d41\u91cf\u89c4\u5219\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>ingress:\n  - from:\n    - ipBlock:\n        cidr: 10/16\n        except:\n        - 10/24\n    - namespaceSelector:\n        matchLabels:\n          project: myproject\n    - podSelector:\n        matchLabels:\n          role: frontend\n  - ports:\n    - protocol: TCP\n      port: 80\n</code></pre> <p>\u8fd9\u91cc\u7684 ingress \u89c4\u5219\u4e2d\u6211\u4eec\u5b9a\u4e49\u4e86 <code>from</code> \u548c <code>ports</code>\uff0c\u8868\u793a\u5141\u8bb8\u6d41\u5165\u7684<code>\u767d\u540d\u5355</code>\u548c\u7aef\u53e3\uff0c\u4e0a\u9762\u6211\u4eec\u4e5f\u8bf4\u4e86 Kubernetes \u4f1a\u62d2\u7edd\u4efb\u4f55\u8bbf\u95ee\u88ab\u9694\u79bb Pod \u7684\u8bf7\u6c42\uff0c\u9664\u975e\u8fd9\u4e2a\u8bf7\u6c42\u6765\u81ea\u4e8e\u4ee5\u4e0b\u767d\u540d\u5355\u91cc\u7684\u5bf9\u8c61\uff0c\u5e76\u4e14\u8bbf\u95ee\u7684\u662f\u88ab\u9694\u79bb Pod \u7684 8- \u7aef\u53e3\u3002\u800c\u8fd9\u4e2a\u5141\u8bb8\u6d41\u5165\u7684<code>\u767d\u540d\u5355</code>\u4e2d\u6307\u5b9a\u4e86\u4e09\u79cd\u5e76\u5217\u7684\u60c5\u51b5\uff0c\u5206\u522b\u662f\uff1a<code>ipBlock</code>\u3001<code>namespaceSelector</code> \u548c <code>podSelector</code>\uff1a</p> <ul> <li>default \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u5e26\u6709 <code>role=frontend</code> \u6807\u7b7e\u7684 Pod</li> <li>\u5e26\u6709 <code>project=myproject</code> \u6807\u7b7e\u7684 Namespace \u4e0b\u7684\u4efb\u4f55 Pod</li> <li>\u4efb\u4f55\u6e90\u5730\u5740\u5c5e\u4e8e <code>172.17.0.0/16</code> \u7f51\u6bb5\uff0c\u4e14\u4e0d\u5c5e\u4e8e <code>172.17.1.0/24</code> \u7f51\u6bb5\u7684\u8bf7\u6c42\u3002</li> </ul> <p><code>egress</code>: \u6bcf\u4e2a NetworkPolicy \u5305\u542b\u4e00\u4e2a egress \u89c4\u5219\u7684\u767d\u540d\u5355\u5217\u8868\u3002\u6bcf\u4e2a\u89c4\u5219\u90fd\u5141\u8bb8\u5339\u914d <code>to</code> \u548c <code>port</code> \u90e8\u5206\u7684\u6d41\u91cf\u3002\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u793a\u4f8b\u89c4\u5219\u7684\u914d\u7f6e\uff1a</p> <pre><code>egress:\n  - to:\n    - ipBlock:\n        cidr: 0/24\n    ports:\n    - protocol: TCP\n      port: 5978\n</code></pre> <p>\u8868\u793a Kubernetes \u4f1a\u62d2\u7edd\u88ab\u9694\u79bb Pod \u5bf9\u5916\u53d1\u8d77\u4efb\u4f55\u8bf7\u6c42\uff0c\u9664\u975e\u8bf7\u6c42\u7684\u76ee\u7684\u5730\u5740\u5c5e\u4e8e <code>10.0.0.0/24</code> \u7f51\u6bb5\uff0c\u5e76\u4e14\u8bbf\u95ee\u7684\u662f\u8be5\u7f51\u6bb5\u5730\u5740\u7684 <code>5978</code> \u7aef\u53e3\u3002</p>"},{"location":"kubernetes_network/policy/#_2","title":"\u6d4b\u8bd5","text":"<p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u521b\u5efa\u4e00\u4e2a Pod\uff0c\u5e26\u6709 <code>role=db</code> \u7684 Label \u6807\u7b7e\uff1a(test-networkpolicy-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: test-networkpolicy\n  labels:\n    role: db\nspec:\n  containers:\n  - name: testnp\n    image: nginx\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl apply -f test-networkpolicy-pod.yaml\n$ kubectl get pods -o wide\nNAME                        READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES\npod-a                       1/1     Running   4          4h3m    2236   ydzs-node1   &lt;none&gt;           &lt;none&gt;\npod-b                       1/1     Running   4          4h3m    2123   ydzs-node2   &lt;none&gt;           &lt;none&gt;\ntest-networkpolicy          1/1     Running   0          4m49s   22     ydzs-node3   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u7528\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684 Pod \u6765\u5bf9\u8fd9\u4e2a Pod \u53d1\u8d77\u4e00\u4e2a\u7f51\u7edc\u8bf7\u6c42\uff1a</p> <pre><code>$ kubectl exec pod-a wget 22\nConnecting to 22 (22:80)\nsaving to 'index.html'\nindex.html           100% |********************************|   612  0:00:00 ETA\n'index.html' saved\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u53ef\u4ee5\u6210\u529f\u8bf7\u6c42\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u6765\u521b\u5efa\u4e0a\u9762\u7684 NetworkPolicy \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f test-networkpolicy.yaml\nnetworkpolicy.networking.k8s.io/test-network-policy created\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u7f51\u7edc\u7b56\u7565\uff0c\u7531\u4e8e\u5339\u914d\u4e86\u7f51\u7edc\u7b56\u7565\u7684\u5c31\u4f1a\u62d2\u7edd\u6240\u6709\u7684\u7f51\u7edc\u8bf7\u6c42\uff0c\u9700\u8981\u901a\u8fc7\u767d\u540d\u5355\u6765\u8fdb\u884c\u5f00\u542f\u8bf7\u6c42\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u7684\u6d4b\u8bd5 Pod \u660e\u663e\u6ca1\u6709\u5728\u767d\u540d\u5355\u4e4b\u4e2d\uff0c\u6240\u4ee5\u5c31\u4f1a\u62d2\u7edd\u7f51\u7edc\u8bf7\u6c42\u4e86\uff1a</p> <pre><code>$ kubectl exec pod-a wget 22\nConnecting to 22 (22:80)\n# \u8bf7\u6c42\u4f1a\u4e00\u76f4 hang \u4f4f\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u7528 NetworkPolicy \u767d\u540d\u5355\u91cc\u9762\u5339\u914d\u7684 Pod \u6765\u5bf9\u4e0a\u9762\u7684 Pod \u53d1\u8d77\u7f51\u7edc\u8bf7\u6c42\uff0c\u6bd4\u5982\u5728\u5e26\u6709\u6807\u7b7e <code>project=myproject</code> \u7684 Namespace \u4e0b\u9762\u7684 Pod \u6765\u53d1\u8d77\u7f51\u7edc\u8bf7\u6c42\uff0c\u6216\u8005\u7ed9 pod-a \u52a0\u4e0a\u4e00\u4e2a <code>role=frontend</code> \u7684\u6807\u7b7e\uff1a</p> <pre><code>$ kubectl label pod pod-a role=frontend\npod/pod-a labeled\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u91cd\u65b0\u53d1\u8d77\u4e00\u4e2a\u7f51\u7edc\u8bf7\u6c42\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u53ef\u4ee5\u6210\u529f\u4e86\uff0c\u56e0\u4e3a\u6211\u4eec\u8bbf\u95ee\u7684 Pod \u8fdb\u7a0b\u9ed8\u8ba4\u7684\u7aef\u53e3\u5c31\u662f 80 \u7aef\u53e3\uff0c\u662f\u5339\u914d\u767d\u540d\u5355\u7684\uff1a</p> <pre><code>$ kubectl exec pod-a -- wget 22 -O-\nConnecting to 22 (22:80)\nwriting to stdout\n-                    100% |********************************|   612  0:00:00 ETA\nwritten to stdout\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6210\u529f\u4e86\uff0cKubernetes \u7684 NetworkPolicy \u5b9e\u73b0\u4e86\u8bbf\u95ee\u63a7\u5236\uff0c\u4f9d\u8d56\u7684\u5e95\u5c42\u662f\u4f9d\u9760\u7f51\u7edc\u63d2\u4ef6\u6dfb\u52a0 iptables \u89c4\u5219\u6765\u8fdb\u884c\u63a7\u5236\u7684\uff0c\u4f46\u662f\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90fd\u9700\u8981\u914d\u7f6e\u5927\u91cf iptables \u89c4\u5219\uff0c\u52a0\u4e0a\u4e0d\u540c\u7ef4\u5ea6\u63a7\u5236\u7684\u589e\u52a0\uff0c\u5bfc\u81f4\u8fd0\u7ef4\u3001\u6392\u969c\u96be\u5ea6\u8f83\u5927\uff0c\u6240\u4ee5\u5982\u679c\u4e0d\u662f\u7279\u522b\u9700\u8981\u7684\u573a\u666f\uff0c\u6700\u597d\u4e0d\u8981\u4f7f\u7528\u4e86\u3002</p>"},{"location":"kubernetes_network/service/","title":"Service \u670d\u52a1","text":""},{"location":"kubernetes_network/service/#service","title":"Service","text":"<p>\u6211\u4eec\u524d\u9762\u7684\u8bfe\u7a0b\u4e2d\u5b66\u4e60\u4e86\u4e00\u4e9b\u5e38\u7528\u63a7\u5236\u5668\u7684\u57fa\u672c\u7528\u6cd5\uff0c\u6211\u4eec\u4e5f\u4e86\u89e3\u5230 Pod \u7684\u751f\u547d\u662f\u6709\u9650\u7684\uff0c\u6b7b\u4ea1\u8fc7\u540e\u4e0d\u4f1a\u590d\u6d3b\u4e86\u3002\u7136\u540e\u6211\u4eec\u77e5\u9053\u53ef\u4ee5\u7528 ReplicaSet \u548cDeployment \u6765\u52a8\u6001\u7684\u521b\u5efa\u548c\u9500\u6bc1 Pod\uff0c\u6bcf\u4e2a Pod \u90fd\u6709\u81ea\u5df1\u7684 IP \u5730\u5740\uff0c\u4f46\u662f\u5982\u679c Pod \u91cd\u5efa\u4e86\u7684\u8bdd\u90a3\u4e48\u4ed6\u7684 IP \u5f88\u6709\u53ef\u80fd\u4e5f\u5c31\u53d8\u5316\u4e86\u3002\u8fd9\u5c31\u4f1a\u5e26\u6765\u4e00\u4e2a\u95ee\u9898\uff1a\u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e9b\u540e\u7aef\u7684 Pod \u96c6\u5408\u4e3a\u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6\u5e94\u7528\u63d0\u4f9b API \u670d\u52a1\uff0c\u5982\u679c\u6211\u4eec\u5728\u524d\u7aef\u5e94\u7528\u4e2d\u628a\u6240\u6709\u7684\u8fd9\u4e9b\u540e\u7aef\u7684 Pod \u7684\u5730\u5740\u90fd\u5199\u6b7b\uff0c\u7136\u540e\u4ee5\u67d0\u79cd\u65b9\u5f0f\u53bb\u8bbf\u95ee\u5176\u4e2d\u4e00\u4e2a Pod \u7684\u670d\u52a1\uff0c\u8fd9\u6837\u770b\u4e0a\u53bb\u662f\u53ef\u4ee5\u5de5\u4f5c\u7684\uff0c\u5bf9\u5427\uff1f\u4f46\u662f\u5982\u679c\u8fd9\u4e2a Pod \u6302\u6389\u4e86\uff0c\u7136\u540e\u91cd\u65b0\u542f\u52a8\u8d77\u6765\u4e86\uff0c\u662f\u4e0d\u662f IP \u5730\u5740\u975e\u5e38\u6709\u53ef\u80fd\u5c31\u53d8\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u524d\u7aef\u5c31\u6781\u5927\u53ef\u80fd\u8bbf\u95ee\u4e0d\u5230\u540e\u7aef\u7684\u670d\u52a1\u4e86\u3002</p> <p>\u9047\u5230\u8fd9\u6837\u7684\u95ee\u9898\u8be5\u600e\u4e48\u89e3\u51b3\u5462\uff1f\u5728\u6ca1\u6709\u4f7f\u7528 Kubernetes \u4e4b\u524d\uff0c\u6211\u76f8\u4fe1\u53ef\u80fd\u5f88\u591a\u540c\u5b66\u90fd\u9047\u5230\u8fc7\u8fd9\u6837\u7684\u95ee\u9898\uff0c\u4e0d\u4e00\u5b9a\u662f IP \u53d8\u5316\u7684\u95ee\u9898\uff0c\u6bd4\u5982\u6211\u4eec\u5728\u90e8\u7f72\u4e00\u4e2aWEB \u670d\u52a1\u7684\u65f6\u5019\uff0c\u524d\u7aef\u4e00\u822c\u90e8\u7f72\u4e00\u4e2a Nginx \u4f5c\u4e3a\u670d\u52a1\u7684\u5165\u53e3\uff0c\u7136\u540e Nginx \u540e\u9762\u80af\u5b9a\u5c31\u662f\u6302\u8f7d\u7684\u8fd9\u4e2a\u670d\u52a1\u7684\u5927\u91cf\u540e\u7aef\u670d\u52a1\uff0c\u5f88\u65e9\u4ee5\u524d\u6211\u4eec\u53ef\u80fd\u662f\u53bb\u624b\u52a8\u66f4\u6539Nginx \u914d\u7f6e\u4e2d\u7684 upstream \u9009\u9879\uff0c\u6765\u52a8\u6001\u6539\u53d8\u63d0\u4f9b\u670d\u52a1\u7684\u6570\u91cf\uff0c\u5230\u540e\u9762\u51fa\u73b0\u4e86\u4e00\u4e9b\u670d\u52a1\u53d1\u73b0\u7684\u5de5\u5177\uff0c\u6bd4\u5982 Consul\u3001ZooKeeper \u8fd8\u6709\u6211\u4eec\u719f\u6089\u7684 etcd \u7b49\u5de5\u5177\uff0c\u6709\u4e86\u8fd9\u4e9b\u5de5\u5177\u8fc7\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u53ea\u9700\u8981\u628a\u6211\u4eec\u7684\u670d\u52a1\u6ce8\u518c\u5230\u8fd9\u4e9b\u670d\u52a1\u53d1\u73b0\u4e2d\u5fc3\u53bb\u5c31\u53ef\u4ee5\uff0c\u7136\u540e\u8ba9\u8fd9\u4e9b\u5de5\u5177\u52a8\u6001\u7684\u53bb\u66f4\u65b0 Nginx \u7684\u914d\u7f6e\u5c31\u53ef\u4ee5\u4e86\uff0c\u6211\u4eec\u5b8c\u5168\u4e0d\u7528\u53bb\u624b\u5de5\u7684\u64cd\u4f5c\u4e86\uff0c\u662f\u4e0d\u662f\u975e\u5e38\u65b9\u4fbf\u3002</p> <p></p> <p>\u540c\u6837\u7684\uff0c\u8981\u89e3\u51b3\u6211\u4eec\u4e0a\u9762\u9047\u5230\u7684\u95ee\u9898\u662f\u4e0d\u662f\u5b9e\u73b0\u4e00\u4e2a\u670d\u52a1\u53d1\u73b0\u7684\u5de5\u5177\u4e5f\u53ef\u4ee5\u89e3\u51b3\uff1f\u6ca1\u9519\u7684\uff0c\u5f53\u6211\u4eec Pod \u88ab\u9500\u6bc1\u6216\u8005\u65b0\u5efa\u8fc7\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u8fd9\u4e2a Pod \u7684\u5730\u5740\u6ce8\u518c\u5230\u8fd9\u4e2a\u670d\u52a1\u53d1\u73b0\u4e2d\u5fc3\u53bb\u5c31\u53ef\u4ee5\uff0c\u4f46\u662f\u8fd9\u6837\u7684\u8bdd\u6211\u4eec\u7684\u524d\u7aef\u5e94\u7528\u5c31\u4e0d\u80fd\u76f4\u63a5\u53bb\u8fde\u63a5\u540e\u53f0\u7684 Pod \u96c6\u5408\u4e86\uff0c\u5e94\u8be5\u8fde\u63a5\u5230\u4e00\u4e2a\u80fd\u591f\u505a\u670d\u52a1\u53d1\u73b0\u7684\u4e2d\u95f4\u4ef6\u4e0a\u9762\uff0c\u5bf9\u5427\uff1f</p> <p>\u4e3a\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898 Kubernetes \u5c31\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u8fd9\u6837\u7684\u4e00\u4e2a\u5bf9\u8c61 - Service\uff0cService \u662f\u4e00\u79cd\u62bd\u8c61\u7684\u5bf9\u8c61\uff0c\u5b83\u5b9a\u4e49\u4e86\u4e00\u7ec4 Pod \u7684\u903b\u8f91\u96c6\u5408\u548c\u4e00\u4e2a\u7528\u4e8e\u8bbf\u95ee\u5b83\u4eec\u7684\u7b56\u7565\uff0c\u5176\u5b9e\u8fd9\u4e2a\u6982\u5ff5\u548c\u5fae\u670d\u52a1\u975e\u5e38\u7c7b\u4f3c\u3002\u4e00\u4e2a Serivce \u4e0b\u9762\u5305\u542b\u7684 Pod \u96c6\u5408\u662f\u7531 Label Selector \u6765\u51b3\u5b9a\u7684\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u4e0a\u9762\u7684\u4f8b\u5b50\uff0c\u5047\u5982\u6211\u4eec\u540e\u7aef\u8fd0\u884c\u4e863\u4e2a\u526f\u672c\uff0c\u8fd9\u4e9b\u526f\u672c\u90fd\u662f\u53ef\u4ee5\u66ff\u4ee3\u7684\uff0c\u56e0\u4e3a\u524d\u7aef\u5e76\u4e0d\u5173\u5fc3\u5b83\u4eec\u4f7f\u7528\u7684\u662f\u54ea\u4e00\u4e2a\u540e\u7aef\u670d\u52a1\u3002\u5c3d\u7ba1\u7531\u4e8e\u5404\u79cd\u539f\u56e0\u540e\u7aef\u7684 Pod \u96c6\u5408\u4f1a\u53d1\u9001\u53d8\u5316\uff0c\u4f46\u662f\u524d\u7aef\u5374\u4e0d\u9700\u8981\u77e5\u9053\u8fd9\u4e9b\u53d8\u5316\uff0c\u4e5f\u4e0d\u9700\u8981\u81ea\u5df1\u7528\u4e00\u4e2a\u5217\u8868\u6765\u8bb0\u5f55\u8fd9\u4e9b\u540e\u7aef\u7684\u670d\u52a1\uff0cService \u7684\u8fd9\u79cd\u62bd\u8c61\u5c31\u53ef\u4ee5\u5e2e\u6211\u4eec\u8fbe\u5230\u8fd9\u79cd\u89e3\u8026\u7684\u76ee\u7684\u3002</p>"},{"location":"kubernetes_network/service/#ip","title":"\u4e09\u79cdIP","text":"<p>\u5728\u7ee7\u7eed\u5f80\u4e0b\u5b66\u4e60 Service \u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u5f04\u660e\u767d Kubernetes \u7cfb\u7edf\u4e2d\u7684\u4e09\u79cdIP\uff0c\u56e0\u4e3a\u7ecf\u5e38\u6709\u540c\u5b66\u6df7\u4e71\u3002</p> <ul> <li>Node IP\uff1aNode \u8282\u70b9\u7684 IP \u5730\u5740</li> <li>Pod IP: Pod \u7684 IP \u5730\u5740</li> <li>Cluster IP: Service \u7684 IP \u5730\u5740</li> </ul> <p>\u9996\u5148\uff0cNode IP \u662f Kubernetes \u96c6\u7fa4\u4e2d\u8282\u70b9\u7684\u7269\u7406\u7f51\u5361 IP \u5730\u5740(\u4e00\u822c\u4e3a\u5185\u7f51)\uff0c\u6240\u6709\u5c5e\u4e8e\u8fd9\u4e2a\u7f51\u7edc\u7684\u670d\u52a1\u5668\u4e4b\u95f4\u90fd\u53ef\u4ee5\u76f4\u63a5\u901a\u4fe1\uff0c\u6240\u4ee5 Kubernetes \u96c6\u7fa4\u5916\u8981\u60f3\u8bbf\u95ee Kubernetes \u96c6\u7fa4\u5185\u90e8\u7684\u67d0\u4e2a\u8282\u70b9\u6216\u8005\u670d\u52a1\uff0c\u80af\u5b9a\u5f97\u901a\u8fc7 Node IP \u8fdb\u884c\u901a\u4fe1\uff08\u8fd9\u4e2a\u65f6\u5019\u4e00\u822c\u662f\u901a\u8fc7\u5916\u7f51 IP \u4e86\uff09</p> <p>\u7136\u540e Pod IP \u662f\u6bcf\u4e2a Pod \u7684 IP \u5730\u5740\uff0c\u5b83\u662f\u7f51\u7edc\u63d2\u4ef6\u8fdb\u884c\u5206\u914d\u7684\uff0c\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u8bb2\u89e3\u8fc7</p> <p>\u6700\u540e Cluster IP \u662f\u4e00\u4e2a\u865a\u62df\u7684 IP\uff0c\u4ec5\u4ec5\u4f5c\u7528\u4e8e Kubernetes Service \u8fd9\u4e2a\u5bf9\u8c61\uff0c\u7531 Kubernetes \u81ea\u5df1\u6765\u8fdb\u884c\u7ba1\u7406\u548c\u5206\u914d\u5730\u5740\u3002</p>"},{"location":"kubernetes_network/service/#service_1","title":"\u5b9a\u4e49 Service","text":"<p>\u5b9a\u4e49 Service \u7684\u65b9\u5f0f\u548c\u6211\u4eec\u524d\u9762\u5b9a\u4e49\u7684\u5404\u79cd\u8d44\u6e90\u5bf9\u8c61\u7684\u65b9\u5f0f\u7c7b\u578b\uff0c\u4f8b\u5982\uff0c\u5047\u5b9a\u6211\u4eec\u6709\u4e00\u7ec4 Pod \u670d\u52a1\uff0c\u5b83\u4eec\u5bf9\u5916\u66b4\u9732\u4e86 8080 \u7aef\u53e3\uff0c\u540c\u65f6\u90fd\u88ab\u6253\u4e0a\u4e86 app=myapp \u8fd9\u6837\u7684\u6807\u7b7e\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u50cf\u4e0b\u9762\u8fd9\u6837\u6765\u5b9a\u4e49\u4e00\u4e2a Service \u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: myservice\nspec:\n  selector:\n    app: myapp\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 8080\n    name: myapp-http\n</code></pre> <p>\u7136\u540e\u901a\u8fc7\u7684\u4f7f\u7528 </p> <pre><code>kubectl create -f myservice.yaml\n</code></pre> <p>\u5c31\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a myservice \u7684 Service \u5bf9\u8c61\uff0c\u5b83\u4f1a\u5c06\u8bf7\u6c42\u4ee3\u7406\u5230\u4f7f\u7528 TCP \u7aef\u53e3\u4e3a 8080\uff0c\u5177\u6709\u6807\u7b7e <code>app=myapp</code> \u7684 Pod \u4e0a\uff0c\u8fd9\u4e2a Service \u4f1a\u88ab\u7cfb\u7edf\u5206\u914d\u4e00\u4e2a\u6211\u4eec\u4e0a\u9762\u8bf4\u7684 Cluster IP\uff0c\u8be5 Service \u8fd8\u4f1a\u6301\u7eed\u7684\u76d1\u542c selector \u4e0b\u9762\u7684 Pod\uff0c\u4f1a\u628a\u8fd9\u4e9b Pod \u4fe1\u606f\u66f4\u65b0\u5230\u4e00\u4e2a\u540d\u4e3a myservice \u7684Endpoints \u5bf9\u8c61\u4e0a\u53bb\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u5c31\u7c7b\u4f3c\u4e8e\u6211\u4eec\u4e0a\u9762\u8bf4\u7684 Pod \u96c6\u5408\u4e86\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cService \u80fd\u591f\u5c06\u4e00\u4e2a\u63a5\u6536\u7aef\u53e3\u6620\u5c04\u5230\u4efb\u610f\u7684 targetPort\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0ctargetPort \u5c06\u88ab\u8bbe\u7f6e\u4e3a\u4e0e port \u5b57\u6bb5\u76f8\u540c\u7684\u503c\u3002\u53ef\u80fd\u66f4\u6709\u8da3\u7684\u662f\uff0ctargetPort \u53ef\u4ee5\u662f\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u5f15\u7528\u4e86 backend Pod \u7684\u4e00\u4e2a\u7aef\u53e3\u7684\u540d\u79f0\u3002\u56e0\u5b9e\u9645\u6307\u6d3e\u7ed9\u8be5\u7aef\u53e3\u540d\u79f0\u7684\u7aef\u53e3\u53f7\uff0c\u5728\u6bcf\u4e2a backend Pod \u4e2d\u53ef\u80fd\u5e76\u4e0d\u76f8\u540c\uff0c\u6240\u4ee5\u5bf9\u4e8e\u90e8\u7f72\u548c\u8bbe\u8ba1 Service\uff0c\u8fd9\u79cd\u65b9\u5f0f\u4f1a\u63d0\u4f9b\u66f4\u5927\u7684\u7075\u6d3b\u6027\u3002</p> <p>\u53e6\u5916 Service \u80fd\u591f\u652f\u6301 TCP \u548c UDP \u534f\u8bae\uff0c\u9ed8\u8ba4\u662f TCP \u534f\u8bae\u3002</p>"},{"location":"kubernetes_network/service/#kube-proxy","title":"kube-proxy","text":"<p>\u524d\u9762\u6211\u4eec\u8bb2\u5230\u8fc7\uff0c\u5728 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u6bcf\u4e2a Node \u4f1a\u8fd0\u884c\u4e00\u4e2a kube-proxy \u8fdb\u7a0b, \u8d1f\u8d23\u4e3a Service \u5b9e\u73b0\u4e00\u79cd VIP\uff08\u865a\u62df IP\uff0c\u5c31\u662f\u6211\u4eec\u4e0a\u9762\u8bf4\u7684 clusterIP\uff09\u7684\u4ee3\u7406\u5f62\u5f0f\uff0c\u73b0\u5728\u7684 Kubernetes \u4e2d\u9ed8\u8ba4\u662f\u4f7f\u7528\u7684 iptables \u8fd9\u79cd\u6a21\u5f0f\u6765\u4ee3\u7406\u3002</p>"},{"location":"kubernetes_network/service/#iptables","title":"iptables","text":"<p>\u8fd9\u79cd\u6a21\u5f0f\uff0ckube-proxy \u4f1a\u76d1\u89c6 apiserver \u5bf9 Service \u5bf9\u8c61\u548c Endpoints \u5bf9\u8c61\u7684\u6dfb\u52a0\u548c\u79fb\u9664\u3002\u5bf9\u6bcf\u4e2a Service\uff0c\u5b83\u4f1a\u6dfb\u52a0\u4e0a iptables \u89c4\u5219\uff0c\u4ece\u800c\u6355\u83b7\u5230\u8fbe\u8be5 Service \u7684 clusterIP\uff08\u865a\u62df IP\uff09\u548c\u7aef\u53e3\u7684\u8bf7\u6c42\uff0c\u8fdb\u800c\u5c06\u8bf7\u6c42\u91cd\u5b9a\u5411\u5230 Service \u7684\u4e00\u7ec4 backend \u4e2d\u7684\u67d0\u4e00\u4e2a Pod \u4e0a\u9762\u3002\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 <code>Pod readiness \u63a2\u9488</code> \u9a8c\u8bc1\u540e\u7aef Pod \u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\uff0c\u4ee5\u4fbf iptables \u6a21\u5f0f\u4e0b\u7684 kube-proxy \u4ec5\u770b\u5230\u6d4b\u8bd5\u6b63\u5e38\u7684\u540e\u7aef\uff0c\u8fd9\u6837\u505a\u610f\u5473\u7740\u53ef\u4ee5\u907f\u514d\u5c06\u6d41\u91cf\u901a\u8fc7 <code>kube-proxy</code> \u53d1\u9001\u5230\u5df2\u77e5\u5931\u8d25\u7684 Pod \u4e2d\uff0c\u6240\u4ee5\u5bf9\u4e8e\u7ebf\u4e0a\u7684\u5e94\u7528\u6765\u8bf4\u4e00\u5b9a\u8981\u505a readiness \u63a2\u9488\u3002</p> <p></p> <p>iptables \u6a21\u5f0f\u7684 kube-proxy \u9ed8\u8ba4\u7684\u7b56\u7565\u662f\uff0c\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u540e\u7aef Pod\u3002</p> <p>\u6bd4\u5982\u5f53\u521b\u5efa backend Service \u65f6\uff0cKubernetes \u4f1a\u7ed9\u5b83\u6307\u6d3e\u4e00\u4e2a\u865a\u62df IP \u5730\u5740\uff0c\u6bd4\u5982 10.0.0.1\u3002\u5047\u8bbe Service \u7684\u7aef\u53e3\u662f 1234\uff0c\u8be5 Service \u4f1a\u88ab\u96c6\u7fa4\u4e2d\u6240\u6709\u7684 kube-proxy \u5b9e\u4f8b\u89c2\u5bdf\u5230\u3002\u5f53 kube-proxy \u770b\u5230\u4e00\u4e2a\u65b0\u7684 Service\uff0c\u5b83\u4f1a\u5b89\u88c5\u4e00\u7cfb\u5217\u7684 iptables \u89c4\u5219\uff0c\u4ece VIP \u91cd\u5b9a\u5411\u5230 <code>per-Service</code> \u89c4\u5219\u3002 \u8be5 <code>per-Service</code> \u89c4\u5219\u8fde\u63a5\u5230 <code>per-Endpoint</code> \u89c4\u5219\uff0c\u8be5 <code>per-Endpoint</code> \u89c4\u5219\u4f1a\u91cd\u5b9a\u5411\uff08\u76ee\u6807 <code>NAT</code>\uff09\u5230\u540e\u7aef\u7684 Pod\u3002</p>"},{"location":"kubernetes_network/service/#ipvs","title":"ipvs","text":"<p>\u9664\u4e86 iptables \u6a21\u5f0f\u4e4b\u5916\uff0ckubernetes \u4e5f\u652f\u6301 ipvs \u6a21\u5f0f\uff0c\u5728 ipvs \u6a21\u5f0f\u4e0b\uff0ckube-proxy \u76d1\u89c6 Kubernetes \u670d\u52a1\u548c\u7aef\u70b9\uff0c\u8c03\u7528 <code>netlink</code> \u63a5\u53e3\u76f8\u5e94\u5730\u521b\u5efa IPVS \u89c4\u5219\uff0c \u5e76\u5b9a\u671f\u5c06 IPVS \u89c4\u5219\u4e0e Kubernetes \u670d\u52a1\u548c\u7aef\u70b9\u540c\u6b65\u3002\u8be5\u63a7\u5236\u5faa\u73af\u53ef\u786e\u4fdd IPVS \u72b6\u6001\u4e0e\u6240\u9700\u72b6\u6001\u5339\u914d\u3002\u8bbf\u95ee\u670d\u52a1\u65f6\uff0cIPVS\u3000\u5c06\u6d41\u91cf\u5b9a\u5411\u5230\u540e\u7aef Pod \u4e4b\u4e00\u3002</p> <p>IPVS \u4ee3\u7406\u6a21\u5f0f\u57fa\u4e8e\u7c7b\u4f3c\u4e8e iptables \u6a21\u5f0f\u7684 netfilter \u94a9\u5b50\u51fd\u6570\uff0c\u4f46\u662f\u4f7f\u7528<code>\u54c8\u5e0c\u8868</code>\u4f5c\u4e3a\u57fa\u7840\u6570\u636e\u7ed3\u6784\uff0c\u5e76\u4e14\u5728\u5185\u6838\u7a7a\u95f4\u4e2d\u5de5\u4f5c\u3002 \u6240\u4ee5\u4e0e iptables \u6a21\u5f0f\u4e0b\u7684 kube-proxy \u76f8\u6bd4\uff0cIPVS \u6a21\u5f0f\u4e0b\u7684 kube-proxy \u91cd\u5b9a\u5411\u901a\u4fe1\u7684\u5ef6\u8fdf\u8981\u77ed\uff0c\u5e76\u4e14\u5728\u540c\u6b65\u4ee3\u7406\u89c4\u5219\u65f6\u5177\u6709\u66f4\u597d\u7684\u6027\u80fd\u3002\u4e0e\u5176\u4ed6\u4ee3\u7406\u6a21\u5f0f\u76f8\u6bd4\uff0cIPVS \u6a21\u5f0f\u8fd8\u652f\u6301\u66f4\u9ad8\u7684\u7f51\u7edc\u6d41\u91cf\u541e\u5410\u91cf\u3002\u6240\u4ee5\u5bf9\u4e8e\u8f83\u5927\u89c4\u6a21\u7684\u96c6\u7fa4\u4f1a\u4f7f\u7528 ipvs \u6a21\u5f0f\u7684 kube-proxy\uff0c\u53ea\u9700\u8981\u6ee1\u8db3\u8282\u70b9\u4e0a\u8fd0\u884c ipvs \u7684\u6761\u4ef6\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u5c06 kube-proxy \u7684\u6a21\u5f0f\u4fee\u6539\u4e3a ipvs\uff0c\u5982\u679c\u4e0d\u6ee1\u8db3\u8fd0\u884c\u6761\u4ef6\u4f1a\u81ea\u52a8\u964d\u7ea7\u4e3a iptables \u6a21\u5f0f\uff0c\u73b0\u5728\u90fd\u63a8\u8350\u4f7f\u7528 ipvs \u6a21\u5f0f\uff0c\u53ef\u4ee5\u5927\u5e45\u5ea6\u63d0\u9ad8 Service \u6027\u80fd\u3002</p> <p>IPVS \u63d0\u4f9b\u4e86\u66f4\u591a\u9009\u9879\u6765\u5e73\u8861\u540e\u7aef Pod \u7684\u6d41\u91cf\uff0c\u9ed8\u8ba4\u662f <code>rr</code>\uff0c\u6709\u5982\u4e0b\u4e00\u4e9b\u7b56\u7565\uff1a</p> <ul> <li>rr: round-robin</li> <li>lc: least connection (smallest number of open connections)</li> <li>dh: destination hashing</li> <li>sh: source hashing</li> <li>sed: shortest expected delay</li> <li>nq: never queue</li> </ul> <p>\u4e0d\u8fc7\u73b0\u5728\u53ea\u80fd\u6574\u4f53\u4fee\u6539\u7b56\u7565\uff0c\u53ef\u4ee5\u901a\u8fc7 kube-proxy \u4e2d\u914d\u7f6e <code>\u2013ipvs-scheduler</code> \u53c2\u6570\u6765\u5b9e\u73b0\uff0c\u6682\u65f6\u4e0d\u652f\u6301\u7279\u5b9a\u7684 Service \u8fdb\u884c\u914d\u7f6e\u3002</p> <p></p> <p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u5b9e\u73b0\u57fa\u4e8e\u5ba2\u6237\u7aef IP \u7684\u4f1a\u8bdd\u4eb2\u548c\u6027\uff0c\u53ef\u4ee5\u5c06 service.spec.sessionAffinity \u7684\u503c\u8bbe\u7f6e\u4e3a \"ClientIP\" \uff08\u9ed8\u8ba4\u503c\u4e3a \"None\"\uff09\u5373\u53ef\uff0c\u6b64\u5916\u8fd8\u53ef\u4ee5\u901a\u8fc7\u9002\u5f53\u8bbe\u7f6e </p> <pre><code>service.spec.sessionAffinityConfig.clientIP.timeoutSeconds\n</code></pre> <p>\u6765\u8bbe\u7f6e\u6700\u5927\u4f1a\u8bdd\u505c\u7559\u65f6\u95f4\uff08\u9ed8\u8ba4\u503c\u4e3a 10800 \u79d2\uff0c\u5373 3 \u5c0f\u65f6\uff09:</p> <pre><code>apiVersion: v1\nkind: Service\nspec:\n  sessionAffinity: ClientIP\n  ...\n</code></pre> <p>\u4eb2\u548c\u6027</p> <p>Service \u53ea\u652f\u6301\u4e24\u79cd\u5f62\u5f0f\u7684\u4f1a\u8bdd\u4eb2\u548c\u6027\u670d\u52a1\uff1aNone \u548c ClientIP\uff0c\u4e0d\u652f\u6301\u57fa\u4e8e cookie \u7684\u4f1a\u8bdd\u4eb2\u548c\u6027\uff0c\u8fd9\u662f\u56e0\u4e3a Service \u4e0d\u662f\u5728 HTTP \u5c42\u9762\u4e0a\u5de5\u4f5c\u7684\uff0c\u5904\u7406\u7684\u662f TCP \u548c UDP \u5305\uff0c\u5e76\u4e0d\u5173\u5fc3\u5176\u4e2d\u7684\u8f7d\u8377\u5185\u5bb9\uff0c\u56e0\u4e3a cookie \u662f HTTP \u534f\u8bae\u7684\u4e00\u90e8\u5206\uff0cService \u5e76\u4e0d\u77e5\u9053\u5b83\u4eec\uff0c\u6240\u6709\u4f1a\u8bdd\u4eb2\u548c\u6027\u4e0d\u80fd\u57fa\u4e8e Cookie\u3002</p>"},{"location":"kubernetes_network/service/#service_2","title":"Service","text":"<p>\u6211\u4eec\u5728\u5b9a\u4e49 Service \u7684\u65f6\u5019\u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2a\u81ea\u5df1\u9700\u8981\u7684\u7c7b\u578b\u7684 Service\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\u7684\u8bdd\u9ed8\u8ba4\u662f <code>ClusterIP</code>\u7c7b\u578b\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u7684\u670d\u52a1\u7c7b\u578b\u5982\u4e0b\uff1a</p> <ul> <li> <p>ClusterIP\uff1a\u901a\u8fc7\u96c6\u7fa4\u7684\u5185\u90e8 IP \u66b4\u9732\u670d\u52a1\uff0c\u9009\u62e9\u8be5\u503c\uff0c\u670d\u52a1\u53ea\u80fd\u591f\u5728\u96c6\u7fa4\u5185\u90e8\u53ef\u4ee5\u8bbf\u95ee\uff0c\u8fd9\u4e5f\u662f\u9ed8\u8ba4\u7684\u670d\u52a1\u7c7b\u578b\u3002</p> </li> <li> <p>NodePort\uff1a\u901a\u8fc7\u6bcf\u4e2a Node \u8282\u70b9\u4e0a\u7684 IP \u548c\u9759\u6001\u7aef\u53e3\uff08NodePort\uff09\u66b4\u9732\u670d\u52a1\u3002NodePort \u670d\u52a1\u4f1a\u8def\u7531\u5230 ClusterIP \u670d\u52a1\uff0c\u8fd9\u4e2a ClusterIP \u670d\u52a1\u4f1a\u81ea\u52a8\u521b\u5efa\u3002\u901a\u8fc7\u8bf7\u6c42 <code>NodeIp:NodePort</code>\uff0c\u53ef\u4ee5\u4ece\u96c6\u7fa4\u7684\u5916\u90e8\u8bbf\u95ee\u4e00\u4e2a NodePort \u670d\u52a1\u3002</p> </li> <li> <p>LoadBalancer\uff1a\u4f7f\u7528\u4e91\u63d0\u4f9b\u5546\u7684\u8d1f\u8f7d\u5c40\u8861\u5668\uff0c\u53ef\u4ee5\u5411\u5916\u90e8\u66b4\u9732\u670d\u52a1\u3002\u5916\u90e8\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u53ef\u4ee5\u8def\u7531\u5230 NodePort \u670d\u52a1\u548c ClusterIP \u670d\u52a1\uff0c\u8fd9\u4e2a\u9700\u8981\u7ed3\u5408\u5177\u4f53\u7684\u4e91\u5382\u5546\u8fdb\u884c\u64cd\u4f5c\u3002</p> </li> <li> <p>ExternalName\uff1a\u901a\u8fc7\u8fd4\u56de <code>CNAME</code> \u548c\u5b83\u7684\u503c\uff0c\u53ef\u4ee5\u5c06\u670d\u52a1\u6620\u5c04\u5230 <code>externalName</code> \u5b57\u6bb5\u7684\u5185\u5bb9\uff08\u4f8b\u5982\uff0c foo.bar.example.com\uff09\u3002</p> </li> </ul>"},{"location":"kubernetes_network/service/#nodeport","title":"NodePort \u7c7b\u578b","text":"<p>\u5982\u679c\u8bbe\u7f6e type \u7684\u503c\u4e3a \"NodePort\"\uff0cKubernetes master \u5c06\u4ece\u7ed9\u5b9a\u7684\u914d\u7f6e\u8303\u56f4\u5185\uff08\u9ed8\u8ba4\uff1a30000-32767\uff09\u5206\u914d\u7aef\u53e3\uff0c\u6bcf\u4e2a Node \u5c06\u4ece\u8be5\u7aef\u53e3\uff08\u6bcf\u4e2a Node \u4e0a\u7684\u540c\u4e00\u7aef\u53e3\uff09\u4ee3\u7406\u5230 Service\u3002\u8be5\u7aef\u53e3\u5c06\u901a\u8fc7 Service \u7684 </p> <pre><code>spec.ports[*].nodePort\n</code></pre> <p>\u5b57\u6bb5\u88ab\u6307\u5b9a\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\u7684\u8bdd\u4f1a\u81ea\u52a8\u751f\u6210\u4e00\u4e2a\u7aef\u53e3\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cService \u5c06\u80fd\u591f\u901a\u8fc7 </p> <pre><code>spec.ports[].nodePort\n</code></pre> <p>\u548c </p> <pre><code>spec.clusterIp:spec.ports[].port\n</code></pre> <p>\u800c\u5bf9\u5916\u53ef\u89c1\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u7ed9\u5927\u5bb6\u521b\u5efa\u4e00\u4e2a NodePort \u7684\u670d\u52a1\u6765\u8bbf\u95ee\u6211\u4eec\u524d\u9762\u7684 Nginx \u670d\u52a1\uff1a(service-nodeport-demo.yaml)</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: myservice\nspec:\n  selector:\n    app: myapp\n  type: NodePort\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 80\n    name: myapp-http\n</code></pre> <p>\u521b\u5efa\u8be5 Service:</p> <pre><code>$ kubectl apply -f service-demo.yaml\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u67e5\u770b Service \u5bf9\u8c61\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get svc\nNAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE\nkubernetes   ClusterIP   1       &lt;none&gt;        443/TCP        27d\nmyservice    NodePort    1198   &lt;none&gt;        80:32560/TCP   14h\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 myservice \u7684 TYPE \u7c7b\u578b\u5df2\u7ecf\u53d8\u6210\u4e86 NodePort\uff0c\u540e\u9762\u7684 PORT(S) \u90e8\u5206\u4e5f\u591a\u4e86\u4e00\u4e2a 32560 \u7684\u6620\u5c04\u7aef\u53e3\u3002</p>"},{"location":"kubernetes_network/service/#externalname","title":"ExternalName","text":"<p>ExternalName \u662f Service \u7684\u7279\u4f8b\uff0c\u5b83\u6ca1\u6709 <code>selector</code>\uff0c\u4e5f\u6ca1\u6709\u5b9a\u4e49\u4efb\u4f55\u7684\u7aef\u53e3\u548c Endpoint\u3002\u5bf9\u4e8e\u8fd0\u884c\u5728\u96c6\u7fa4\u5916\u90e8\u7684\u670d\u52a1\uff0c\u5b83\u901a\u8fc7\u8fd4\u56de\u8be5\u5916\u90e8\u670d\u52a1\u7684\u522b\u540d\u8fd9\u79cd\u65b9\u5f0f\u6765\u63d0\u4f9b\u670d\u52a1\u3002</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\n  name: my-service\n  namespace: prod\nspec:\n  type: ExternalName\n  externalName: my.database.example.com\n</code></pre> <p>\u5f53\u8bbf\u95ee\u5730\u5740 </p> <pre><code>my-service.prod.svc.cluster.local\n</code></pre> <p>\uff08\u540e\u9762\u670d\u52a1\u53d1\u73b0\u7684\u65f6\u5019\u6211\u4eec\u4f1a\u518d\u6df1\u5165\u8bb2\u89e3\uff09\u65f6\uff0c\u96c6\u7fa4\u7684 DNS \u670d\u52a1\u5c06\u8fd4\u56de\u4e00\u4e2a\u503c\u4e3a my.database.example.com \u7684 <code>CNAME</code> \u8bb0\u5f55\u3002\u8bbf\u95ee\u8fd9\u4e2a\u670d\u52a1\u7684\u5de5\u4f5c\u65b9\u5f0f\u4e0e\u5176\u5b83\u7684\u76f8\u540c\uff0c\u552f\u4e00\u4e0d\u540c\u7684\u662f\u91cd\u5b9a\u5411\u53d1\u751f\u5728 DNS \u5c42\uff0c\u800c\u4e14\u4e0d\u4f1a\u8fdb\u884c\u4ee3\u7406\u6216\u8f6c\u53d1\u3002\u5982\u679c\u540e\u7eed\u51b3\u5b9a\u8981\u5c06\u6570\u636e\u5e93\u8fc1\u79fb\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u53ef\u4ee5\u542f\u52a8\u5bf9\u5e94\u7684 Pod\uff0c\u589e\u52a0\u5408\u9002\u7684 Selector \u6216 Endpoint\uff0c\u4fee\u6539 Service \u7684 type\uff0c\u5b8c\u5168\u4e0d\u9700\u8981\u4fee\u6539\u8c03\u7528\u7684\u4ee3\u7801\uff0c\u8fd9\u6837\u5c31\u5b8c\u5168\u89e3\u8026\u4e86\u3002</p> <p>\u9664\u4e86\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 <code>externalName</code> \u6307\u5b9a\u5916\u90e8\u670d\u52a1\u7684\u57df\u540d\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49 Endpoints \u6765\u521b\u5efa Service\uff0c\u524d\u63d0\u662f <code>clusterIP=None</code>\uff0c\u540d\u79f0\u8981\u548c Service \u4fdd\u6301\u4e00\u81f4\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: etcd-k8s\n  namespace: kube-system\n  labels:\n    k8s-app: etcd\nspec:\n  type: ClusterIP\n  clusterIP: None\n  ports:\n  - name: port\n    port: 2379\n\n---\n\napiVersion: v1\nkind: Endpoints\nmetadata:\n  name: etcd-k8s  # \u540d\u79f0\u5fc5\u987b\u548c Service \u4e00\u81f4\n  namespace: kube-system\n  labels:\n    k8s-app: etcd\nsubsets:\n- addresses:\n  - ip: 157  # Service \u5c06\u8fde\u63a5\u91cd\u5b9a\u5411\u5230 endpoint\n  ports:\n  - name: port\n    port: 2379   # endpoint \u7684\u76ee\u6807\u7aef\u53e3\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a\u670d\u52a1\u5c31\u662f\u5c06\u5916\u90e8\u7684 etcd \u670d\u52a1\u5f15\u5165\u5230 Kubernetes \u96c6\u7fa4\u4e2d\u6765\u3002</p>"},{"location":"kubernetes_network/service/#ip_1","title":"\u83b7\u53d6\u5ba2\u6237\u7aef IP","text":"<p>\u901a\u5e38\uff0c\u5f53\u96c6\u7fa4\u5185\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u5230\u670d\u52a1\u7684\u65f6\u5019\uff0c\u662f\u652f\u6301\u670d\u52a1\u7684 Pod \u53ef\u4ee5\u83b7\u53d6\u5230\u5ba2\u6237\u7aef\u7684 IP \u5730\u5740\u7684\uff0c\u4f46\u662f\uff0c\u5f53\u901a\u8fc7\u8282\u70b9\u7aef\u53e3\u63a5\u6536\u5230\u8fde\u63a5\u65f6\uff0c\u7531\u4e8e\u5bf9\u6570\u636e\u5305\u6267\u884c\u4e86\u6e90\u7f51\u7edc\u5730\u5740\u8f6c\u6362\uff08SNAT\uff09\uff0c\u56e0\u6b64\u6570\u636e\u5305\u7684\u6e90 IP \u5730\u5740\u4f1a\u53d1\u751f\u53d8\u5316\uff0c\u540e\u7aef\u7684 Pod \u65e0\u6cd5\u770b\u5230\u5b9e\u9645\u7684\u5ba2\u6237\u7aef IP\uff0c\u5bf9\u4e8e\u67d0\u4e9b\u5e94\u7528\u6765\u8bf4\u662f\u4e2a\u95ee\u9898\uff0c\u6bd4\u5982\uff0cnginx \u7684\u8bf7\u6c42\u65e5\u5fd7\u5c31\u65e0\u6cd5\u83b7\u53d6\u51c6\u786e\u7684\u5ba2\u6237\u7aef\u8bbf\u95ee IP \u4e86\uff0c\u6bd4\u5982\u4e0b\u9762\u6211\u4eec\u7684\u5e94\u7528\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - containerPort: 80\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: nginx\nspec:\n  selector:\n    app: nginx\n  type: NodePort\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 80\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u540e\u53ef\u4ee5\u67e5\u770b nginx \u670d\u52a1\u88ab\u81ea\u52a8\u5206\u914d\u4e86\u4e00\u4e2a 32761 \u7684 NodePort \u7aef\u53e3\uff1a</p> <pre><code>$ kubectl get svc\nNAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\nkubernetes   ClusterIP   1        &lt;none&gt;        443/TCP        28d\nnginx        NodePort    11194   &lt;none&gt;        80:32761/TCP   48m\n$ kubectl get pods -o wide\nNAME                              READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES\nnginx-54f57cf6bf-nwtjp            1/1     Running   0          3m      215    ydzs-node3   &lt;none&gt;           &lt;none&gt;\nnginx-54f57cf6bf-ptvgs            1/1     Running   0          2m59s   213    ydzs-node2   &lt;none&gt;           &lt;none&gt;\nnginx-54f57cf6bf-xhs8g            1/1     Running   0          2m59s   216    ydzs-node1   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a3\u4e2a Pod \u88ab\u5206\u914d\u5230\u4e86 3 \u4e2a\u4e0d\u540c\u7684\u8282\u70b9\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u901a\u8fc7 master \u8282\u70b9\u7684 NodePort \u7aef\u53e3\u6765\u8bbf\u95ee\u4e0b\u6211\u4eec\u7684\u670d\u52a1\uff0c\u56e0\u4e3a\u6211\u8fd9\u91cc\u53ea\u6709 master \u8282\u70b9\u53ef\u4ee5\u8bbf\u95ee\u5916\u7f51\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u67e5\u770b nginx \u7684 Pod \u65e5\u5fd7\u53ef\u4ee5\u770b\u5230\u5176\u4e2d\u83b7\u53d6\u5230\u7684 clientIP \u662f <code>10.151.30.11</code>\uff0c\u5176\u5b9e\u662f master \u8282\u70b9\u7684\u5185\u7f51 IP\uff0c\u5e76\u4e0d\u662f\u6211\u4eec\u671f\u671b\u7684\u771f\u6b63\u7684\u6d4f\u89c8\u5668\u7aef\u8bbf\u95ee\u7684 IP \u5730\u5740\uff1a</p> <pre><code>$ kubectl logs -f nginx-54f57cf6bf-xhs8g\n111 - - [07/Dec/2019:16:44:38 +0800] \"GET / HTTP/1\" 200 612 \"-\" \"Mozilla/0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/536 (KHTML, like Gecko) Chrome/39108 Safari/536\" \"-\"\n</code></pre> <p>\u8fd9\u4e2a\u662f\u56e0\u4e3a\u6211\u4eec master \u8282\u70b9\u4e0a\u5e76\u6ca1\u6709\u5bf9\u5e94\u7684 Pod\uff0c\u6240\u4ee5\u901a\u8fc7 master \u8282\u70b9\u53bb\u8bbf\u95ee\u5e94\u7528\u7684\u65f6\u5019\u5fc5\u7136\u9700\u8981\u989d\u5916\u7684\u7f51\u7edc\u8df3\u8f6c\u624d\u80fd\u5230\u8fbe\u5176\u4ed6\u8282\u70b9\u4e0a Pod\uff0c\u5728\u8df3\u8f6c\u8fc7\u7a0b\u4e2d\u7531\u4e8e\u5bf9\u6570\u636e\u5305\u8fdb\u884c\u4e86 SNAT\uff0c\u6240\u4ee5\u770b\u5230\u7684\u662f master \u8282\u70b9\u7684 IP\u3002\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u5728 Service \u8bbe\u7f6e </p> <pre><code>externalTrafficPolicy\n</code></pre> <p>\u6765\u51cf\u5c11\u7f51\u7edc\u8df3\u6570\uff1a</p> <pre><code>spec:\n  externalTrafficPolicy: Local\n</code></pre> <p>\u5982\u679c Service \u4e2d\u914d\u7f6e\u4e86 </p> <pre><code>externalTrafficPolicy=Local\n</code></pre> <p>\uff0c\u5e76\u4e14\u901a\u8fc7\u670d\u52a1\u7684\u8282\u70b9\u7aef\u53e3\u6765\u6253\u5f00\u5916\u90e8\u8fde\u63a5\uff0c\u5219 Service \u4f1a\u4ee3\u7406\u5230\u672c\u5730\u8fd0\u884c\u7684 Pod\uff0c\u5982\u679c\u672c\u5730\u6ca1\u6709\u672c\u5730 Pod \u5b58\u5728\uff0c\u5219\u8fde\u63a5\u5c06\u6302\u8d77\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u8bbe\u7f6e\u4e0a\u8be5\u5b57\u6bb5\u66f4\u65b0\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53bb\u901a\u8fc7 master \u8282\u70b9\u7684 NodePort \u8bbf\u95ee\u5e94\u7528\u662f\u8bbf\u95ee\u4e0d\u5230\u7684\uff0c\u56e0\u4e3a master \u8282\u70b9\u4e0a\u5e76\u6ca1\u6709\u5bf9\u5e94\u7684 Pod \u8fd0\u884c\uff0c\u6240\u4ee5\u9700\u8981\u786e\u4fdd\u8d1f\u8f7d\u5747\u8861\u5668\u5c06\u8fde\u63a5\u8f6c\u53d1\u7ed9\u81f3\u5c11\u5177\u6709\u4e00\u4e2a Pod \u7684\u8282\u70b9\u3002</p> <p>\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f\u4f7f\u7528\u8fd9\u4e2a\u53c2\u6570\u6709\u4e00\u4e2a\u7f3a\u70b9\uff0c\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u8bf7\u6c42\u90fd\u662f\u5747\u5300\u5206\u5e03\u5728\u6240\u6709 Pod \u4e0a\u7684\uff0c\u4f46\u662f\u4f7f\u7528\u4e86\u8fd9\u4e2a\u914d\u7f6e\u7684\u8bdd\uff0c\u60c5\u51b5\u5c31\u6709\u53ef\u80fd\u4e0d\u4e00\u6837\u4e86\u3002\u6bd4\u5982\u6211\u4eec\u6709\u4e24\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e86 3 \u4e2a Pod\uff0c\u5047\u5982\u8282\u70b9 A \u8fd0\u884c\u4e00\u4e2a Pod\uff0c\u8282\u70b9 B \u8fd0\u884c\u4e24\u4e2a Pod\uff0c\u5982\u679c\u8d1f\u8f7d\u5747\u8861\u5668\u5728\u4e24\u4e2a\u8282\u70b9\u95f4\u5747\u8861\u5206\u5e03\u8fde\u63a5\uff0c\u5219\u8282\u70b9 A \u4e0a\u7684 Pod \u5c06\u63a5\u6536\u5230\u6240\u6709\u8bf7\u6c42\u7684 50%\uff0c\u4f46\u8282\u70b9 B \u4e0a\u7684\u4e24\u4e2a Pod \u6bcf\u4e2a\u5c31\u53ea\u63a5\u6536 25% \u3002</p> <p>\u7531\u4e8e\u589e\u52a0\u4e86</p> <pre><code>externalTrafficPolicy: Local\n</code></pre> <p>\u8fd9\u4e2a\u914d\u7f6e\u540e\uff0c\u63a5\u6536\u8bf7\u6c42\u7684\u8282\u70b9\u548c\u76ee\u6807 Pod \u90fd\u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\uff0c\u6240\u4ee5\u6ca1\u6709\u989d\u5916\u7684\u7f51\u7edc\u8df3\u8f6c\uff08\u4e0d\u6267\u884c SNAT\uff09\uff0c\u6240\u4ee5\u5c31\u53ef\u4ee5\u62ff\u5230\u6b63\u786e\u7684\u5ba2\u6237\u7aef IP\uff0c\u5982\u4e0b\u6240\u793a\u6211\u4eec\u628a Pod \u90fd\u56fa\u5b9a\u5230 master \u8282\u70b9\u4e0a\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name:  nginx\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      tolerations:\n      - operator: \"Exists\"\n      nodeSelector:\n        kubernetes.io/hostname: ydzs-master\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - containerPort: 80\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: nginx\nspec:\n externalTrafficPolicy: Local\n  selector:\n    app: nginx\n  type: NodePort\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 80\n</code></pre> <p>\u66f4\u65b0\u670d\u52a1\u540e\uff0c\u7136\u540e\u518d\u901a\u8fc7 NodePort \u8bbf\u95ee\u670d\u52a1\u53ef\u4ee5\u770b\u5230\u62ff\u5230\u7684\u5c31\u662f\u6b63\u786e\u7684\u5ba2\u6237\u7aef IP \u5730\u5740\u4e86\uff1a</p> <pre><code>$ kubectl logs -f nginx-ddc8f997b-ptb7b\n11111 - - [07/Dec/2019:17:03:43 +0800] \"GET / HTTP/1\" 200 612 \"-\" \"Mozilla/0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/536 (KHTML, like Gecko) Chrome/39108 Safari/536\" \"-\"\n</code></pre>"},{"location":"kubernetes_network/service/#_1","title":"\u670d\u52a1\u53d1\u73b0","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bb2\u89e3\u4e86 Service \u7684\u7528\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Service \u751f\u6210\u7684 ClusterIP(VIP) \u6765\u8bbf\u95ee Pod \u63d0\u4f9b\u7684\u670d\u52a1\uff0c\u4f46\u662f\u5728\u4f7f\u7528\u7684\u65f6\u5019\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\uff1a\u6211\u4eec\u600e\u4e48\u77e5\u9053\u67d0\u4e2a\u5e94\u7528\u7684 VIP \u5462\uff1f\u6bd4\u5982\u6211\u4eec\u6709\u4e24\u4e2a\u5e94\u7528\uff0c\u4e00\u4e2a\u662f api \u5e94\u7528\uff0c\u4e00\u4e2a\u662f db \u5e94\u7528\uff0c\u4e24\u4e2a\u5e94\u7528\u90fd\u662f\u901a\u8fc7 Deployment \u8fdb\u884c\u7ba1\u7406\u7684\uff0c\u5e76\u4e14\u90fd\u901a\u8fc7 Service \u66b4\u9732\u51fa\u4e86\u7aef\u53e3\u63d0\u4f9b\u670d\u52a1\u3002api \u9700\u8981\u8fde\u63a5\u5230 db \u8fd9\u4e2a\u5e94\u7528\uff0c\u6211\u4eec\u53ea\u77e5\u9053 db \u5e94\u7528\u7684\u540d\u79f0\u548c db \u5bf9\u5e94\u7684 Service \u7684\u540d\u79f0\uff0c\u4f46\u662f\u5e76\u4e0d\u77e5\u9053\u5b83\u7684 VIP \u5730\u5740\uff0c\u6211\u4eec\u524d\u9762\u7684 Service \u8bfe\u7a0b\u4e2d\u662f\u4e0d\u662f\u5b66\u4e60\u5230\u6211\u4eec\u901a\u8fc7 ClusterIP \u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230\u540e\u9762\u7684 Pod \u670d\u52a1\uff0c\u5982\u679c\u6211\u4eec\u77e5\u9053\u4e86 VIP \u7684\u5730\u5740\u662f\u4e0d\u662f\u5c31\u884c\u4e86\uff1f</p>"},{"location":"kubernetes_network/service/#_2","title":"\u73af\u5883\u53d8\u91cf","text":"<p>\u4e3a\u4e86\u89e3\u51b3\u4e0a\u9762\u7684\u95ee\u9898\uff0c\u5728\u4e4b\u524d\u7684\u7248\u672c\u4e2d\uff0cKubernetes \u91c7\u7528\u4e86\u73af\u5883\u53d8\u91cf\u7684\u65b9\u6cd5\uff0c\u6bcf\u4e2a Pod \u542f\u52a8\u7684\u65f6\u5019\uff0c\u4f1a\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u8bbe\u7f6e\u6240\u6709\u670d\u52a1\u7684 IP \u548c port \u4fe1\u606f\uff0c\u8fd9\u6837 Pod \u4e2d\u7684\u5e94\u7528\u53ef\u4ee5\u901a\u8fc7\u8bfb\u53d6\u73af\u5883\u53d8\u91cf\u6765\u83b7\u53d6\u4f9d\u8d56\u670d\u52a1\u7684\u5730\u5740\u4fe1\u606f\uff0c\u8fd9\u79cd\u65b9\u6cd5\u4f7f\u7528\u8d77\u6765\u76f8\u5bf9\u7b80\u5355\uff0c\u4f46\u662f\u6709\u4e00\u4e2a\u5f88\u5927\u7684\u95ee\u9898\u5c31\u662f\u4f9d\u8d56\u7684\u670d\u52a1\u5fc5\u987b\u5728 Pod \u542f\u52a8\u4e4b\u524d\u5c31\u5b58\u5728\uff0c\u4e0d\u7136\u662f\u4e0d\u4f1a\u88ab\u6ce8\u5165\u5230\u73af\u5883\u53d8\u91cf\u4e2d\u7684\u3002\u6bd4\u5982\u6211\u4eec\u9996\u5148\u521b\u5efa\u4e00\u4e2a Nginx \u670d\u52a1\uff1a(test-nginx.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-deploy\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - containerPort: 80\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: nginx-service\n  labels:\n    name: nginx-service\nspec:\n  ports:\n  - port: 5000\n    targetPort: 80\n  selector:\n    app: nginx\n</code></pre> <p>\u521b\u5efa\u4e0a\u9762\u7684\u670d\u52a1\uff1a</p> <pre><code>$ kubectl apply -f test-nginx.yaml\ndeployment.apps \"nginx-deploy\" created\nservice \"nginx-service\" created\n$ kubectl get pods\nNAME                                      READY     STATUS    RESTARTS   AGE\n...\nnginx-deploy-75675f5897-47h4t             1/1       Running   0          53s\nnginx-deploy-75675f5897-mmm8w             1/1       Running   0          53s\n...\n$ kubectl get svc\nNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\n...\nnginx-service   ClusterIP   1242    &lt;none&gt;        5000/TCP         1m\n...\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e24\u4e2a Pod \u548c\u4e00\u4e2a\u540d\u4e3a nginx-service \u7684\u670d\u52a1\u521b\u5efa\u6210\u529f\u4e86\uff0c\u8be5 Service \u76d1\u542c\u7684\u7aef\u53e3\u662f 5000\uff0c\u540c\u65f6\u5b83\u4f1a\u628a\u6d41\u91cf\u8f6c\u53d1\u7ed9\u5b83\u4ee3\u7406\u7684\u6240\u6709 Pod\uff08\u6211\u4eec\u8fd9\u91cc\u5c31\u662f\u62e5\u6709 <code>app: nginx</code> \u6807\u7b7e\u7684\u4e24\u4e2a Pod\uff09\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u518d\u6765\u521b\u5efa\u4e00\u4e2a\u666e\u901a\u7684 Pod\uff0c\u89c2\u5bdf\u4e0b\u8be5 Pod \u4e2d\u7684\u73af\u5883\u53d8\u91cf\u662f\u5426\u5305\u542b\u4e0a\u9762\u7684 <code>nginx-service</code> \u7684\u670d\u52a1\u4fe1\u606f\uff1a\uff08test-pod.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: test-pod\nspec:\n  containers:\n  - name: test-service-pod\n    image: busybox\n    command: [\"/bin/sh\", \"-c\", \"env\"]\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u8be5\u6d4b\u8bd5\u7684 Pod\uff1a</p> <pre><code>$ kubectl apply -f test-pod.yaml\npod \"test-pod\" created\n</code></pre> <p>\u7b49 Pod \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u67e5\u770b\u65e5\u5fd7\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl logs test-pod\n...\nKUBERNETES_PORT=tcp://1:443\nKUBERNETES_SERVICE_PORT=443\nHOSTNAME=test-pod\nHOME=/root\nNGINX_SERVICE_PORT_5000_TCP_ADDR=1242\nNGINX_SERVICE_PORT_5000_TCP_PORT=5000\nNGINX_SERVICE_PORT_5000_TCP_PROTO=tcp\nKUBERNETES_PORT_443_TCP_ADDR=1\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nNGINX_SERVICE_SERVICE_HOST=1242\nNGINX_SERVICE_PORT_5000_TCP=tcp://1242:5000\nKUBERNETES_PORT_443_TCP_PORT=443\nKUBERNETES_PORT_443_TCP_PROTO=tcp\nNGINX_SERVICE_SERVICE_PORT=5000\nNGINX_SERVICE_PORT=tcp://1242:5000\nKUBERNETES_SERVICE_PORT_HTTPS=443\nKUBERNETES_PORT_443_TCP=tcp://1:443\nKUBERNETES_SERVICE_HOST=1\nPWD=/\n...\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6253\u5370\u4e86\u5f88\u591a\u73af\u5883\u53d8\u91cf\u4fe1\u606f\uff0c\u5176\u4e2d\u5c31\u5305\u62ec\u6211\u4eec\u521a\u521a\u521b\u5efa\u7684 nginx-service \u8fd9\u4e2a\u670d\u52a1\uff0c\u6709 HOST\u3001PORT\u3001PROTO\u3001ADDR \u7b49\uff0c\u4e5f\u5305\u62ec\u5176\u4ed6\u5df2\u7ecf\u5b58\u5728\u7684 Service \u7684\u73af\u5883\u53d8\u91cf\uff0c\u73b0\u5728\u5982\u679c\u6211\u4eec\u9700\u8981\u5728\u8fd9\u4e2a Pod \u91cc\u9762\u8bbf\u95ee nginx-service \u7684\u670d\u52a1\uff0c\u6211\u4eec\u662f\u4e0d\u662f\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 </p> <pre><code>NGINX_SERVICE_SERVICE_HOST\n</code></pre> <p>\u548c </p> <pre><code>NGINX_SERVICE_SERVICE_PORT\n</code></pre> <p>\u5c31\u53ef\u4ee5\u4e86\uff0c\u4f46\u662f\u5982\u679c\u8fd9\u4e2a Pod \u542f\u52a8\u8d77\u6765\u7684\u65f6\u5019 nginx-service \u670d\u52a1\u8fd8\u6ca1\u542f\u52a8\u8d77\u6765\uff0c\u5728\u73af\u5883\u53d8\u91cf\u4e2d\u6211\u4eec\u662f\u65e0\u6cd5\u83b7\u53d6\u5230\u8fd9\u4e9b\u4fe1\u606f\u7684\uff0c\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>initContainer</code> \u4e4b\u7c7b\u7684\u65b9\u6cd5\u6765\u786e\u4fdd nginx-service \u542f\u52a8\u540e\u518d\u542f\u52a8 Pod\uff0c\u4f46\u662f\u8fd9\u79cd\u65b9\u6cd5\u6bd5\u7adf\u589e\u52a0\u4e86 Pod \u542f\u52a8\u7684\u590d\u6742\u6027\uff0c\u6240\u4ee5\u8fd9\u4e0d\u662f\u6700\u4f18\u7684\u65b9\u6cd5\uff0c\u5c40\u9650\u6027\u592a\u591a\u4e86\u3002</p>"},{"location":"kubernetes_network/service/#dns","title":"DNS","text":"<p>\u7531\u4e8e\u4e0a\u9762\u73af\u5883\u53d8\u91cf\u8fd9\u79cd\u65b9\u5f0f\u7684\u5c40\u9650\u6027\uff0c\u6211\u4eec\u9700\u8981\u4e00\u79cd\u66f4\u52a0\u667a\u80fd\u7684\u65b9\u6848\uff0c\u5176\u5b9e\u6211\u4eec\u53ef\u4ee5\u81ea\u5df1\u601d\u8003\u4e00\u79cd\u6bd4\u8f83\u7406\u60f3\u7684\u65b9\u6848\uff1a\u90a3\u5c31\u662f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Service \u7684\u540d\u79f0\uff0c\u56e0\u4e3a Service \u7684\u540d\u79f0\u4e0d\u4f1a\u53d8\u5316\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u53bb\u5173\u5fc3\u5206\u914d\u7684 ClusterIP \u7684\u5730\u5740\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u5730\u5740\u5e76\u4e0d\u662f\u56fa\u5b9a\u4e0d\u53d8\u7684\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u76f4\u63a5\u4f7f\u7528 Service \u7684\u540d\u5b57\uff0c\u7136\u540e\u5bf9\u5e94\u7684 ClusterIP \u5730\u5740\u7684\u8f6c\u6362\u80fd\u591f\u81ea\u52a8\u5b8c\u6210\u5c31\u5f88\u597d\u4e86\u3002\u6211\u4eec\u77e5\u9053\u540d\u5b57\u548c IP \u76f4\u63a5\u7684\u8f6c\u6362\u662f\u4e0d\u662f\u548c\u6211\u4eec\u5e73\u65f6\u8bbf\u95ee\u7684\u7f51\u7ad9\u975e\u5e38\u7c7b\u4f3c\u554a\uff1f\u4ed6\u4eec\u4e4b\u95f4\u7684\u8f6c\u6362\u529f\u80fd\u901a\u8fc7 DNS \u5c31\u53ef\u4ee5\u89e3\u51b3\u4e86\uff0c\u540c\u6837\u7684\uff0cKubernetes \u4e5f\u63d0\u4f9b\u4e86 DNS \u7684\u65b9\u6848\u6765\u89e3\u51b3\u4e0a\u9762\u7684\u670d\u52a1\u53d1\u73b0\u7684\u95ee\u9898\u3002</p> <p>DNS \u670d\u52a1\u4e0d\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u7cfb\u7edf\u670d\u52a1\uff0c\u800c\u662f\u4f5c\u4e3a\u4e00\u79cd addon \u63d2\u4ef6\u800c\u5b58\u5728\uff0c\u73b0\u5728\u6bd4\u8f83\u63a8\u8350\u7684\u4e24\u4e2a\u63d2\u4ef6\uff1akube-dns \u548c CoreDNS\uff0c\u5b9e\u9645\u4e0a\u5728\u6bd4\u8f83\u65b0\u70b9\u7684\u7248\u672c\u4e2d\u5df2\u7ecf\u9ed8\u8ba4\u662f CoreDNS \u4e86\uff0c\u56e0\u4e3a kube-dns \u9ed8\u8ba4\u4e00\u4e2a Pod \u4e2d\u9700\u89813\u4e2a\u5bb9\u5668\u914d\u5408\u4f7f\u7528\uff0cCoreDNS \u53ea\u9700\u8981\u4e00\u4e2a\u5bb9\u5668\u5373\u53ef\uff0c\u6211\u4eec\u5728\u524d\u9762\u4f7f\u7528 kubeadm \u642d\u5efa\u96c6\u7fa4\u7684\u65f6\u5019\u76f4\u63a5\u5b89\u88c5\u7684\u5c31\u662f CoreDNS \u63d2\u4ef6\uff1a</p> <pre><code>$ kubectl get pods -n kube-system -l k8s-app=kube-dns\nNAME                       READY   STATUS    RESTARTS   AGE\ncoredns-667f964f9b-sthqq   1/1     Running   0          32m\ncoredns-667f964f9b-zj4r4   1/1     Running   0          33m\n</code></pre> <p>CoreDns \u662f\u7528 GO \u5199\u7684\u9ad8\u6027\u80fd\uff0c\u9ad8\u6269\u5c55\u6027\u7684 DNS \u670d\u52a1\uff0c\u57fa\u4e8e HTTP/2 Web \u670d\u52a1 Caddy \u8fdb\u884c\u7f16\u5199\u7684\u3002CoreDns \u5185\u90e8\u91c7\u7528\u63d2\u4ef6\u673a\u5236\uff0c\u6240\u6709\u529f\u80fd\u90fd\u662f\u63d2\u4ef6\u5f62\u5f0f\u7f16\u5199\uff0c\u7528\u6237\u4e5f\u53ef\u4ee5\u6269\u5c55\u81ea\u5df1\u7684\u63d2\u4ef6\uff0c\u4ee5\u4e0b\u662f Kubernetes \u90e8\u7f72 CoreDns \u65f6\u7684\u9ed8\u8ba4\u914d\u7f6e\uff1a</p> <pre><code>$ kubectl get cm coredns -n kube-system -o yaml\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors  # \u542f\u7528\u9519\u8bef\u8bb0\u5f55\n        health  # \u542f\u7528\u68c0\u67e5\u68c0\u67e5\u7aef\u70b9\uff0c8080:health\n        ready\n        kubernetes cluster.local in-addr.arpa iparpa {  # \u5904\u7406 k8s \u57df\u540d\u89e3\u6790\n           pods insecure\n           fallthrough in-addr.arpa iparpa\n           ttl 30\n        }\n        prometheus :9153  # \u542f\u7528 prometheus metrics \u6307\u6807\uff0c9153:metrics\n        forward . /etc/resolv.conf  # \u901a\u8fc7 resolv.conf \u5185\u7684 nameservers \u89e3\u6790\n        cache 30  # \u542f\u7528\u7f13\u5b58\uff0c\u6240\u6709\u5185\u5bb9\u9650\u5236\u4e3a 30s \u7684TTL\n        loop  # \u68c0\u67e5\u7b80\u5355\u7684\u8f6c\u53d1\u5faa\u73af\u5e76\u505c\u6b62\u670d\u52a1\n        reload  # \u8fd0\u884c\u81ea\u52a8\u91cd\u65b0\u52a0\u8f7d corefile\uff0c\u70ed\u66f4\u65b0\n        loadbalance  # \u8d1f\u8f7d\u5747\u8861\uff0c\u9ed8\u8ba4 round_robin\n    }\nkind: ConfigMap\nmetadata:\n  creationTimestamp: \"2019-11-08T11:59:49Z\"\n  name: coredns\n  namespace: kube-system\n  resourceVersion: \"188\"\n  selfLink: /api/v1/namespaces/kube-system/configmaps/coredns\n  uid: 21966186-c2d9-467a-b87f-d061c5c9e4d7\n</code></pre> <ul> <li>\u6bcf\u4e2a <code>{}</code> \u4ee3\u8868\u4e00\u4e2a zone,\u683c\u5f0f\u662f <code>\u201cZone:port{}\u201d</code>, \u5176\u4e2d<code>\".\"</code>\u4ee3\u8868\u9ed8\u8ba4zone</li> <li> <p><code>{}</code> \u5185\u7684\u6bcf\u4e2a\u540d\u79f0\u4ee3\u8868\u63d2\u4ef6\u7684\u540d\u79f0\uff0c\u53ea\u6709\u914d\u7f6e\u7684\u63d2\u4ef6\u624d\u4f1a\u542f\u7528\uff0c\u5f53\u89e3\u6790\u57df\u540d\u65f6\uff0c\u4f1a\u5148\u5339\u914d zone\uff08\u90fd\u672a\u5339\u914d\u4f1a\u6267\u884c\u9ed8\u8ba4 zone\uff09\uff0c\u7136\u540e zone \u5185\u7684\u63d2\u4ef6\u4ece\u4e0a\u5230\u4e0b\u4f9d\u6b21\u6267\u884c(\u8fd9\u4e2a\u987a\u5e8f\u5e76\u4e0d\u662f\u914d\u7f6e\u6587\u4ef6\u5185\u8c01\u5728\u524d\u9762\u7684\u987a\u5e8f\uff0c\u800c\u662f</p> <pre><code>core/dnsserver/zdirectives.go\n</code></pre> <p>\u5185\u7684\u987a\u5e8f)\uff0c\u5339\u914d\u540e\u8fd4\u56de\u5904\u7406\uff08\u6267\u884c\u8fc7\u7684\u63d2\u4ef6\u4ece\u4e0b\u5230\u4e0a\u4f9d\u6b21\u5904\u7406\u8fd4\u56de\u903b\u8f91\uff09\uff0c\u4e0d\u518d\u6267\u884c\u4e0b\u4e00\u4e2a\u63d2\u4ef6</p> </li> </ul> <p>CoreDNS \u7684 Service \u5730\u5740\u4e00\u822c\u60c5\u51b5\u4e0b\u662f\u56fa\u5b9a\u7684\uff0c\u7c7b\u4f3c\u4e8e kubernetes \u8fd9\u4e2a Service \u5730\u5740\u4e00\u822c\u5c31\u662f\u7b2c\u4e00\u4e2a IP \u5730\u5740 <code>10.96.0.1</code>\uff0cCoreDNS \u7684 Service \u5730\u5740\u5c31\u662f <code>10.96.0.10</code>\uff0c\u8be5 IP \u88ab\u5206\u914d\u540e\uff0ckubelet \u4f1a\u5c06\u4f7f\u7528 </p> <pre><code>--cluster-dns=&lt;dns-service-ip&gt;\n</code></pre> <p>\u53c2\u6570\u914d\u7f6e\u7684 DNS \u4f20\u9012\u7ed9\u6bcf\u4e2a\u5bb9\u5668\u3002DNS \u540d\u79f0\u4e5f\u9700\u8981\u57df\u540d\uff0c\u672c\u5730\u57df\u53ef\u4ee5\u4f7f\u7528\u53c2\u6570</p> <pre><code>--cluster-domain = &lt;default-local-domain&gt;\n</code></pre> <p>\u5728 kubelet \u4e2d\u914d\u7f6e\uff1a</p> <pre><code>$ cat /var/lib/kubelet/config.yaml\n......\nclusterDNS:\n- 10\nclusterDomain: cluster.local\n......\n</code></pre> <p>\u6211\u4eec\u524d\u9762\u8bf4\u4e86\u5982\u679c\u6211\u4eec\u5efa\u7acb\u7684 Service \u5982\u679c\u652f\u6301\u57df\u540d\u5f62\u5f0f\u8fdb\u884c\u89e3\u6790\uff0c\u5c31\u53ef\u4ee5\u89e3\u51b3\u6211\u4eec\u7684\u670d\u52a1\u53d1\u73b0\u7684\u529f\u80fd\uff0c\u90a3\u4e48\u5229\u7528 kubedns \u53ef\u4ee5\u5c06 Service \u751f\u6210\u600e\u6837\u7684 DNS \u8bb0\u5f55\u5462\uff1f</p> <ul> <li> <p>\u666e\u901a\u7684 Service\uff1a\u4f1a\u751f\u6210 </p> <pre><code>servicename.namespace.svc.cluster.local\n</code></pre> <p>\u7684\u57df\u540d\uff0c\u4f1a\u89e3\u6790\u5230 Service \u5bf9\u5e94\u7684 ClusterIP \u4e0a\uff0c\u5728 Pod \u4e4b\u95f4\u7684\u8c03\u7528\u53ef\u4ee5\u7b80\u5199\u6210 </p> <pre><code>servicename.namespace\n</code></pre> <p>\uff0c\u5982\u679c\u5904\u4e8e\u540c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\uff0c\u751a\u81f3\u53ef\u4ee5\u53ea\u5199\u6210 <code>servicename</code> \u5373\u53ef\u8bbf\u95ee *   Headless Service\uff1a\u65e0\u5934\u670d\u52a1\uff0c\u5c31\u662f\u628a clusterIP \u8bbe\u7f6e\u4e3a None \u7684\uff0c\u4f1a\u88ab\u89e3\u6790\u4e3a\u6307\u5b9a Pod \u7684 IP \u5217\u8868\uff0c\u540c\u6837\u8fd8\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>podname.servicename.namespace.svc.cluster.local\n</code></pre> <p>\u8bbf\u95ee\u5230\u5177\u4f53\u7684\u67d0\u4e00\u4e2a Pod\u3002</p> </li> </ul> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4f7f\u7528\u4e00\u4e2a\u7b80\u5355 Pod \u6765\u6d4b\u8bd5\u4e0b Service \u7684\u57df\u540d\u8bbf\u95ee\uff1a</p> <pre><code>$ kubectl run -it --image busybox:3 test-dns --restart=Never --rm /bin/sh\nIf you don't see a command prompt, try pressing enter.\n/ # cat /etc/resolv.conf\nnameserver 10\nsearch default.svc.cluster.local svc.cluster.local cluster.local\noptions ndots:5\n/ #\n</code></pre> <p>\u6211\u4eec\u8fdb\u5165\u5230 Pod \u4e2d\uff0c\u67e5\u770b <code>/etc/resolv.conf</code> \u4e2d\u7684\u5185\u5bb9\uff0c\u53ef\u4ee5\u770b\u5230 <code>nameserver</code> \u7684\u5730\u5740 <code>10.96.0.10</code>\uff0c\u8be5 IP \u5730\u5740\u5373\u662f\u5728\u5b89\u88c5 CoreDNS \u63d2\u4ef6\u7684\u65f6\u5019\u96c6\u7fa4\u5206\u914d\u7684\u4e00\u4e2a\u56fa\u5b9a\u7684\u9759\u6001 IP \u5730\u5740\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get svc -n kube-system\nNAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE\nkube-dns                  ClusterIP   10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   28d\n</code></pre> <p>\u4e5f\u5c31\u662f\u8bf4\u6211\u4eec\u8fd9\u4e2a Pod \u73b0\u5728\u9ed8\u8ba4\u7684 <code>nameserver</code> \u5c31\u662f <code>kube-dns</code> \u7684\u5730\u5740\uff0c\u73b0\u5728\u6211\u4eec\u6765\u8bbf\u95ee\u4e0b\u524d\u9762\u6211\u4eec\u521b\u5efa\u7684 nginx-service \u670d\u52a1\uff1a</p> <pre><code>/ # wget -q -O- nginx-service.default.svc.cluster.local\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u6211\u4eec\u4f7f\u7528 wget \u547d\u4ee4\u53bb\u8bbf\u95ee nginx-service \u670d\u52a1\u7684\u57df\u540d\u7684\u65f6\u5019\u88ab hang \u4f4f\u4e86\uff0c\u6ca1\u6709\u5f97\u5230\u671f\u671b\u7684\u7ed3\u679c\uff0c\u8fd9\u662f\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u5efa\u7acb Service \u7684\u65f6\u5019\u66b4\u9732\u7684\u7aef\u53e3\u662f 5000\uff1a</p> <pre><code>/ # wget -q -O- nginx-service.default.svc.cluster.local:5000\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u52a0\u4e0a 5000 \u7aef\u53e3\uff0c\u5c31\u6b63\u5e38\u8bbf\u95ee\u5230\u670d\u52a1\uff0c\u518d\u8bd5\u4e00\u8bd5\u8bbf\u95ee\uff1a</p> <pre><code>nginx-service.default.svc\n</code></pre> <p>\u3001</p> <pre><code>nginx-service.default\n</code></pre> <p>\u3001<code>nginx-service</code>\uff0c\u4e0d\u51fa\u610f\u5916\u8fd9\u4e9b\u57df\u540d\u90fd\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\u5230\u671f\u671b\u7684\u7ed3\u679c\u3002</p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u662f\u4e0d\u662f\u5c31\u5b9e\u73b0\u4e86\u5728\u96c6\u7fa4\u5185\u90e8\u901a\u8fc7 Service \u7684\u57df\u540d\u5f62\u5f0f\u8fdb\u884c\u4e92\u76f8\u901a\u4fe1\u4e86\uff0c\u5927\u5bb6\u4e0b\u53bb\u8bd5\u7740\u770b\u770b\u8bbf\u95ee\u4e0d\u540c namespace \u4e0b\u9762\u7684\u670d\u52a1\u5462\uff1f\u4e0b\u8282\u8bfe\u6211\u4eec\u6765\u7ed9\u5927\u5bb6\u8bb2\u89e3\u4f7f\u7528 ingress \u66b4\u9732\u670d\u52a1\u3002</p>"},{"location":"kubernetes_network/ingress/nginx/","title":"NGINX Controller","text":""},{"location":"kubernetes_network/ingress/nginx/#ingress","title":"Ingress","text":"<p>\u5bf9\u5916\u66b4\u9732\u96c6\u7fa4\u670d\u52a1</p> <p>\u524d\u9762\u6211\u4eec\u5b66\u4e60\u4e86\u5728 Kubernetes \u96c6\u7fa4\u5185\u90e8\u4f7f\u7528 kube-dns \u5b9e\u73b0\u670d\u52a1\u53d1\u73b0\u7684\u529f\u80fd\uff0c\u90a3\u4e48\u6211\u4eec\u90e8\u7f72\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u5e94\u7528\u5982\u4f55\u66b4\u9732\u7ed9\u5916\u90e8\u7684\u7528\u6237\u4f7f\u7528\u5462\uff1f\u6211\u4eec\u77e5\u9053\u53ef\u4ee5\u4f7f\u7528 <code>NodePort</code> \u548c <code>LoadBlancer</code> \u7c7b\u578b\u7684 Service \u53ef\u4ee5\u628a\u5e94\u7528\u66b4\u9732\u7ed9\u5916\u90e8\u7528\u6237\u4f7f\u7528\uff0c\u9664\u6b64\u4e4b\u5916\uff0cKubernetes \u8fd8\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u8d44\u6e90\u5bf9\u8c61\u53ef\u4ee5\u7528\u6765\u66b4\u9732\u670d\u52a1\u7ed9\u5916\u90e8\u7528\u6237\uff0c\u90a3\u5c31\u662f <code>Ingress</code>\u3002\u5bf9\u4e8e\u5c0f\u89c4\u6a21\u7684\u5e94\u7528\u6211\u4eec\u4f7f\u7528 NodePort \u6216\u8bb8\u80fd\u591f\u6ee1\u8db3\u6211\u4eec\u7684\u9700\u6c42\uff0c\u4f46\u662f\u5f53\u4f60\u7684\u5e94\u7528\u8d8a\u6765\u8d8a\u591a\u7684\u65f6\u5019\uff0c\u4f60\u5c31\u4f1a\u53d1\u73b0\u5bf9\u4e8e NodePort \u7684\u7ba1\u7406\u5c31\u975e\u5e38\u9ebb\u70e6\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u4f7f\u7528 Ingress \u5c31\u975e\u5e38\u65b9\u4fbf\u4e86\uff0c\u53ef\u4ee5\u907f\u514d\u7ba1\u7406\u5927\u91cf\u7684\u7aef\u53e3\u3002</p> <p>Ingress \u5176\u5b9e\u5c31\u662f\u4ece Kuberenets \u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee\u96c6\u7fa4\u7684\u4e00\u4e2a\u5165\u53e3\uff0c\u5c06\u5916\u90e8\u7684\u8bf7\u6c42\u8f6c\u53d1\u5230\u96c6\u7fa4\u5185\u4e0d\u540c\u7684 Service \u4e0a\uff0c\u5176\u5b9e\u5c31\u76f8\u5f53\u4e8e nginx\u3001haproxy \u7b49\u8d1f\u8f7d\u5747\u8861\u4ee3\u7406\u670d\u52a1\u5668\uff0c\u53ef\u80fd\u4f60\u4f1a\u89c9\u5f97\u6211\u4eec\u76f4\u63a5\u4f7f\u7528 nginx \u5c31\u5b9e\u73b0\u4e86\uff0c\u4f46\u662f\u53ea\u4f7f\u7528 nginx \u8fd9\u79cd\u65b9\u5f0f\u6709\u5f88\u5927\u7f3a\u9677\uff0c\u6bcf\u6b21\u6709\u65b0\u670d\u52a1\u52a0\u5165\u7684\u65f6\u5019\u600e\u4e48\u6539 Nginx \u914d\u7f6e\uff1f\u4e0d\u53ef\u80fd\u8ba9\u6211\u4eec\u53bb\u624b\u52a8\u66f4\u6539\u6216\u8005\u6eda\u52a8\u66f4\u65b0\u524d\u7aef\u7684 Nginx Pod \u5427\uff1f\u90a3\u6211\u4eec\u518d\u52a0\u4e0a\u4e00\u4e2a\u670d\u52a1\u53d1\u73b0\u7684\u5de5\u5177\u6bd4\u5982 consul \u5982\u4f55\uff1f\u8c8c\u4f3c\u662f\u53ef\u4ee5\uff0c\u5bf9\u5427\uff1fIngress \u5b9e\u9645\u4e0a\u5c31\u662f\u8fd9\u6837\u5b9e\u73b0\u7684\uff0c\u53ea\u662f\u670d\u52a1\u53d1\u73b0\u7684\u529f\u80fd\u81ea\u5df1\u5b9e\u73b0\u4e86\uff0c\u4e0d\u9700\u8981\u4f7f\u7528\u7b2c\u4e09\u65b9\u7684\u670d\u52a1\u4e86\uff0c\u7136\u540e\u518d\u52a0\u4e0a\u4e00\u4e2a\u57df\u540d\u89c4\u5219\u5b9a\u4e49\uff0c\u8def\u7531\u4fe1\u606f\u7684\u5237\u65b0\u4f9d\u9760 Ingress Controller \u6765\u63d0\u4f9b\u3002</p> <p>Ingress Controller \u53ef\u4ee5\u7406\u89e3\u4e3a\u4e00\u4e2a\u76d1\u542c\u5668\uff0c\u901a\u8fc7\u4e0d\u65ad\u5730\u76d1\u542c kube-apiserver\uff0c\u5b9e\u65f6\u7684\u611f\u77e5\u540e\u7aef Service\u3001Pod \u7684\u53d8\u5316\uff0c\u5f53\u5f97\u5230\u8fd9\u4e9b\u4fe1\u606f\u53d8\u5316\u540e\uff0cIngress Controller \u518d\u7ed3\u5408 Ingress \u7684\u914d\u7f6e\uff0c\u66f4\u65b0\u53cd\u5411\u4ee3\u7406\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u8fbe\u5230\u670d\u52a1\u53d1\u73b0\u7684\u4f5c\u7528\u3002\u5176\u5b9e\u8fd9\u70b9\u548c\u670d\u52a1\u53d1\u73b0\u5de5\u5177 consul\u3001 consul-template \u975e\u5e38\u7c7b\u4f3c\u3002</p> <p></p> <p>\u73b0\u5728\u53ef\u4ee5\u4f9b\u5927\u5bb6\u4f7f\u7528\u7684 Ingress Controller \u6709\u5f88\u591a\uff0c\u6bd4\u5982 traefik\u3001nginx-controller\u3001Kubernetes Ingress Controller for Kong\u3001HAProxy Ingress controller\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u81ea\u5df1\u5b9e\u73b0\u4e00\u4e2a Ingress Controller\uff0c\u73b0\u5728\u666e\u904d\u7528\u5f97\u8f83\u591a\u7684\u662f traefik \u548c nginx-controller\uff0ctraefik \u7684\u6027\u80fd\u8f83 nginx-controller \u5dee\uff0c\u4f46\u662f\u914d\u7f6e\u4f7f\u7528\u8981\u7b80\u5355\u8bb8\u591a\uff0c\u6211\u4eec\u8fd9\u91cc\u4f1a\u91cd\u70b9\u7ed9\u5927\u5bb6\u4ecb\u7ecd nginx-controller \u4ee5\u53ca traefik \u7684\u4f7f\u7528\u3002</p>"},{"location":"kubernetes_network/ingress/nginx/#nginx_ingress_controller","title":"NGINX Ingress Controller","text":"<p>NGINX Ingress Controller \u662f\u4f7f\u7528 Kubernetes Ingress \u8d44\u6e90\u5bf9\u8c61\u6784\u5efa\u7684\uff0c\u7528 ConfigMap \u6765\u5b58\u50a8 Nginx \u914d\u7f6e\u7684\u4e00\u79cd Ingress Controller \u5b9e\u73b0\u3002</p> <p>\u8981\u4f7f\u7528 Ingress \u5bf9\u5916\u66b4\u9732\u670d\u52a1\uff0c\u5c31\u9700\u8981\u63d0\u524d\u5b89\u88c5\u4e00\u4e2a Ingress Controller\uff0c\u6211\u4eec\u8fd9\u91cc\u5c31\u5148\u6765\u5b89\u88c5 NGINX Ingress Controller\uff0c\u7531\u4e8e nginx-ingress \u6240\u5728\u7684\u8282\u70b9\u9700\u8981\u80fd\u591f\u8bbf\u95ee\u5916\u7f51\uff0c\u8fd9\u6837\u57df\u540d\u53ef\u4ee5\u89e3\u6790\u5230\u8fd9\u4e9b\u8282\u70b9\u4e0a\u76f4\u63a5\u4f7f\u7528\uff0c\u6240\u4ee5\u9700\u8981\u8ba9 nginx-ingress \u7ed1\u5b9a\u8282\u70b9\u7684 80 \u548c 443 \u7aef\u53e3\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528 hostPort \u6765\u8fdb\u884c\u8bbf\u95ee\uff0c\u5f53\u7136\u5bf9\u4e8e\u7ebf\u4e0a\u73af\u5883\u6765\u8bf4\u4e3a\u4e86\u4fdd\u8bc1\u9ad8\u53ef\u7528\uff0c\u4e00\u822c\u662f\u9700\u8981\u8fd0\u884c\u591a\u4e2a nginx-ingress \u5b9e\u4f8b\u7684\uff0c\u7136\u540e\u53ef\u4ee5\u7528\u4e00\u4e2a nginx/haproxy \u4f5c\u4e3a\u5165\u53e3\uff0c\u901a\u8fc7 keepalived \u6765\u8bbf\u95ee\u8fb9\u7f18\u8282\u70b9\u7684 vip \u5730\u5740\u3002</p> <p>\u8fb9\u7f18\u8282\u70b9</p> <p>\u6240\u8c13\u7684\u8fb9\u7f18\u8282\u70b9\u5373\u96c6\u7fa4\u5185\u90e8\u7528\u6765\u5411\u96c6\u7fa4\u5916\u66b4\u9732\u670d\u52a1\u80fd\u529b\u7684\u8282\u70b9\uff0c\u96c6\u7fa4\u5916\u90e8\u7684\u670d\u52a1\u901a\u8fc7\u8be5\u8282\u70b9\u6765\u8c03\u7528\u96c6\u7fa4\u5185\u90e8\u7684\u670d\u52a1\uff0c\u8fb9\u7f18\u8282\u70b9\u662f\u96c6\u7fa4\u5185\u5916\u4ea4\u6d41\u7684\u4e00\u4e2aEndpoint\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u9700\u8981\u66f4\u6539\u4e0b\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a</p> <pre><code>$ wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-1/deploy/static/mandatory.yaml\n$ cat mandatory.yaml\n...\ntolerations:  # \u7531\u4e8e\u6211\u8fd9\u91cc\u7684\u8fb9\u7f18\u8282\u70b9\u53ea\u6709master\u4e00\u4e2a\u8282\u70b9\uff0c\u6240\u6709\u9700\u8981\u52a0\u4e0a\u5bb9\u5fcd\n- operator: \"Exists\"\nnodeSelector:  # \u56fa\u5b9a\u5728\u8fb9\u7f18\u8282\u70b9\n  kubernetes.io/hostname: ydzs-master\ncontainers:\n  - name: nginx-ingress-controller\n    image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:1\n    args:\n    - /nginx-ingress-controller\n    - --configmap=$(POD_NAMESPACE)/nginx-configuration\n    - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services\n    - --udp-services-configmap=$(POD_NAMESPACE)/udp-services\n    - --publish-service=$(POD_NAMESPACE)/ingress-nginx\n    - --annotations-prefix=nginx.ingress.kubernetes.io\n    securityContext:\n    allowPrivilegeEscalation: true\n    capabilities:\n      drop:\n        - ALL\n      add:\n        - NET_BIND_SERVICE\n    # www-data -&gt; 33\n    runAsUser: 33\n    env:\n    - name: POD_NAME\n      valueFrom:\n        fieldRef:\n          fieldPath: metadata.name\n    - name: POD_NAMESPACE\n      valueFrom:\n        fieldRef:\n          fieldPath: metadata.namespace\n    ports:\n    - name: http\n      hostPort: 80  # \u4f7f\u7528hostPort\n      containerPort: 80\n    - name: https\n      hostPort: 443  # \u4f7f\u7528hostPort\n      containerPort: 443\n...\n$ kubectl apply -f mandatory.yaml\n</code></pre> <p>\u5b89\u88c5\u540e\u4f1a\u5c06 NGINX Ingress Controller \u5b89\u88c5\u5728\u4e00\u4e2a\u7edf\u4e00\u7684 ingress-nginx \u7684 namespace \u4e0b\u9762\uff1a</p> <pre><code>$ kubectl get pods -n ingress-nginx\nNAME                                       READY   STATUS    RESTARTS   AGE\nnginx-ingress-controller-565459444-6m4cz   1/1     Running   0          38s\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 controller \u7684 Pod \u6240\u5728\u8282\u70b9\u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f\u8fdb\u884c\u9a8c\u8bc1\uff1a</p> <pre><code>$ curl 11\n&lt;html&gt;\n&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;openresty/2&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u51fa\u73b0\u4e86\u4e0a\u9762\u7684\u4fe1\u606f\u8bc1\u660e Ingress Controller \u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u3002</p>"},{"location":"kubernetes_network/ingress/nginx/#ingress_1","title":"Ingress","text":"<p>\u5b89\u88c5\u6210\u529f\u540e\uff0c\u73b0\u5728\u6211\u4eec\u6765\u4e3a\u4e00\u4e2a nginx \u5e94\u7528\u521b\u5efa\u4e00\u4e2a Ingress \u8d44\u6e90\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: my-nginx\nspec:\n  selector:\n    matchLabels:\n      app: my-nginx\n  template:\n    metadata:\n      labels:\n        app: my-nginx\n    spec:\n      containers:\n      - name: my-nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: my-nginx\n  labels:\n    app: my-nginx\nspec:\n  ports:\n  - port: 80\n    protocol: TCP\n    name: http\n  selector:\n    app: my-nginx\n---\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: my-nginx\n  annotations:\n    kubernetes.io/ingress.class: \"nginx\"\nspec:\n  rules:\n  - host: ngdemo.qikqiak.com  # \u5c06\u57df\u540d\u6620\u5c04\u5230 my-nginx \u670d\u52a1\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: my-nginx  # \u5c06\u6240\u6709\u8bf7\u6c42\u53d1\u9001\u5230 my-nginx \u670d\u52a1\u7684 80 \u7aef\u53e3\n          servicePort: 80     # \u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u5927\u90e8\u5206Ingress controller\u90fd\u4e0d\u662f\u76f4\u63a5\u8f6c\u53d1\u5230Service\n                            # \u800c\u662f\u53ea\u662f\u901a\u8fc7Service\u6765\u83b7\u53d6\u540e\u7aef\u7684Endpoints\u5217\u8868\uff0c\u76f4\u63a5\u8f6c\u53d1\u5230Pod\uff0c\u8fd9\u6837\u53ef\u4ee5\u51cf\u5c11\u7f51\u7edc\u8df3\u8f6c\uff0c\u63d0\u9ad8\u6027\u80fd\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f ngdemo.yaml\ndeployment.apps \"my-nginx\" created\nservice \"my-nginx\" created\ningress.extensions \"my-nginx\" created\n</code></pre> <p>\u6ce8\u610f\u6211\u4eec\u5728 Ingress \u8d44\u6e90\u5bf9\u8c61\u4e2d\u6dfb\u52a0\u4e86\u4e00\u4e2a annotations\uff1a</p> <pre><code>kubernetes.io/ingress.class: \"nginx\"\n</code></pre> <p>\uff0c\u8fd9\u5c31\u662f\u6307\u5b9a\u8ba9\u8fd9\u4e2a Ingress \u901a\u8fc7 nginx-ingress \u6765\u5904\u7406\u3002</p> <p>\u4e0a\u9762\u8d44\u6e90\u521b\u5efa\u6210\u529f\u540e\uff0c\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u5c06\u57df\u540d<code>ngdemo.qikqiak.com</code>\u89e3\u6790\u5230<code>nginx-ingress</code>\u6240\u5728\u7684<code>\u8fb9\u7f18\u8282\u70b9</code>\u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u5728\u672c\u5730<code>/etc/hosts</code>\u4e2d\u6dfb\u52a0\u5bf9\u5e94\u7684\u6620\u5c04\u4e5f\u53ef\u4ee5\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7\u57df\u540d\u8fdb\u884c\u8bbf\u95ee\u4e86\u3002</p> <p></p> <p>\u4e0b\u56fe\u663e\u793a\u4e86\u5ba2\u6237\u7aef\u662f\u5982\u679c\u901a\u8fc7 Ingress Controller \u8fde\u63a5\u5230\u5176\u4e2d\u4e00\u4e2a Pod \u7684\u6d41\u7a0b\uff0c\u5ba2\u6237\u7aef\u9996\u5148\u5bf9 <code>ngdemo.qikqiak.com</code> \u6267\u884c DNS \u89e3\u6790\uff0c\u5f97\u5230 Ingress Controller \u6240\u5728\u8282\u70b9\u7684 IP\uff0c\u7136\u540e\u5ba2\u6237\u7aef\u5411 Ingress Controller \u53d1\u9001 HTTP \u8bf7\u6c42\uff0c\u7136\u540e\u6839\u636e Ingress \u5bf9\u8c61\u91cc\u9762\u7684\u63cf\u8ff0\u5339\u914d\u57df\u540d\uff0c\u627e\u5230\u5bf9\u5e94\u7684 Service \u5bf9\u8c61\uff0c\u5e76\u83b7\u53d6\u5173\u8054\u7684 Endpoints \u5217\u8868\uff0c\u5c06\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u8f6c\u53d1\u7ed9\u5176\u4e2d\u4e00\u4e2a Pod\u3002</p> <p></p>"},{"location":"kubernetes_network/ingress/nginx/#url_rewrite","title":"URL Rewrite","text":"<p>NGINX Ingress Controller \u5f88\u591a\u9ad8\u7ea7\u7684\u7528\u6cd5\u53ef\u4ee5\u901a\u8fc7 Ingress \u5bf9\u8c61\u7684 <code>annotation</code> \u8fdb\u884c\u914d\u7f6e\uff0c\u6bd4\u5982\u5e38\u7528\u7684 URL Rewrite \u529f\u80fd\uff0c\u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a todo \u7684\u524d\u7aef\u5e94\u7528\uff0c\u5bf9\u5e94\u7684 Ingress \u8d44\u6e90\u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: fe\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.class: \"nginx\"\nspec:\n  rules:\n  - host: todo.qikqiak.com\n    http:\n      paths:\n      - backend:\n          serviceName: fe\n          servicePort: 3000\n        path: /\n</code></pre> <p>\u5c31\u662f\u4e00\u4e2a\u5f88\u5e38\u89c4\u7684 <code>Ingress</code> \u5bf9\u8c61\uff0c\u90e8\u7f72\u8be5\u5bf9\u8c61\u540e\uff0c\u5c06\u57df\u540d\u89e3\u6790\u540e\u5c31\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\u5230\u5e94\u7528\uff1a</p> <p></p> <p>\u73b0\u5728\u6211\u4eec\u9700\u8981\u5bf9\u8bbf\u95ee\u7684 URL \u8def\u5f84\u505a\u4e00\u4e2a Rewrite\uff0c\u6bd4\u5982\u5728 PATH \u4e2d\u6dfb\u52a0\u4e00\u4e2a app \u7684\u524d\u7f00\uff0c\u5173\u4e8e Rewrite \u7684\u64cd\u4f5c\u5728 ingress-nginx \u5b98\u65b9\u6587\u6863\u4e2d\u4e5f\u7ed9\u51fa\u5bf9\u5e94\u7684\u8bf4\u660e:</p> <p></p> <p>\u6309\u7167\u8981\u6c42\u6211\u4eec\u9700\u8981\u5728 <code>path</code> \u4e2d\u5339\u914d\u524d\u7f00 <code>app</code>\uff0c\u7136\u540e\u901a\u8fc7 <code>rewrite-target</code> \u6307\u5b9a\u76ee\u6807\uff0c\u4fee\u6539\u540e\u7684 Ingress \u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: fe\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.class: \"nginx\"\n    nginx.ingress.kubernetes.io/rewrite-target: /$2\nspec:\n  rules:\n  - host: todo.qikqiak.com\n    http:\n      paths:\n      - backend:\n          serviceName: fe\n          servicePort: 3000\n        path: /app(/|$)(.*)\n</code></pre> <p>\u66f4\u65b0\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u9047\u89c1\u5230\u76f4\u63a5\u8bbf\u95ee\u57df\u540d\u80af\u5b9a\u662f\u4e0d\u884c\u4e86\uff0c\u56e0\u4e3a\u6211\u4eec\u6ca1\u6709\u5339\u914d <code>/</code> \u7684 path \u8def\u5f84\uff1a</p> <p></p> <p>\u4f46\u662f\u6211\u4eec\u5e26\u4e0a <code>app</code> \u7684\u524d\u7f00\u518d\u53bb\u8bbf\u95ee:</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u53ef\u4ee5\u8bbf\u95ee\u5230\u9875\u9762\u5185\u5bb9\u4e86\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u5728 <code>path</code> \u4e2d\u901a\u8fc7\u6b63\u5219\u8868\u8fbe\u5f0f <code>/app(/|$)(.*)</code> \u5c06\u5339\u914d\u7684\u8def\u5f84\u8bbe\u7f6e\u6210\u4e86 <code>rewrite-target</code> \u7684\u76ee\u6807\u8def\u5f84\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u8bbf\u95ee <code>todo.qikqiak.com/app</code> \u7684\u65f6\u5019\u5b9e\u9645\u4e0a\u76f8\u5f53\u4e8e\u8bbf\u95ee\u7684\u5c31\u662f\u540e\u7aef\u670d\u52a1\u7684 <code>/</code> \u8def\u5f84\uff0c\u4f46\u662f\u6211\u4eec\u4e5f\u53ef\u4ee5\u53d1\u73b0\u73b0\u5728\u9875\u9762\u7684\u6837\u5f0f\u6ca1\u6709\u4e86\uff1a</p> <p></p> <p>\u8fd9\u662f\u56e0\u4e3a\u5e94\u7528\u7684\u9759\u6001\u8d44\u6e90\u8def\u5f84\u662f\u5728 <code>/stylesheets</code> \u8def\u5f84\u4e0b\u9762\u7684\uff0c\u73b0\u5728\u6211\u4eec\u505a\u4e86 url rewrite \u8fc7\u540e\uff0c\u8981\u6b63\u5e38\u8bbf\u95ee\u4e5f\u9700\u8981\u5e26\u4e0a\u524d\u7f00\u624d\u53ef\u4ee5\uff1a</p> <pre><code>http://todo.qikqiak.com/stylesheets/screen.css\n</code></pre> <p>\uff0c\u5bf9\u4e8e\u56fe\u7247\u6216\u8005\u5176\u4ed6\u9759\u6001\u8d44\u6e90\u4e5f\u662f\u5982\u6b64\uff0c\u5f53\u7136\u6211\u4eec\u53bb\u66f4\u6539\u9875\u9762\u5f15\u5165\u9759\u6001\u8d44\u6e90\u7684\u65b9\u5f0f\u4e3a\u76f8\u5bf9\u8def\u5f84\u4e5f\u662f\u53ef\u4ee5\u7684\uff0c\u4f46\u662f\u6bd5\u7adf\u8981\u4fee\u6539\u4ee3\u7801\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u501f\u52a9 <code>ingress-nginx</code> \u4e2d\u7684 </p> <pre><code>configuration-snippet\n</code></pre> <p>\u6765\u5bf9\u9759\u6001\u8d44\u6e90\u505a\u4e00\u6b21\u8df3\u8f6c\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: fe\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.class: \"nginx\"\n    nginx.ingress.kubernetes.io/rewrite-target: /$2\n    nginx.ingress.kubernetes.io/configuration-snippet: |\n      rewrite ^/stylesheets/(.*)$ /app/stylesheets/$1 redirect;  # \u6dfb\u52a0 /app \u524d\u7f00\n      rewrite ^/images/(.*)$ /app/images/$1 redirect;  # \u6dfb\u52a0 /app \u524d\u7f00\nspec:\n  rules:\n  - host: todo.qikqiak.com\n    http:\n      paths:\n      - backend:\n          serviceName: fe\n          servicePort: 3000\n        path: /app(/|$)(.*)\n</code></pre> <p>\u66f4\u65b0 Ingress \u5bf9\u8c61\u540e\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5237\u65b0\u9875\u9762\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6b63\u5e38\u4e86\uff1a</p> <p></p> <p>\u8981\u89e3\u51b3\u6211\u4eec\u8bbf\u95ee\u4e3b\u57df\u540d\u51fa\u73b0 404 \u7684\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u7ed9\u5e94\u7528\u8bbe\u7f6e\u4e00\u4e2a <code>app-root</code> \u7684\u6ce8\u89e3\uff0c\u8fd9\u6837\u5f53\u6211\u4eec\u8bbf\u95ee\u4e3b\u57df\u540d\u7684\u65f6\u5019\u4f1a\u81ea\u52a8\u8df3\u8f6c\u5230\u6211\u4eec\u6307\u5b9a\u7684 <code>app-root</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: fe\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.class: \"nginx\"\n    nginx.ingress.kubernetes.io/app-root: /app/\n    nginx.ingress.kubernetes.io/rewrite-target: /$2\n    nginx.ingress.kubernetes.io/configuration-snippet: |\n      rewrite ^/stylesheets/(.*)$ /app/stylesheets/$1 redirect;  # \u6dfb\u52a0 /app \u524d\u7f00\n      rewrite ^/images/(.*)$ /app/images/$1 redirect;  # \u6dfb\u52a0 /app \u524d\u7f00\nspec:\n  rules:\n  - host: todo.qikqiak.com\n    http:\n      paths:\n      - backend:\n          serviceName: fe\n          servicePort: 3000\n        path: /app(/|$)(.*)\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u66f4\u65b0\u5e94\u7528\u540e\u8bbf\u95ee\u4e3b\u57df\u540d </p> <pre><code>http://todo.qikqiak.com\n</code></pre> <p>\u5c31\u4f1a\u81ea\u52a8\u8df3\u8f6c\u5230 </p> <pre><code>http://todo.qikqiak.com/app/\n</code></pre> <p>\u8def\u5f84\u4e0b\u9762\u53bb\u4e86\u3002\u4f46\u662f\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\u662f\u6211\u4eec\u7684 path \u8def\u5f84\u5176\u5b9e\u4e5f\u5339\u914d\u4e86 <code>/app</code> \u8fd9\u6837\u7684\u8def\u5f84\uff0c\u53ef\u80fd\u6211\u4eec\u66f4\u52a0\u5e0c\u671b\u6211\u4eec\u7684\u5e94\u7528\u5728\u6700\u540e\u6dfb\u52a0\u4e00\u4e2a <code>/</code> \u8fd9\u6837\u7684 slash\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>configuration-snippet\n</code></pre> <p>\u914d\u7f6e\u6765\u5b8c\u6210\uff0c\u5982\u4e0b Ingress \u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: fe\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.class: \"nginx\"\n    nginx.ingress.kubernetes.io/app-root: /app/\n    nginx.ingress.kubernetes.io/rewrite-target: /$2\n    nginx.ingress.kubernetes.io/configuration-snippet: |\n      rewrite ^(/app)$ $1/ redirect;\n      rewrite ^/stylesheets/(.*)$ /app/stylesheets/$1 redirect;\n      rewrite ^/images/(.*)$ /app/images/$1 redirect;\nspec:\n  rules:\n  - host: todo.qikqiak.com\n    http:\n      paths:\n      - backend:\n          serviceName: fe\n          servicePort: 3000\n        path: /app(/|$)(.*)\n</code></pre> <p>\u66f4\u65b0\u540e\u6211\u4eec\u7684\u5e94\u7528\u5c31\u90fd\u4f1a\u4ee5 <code>/</code> \u8fd9\u6837\u7684 slash \u7ed3\u5c3e\u4e86\u3002\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u6211\u4eec\u7684\u9700\u6c42\uff0c\u5982\u679c\u4f60\u539f\u672c\u5bf9 nginx \u7684\u914d\u7f6e\u5c31\u975e\u5e38\u719f\u6089\u7684\u8bdd\u5e94\u8be5\u53ef\u4ee5\u5f88\u5feb\u5c31\u80fd\u7406\u89e3\u8fd9\u79cd\u914d\u7f6e\u65b9\u5f0f\u4e86\u3002</p>"},{"location":"kubernetes_network/ingress/nginx/#basic_auth","title":"Basic Auth","text":"<p>\u540c\u6837\u6211\u4eec\u8fd8\u53ef\u4ee5\u5728 Ingress Controller \u4e0a\u9762\u914d\u7f6e\u4e00\u4e9b\u57fa\u672c\u7684 Auth \u8ba4\u8bc1\uff0c\u6bd4\u5982 Basic Auth\uff0c\u53ef\u4ee5\u7528 htpasswd \u751f\u6210\u4e00\u4e2a\u5bc6\u7801\u6587\u4ef6\u6765\u9a8c\u8bc1\u8eab\u4efd\u9a8c\u8bc1\u3002</p> <pre><code>$ htpasswd -c auth foo\nNew password:\nRe-type new password:\nAdding password for user foo\n</code></pre> <p>\u7136\u540e\u6839\u636e\u4e0a\u9762\u7684 auth \u6587\u4ef6\u521b\u5efa\u4e00\u4e2a secret \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create secret generic basic-auth --from-file=auth\nsecret/basic-auth created\n$ kubectl get secret basic-auth -o yaml\napiVersion: v1\ndata:\n  auth: Zm9vOiRhcHIxJFNjcVhZcFN6JDc4Nm5ISFNaeDdwN2VscDM2WUo0YS8K\nkind: Secret\nmetadata:\n  creationTimestamp: \"2019-12-08T06:40:39Z\"\n  name: basic-auth\n  namespace: default\n  resourceVersion: \"9197951\"\n  selfLink: /api/v1/namespaces/default/secrets/basic-auth\n  uid: 6b2aa299-b511-412e-85ea-d0e91e578af0\ntype: Opaque\n</code></pre> <p>\u7136\u540e\u5bf9\u4e0a\u9762\u7684 my-nginx \u5e94\u7528\u521b\u5efa\u4e00\u4e2a\u5177\u6709 Basic Auth \u7684 Ingress \u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: ingress-with-auth\n  annotations:\n    # \u8ba4\u8bc1\u7c7b\u578b\n    nginx.ingress.kubernetes.io/auth-type: basic\n    # \u5305\u542b user/password \u5b9a\u4e49\u7684 secret \u5bf9\u8c61\u540d\n    nginx.ingress.kubernetes.io/auth-secret: basic-auth\n    # \u8981\u663e\u793a\u7684\u5e26\u6709\u9002\u5f53\u4e0a\u4e0b\u6587\u7684\u6d88\u606f\uff0c\u8bf4\u660e\u9700\u8981\u8eab\u4efd\u9a8c\u8bc1\u7684\u539f\u56e0\n    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required - foo'\nspec:\n  rules:\n  - host: foo.bar.com\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: my-nginx\n          servicePort: 80\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u7136\u540e\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6216\u8005\u5728\u6d4f\u89c8\u5668\u4e2d\u76f4\u63a5\u6253\u5f00\u914d\u7f6e\u7684\u57df\u540d\uff1a</p> <pre><code>$ curl -v http://k8s.youdianzhishi.com -H 'Host: foo.bar.com'\n* Rebuilt URL to: http://k8s.youdianzhishi.com/\n*   Trying 11..\n* TCP_NODELAY set\n* Connected to k8s.youdianzhishi.com (1111) port 80 (#0)\n&gt; GET / HTTP/1\n&gt; Host: foo.bar.com\n&gt; User-Agent: curl/0\n&gt; Accept: */*\n&gt;\n&lt; HTTP/1 401 Unauthorized\n&lt; Server: openresty/2\n&lt; Date: Sun, 08 Dec 2019 06:44:35 GMT\n&lt; Content-Type: text/html\n&lt; Content-Length: 185\n&lt; Connection: keep-alive\n&lt; WWW-Authenticate: Basic realm=\"Authentication Required - foo\"\n&lt;\n&lt;html&gt;\n&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;openresty/2&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u51fa\u73b0\u4e86 401 \u8ba4\u8bc1\u5931\u8d25\u9519\u8bef\uff0c\u7136\u540e\u5e26\u4e0a\u6211\u4eec\u914d\u7f6e\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\u8fdb\u884c\u8ba4\u8bc1\uff1a</p> <pre><code>$ curl -v http://k8s.youdianzhishi.com -H 'Host: foo.bar.com' -u 'foo:foo'\n* Rebuilt URL to: http://k8s.youdianzhishi.com/\n*   Trying 11..\n* TCP_NODELAY set\n* Connected to k8s.youdianzhishi.com (1111) port 80 (#0)\n* Server auth using Basic with user 'foo'\n&gt; GET / HTTP/1\n&gt; Host: foo.bar.com\n&gt; Authorization: Basic Zm9vOmZvbw==\n&gt; User-Agent: curl/0\n&gt; Accept: */*\n&gt;\n&lt; HTTP/1 200 OK\n&lt; Server: openresty/2\n&lt; Date: Sun, 08 Dec 2019 06:46:27 GMT\n&lt; Content-Type: text/html\n&lt; Content-Length: 612\n&lt; Connection: keep-alive\n&lt; Vary: Accept-Encoding\n&lt; Last-Modified: Tue, 19 Nov 2019 12:50:08 GMT\n&lt; ETag: \"5dd3e500-264\"\n&lt; Accept-Ranges: bytes\n&lt;\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u8ba4\u8bc1\u6210\u529f\u4e86\u3002\u5f53\u7136\u51fa\u6765 Basic Auth \u8fd9\u4e00\u79cd\u7b80\u5355\u7684\u8ba4\u8bc1\u65b9\u5f0f\u4e4b\u5916\uff0cNGINX Ingress Controller \u8fd8\u652f\u6301\u4e00\u4e9b\u5176\u4ed6\u9ad8\u7ea7\u7684\u8ba4\u8bc1\uff0c\u6bd4\u5982 OAUTH \u8ba4\u8bc1\u4e4b\u7c7b\u7684\u3002</p>"},{"location":"kubernetes_network/ingress/nginx/#https","title":"HTTPS","text":"<p>\u5982\u679c\u6211\u4eec\u9700\u8981\u7528 HTTPS \u6765\u8bbf\u95ee\u6211\u4eec\u8fd9\u4e2a\u5e94\u7528\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u76d1\u542c 443 \u7aef\u53e3\u4e86\uff0c\u540c\u6837\u7528 HTTPS \u8bbf\u95ee\u5e94\u7528\u5fc5\u7136\u5c31\u9700\u8981\u8bc1\u4e66\uff0c\u8fd9\u91cc\u6211\u4eec\u7528 <code>openssl</code> \u6765\u521b\u5efa\u4e00\u4e2a\u81ea\u7b7e\u540d\u7684\u8bc1\u4e66\uff1a</p> <pre><code>$ openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj \"/CN=foo.bar.com\"\n</code></pre> <p>\u7136\u540e\u901a\u8fc7 Secret \u5bf9\u8c61\u6765\u5f15\u7528\u8bc1\u4e66\u6587\u4ef6\uff1a</p> <pre><code># \u8981\u6ce8\u610f\u8bc1\u4e66\u6587\u4ef6\u540d\u79f0\u5fc5\u987b\u662f tls.crt \u548c tls.key\n$ kubectl create secret tls foo-tls --cert=tls.crt --key=tls.key\nsecret/who-tls created\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a HTTPS \u8bbf\u95ee\u5e94\u7528\u7684\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: ingress-with-auth\n  annotations:\n    # \u8ba4\u8bc1\u7c7b\u578b\n    nginx.ingress.kubernetes.io/auth-type: basic\n    # \u5305\u542b user/password \u5b9a\u4e49\u7684 secret \u5bf9\u8c61\u540d\n    nginx.ingress.kubernetes.io/auth-secret: basic-auth\n    # \u8981\u663e\u793a\u7684\u5e26\u6709\u9002\u5f53\u4e0a\u4e0b\u6587\u7684\u6d88\u606f\uff0c\u8bf4\u660e\u9700\u8981\u8eab\u4efd\u9a8c\u8bc1\u7684\u539f\u56e0\n    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required - foo'\nspec:\n  rules:\n  - host: foo.bar.com\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: my-nginx\n          servicePort: 80\n  tls:\n  - hosts:\n    - foo.bar.com\n    secretName: foo-tls\n</code></pre>"},{"location":"kubernetes_network/ingress/traefik/","title":"Traefik","text":""},{"location":"kubernetes_network/ingress/traefik/#traefik","title":"Traefik","text":"<p>Traefik \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u53ef\u4ee5\u4f7f\u670d\u52a1\u53d1\u5e03\u53d8\u5f97\u8f7b\u677e\u6709\u8da3\u7684\u8fb9\u7f18\u8def\u7531\u5668\u3002\u5b83\u8d1f\u8d23\u63a5\u6536\u4f60\u7cfb\u7edf\u7684\u8bf7\u6c42\uff0c\u7136\u540e\u4f7f\u7528\u5408\u9002\u7684\u7ec4\u4ef6\u6765\u5bf9\u8fd9\u4e9b\u8bf7\u6c42\u8fdb\u884c\u5904\u7406\u3002</p> <p></p> <p>\u9664\u4e86\u4f17\u591a\u7684\u529f\u80fd\u4e4b\u5916\uff0cTraefik \u7684\u4e0e\u4f17\u4e0d\u540c\u4e4b\u5904\u8fd8\u5728\u4e8e\u5b83\u4f1a\u81ea\u52a8\u53d1\u73b0\u9002\u5408\u4f60\u670d\u52a1\u7684\u914d\u7f6e\u3002\u5f53 Traefik \u5728\u68c0\u67e5\u4f60\u7684\u670d\u52a1\u65f6\uff0c\u4f1a\u627e\u5230\u670d\u52a1\u7684\u76f8\u5173\u4fe1\u606f\u5e76\u627e\u5230\u5408\u9002\u7684\u670d\u52a1\u6765\u6ee1\u8db3\u5bf9\u5e94\u7684\u8bf7\u6c42\u3002</p> <p>Traefik \u517c\u5bb9\u6240\u6709\u4e3b\u6d41\u7684\u96c6\u7fa4\u6280\u672f\uff0c\u6bd4\u5982 Kubernetes\uff0cDocker\uff0cDocker Swarm\uff0cAWS\uff0cMesos\uff0cMarathon\uff0c\u7b49\u7b49\uff1b\u5e76\u4e14\u53ef\u4ee5\u540c\u65f6\u5904\u7406\u591a\u79cd\u65b9\u5f0f\u3002\uff08\u751a\u81f3\u53ef\u4ee5\u7528\u4e8e\u5728\u88f8\u673a\u4e0a\u8fd0\u884c\u7684\u6bd4\u8f83\u65e7\u7684\u8f6f\u4ef6\u3002\uff09</p> <p>\u4f7f\u7528 Traefik\uff0c\u4e0d\u9700\u8981\u7ef4\u62a4\u6216\u8005\u540c\u6b65\u4e00\u4e2a\u72ec\u7acb\u7684\u914d\u7f6e\u6587\u4ef6\uff1a\u56e0\u4e3a\u4e00\u5207\u90fd\u4f1a\u81ea\u52a8\u914d\u7f6e\uff0c\u5b9e\u65f6\u64cd\u4f5c\u7684\uff08\u65e0\u9700\u91cd\u65b0\u542f\u52a8\uff0c\u4e0d\u4f1a\u4e2d\u65ad\u8fde\u63a5\uff09\u3002\u4f7f\u7528 Traefik\uff0c\u4f60\u53ef\u4ee5\u82b1\u66f4\u591a\u7684\u65f6\u95f4\u5728\u7cfb\u7edf\u7684\u5f00\u53d1\u548c\u65b0\u529f\u80fd\u4e0a\u9762\uff0c\u800c\u4e0d\u662f\u5728\u914d\u7f6e\u548c\u7ef4\u62a4\u5de5\u4f5c\u72b6\u6001\u4e0a\u9762\u82b1\u8d39\u5927\u91cf\u65f6\u95f4\u3002</p>"},{"location":"kubernetes_network/ingress/traefik/#_1","title":"\u6838\u5fc3\u6982\u5ff5","text":"<p>Traefik \u662f\u4e00\u4e2a\u8fb9\u7f18\u8def\u7531\u5668\uff0c\u662f\u4f60\u6574\u4e2a\u5e73\u53f0\u7684\u5927\u95e8\uff0c\u62e6\u622a\u5e76\u8def\u7531\u6bcf\u4e2a\u4f20\u5165\u7684\u8bf7\u6c42\uff1a\u5b83\u77e5\u9053\u6240\u6709\u7684\u903b\u8f91\u548c\u89c4\u5219\uff0c\u8fd9\u4e9b\u89c4\u5219\u786e\u5b9a\u54ea\u4e9b\u670d\u52a1\u5904\u7406\u54ea\u4e9b\u8bf7\u6c42\uff1b\u4f20\u7edf\u7684\u53cd\u5411\u4ee3\u7406\u9700\u8981\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b\u8def\u7531\u5230\u4f60\u670d\u52a1\u7684\u6240\u6709\u53ef\u80fd\u8def\u7531\uff0c\u800c Traefik \u4f1a\u5b9e\u65f6\u68c0\u6d4b\u670d\u52a1\u5e76\u81ea\u52a8\u66f4\u65b0\u8def\u7531\u89c4\u5219\uff0c\u53ef\u4ee5\u81ea\u52a8\u670d\u52a1\u53d1\u73b0\u3002</p> <p></p> <p>\u9996\u5148\uff0c\u5f53\u542f\u52a8 Traefik \u65f6\uff0c\u9700\u8981\u5b9a\u4e49 <code>entrypoints</code>\uff08\u5165\u53e3\u70b9\uff09\uff0c\u7136\u540e\uff0c\u6839\u636e\u8fde\u63a5\u5230\u8fd9\u4e9b entrypoints \u7684<code>\u8def\u7531</code>\u6765\u5206\u6790\u4f20\u5165\u7684\u8bf7\u6c42\uff0c\u6765\u67e5\u770b\u4ed6\u4eec\u662f\u5426\u4e0e\u4e00\u7ec4<code>\u89c4\u5219</code>\u76f8\u5339\u914d\uff0c\u5982\u679c\u5339\u914d\uff0c\u5219\u8def\u7531\u53ef\u80fd\u4f1a\u5c06\u8bf7\u6c42\u901a\u8fc7\u4e00\u7cfb\u5217<code>\u4e2d\u95f4\u4ef6</code>\u8f6c\u6362\u8fc7\u540e\u518d\u8f6c\u53d1\u5230\u4f60\u7684<code>\u670d\u52a1</code>\u4e0a\u53bb\u3002\u5728\u4e86\u89e3 Traefik \u4e4b\u524d\u6709\u51e0\u4e2a\u6838\u5fc3\u6982\u5ff5\u6211\u4eec\u5fc5\u987b\u8981\u4e86\u89e3\uff1a</p> <ul> <li><code>Providers</code>\u00a0\u7528\u6765\u81ea\u52a8\u53d1\u73b0\u5e73\u53f0\u4e0a\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u662f\u7f16\u6392\u5de5\u5177\u3001\u5bb9\u5668\u5f15\u64ce\u6216\u8005 key-value \u5b58\u50a8\u7b49\uff0c\u6bd4\u5982 Docker\u3001Kubernetes\u3001File</li> <li><code>Entrypoints</code>\u00a0\u76d1\u542c\u4f20\u5165\u7684\u6d41\u91cf\uff08\u7aef\u53e3\u7b49\u2026\uff09\uff0c\u662f\u7f51\u7edc\u5165\u53e3\u70b9\uff0c\u5b83\u4eec\u5b9a\u4e49\u4e86\u63a5\u6536\u8bf7\u6c42\u7684\u7aef\u53e3\uff08HTTP \u6216\u8005 TCP\uff09\u3002</li> <li><code>Routers</code>\u00a0\u5206\u6790\u8bf7\u6c42\uff08host, path, headers, SSL, \u2026\uff09\uff0c\u8d1f\u8d23\u5c06\u4f20\u5165\u8bf7\u6c42\u8fde\u63a5\u5230\u53ef\u4ee5\u5904\u7406\u8fd9\u4e9b\u8bf7\u6c42\u7684\u670d\u52a1\u4e0a\u53bb\u3002</li> <li><code>Services</code>\u00a0\u5c06\u8bf7\u6c42\u8f6c\u53d1\u7ed9\u4f60\u7684\u5e94\u7528\uff08load balancing, \u2026\uff09\uff0c\u8d1f\u8d23\u914d\u7f6e\u5982\u4f55\u83b7\u53d6\u6700\u7ec8\u5c06\u5904\u7406\u4f20\u5165\u8bf7\u6c42\u7684\u5b9e\u9645\u670d\u52a1\u3002</li> <li><code>Middlewares</code>\u00a0\u4e2d\u95f4\u4ef6\uff0c\u7528\u6765\u4fee\u6539\u8bf7\u6c42\u6216\u8005\u6839\u636e\u8bf7\u6c42\u6765\u505a\u51fa\u4e00\u4e9b\u5224\u65ad\uff08authentication, rate limiting, headers, ...\uff09\uff0c\u4e2d\u95f4\u4ef6\u88ab\u9644\u4ef6\u5230\u8def\u7531\u4e0a\uff0c\u662f\u4e00\u79cd\u5728\u8bf7\u6c42\u53d1\u9001\u5230\u4f60\u7684<code>\u670d\u52a1</code>\u4e4b\u524d\uff08\u6216\u8005\u5728\u670d\u52a1\u7684\u54cd\u5e94\u53d1\u9001\u5230\u5ba2\u6237\u7aef\u4e4b\u524d\uff09\u8c03\u6574\u8bf7\u6c42\u7684\u4e00\u79cd\u65b9\u6cd5\u3002</li> </ul>"},{"location":"kubernetes_network/ingress/traefik/#_2","title":"\u5b89\u88c5","text":"<p>\u7531\u4e8e Traefik 2.X \u7248\u672c\u548c\u4e4b\u524d\u7684 1.X \u7248\u672c\u4e0d\u517c\u5bb9\uff0c\u6211\u4eec\u8fd9\u91cc\u9009\u62e9\u529f\u80fd\u66f4\u52a0\u5f3a\u5927\u7684 2.X \u7248\u672c\u6765\u548c\u5927\u5bb6\u8fdb\u884c\u8bb2\u89e3\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u955c\u50cf\u662f <code>traefik:2.1.1</code>\u3002</p> <p>\u5728 Traefik \u4e2d\u7684\u914d\u7f6e\u53ef\u4ee5\u4f7f\u7528\u4e24\u79cd\u4e0d\u540c\u7684\u65b9\u5f0f\uff1a</p> <ul> <li>\u52a8\u6001\u914d\u7f6e\uff1a\u5b8c\u5168\u52a8\u6001\u7684\u8def\u7531\u914d\u7f6e</li> <li>\u9759\u6001\u914d\u7f6e\uff1a\u542f\u52a8\u914d\u7f6e</li> </ul> <p><code>\u9759\u6001\u914d\u7f6e</code>\u4e2d\u7684\u5143\u7d20\uff08\u8fd9\u4e9b\u5143\u7d20\u4e0d\u4f1a\u7ecf\u5e38\u66f4\u6539\uff09\u8fde\u63a5\u5230 providers \u5e76\u5b9a\u4e49 Treafik \u5c06\u8981\u76d1\u542c\u7684 entrypoints\u3002</p> <p>\u5728 Traefik \u4e2d\u6709\u4e09\u79cd\u65b9\u5f0f\u5b9a\u4e49\u9759\u6001\u914d\u7f6e\uff1a\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u3001\u5728\u547d\u4ee4\u884c\u53c2\u6570\u4e2d\u3001\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u4f20\u9012</p> <p><code>\u52a8\u6001\u914d\u7f6e</code>\u5305\u542b\u5b9a\u4e49\u7cfb\u7edf\u5982\u4f55\u5904\u7406\u8bf7\u6c42\u7684\u6240\u6709\u914d\u7f6e\u5185\u5bb9\uff0c\u8fd9\u4e9b\u914d\u7f6e\u662f\u53ef\u4ee5\u6539\u53d8\u7684\uff0c\u800c\u4e14\u662f\u65e0\u7f1d\u70ed\u66f4\u65b0\u7684\uff0c\u6ca1\u6709\u4efb\u4f55\u8bf7\u6c42\u4e2d\u65ad\u6216\u8fde\u63a5\u635f\u8017\u3002</p> <p>\u5b89\u88c5 Traefik \u5230 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u6211\u8fd9\u91cc\u63d0\u524d\u51c6\u5907\u597d\u4e86\uff0c\u76f4\u63a5\u6267\u884c\u4e0b\u9762\u7684\u5b89\u88c5\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f https://www.qikqiak.com/k8strain/network/manifests/traefik/crd.yaml\n$ kubectl apply -f https://www.qikqiak.com/k8strain/network/manifests/traefik/rbac.yaml\n$ kubectl apply -f https://www.qikqiak.com/k8strain/network/manifests/traefik/deployment.yaml\n$ kubectl apply -f https://www.qikqiak.com/k8strain/network/manifests/traefik/dashboard.yaml\n</code></pre> <p>\u5176\u4e2d <code>deployment.yaml</code> \u6211\u8fd9\u91cc\u662f\u56fa\u5b9a\u5230 master \u8282\u70b9\u4e0a\u7684\uff0c\u5982\u679c\u4f60\u9700\u8981\u4fee\u6539\u53ef\u4ee5\u4e0b\u8f7d\u4e0b\u6765\u505a\u76f8\u5e94\u7684\u4fee\u6539\u5373\u53ef\u3002\u6211\u4eec\u8fd9\u91cc\u662f\u901a\u8fc7\u547d\u4ee4\u884c\u53c2\u6570\u6765\u505a\u7684\u9759\u6001\u914d\u7f6e\uff1a</p> <pre><code>args:\n- --entryPoints.web.address=:80\n- --entryPoints.websecure.address=:443\n- --api=true\n- --api.dashboard=true\n- --ping=true\n- --providers.kubernetesingress\n- --providers.kubernetescrd\n- --log.level=INFO\n- --accesslog\n</code></pre> <p>\u5176\u4e2d\u524d\u4e24\u9879\u914d\u7f6e\u662f\u6765\u5b9a\u4e49 <code>web</code> \u548c <code>websecure</code> \u8fd9\u4e24\u4e2a\u5165\u53e3\u70b9\u7684\uff0c<code>--api=true</code> \u5f00\u542f,=\uff0c\u5c31\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>api@internal</code> \u7684\u7279\u6b8a service\uff0c\u5728 dashboard \u4e2d\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a service \u6765\u8bbf\u95ee\uff0c\u7136\u540e\u5176\u4ed6\u6bd4\u8f83\u91cd\u8981\u7684\u5c31\u662f\u5f00\u542f <code>kubernetesingress</code> \u548c <code>kubernetescrd</code> \u8fd9\u4e24\u4e2a provider\u3002</p> <p><code>dashboard.yaml</code> \u4e2d\u5b9a\u4e49\u7684\u662f\u8bbf\u95ee dashboard \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u4fee\u6539\u3002</p> <pre><code>$ kubectl get pods -n kube-system                       \nNAME                                  READY   STATUS    RESTARTS   AGE\ntraefik-867bd6b9c-lbrlx               1/1     Running   0          6m17s\n......\n$ kubectl get ingressroute\nNAME                 AGE\ntraefik-dashboard    30m\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u672c\u5730 <code>/etc/hosts</code> \u4e2d\u6dfb\u52a0\u4e0a\u57df\u540d <code>traefik.domain.com</code> \u7684\u6620\u5c04\u5373\u53ef\u8bbf\u95ee Traefik \u7684 Dashboard \u9875\u9762\u4e86\uff1a</p> <p></p>"},{"location":"kubernetes_network/ingress/traefik/#acme","title":"ACME","text":"<p>Traefik \u901a\u8fc7\u6269\u5c55 CRD \u7684\u65b9\u5f0f\u6765\u6269\u5c55 Ingress \u7684\u529f\u80fd\uff0c\u9664\u4e86\u9ed8\u8ba4\u7684\u7528 Secret \u7684\u65b9\u5f0f\u53ef\u4ee5\u652f\u6301\u5e94\u7528\u7684 HTTPS \u4e4b\u5916\uff0c\u8fd8\u652f\u6301\u81ea\u52a8\u751f\u6210 HTTPS \u8bc1\u4e66\u3002</p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6709\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 <code>whoami</code> \u5e94\u7528\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: whoami\nspec:\n  ports:\n    - protocol: TCP\n      name: web\n      port: 80\n  selector:\n    app: whoami\n---\nkind: Deployment\napiVersion: apps/v1\nmetadata:\n  name: whoami\n  labels:\n    app: whoami\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: whoami\n  template:\n    metadata:\n      labels:\n        app: whoami\n    spec:\n      containers:\n        - name: whoami\n          image: containous/whoami\n          ports:\n            - name: web\n              containerPort: 80\n</code></pre> <p>\u7136\u540e\u5b9a\u4e49\u4e00\u4e2a IngressRoute \u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: simpleingressroute\nspec:\n  entryPoints:\n    - web\n  routes:\n  - match: Host(`who.qikqiak.com`) &amp;&amp; PathPrefix(`/notls`)\n    kind: Rule\n    services:\n    - name: whoami\n      port: 80\n</code></pre> <p>\u901a\u8fc7 <code>entryPoints</code> \u6307\u5b9a\u4e86\u6211\u4eec\u8fd9\u4e2a\u5e94\u7528\u7684\u5165\u53e3\u70b9\u662f <code>web</code>\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7 80 \u7aef\u53e3\u8bbf\u95ee\uff0c\u7136\u540e\u8bbf\u95ee\u7684\u89c4\u5219\u5c31\u662f\u8981\u5339\u914d <code>who.qikqiak.com</code> \u8fd9\u4e2a\u57df\u540d\uff0c\u5e76\u4e14\u5177\u6709 <code>/notls</code> \u7684\u8def\u5f84\u524d\u7f00\u7684\u8bf7\u6c42\u624d\u4f1a\u88ab <code>whoami</code> \u8fd9\u4e2a Service \u6240\u5339\u914d\u3002\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u51e0\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u7136\u540e\u5bf9\u57df\u540d\u505a\u5bf9\u5e94\u7684\u89e3\u6790\u540e\uff0c\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5e94\u7528\u4e86\uff1a</p> <p></p> <p>\u5728 <code>IngressRoute</code> \u5bf9\u8c61\u4e2d\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e9b\u5339\u914d\u89c4\u5219\uff0c\u8fd9\u4e9b\u89c4\u5219\u5728 Traefik \u4e2d\u6709\u5982\u4e0b\u5b9a\u4e49\u65b9\u5f0f\uff1a</p> <p></p> <p>\u5982\u679c\u6211\u4eec\u9700\u8981\u7528 HTTPS \u6765\u8bbf\u95ee\u6211\u4eec\u8fd9\u4e2a\u5e94\u7528\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u76d1\u542c <code>websecure</code> \u8fd9\u4e2a\u5165\u53e3\u70b9\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7 443 \u7aef\u53e3\u6765\u8bbf\u95ee\uff0c\u540c\u6837\u7528 HTTPS \u8bbf\u95ee\u5e94\u7528\u5fc5\u7136\u5c31\u9700\u8981\u8bc1\u4e66\uff0c\u8fd9\u91cc\u6211\u4eec\u7528 <code>openssl</code> \u6765\u521b\u5efa\u4e00\u4e2a\u81ea\u7b7e\u540d\u7684\u8bc1\u4e66\uff1a</p> <pre><code>$ openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj \"/CN=who.qikqiak.com\"\n</code></pre> <p>\u7136\u540e\u901a\u8fc7 Secret \u5bf9\u8c61\u6765\u5f15\u7528\u8bc1\u4e66\u6587\u4ef6\uff1a</p> <pre><code># \u8981\u6ce8\u610f\u8bc1\u4e66\u6587\u4ef6\u540d\u79f0\u5fc5\u987b\u662f tls.crt \u548c tls.key\n$ kubectl create secret tls who-tls --cert=tls.crt --key=tls.key\nsecret/who-tls created\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a HTTPS \u8bbf\u95ee\u5e94\u7528\u7684 IngressRoute \u5bf9\u8c61\u4e86\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: ingressroutetls\nspec:\n  entryPoints:\n    - websecure\n  routes:\n  - match: Host(`who.qikqiak.com`) &amp;&amp; PathPrefix(`/tls`)\n    kind: Rule\n    services:\n    - name: whoami\n      port: 80\n  tls:\n    secretName: who-tls\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7 HTTPS \u6765\u8bbf\u95ee\u5e94\u7528\u4e86\uff0c\u7531\u4e8e\u6211\u4eec\u662f\u81ea\u7b7e\u540d\u7684\u8bc1\u4e66\uff0c\u6240\u4ee5\u8bc1\u4e66\u662f\u4e0d\u53d7\u4fe1\u4efb\u7684\uff1a</p> <p></p> <p>\u9664\u4e86\u624b\u52a8\u63d0\u4f9b\u8bc1\u4e66\u7684\u65b9\u5f0f\u4e4b\u5916 Traefik \u8fd8\u652f\u6301\u4f7f\u7528 <code>Let\u2019s Encrypt</code> \u81ea\u52a8\u751f\u6210\u8bc1\u4e66\uff0c\u8981\u4f7f\u7528 <code>Let\u2019s Encrypt</code> \u6765\u8fdb\u884c\u81ea\u52a8\u5316 HTTPS\uff0c\u5c31\u9700\u8981\u9996\u5148\u5f00\u542f <code>ACME</code>\uff0c\u5f00\u542f <code>ACME</code> \u9700\u8981\u901a\u8fc7\u9759\u6001\u914d\u7f6e\u7684\u65b9\u5f0f\uff0c\u4e5f\u5c31\u662f\u8bf4\u53ef\u4ee5\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u3001\u542f\u52a8\u53c2\u6570\u7b49\u65b9\u5f0f\u6765\u63d0\u4f9b\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u662f\u76f4\u63a5\u4f7f\u7528\u542f\u52a8\u53c2\u6570\u7684\u5f62\u5f0f\u6765\u5f00\u542f\uff0c\u5728 Traefik \u7684\u90e8\u7f72\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u547d\u4ee4\u884c\u53c2\u6570\uff1a</p> <pre><code>args:\n......\n# \u4f7f\u7528 dns \u9a8c\u8bc1\u65b9\u5f0f\n- --certificatesResolvers.ali.acme.dnsChallenge.provider=alidns\n# \u90ae\u7bb1\u914d\u7f6e\n- --certificatesResolvers.ali.acme.email=ych_1024@1com\n# \u4fdd\u5b58 ACME \u8bc1\u4e66\u7684\u4f4d\u7f6e\n- --certificatesResolvers.ali.acme.storage=/etc/acme/acme.json\n</code></pre> <p>ACME \u6709\u591a\u79cd\u6821\u9a8c\u65b9\u5f0f <code>tlsChallenge</code>\u3001<code>httpChallenge</code> \u548c <code>dnsChallenge</code> \u4e09\u79cd\u9a8c\u8bc1\u65b9\u5f0f\uff0c\u4e4b\u524d\u66f4\u5e38\u7528\u7684\u662f http \u8fd9\u79cd\u9a8c\u8bc1\u65b9\u5f0f\uff0c\u5173\u4e8e\u8fd9\u51e0\u79cd\u9a8c\u8bc1\u65b9\u5f0f\u7684\u4f7f\u7528\u53ef\u4ee5\u67e5\u770b\u6587\u6863\uff1ahttps://www.qikqiak.com/traefik-book/https/acme/ \u4e86\u89e3\u4ed6\u4eec\u4e4b\u95f4\u7684\u533a\u522b\u3002\u8981\u4f7f\u7528 tls \u6821\u9a8c\u65b9\u5f0f\u7684\u8bdd\u9700\u8981\u4fdd\u8bc1 Traefik \u7684 443 \u7aef\u53e3\u662f\u53ef\u8fbe\u7684\uff0cdns \u6821\u9a8c\u65b9\u5f0f\u53ef\u4ee5\u751f\u6210\u901a\u914d\u7b26\u7684\u8bc1\u4e66\uff0c\u53ea\u9700\u8981\u914d\u7f6e\u4e0a DNS \u89e3\u6790\u670d\u52a1\u5546\u7684 API \u8bbf\u95ee\u5bc6\u94a5\u5373\u53ef\u6821\u9a8c\u3002\u6211\u4eec\u8fd9\u91cc\u7528 DNS \u6821\u9a8c\u7684\u65b9\u5f0f\u6765\u4e3a\u5927\u5bb6\u8bf4\u660e\u5982\u4f55\u914d\u7f6e ACME\u3002</p> <p>\u4e0a\u9762\u6211\u4eec\u901a\u8fc7\u8bbe\u7f6e </p> <pre><code>--certificatesResolvers.ali.acme.dnsChallenge.provider=alidns\n</code></pre> <p>\u53c2\u6570\u6765\u6307\u5b9a\u6307\u5b9a\u963f\u91cc\u4e91\u7684 DNS \u6821\u9a8c\uff0c\u8981\u4f7f\u7528\u963f\u91cc\u4e91\u7684 DNS \u6821\u9a8c\u6211\u4eec\u8fd8\u9700\u8981\u914d\u7f6e3\u4e2a\u73af\u5883\u53d8\u91cf\uff1a<code>ALICLOUD_ACCESS_KEY</code>\u3001<code>ALICLOUD_SECRET_KEY</code>\u3001<code>ALICLOUD_REGION_ID</code>\uff0c\u5206\u522b\u5bf9\u5e94\u6211\u4eec\u5e73\u65f6\u5f00\u53d1\u963f\u91cc\u4e91\u5e94\u7528\u7684\u65f6\u5019\u7684\u5bc6\u94a5\uff0c\u53ef\u4ee5\u767b\u5f55\u963f\u91cc\u4e91\u540e\u53f0\u83b7\u53d6\uff0c\u7531\u4e8e\u8fd9\u662f\u6bd4\u8f83\u79c1\u5bc6\u7684\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u7528 Secret \u5bf9\u8c61\u6765\u521b\u5efa\uff1a</p> <pre><code>$ kubectl create secret generic traefik-alidns-secret --from-literal=ALICLOUD_ACCESS_KEY=&lt;aliyun ak&gt; --from-literal=ALICLOUD_SECRET_KEY=&lt;aliyun sk&gt;--from-literal=ALICLOUD_REGION_ID=cn-beijing -n kube-system\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u5c06\u8fd9\u4e2a Secret \u901a\u8fc7\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u5230 Traefik \u7684\u5e94\u7528\u4e2d\u3002\u8fd8\u6709\u4e00\u4e2a\u503c\u5f97\u6ce8\u610f\u7684\u662f\u9a8c\u8bc1\u901a\u8fc7\u7684\u8bc1\u4e66\u6211\u4eec\u8fd9\u91cc\u5b58\u5230 <code>/etc/acme/acme.json</code> \u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u4e00\u5b9a\u8981\u5c06\u8fd9\u4e2a\u6587\u4ef6\u6301\u4e45\u5316\uff0c\u5426\u5219\u6bcf\u6b21 Traefik \u91cd\u5efa\u540e\u5c31\u9700\u8981\u91cd\u65b0\u8ba4\u8bc1\uff0c\u800c <code>Let\u2019s Encrypt</code> \u672c\u8eab\u6821\u9a8c\u6b21\u6570\u662f\u6709\u9650\u5236\u7684\u3002\u6700\u540e\u6211\u4eec\u8fd9\u91cc\u5b8c\u6574\u7684 Traefik \u7684\u914d\u7f6e\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: traefik\n  namespace: kube-system\n  labels:\n    app: traefik\nspec:\n  selector:\n    matchLabels:\n      app: traefik\n  template:\n    metadata:\n      labels:\n        app: traefik\n    spec:\n      serviceAccountName: traefik\n      terminationGracePeriodSeconds: 60\n      tolerations:\n      - operator: \"Exists\"\n      nodeSelector:\n        kubernetes.io/hostname: ydzs-master\n      volumes:\n      - name: acme\n        hostPath:\n          path: /data/k8s/traefik/acme\n      containers:\n      - image: traefik:1\n        name: traefik\n        ports:\n        - name: web\n          containerPort: 80\n          hostPort: 80\n        - name: websecure\n          containerPort: 443\n          hostPort: 443\n        args:\n        - --entryPoints.web.address=:80\n        - --entryPoints.websecure.address=:443\n        - --api=true\n        - --api.dashboard=true\n        - --ping=true\n        - --providers.kubernetesingress\n        - --providers.kubernetescrd\n        - --log.level=INFO\n        - --accesslog\n        # \u4f7f\u7528 dns \u9a8c\u8bc1\u65b9\u5f0f\n        - --certificatesResolvers.ali.acme.dnsChallenge.provider=alidns\n        # \u90ae\u7bb1\u914d\u7f6e\n        - --certificatesResolvers.ali.acme.email=ych_1024@1com\n        # \u4fdd\u5b58 ACME \u8bc1\u4e66\u7684\u4f4d\u7f6e\n        - --certificatesResolvers.ali.acme.storage=/etc/acme/acme.json\n        # \u4e0b\u9762\u662f\u7528\u4e8e\u6d4b\u8bd5\u7684ca\u670d\u52a1\uff0c\u5982\u679chttps\u8bc1\u4e66\u751f\u6210\u6210\u529f\u4e86\uff0c\u5219\u79fb\u9664\u4e0b\u9762\u53c2\u6570\n        # - --certificatesresolvers.ali.acme.caserver=https://acme-staging-vapi.letsencrypt.org/directory\n        envFrom:\n        - secretRef:\n            name: traefik-alidns-secret\n            # ALICLOUD_ACCESS_KEY\n            # ALICLOUD_SECRET_KEY\n            # ALICLOUD_REGION_ID\n        volumeMounts:\n        - name: acme\n          mountPath: /etc/acme\n        resources:\n          requests:\n            cpu: \"50m\"\n            memory: \"50Mi\"\n          limits:\n            cpu: \"200m\"\n            memory: \"100Mi\"\n        securityContext:\n          allowPrivilegeEscalation: true\n          capabilities:\n            drop:\n            - ALL\n            add:\n            - NET_BIND_SERVICE\n        readinessProbe:\n          httpGet:\n            path: /ping\n            port: 8080\n          failureThreshold: 1\n          initialDelaySeconds: 10\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 2\n        livenessProbe:\n          httpGet:\n            path: /ping\n            port: 8080\n          failureThreshold: 3\n          initialDelaySeconds: 10\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 2\n</code></pre> <p>\u76f4\u63a5\u66f4\u65b0 Traefik \u5e94\u7528\u5373\u53ef\u3002\u66f4\u65b0\u5b8c\u6210\u540e\u73b0\u5728\u6211\u4eec\u6765\u4fee\u6539\u4e0a\u9762\u6211\u4eec\u7684 <code>whoami</code> \u5e94\u7528\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: ingressroutetls\nspec:\n  entryPoints:\n    - websecure\n  routes:\n  - match: Host(`who.qikqiak.com`) &amp;&amp; PathPrefix(`/tls`)\n    kind: Rule\n    services:\n    - name: whoami\n      port: 80\n  tls:\n    certResolver: ali\n    domains:\n    - main: \"*.qikqiak.com\"\n</code></pre> <p>\u5176\u4ed6\u7684\u90fd\u4e0d\u53d8\uff0c\u53ea\u9700\u8981\u5c06 tls \u90e8\u5206\u6539\u6210\u6211\u4eec\u5b9a\u4e49\u7684 <code>ali</code> \u8fd9\u4e2a\u8bc1\u4e66\u89e3\u6790\u5668\uff0c\u5982\u679c\u6211\u4eec\u60f3\u8981\u751f\u6210\u4e00\u4e2a\u901a\u914d\u7b26\u7684\u57df\u540d\u8bc1\u4e66\u7684\u8bdd\u53ef\u4ee5\u5b9a\u4e49 <code>domains</code> \u53c2\u6570\u6765\u6307\u5b9a\uff0c\u7136\u540e\u66f4\u65b0 IngressRoute \u5bf9\u8c61\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u53bb\u7528 HTTPS \u8bbf\u95ee\u6211\u4eec\u7684\u5e94\u7528\uff08\u5f53\u7136\u9700\u8981\u5c06\u57df\u540d\u5728\u963f\u91cc\u4e91 DNS \u4e0a\u505a\u89e3\u6790\uff09\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8bbf\u95ee\u5e94\u7528\u5df2\u7ecf\u662f\u53d7\u6d4f\u89c8\u5668\u4fe1\u4efb\u7684\u8bc1\u4e66\u4e86\uff0c\u67e5\u770b\u8bc1\u4e66\u6211\u4eec\u8fd8\u53ef\u4ee5\u53d1\u73b0\u8be5\u8bc1\u4e66\u662f\u4e00\u4e2a\u901a\u914d\u7b26\u7684\u8bc1\u4e66\u3002</p>"},{"location":"kubernetes_network/ingress/traefik/#_3","title":"\u4e2d\u95f4\u4ef6","text":"<p>\u4e2d\u95f4\u4ef6\u662f Traefik2.0 \u4e2d\u4e00\u4e2a\u975e\u5e38\u6709\u7279\u8272\u7684\u529f\u80fd\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u5404\u79cd\u9700\u6c42\u53bb\u9009\u62e9\u4e0d\u540c\u7684\u4e2d\u95f4\u4ef6\u6765\u6ee1\u8db3\u670d\u52a1\uff0cTraefik \u5b98\u65b9\u5df2\u7ecf\u5185\u7f6e\u4e86\u8bb8\u591a\u4e0d\u540c\u529f\u80fd\u7684\u4e2d\u95f4\u4ef6\uff0c\u5176\u4e2d\u4e00\u4e9b\u53ef\u4ee5\u4fee\u6539\u8bf7\u6c42\uff0c\u5934\u4fe1\u606f\uff0c\u4e00\u4e9b\u8d1f\u8d23\u91cd\u5b9a\u5411\uff0c\u4e00\u4e9b\u6dfb\u52a0\u8eab\u4efd\u9a8c\u8bc1\u7b49\u7b49\uff0c\u800c\u4e14\u4e2d\u95f4\u4ef6\u8fd8\u53ef\u4ee5\u901a\u8fc7\u94fe\u5f0f\u7ec4\u5408\u7684\u65b9\u5f0f\u6765\u9002\u7528\u5404\u79cd\u60c5\u51b5\u3002</p> <p></p> <p>\u540c\u6837\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u7684 whoami \u8fd9\u4e2a\u5e94\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>https://who.qikqiak.com/tls\n</code></pre> <p>\u6765\u8bbf\u95ee\u5230\u5e94\u7528\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u7528 <code>http</code> \u6765\u8bbf\u95ee\u7684\u8bdd\u5462\u5c31\u4e0d\u884c\u4e86\uff0c\u5c31\u4f1a404\u4e86\uff0c\u56e0\u4e3a\u6211\u4eec\u6839\u672c\u5c31\u6ca1\u6709\u7b80\u535580\u7aef\u53e3\u8fd9\u4e2a\u5165\u53e3\u70b9\uff0c\u6240\u4ee5\u8981\u60f3\u901a\u8fc7 <code>http</code> \u6765\u8bbf\u95ee\u5e94\u7528\u7684\u8bdd\u81ea\u7136\u6211\u4eec\u9700\u8981\u76d1\u542c\u4e0b <code>web</code> \u8fd9\u4e2a\u5165\u53e3\u70b9\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: ingressroutetls-http\nspec:\n  entryPoints:\n    - web\n  routes:\n  - match: Host(`who.qikqiak.com`) &amp;&amp; PathPrefix(`/tls`)\n    kind: Rule\n    services:\n    - name: whoami\n      port: 80\n</code></pre> <p>\u6ce8\u610f\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u7684 IngressRoute \u7684 entryPoints \u662f <code>web</code>\uff0c\u7136\u540e\u521b\u5efa\u8fd9\u4e2a\u5bf9\u8c61\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 http \u8bbf\u95ee\u5230\u8fd9\u4e2a\u5e94\u7528\u4e86\u3002</p> <p>\u4f46\u662f\u6211\u4eec\u5982\u679c\u53ea\u5e0c\u671b\u7528\u6237\u901a\u8fc7 https \u6765\u8bbf\u95ee\u5e94\u7528\u7684\u8bdd\u5462\uff1f\u6309\u7167\u4ee5\u524d\u7684\u77e5\u8bc6\uff0c\u6211\u4eec\u662f\u4e0d\u662f\u53ef\u4ee5\u8ba9 http \u5f3a\u5236\u8df3\u8f6c\u5230 https \u670d\u52a1\u53bb\uff0c\u5bf9\u7684\uff0c\u5728 Traefik \u4e2d\u4e5f\u662f\u53ef\u4ee5\u914d\u7f6e\u5f3a\u5236\u8df3\u8f6c\u7684\uff0c\u53ea\u662f\u8fd9\u4e2a\u529f\u80fd\u73b0\u5728\u662f\u901a\u8fc7\u4e2d\u95f4\u4ef6\u6765\u63d0\u4f9b\u7684\u4e86\u3002\u5982\u4e0b\u6240\u793a\uff0c\u6211\u4eec\u4f7f\u7528 <code>redirectScheme</code> \u4e2d\u95f4\u4ef6\u6765\u521b\u5efa\u63d0\u4f9b\u5f3a\u5236\u8df3\u8f6c\u670d\u52a1\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: Middleware\nmetadata:\n  name: redirect-https\nspec:\n  redirectScheme:\n    scheme: https\n</code></pre> <p>\u7136\u540e\u5c06\u8fd9\u4e2a\u4e2d\u95f4\u4ef6\u9644\u52a0\u5230 http \u7684\u670d\u52a1\u4e0a\u9762\u53bb\uff0c\u56e0\u4e3a https \u7684\u4e0d\u9700\u8981\u8df3\u8f6c\uff1a</p> <pre><code>---\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: ingressroutetls-http\nspec:\n  entryPoints:\n    - web\n  routes:\n  - match: Host(`who.qikqiak.com`) &amp;&amp; PathPrefix(`/tls`)\n    kind: Rule\n    services:\n    - name: whoami\n      port: 80\n    middlewares: \n    - name: redirect-https\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u53bb\u8bbf\u95ee http \u670d\u52a1\u53ef\u4ee5\u53d1\u73b0\u5c31\u4f1a\u81ea\u52a8\u8df3\u8f6c\u5230 https \u53bb\u4e86\u3002\u5173\u4e8e\u66f4\u591a\u4e2d\u95f4\u4ef6\u7684\u7528\u6cd5\u53ef\u4ee5\u67e5\u770b\u6587\u6863 Traefik Docs\u3002</p>"},{"location":"kubernetes_network/ingress/traefik/#_4","title":"\u7070\u5ea6\u53d1\u5e03","text":"<p>Traefik2.0 \u7684\u4e00\u4e2a\u66f4\u5f3a\u5927\u7684\u529f\u80fd\u5c31\u662f\u7070\u5ea6\u53d1\u5e03\uff0c\u7070\u5ea6\u53d1\u5e03\u6211\u4eec\u6709\u65f6\u5019\u4e5f\u4f1a\u79f0\u4e3a\u91d1\u4e1d\u96c0\u53d1\u5e03\uff08Canary\uff09\uff0c\u4e3b\u8981\u5c31\u662f\u8ba9\u4e00\u90e8\u5206\u6d4b\u8bd5\u7684\u670d\u52a1\u4e5f\u53c2\u4e0e\u5230\u7ebf\u4e0a\u53bb\uff0c\u7ecf\u8fc7\u6d4b\u8bd5\u89c2\u5bdf\u770b\u662f\u5426\u7b26\u53f7\u4e0a\u7ebf\u8981\u6c42\u3002</p> <p></p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6709\u4e24\u4e2a\u540d\u4e3a <code>appv1</code> \u548c <code>appv2</code> \u7684\u670d\u52a1\uff0c\u6211\u4eec\u5e0c\u671b\u901a\u8fc7 Traefik \u6765\u63a7\u5236\u6211\u4eec\u7684\u6d41\u91cf\uff0c\u5c06 3\u20444 \u7684\u6d41\u91cf\u8def\u7531\u5230 appv1\uff0c\u00bc \u7684\u6d41\u91cf\u8def\u7531\u5230 appv2 \u53bb\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u5229\u7528 Traefik2.0 \u4e2d\u63d0\u4f9b\u7684<code>\u5e26\u6743\u91cd\u7684\u8f6e\u8be2\uff08WRR\uff09</code>\u6765\u5b9e\u73b0\u8be5\u529f\u80fd\uff0c\u9996\u5148\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e0a\u9762\u7684\u4e24\u4e2a\u670d\u52a1\u3002\u4e3a\u4e86\u5bf9\u6bd4\u7ed3\u679c\u6211\u4eec\u8fd9\u91cc\u63d0\u4f9b\u7684\u4e24\u4e2a\u670d\u52a1\u4e00\u4e2a\u662f whoami\uff0c\u4e00\u4e2a\u662f nginx\uff0c\u65b9\u4fbf\u6d4b\u8bd5\u3002</p> <p>appv1 \u670d\u52a1\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a\uff08appv1.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: appv1\nspec:\n  selector:\n    matchLabels:\n      app: appv1\n  template:\n    metadata:\n      labels:\n        use: test\n        app: appv1\n    spec:\n      containers:\n      - name: whoami\n        image: containous/whoami\n        ports:\n        - containerPort: 80\n          name: portv1\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: appv1\nspec:\n  selector:\n    app: appv1\n  ports:\n  - name: http\n    port: 80\n    targetPort: portv1\n</code></pre> <p>appv2 \u670d\u52a1\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a\uff08appv2.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: appv2\nspec:\n  selector:\n    matchLabels:\n      app: appv2\n  template:\n    metadata:\n      labels:\n        use: test\n        app: appv2\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n          name: portv2\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: appv2\nspec:\n  selector:\n    app: appv2\n  ports:\n  - name: http\n    port: 80\n    targetPort: portv2\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u4e24\u4e2a\u670d\u52a1\uff1a</p> <pre><code>$ kubectl apply -f appvyaml\n$ kubectl apply -f appvyaml\n# \u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u670d\u52a1\u662f\u5426\u8fd0\u884c\u6210\u529f\n$ kubectl get pods -l use=test\nNAME                     READY   STATUS    RESTARTS   AGE\nappv1-58f856c665-shm9j   1/1     Running   0          12s\nappv2-ff5db55cf-qjtrf    1/1     Running   0          12s\n</code></pre> <p>\u5728 Traefik2.1 \u4e2d\u65b0\u589e\u4e86\u4e00\u4e2a <code>TraefikService</code> \u7684 CRD \u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5229\u7528\u8fd9\u4e2a\u5bf9\u8c61\u6765\u914d\u7f6e WRR\uff0c\u4e4b\u524d\u7684\u7248\u672c\u9700\u8981\u901a\u8fc7 File Provider\uff0c\u6bd4\u8f83\u9ebb\u70e6\uff0c\u65b0\u5efa\u4e00\u4e2a\u63cf\u8ff0 WRR \u7684\u8d44\u6e90\u6e05\u5355\uff1a(wrr.yaml)</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: TraefikService\nmetadata:\n  name: app-wrr\nspec:\n  weighted:\n    services:\n      - name: appv1\n        weight: 3  # \u5b9a\u4e49\u6743\u91cd\n        port: 80\n        kind: Service  # \u53ef\u9009\uff0c\u9ed8\u8ba4\u5c31\u662f Service\n      - name: appv2\n        weight: 1\n        port: 80\n</code></pre> <p>\u7136\u540e\u4e3a\u6211\u4eec\u7684\u7070\u5ea6\u53d1\u5e03\u7684\u670d\u52a1\u521b\u5efa\u4e00\u4e2a IngressRoute \u8d44\u6e90\u5bf9\u8c61\uff1a(ingressroute.yaml)</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: wrringressroute\n  namespace: default\nspec:\n  entryPoints:\n    - web\n  routes:\n  - match: Host(`wrr.qikqiak.com`)\n    kind: Rule\n    services:\n    - name: app-wrr\n      kind: TraefikService\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u73b0\u5728\u6211\u4eec\u914d\u7f6e\u7684 Service \u4e0d\u518d\u662f\u76f4\u63a5\u7684 Kubernetes \u5bf9\u8c61\u4e86\uff0c\u800c\u662f\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u7684 TraefikService \u5bf9\u8c61\uff0c\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u4e24\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5bf9\u57df\u540d <code>wrr.qikqiak.com</code> \u505a\u4e0a\u89e3\u6790\uff0c\u53bb\u6d4f\u89c8\u5668\u4e2d\u8fde\u7eed\u8bbf\u95ee 4 \u6b21\uff0c\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf\u5230 appv1 \u8fd9\u5e94\u7528\u4f1a\u6536\u5230 3 \u6b21\u8bf7\u6c42\uff0c\u800c appv2 \u8fd9\u4e2a\u5e94\u7528\u53ea\u6536\u5230 1 \u6b21\u8bf7\u6c42\uff0c\u7b26\u5408\u4e0a\u9762\u6211\u4eec\u7684 <code>3:1</code> \u7684\u6743\u91cd\u914d\u7f6e\u3002</p> <p></p>"},{"location":"kubernetes_network/ingress/traefik/#_5","title":"\u6d41\u91cf\u590d\u5236","text":"<p>\u9664\u4e86\u7070\u5ea6\u53d1\u5e03\u4e4b\u5916\uff0cTraefik 2.0 \u8fd8\u5f15\u5165\u4e86\u6d41\u91cf\u955c\u50cf\u670d\u52a1\uff0c\u662f\u4e00\u79cd\u53ef\u4ee5\u5c06\u6d41\u5165\u6d41\u91cf\u590d\u5236\u5e76\u540c\u65f6\u5c06\u5176\u53d1\u9001\u7ed9\u5176\u4ed6\u670d\u52a1\u7684\u65b9\u6cd5\uff0c\u955c\u50cf\u670d\u52a1\u53ef\u4ee5\u83b7\u5f97\u7ed9\u5b9a\u767e\u5206\u6bd4\u7684\u8bf7\u6c42\u540c\u65f6\u4e5f\u4f1a\u5ffd\u7565\u8fd9\u90e8\u5206\u8bf7\u6c42\u7684\u54cd\u5e94\u3002</p> <p></p> <p>\u540c\u6837\u7684\u5728 2.0 \u4e2d\u53ea\u80fd\u901a\u8fc7 FileProvider \u8fdb\u884c\u914d\u7f6e\uff0c\u5728 2.1 \u7248\u672c\u4e2d\u6211\u4eec\u5df2\u7ecf\u53ef\u4ee5\u901a\u8fc7 <code>TraefikService</code> \u8d44\u6e90\u5bf9\u8c61\u6765\u8fdb\u884c\u914d\u7f6e\u4e86\uff0c\u73b0\u5728\u6211\u4eec\u90e8\u7f72\u4e24\u4e2a whoami \u7684\u670d\u52a1\uff0c\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: v1\nspec:\n  ports:\n    - protocol: TCP\n      name: web\n      port: 80\n  selector:\n    app: v1\n---\nkind: Deployment\napiVersion: apps/v1\nmetadata:\n  name: v1\n  labels:\n    app: v1\nspec:\n  selector:\n    matchLabels:\n      app: v1\n  template:\n    metadata:\n      labels:\n        app: v1\n    spec:\n      containers:\n        - name: v1\n          image: nginx\n          ports:\n            - name: web\n              containerPort: 80\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: v2\nspec:\n  ports:\n    - protocol: TCP\n      name: web\n      port: 80\n  selector:\n    app: v2\n---\nkind: Deployment\napiVersion: apps/v1\nmetadata:\n  name: v2\n  labels:\n    app: v2\nspec:\n  selector:\n    matchLabels:\n      app: v2\n  template:\n    metadata:\n      labels:\n        app: v2\n    spec:\n      containers:\n        - name: v2\n          image: nginx\n          ports:\n            - name: web\n              containerPort: 80\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get pods\nNAME                                      READY   STATUS    RESTARTS   AGE\nv1-77cfb86999-wfbl2                       1/1     Running   0          94s\nv2-6f45d498b7-g6qjt                       1/1     Running   0          91s\n$ kubectl get svc \nNAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)     AGE\nv1              ClusterIP   2173   &lt;none&gt;        80/TCP      99s\nv2              ClusterIP   48     &lt;none&gt;        80/TCP      96s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u521b\u5efa\u4e00\u4e2a IngressRoute \u5bf9\u8c61\uff0c\u5c06\u670d\u52a1 v1 \u7684\u6d41\u91cf\u590d\u5236 50% \u5230\u670d\u52a1 v2\uff0c\u5982\u4e0b\u8d44\u6e90\u5bf9\u8c61\u6240\u793a\uff1a(mirror-ingress-route.yaml)</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: TraefikService\nmetadata:\n  name: app-mirror\nspec:\n  mirroring:\n    name: v1 # \u53d1\u9001 100% \u7684\u8bf7\u6c42\u5230 K8S \u7684 Service \"v1\"\n    port: 80\n    mirrors:\n    - name: v2 # \u7136\u540e\u590d\u5236 50% \u7684\u8bf7\u6c42\u5230 v2\n      percent: 50\n      port: 80\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: mirror-ingress-route\n  namespace: default\nspec:\n  entryPoints:\n  - web\n  routes:   \n  - match: Host(`mirror.qikqiak.com`)\n    kind: Rule\n    services:\n    - name: app-mirror\n      kind: TraefikService # \u4f7f\u7528\u58f0\u660e\u7684 TraefikService \u670d\u52a1\uff0c\u800c\u4e0d\u662f K8S \u7684 Service\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f mirror-ingress-route.yaml \ningressroute.traefik.containo.us/mirror-ingress-route created\ntraefikservice.traefik.containo.us/mirroring-example created\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5728\u6d4f\u89c8\u5668\u4e2d\u53bb\u8fde\u7eed\u8bbf\u95ee4\u6b21 <code>mirror.qikqiak.com</code> \u53ef\u4ee5\u53d1\u73b0\u6709\u4e00\u534a\u7684\u8bf7\u6c42\u4e5f\u51fa\u73b0\u5728\u4e86 <code>v2</code> \u8fd9\u4e2a\u670d\u52a1\u4e2d\uff1a </p>"},{"location":"kubernetes_network/ingress/traefik/#tcp","title":"TCP","text":"<p>\u53e6\u5916 Traefik2.0 \u5df2\u7ecf\u652f\u6301\u4e86 TCP \u670d\u52a1\u7684\uff0c\u4e0b\u9762\u6211\u4eec\u4ee5 mongo \u4e3a\u4f8b\u6765\u4e86\u89e3\u4e0b Traefik \u662f\u5982\u4f55\u652f\u6301 TCP \u670d\u52a1\u5f97\u3002</p>"},{"location":"kubernetes_network/ingress/traefik/#tcp_1","title":"\u7b80\u5355 TCP \u670d\u52a1","text":"<p>\u9996\u5148\u90e8\u7f72\u4e00\u4e2a\u666e\u901a\u7684 mongo \u670d\u52a1\uff0c\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a\uff08mongo.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: mongo-traefik\n  labels:\n    app: mongo-traefik\nspec:\n  selector:\n    matchLabels:\n      app: mongo-traefik\n  template:\n    metadata:\n      labels:\n        app: mongo-traefik\n    spec:\n      containers:\n      - name: mongo\n        image: mongo:0\n        ports:\n        - containerPort: 27017\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: mongo-traefik\nspec:\n  selector:\n    app: mongo-traefik\n  ports:\n  - port: 27017\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa mongo \u5e94\u7528\uff1a</p> <pre><code>$ kubectl apply -f mongo.yaml\ndeployment.apps/mongo-traefik created\nservice/mongo-traefik created\n</code></pre> <p>\u521b\u5efa\u6210\u529f\u540e\u5c31\u53ef\u4ee5\u6765\u4e3a mongo \u670d\u52a1\u914d\u7f6e\u4e00\u4e2a\u8def\u7531\u4e86\u3002\u7531\u4e8e Traefik \u4e2d\u4f7f\u7528 TCP \u8def\u7531\u914d\u7f6e\u9700\u8981 <code>SNI</code>\uff0c\u800c <code>SNI</code> \u53c8\u662f\u4f9d\u8d56 <code>TLS</code> \u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u914d\u7f6e\u8bc1\u4e66\u624d\u884c\uff0c\u5982\u679c\u6ca1\u6709\u8bc1\u4e66\u7684\u8bdd\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26 <code>*</code> \u8fdb\u884c\u914d\u7f6e\uff0c\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u4e00\u4e2a <code>IngressRouteTCP</code> \u7c7b\u578b\u7684 CRD \u5bf9\u8c61\uff08\u524d\u9762\u6211\u4eec\u5c31\u5df2\u7ecf\u5b89\u88c5\u4e86\u5bf9\u5e94\u7684 CRD \u8d44\u6e90\uff09\uff1a(mongo-ingressroute-tcp.yaml)</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRouteTCP\nmetadata:\n  name: mongo-traefik-tcp\nspec:\n  entryPoints:\n    - mongo\n  routes:\n  - match: HostSNI(`*`)\n    services:\n    - name: mongo-traefik\n      port: 27107\n</code></pre> <p>\u8981\u6ce8\u610f\u7684\u662f\u8fd9\u91cc\u7684 <code>entryPoints</code> \u90e8\u5206\uff0c\u662f\u6839\u636e\u6211\u4eec\u542f\u52a8\u7684 Traefik \u7684\u9759\u6001\u914d\u7f6e\u4e2d\u7684 entryPoints \u6765\u51b3\u5b9a\u7684\uff0c\u6211\u4eec\u5f53\u7136\u53ef\u4ee5\u4f7f\u7528\u524d\u9762\u6211\u4eec\u5b9a\u4e49\u5f97 80 \u548c 443 \u8fd9\u4e24\u4e2a\u5165\u53e3\u70b9\uff0c\u4f46\u662f\u4e5f\u53ef\u4ee5\u53ef\u4ee5\u81ea\u5df1\u6dfb\u52a0\u4e00\u4e2a\u7528\u4e8e mongo \u670d\u52a1\u7684\u4e13\u95e8\u5165\u53e3\u70b9\uff1a</p> <pre><code>......\n- image: traefik:1\n  name: traefik\n  ports:\n  - name: web\n    containerPort: 80\n    hostPort: 80\n  - name: websecure\n    containerPort: 443\n    hostPort: 443\n  - name: mongo\n    hostPort: 27017\n    containerPort: 27017\n  args:\n  - --entryPoints.web.address=:80\n  - --entryPoints.websecure.address=:443\n  - --entryPoints.mongo.address=:27017\n  ......\n</code></pre> <p>\u8fd9\u91cc\u7ed9\u5165\u53e3\u70b9\u6dfb\u52a0 <code>hostPort</code> \u662f\u4e3a\u4e86\u80fd\u591f\u901a\u8fc7\u8282\u70b9\u7684\u7aef\u53e3\u8bbf\u95ee\u5230\u670d\u52a1\uff0c\u5173\u4e8e entryPoints \u5165\u53e3\u70b9\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u53ef\u4ee5\u67e5\u770b\u6587\u6863 entrypoints \u4e86\u89e3\u66f4\u591a\u4fe1\u606f\u3002</p> <p>\u7136\u540e\u66f4\u65b0 Traefik \u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ mongo-ingressroute-tcp.yaml\ningressroutetcp.traefik.containo.us/mongo-traefik-tcp created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u53bb Traefik \u7684 Dashboard \u9875\u9762\u4e0a\u67e5\u770b\u662f\u5426\u751f\u6548\uff1a</p> <p></p> <p>\u7136\u540e\u6211\u4eec\u914d\u7f6e\u4e00\u4e2a\u57df\u540d <code>mongo.local</code> \u89e3\u6790\u5230 Traefik \u6240\u5728\u7684\u8282\u70b9\uff0c\u7136\u540e\u901a\u8fc7 27017 \u7aef\u53e3\u6765\u8fde\u63a5 mongo \u670d\u52a1\uff1a</p> <pre><code>$ mongo --host mongo.local --port 27017\nmongo(75243,0x1075295c0) malloc: *** malloc_zone_unregister() failed for 0x7fffa56f4000\nMongoDB shell version: 1\nconnecting to: mongo.local:27017/test\n&gt; show dbs\nadmin   000GB\nconfig  000GB\nlocal   000GB\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u5c06 mongo\uff08TCP\uff09\u670d\u52a1\u66b4\u9732\u7ed9\u5916\u90e8\u7528\u6237\u4e86\u3002</p>"},{"location":"kubernetes_network/ingress/traefik/#tls_tcp","title":"\u5e26 TLS \u8bc1\u4e66\u7684 TCP","text":"<p>\u4e0a\u9762\u6211\u4eec\u90e8\u7f72\u7684 mongo \u662f\u4e00\u4e2a\u666e\u901a\u7684\u670d\u52a1\uff0c\u7136\u540e\u7528 Traefik \u4ee3\u7406\u7684\uff0c\u4f46\u662f\u6709\u65f6\u5019\u4e3a\u4e86\u5b89\u5168 mongo \u670d\u52a1\u672c\u8eab\u8fd8\u4f1a\u4f7f\u7528 TLS \u8bc1\u4e66\u7684\u5f62\u5f0f\u63d0\u4f9b\u670d\u52a1\uff0c\u4e0b\u9762\u662f\u7528\u6765\u751f\u6210 mongo tls \u8bc1\u4e66\u7684\u811a\u672c\u6587\u4ef6\uff1a\uff08generate-certificates.sh\uff09</p> <pre><code>#!/bin/bash\n#\n# From https://medium.com/@rajanmaharjan/secure-your-mongodb-connections-ssl-tls-92e2addb3c89\n\nset -eu -o pipefail\n\nDOMAINS=\"${1}\"\nCERTS_DIR=\"${2}\"\n[ -d \"${CERTS_DIR}\" ]\nCURRENT_DIR=\"$(cd \"$(dirname \"${0}\")\" &amp;&amp; pwd -P)\"\n\nGENERATION_DIRNAME=\"$(echo \"${DOMAINS}\" | cut -d, -f1)\"\n\nrm -rf \"${CERTS_DIR}/${GENERATION_DIRNAME:?}\" \"${CERTS_DIR}/certs\"\n\necho \"== Checking Requirements...\"\ncommand -v go &gt;/dev/null 2&gt;&amp;1 || echo \"Golang is required\"\ncommand -v minica &gt;/dev/null 2&gt;&amp;1 || go get github.com/jsha/minica &gt;/dev/null\n\necho \"== Generating Certificates for the following domains: ${DOMAINS}...\"\ncd \"${CERTS_DIR}\"\nminica --ca-cert \"${CURRENT_DIR}/minica.pem\" --ca-key=\"${CURRENT_DIR}/minica-key.pem\" --domains=\"${DOMAINS}\"\nmv \"${GENERATION_DIRNAME}\" \"certs\"\ncat certs/key.pem certs/cert.pem &gt; certs/mongo.pem\n\necho \"== Certificates Generated in the directory ${CERTS_DIR}/certs\"\n</code></pre> <p>\u5c06\u4e0a\u9762\u8bc1\u4e66\u653e\u7f6e\u5230 certs \u76ee\u5f55\u4e0b\u9762\uff0c\u7136\u540e\u6211\u4eec\u65b0\u5efa\u4e00\u4e2a <code>02-tls-mongo</code> \u7684\u76ee\u5f55\uff0c\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u6765\u751f\u6210\u8bc1\u4e66\uff1a</p> <pre><code>$ bash ../certs/generate-certificates.sh mongo.local .\n== Checking Requirements...\n== Generating Certificates for the following domains: mongo.local...\n</code></pre> <p>\u6700\u540e\u7684\u76ee\u5f55\u5982\u4e0b\u6240\u793a\uff0c\u5728 <code>02-tls-mongo</code> \u76ee\u5f55\u4e0b\u9762\u4f1a\u751f\u6210\u5305\u542b\u8bc1\u4e66\u7684 certs \u76ee\u5f55\uff1a</p> <pre><code>$ tree .\n.\n\u251c\u2500\u2500 01-mongo\n\u2502   \u251c\u2500\u2500 mongo-ingressroute-tcp.yaml\n\u2502   \u2514\u2500\u2500 mongo.yaml\n\u251c\u2500\u2500 02-tls-mongo\n\u2502   \u2514\u2500\u2500 certs\n\u2502       \u251c\u2500\u2500 cert.pem\n\u2502       \u251c\u2500\u2500 key.pem\n\u2502       \u2514\u2500\u2500 mongo.pem\n\u2514\u2500\u2500 certs\n    \u251c\u2500\u2500 generate-certificates.sh\n    \u251c\u2500\u2500 minica-key.pem\n    \u2514\u2500\u2500 minica.pem\n</code></pre> <p>\u5728 <code>02-tls-mongo/certs</code> \u76ee\u5f55\u4e0b\u9762\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u901a\u8fc7 Secret \u6765\u5305\u542b\u8bc1\u4e66\u5185\u5bb9\uff1a</p> <pre><code>$ kubectl create secret tls traefik-mongo-certs --cert=cert.pem --key=key.pem\nsecret/traefik-mongo-certs created\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u66f4\u65b0 <code>IngressRouteTCP</code> \u5bf9\u8c61\uff0c\u589e\u52a0 TLS \u914d\u7f6e\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRouteTCP\nmetadata:\n  name: mongo-traefik-tcp\nspec:\n  entryPoints:\n    - mongo\n  routes:\n  - match: HostSNI(`mongo.local`)\n    services:\n    - name: mongo-traefik\n      port: 27017\n  tls: \n    secretName: traefik-mongo-certs\n</code></pre> <p>\u540c\u6837\u66f4\u65b0\u540e\uff0c\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u53bb\u8bbf\u95ee\u5e94\u7528\u5c31\u4f1a\u88ab hang \u4f4f\uff0c\u56e0\u4e3a\u6211\u4eec\u6ca1\u6709\u63d0\u4f9b\u8bc1\u4e66\uff1a</p> <pre><code>$ mongo --host mongo.local --port 27017\nMongoDB shell version: 1\nconnecting to: mongolocal:27017/test\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u5e26\u4e0a\u8bc1\u4e66\u6765\u8fdb\u884c\u8fde\u63a5\uff1a</p> <pre><code>$ mongo --host mongo.local --port 27017 --ssl --sslCAFile=../certs/minica.pem --sslPEMKeyFile=./certs/mongo.pem\nMongoDB shell version v3\nconnecting to: mongodb://mongo.local:27017/\nImplicit session: session { \"id\" : UUID(\"e7409ef6-8ebe-4c5a-9642-42059bdb477b\") }\nMongoDB server version: 14\n......\n&gt; show dbs;\nadmin   000GB\nconfig  000GB\nlocal   000GB\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u5c31\u53ef\u4ee5\u8fde\u63a5\u6210\u529f\u4e86\uff0c\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u4e00\u4e2a\u4f7f\u7528 TLS \u8bc1\u4e66\u4ee3\u7406 TCP \u670d\u52a1\u7684\u529f\u80fd\uff0c\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u6211\u4eec\u4f7f\u7528\u5176\u4ed6\u7684\u57df\u540d\u53bb\u8fdb\u884c\u8fde\u63a5\u5c31\u4f1a\u62a5\u9519\u4e86\uff0c\u56e0\u4e3a\u73b0\u5728\u6211\u4eec\u6307\u5b9a\u7684\u662f\u7279\u5b9a\u7684 HostSNI\uff1a</p> <pre><code>$ mongo --host mongo.k8s.local --port 27017 --ssl --sslCAFile=../certs/minica.pem --sslPEMKeyFile=./certs/mongo.pem\nMongoDB shell version v3\nconnecting to: mongodb://mongo.k8s.local:27017/\n2019-12-29T15:03:424+0800 E NETWORK  [js] SSL peer certificate validation failed: Certificate trust failure: CSSMERR_TP_NOT_TRUSTED; connection rejected\n2019-12-29T15:03:429+0800 E QUERY    [js] Error: couldn't connect to server mongo.qikqiak.com:27017, connection attempt failed: SSLHandshakeFailed: SSL peer certificate validation failed: Certificate trust failure: CSSMERR_TP_NOT_TRUSTED; connection rejected :\nconnect@src/mongo/shell/mongo.js:257:13\n@(connect):1:6\nexception: connect failed\n</code></pre> <p>\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 ACME \u6765\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e00\u4e2a\u5408\u6cd5\u7684\u8bc1\u4e66\uff0c\u8fd9\u6837\u5728\u8fde\u63a5\u7684\u4f7f\u7528\u5c31\u4e0d\u9700\u8981\u6307\u5b9a\u8bc1\u4e66\u4e86\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRouteTCP\nmetadata:\n  name: mongo-traefik-tcp\nspec:\n  entryPoints:\n    - mongo\n  routes:\n  - match: HostSNI(`mongo.qikqiak.com`)\n    services:\n    - name: mongo-traefik\n      port: 27017\n  tls:\n    certResolver: ali\n    domains:\n    - main: \"*.qikqiak.com\"\n</code></pre> <p>\u8fd9\u6837\u5f53\u6211\u4eec\u8fde\u63a5\u7684\u65f6\u5019\u5c31\u53ea\u9700\u8981\u5982\u4e0b\u7684\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ mongo --host mongo.qikqiak.com --port 27017 --ssl\n</code></pre>"},{"location":"kubernetes_operator/crd/","title":"CRD","text":""},{"location":"kubernetes_operator/crd/#crd","title":"CRD","text":"<p><code>`` Custom Resource Define <pre><code> \u7b80\u79f0 CRD\uff0c\u662f Kubernetes\uff08v1.7+\uff09\u4e3a\u63d0\u9ad8\u53ef\u6269\u5c55\u6027\uff0c\u8ba9\u5f00\u53d1\u8005\u53bb\u81ea\u5b9a\u4e49\u8d44\u6e90\u7684\u4e00\u79cd\u65b9\u5f0f\u3002CRD \u8d44\u6e90\u53ef\u4ee5\u52a8\u6001\u6ce8\u518c\u5230\u96c6\u7fa4\u4e2d\uff0c\u6ce8\u518c\u5b8c\u6bd5\u540e\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7 kubectl \u6765\u521b\u5efa\u8bbf\u95ee\u8fd9\u4e2a\u81ea\u5b9a\u4e49\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u7c7b\u4f3c\u4e8e\u64cd\u4f5c Pod \u4e00\u6837\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f CRD \u4ec5\u4ec5\u662f\u8d44\u6e90\u7684\u5b9a\u4e49\u800c\u5df2\uff0c\u9700\u8981\u4e00\u4e2a Controller \u53bb\u76d1\u542c CRD \u7684\u5404\u79cd\u4e8b\u4ef6\u6765\u6dfb\u52a0\u81ea\u5b9a\u4e49\u7684\u4e1a\u52a1\u903b\u8f91\u3002\n\n### \u5b9a\u4e49\n\n&gt; \u5982\u679c\u8bf4\u53ea\u662f\u5bf9 CRD \u8d44\u6e90\u672c\u8eab\u8fdb\u884c CRUD \u64cd\u4f5c\u7684\u8bdd\uff0c\u4e0d\u9700\u8981 Controller \u4e5f\u662f\u53ef\u4ee5\u5b9e\u73b0\u7684\uff0c\u76f8\u5f53\u4e8e\u5c31\u662f\u53ea\u6709\u6570\u636e\u5b58\u5165\u4e86 etcd \u4e2d\uff0c\u800c\u6ca1\u6709\u5bf9\u8fd9\u4e2a\u6570\u636e\u7684\u76f8\u5173\u64cd\u4f5c\u800c\u5df2\u3002\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 CRD \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a(crd-demo.yaml)\n</code></pre> apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:   # name \u5fc5\u987b\u5339\u914d\u4e0b\u9762\u7684spec\u5b57\u6bb5\uff1a&lt;plural&gt;.&lt;group&gt;   name: crontabs.stable.example.com spec:   # group \u540d\u7528\u4e8e REST API \u4e2d\u7684\u5b9a\u4e49\uff1a/apis/&lt;group&gt;/&lt;version&gt;   group: stable.example.com   # \u5217\u51fa\u81ea\u5b9a\u4e49\u8d44\u6e90\u7684\u6240\u6709 API \u7248\u672c   versions:   - name: v1beta1  # \u7248\u672c\u540d\u79f0\uff0c\u6bd4\u5982 v1\u3001v2beta1 \u7b49\u7b49     served: true  # \u662f\u5426\u5f00\u542f\u901a\u8fc7 REST APIs \u8bbf\u95ee</code>/apis///...`     storage: true # \u5fc5\u987b\u5c06\u4e00\u4e2a\u4e14\u53ea\u6709\u4e00\u4e2a\u7248\u672c\u6807\u8bb0\u4e3a\u5b58\u50a8\u7248\u672c     schema:  # \u5b9a\u4e49\u81ea\u5b9a\u4e49\u5bf9\u8c61\u7684\u58f0\u660e\u89c4\u8303       openAPIV3Schema:         description: Define CronTab YAML Spec         type: object         properties:           spec:             type: object             properties:               cronSpec:                 type: string               image:                 type: string               replicas:                 type: integer   # \u5b9a\u4e49\u4f5c\u7528\u8303\u56f4\uff1aNamespaced\uff08\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\uff09\u6216\u8005 Cluster\uff08\u6574\u4e2a\u96c6\u7fa4\uff09   scope: Namespaced   names:     # kind \u662f sigular \u7684\u4e00\u4e2a\u9a7c\u5cf0\u5f62\u5f0f\u5b9a\u4e49\uff0c\u5728\u8d44\u6e90\u6e05\u5355\u4e2d\u4f1a\u4f7f\u7528     kind: CronTab     # plural \u540d\u5b57\u7528\u4e8e REST API \u4e2d\u7684\u5b9a\u4e49\uff1a/apis///     plural: crontabs     # singular \u540d\u79f0\u7528\u4e8e CLI \u64cd\u4f5c\u6216\u663e\u793a\u7684\u4e00\u4e2a\u522b\u540d     singular: crontab     # shortNames \u76f8\u5f53\u4e8e\u7f29\u5199\u5f62\u5f0f     shortNames:     - ct <pre><code>&gt; &gt; \u9700\u8981\u6ce8\u610f\u7684\u662f v1.26 \u7248\u672c\u4ee5\u540e\u5df2\u7ecf GA \u4e86\uff0c\u4f7f\u7528\u7684\u662f v1 \u7248\u672c\uff0c\u4e4b\u524d\u90fd\u662f v1beta1\uff0c\u5b9a\u4e49\u89c4\u8303\u6709\u90e8\u5206\u53d8\u5316\uff0c\u6240\u4ee5\u8981\u6ce8\u610f\u7248\u672c\u53d8\u5316\u3002\n\n&gt; \u8fd9\u4e2a\u5730\u65b9\u7684\u5b9a\u4e49\u548c\u6211\u4eec\u5b9a\u4e49\u666e\u901a\u7684\u8d44\u6e90\u5bf9\u8c61\u6bd4\u8f83\u7c7b\u4f3c\uff0c\u6211\u4eec\u8bf4\u6211\u4eec\u53ef\u4ee5\u968f\u610f\u5b9a\u4e49\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u4f46\u662f\u5728\u521b\u5efa\u8d44\u6e90\u7684\u65f6\u5019\uff0c\u80af\u5b9a\u4e0d\u662f\u4efb\u7531\u6211\u4eec\u968f\u610f\u53bb\u7f16\u5199 YAML \u6587\u4ef6\u7684\uff0c\u5f53\u6211\u4eec\u628a\u4e0a\u9762\u7684 CRD \u6587\u4ef6\u63d0\u4ea4\u7ed9 Kubernetes \u4e4b\u540e\uff0cKubernetes \u4f1a\u5bf9\u6211\u4eec\u63d0\u4ea4\u7684\u58f0\u660e\u6587\u4ef6\u8fdb\u884c\u6821\u9a8c\uff0c\u4ece\u5b9a\u4e49\u53ef\u4ee5\u770b\u51fa CRD \u662f\u57fa\u4e8e OpenAPI v3 schem \u8fdb\u884c\u89c4\u8303\u7684\u3002\u5f53\u7136\u8fd9\u79cd\u6821\u9a8c\u53ea\u662f\u5bf9\u4e8e\u5b57\u6bb5\u7684\u7c7b\u578b\u8fdb\u884c\u6821\u9a8c\uff0c\u6bd4\u8f83\u521d\u7ea7\uff0c\u5982\u679c\u60f3\u8981\u66f4\u52a0\u590d\u6742\u7684\u6821\u9a8c\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u901a\u8fc7 Kubernetes \u7684 admission webhook \u6765\u5b9e\u73b0\u4e86\u3002\u5173\u4e8e\u6821\u9a8c\u7684\u66f4\u591a\u7528\u6cd5\uff0c\u53ef\u4ee5\u524d\u5f80\u5b98\u65b9\u6587\u6863\u67e5\u770b\u3002\n\n&gt; \u540c\u6837\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 kubectl \u6765\u521b\u5efa\u8fd9\u4e2a CRD \u8d44\u6e90\u6e05\u5355\uff1a\n</code></pre> $ kubectl apply -f crd-demo.yaml customresourcedefinition.apiextensions.k8s.io/crontabs.stable.example.com created <pre><code>&gt; \u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5230\u96c6\u7fa4\u4e2d\u5df2\u7ecf\u6709\u6211\u4eec\u5b9a\u4e49\u7684\u8fd9\u4e2a CRD \u8d44\u6e90\u5bf9\u8c61\u4e86\uff1a\n</code></pre> $ kubectl get crd |grep example crontabs.stable.example.com                      2019-12-19T02:37:54Z <pre><code>&gt; \u8fd9\u4e2a\u65f6\u5019\u4e00\u4e2a\u65b0\u7684 namespace \u7ea7\u522b\u7684 RESTful API \u5c31\u4f1a\u88ab\u521b\u5efa\uff1a\n</code></pre> /apis/stable/example.com/v1beta1/namespaces//crontabs/... <pre><code>&gt; \u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a API \u7aef\u70b9\u6765\u521b\u5efa\u548c\u7ba1\u7406\u81ea\u5b9a\u4e49\u7684\u5bf9\u8c61\uff0c\u8fd9\u4e9b\u5bf9\u8c61\u7684\u7c7b\u578b\u5c31\u662f\u4e0a\u9762\u521b\u5efa\u7684 CRD \u5bf9\u8c61\u89c4\u8303\u4e2d\u7684 `CronTab`\u3002\n\n&gt; \u73b0\u5728\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u6211\u4eec\u5c31\u591a\u4e86\u4e00\u79cd\u65b0\u7684\u8d44\u6e90\u53eb\u505a \n</code></pre> crontabs.stable.example.com <pre><code>\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u5b83\u6765\u5b9a\u4e49\u4e00\u4e2a `CronTab` \u8d44\u6e90\u5bf9\u8c61\u4e86\uff0c\u8fd9\u4e2a\u81ea\u5b9a\u4e49\u8d44\u6e90\u5bf9\u8c61\u91cc\u9762\u53ef\u4ee5\u5305\u542b\u7684\u5b57\u6bb5\u6211\u4eec\u5728\u5b9a\u4e49\u7684\u65f6\u5019\u901a\u8fc7 `schema` \u8fdb\u884c\u4e86\u89c4\u8303\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u6e05\u5355\uff1a(crd-crontab-demo.yaml)\n</code></pre> apiVersion: \"stable.example.com/v1beta1\" kind: CronTab metadata:   name: my-new-cron-object spec:   cronSpec: \" * * * /5\"   image: my-awesome-cron-image <pre><code>&gt; \u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u5bf9\u8c61\uff1a\n</code></pre> $ kubectl apply -f crd-crontab-demo.yaml crontab.stable.example.com/my-new-cron-object created <pre><code>&gt; \u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u7528 kubectl \u6765\u7ba1\u7406\u6211\u4eec\u8fd9\u91cc\u521b\u5efa CronTab \u5bf9\u8c61\u4e86\uff0c\u6bd4\u5982\uff1a\n</code></pre> $ kubectl get ct  # \u7b80\u5199 NAME                 AGE my-new-cron-object   42s $ kubectl get crontab NAME                 AGE my-new-cron-object   88s <pre><code>&gt; \u5728\u4f7f\u7528 kubectl \u7684\u65f6\u5019\uff0c\u8d44\u6e90\u540d\u79f0\u662f\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 CRD \u4e2d\u5b9a\u4e49\u7684\u5355\u6570\u6216\u8005\u590d\u6570\u5f62\u5f0f\u4ee5\u53ca\u4efb\u4f55\u7b80\u5199\u3002\n\n&gt; \u6211\u4eec\u4e5f\u53ef\u4ee5\u67e5\u770b\u521b\u5efa\u7684\u8fd9\u4e2a\u5bf9\u8c61\u7684\u539f\u59cb YAML \u6570\u636e\uff1a\n</code></pre> $ kubectl get ct -o yaml apiVersion: v1 items: - apiVersion: stable.example.com/v1beta1   kind: CronTab   metadata:     annotations:       kubectl.kubernetes.io/last-applied-configuration: |         {\"apiVersion\":\"stable.example.com/v1beta1\",\"kind\":\"CronTab\",\"metadata\":{\"annotations\":{},\"name\":\"my-new-cron-object\",\"namespace\":\"default\"},\"spec\":{\"cronSpec\":\" * * * /5\",\"image\":\"my-awesome-cron-image\"}}     creationTimestamp: \"2019-12-19T02:52:55Z\"     generation: 1     name: my-new-cron-object     namespace: default     resourceVersion: \"12342275\"     selfLink: /apis/stable.example.com/v1beta1/namespaces/default/crontabs/my-new-cron-object     uid: dace308d-5f54-4232-9c7b-841adf6bab62   spec:     cronSpec: ' * * * */5'     image: my-awesome-cron-image kind: List metadata:   resourceVersion: \"\"   selfLink: \"\" <pre><code>&gt; \u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5b83\u5305\u542b\u4e86\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u7684 `cronSpec` \u548c `image` \u5b57\u6bb5\u3002\n\n### Controller\n\n&gt; \u5c31\u5982\u4e0a\u9762\u6211\u4eec\u8bf4\u7684\uff0c\u73b0\u5728\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u8d44\u6e90\u521b\u5efa\u5b8c\u6210\u4e86\uff0c\u4f46\u662f\u4e5f\u53ea\u662f\u5355\u7eaf\u7684\u628a\u8d44\u6e90\u6e05\u5355\u6570\u636e\u5b58\u5165\u5230\u4e86 etcd \u4e2d\u800c\u5df2\uff0c\u5e76\u6ca1\u6709\u4ec0\u4e48\u5176\u4ed6\u7528\u5904\uff0c\u56e0\u4e3a\u6211\u4eec\u6ca1\u6709\u5b9a\u4e49\u4e00\u4e2a\u5bf9\u5e94\u7684 Controller \u6765\u5904\u7406\u4ed6\u3002\n\n&gt; \u5b98\u65b9\u63d0\u4f9b\u4e86\u4e00\u4e2a\u81ea\u5b9a\u4e49 Controller \u7684\u793a\u4f8b\uff1ahttps://github.com/kubernetes/sample-controller\uff0c\u5b9e\u73b0\u4e86\uff1a\n\n*   \u5982\u4f55\u6ce8\u518c\u8d44\u6e90 Foo\n*   \u5982\u4f55\u521b\u5efa\u3001\u5220\u9664\u548c\u67e5\u8be2 Foo \u5bf9\u8c61\n*   \u5982\u4f55\u76d1\u542c Foo \u8d44\u6e90\u5bf9\u8c61\u7684\u53d8\u5316\u60c5\u51b5\n\n&gt; \u8981\u60f3\u4e86\u89e3 Controller \u7684\u5b9e\u73b0\u539f\u7406\u548c\u65b9\u5f0f\uff0c\u6211\u4eec\u5c31\u9700\u8981\u4e86\u89e3\u4e0b client-go \u8fd9\u4e2a\u5e93\u7684\u5b9e\u73b0\uff0cKubernetes \u90e8\u5206\u4ee3\u7801\u4e5f\u662f\u57fa\u4e8e\u8fd9\u4e2a\u5e93\u5b9e\u73b0\u7684\uff0c\u4e5f\u5305\u542b\u4e86\u5f00\u53d1\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u65f6\u53ef\u4ee5\u4f7f\u7528\u7684\u5404\u79cd\u673a\u5236\uff0c\u8fd9\u4e9b\u673a\u5236\u5728 client-go \u6e90\u7801\u7684 tools/cache \u76ee\u5f55\u4e0b\u9762\u6709\u5b9a\u4e49\u3002\n\n&gt; \u4e0b\u56fe\u663e\u793a\u4e86 client-go \u4e2d\u7684\u5404\u4e2a\u7ec4\u4ef6\u662f\u5982\u4f55\u516c\u4f17\u7684\u4ee5\u53ca\u4e0e\u6211\u4eec\u8981\u7f16\u5199\u7684\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u4ee3\u7801\u7684\u4ea4\u4e92\u5165\u53e3\uff1a\n\n&gt; ![client-go controller interaction](https://bxdc-static.oss-cn-beijing.aliyuncs.com/images/client-go-controller-interaction.jpeg)\n\n&gt; `client-go \u7ec4\u4ef6`\uff1a\n\n*   Reflector\uff1a\u901a\u8fc7 Kubernetes API \u76d1\u63a7 Kubernetes \u7684\u8d44\u6e90\u7c7b\u578b \u91c7\u7528 List/Watch \u673a\u5236, \u53ef\u4ee5 Watch \u4efb\u4f55\u8d44\u6e90\u5305\u62ec CRD \u6dfb\u52a0 object \u5bf9\u8c61\u5230 FIFO \u961f\u5217\uff0c\u7136\u540e Informer \u4f1a\u4ece\u961f\u5217\u91cc\u9762\u53d6\u6570\u636e\n*   Informer\uff1acontroller \u673a\u5236\u7684\u57fa\u7840\uff0c\u5faa\u73af\u5904\u7406 object \u5bf9\u8c61 \u4ece Reflector \u53d6\u51fa\u6570\u636e\uff0c\u7136\u540e\u5c06\u6570\u636e\u7ed9\u5230 Indexer \u53bb\u7f13\u5b58\uff0c\u63d0\u4f9b\u5bf9\u8c61\u4e8b\u4ef6\u7684 handler \u63a5\u53e3\uff0c\u53ea\u8981\u7ed9 Informer \u6dfb\u52a0 `ResourceEventHandler` \u5b9e\u4f8b\u7684\u56de\u8c03\u51fd\u6570\uff0c\u53bb\u5b9e\u73b0 \n\n    ```\n    OnAdd(obj interface{})\n    ```\n\n    \u3001 \n\n    ```\n    OnUpdate(oldObj, newObj interface{})\n    ```\n\n     \u548c \n\n    ```\n    OnDelete(obj interface{})\n    ```\n\n     \u8fd9\u4e09\u4e2a\u65b9\u6cd5\uff0c\u5c31\u53ef\u4ee5\u5904\u7406\u597d\u8d44\u6e90\u7684\u521b\u5efa\u3001\u66f4\u65b0\u548c\u5220\u9664\u64cd\u4f5c\u4e86\u3002\n*   Indexer\uff1a\u63d0\u4f9b object \u5bf9\u8c61\u7684\u7d22\u5f15\uff0c\u662f\u7ebf\u7a0b\u5b89\u5168\u7684\uff0c\u7f13\u5b58\u5bf9\u8c61\u4fe1\u606f\n\n&gt; `controller \u7ec4\u4ef6`\uff1a * Informer reference: controller \u9700\u8981\u521b\u5efa\u5408\u9002\u7684 Informer \u624d\u80fd\u901a\u8fc7 Informer reference \u64cd\u4f5c\u8d44\u6e90\u5bf9\u8c61 * Indexer reference: controller \u521b\u5efa Indexer reference \u7136\u540e\u53bb\u5229\u7528\u7d22\u5f15\u505a\u76f8\u5173\u5904\u7406 * Resource Event Handlers\uff1aInformer \u4f1a\u56de\u8c03\u8fd9\u4e9b handlers * Work queue: Resource Event Handlers \u88ab\u56de\u8c03\u540e\u5c06 key \u5199\u5230\u5de5\u4f5c\u961f\u5217\uff0c\u8fd9\u91cc\u7684 key \u76f8\u5f53\u4e8e\u4e8b\u4ef6\u901a\u77e5\uff0c\u540e\u9762\u6839\u636e\u53d6\u51fa\u4e8b\u4ef6\u540e\uff0c\u505a\u540e\u7eed\u7684\u5904\u7406 * Process Item\uff1a\u4ece\u5de5\u4f5c\u961f\u5217\u4e2d\u53d6\u51fa key \u540e\u8fdb\u884c\u540e\u7eed\u5904\u7406\uff0c\u5177\u4f53\u5904\u7406\u53ef\u4ee5\u901a\u8fc7 Indexer reference controller \u53ef\u4ee5\u76f4\u63a5\u521b\u5efa\u4e0a\u8ff0\u4e24\u4e2a\u5f15\u7528\u5bf9\u8c61\u53bb\u5904\u7406\uff0c\u4e5f\u53ef\u4ee5\u91c7\u7528\u5de5\u5382\u6a21\u5f0f\uff0c\u5b98\u65b9\u90fd\u6709\u76f8\u5173\u793a\u4f8b\n\n&gt; ```\nclient-go/tool/cache/\n</code></pre> <p>\u548c\u81ea\u5b9a\u4e49 Controller \u7684\u63a7\u5236\u6d41(\u56fe\u7247\u6765\u6e90)\uff1a</p> <p></p> <p>\u5982\u4e0a\u56fe\u6240\u793a\u4e3b\u8981\u6709\u4e24\u4e2a\u90e8\u5206\uff0c\u4e00\u4e2a\u662f\u53d1\u751f\u5728 <code>SharedIndexInformer</code> \u4e2d\uff0c\u53e6\u5916\u4e00\u4e2a\u662f\u5728\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u4e2d\u3002</p> <ol> <li> <p><code>Reflector</code> \u901a\u8fc7 Kubernetes APIServer \u6267\u884c\u5bf9\u8c61\uff08\u6bd4\u5982 Pod\uff09\u7684 <code>ListAndWatch</code> \u67e5\u8be2\uff0c\u8bb0\u5f55\u548c\u5bf9\u8c61\u76f8\u5173\u7684\u4e09\u79cd\u4e8b\u4ef6\u7c7b\u578b<code>Added</code>\u3001<code>Updated</code>\u3001<code>Deleted</code>\uff0c\u7136\u540e\u5c06\u5b83\u4eec\u4f20\u9012\u5230 <code>DeltaFIFO</code> \u4e2d\u53bb\u3002</p> </li> <li> <p><code>DeltaFIFO</code> \u63a5\u6536\u5230\u4e8b\u4ef6\u548c watch \u4e8b\u4ef6\u5bf9\u5e94\u7684\u5bf9\u8c61\uff0c\u7136\u540e\u5c06\u4ed6\u4eec\u8f6c\u6362\u4e3a <code>Delta</code> \u5bf9\u8c61\uff0c\u8fd9\u4e9b <code>Delta</code> \u5bf9\u8c61\u88ab\u9644\u52a0\u5230\u961f\u5217\u4e2d\u53bb\u7b49\u5f85\u5904\u7406\uff0c\u5bf9\u4e8e\u5df2\u7ecf\u5220\u9664\u7684\uff0c\u4f1a\u68c0\u67e5\u7ebf\u7a0b\u5b89\u5168\u7684 store \u4e2d\u662f\u5426\u5df2\u7ecf\u5b58\u5728\u8be5\u6587\u4ef6\uff0c\u4ece\u800c\u53ef\u4ee5\u907f\u514d\u5728\u4e0d\u5b58\u5728\u67d0\u4e9b\u5185\u5bb9\u65f6\u6392\u961f\u6267\u884c\u5220\u9664\u64cd\u4f5c\u3002</p> </li> <li> <p>Cache \u63a7\u5236\u5668\uff08\u4e0d\u8981\u548c\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u6df7\u6dc6\uff09\u8c03\u7528 <code>Pop()</code> \u65b9\u6cd5\u4ece <code>DeltaFIFO</code> \u961f\u5217\u4e2d\u51fa\u961f\u5217\uff0c<code>Delta</code> \u5bf9\u8c61\u5c06\u4f20\u9012\u5230 <code>SharedIndexInformer</code> \u7684 <code>HandleDelta()</code> \u65b9\u6cd5\u4e2d\u4ee5\u8fdb\u884c\u8fdb\u4e00\u6b65\u5904\u7406\u3002</p> </li> <li> <p>\u6839\u636e <code>Delta</code> \u5bf9\u8c61\u7684\u64cd\u4f5c\uff08\u4e8b\u4ef6\uff09\u7c7b\u578b\uff0c\u9996\u5148\u5728 <code>HandleDeltas</code> \u65b9\u6cd5\u4e2d\u901a\u8fc7 <code>indexer</code> \u7684\u65b9\u6cd5\u5c06\u5bf9\u5bf9\u8c61\u4fdd\u5b58\u5230\u7ebf\u7a0b\u5b89\u5168\u7684 Store \u4e2d\uff0c\u7136\u540e\uff0c\u901a\u8fc7 <code>SharedIndexInformer</code> \u4e2d\u7684 <code>sharedProcessor</code> \u7684 <code>distribution()</code> \u65b9\u6cd5\u5c06\u8fd9\u4e9b\u5bf9\u8c61\u53d1\u9001\u5230\u4e8b\u4ef6 handlers\uff0c\u8fd9\u4e9b\u4e8b\u4ef6\u5904\u7406\u5668\u7531\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u901a\u8fc7 <code>SharedInformer</code> \u7684\u65b9\u6cd5\u6bd4\u5982 </p> <pre><code>AddEventHandlerWithResyncPeriod()\n</code></pre> <p>\u8fdb\u884c\u6ce8\u518c\u3002</p> </li> <li> <p>\u5df2\u6ce8\u518c\u7684\u4e8b\u4ef6\u5904\u7406\u5668\u901a\u8fc7\u6dfb\u52a0\u6216\u66f4\u65b0\u65f6\u95f4\u7684 </p> <pre><code>MetaNamespaceKeyFunc()\n</code></pre> <p>\u6216\u5220\u9664\u4e8b\u4ef6\u7684 </p> <pre><code>DeletionHandingMetaNamespaceKeyFunc()\n</code></pre> <p>\u5c06\u5bf9\u8c61\u8f6c\u6362\u4e3a\u683c\u5f0f\u4e3a <code>namespace/name</code> \u6216\u53ea\u662f <code>name</code> \u7684 key\uff0c\u7136\u540e\u5c06\u8fd9\u4e2a key \u6dfb\u52a0\u5230\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u7684 <code>workqueue</code> \u4e2d\uff0c<code>workqueues</code> \u7684\u5b9e\u73b0\u53ef\u4ee5\u5728 <code>util/workqueue</code> \u4e2d\u627e\u5230\u3002</p> </li> <li> <p>\u81ea\u5b9a\u4e49\u7684\u63a7\u5236\u5668\u901a\u8fc7\u8c03\u7528\u5b9a\u4e49\u7684 handlers \u5904\u7406\u5668\u4ece workqueue \u4e2d pop \u4e00\u4e2a key \u51fa\u6765\u8fdb\u884c\u5904\u7406\uff0chandlers \u5c06\u8c03\u7528 indexer \u7684 <code>GetByKey()</code> \u4ece\u7ebf\u7a0b\u5b89\u5168\u7684 store \u4e2d\u83b7\u53d6\u5bf9\u8c61\uff0c\u6211\u4eec\u7684\u4e1a\u52a1\u903b\u8f91\u5c31\u662f\u5728\u8fd9\u4e2a handlers \u91cc\u9762\u5b9e\u73b0\u3002</p> </li> </ol> <p><code>client-go</code> \u4e2d\u4e5f\u6709\u81ea\u5b9a\u4e49 Controller \u7684\u6837\u4f8b\u4ee3\u7801\uff0c\u4f4d\u4e8e\uff1a</p> <pre><code>k8s.io/client-go/examples/workqueue/main.go\n</code></pre> <p>\u3002</p>"},{"location":"kubernetes_operator/crd/#_1","title":"\u53c2\u8003\u6587\u6863","text":"<ul> <li>How to Create a Kubernetes Custom Controller Using client-go</li> <li>A deep dive into Kubernetes controllers</li> </ul>"},{"location":"kubernetes_operator/operator/","title":"Operator","text":""},{"location":"kubernetes_operator/operator/#operator","title":"Operator","text":"<p><code>Operator</code> \u5c31\u53ef\u4ee5\u770b\u6210\u662f CRD \u548c Controller \u7684\u4e00\u79cd\u7ec4\u5408\u7279\u4f8b\uff0cOperator \u662f\u4e00\u79cd\u601d\u60f3\uff0c\u5b83\u7ed3\u5408\u4e86\u7279\u5b9a\u9886\u57df\u77e5\u8bc6\u5e76\u901a\u8fc7 CRD \u673a\u5236\u6269\u5c55\u4e86 Kubernetes API \u8d44\u6e90\uff0c\u4f7f\u7528\u6237\u7ba1\u7406 Kubernetes \u7684\u5185\u7f6e\u8d44\u6e90\uff08Pod\u3001Deployment\u7b49\uff09\u4e00\u6837\u521b\u5efa\u3001\u914d\u7f6e\u548c\u7ba1\u7406\u5e94\u7528\u7a0b\u5e8f\uff0cOperator \u662f\u4e00\u4e2a\u7279\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u63a7\u5236\u5668\uff0c\u901a\u8fc7\u6269\u5c55 Kubernetes API \u8d44\u6e90\u4ee5\u4ee3\u8868 Kubernetes \u7528\u6237\u521b\u5efa\u3001\u914d\u7f6e\u548c\u7ba1\u7406\u590d\u6742\u5e94\u7528\u7a0b\u5e8f\u7684\u5b9e\u4f8b\uff0c\u901a\u5e38\u5305\u542b\u8d44\u6e90\u6a21\u578b\u5b9a\u4e49\u548c\u63a7\u5236\u5668\uff0c\u901a\u8fc7 <code>Operator</code> \u901a\u5e38\u662f\u4e3a\u4e86\u5b9e\u73b0\u67d0\u79cd\u7279\u5b9a\u8f6f\u4ef6\uff08\u901a\u5e38\u662f\u6709\u72b6\u6001\u670d\u52a1\uff09\u7684\u81ea\u52a8\u5316\u8fd0\u7ef4\u3002</p> <p>\u6211\u4eec\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u7684\u65b9\u5f0f\u7f16\u5199\u4e00\u4e2a CRD \u5bf9\u8c61\uff0c\u7136\u540e\u53bb\u624b\u52a8\u5b9e\u73b0\u4e00\u4e2a\u5bf9\u5e94\u7684 Controller \u5c31\u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e2a Operator\uff0c\u4f46\u662f\u6211\u4eec\u4e5f\u53d1\u73b0\u4ece\u5934\u5f00\u59cb\u53bb\u6784\u5efa\u4e00\u4e2a CRD \u63a7\u5236\u5668\u5e76\u4e0d\u5bb9\u6613\uff0c\u9700\u8981\u5bf9 Kubernetes \u7684 API \u6709\u6df1\u5165\u4e86\u89e3\uff0c\u5e76\u4e14 RBAC \u96c6\u6210\u3001\u955c\u50cf\u6784\u5efa\u3001\u6301\u7eed\u96c6\u6210\u548c\u90e8\u7f72\u7b49\u90fd\u9700\u8981\u5f88\u5927\u5de5\u4f5c\u91cf\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u793e\u533a\u5c31\u63a8\u51fa\u4e86\u5bf9\u5e94\u7684\u7b80\u5355\u6613\u7528\u7684 Operator \u6846\u67b6\uff0c\u6bd4\u8f83\u4e3b\u6d41\u7684\u662f kubebuilder \u548c Operator Framework\uff0c\u8fd9\u4e24\u4e2a\u6846\u67b6\u7684\u4f7f\u7528\u57fa\u672c\u4e0a\u5dee\u522b\u4e0d\u5927\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u4e60\u60ef\u9009\u62e9\u4e00\u4e2a\u5373\u53ef\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 <code>Operator Framework</code> \u6765\u7ed9\u5927\u5bb6\u7b80\u8981\u8bf4\u660e\u4e0b Operator \u7684\u5f00\u53d1\u3002</p>"},{"location":"kubernetes_operator/operator/#operator_framework","title":"Operator Framework","text":"<p><code>Operator Framework</code> \u662f CoreOS \u5f00\u6e90\u7684\u4e00\u4e2a\u7528\u4e8e\u5feb\u901f\u5f00\u53d1 Operator \u7684\u5de5\u5177\u5305\uff0c\u8be5\u6846\u67b6\u5305\u542b\u4e24\u4e2a\u4e3b\u8981\u7684\u90e8\u5206\uff1a</p> <ul> <li>Operator SDK: \u65e0\u9700\u4e86\u89e3\u590d\u6742\u7684 Kubernetes API \u7279\u6027\uff0c\u5373\u53ef\u8ba9\u4f60\u6839\u636e\u4f60\u81ea\u5df1\u7684\u4e13\u4e1a\u77e5\u8bc6\u6784\u5efa\u4e00\u4e2a Operator \u5e94\u7528\u3002</li> <li>Operator Lifecycle Manager\uff08OLM\uff09: \u5e2e\u52a9\u4f60\u5b89\u88c5\u3001\u66f4\u65b0\u548c\u7ba1\u7406\u8de8\u96c6\u7fa4\u7684\u8fd0\u884c\u4e2d\u7684\u6240\u6709 Operator\uff08\u4ee5\u53ca\u4ed6\u4eec\u7684\u76f8\u5173\u670d\u52a1\uff09</li> </ul> <p></p> <p>Operator SDK \u63d0\u4f9b\u4ee5\u4e0b\u5de5\u4f5c\u6d41\u6765\u5f00\u53d1\u4e00\u4e2a\u65b0\u7684 Operator\uff1a</p> <ol> <li>\u4f7f\u7528 SDK \u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Operator \u9879\u76ee</li> <li>\u901a\u8fc7\u6dfb\u52a0\u81ea\u5b9a\u4e49\u8d44\u6e90\uff08CRD\uff09\u5b9a\u4e49\u65b0\u7684\u8d44\u6e90 API</li> <li>\u6307\u5b9a\u4f7f\u7528 SDK API \u6765 watch \u7684\u8d44\u6e90</li> <li>\u5b9a\u4e49 Operator \u7684\u534f\u8c03\uff08reconcile\uff09\u903b\u8f91</li> <li>\u4f7f\u7528 Operator SDK \u6784\u5efa\u5e76\u751f\u6210 Operator \u90e8\u7f72\u6e05\u5355\u6587\u4ef6</li> </ol>"},{"location":"kubernetes_operator/operator/#_1","title":"\u793a\u4f8b","text":"<p>\u6211\u4eec\u5e73\u65f6\u5728\u90e8\u7f72\u4e00\u4e2a\u7b80\u5355\u7684 Webserver \u5230 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u65f6\u5019\uff0c\u90fd\u9700\u8981\u5148\u7f16\u5199\u4e00\u4e2a Deployment \u7684\u63a7\u5236\u5668\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a Service \u5bf9\u8c61\uff0c\u901a\u8fc7 Pod \u7684 label \u6807\u7b7e\u8fdb\u884c\u5173\u8054\uff0c\u6700\u540e\u901a\u8fc7 Ingress \u6216\u8005 type=NodePort \u7c7b\u578b\u7684 Service \u6765\u66b4\u9732\u670d\u52a1\uff0c\u6bcf\u6b21\u90fd\u9700\u8981\u8fd9\u6837\u64cd\u4f5c\uff0c\u662f\u4e0d\u662f\u7565\u663e\u9ebb\u70e6\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u901a\u8fc7\u6211\u4eec\u7684 CRD \u6765\u63cf\u8ff0\u6211\u4eec\u8981\u90e8\u7f72\u7684\u5e94\u7528\u4fe1\u606f\uff0c\u6bd4\u5982\u955c\u50cf\u3001\u670d\u52a1\u7aef\u53e3\u3001\u73af\u5883\u53d8\u91cf\u7b49\u7b49\uff0c\u7136\u540e\u521b\u5efa\u6211\u4eec\u7684\u81ea\u5b9a\u4e49\u7c7b\u578b\u7684\u8d44\u6e90\u5bf9\u8c61\u7684\u65f6\u5019\uff0c\u901a\u8fc7\u63a7\u5236\u5668\u53bb\u521b\u5efa\u5bf9\u5e94\u7684 Deployment \u548c Service\uff0c\u662f\u4e0d\u662f\u5c31\u65b9\u4fbf\u5f88\u591a\u4e86\uff0c\u76f8\u5f53\u4e8e\u6211\u4eec\u7528\u4e00\u4e2a\u8d44\u6e90\u6e05\u5355\u53bb\u63cf\u8ff0\u4e86 Deployment \u548c Service \u8981\u505a\u7684\u4e24\u4ef6\u4e8b\u60c5\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a AppService \u7684 CRD \u8d44\u6e90\u5bf9\u8c61\uff0c\u7136\u540e\u5b9a\u4e49\u5982\u4e0b\u7684\u8d44\u6e90\u6e05\u5355\u8fdb\u884c\u5e94\u7528\u90e8\u7f72\uff1a</p> <pre><code>apiVersion: app.example.com/v1\nkind: AppService\nmetadata:\n  name: nginx-app\nspec:\n  size: 2\n  image: nginx:9\n  ports:\n    - port: 80\n      targetPort: 80\n      nodePort: 30002\n</code></pre> <p>\u901a\u8fc7\u8fd9\u91cc\u7684\u81ea\u5b9a\u4e49\u7684 AppService \u8d44\u6e90\u5bf9\u8c61\u53bb\u521b\u5efa\u526f\u672c\u6570\u4e3a2\u7684 Pod\uff0c\u7136\u540e\u901a\u8fc7 <code>nodePort=30002</code> \u7684\u7aef\u53e3\u53bb\u66b4\u9732\u670d\u52a1\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u4e00\u6b65\u4e00\u6b65\u7684\u5b9e\u73b0\u6211\u4eec\u8fd9\u91cc\u7684\u8fd9\u4e2a\u7b80\u5355\u7684 Operator \u5e94\u7528\u3002</p>"},{"location":"kubernetes_operator/operator/#_2","title":"\u5f00\u53d1\u73af\u5883","text":"<p>\u8981\u5f00\u53d1 Operator \u81ea\u7136 Kubernetes \u96c6\u7fa4\u662f\u5c11\u4e0d\u4e86\u7684\uff0c\u8fd8\u9700\u8981 Golang \u7684\u73af\u5883\uff0c\u8fd9\u91cc\u7684\u5b89\u88c5\u5c31\u4e0d\u591a\u8bf4\u4e86\u3002\u7136\u540e\u9700\u8981\u5b89\u88c5 <code>operator-sdk</code>\uff0coperator sdk \u5b89\u88c5\u65b9\u6cd5\u975e\u5e38\u591a\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728 github \u4e0a\u9762\u4e0b\u8f7d\u9700\u8981\u4f7f\u7528\u7684\u7248\u672c\uff0c\u7136\u540e\u653e\u7f6e\u5230 PATH \u73af\u5883\u4e0b\u9762\u5373\u53ef\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u5c06\u6e90\u7801 clone \u5230\u672c\u5730\u624b\u52a8\u7f16\u8bd1\u5b89\u88c5\u5373\u53ef\uff0c\u5982\u679c\u4f60\u662f Mac\uff0c\u5f53\u7136\u8fd8\u53ef\u4ee5\u4f7f\u7528\u5e38\u7528\u7684 brew \u5de5\u5177\u8fdb\u884c\u5b89\u88c5\uff1a</p> <pre><code>$ brew install operator-sdk\n......\n$ operator-sdk version\noperator-sdk version: \"v0\", commit: \"2445fcda834ca4b7cf0d6c38fba6317fb219b469\", go version: \"go1\n.3 darwin/amd64\"\n$ go version\ngo version go3 darwin/amd64\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684 sdk \u7248\u672c\u662f <code>v0.12.0</code>\uff0c\u5176\u4ed6\u5b89\u88c5\u65b9\u6cd5\u53ef\u4ee5\u53c2\u8003\u6587\u6863\uff1ahttps://github.com/operator-framework/operator-sdk/blob/master/doc/user/install-operator-sdk.md</p>"},{"location":"kubernetes_operator/operator/#_3","title":"\u521b\u5efa\u9879\u76ee","text":"<p>\u73af\u5883\u51c6\u5907\u597d\u4e86\uff0c\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>operator-sdk</code> \u76f4\u63a5\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u9879\u76ee\u4e86\uff0c\u547d\u4ee4\u683c\u5f0f\u4e3a\uff1a<code>operator-sdk new</code>\u3002</p> <p>\u6309\u7167\u4e0a\u9762\u6211\u4eec\u9884\u5148\u5b9a\u4e49\u7684 CRD \u8d44\u6e90\u6e05\u5355\uff0c\u6211\u4eec\u8fd9\u91cc\u53ef\u4ee5\u8fd9\u6837\u521b\u5efa\uff1a</p> <pre><code># \u521b\u5efa\u9879\u76ee\u76ee\u5f55\n$ mkdir -p operator-learning &amp;&amp; cd operator-learning\n$ export GO111MODULE=on  # \u4f7f\u7528gomodules\u5305\u7ba1\u7406\u5de5\u5177\n$ export GOPROXY=\"https://goproxy.io\" # \u4f7f\u7528\u5305\u4ee3\u7406\uff0c\u52a0\u901f\n# \u4f7f\u7528 sdk \u521b\u5efa\u4e00\u4e2a\u540d\u4e3a opdemo \u7684 operator \u9879\u76ee\uff0c\u5982\u679c\u5728 GOPATH \u4e4b\u5916\u9700\u8981\u6307\u5b9a repo \u53c2\u6570\n$ operator-sdk new opdemo --repo github.com/cnych/opdemo\nINFO[0000] Creating new Go operator 'opdemo'.           \nINFO[0000] Created go.mod                               \nINFO[0000] Created tools.go                             \nINFO[0000] Created cmd/manager/main.go                  \nINFO[0000] Created build/Dockerfile                     \nINFO[0000] Created build/bin/entrypoint                 \nINFO[0000] Created build/bin/user_setup                 \nINFO[0000] Created deploy/service_account.yaml          \nINFO[0000] Created deploy/role.yaml                     \nINFO[0000] Created deploy/role_binding.yaml             \nINFO[0000] Created deploy/operator.yaml                 \nINFO[0000] Created pkg/apis/apis.go                     \nINFO[0000] Created pkg/controller/controller.go         \nINFO[0000] Created version/version.go                   \nINFO[0000] Created .gitignore                           \nINFO[0000] Validating project                           \n......\nINFO[0063] Project validation successful.               \nINFO[0063] Project creation complete.  \n$ cd opdemo &amp;&amp; tree -L 2\n.\n\u251c\u2500\u2500 build\n\u2502   \u251c\u2500\u2500 Dockerfile\n\u2502   \u2514\u2500\u2500 bin\n\u251c\u2500\u2500 cmd\n\u2502   \u2514\u2500\u2500 manager\n\u251c\u2500\u2500 deploy\n\u2502   \u251c\u2500\u2500 operator.yaml\n\u2502   \u251c\u2500\u2500 role.yaml\n\u2502   \u251c\u2500\u2500 role_binding.yaml\n\u2502   \u2514\u2500\u2500 service_account.yaml\n\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 go.sum\n\u251c\u2500\u2500 pkg\n\u2502   \u251c\u2500\u2500 apis\n\u2502   \u2514\u2500\u2500 controller\n\u251c\u2500\u2500 tools.go\n\u2514\u2500\u2500 version\n    \u2514\u2500\u2500 version.go\n\n9 directories, 9 files\n</code></pre> <p>\u5230\u8fd9\u91cc\u4e00\u4e2a\u5168\u65b0\u7684 Operator \u9879\u76ee\u5c31\u65b0\u5efa\u5b8c\u6210\u4e86\u3002</p>"},{"location":"kubernetes_operator/operator/#_4","title":"\u9879\u76ee\u7ed3\u6784","text":"<p>\u4f7f\u7528 <code>operator-sdk new</code> \u547d\u4ee4\u521b\u5efa\u65b0\u7684 Operator \u9879\u76ee\u540e\uff0c\u9879\u76ee\u76ee\u5f55\u5c31\u5305\u542b\u4e86\u5f88\u591a\u751f\u6210\u7684\u6587\u4ef6\u5939\u548c\u6587\u4ef6\u3002</p> <ul> <li>go.mod go.sum\u200a\u2014\u200aGo Modules \u5305\u7ba1\u7406\u6e05\u5355\uff0c\u7528\u6765\u63cf\u8ff0\u5f53\u524d Operator \u7684\u4f9d\u8d56\u5305\u3002</li> <li>cmd - \u5305\u542b main.go \u6587\u4ef6\uff0c\u4f7f\u7528 operator-sdk API \u521d\u59cb\u5316\u548c\u542f\u52a8\u5f53\u524d Operator \u7684\u5165\u53e3\u3002</li> <li>deploy - \u5305\u542b\u4e00\u7ec4\u7528\u4e8e\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u8fdb\u884c\u90e8\u7f72\u7684\u901a\u7528\u7684 Kubernetes \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u3002</li> <li>pkg/apis - \u5305\u542b\u5b9a\u4e49\u7684 API \u548c\u81ea\u5b9a\u4e49\u8d44\u6e90\uff08CRD\uff09\u7684\u76ee\u5f55\u6811\uff0c\u8fd9\u4e9b\u6587\u4ef6\u5141\u8bb8 sdk \u4e3a CRD \u751f\u6210\u4ee3\u7801\u5e76\u6ce8\u518c\u5bf9\u5e94\u7684\u7c7b\u578b\uff0c\u4ee5\u4fbf\u6b63\u786e\u89e3\u7801\u81ea\u5b9a\u4e49\u8d44\u6e90\u5bf9\u8c61\u3002</li> <li>pkg/controller - \u7528\u4e8e\u7f16\u5199\u6240\u6709\u7684\u64cd\u4f5c\u4e1a\u52a1\u903b\u8f91\u7684\u5730\u65b9</li> <li>version - \u7248\u672c\u5b9a\u4e49</li> <li>build - Dockerfile \u5b9a\u4e49\u76ee\u5f55</li> </ul> <p>\u6211\u4eec\u4e3b\u8981\u9700\u8981\u7f16\u5199\u7684\u662f <code>pkg</code> \u76ee\u5f55\u4e0b\u9762\u7684 api \u5b9a\u4e49\u4ee5\u53ca\u5bf9\u5e94\u7684 controller \u5b9e\u73b0\u3002</p>"},{"location":"kubernetes_operator/operator/#api","title":"\u6dfb\u52a0 API","text":"<p>\u63a5\u4e0b\u6765\u4e3a\u6211\u4eec\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684 API\uff0c\u6309\u7167\u4e0a\u9762\u6211\u4eec\u9884\u5b9a\u4e49\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u5728 Operator \u76f8\u5173\u6839\u76ee\u5f55\u4e0b\u9762\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ operator-sdk add api --api-version=app.example.com/v1 --kind=AppService\n</code></pre> <p>\u6dfb\u52a0\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u7c7b\u4f3c\u4e8e\u4e0b\u9762\u7684\u8fd9\u6837\u9879\u76ee\u7ed3\u6784\uff1a </p>"},{"location":"kubernetes_operator/operator/#_5","title":"\u6dfb\u52a0\u63a7\u5236\u5668","text":"<p>\u4e0a\u9762\u6211\u4eec\u6dfb\u52a0\u81ea\u5b9a\u4e49\u7684 API\uff0c\u63a5\u4e0b\u6765\u53ef\u4ee5\u6dfb\u52a0\u5bf9\u5e94\u7684\u81ea\u5b9a\u4e49 API \u7684\u5177\u4f53\u5b9e\u73b0 Controller\uff0c\u540c\u6837\u5728\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u9762\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ operator-sdk add controller --api-version=app.example.com/v1 --kind=AppService\n</code></pre> <p>\u8fd9\u6837\u6574\u4e2a Operator \u9879\u76ee\u7684\u811a\u624b\u67b6\u5c31\u5df2\u7ecf\u642d\u5efa\u5b8c\u6210\u4e86\uff0c\u63a5\u4e0b\u6765\u5c31\u662f\u5177\u4f53\u7684\u5b9e\u73b0\u4e86\u3002</p>"},{"location":"kubernetes_operator/operator/#api_1","title":"\u81ea\u5b9a\u4e49 API","text":"<p>\u6253\u5f00\u6e90\u6587\u4ef6 </p> <pre><code>pkg/apis/app/v1/appservice_types.go\n</code></pre> <p>\uff0c\u9700\u8981\u6211\u4eec\u6839\u636e\u6211\u4eec\u7684\u9700\u6c42\u53bb\u81ea\u5b9a\u4e49\u7ed3\u6784\u4f53 <code>AppServiceSpec</code>\uff0c\u6211\u4eec\u6700\u4e0a\u9762\u9884\u5b9a\u4e49\u7684\u8d44\u6e90\u6e05\u5355\u4e2d\u5c31\u6709 <code>size</code>\u3001<code>image</code>\u3001<code>ports</code> \u8fd9\u4e9b\u5c5e\u6027\uff0c\u6240\u6709\u6211\u4eec\u9700\u8981\u7528\u5230\u7684\u5c5e\u6027\u90fd\u9700\u8981\u5728\u8fd9\u4e2a\u7ed3\u6784\u4f53\u4e2d\u8fdb\u884c\u5b9a\u4e49\uff1a</p> <pre><code>type AppServiceSpec struct {\n    // INSERT ADDITIONAL SPEC FIELDS - desired state of cluster\n    // Important: Run \"operator-sdk generate k8s\" to regenerate code after modifying this file\n    // Add custom validation using kubebuilder tags: https://book.kubebuilder.io/beyond_basics/generating_crd.html\n    Size      *int32                      `json:\"size\"`\n    Image     string                      `json:\"image\"`\n    Resources corevResourceRequirements `json:\"resources,omitempty\"`\n    Envs      []corevEnvVar             `json:\"envs,omitempty\"`\n    Ports     []corevServicePort        `json:\"ports,omitempty\"`\n}\n</code></pre> <p>\u4ee3\u7801\u4e2d\u4f1a\u6d89\u53ca\u5230\u4e00\u4e9b\u5305\u540d\u7684\u5bfc\u5165\uff0c\u7531\u4e8e\u5305\u540d\u8f83\u591a\uff0c\u6240\u4ee5\u6211\u4eec\u4f1a\u4f7f\u7528\u4e00\u4e9b\u522b\u540d\u8fdb\u884c\u533a\u5206\uff0c\u4e3b\u8981\u7684\u5305\u542b\u4e0b\u9762\u51e0\u4e2a\uff1a</p> <pre><code>import (\n    appsv1 \"k8s.io/api/apps/v1\"\n    corev1 \"k8s.io/api/core/v1\"\n    appv1 \"github.com/cnych/opdemo/pkg/apis/app/v1\"\n    metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n)\n</code></pre> <p>\u8fd9\u91cc\u7684 resources\u3001envs\u3001ports \u7684\u5b9a\u4e49\u90fd\u662f\u76f4\u63a5\u5f15\u7528\u7684 <code>\"k8s.io/api/core/v1\"</code> \u4e2d\u5b9a\u4e49\u7684\u7ed3\u6784\u4f53\uff0c\u800c\u4e14\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f <code>ServicePort</code>\uff0c\u800c\u4e0d\u662f\u50cf\u4f20\u7edf\u7684 Pod \u4e2d\u5b9a\u4e49\u7684 ContanerPort\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u7684\u8d44\u6e90\u6e05\u5355\u4e2d\u4e0d\u4ec5\u8981\u63cf\u8ff0\u5bb9\u5668\u7684 Port\uff0c\u8fd8\u8981\u63cf\u8ff0 Service \u7684 Port\u3002</p> <p>\u7136\u540e\u4e00\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u7ed3\u6784\u4f53 <code>AppServiceStatus</code> \u7528\u6765\u63cf\u8ff0\u8d44\u6e90\u7684\u72b6\u6001\uff0c\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u9700\u8981\u53bb\u81ea\u5b9a\u4e49\u72b6\u6001\u7684\u63cf\u8ff0\uff0c\u6211\u8fd9\u91cc\u5c31\u5077\u61d2\u76f4\u63a5\u4f7f\u7528 Deployment \u7684\u72b6\u6001\u4e86\uff1a</p> <pre><code>type AppServiceStatus struct {\n    // INSERT ADDITIONAL STATUS FIELD - define observed state of cluster\n    // Important: Run \"operator-sdk generate k8s\" to regenerate code after modifying this file\n    // Add custom validation using kubebuilder tags: https://book.kubebuilder.io/beyond_basics/generating_crd.html\n    appsvDeploymentStatus `json:\",inline\"`\n}\n</code></pre> <p>\u5b9a\u4e49\u5b8c\u6210\u540e\uff0c\u5728\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u9762\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ operator-sdk generate k8s\nINFO[0000] Running deepcopy code-generation for Custom Resource group versions: [app:[v1], ] \nINFO[0011] Code-generation complete.\n</code></pre> <p>\u8be5\u547d\u4ee4\u662f\u7528\u6765\u6839\u636e\u6211\u4eec\u81ea\u5b9a\u4e49\u7684 API \u63cf\u8ff0\u6765\u81ea\u52a8\u751f\u6210\u4e00\u4e9b\u4ee3\u7801\uff0c\u76ee\u5f55 <code>pkg/apis/app/v1/</code> \u4e0b\u9762\u4ee5 <code>zz_generated</code> \u5f00\u5934\u7684\u6587\u4ef6\u5c31\u662f\u81ea\u52a8\u751f\u6210\u7684\u4ee3\u7801\uff0c\u91cc\u9762\u7684\u5185\u5bb9\u5e76\u4e0d\u9700\u8981\u6211\u4eec\u53bb\u624b\u52a8\u7f16\u5199\u3002</p> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u7b97\u5b8c\u6210\u4e86\u5bf9\u81ea\u5b9a\u4e49\u8d44\u6e90\u5bf9\u8c61\u7684 API \u7684\u58f0\u660e\u3002</p>"},{"location":"kubernetes_operator/operator/#_6","title":"\u5b9e\u73b0\u4e1a\u52a1\u903b\u8f91","text":"<p>\u4e0a\u9762 API \u63cf\u8ff0\u58f0\u660e\u5b8c\u6210\u4e86\uff0c\u63a5\u4e0b\u6765\u5c31\u9700\u8981\u6211\u4eec\u6765\u8fdb\u884c\u5177\u4f53\u7684\u4e1a\u52a1\u903b\u8f91\u5b9e\u73b0\u4e86\uff0c\u7f16\u5199\u5177\u4f53\u7684 controller \u5b9e\u73b0\uff0c\u6253\u5f00\u6e90\u6587\u4ef6</p> <pre><code>pkg/controller/appservice/appservice_controller.go\n</code></pre> <p>\uff0c\u9700\u8981\u6211\u4eec\u53bb\u66f4\u6539\u7684\u5730\u65b9\u4e5f\u4e0d\u662f\u5f88\u591a\uff0c\u6838\u5fc3\u7684\u5c31\u662f<code>Reconcile</code> \u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u5c31\u662f\u53bb\u4e0d\u65ad\u7684 watch \u8d44\u6e90\u7684\u72b6\u6001\uff0c\u7136\u540e\u6839\u636e\u72b6\u6001\u7684\u4e0d\u540c\u53bb\u5b9e\u73b0\u5404\u79cd\u64cd\u4f5c\u903b\u8f91\uff0c\u6838\u5fc3\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>func (r *ReconcileAppService) Reconcile(request reconcile.Request) (reconcile.Result, error) {\n    reqLogger := log.WithValues(\"Request.Namespace\", request.Namespace, \"Request.Name\", request.Name)\n    reqLogger.Info(\"Reconciling AppService\")\n\n    // Fetch the AppService instance\n    instance := &amp;appvAppService{}\n    err := r.client.Get(context.TODO(), request.NamespacedName, instance)\n    if err != nil {\n        if errors.IsNotFound(err) {\n            // Request object not found, could have been deleted after reconcile request.\n            // Owned objects are automatically garbage collected. For additional cleanup logic use finalizers.\n            // Return and don't requeue\n            return reconcile.Result{}, nil\n        }\n        // Error reading the object - requeue the request.\n        return reconcile.Result{}, err\n    }\n\n    if instance.DeletionTimestamp != nil {\n        return reconcile.Result{}, err\n    }\n\n    // \u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u521b\u5efa\u5173\u8054\u8d44\u6e90\n    // \u5982\u679c\u5b58\u5728\uff0c\u5224\u65ad\u662f\u5426\u9700\u8981\u66f4\u65b0\n    //   \u5982\u679c\u9700\u8981\u66f4\u65b0\uff0c\u5219\u76f4\u63a5\u66f4\u65b0\n    //   \u5982\u679c\u4e0d\u9700\u8981\u66f4\u65b0\uff0c\u5219\u6b63\u5e38\u8fd4\u56de\n\n    deploy := &amp;appsvDeployment{}\n    if err := r.client.Get(context.TODO(), request.NamespacedName, deploy); err != nil &amp;&amp; errors.IsNotFound(err) {\n        // \u521b\u5efa\u5173\u8054\u8d44\u6e90\n        //  \u521b\u5efa Deploy\n        deploy := resources.NewDeploy(instance)\n        if err := r.client.Create(context.TODO(), deploy); err != nil {\n            return reconcile.Result{}, err\n        }\n        //  \u521b\u5efa Service\n        service := resources.NewService(instance)\n        if err := r.client.Create(context.TODO(), service); err != nil {\n            return reconcile.Result{}, err\n        }\n        //  \u5173\u8054 Annotations\n        data, _ := json.Marshal(instance.Spec)\n        if instance.Annotations != nil {\n            instance.Annotations[\"spec\"] = string(data)\n        } else {\n            instance.Annotations = map[string]string{\"spec\": string(data)}\n        }\n\n        if err := r.client.Update(context.TODO(), instance); err != nil {\n            return reconcile.Result{}, nil\n        }\n        return reconcile.Result{}, nil\n    }\n\n    oldspec := appvAppServiceSpec{}\n    if err := json.Unmarshal([]byte(instance.Annotations[\"spec\"]), oldspec); err != nil {\n        return reconcile.Result{}, err\n    }\n\n    if !reflect.DeepEqual(instance.Spec, oldspec) {\n        // \u66f4\u65b0\u5173\u8054\u8d44\u6e90\n        newDeploy := resources.NewDeploy(instance)\n        oldDeploy := &amp;appsvDeployment{}\n        if err := r.client.Get(context.TODO(), request.NamespacedName, oldDeploy); err != nil {\n            return reconcile.Result{}, err\n        }\n        oldDeploy.Spec = newDeploy.Spec\n        if err := r.client.Update(context.TODO(), oldDeploy); err != nil {\n            return reconcile.Result{}, err\n        }\n\n        newService := resources.NewService(instance)\n        oldService := &amp;corevService{}\n        if err := r.client.Get(context.TODO(), request.NamespacedName, oldService); err != nil {\n            return reconcile.Result{}, err\n        }\n        oldService.Spec = newService.Spec\n        if err := r.client.Update(context.TODO(), oldService); err != nil {\n            return reconcile.Result{}, err\n        }\n\n        return reconcile.Result{}, nil\n    }\n\n    return reconcile.Result{}, nil\n\n}\n</code></pre> <p>\u4e0a\u9762\u5c31\u662f\u4e1a\u52a1\u903b\u8f91\u5b9e\u73b0\u7684\u6838\u5fc3\u4ee3\u7801\uff0c\u903b\u8f91\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u53bb\u5224\u65ad\u8d44\u6e90\u662f\u5426\u5b58\u5728\uff0c\u4e0d\u5b58\u5728\uff0c\u5219\u76f4\u63a5\u521b\u5efa\u65b0\u7684\u8d44\u6e90\uff0c\u521b\u5efa\u65b0\u7684\u8d44\u6e90\u9664\u4e86\u9700\u8981\u521b\u5efa Deployment \u8d44\u6e90\u5916\uff0c\u8fd8\u9700\u8981\u521b\u5efa Service \u8d44\u6e90\u5bf9\u8c61\uff0c\u56e0\u4e3a\u8fd9\u5c31\u662f\u6211\u4eec\u7684\u9700\u6c42\uff0c\u5f53\u7136\u4f60\u8fd8\u53ef\u4ee5\u81ea\u5df1\u53bb\u6269\u5c55\uff0c\u6bd4\u5982\u5728\u521b\u5efa\u4e00\u4e2a Ingress \u5bf9\u8c61\u3002\u66f4\u65b0\u4e5f\u662f\u4e00\u6837\u7684\uff0c\u53bb\u5bf9\u6bd4\u65b0\u65e7\u5bf9\u8c61\u7684\u58f0\u660e\u662f\u5426\u4e00\u81f4\uff0c\u4e0d\u4e00\u81f4\u5219\u9700\u8981\u66f4\u65b0\uff0c\u540c\u6837\u7684\uff0c\u4e24\u79cd\u8d44\u6e90\u90fd\u9700\u8981\u66f4\u65b0\u7684\u3002</p> <p>\u53e6\u5916\u4e24\u4e2a\u6838\u5fc3\u7684\u65b9\u6cd5\u5c31\u662f\u4e0a\u9762\u7684 </p> <pre><code>resources.NewDeploy(instance)\n</code></pre> <p>\u548c </p> <pre><code>resources.NewService(instance)\n</code></pre> <p>\u65b9\u6cd5\uff0c\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u5b9e\u73b0\u903b\u8f91\u4e5f\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u6839\u636e CRD \u4e2d\u7684\u58f0\u660e\u53bb\u586b\u5145 Deployment \u548c Service \u8d44\u6e90\u5bf9\u8c61\u7684 Spec \u5bf9\u8c61\u5373\u53ef\u3002</p> <p>NewDeploy \u65b9\u6cd5\u5b9e\u73b0\u5982\u4e0b\uff1a</p> <pre><code>func NewDeploy(app *appvAppService) *appsvDeployment {\n    labels := map[string]string{\"app\": app.Name}\n    selector := &amp;metavLabelSelector{MatchLabels: labels}\n    return &amp;appsvDeployment{\n        TypeMeta: metavTypeMeta{\n            APIVersion: \"apps/v1\",\n            Kind:       \"Deployment\",\n        },\n        ObjectMeta: metavObjectMeta{\n            Name:      app.Name,\n            Namespace: app.Namespace,\n\n            OwnerReferences: []metavOwnerReference{\n                *metavNewControllerRef(app, schema.GroupVersionKind{\n                    Group: vSchemeGroupVersion.Group,\n                    Version: vSchemeGroupVersion.Version,\n                    Kind: \"AppService\",\n                }),\n            },\n        },\n        Spec: appsvDeploymentSpec{\n            Replicas: app.Spec.Size,\n            Template: corevPodTemplateSpec{\n                ObjectMeta: metavObjectMeta{\n                    Labels: labels,\n                },\n                Spec: corevPodSpec{\n                    Containers: newContainers(app),\n                },\n            },\n            Selector: selector,\n        },\n    }\n}\n\nfunc newContainers(app *vAppService) []corevContainer {\n    containerPorts := []corevContainerPort{}\n    for _, svcPort := range app.Spec.Ports {\n        cport := corevContainerPort{}\n        cport.ContainerPort = svcPort.TargetPort.IntVal\n        containerPorts = append(containerPorts, cport)\n    }\n    return []corevContainer{\n        {\n            Name: app.Name,\n            Image: app.Spec.Image,\n            Resources: app.Spec.Resources,\n            Ports: containerPorts,\n            ImagePullPolicy: corevPullIfNotPresent,\n            Env: app.Spec.Envs,\n        },\n    }\n}\n</code></pre> <p>newService \u5bf9\u5e94\u7684\u65b9\u6cd5\u5b9e\u73b0\u5982\u4e0b\uff1a</p> <pre><code>func NewService(app *vAppService) *corevService {\n    return &amp;corevService {\n        TypeMeta: metavTypeMeta {\n            Kind: \"Service\",\n            APIVersion: \"v1\",\n        },\n        ObjectMeta: metavObjectMeta{\n            Name: app.Name,\n            Namespace: app.Namespace,\n            OwnerReferences: []metavOwnerReference{\n                *metavNewControllerRef(app, schema.GroupVersionKind{\n                    Group: vSchemeGroupVersion.Group,\n                    Version: vSchemeGroupVersion.Version,\n                    Kind: \"AppService\",\n                }),\n            },\n        },\n        Spec: corevServiceSpec{\n            Type: corevServiceTypeNodePort,\n            Ports: app.Spec.Ports,\n            Selector: map[string]string{\n                \"app\": app.Name,\n            },\n        },\n    }\n}\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u5b9e\u73b0\u4e86 AppService \u8fd9\u79cd\u8d44\u6e90\u5bf9\u8c61\u7684\u4e1a\u52a1\u903b\u8f91\u3002</p>"},{"location":"kubernetes_operator/operator/#_7","title":"\u8c03\u8bd5","text":"<p>\u5982\u679c\u6211\u4eec\u672c\u5730\u6709\u4e00\u4e2a\u53ef\u4ee5\u8bbf\u95ee\u7684 Kubernetes \u96c6\u7fa4\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u76f4\u63a5\u8fdb\u884c\u8c03\u8bd5\uff0c\u5728\u672c\u5730\u7528\u6237 <code>~/.kube/config</code> \u6587\u4ef6\u4e2d\u914d\u7f6e\u96c6\u7fa4\u8bbf\u95ee\u4fe1\u606f\uff0c\u4e0b\u9762\u7684\u4fe1\u606f\u8868\u660e\u53ef\u4ee5\u8bbf\u95ee Kubernetes \u96c6\u7fa4\uff1a</p> <pre><code>$ kubectl cluster-info\nKubernetes master is running at https://ydzs-master:6443\nKubeDNS is running at https://ydzs-master:6443/api/v1/namespaces/kube-system/services/kube-dns/proxy\n\nTo further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.\n</code></pre> <p>\u9996\u5148\uff0c\u5728\u96c6\u7fa4\u4e2d\u5b89\u88c5 CRD \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f deploy/crds/app.example.com_appservices_crd.yaml \ncustomresourcedefinition.apiextensions.k8s.io/appservices.app.example.com created\n$ kubectl get crd |grep appservice\nappservices.app.example.com                      2019-12-19T04:31:12Z\n</code></pre> <p>\u5f53\u6211\u4eec\u901a\u8fc7 <code>kubectl get crd</code> \u547d\u4ee4\u83b7\u53d6\u5230\u6211\u4eec\u5b9a\u4e49\u7684 CRD \u8d44\u6e90\u5bf9\u8c61\uff0c\u5c31\u8bc1\u660e\u6211\u4eec\u5b9a\u4e49\u7684 CRD \u5b89\u88c5\u6210\u529f\u4e86\u3002\u5176\u5b9e\u73b0\u5728\u53ea\u662f CRD \u7684\u8fd9\u4e2a\u58f0\u660e\u5b89\u88c5\u6210\u529f\u4e86\uff0c\u4f46\u662f\u6211\u4eec\u8fd9\u4e2a CRD \u7684\u5177\u4f53\u4e1a\u52a1\u903b\u8f91\u5b9e\u73b0\u65b9\u5f0f\u8fd8\u5728\u6211\u4eec\u672c\u5730\uff0c\u5e76\u6ca1\u6709\u90e8\u7f72\u5230\u96c6\u7fa4\u4e4b\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u5728\u672c\u5730\u9879\u76ee\u4e2d\u542f\u52a8 Operator \u7684\u8c03\u8bd5\uff1a</p> <pre><code>$ operator-sdk up local                                                     \noperator-sdk up local \nINFO[0000] Running the operator locally.                \nINFO[0000] Using namespace default.                     \n{\"level\":\"info\",\"ts\":15767300743257,\"logger\":\"cmd\",\"msg\":\"Operator Version: 1\"}\n{\"level\":\"info\",\"ts\":15767300743318,\"logger\":\"cmd\",\"msg\":\"Go Version: go3\"}\n{\"level\":\"info\",\"ts\":15767300743336,\"logger\":\"cmd\",\"msg\":\"Go OS/Arch: darwin/amd64\"}\n{\"level\":\"info\",\"ts\":157673007433379,\"logger\":\"cmd\",\"msg\":\"Version of operator-sdk: v0\"}\n{\"level\":\"info\",\"ts\":15767300744948,\"logger\":\"leader\",\"msg\":\"Trying to become the leader.\"}\n{\"level\":\"info\",\"ts\":15767300744969,\"logger\":\"leader\",\"msg\":\"Skipping leader election; not running in a cluster.\"}\n......\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u5728\u672c\u5730\u8fd0\u884c Operator \u5e94\u7528\uff0c\u901a\u8fc7 <code>~/.kube/config</code> \u53bb\u5173\u8054\u96c6\u7fa4\u4fe1\u606f\uff0c\u73b0\u5728\u6211\u4eec\u53bb\u6dfb\u52a0\u4e00\u4e2a AppService \u7c7b\u578b\u7684\u8d44\u6e90\u7136\u540e\u89c2\u5bdf\u672c\u5730 Operator \u7684\u53d8\u5316\u60c5\u51b5\uff0c\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5c31\u662f\u6211\u4eec\u4e0a\u9762\u9884\u5b9a\u4e49\u7684\uff08deploy/crds/app.example.com_v1_appservice_cr.yaml\uff09:</p> <pre><code>apiVersion: app.example.com/v1\nkind: AppService\nmetadata:\n  name: nginx-app\nspec:\n  size: 2\n  image: nginx:9\n  ports:\n    - port: 80\n      targetPort: 80\n      nodePort: 30002\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f deploy/crds/app.example.com_v1_appservice_cr.yaml \nappservice.app.example.com/nginx-app created\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u7684\u5e94\u7528\u521b\u5efa\u6210\u529f\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u67e5\u770b Operator \u7684\u8c03\u8bd5\u7a97\u53e3\u4f1a\u6709\u5982\u4e0b\u7684\u4fe1\u606f\u51fa\u73b0\uff1a</p> <pre><code>......\n{\"level\":\"info\",\"ts\":15592074670523,\"logger\":\"controller_appservice\",\"msg\":\"Reconciling AppService\",\"Request.Namespace\":\"default\",\"Request.Name\":\"nginx-app\"}\n{\"level\":\"info\",\"ts\":15592074004226,\"logger\":\"controller_appservice\",\"msg\":\"Reconciling AppService\",\"Request.Namespace\":\"default\",\"Request.Name\":\"nginx-app\"}\n{\"level\":\"info\",\"ts\":15592074004331,\"logger\":\"controller_appservice\",\"msg\":\"Reconciling AppService\",\"Request.Namespace\":\"default\",\"Request.Name\":\"nginx-app\"}\n{\"level\":\"info\",\"ts\":1559207433779,\"logger\":\"controller_appservice\",\"msg\":\"Reconciling AppService\",\"Request.Namespace\":\"default\",\"Request.Name\":\"nginx-app\"}\n{\"level\":\"info\",\"ts\":15592074951193,\"logger\":\"controller_appservice\",\"msg\":\"Reconciling AppService\",\"Request.Namespace\":\"default\",\"Request.Name\":\"nginx-app\"}\n......\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u53bb\u67e5\u770b\u96c6\u7fa4\u4e2d\u662f\u5426\u6709\u7b26\u5408\u6211\u4eec\u9884\u671f\u7684\u8d44\u6e90\u51fa\u73b0\uff1a</p> <pre><code>$ kubectl get AppService\nNAME        AGE\nnginx-app   2m8s\n$ kubectl get deploy\nNAME                     READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-app                2/2     2            2           2m20s\n$ kubectl get svc   \nNAME             TYPE           CLUSTER-IP       EXTERNAL-IP             PORT(S)          AGE\nnginx-app        NodePort       110     &lt;none&gt;                  80:30002/TCP     2m23s\n</code></pre> <p>\u770b\u5230\u4e86\u5427\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e24\u4e2a\u526f\u672c\uff08size=2\uff09\uff0c\u8fd9\u91cc\u5c31\u51fa\u73b0\u4e86\u4e24\u4e2a Pod\uff0c\u8fd8\u6709\u4e00\u4e2a NodePort=30002 \u7684 Service \u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8be5\u7aef\u53e3\u53bb\u8bbf\u95ee\u4e0b\u5e94\u7528\uff1a</p> <p></p> <p>\u5982\u679c\u5e94\u7528\u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u4e86\u4efb\u4f55\u95ee\u9898\uff0c\u6211\u4eec\u90fd\u53ef\u4ee5\u901a\u8fc7\u672c\u5730\u7684 Operator \u8c03\u8bd5\u7a97\u53e3\u627e\u5230\u6709\u7528\u7684\u4fe1\u606f\uff0c\u7136\u540e\u8c03\u8bd5\u4fee\u6539\u5373\u53ef\u3002</p> <p>\u6e05\u7406\uff1a</p> <pre><code>$ kubectl delete -f deploy/crds/app.example.com_v1_appservice_cr.yaml\n$ kubectl delete -f deploy/crds/app.example.com_appservices_crd.yaml\n</code></pre>"},{"location":"kubernetes_operator/operator/#_8","title":"\u90e8\u7f72","text":"<p>\u81ea\u5b9a\u4e49\u7684\u8d44\u6e90\u5bf9\u8c61\u73b0\u5728\u6d4b\u8bd5\u901a\u8fc7\u4e86\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u5c06\u672c\u5730\u7684 </p> <pre><code>operator-sdk up local\n</code></pre> <p>\u547d\u4ee4\u7ec8\u6b62\u6389\uff0c\u6211\u4eec\u53ef\u4ee5\u731c\u60f3\u5230\u5c31\u6ca1\u529e\u6cd5\u5904\u7406 AppService \u8d44\u6e90\u5bf9\u8c61\u7684\u4e00\u4e9b\u64cd\u4f5c\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5c06\u6211\u4eec\u7684\u4e1a\u52a1\u903b\u8f91\u5b9e\u73b0\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\u53bb\u3002</p> <p>\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u6784\u5efa Operator \u5e94\u7528\u6253\u5305\u6210 Docker \u955c\u50cf\uff1a</p> <pre><code>$ operator-sdk build cnych/opdemo:1\n......\nSuccessfully built 29cd605c4ad2\nSuccessfully tagged cnych/opdemo:1\nINFO[0041] Operator build complete.\n</code></pre> <p>\u955c\u50cf\u6784\u5efa\u6210\u529f\u540e\uff0c\u63a8\u9001\u5230 docker hub\uff1a</p> <pre><code>$ docker push cnych/opdemo:1\n</code></pre> <p>\u955c\u50cf\u63a8\u9001\u6210\u529f\u540e\uff0c\u4f7f\u7528\u4e0a\u9762\u7684\u955c\u50cf\u5730\u5740\u66f4\u65b0 Operator \u7684\u8d44\u6e90\u6e05\u5355\uff1a</p> <pre><code>$ sed -i 's|REPLACE_IMAGE|cnych/opdemo:1|g' deploy/operator.yaml\n# \u5982\u679c\u4f60\u4f7f\u7528\u7684\u662f Mac \u7cfb\u7edf\uff0c\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\n$ sed -i \"\" 's|REPLACE_IMAGE|cnych/opdemo:1|g' deploy/operator.yaml\n</code></pre> <p>\u73b0\u5728 Operator \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u51c6\u5907\u597d\u4e86\uff0c\u7136\u540e\u521b\u5efa\u5bf9\u5e94\u7684 RBAC \u7684\u5bf9\u8c61\uff1a</p> <pre><code># Setup Service Account\n$ kubectl apply -f deploy/service_account.yaml\n# Setup RBAC\n$ kubectl apply -f deploy/role.yaml\n$ kubectl apply -f deploy/role_binding.yaml\n</code></pre> <p>\u6743\u9650\u76f8\u5173\u58f0\u660e\u5df2\u7ecf\u5b8c\u6210\uff0c\u63a5\u4e0b\u6765\u5b89\u88c5 CRD \u548c Operator\uff1a</p> <pre><code>$ kubectl apply -f deploy/crds/app.example.com_appservices_crd.yaml\n$ kubectl get crd |grep appservices\nappservices.app.example.com                      2019-12-19T05:25:55Z\n......\n# Deploy the Operator\n$ kubectl apply -f deploy/operator.yaml\ndeployment.apps/opdemo created\n$ kubectl get pods\nNAME                                      READY   STATUS              RESTARTS   AGE\nopdemo-7565595bbc-p7f5c                   1/1     Running             0          5s\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u7684 CRD \u548c Operator \u5b9e\u73b0\u90fd\u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u518d\u6765\u90e8\u7f72\u6211\u4eec\u7684 AppService \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u73b0\u5728\u7684\u4e1a\u52a1\u903b\u8f91\u5c31\u4f1a\u5728\u4e0a\u9762\u7684 </p> <pre><code>opdemo-7565595bbc-p7f5c\n</code></pre> <p>\u7684 Pod \u4e2d\u53bb\u5904\u7406\u4e86\u3002</p> <pre><code>$ kubectl apply -f deploy/crds/app.example.com_v1_appservice_cr.yaml\nappservice.app.example.com/nginx-app created\n$ kubectl get appservice\nNAME        AGE\nnginx-app   18s\n$  kubectl get deploy\nNAME                     READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-app                2/2     2            2           22s\nopdemo                   1/1     1            1           5m51s\n$  kubectl get svc\nNAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE\nkubernetes   ClusterIP   1       &lt;none&gt;        443/TCP        76d\nnginx-app    NodePort    1182   &lt;none&gt;        80:30002/TCP   29s\nopdemo       ClusterIP   1251   &lt;none&gt;        8383/TCP       4m25s\n$  kubectl get pods\nNAME                                      READY   STATUS    RESTARTS   AGE\nnginx-app-76b6449498-ffhgx                1/1     Running   0          32s\nnginx-app-76b6449498-wzjq2                1/1     Running   0          32s\nopdemo-7565595bbc-p7f5c                   1/1     Running   0          5m59s\n$ kubectl describe appservice nginx-app\nName:         nginx-app\nNamespace:    default\nLabels:       &lt;none&gt;\nAnnotations:  kubectl.kubernetes.io/last-applied-configuration:\n                {\"apiVersion\":\"app.example.com/v1\",\"kind\":\"AppService\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-app\",\"namespace\":\"default\"},\"spec\":{\"ima...\n              spec: {\"size\":2,\"image\":\"nginx:9\",\"resources\":{},\"ports\":[{\"protocol\":\"TCP\",\"port\":80,\"targetPort\":80,\"nodePort\":30002}]}\nAPI Version:  app.example.com/v1\nKind:         AppService\nMetadata:\n  Creation Timestamp:  2019-12-19T05:30:26Z\n  Generation:          2\n  Resource Version:    12364119\n  Self Link:           /apis/app.example.com/v1/namespaces/default/appservices/nginx-app\n  UID:                 1bb6d5fa-9f94-4eaf-ad55-643568690bab\nSpec:\n  Image:  nginx:9\n  Ports:\n    Node Port:    30002\n    Port:         80\n    Protocol:     TCP\n    Target Port:  80\n  Resources:\n  Size:  2\nEvents:  &lt;none&gt;\n</code></pre> <p>\u7136\u540e\u540c\u6837\u7684\u53ef\u4ee5\u901a\u8fc7 30002 \u8fd9\u4e2a NodePort \u7aef\u53e3\u53bb\u8bbf\u95ee\u5e94\u7528\uff0c\u5230\u8fd9\u91cc\u5e94\u7528\u5c31\u90e8\u7f72\u6210\u529f\u4e86\u3002</p> <p>\u5982\u679c\u9700\u8981\u6e05\u7406\uff0c\u5219\u76f4\u63a5\u5220\u9664\u5373\u53ef\uff1a</p> <pre><code>$ kubectl delete -f deploy/crds/app.example.com_v1_appservice_cr.yaml\n$ kubectl delete -f deploy/operator.yaml\n$ kubectl delete -f deploy/role.yaml\n$ kubectl delete -f deploy/role_binding.yaml\n$ kubectl delete -f deploy/service_account.yaml\n$ kubectl delete -f deploy/crds/app.example.com_appservices_crd.yaml\n</code></pre>"},{"location":"kubernetes_package/chart_hooks/","title":"Chart Hooks","text":""},{"location":"kubernetes_package/chart_hooks/#chart_hooks","title":"Chart Hooks","text":"<p>Helm \u4e5f\u63d0\u4f9b\u4e86\u4e00\u79cd Hook \u673a\u5236\uff0c\u53ef\u4ee5\u5141\u8bb8 chart \u5f00\u53d1\u4eba\u5458\u5728 release \u751f\u547d\u5468\u671f\u7684\u67d0\u4e9b\u65f6\u95f4\u70b9\u8fdb\u884c\u5e72\u9884\u3002\u6bd4\u5982\uff0c\u53ef\u4ee5\u4f7f\u7528 hook \u6765\u8fdb\u884c\u4e0b\u9762\u7684\u64cd\u4f5c\uff1a</p> <ul> <li>\u5728\u52a0\u8f7d\u4efb\u4f55 charts \u4e4b\u524d\uff0c\u5728\u5b89\u88c5\u7684\u65f6\u5019\u52a0\u8f7d ConfigMap \u6216\u8005 Secret</li> <li>\u5728\u5b89\u88c5\u65b0\u7684 chart \u4e4b\u524d\uff0c\u6267\u884c\u4e00\u4e2a Job \u6765\u5907\u4efd\u6570\u636e\u5e93\uff0c\u7136\u540e\u5728\u5347\u7ea7\u540e\u6267\u884c\u7b2c\u4e8c\u4e2a Job \u8fd8\u539f\u6570\u636e</li> <li>\u5728\u5220\u9664 release \u4e4b\u524d\u8fd0\u884c\u4e00\u4e2a JOb\uff0c\u4ee5\u5728\u5220\u9664 release \u4e4b\u524d\u9002\u5f53\u5730\u53d6\u6d88\u76f8\u5173\u670d\u52a1</li> </ul> <p>Hooks \u7684\u5de5\u4f5c\u65b9\u5f0f\u7c7b\u4f3c\u4e8e\u666e\u901a\u7684\u6a21\u677f\uff0c\u4f46\u662f\u4ed6\u4eec\u5177\u6709\u7279\u6b8a\u7684\u6ce8\u89e3\uff0c\u8fd9\u4e9b\u6ce8\u89e3\u4f7f Helm \u53ef\u4ee5\u7528\u4e0d\u540c\u7684\u65b9\u5f0f\u6765\u4f7f\u7528\u4ed6\u4eec\u3002</p>"},{"location":"kubernetes_package/chart_hooks/#hooks","title":"Hooks","text":"<p>\u5728 Helm \u4e2d\u5b9a\u4e49\u4e86\u5982\u4e0b\u4e00\u4e9b\u53ef\u4f9b\u6211\u4eec\u4f7f\u7528\u7684 Hooks\uff1a</p> <ul> <li>\u9884\u5b89\u88c5<code>pre-install</code>\uff1a\u5728\u6a21\u677f\u6e32\u67d3\u540e\uff0ckubernetes \u521b\u5efa\u4efb\u4f55\u8d44\u6e90\u4e4b\u524d\u6267\u884c</li> <li>\u5b89\u88c5\u540e<code>post-install</code>\uff1a\u5728\u6240\u6709 kubernetes \u8d44\u6e90\u5b89\u88c5\u5230\u96c6\u7fa4\u540e\u6267\u884c</li> <li>\u9884\u5220\u9664<code>pre-delete</code>\uff1a\u5728\u4ece kubernetes \u5220\u9664\u4efb\u4f55\u8d44\u6e90\u4e4b\u524d\u6267\u884c\u5220\u9664\u8bf7\u6c42</li> <li>\u5220\u9664\u540e<code>post-delete</code>\uff1a\u5220\u9664\u6240\u6709 release \u7684\u8d44\u6e90\u540e\u6267\u884c</li> <li>\u5347\u7ea7\u524d<code>pre-upgrade</code>\uff1a\u5728\u6a21\u677f\u6e32\u67d3\u540e\uff0c\u4f46\u5728\u4efb\u4f55\u8d44\u6e90\u5347\u7ea7\u4e4b\u524d\u6267\u884c</li> <li>\u5347\u7ea7\u540e<code>post-upgrade</code>\uff1a\u5728\u6240\u6709\u8d44\u6e90\u5347\u7ea7\u540e\u6267\u884c</li> <li>\u9884\u56de\u6eda<code>pre-rollback</code>\uff1a\u5728\u6a21\u677f\u6e32\u67d3\u540e\uff0c\u5728\u4efb\u4f55\u8d44\u6e90\u56de\u6eda\u4e4b\u524d\u6267\u884c</li> <li>\u56de\u6eda\u540e<code>post-rollback</code>\uff1a\u5728\u4fee\u6539\u6240\u6709\u8d44\u6e90\u540e\u6267\u884c\u56de\u6eda\u8bf7\u6c42</li> <li>\u6d4b\u8bd5<code>test</code>\uff1a\u5728\u8c03\u7528 Helm <code>test</code> \u5b50\u547d\u4ee4\u7684\u65f6\u5019\u6267\u884c\uff08\u53ef\u4ee5\u67e5\u770b\u6d4b\u8bd5\u6587\u6863\uff09</li> </ul>"},{"location":"kubernetes_package/chart_hooks/#_1","title":"\u751f\u547d\u5468\u671f","text":"<p>Hooks \u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u5728 release \u7684\u751f\u547d\u5468\u671f\u4e2d\u7684\u4e00\u4e9b\u5173\u952e\u8282\u70b9\u6267\u884c\u4e00\u4e9b\u94a9\u5b50\u51fd\u6570\uff0c\u6211\u4eec\u6b63\u5e38\u5b89\u88c5\u4e00\u4e2a chart \u5305\u7684\u65f6\u5019\u7684\u751f\u547d\u5468\u671f\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li> <ol> <li>\u7528\u6237\u8fd0\u884c <code>helm install foo</code></li> </ol> </li> <li> <ol> <li>Helm \u5e93\u6587\u4ef6\u8c03\u7528\u5b89\u88c5 API</li> </ol> </li> <li> <ol> <li>\u7ecf\u8fc7\u4e00\u4e9b\u9a8c\u8bc1\uff0cHelm \u5e93\u6e32\u67d3 <code>foo</code> \u6a21\u677f</li> </ol> </li> <li> <ol> <li>Helm \u5e93\u5c06\u4ea7\u751f\u7684\u8d44\u6e90\u52a0\u8f7d\u5230 kubernetes \u4e2d\u53bb</li> </ol> </li> <li> <ol> <li>Helm \u5e93\u5c06 release \u5bf9\u8c61\u548c\u5176\u4ed6\u6570\u636e\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef</li> </ol> </li> <li> <ol> <li>Helm \u5ba2\u6237\u7aef\u9000\u51fa</li> </ol> </li> </ul> <p>\u5982\u679c\u5f00\u53d1\u4eba\u5458\u5728 <code>install</code> \u7684\u751f\u547d\u5468\u671f\u4e2d\u5b9a\u4e49\u4e86\u4e24\u4e2a hook\uff1a<code>pre-install</code>\u548c<code>post-install</code>\uff0c\u90a3\u4e48\u6211\u4eec\u5b89\u88c5\u4e00\u4e2a chart \u5305\u7684\u751f\u547d\u5468\u671f\u5c31\u4f1a\u591a\u4e00\u4e9b\u6b65\u9aa4\u4e86\uff1a</p> <ul> <li> <ol> <li>\u7528\u6237\u8fd0\u884c<code>helm install foo</code></li> </ol> </li> <li> <ol> <li>Helm \u5e93\u6587\u4ef6\u8c03\u7528\u5b89\u88c5 API</li> </ol> </li> <li> <ol> <li>\u5728 <code>crds/</code> \u76ee\u5f55\u4e0b\u9762\u7684 CRDs \u88ab\u5b89\u88c5</li> </ol> </li> <li> <ol> <li>\u7ecf\u8fc7\u4e00\u4e9b\u9a8c\u8bc1\uff0cHelm \u5e93\u6e32\u67d3 <code>foo</code> \u6a21\u677f</li> </ol> </li> <li> <ol> <li>Helm \u5e93\u5c06 hook \u8d44\u6e90\u52a0\u8f7d\u5230 kubernetes \u4e2d\uff0c\u51c6\u5907\u6267\u884c<code>pre-install</code> hooks</li> </ol> </li> <li> <ol> <li>Helm \u5e93\u4f1a\u6839\u636e\u6743\u91cd\u5bf9 hooks \u8fdb\u884c\u6392\u5e8f\uff08\u9ed8\u8ba4\u5206\u914d\u6743\u91cd0\uff0c\u6743\u91cd\u76f8\u540c\u7684 hook \u6309\u5347\u5e8f\u6392\u5e8f\uff09</li> </ol> </li> <li> <ol> <li>Helm \u5e93\u7136\u540e\u52a0\u8f7d\u6700\u4f4e\u6743\u91cd\u7684 hook</li> </ol> </li> <li> <ol> <li>Helm \u5e93\u4f1a\u7b49\u5f85\uff0c\u76f4\u5230 hook \u51c6\u5907\u5c31\u7eea</li> </ol> </li> <li> <ol> <li>Helm \u5e93\u5c06\u4ea7\u751f\u7684\u8d44\u6e90\u52a0\u8f7d\u5230 kubernetes \u4e2d\uff0c\u6ce8\u610f\u5982\u679c\u6dfb\u52a0\u4e86 <code>--wait</code> \u53c2\u6570\uff0cHelm \u5e93\u4f1a\u7b49\u5f85\u6240\u6709\u8d44\u6e90\u90fd\u51c6\u5907\u597d\uff0c\u5728\u8fd9\u4e4b\u524d\u4e0d\u4f1a\u8fd0\u884c <code>post-install</code> hook</li> </ol> </li> <li> <ol> <li>Helm \u5e93\u6267\u884c <code>post-install</code> hook\uff08\u52a0\u8f7d hook \u8d44\u6e90\uff09</li> </ol> </li> <li> <ol> <li>Helm \u5e93\u7b49\u5f85\uff0c\u76f4\u5230 hook \u51c6\u5907\u5c31\u7eea</li> </ol> </li> <li> <ol> <li>Helm \u5e93\u5c06 release \u5bf9\u8c61\u548c\u5176\u4ed6\u6570\u636e\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef</li> </ol> </li> <li> <ol> <li>Helm \u5ba2\u6237\u7aef\u9000\u51fa</li> </ol> </li> </ul> <p>\u7b49\u5f85 hook \u51c6\u5907\u5c31\u7eea\uff0c\u8fd9\u662f\u4e00\u4e2a\u963b\u585e\u7684\u64cd\u4f5c\uff0c\u5982\u679c hook \u4e2d\u58f0\u660e\u7684\u662f\u4e00\u4e2a Job \u8d44\u6e90\uff0cHelm \u5c06\u7b49\u5f85 Job \u6210\u529f\u5b8c\u6210\uff0c\u5982\u679c\u5931\u8d25\uff0c\u5219\u53d1\u5e03\u5931\u8d25\uff0c\u5728\u8fd9\u4e2a\u671f\u95f4\uff0cHelm \u5ba2\u6237\u7aef\u662f\u5904\u4e8e\u6682\u505c\u72b6\u6001\u7684\u3002</p> <p>\u5bf9\u4e8e\u6240\u6709\u5176\u4ed6\u7c7b\u578b\uff0c\u53ea\u8981 kubernetes \u5c06\u8d44\u6e90\u6807\u8bb0\u4e3a\u52a0\u8f7d\uff08\u6dfb\u52a0\u6216\u66f4\u65b0\uff09\uff0c\u8d44\u6e90\u5c31\u88ab\u89c6\u4e3a\u5c31\u7eea\u72b6\u6001\uff0c\u5f53\u4e00\u4e2a hook \u58f0\u660e\u4e86\u5f88\u591a\u8d44\u6e90\u662f\uff0c\u8fd9\u4e9b\u8d44\u6e90\u662f\u88ab\u4e32\u884c\u6267\u884c\u7684\u3002</p> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f hook \u521b\u5efa\u7684\u8d44\u6e90\u4e0d\u4f1a\u4f5c\u4e3a release \u7684\u4e00\u90e8\u5206\u8fdb\u884c\u8ddf\u8e2a\u548c\u7ba1\u7406\uff0c\u4e00\u65e6 Helm \u9a8c\u8bc1\u4e86 hook \u5df2\u7ecf\u8fbe\u5230\u4e86\u5c31\u7eea\u72b6\u6001\uff0c\u5b83\u5c31\u4e0d\u4f1a\u53bb\u7ba1\u5b83\u4e86\u3002</p> <p>\u6240\u4ee5\uff0c\u5982\u679c\u6211\u4eec\u5728 hook \u4e2d\u521b\u5efa\u4e86\u8d44\u6e90\uff0c\u90a3\u4e48\u4e0d\u80fd\u4f9d\u8d56 <code>helm uninstall</code> \u53bb\u5220\u9664\u8d44\u6e90\uff0c\u56e0\u4e3a hook \u521b\u5efa\u7684\u8d44\u6e90\u5df2\u7ecf\u4e0d\u53d7\u63a7\u5236\u4e86\uff0c\u8981\u9500\u6bc1\u8fd9\u4e9b\u8d44\u6e90\uff0c\u4f60\u9700\u8981\u5c06 </p> <pre><code>helm.sh/hook-delete-policy\n</code></pre> <p>\u8fd9\u4e2a annotation \u6dfb\u52a0\u5230 hook \u6a21\u677f\u6587\u4ef6\u4e2d\uff0c\u6216\u8005\u8bbe\u7f6e Job \u8d44\u6e90\u7684\u751f\u5b58\uff08TTL\uff09\u5b57\u6bb5\u3002</p>"},{"location":"kubernetes_package/chart_hooks/#hook","title":"\u7f16\u5199 Hook","text":"<p>Hooks \u5c31\u662f Kubernetes \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u5728\u5143\u6570\u636e\u90e8\u5206\u5e26\u6709\u4e00\u4e9b\u7279\u6b8a\u7684\u6ce8\u89e3\uff0c\u56e0\u4e3a\u4ed6\u4eec\u662f\u6a21\u677f\u6587\u4ef6\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u4f7f\u7528\u666e\u901a\u6a21\u677f\u6240\u6709\u7684\u529f\u80fd\uff0c\u5305\u62ec\u8bfb\u53d6 <code>.Values</code>\u3001<code>.Release</code> \u548c <code>.Template</code>\u3002</p> <p>\u4f8b\u5982\uff0c\u5728 </p> <pre><code>templates/post-install-job.yaml\n</code></pre> <p>\u6587\u4ef6\u4e2d\u58f0\u660e\u4e00\u4e2a post-install \u7684 hook\uff1a</p> <pre><code>apiVersion: batch/v1\nkind: Job\nmetadata:\n  name: \"{{ .Release.Name }}\"\n  labels:\n    app.kubernetes.io/managed-by: {{ .Release.Service | quote }}\n    app.kubernetes.io/instance: {{ .Release.Name | quote }}\n    app.kubernetes.io/version: {{ .Chart.AppVersion }}\n    helm.sh/chart: \"{{ .Chart.Name }}-{{ .Chart.Version }}\"\n  annotations:\n    # \u56e0\u4e3a\u6dfb\u52a0\u4e86\u8fd9\u4e2a hook\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u4e2a\u8d44\u6e90\u88ab\u5b9a\u4e49\u4e3a\u4e86 hook\n    # \u5982\u679c\u6ca1\u6709\u8fd9\u884c\uff0c\u5219\u5f53\u524d\u8fd9\u4e2a Job \u4f1a\u88ab\u5f53\u6210 release \u7684\u4e00\u90e8\u5206\u5185\u5bb9\u3002\n    \"helm.sh/hook\": post-install\n    \"helm.sh/hook-weight\": \"-5\"\n    \"helm.sh/hook-delete-policy\": hook-succeeded\nspec:\n  template:\n    metadata:\n      name: \"{{ .Release.Name }}\"\n      labels:\n        app.kubernetes.io/managed-by: {{ .Release.Service | quote }}\n        app.kubernetes.io/instance: {{ .Release.Name | quote }}\n        helm.sh/chart: \"{{ .Chart.Name }}-{{ .Chart.Version }}\"\n    spec:\n      restartPolicy: Never\n      containers:\n      - name: post-install-job\n        image: \"alpine:3\"\n        command: [\"/bin/sleep\",\"{{ default \"10\" .Values.sleepyTime }}\"]\n</code></pre> <p>\u5f53\u524d\u8fd9\u4e2a\u6a21\u677f\u6210\u4e3a hook \u7684\u539f\u56e0\u5c31\u662f\u6dfb\u52a0\u8fd9\u4e2a\u6ce8\u89e3\uff1a</p> <pre><code>annotations:\n  \"helm.sh/hook\": post-install\n</code></pre> <p>\u4e00\u79cd\u8d44\u6e90\u4e5f\u53ef\u4ee5\u5b9e\u73b0\u591a\u4e2a hooks\uff1a</p> <pre><code>annotations:\n  \"helm.sh/hook\": post-install,post-upgrade\n</code></pre> <p>\u7c7b\u4f3c\u7684\uff0c\u5b9e\u73b0\u7ed9\u5b9a hook \u7684\u8d44\u6e90\u6570\u91cf\u4e5f\u6ca1\u6709\u9650\u5236\uff0c\u6bd4\u5982\u53ef\u4ee5\u5c06 secret \u548c\u4e00\u4e2a configmap \u90fd\u58f0\u660e\u4e3a <code>pre-install</code> hook\u3002</p> <p>\u5f53\u5b50 chart \u58f0\u660e hooks \u7684\u65f6\u5019\uff0c\u4e5f\u4f1a\u5bf9\u5176\u8fdb\u884c\u8c03\u7528\uff0c\u9876\u5c42\u7684 chart \u65e0\u6cd5\u7981\u7528\u5b50 chart \u6240\u58f0\u660e\u7684 hooks\u3002\u53ef\u4ee5\u4e3a hooks \u5b9a\u4e49\u6743\u91cd\uff0c\u8fd9\u5c06\u6709\u52a9\u4e8e\u786e\u5b9a hooks \u7684\u6267\u884c\u987a\u5e8f\uff1a</p> <pre><code>annotations:\n  \"helm.sh/hook-weight\": \"5\"\n</code></pre> <p>hook \u6743\u91cd\u53ef\u4ee5\u662f\u6b63\u6570\u4e5f\u53ef\u4ee5\u662f\u8d1f\u6570\uff0c\u4f46\u662f\u5fc5\u987b\u7528\u5b57\u7b26\u4e32\u8868\u793a\uff0c\u5f53 Helm \u5f00\u59cb\u6267\u884c\u7279\u5b9a\u79cd\u7c7b\u7684 hooks \u7684\u65f6\u5019\uff0c\u5b83\u5c06\u4ee5\u5347\u5e8f\u7684\u65b9\u5f0f\u5bf9\u8fd9\u4e9b hooks \u8fdb\u884c\u6392\u5e8f\u3002</p>"},{"location":"kubernetes_package/chart_hooks/#hook_1","title":"Hook \u5220\u9664\u7b56\u7565","text":"<p>\u6211\u4eec\u8fd8\u53ef\u4ee5\u5b9a\u4e49\u786e\u5b9a\u4f55\u65f6\u5220\u9664\u76f8\u5e94 hook \u8d44\u6e90\u7684\u7b56\u7565\uff0chook \u5220\u9664\u7b56\u7565\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u6ce8\u89e3\u8fdb\u884c\u5b9a\u4e49\uff1a</p> <pre><code>annotations:\n  \"helm.sh/hook-delete-policy\": before-hook-creation,hook-succeeded\n</code></pre> <p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u9009\u62e9\u4e00\u4e2a\u6216\u591a\u4e2a\u5df2\u5b9a\u4e49\u7684\u6ce8\u89e3\uff1a</p> <ul> <li><code>before-hook-creation</code>\uff1a\u8fd0\u884c\u4e00\u4e2a\u65b0\u7684 hook \u4e4b\u524d\u5220\u9664\u524d\u9762\u7684\u8d44\u6e90\uff08\u9ed8\u8ba4\uff09</li> <li><code>hook-succeeded</code>\uff1ahook \u6210\u529f\u6267\u884c\u540e\u5220\u9664\u8d44\u6e90</li> <li><code>hook-failed</code>\uff1ahook \u5982\u679c\u6267\u884c\u5931\u8d25\u5219\u5220\u9664\u8d44\u6e90</li> </ul> <p>\u5982\u679c\u672a\u6307\u5b9a\u4efb\u4f55 hook \u5220\u9664\u7b56\u7565\u6ce8\u89e3\uff0c\u5219\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f1a\u4f7f\u7528 <code>before-hook-creation</code> \u7b56\u7565\u3002</p>"},{"location":"kubernetes_package/charts/","title":"Charts","text":""},{"location":"kubernetes_package/charts/#charts","title":"Charts","text":"<p>Helm \u4f7f\u7528\u4e00\u79cd\u540d\u4e3a charts \u7684\u5305\u683c\u5f0f\uff0c\u4e00\u4e2a chart \u662f\u63cf\u8ff0\u4e00\u7ec4\u76f8\u5173\u7684 Kubernetes \u8d44\u6e90\u7684\u6587\u4ef6\u96c6\u5408\uff0c\u5355\u4e2a chart \u53ef\u80fd\u7528\u4e8e\u90e8\u7f72\u7b80\u5355\u7684\u5e94\u7528\uff0c\u6bd4\u5982 memcached pod\uff0c\u6216\u8005\u590d\u6742\u7684\u5e94\u7528\uff0c\u6bd4\u5982\u4e00\u4e2a\u5e26\u6709 HTTP \u670d\u52a1\u3001\u6570\u636e\u5e93\u3001\u7f13\u5b58\u7b49\u7b49\u529f\u80fd\u7684\u5b8c\u6574 web \u5e94\u7528\u7a0b\u5e8f\u3002</p> <p>Charts \u662f\u521b\u5efa\u5728\u7279\u5b9a\u76ee\u5f55\u4e0b\u9762\u7684\u6587\u4ef6\u96c6\u5408\uff0c\u7136\u540e\u53ef\u4ee5\u5c06\u5b83\u4eec\u6253\u5305\u5230\u4e00\u4e2a\u7248\u672c\u5316\u7684\u5b58\u6863\u4e2d\u6765\u90e8\u7f72\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u770b\u770b\u4f7f\u7528 Helm \u6784\u5efa charts \u7684\u4e00\u4e9b\u57fa\u672c\u65b9\u6cd5\u3002</p>"},{"location":"kubernetes_package/charts/#_1","title":"\u6587\u4ef6\u7ed3\u6784","text":"<p>chart \u88ab\u7ec4\u7ec7\u4e3a\u4e00\u4e2a\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u96c6\u5408\uff0c\u76ee\u5f55\u540d\u79f0\u5c31\u662f chart \u7684\u540d\u79f0\uff08\u4e0d\u5305\u542b\u7248\u672c\u4fe1\u606f\uff09\uff0c\u4e0b\u9762\u662f\u4e00\u4e2a WordPress \u7684 chart\uff0c\u4f1a\u88ab\u5b58\u50a8\u5728 <code>wordpress/</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u57fa\u672c\u7ed3\u6784\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>wordpress/\n  Chart.yaml          # \u5305\u542b\u5f53\u524d chart \u4fe1\u606f\u7684 YAML \u6587\u4ef6\n  LICENSE             # \u53ef\u9009\uff1a\u5305\u542b chart \u7684 license \u7684\u6587\u672c\u6587\u4ef6\n  README.md           # \u53ef\u9009\uff1a\u4e00\u4e2a\u53ef\u8bfb\u6027\u9ad8\u7684 README \u6587\u4ef6\n  values.yaml         # \u5f53\u524d chart \u7684\u9ed8\u8ba4\u914d\u7f6e values\n  values.schema.json  # \u53ef\u9009: \u4e00\u4e2a\u4f5c\u7528\u5728 values.yaml \u6587\u4ef6\u4e0a\u7684 JSON \u6a21\u5f0f\n  charts/             # \u5305\u542b\u8be5 chart \u4f9d\u8d56\u7684\u6240\u6709 chart \u7684\u76ee\u5f55\n  crds/               # Custom Resource Definitions\n  templates/          # \u6a21\u677f\u76ee\u5f55\uff0c\u4e0e values \u7ed3\u5408\u4f7f\u7528\u65f6\uff0c\u5c06\u6e32\u67d3\u751f\u6210 Kubernetes \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\n  templates/NOTES.txt # \u53ef\u9009: \u5305\u542b\u7b80\u77ed\u4f7f\u7528\u4f7f\u7528\u7684\u6587\u672c\u6587\u4ef6\n</code></pre> <p>\u53e6\u5916 Helm \u4f1a\u4fdd\u7559 <code>charts/</code>\u3001<code>crds/</code> \u4ee5\u53ca <code>templates/</code> \u76ee\u5f55\u4ee5\u53ca\u4e0a\u9762\u5217\u51fa\u7684\u6587\u4ef6\u540d\u7684\u4f7f\u7528\u3002</p>"},{"location":"kubernetes_package/charts/#chartyaml","title":"Chart.yaml \u6587\u4ef6","text":"<p>\u5bf9\u4e8e\u4e00\u4e2a chart \u5305\u6765\u8bf4 <code>Chart.yaml</code> \u6587\u4ef6\u662f\u5fc5\u987b\u7684\uff0c\u5b83\u5305\u542b\u4e0b\u9762\u7684\u8fd9\u4e9b\u5b57\u6bb5\uff1a</p> <pre><code>apiVersion: chart API \u7248\u672c (\u5fc5\u987b)\nname: chart \u540d (\u5fc5\u987b)\nversion: SemVer 2\u7248\u672c (\u5fc5\u987b)\nkubeVersion: \u517c\u5bb9\u7684 Kubernetes \u7248\u672c (\u53ef\u9009)\ndescription: \u4e00\u53e5\u8bdd\u63cf\u8ff0 (\u53ef\u9009)\ntype: chart \u7c7b\u578b (\u53ef\u9009)\nkeywords:\n  - \u5f53\u524d\u9879\u76ee\u5173\u952e\u5b57\u96c6\u5408 (\u53ef\u9009)\nhome: \u5f53\u524d\u9879\u76ee\u7684 URL (\u53ef\u9009)\nsources:\n  - \u5f53\u524d\u9879\u76ee\u6e90\u7801 URL (\u53ef\u9009)\ndependencies: # chart \u4f9d\u8d56\u5217\u8868 (\u53ef\u9009)\n  - name: chart \u540d\u79f0 (nginx)\n    version: chart \u7248\u672c (\"3\")\n    repository: \u4ed3\u5e93\u5730\u5740 (\"https://example.com/charts\")\nmaintainers: # (\u53ef\u9009)\n  - name: \u7ef4\u62a4\u8005\u540d\u5b57 (\u5bf9\u6bcf\u4e2a maintainer \u662f\u5fc5\u987b\u7684)\n    email: \u7ef4\u62a4\u8005\u7684 email (\u53ef\u9009)\n    url: \u7ef4\u62a4\u8005 URL (\u53ef\u9009)\nicon: chart \u7684 SVG \u6216\u8005 PNG \u56fe\u6807 URL (\u53ef\u9009).\nappVersion: \u5305\u542b\u7684\u5e94\u7528\u7a0b\u5e8f\u7248\u672c (\u53ef\u9009). \u4e0d\u9700\u8981 SemVer \u7248\u672c\ndeprecated: chart \u662f\u5426\u5df2\u88ab\u5f03\u7528 (\u53ef\u9009, boolean)\n</code></pre> <p>\u5176\u4ed6\u5b57\u6bb5\u9ed8\u8ba4\u4f1a\u88ab\u5ffd\u7565\u3002</p>"},{"location":"kubernetes_package/charts/#_2","title":"\u7248\u672c","text":"<p>\u6bcf\u4e2a chart \u90fd\u5fc5\u987b\u6709\u4e00\u4e2a\u7248\u672c\u53f7\uff0c\u7248\u672c\u5fc5\u987b\u9075\u5faa <code>SemVer2</code> \u6807\u51c6\uff0c\u548c Helm Classic \u4e0d\u540c\uff0cKubernetes Helm \u4f7f\u7528\u7248\u672c\u53f7\u4f5c\u4e3a release \u7684\u6807\u8bb0\uff0c\u4ed3\u5e93\u4e2d\u7684\u8f6f\u4ef6\u5305\u901a\u8fc7\u540d\u79f0\u52a0\u4e0a\u7248\u672c\u53f7\u6765\u6807\u8bc6\u7684\u3002</p> <p>\u4f8b\u5982\uff0c\u5c06\u4e00\u4e2a nginx \u7684 chart \u5305 version \u5b57\u6bb5\u8bbe\u7f6e\u4e3a\uff1a1.2.3\uff0c\u5219 chart \u6700\u7ec8\u540d\u79f0\u4e3a\uff1a</p> <p><code>nginx-1.2.3.tgz</code></p> <p>\u8fd8\u652f\u6301\u66f4\u590d\u6742\u7684 <code>SemVer2</code> \u540d\u79f0\uff0c\u4f8b\u5982\u7248\u672c\uff1a<code>1.2.3-alpha.1+ef365</code>\uff0c\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f\u7cfb\u7edf\u660e\u786e\u7981\u6b62\u4f7f\u7528\u975e <code>SemVer</code> \u7684\u540d\u79f0\u3002</p> <p><code>Chart.yaml</code> \u4e2d\u7684 <code>version</code> \u5b57\u6bb5\u88ab\u5f88\u591a Helm \u5de5\u5177\u4f7f\u7528\uff0c\u5305\u62ec CLI \u5de5\u5177\uff0c\u751f\u6210\u5305\u7684\u65f6\u5019\uff0c\u547d\u4ee4 <code>helm package</code> \u5c06\u4f7f\u7528\u8be5\u5b57\u6bb5\u4f5c\u4e3a\u5305\u540d\u79f0\u4e2d\u7684\u6807\u8bb0\uff0c\u7cfb\u7edf\u662f\u9ed8\u8ba4 Chart \u5305\u4e2d\u7684\u7248\u672c\u53f7\u4e0e <code>chart.yaml</code> \u4e2d\u7684\u7248\u672c\u53f7\u5339\u914d\u7684\uff0c\u6240\u4ee5\u5982\u679c\u4e0d\u5339\u914d\u7684\u8bdd\u5c31\u5bfc\u81f4\u4e00\u7cfb\u5217\u9519\u8bef\u3002</p>"},{"location":"kubernetes_package/charts/#apiversion","title":"<code>apiVersion</code> \u5b57\u6bb5","text":"<p>\u5bf9\u4e8e Helm 3 \u4ee5\u4e0a\u7684\u7248\u672c <code>apiVersion</code> \u5b57\u6bb5\u5e94\u8be5\b\u662f <code>v2</code>\uff0c\u4e4b\u524d\u7248\u672c\u7684 Chart \u5e94\u8be5\u8bbe\u7f6e\u4e3a1\uff0c\u5e76\u4e14\u4e5f\u53ef\u4ee5\u6709 Helm 3 \u8fdb\u884c\u5b89\u88c5\u3002</p>"},{"location":"kubernetes_package/charts/#appversion","title":"<code>appVersion</code> \u5b57\u6bb5","text":"<p>\u8981\u6ce8\u610f <code>appVersion</code> \u5b57\u6bb5\u4e0e version \u5b57\u6bb5\u65e0\u5173\uff0c\u8fd9\u662f\u4e00\u79cd\u6307\u5b9a\u5e94\u7528\u7a0b\u5e8f\u7248\u672c\u7684\u65b9\u6cd5\uff0c\u6bd4\u5982 drupal \u7684 Chart \u5305\u53ef\u80fd\u6709\u4e00\u4e2a <code>appVersion: 8.2.1</code> \u7684\u5b57\u6bb5\uff0c\u8868\u793a Chart \u4e2d\u5305\u542b\u7684 drupal \u7248\u672c\u662f 8.2.1\uff0c\u8be5\u5b57\u6bb5\u4ec5\u4f9b\u53c2\u8003\uff0c\u5bf9 Chart \u7248\u672c\u7684\u8ba1\u7b97\u4e0d\u4f1a\u4ea7\u751f\u5f71\u54cd\u3002</p>"},{"location":"kubernetes_package/charts/#charts_1","title":"\u5f03\u7528 Charts","text":"<p>\u5f53\u5728 Chart \u4ed3\u5e93\u4e2d\u7ba1\u7406 charts \u7684\u65f6\u5019\uff0c\u6709\u65f6\u5019\u9700\u8981\u5f03\u7528\u4e00\u4e2a chart\uff0c<code>Chart.yaml</code> \u4e2d\u7684\u53ef\u9009\u5b57\u6bb5 <code>deprecated</code> \u53ef\u4ee5\u7528\u6765\u6807\u8bb0\u4e00\u4e2a chart \u4e3a\u5f03\u7528\u72b6\u6001\u3002\u5982\u679c\u5c06\u4ed3\u5e93\u4e2d\u6700\u65b0\u7248\u672c\u7684 chart \u6807\u8bb0\u4e3a\u5f03\u7528\uff0c\u5219\u6574\u4e2a chart \u90fd\u4f1a\u88ab\u5f53\u505a\u5f03\u7528\u72b6\u6001\u4e86\u3002\u4ee5\u540e\u53ef\u4ee5\u901a\u8fc7\u53d1\u5e03\u4e00\u4e2a\u672a\u88ab\u6807\u8bb0\u4e3a\u5f03\u7528\u72b6\u6001\u7684\u65b0\u7248\u672c\u6765\u91cd\u65b0\u4f7f\u7528\u8be5 chart\u3002\u5f03\u7528 charts \u7684\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li>\u66f4\u65b0 chart \u7684 <code>Chart.yaml</code> \u6765\u6807\u8bb0 chart \u4e3a\u5f03\u7528\u72b6\u6001</li> <li>\u53d1\u5e03\u8be5\u65b0\u7248\u672c\u5230 Chart \u4ed3\u5e93</li> <li>\u4ece\u6e90\u7801\u4ed3\u5e93\uff08\u6bd4\u5982 git\uff09\u4e2d\u5220\u9664 chart</li> </ul>"},{"location":"kubernetes_package/charts/#chart","title":"Chart \u7c7b\u578b","text":"<p><code>type</code> \u5b57\u6bb5\u5b9a\u4e49 chart \u7684\u7c7b\u578b\uff0c\u53ef\u4ee5\u5b9a\u4e49\u4e24\u79cd\u7c7b\u578b\uff1a\u5e94\u7528\u7a0b\u5e8f\uff08application\uff09\u548c\u5e93\uff08library\uff09\u3002\u5e94\u7528\u7a0b\u5e8f\u662f\u9ed8\u8ba4\u7684\u7c7b\u578b\uff0c\u5b83\u662f\u4e00\u4e2a\u53ef\u4ee5\u5b8c\u6574\u64cd\u4f5c\u7684\u6807\u51c6 chart\uff0c\u5e93\u6216\u8005\u8f85\u52a9\u7c7b chart \u4e3a chart \u63d0\u4f9b\u4e86\u4e00\u4e9b\u5b9e\u7528\u7684\u529f\u80fd\uff0clibrary \u4e0d\u540c\u4e8e\u5e94\u7528\u7a0b\u5e8f chart\uff0c\u56e0\u4e3a\u5b83\u6ca1\u6709\u8d44\u6e90\u5bf9\u8c61\uff0c\u6240\u4ee5\u65e0\u6cd5\u5b89\u88c5\u3002</p> <p>\u6ce8\u610f</p> <p>\u4e00\u4e2a\u5e94\u7528 chart \u4e5f\u53ef\u4ee5\u5f53\u4f5c\u5e93\u8fdb\u884c\u4f7f\u7528\u3002\u901a\u8fc7\u5c06\u7c7b\u578b\u8bbe\u7f6e\u4e3a library\uff0c\u7136\u540e\u8be5 chart \u5c31\u4f1a\u6e32\u67d3\u6210\u4e00\u4e2a\u5e93\uff0c\u53ef\u4ee5\u5728\u5176\u4e2d\u4f7f\u7528\u6240\u6709\u7684\u5b9e\u7528\u6027\u529f\u80fd\uff0cchart \u7684\u6240\u6709\u8d44\u6e90\u5bf9\u8c61\u90fd\u4e0d\u4f1a\u88ab\u6e32\u67d3\u3002</p>"},{"location":"kubernetes_package/charts/#license_readme_notes","title":"LICENSE, README \u548c NOTES","text":"<p>Chart \u8fd8\u53ef\u4ee5\u5305\u542b\u7528\u4e8e\u63cf\u8ff0 chart \u7684\u5b89\u88c5\u3001\u914d\u7f6e\u3001\u7528\u6cd5\u548c\u8bb8\u53ef\u8bc1\u4e66\u7684\u6587\u4ef6\u3002</p> <p>LICENSE \u662f\u4e00\u4e2a\u7eaf\u6587\u672c\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b chart \u7684\u8bb8\u53ef\u8bc1\u4e66\u3002chart \u53ef\u4ee5\u5305\u542b\u4e00\u4e2a\u8bb8\u53ef\u8bc1\u4e66\uff0c\u56e0\u4e3a\u5b83\u53ef\u80fd\u5728\u6a21\u677f\u4e2d\u5177\u6709\u7f16\u7a0b\u903b\u8f91\uff0c\u6240\u4ee5\u4e0d\u53ea\u662f\u914d\u7f6e\uff0c\u5982\u679c\u9700\u8981\uff0cchart \u8fd8\u53ef\u4ee5\u4e3a\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u5355\u72ec\u7684 license(s)\u3002</p> <p>Chart \u7684 README \u6587\u4ef6\u5e94\u8be5\u91c7\u7528 Markdown\uff08README.md\uff09\u683c\u5f0f\uff0c\u5e76\u4e14\u901a\u5e38\u5e94\u8be5\u5305\u542b\u5982\u4e0b\u7684\u4e00\u4e9b\u4fe1\u606f\uff1a</p> <ul> <li>chart \u63d0\u4f9b\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u63cf\u8ff0\u4fe1\u606f</li> <li>\u8fd0\u884c chart \u7684\u4efb\u4f55\u5148\u51b3\u6761\u4ef6\u6216\u8005\u8981\u6c42</li> <li><code>values.yaml</code> \u548c\u9ed8\u8ba4\u503c\u4e2d\u7684\u4e00\u4e9b\u9009\u9879\u8bf4\u660e</li> <li>\u4e0e chart \u7684\u5b89\u88c5\u6216\u914d\u7f6e\u6709\u5173\u7684\u4efb\u4f55\u5176\u4ed6\u4fe1\u606f</li> </ul> <p>chart \u8fd8\u53ef\u4ee5\u5305\u542b\u7b80\u77ed\u7684\u7eaf\u6587\u672c\u6a21\u677f\u6216\u8005 <code>NOTES.txt</code> \u6587\u4ef6\uff0c\u8be5\u6587\u4ef6\u5c06\u5728\u5b89\u88c5\u540e\u4ee5\u53ca\u67e5\u770b release \u72b6\u6001\u7684\u65f6\u5019\u6253\u5370\u51fa\u6765\u3002\u8be5\u6587\u4ef6\u4f1a\u88ab\u5f53\u6210\u6a21\u677f\u6587\u4ef6\uff0c\u5e76\u4e14\u53ef\u4ee5\u7528\u4e8e\u663e\u793a\u4f7f\u7528\u8bf4\u660e\uff0c\u540e\u7eed\u6b65\u9aa4\u6216\u4e0e release \u6709\u5173\u7684\u4efb\u4f55\u5176\u4ed6\u4fe1\u606f\u3002\u4f8b\u5982\uff0c\u53ef\u4ee5\u63d0\u4f9b\u7528\u4e8e\u8fde\u63a5\u5230\u6570\u636e\u6216\u8bbf\u95ee Web UI \u7684\u6307\u4ee4\u3002\u7531\u4e8e\u5728\u8fd0\u884c <code>helm install</code> \u6216\u8005 <code>helm status</code> \u7684\u65f6\u5019\u8be5\u6587\u4ef6\u4f1a\u6253\u5370\u5230 <code>STDOUT</code> \u4e2d\uff0c\u6240\u4ee5\u5efa\u8bae\u8be5\u6587\u4ef6\u5185\u5bb9\u4fdd\u6301\u5185\u5bb9\u7b80\u77ed\u7136\u540e\u53ef\u4ee5\u6307\u5411 README \u6587\u4ef6\u6765\u83b7\u53d6\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\u3002</p>"},{"location":"kubernetes_package/charts/#_3","title":"\u4f9d\u8d56","text":"<p>\u5728 Helm \u4e2d\uff0c\u4e00\u4e2a chart \u5305\u53ef\u80fd\u4f1a\u4f9d\u8d56\u8bb8\u591a\u5176\u4ed6\u7684 chart\u3002\u8fd9\u4e9b\u4f9d\u8d56\u5173\u7cfb\u53ef\u4ee5\u4f7f\u7528 <code>Chart.yaml</code> \u4e2d\u7684\u4f9d\u8d56\u5173\u7cfb\u5b57\u6bb5\u52a8\u6001\u94fe\u63a5\uff0c\u4e5f\u53ef\u4ee5\u5f15\u5165\u5230 <code>charts/</code> \u76ee\u5f55\u624b\u52a8\u8fdb\u884c\u7ba1\u7406\u3002</p>"},{"location":"kubernetes_package/charts/#dependencies","title":"\u4f7f\u7528 <code>dependencies</code> \u5b57\u6bb5\u7ba1\u7406\u4f9d\u8d56","text":"<p>\u5f53\u524d chart \u6240\u9700\u7684\u4f9d\u8d56 chart \u9700\u8981\u5728 <code>dependencies</code> \u5b57\u6bb5\u4e2d\u8fdb\u884c\u5b9a\u4e49\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>dependencies:\n  - name: apache\n    version: 3\n    repository: https://example.com/charts\n  - name: mysql\n    version: 1\n    repository: https://another.example.com/charts\n</code></pre> <ul> <li><code>name</code> \u5b57\u6bb5\u662f\u6240\u4f9d\u8d56\u7684 chart \u7684\u540d\u79f0</li> <li><code>version</code> \u5b57\u6bb5\u662f\u4f9d\u8d56\u7684 chart \u7248\u672c</li> <li><code>repository</code> \u5b57\u6bb5\u662f chart \u4ed3\u5e93\u7684\u5b8c\u6574 URL\uff0c\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\uff0c\u5fc5\u987b\u4f7f\u7528 <code>helm repo add</code> \u5728\u672c\u5730\u6dfb\u52a0\u8be5 repo</li> </ul> <p>\u5b9a\u4e49\u4e86\u4f9d\u8d56\u9879\u540e\uff0c\u53ef\u4ee5\u8fd0\u884c </p> <pre><code>helm dependency update\n</code></pre> <p>\u6765\u66f4\u65b0\u4f9d\u8d56\u9879\uff0c\u5b83\u5c06\u6839\u636e\u4f60\u7684\u4f9d\u8d56\u9879\u6587\u4ef6\u628a\u4f60\u6240\u6709\u6307\u5b9a\u7684 chart \u5305\u4e0b\u8f7d\u5230 <code>charts/</code> \u76ee\u5f55\u4e2d\uff1a</p> <pre><code>$ helm dependency update foochart\nHang tight while we grab the latest from your chart repositories...\n...Successfully got an update from the \"local\" chart repository\n...Successfully got an update from the \"stable\" chart repository\n...Successfully got an update from the \"example\" chart repository\n...Successfully got an update from the \"another\" chart repository\nUpdate Complete. Happy Helming!\nSaving 2 charts\nDownloading apache from repo https://example.com/charts\nDownloading mysql from repo https://another.example.com/charts\n</code></pre> <p>\u5f53\u6267\u884c </p> <pre><code>helm dependency update\n</code></pre> <p>\u547d\u4ee4\u7684\u65f6\u5019\u4f1a\u89e3\u6790 chart \u7684\u4f9d\u8d56\u9879\uff0c\u4f1a\u5c06\u4ed6\u4eec\u4f5c\u4e3a chart \u5305\u6587\u4ef6\u4e0b\u8f7d\u5b58\u653e\u5230 <code>charts/</code> \u76ee\u5f55\u4e2d\uff0c\u6240\u4ee5\uff0c\u5bf9\u4e8e\u4e0a\u9762\u7684\u793a\u4f8b\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 charts \u76ee\u5f55\u4e2d\u770b\u5230\u5982\u4e0b\u7684\u6587\u4ef6\uff1a</p> <pre><code>charts/\n  apache-tgz\n  mysql-tgz\n</code></pre>"},{"location":"kubernetes_package/charts/#alias","title":"alias \u5b57\u6bb5","text":"<p>\u9664\u4e86\u4e0a\u9762\u7684\u51e0\u4e2a\u5b57\u6bb5\u4e4b\u5916\uff0c\u6bcf\u4e2a\u4f9d\u8d56\u9879\u8fd8\u53ef\u4ee5\u5305\u542b\u4e00\u4e2a\u53ef\u9009\u7684 <code>alias</code> \u522b\u540d\u5b57\u6bb5\u3002\u4e3a\u4f9d\u8d56 chart \u6dfb\u52a0\u522b\u540d\u5c06\u4f7f\u7528\u522b\u540d\u4f5c\u4e3a\u4f9d\u8d56\u7684\u540d\u79f0\u3002\u5728\u9700\u8981\u8bbf\u95ee\u5176\u4ed6\u540d\u79f0\u7684 chart \u60c5\u51b5\u4e0b\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u522b\u540d\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># parentchart/Chart.yaml\n\ndependencies:\n  - name: subchart\n    repository: http://localhost:10191\n    version: 0\n    alias: new-subchart-1\n  - name: subchart\n    repository: http://localhost:10191\n    version: 0\n    alias: new-subchart-2\n  - name: subchart\n    repository: http://localhost:10191\n    version: 0\n</code></pre> <p>\u5728\u4e0a\u9762\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u5c06\u83b7\u5f973\u4e2a\u4f9d\u8d56\u9879\uff1a</p> <pre><code>subchart\nnew-subchart-1\nnew-subchart-2\n</code></pre> <p>\u5f53\u7136\u5176\u5b9e\u6211\u4eec\u4e5f\u53ef\u4ee5\u624b\u52a8\u6765\u5b9e\u73b0\uff0c\u5c06\u540c\u4e00\u4e2a chart \u4ee5\u4e0d\u540c\u7684\u540d\u79f0\u591a\u6b21\u590d\u5236/\u7c98\u8d34\u5230 <code>charts/</code> \u76ee\u5f55\u4e2d\u4e5f\u662f\u53ef\u4ee5\u7684\u3002</p>"},{"location":"kubernetes_package/charts/#templates_values","title":"TEMPLATES \u548c VALUES","text":"<p>Helm Chart \u6a21\u677f\u662f\u7528 Go template \u8bed\u8a00 \u8fdb\u884c\u7f16\u5199\u7684\uff0c\u53e6\u5916\u8fd8\u989d\u5916\u589e\u52a0\u4e86(\u3010Sprig\u3011](https://github.com/Masterminds/sprig)\u5e93\u4e2d\u768450\u4e2a\u5de6\u53f3\u7684\u9644\u52a0\u6a21\u677f\u51fd\u6570\u548c\u4e00\u4e9b\u5176\u4ed6\u4e13\u7528\u51fd\u6570\u3002</p> <p>\u6240\u6709\u6a21\u677f\u6587\u4ef6\u90fd\u5b58\u50a8\u5728 chart \u7684 <code>templates/</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u5f53 Helm \u6e32\u67d3 charts \u7684\u65f6\u5019\uff0c\u5b83\u5c06\u901a\u8fc7\u6a21\u677f\u5f15\u64ce\u4f20\u9012\u8be5\u76ee\u5f55\u4e2d\u7684\u6bcf\u4e2a\u6587\u4ef6\u3002\u6a21\u677f\u7684 <code>Values</code> \u53ef\u4ee5\u901a\u8fc7\u4e24\u79cd\u65b9\u5f0f\u63d0\u4f9b\uff1a</p> <ul> <li>Chart \u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u5728 chart \u5185\u90e8\u63d0\u4f9b\u4e00\u4e2a\u540d\u4e3a <code>values.yaml</code> \u7684\u6587\u4ef6\uff0c\u8be5\u6587\u4ef6\u53ef\u4ee5\u5305\u542b\u9ed8\u8ba4\u7684 values \u503c\u5185\u5bb9\u3002</li> <li>Chart \u7528\u6237\u53ef\u4ee5\u63d0\u4f9b\u5305\u542b values \u503c\u7684 YAML \u6587\u4ef6\uff0c\u53ef\u4ee5\u5728\u547d\u4ee4\u884c\u4e2d\u901a\u8fc7 <code>helm install</code> \u6765\u6307\u5b9a\u8be5\u6587\u4ef6\u3002</li> </ul> <p>\u5f53\u7528\u6237\u63d0\u4f9b\u81ea\u5b9a\u4e49 values \u503c\u7684\u65f6\u5019\uff0c\u8fd9\u4e9b\u503c\u5c06\u8986\u76d6 chart \u4e2d <code>values.yaml</code> \u6587\u4ef6\u4e2d\u7684\u76f8\u5e94\u7684\u503c\u3002</p>"},{"location":"kubernetes_package/charts/#_4","title":"\u6a21\u677f\u6587\u4ef6","text":"<p>\u6a21\u677f\u6587\u4ef6\u9075\u5faa\u7f16\u5199 Go \u6a21\u677f\u7684\u6807\u51c6\u7ea6\u5b9a\uff08\u53ef\u4ee5\u67e5\u770b text/template \u5305\u6587\u6863\u67e5\u770b\u8be6\u7ec6\u4fe1\u606f\uff09\uff0c\u4e0b\u9762\u662f\u4e00\u4e2a\u6a21\u677f\u6587\u4ef6\u793a\u4f8b\uff1a</p> <pre><code>apiVersion: v1\nkind: ReplicationController\nmetadata:\n  name: deis-database\n  namespace: deis\n  labels:\n    app.kubernetes.io/managed-by: deis\nspec:\n  replicas: 1\n  selector:\n    app.kubernetes.io/name: deis-database\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: deis-database\n    spec:\n      serviceAccount: deis-database\n      containers:\n        - name: deis-database\n          image: {{ .Values.imageRegistry }}/postgres:{{ .Values.dockerTag }}\n          imagePullPolicy: {{ .Values.pullPolicy }}\n          ports:\n            - containerPort: 5432\n          env:\n            - name: DATABASE_STORAGE\n              value: {{ default \"minio\" .Values.storage }}\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a\u793a\u4f8b\u662f Kubernetes replication \u63a7\u5236\u5668\u7684\u4e00\u4e2a\u6a21\u677f\uff0c\u5b83\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b4\u4e2a\u6a21\u677f\u503c\uff08\u901a\u5e38\u5728 <code>values.yaml</code> \u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\uff09\uff1a</p> <ul> <li><code>imageRegistry</code>\uff1aDocker \u955c\u50cf\u4ed3\u5e93</li> <li><code>dockerTag</code>\uff1aDocker \u955c\u50cf tag</li> <li><code>pullPolicy</code>\uff1a\u955c\u50cf\u62c9\u53d6\u7b56\u7565</li> <li><code>storage</code>\uff1a\u5b58\u50a8\u540e\u7aef\uff0c\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a <code>\"minio\"</code></li> </ul> <p>\u8fd9\u4e9b\u6240\u6709\u7684 values \u503c\u90fd\u662f\u6709\u6a21\u677f\u4f5c\u8005\u6765\u5b9a\u4e49\u7684\uff0cHelm \u4e0d\u4f1a\u4e5f\u4e0d\u9700\u8981\u89c4\u5b9a\u8fd9\u4e9b\u53c2\u6570\u3002\u53ef\u4ee5\u53ef\u4ee5\u67e5\u770b Kubernetes Charts \u9879\u76ee\u53bb\u4e86\u89e3\u66f4\u591a\u7684 charts \u9879\u76ee\u7684\u8be6\u7ec6\u5185\u5bb9\u3002</p>"},{"location":"kubernetes_package/charts/#values","title":"\u9884\u5b9a\u4e49 Values","text":"<p>\u5728\u6a21\u677f\u4e2d\u7528 <code>.Values</code> \u53ef\u4ee5\u83b7\u53d6\u5230 <code>values.yaml</code> \u6587\u4ef6\uff08\u6216\u8005 <code>--set</code> \u53c2\u6570\uff09\u63d0\u4f9b\u7684 values \u503c\uff0c\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u8bbf\u95ee\u5176\u4ed6\u9884\u5b9a\u4e49\u7684\u6570\u636e\u3002\u4e0b\u9762\u662f\u4e00\u4e9b\u9884\u5b9a\u4e49\u7684\u3001\u53ef\u7528\u4e8e\u6bcf\u4e2a\u6a21\u677f\u3001\u5e76\u4e14\u4e0d\u80fd\u88ab\u8986\u76d6\u7684 values \u503c\uff0c\u4e0e\u6240\u6709 values \u503c\u4e00\u6837\uff0c\u540d\u79f0\u90fd\u662f\u533a\u5206\u5927\u5c0f\u5199\u7684\uff1a</p> <ul> <li><code>Release.Name</code>\uff1arelease \u7684\u540d\u79f0\uff08\u4e0d\u662f chart\uff09</li> <li><code>Release.Namespace</code>\uff1arelease \u88ab\u5b89\u88c5\u5230\u7684\u547d\u540d\u7a7a\u95f4</li> <li><code>Release.Service</code>\uff1a\u6e32\u67d3\u5f53\u524d\u6a21\u677f\u7684\u670d\u52a1\uff0c\u5728 Helm \u4e0a\uff0c\u5b9e\u9645\u4e0a\u8be5\u503c\u59cb\u7ec8\u4e3a Helm</li> <li><code>Release.IsUpgrade</code>\uff1a\u5982\u679c\u5f53\u524d\u64cd\u4f5c\u662f\u5347\u7ea7\u6216\u56de\u6eda\uff0c\u5219\u8be5\u503c\u4e3a true</li> <li><code>Release.IsInstall</code>\uff1a\u5982\u679c\u5f53\u524d\u64cd\u4f5c\u662f\u5b89\u88c5\uff0c\u5219\u8be5\u503c\u4e3a true</li> <li><code>Chart</code>\uff1a<code>Chart.yaml</code> \u6587\u4ef6\u7684\u5185\u5bb9\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>Chart.Version</code> \u6765\u83b7\u5f97 Chart \u7684\u7248\u672c\uff0c\u901a\u8fc7 <code>Chart.Maintainers</code> \u53ef\u4ee5\u83b7\u53d6\u7ef4\u62a4\u8005\u4fe1\u606f</li> <li> <p><code>Files</code>\uff1a \u4e00\u4e2a\u5305\u542b chart \u4e2d\u6240\u6709\u975e\u7279\u6b8a\u6587\u4ef6\u7684 map \u5bf9\u8c61\uff0c\u8fd9\u4e0d\u4f1a\u7ed9\u4f60\u8bbf\u95ee\u6a21\u677f\u7684\u6743\u9650\uff0c\u4f46\u662f\u4f1a\u7ed9\u4f60\u8bbf\u95ee\u5b58\u5728\u7684\u5176\u4ed6\u6587\u4ef6\u7684\u6743\u9650\uff08\u9664\u975e\u4f7f\u7528 <code>.helmignore</code> \u6392\u9664\u5b83\u4eec\uff09\uff0c\u53ef\u4ee5\u4f7f\u7528 </p> <pre><code>{{ index .Files \"file.name\" }}\n</code></pre> <p>\u6216\u8005 </p> <pre><code>{{ .Files.Get name }}\n</code></pre> <p>\u6216\u8005 </p> <pre><code>{{ .Files.GetString name }}\n</code></pre> <p>\u51fd\u6570\u6765\u8bbf\u95ee\u6587\u4ef6\uff0c\u4f60\u8fd8\u53ef\u4ee5\u4f7f\u7528 </p> <pre><code>{{ .Files.GetBytes }}\n</code></pre> <p>\u4ee5 <code>[]byte</code> \u7684\u5f62\u5f0f\u83b7\u53d6\u8bbf\u95ee\u6587\u4ef6\u7684\u5185\u5bb9 *   <code>Capabilities</code>\uff1a\u4e5f\u662f\u4e00\u4e2a\u7c7b map \u7684\u5bf9\u8c61\uff0c\u5176\u4e2d\u5305\u542b\u6709\u5173 Kubernetes \u7248\u672c\uff08</p> <pre><code>{{ .Capabilities.KubeVersion }}\n</code></pre> <p>\uff09\u548c\u652f\u6301\u7684 Kubernetes API \u7248\u672c\uff08</p> <pre><code>{{ .Capabilities.APIVersions.Has \"batch/v1\" }}\n</code></pre> <p>\uff09\u4fe1\u606f\u3002</p> </li> </ul> <p>\u6ce8\u610f</p> <p>\u4efb\u4f55\u672a\u77e5\u7684 <code>Chart.yaml</code> \u5b57\u6bb5\u90fd\u4f1a\u88ab\u5220\u9664\uff0c\u5728 Chart \u5bf9\u8c61\u5185\u90e8\u65e0\u6cd5\u8bbf\u95ee\u4ed6\u4eec\uff0c\u6240\u4ee5\uff0c<code>Chart.yaml</code> \u4e0d\u80fd\u7528\u4e8e\u5c06\u4efb\u610f\u7ed3\u6784\u5316\u7684\u6570\u636e\u4f20\u9012\u5230\u6a21\u677f\u4e2d\uff0c\u4f46\u662f\u53ef\u4ee5\u4f7f\u7528 values \u6587\u4ef6\u6765\u4f20\u9012\u3002</p>"},{"location":"kubernetes_package/charts/#values_1","title":"Values \u6587\u4ef6","text":"<p>\u4e3a\u6a21\u677f\u63d0\u4f9b\u4e00\u4e9b\u5fc5\u987b\u7684 values \u503c\u7684 <code>values.yaml</code> \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>imageRegistry: \"quay.io/deis\"\ndockerTag: \"latest\"\npullPolicy: \"Always\"\nstorage: \"s3\"\n</code></pre> <p>values \u6587\u4ef6\u7684\u683c\u5f0f\u662f YAML\uff0c\u4e00\u4e2a chart \u5305\u53ef\u80fd\u5305\u542b\u4e00\u4e2a\u9ed8\u8ba4\u7684 <code>values.yaml</code> \u6587\u4ef6\uff0c<code>helm install</code> \u547d\u4ee4\u5141\u8bb8\u7528\u6237\u901a\u8fc7\u63d0\u4f9b\u5176\u4ed6\u7684 YAML \u503c\u6587\u4ef6\u6765\u8986\u76d6\u9ed8\u8ba4\u7684\u503c\uff1a</p> <pre><code>$ helm install --values=myvals.yaml wordpress\n</code></pre> <p>\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u4f20\u9012 values \u503c\u7684\u65f6\u5019\uff0c\u5b83\u4eec\u5c06\u5408\u5e76\u5230\u9ed8\u8ba4\u503c\u6587\u4ef6\u4e2d\uff0c\u6bd4\u5982\u6709\u4e00\u4e2a <code>myvals.yaml</code> \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>storage: \"gcs\"</code></p> <p>\u5c06\u5176\u4e0e chart \u7684 <code>values.yaml</code> \u6587\u4ef6\u5408\u5e76\u540e\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u4e3a\uff1a</p> <pre><code>imageRegistry: \"quay.io/deis\"\ndockerTag: \"latest\"\npullPolicy: \"Always\"\nstorage: \"gcs\"\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u53ea\u6709\u6700\u540e\u4e00\u4e2a\u5b57\u6bb5\u88ab\u8986\u76d6\u4e86\u3002</p> <p>\u6ce8\u610f</p> <p>chart \u5185\u5305\u542b\u7684\u9ed8\u8ba4 values \u6587\u4ef6\u5fc5\u987b\u547d\u540d\u4e3a <code>values.yaml</code>\uff0c\u4f46\u662f\u5728\u547d\u4ee4\u884c\u4e0a\u6307\u5b9a\u7684\u6587\u4ef6\u53ef\u4ee5\u4efb\u610f\u547d\u540d\u3002 \u5982\u679c\u5728 <code>helm install</code> \u6216\u8005 <code>helm upgrade</code> \u7684\u65f6\u5019\u4f7f\u7528 <code>--set</code> \u53c2\u6570\uff0c\u5219\u8fd9\u4e9b\u503c\u5c06\u5728\u5ba2\u6237\u7aef\u8f6c\u6362\u4e3a YAML \u683c\u5f0f\u3002 \u5982\u679c values \u6587\u4ef6\u5b58\u5728\u4efb\u4f55\u5fc5\u987b\u7684\u6761\u76ee\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528 <code>required</code> \u51fd\u6570\u5728 chart \u6a21\u677f\u4e2d\u5c06\u5b83\u4eec\u58f0\u660e\u4e3a\u5fc5\u987b\u9009\u9879\u3002</p> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>.Values</code> \u5bf9\u8c61\u5728\u6a21\u677f\u4e2d\u8bbf\u95ee\u4efb\u610f\u4e00\u4e2a values \u503c\uff0c\u7c7b\u4f3c\u4e8e\u4e0b\u9762\u7684\u6a21\u677f\u6587\u4ef6\uff1a</p> <pre><code>apiVersion: v1\nkind: ReplicationController\nmetadata:\n  name: deis-database\n  namespace: deis\n  labels:\n    app.kubernetes.io/managed-by: deis\nspec:\n  replicas: 1\n  selector:\n    app.kubernetes.io/name: deis-database\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: deis-database\n    spec:\n      serviceAccount: deis-database\n      containers:\n        - name: deis-database\n          image: {{ .Values.imageRegistry }}/postgres:{{ .Values.dockerTag }}\n          imagePullPolicy: {{ .Values.pullPolicy }}\n          ports:\n            - containerPort: 5432\n          env:\n            - name: DATABASE_STORAGE\n              value: {{ default \"minio\" .Values.storage }}\n</code></pre>"},{"location":"kubernetes_package/charts/#values_2","title":"\u4f5c\u7528\u8303\u56f4\u3001\u4f9d\u8d56\u548c Values","text":"<p>values \u6587\u4ef6\u53ef\u4ee5\u58f0\u660e\u9876\u7ea7\u7684 chart \u4ee5\u53ca\u8be5 chart \u7684 <code>charts/</code> \u76ee\u5f55\u4e2d\u5305\u542b\u7684\u4efb\u4f55 chart \u7684\u503c\u3002\u6216\u8005\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0cvalues \u6587\u4ef6\u53ef\u4ee5\u4e3a chart \u4ee5\u53ca\u4ed6\u7684\u4efb\u4f55\u4f9d\u8d56\u9879\u63d0\u4f9b values \u503c\u3002\u4f8b\u5982\uff0c\u4e0a\u9762\u63d0\u5230\u4e86 WordPress \u8fd9\u4e2a chart \u540c\u65f6\u4f9d\u8d56 mysql \u548c apache \u8fd9\u4e24\u4e2a\u4f9d\u8d56\u9879\uff0cvalues \u6587\u4ef6\u53ef\u4ee5\u4e3a\u6240\u6709\u8fd9\u4e9b\u7ec4\u4ef6\u63d0\u4f9b values \u503c\uff1a</p> <pre><code>title: \"My WordPress Site\" # \u4f20\u9012\u5230 WordPress \u6a21\u677f\n\nmysql:\n  max_connections: 100 # \u4f20\u9012\u5230 MySQL\n  password: \"secret\"\n\napache:\n  port: 8080 # \u4f20\u9012\u5230 Apache\n</code></pre> <p>\u8f83\u9ad8\u7ea7\u522b\u7684 Charts \u53ef\u4ee5\u8bbf\u95ee\u4e0b\u9762\u5b9a\u4e49\u7684\u6240\u6709\u53d8\u91cf\uff0c\u6240\u4ee5\uff0cWordPress \u8fd9\u4e2a chart \u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>.Values.mysql.password\n</code></pre> <p>\u6765\u8bbf\u95ee MySQL \u7684\u5bc6\u7801\uff0c\u4f46\u662f\u8f83\u4f4e\u7ea7\u522b\u7684 chart \u662f\u65e0\u6cd5\u8bbf\u95ee\u7236 chart \u4e2d\u7684\u5185\u5bb9\u7684\uff0c\u6240\u6709 MySQL \u65e0\u6cd5\u83b7\u53d6\u5230 title \u5c5e\u6027\uff0c\u5f53\u7136\u540c\u6837\u4e5f\u4e0d\u80fd\u8bbf\u95ee <code>apache.port</code>\u3002</p> <p>Values \u662f\u6709\u547d\u540d\u7a7a\u95f4\u7684\uff0c\u4f46\u662f\u4f1a\u5bf9\u5176\u8fdb\u884c\u8c03\u6574\uff0c\u6bd4\u5982\u5bf9\u4e8e WordPress \u8fd9\u4e2a chart \u6765\u8bf4\uff0c\u5b83\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>.Values.mysql.password\n</code></pre> <p>\u6765\u8fdb\u884c\u8bbf\u95ee\uff0c\u4f46\u662f\u5bf9\u4e8e MySQL \u8fd9\u4e2a chart \u672c\u8eab\u6765\u8bf4\uff0cvalues \u7684\u8303\u56f4\u7f29\u5c0f\u4e86\uff0c\u547d\u540d\u7a7a\u95f4\u524d\u7f00\u4f1a\u88ab\u5220\u9664\uff0c\u6240\u4ee5\u5b83\u53ea\u9700\u8981\u901a\u8fc7 <code>.Values.password</code> \u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230\u3002</p>"},{"location":"kubernetes_package/charts/#values_3","title":"\u5168\u5c40 Values","text":"<p>\u4ece <code>2.0.0-Alpha.2</code> \u7248\u672c\u5f00\u59cb\uff0cHelm \u5f00\u59cb\u652f\u6301\u7279\u6b8a\u7684 <code>global</code> \u5168\u5c40\u503c\uff0c\u6bd4\u5982\u5c06\u4e0a\u9762\u7684\u793a\u4f8b\u4fee\u6539\u5982\u4e0b\uff1a</p> <pre><code>title: \"My WordPress Site\" # \u4f20\u9012\u5230 WordPress \u6a21\u677f\n\nglobal:\n  app: MyWordPress\n\nmysql:\n  max_connections: 100 # \u4f20\u9012\u5230 MySQL\n  password: \"secret\"\n\napache:\n  port: 8080 # \u4f20\u9012\u5230 Apache\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a\u5168\u5c40\u8303\u56f4\u7684 value \u503c\uff1a<code>app: MyWordPress</code>\uff0c\u8be5\u503c\u53ef\u4ee5\u901a\u8fc7 <code>.Values.global.app</code> \u63d0\u4f9b\u7ed9\u6240\u6709 chart \u4f7f\u7528\u3002</p> <p>\u4f8b\u5982\uff0cmysql \u6a21\u677f\u53ef\u4ee5\u4ee5 </p> <pre><code>{{ .Values.global.app }}\n</code></pre> <p>\u6765\u8bbf\u95ee app\uff0capache chart \u4e5f\u53ef\u4ee5\uff0c\u5b9e\u9645\u4e0a\uff0c\u4e0a\u9762\u7684 values \u6587\u4ef6\u4f1a\u8fd9\u6837\u91cd\u65b0\u751f\u6210\uff1a</p> <pre><code>title: \"My WordPress Site\" # \u4f20\u9012\u5230 WordPress \u6a21\u677f\n\nglobal:\n  app: MyWordPress\n\nmysql:\n  global:\n    app: MyWordPress\n  max_connections: 100 # \u4f20\u9012\u5230 MySQL\n  password: \"secret\"\n\napache:\n  global:\n    app: MyWordPress\n  port: 8080 # \u4f20\u9012\u5230 Apache\n</code></pre> <p>\u8fd9\u79cd\u65b9\u5f0f\u63d0\u4f9b\u4e86\u4e00\u79cd\u4e0e\u6240\u6709\u5b50 chart \u5171\u4eab\u4e00\u4e2a\u9876\u7ea7\u53d8\u91cf\u7684\u65b9\u5f0f\uff0c\u8fd9\u5bf9\u4e8e\u8bbe\u7f6e meta \u6570\u636e\u8fd9\u79cd\u5c5e\u6027\u662f\u975e\u5e38\u6709\u7528\u7684\u3002\u5982\u679c\u5b50 chart \u58f0\u660e\u4e86\u5168\u5c40\u53d8\u91cf\uff0c\u5219\u8be5\u5168\u5c40\u53d8\u91cf\u5c06\u5411\u4e0b\uff08\u4f20\u9012\u5230\u5b50 chart \u7684\u5b50 chart \u4e2d\uff09\u4f20\u9012\uff0c\u800c\u4e0d\u4f1a\u5411\u4e0a\u4f20\u9012\u5230\u7236 chart\uff0c\u5b50 chart \u65e0\u6cd5\u5f71\u54cd \u7236 chart\u7684\u503c\u3002\u540c\u6837\uff0c\u7236 chart \u7684\u5168\u5c40\u904d\u5386\u4f18\u5148\u4e0e\u5b50 chart \u4e2d\u7684\u5168\u5c40\u53d8\u91cf\u3002</p>"},{"location":"kubernetes_package/charts/#schema","title":"Schema \u6587\u4ef6","text":"<p>\u6709\u65f6\u5019\uff0cchart \u5f00\u53d1\u8005\u53ef\u80fd\u5e0c\u671b\u5728\u5176 values \u503c\u4e0a\u9762\u5b9a\u4e49\u4e00\u4e2a\u7ed3\u6784\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u53ef\u4ee5\u901a\u8fc7\u5728 <code>values.schema.json</code> \u6587\u4ef6\u4e2d\u5b9a\u4e49\u4e00\u4e2a schema \u6765\u5b8c\u6210\uff0c\u8fd9\u91cc\u7684 schema \u5c31\u662f\u4e00\u4e2a JSON Schema \u6587\u4ef6\u7ed3\u6784\u89c4\u8303\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>{\n  \"$schema\": \"https://json-schema.org/draft-07/schema#\",\n  \"properties\": {\n    \"image\": {\n      \"description\": \"Container Image\",\n      \"properties\": {\n        \"repo\": {\n          \"type\": \"string\"\n        },\n        \"tag\": {\n          \"type\": \"string\"\n        }\n      },\n      \"type\": \"object\"\n    },\n    \"name\": {\n      \"description\": \"Service name\",\n      \"type\": \"string\"\n    },\n    \"port\": {\n      \"description\": \"Port\",\n      \"minimum\": 0,\n      \"type\": \"integer\"\n    },\n    \"protocol\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\n    \"protocol\",\n    \"port\"\n  ],\n  \"title\": \"Values\",\n  \"type\": \"object\"\n}\n</code></pre> <p>\u8be5 schema \u4f1a\u5bf9 values \u503c\u8fdb\u884c\u6821\u9a8c\uff0c\u8c03\u7528\u4ee5\u4e0b\u4efb\u4f55\u547d\u4ee4\u65f6\uff0c\u90fd\u4f1a\u8fdb\u884c\u9a8c\u8bc1\uff1a</p> <ul> <li>helm install</li> <li>helm upgrade</li> <li>helm lint</li> <li>helm template</li> </ul> <p>\u6bd4\u5982\u4e0b\u9762\u7684\u793a\u4f8b\u6587\u4ef6\u5c31\u53ef\u4ee5\u6ee1\u8db3\u4e0a\u9762\u7684 schema \u8981\u6c42\uff1a</p> <pre><code>name: frontend\nprotocol: https\nport: 443\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u8be5 schema \u5c06\u5e94\u7528\u4e8e\u6700\u7ec8\u7684 <code>.Values</code> \u5bf9\u8c61\uff0c\u800c\u4e0d\u4ec5\u4ec5\u662f\u5e94\u7528\u4e8e <code>values.yaml</code> \u6587\u4ef6\uff0c\u6240\u4ee5\u4e0b\u9762\u7684\u6587\u4ef6\u4e5f\u662f\u53ef\u4ee5\u6ee1\u8db3 schema \u8981\u6c42\u7684\uff1a</p> <pre><code>name: frontend\nprotocol: https\n</code></pre> <p>\u56e0\u4e3a\u5728\u5b89\u88c5\u7684\u65f6\u5019\u6211\u4eec\u901a\u8fc7 <code>--set</code> \u9009\u9879\u4f20\u9012\u4e86\u5fc5\u987b\u7684 <code>port</code> \u5c5e\u6027\uff1a</p> <pre><code>$ helm install --set port=443\n</code></pre> <p>\u6b64\u5916\uff0c\u8fd8\u4f1a\u6839\u636e\u6240\u6709\u7684\u5b50 chart schemas \u6765\u68c0\u67e5\u6700\u7ec8\u7684 <code>.Values</code> \u5bf9\u8c61\uff0c\u8fd9\u610f\u5473\u7740\u7236 chart \u65e0\u6cd5\u89c4\u907f\u5bf9\u5b50 chart \u7684\u9650\u5236\u3002\u540c\u6837\u7684\uff0c\u5982\u679c\u5b50 chart \u8981\u6c42\u672a\u6ee1\u8db3\u5b50 chart \u7684 <code>values.yaml</code> \u6587\u4ef6\uff0c\u5219\u7236 chart \u5fc5\u987b\u6ee1\u8db3\u8fd9\u4e9b\u9650\u5236\u624d\u80fd\u751f\u6548\u3002</p>"},{"location":"kubernetes_package/charts/#_5","title":"\u53c2\u8003\u6587\u6863","text":"<p>\u5728\u7f16\u5199\u6a21\u677f\u3001values\u3001\u548c schema \u6587\u4ef6\u7684\u65f6\u5019\uff0c\u4e0b\u9762\u8fd9\u4e9b\u6587\u6863\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e9b\u5e2e\u52a9\uff1a</p> <ul> <li>Go Template</li> <li>\u989d\u5916\u7684\u6a21\u677f\u51fd\u6570</li> <li>YAML \u6587\u4ef6</li> <li>JSON Schema</li> </ul>"},{"location":"kubernetes_package/charts/#crds","title":"CRDS","text":"<p>Kubernetes \u63d0\u4f9b\u4e86\u4e00\u79cd\u58f0\u660e\u65b0\u7c7b\u578b\u7684 Kubernetes \u5bf9\u8c61\u7684\u673a\u5236\uff0c\u4f7f\u7528 </p> <pre><code>CustomResourceDefinitions\uff08CRDS\uff09\n</code></pre> <p>\u53ef\u4ee5\u8ba9 Kubernetes \u5f00\u53d1\u4eba\u5458\u58f0\u660e\u81ea\u5b9a\u4e49\u8d44\u6e90\u7c7b\u578b\u3002</p> <p>\u5728 Helm 3 \u4e2d\uff0cCRD \u88ab\u89c6\u4e3a\u4e00\u79cd\u7279\u6b8a\u7684\u5bf9\u8c61\uff0c\u5b83\u4eec\u5728 chart \u90e8\u5206\u4e4b\u524d\u88ab\u5b89\u88c5\uff0c\u5e76\u4e14\u4f1a\u53d7\u5230\u4e00\u4e9b\u9650\u5236\u3002CRD YAML \u6587\u4ef6\u5e94\u8be5\u653e\u7f6e chart \u5185\u7684 <code>crds/</code> \u76ee\u5f55\u4e0b\u9762\u3002\u591a\u4e2a CRDs \u53ef\u4ee5\u653e\u5728\u540c\u4e00\u4e2a\u6587\u4ef6\u4e2d\uff0cHelm \u5c06\u5c1d\u8bd5\u5c06 CRD \u76ee\u5f55\u4e2d\u7684\u6240\u6709\u6587\u4ef6\u52a0\u8f7d\u5230 Kubernetes \u4e2d\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f CRD \u6587\u4ef6<code>\u4e0d\u80fd\u6a21\u677f\u5316</code>\uff0c\u5b83\u4eec\u5fc5\u987b\u662f\u7eaf\u7684 YAML \u6587\u4ef6\u3002</p> <p>\u5f53 Helm \u5b89\u88c5\u4e00\u4e2a\u65b0\u7684 chart \u7684\u65f6\u5019\uff0c\u5b83\u5c06\u4f1a\u5b89\u88c5 CRDs\uff0c\u7136\u540e\u4f1a\u6682\u505c\u76f4\u5230 API Server \u63d0\u4f9b CRD \u4e3a\u6b62\uff0c\u7136\u540e\u624d\u5f00\u59cb\u542f\u52a8\u6a21\u677f\u5f15\u64ce\uff0c\u6e32\u67d3\u5176\u4f59\u7684 chart \u6a21\u677f\uff0c\u5e76\u5c06\u5176\u5b89\u88c5\u5230 Kubernetes \u4e2d\u3002\u7531\u4e8e\u8fd9\u4e2a\u5b89\u88c5\u987a\u5e8f\uff0cCRD \u4fe1\u606f\u5728 Helm \u6a21\u677f\u7684 <code>.Capabilities</code> \u5bf9\u8c61\u4e2d\u662f\u53ef\u4ee5\u83b7\u53d6\u5230\u7684\uff0c\u5e76\u4e14 Helm \u6a21\u677f\u53ef\u80fd\u4f1a\u521b\u5efa\u5728 CRD \u4e2d\u58f0\u660e\u7684\u5bf9\u8c61\u7684\u65b0\u5b9e\u4f8b\u3002</p> <p>\u6bd4\u5982\uff0c\u5982\u679c\u4f60\u7684\u5443 chart \u5728 <code>crds</code> \u76ee\u5f55\u4e0b\u9762\u6709\u4e00\u4e2a CronTab \u7684 CRD\uff0c\u5219\u53ef\u4ee5\u5728 <code>templates/</code> \u76ee\u5f55\u4e0b\u9762\u521b\u5efa CronTab \u7c7b\u578b\u7684\u5b9e\u4f8b\uff1a</p> <pre><code>crontabs/\n  Chart.yaml\n  crds/\n    crontab.yaml\n  templates/\n    mycrontab.yaml\n</code></pre> <p><code>crontab.yaml</code> \u6587\u4ef6\u5fc5\u987b\u5305\u542b\u4e0d\u5e26\u6a21\u677f\u6307\u5b9a\u7684 CRD\uff1a</p> <pre><code>kind: CustomResourceDefinition\nmetadata:\n  name: crontabs.stable.example.com\nspec:\n  group: stable.example.com\n  versions:\n    - name: v1\n      served: true\n      storage: true\n  scope: Namespaced\n  names:\n    plural: crontabs\n    singular: crontab\n    kind: CronTab\n</code></pre> <p>\u7136\u540e\u6a21\u677f <code>mycrontab.yaml</code> \u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 CronTab\uff08\u548c\u5e73\u65f6\u4f7f\u7528\u6a21\u677f\u4e00\u6837\uff09\uff1a</p> <pre><code>apiVersion: stable.example.com\nkind: CronTab\nmetadata:\n  name: {{ .Values.name }}\nspec:\n   # ...\n</code></pre> <p>\u5728\u7ee7\u7eed\u5b89\u88c5 <code>templates/</code> \u4e4b\u524d\uff0cHelm \u4f1a\u786e\u4fdd\u5df2\u7ecf\u5b89\u88c5\u4e0a\u4e86 CronTab \u7c7b\u578b\uff0c\u5e76\u4e14\u53ef\u4ee5\u4ece Kubernetes API server \u4e0a\u83b7\u5f97\u8be5\u7c7b\u578b\u3002</p>"},{"location":"kubernetes_package/charts/#crds_1","title":"CRDs \u7684\u9650\u5236","text":"<p>\u4e8e Kubernetes \u4e2d\u7684\u5927\u591a\u6570\u5bf9\u8c61\u4e0d\u540c\uff0cCRDs \u662f\u5168\u5c40\u5b89\u88c5\u7684\uff0c\u6240\u4ee5 Helm \u5728\u7ba1\u7406 CRD \u7684\u65f6\u5019\u6bd4\u8f83\u8c28\u614e\uff0c\u4f1a\u6709\u4e00\u4e9b\u9650\u5236\uff1a</p> <ul> <li>CRDs \u4e0d\u4f1a\u91cd\u65b0\u5b89\u88c5\uff0c\u5982\u679c Helm \u786e\u5b9a <code>crds/</code> \u76ee\u5f55\u4e2d\u7684 CRD \u5df2\u7ecf\u5b58\u5728\uff08\u65e0\u8bba\u7248\u672c\u5982\u4f55\uff09\uff0cHelm \u90fd\u4e0d\u4f1a\u91cd\u65b0\u5b89\u88c5\u6216\u5347\u7ea7\u3002</li> <li>CRDs \u4e0d\u4f1a\u5728\u5347\u7ea7\u6216\u56de\u6eda\u7684\u65f6\u5019\u5b89\u88c5\uff0c\u53ea\u4f1a\u5728\u5b89\u88c5\u64cd\u4f5c\u7684\u65f6\u5019\u521b\u5efa CRDs\u3002</li> <li>CRDs \u4e0d\u4f1a\u88ab\u5220\u9664\uff0c\u5220\u9664 CRD \u4f1a\u81ea\u52a8\u5220\u9664\u96c6\u7fa4\u4e2d\u6240\u6709 namespace \u4e2d\u7684 CRDs \u5185\u5bb9\uff0c\u6240\u4ee5 Helm \u4e0d\u4f1a\u5220\u9664 CRD\u3002</li> </ul> <p>Helm \u5e0c\u671b\u60f3\u8981\u5347\u7ea7\u6216\u5220\u9664 CRDs \u7684\u64cd\u4f5c\u4eba\u5458\u53ef\u4ee5\u624b\u52a8\u6765\u4ed4\u7ec6\u5730\u64cd\u4f5c\u3002</p>"},{"location":"kubernetes_package/charts/#helm_charts","title":"\u4f7f\u7528 Helm \u7ba1\u7406 Charts","text":"<p>helm \u5de5\u5177\u6709\u51e0\u4e2a\u7528\u4e8e\u64cd\u4f5c charts \u7684\u547d\u4ee4\uff0c\u5982\u4e0b\u6240\u793a\u3002</p> <p>\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 chart \u5305\uff1a</p> <pre><code>$ helm create mychart\nCreated mychart/\n</code></pre> <p>\u4e00\u65e6\u4f60\u5df2\u7ecf\u7f16\u8f91\u4e86\u4e00\u4e2a chart \u5305\uff0cHelm \u53ef\u4ee5\u5c06\u5176\u6253\u5305\u5230\u4e00\u4e2a\u72ec\u7acb\u6587\u4ef6\u4e2d\uff1a</p> <pre><code>$ helm package mychart\nArchived mychart--.tgz\n</code></pre> <p>\u4f60\u8fd8\u53ef\u4ee5\u4f7f\u7528 helm \u5e2e\u52a9\u4f60\u67e5\u627e chart \u5305\u7684\u683c\u5f0f\u8981\u6c42\u65b9\u9762\u6216\u5176\u4ed6\u95ee\u9898\uff1a</p> <pre><code>$ helm lint mychart\nNo issues found\n</code></pre>"},{"location":"kubernetes_package/charts/#chart_1","title":"Chart \u4ed3\u5e93","text":"<p>chart \u4ed3\u5e93\u5b9e\u9645\u4e0a\u5c31\u662f\u4e00\u4e2a HTTP \u670d\u52a1\u5668\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e2a\u6216\u591a\u4e2a\u6253\u5305\u7684 chart \u5305\uff0c\u867d\u7136\u53ef\u4ee5\u4f7f\u7528 helm \u6765\u7ba1\u7406\u672c\u5730 chart \u76ee\u5f55\uff0c\u4f46\u662f\u5728\u5171\u4eab charts \u7684\u65f6\u5019\uff0c\u6700\u597d\u7684\u8fd8\u662f\u4f7f\u7528 chart \u4ed3\u5e93\u3002</p> <p>\u53ef\u4ee5\u63d0\u4f9b <code>YAML</code> \u6587\u4ef6\u548c <code>tar</code>\u6587\u4ef6\u5e76\u53ef\u4ee5\u76f8\u5e94 GET \u8bf7\u6c42\u7684\u4efb\u4f55 HTTP \u670d\u52a1\u5668\u90fd\u53ef\u4ee5\u4f5c\u4e3a chart \u4ed3\u5e93\u670d\u52a1\u5668\u3002\u4ed3\u5e93\u7684\u4e3b\u8981\u7279\u5f81\u662f\u5b58\u5728\u4e00\u4e2a\u540d\u4e3a <code>index.yaml</code> \u7684\u7279\u6b8a\u6587\u4ef6\uff0c\u8be5\u6587\u4ef6\u5177\u6709\u4ed3\u5e93\u4e2d\u63d0\u4f9b\u7684\u6240\u6709\u8f6f\u4ef6\u5305\u7684\u5217\u8868\u4ee5\u53ca\u5141\u8bb8\u68c0\u7d22\u548c\u9a8c\u8bc1\u8fd9\u4e9b\u8f6f\u4ef6\u5305\u7684\u5143\u6570\u636e\u3002</p> <p>\u5728\u5ba2\u6237\u7aef\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>helm repo</code> \u547d\u4ee4\u6765\u7ba1\u7406\u4ed3\u5e93\uff0c\u4f46\u662f Helm \u4e0d\u63d0\u4f9b\u7528\u4e8e\u5c06 chart \u4e0a\u4f20\u5230\u8fdc\u7a0b chart \u4ed3\u5e93\u7684\u5de5\u5177\u3002</p>"},{"location":"kubernetes_package/example/","title":"\u793a\u4f8b","text":""},{"location":"kubernetes_package/example/#_1","title":"\u793a\u4f8b","text":"<p>\u524d\u9762\u4ecb\u7ecd\u4e86 Helm \u7684\u57fa\u672c\u4f7f\u7528\uff0c\u4ee5\u53ca Helm Chart \u5305\u5f00\u53d1\u76f8\u5173\u7684\u4e00\u4e9b\u77e5\u8bc6\u70b9\uff0c\u4e0b\u9762\u6211\u4eec\u7528\u4e00\u4e2a\u5b9e\u4f8b\u6765\u6f14\u793a\u4e0b\u5982\u4f55\u5f00\u53d1\u4e00\u4e2a\u771f\u6b63\u7684 Helm Chart \u5305\u3002</p>"},{"location":"kubernetes_package/example/#_2","title":"\u5e94\u7528","text":"<p>\u6211\u4eec\u8fd9\u91cc\u4e3a\u524d\u9762\u7684\u5b8c\u6574\u793a\u4f8b Wordpress \u5f00\u53d1\u4e00\u4e2a Chart \u5305\uff0c\u5728\u5f00\u53d1 Chart \u5305\u4e4b\u524d\u5f88\u660e\u663e\u6211\u4eec\u6700\u9700\u8981\u7684\u5c31\u662f\u8981\u77e5\u9053\u6211\u4eec\u81ea\u5df1\u7684\u5e94\u7528\u5e94\u8be5\u5982\u4f55\u4f7f\u7528\uff0c\u5982\u4f55\u90e8\u7f72\uff0c\u4e0d\u7136\u662f\u4e0d\u53ef\u80fd\u7f16\u5199\u51fa\u5bf9\u5e94\u7684 Chart \u5305\u7684\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u7528 <code>helm create</code> \u547d\u4ee4\u6765\u521b\u5efa\u4e00\u4e2a Chart \u5305\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u5168\u624b\u52a8\u6765\u521b\u5efa\uff0c\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a wordpress \u7684\u6587\u4ef6\u5939:</p> <pre><code>$ mkdir wordpress &amp;&amp; cd wordpress\n</code></pre> <p>\u7136\u540e\u5728\u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684 <code>Chart.yaml</code> \u6587\u4ef6\uff1a</p> <pre><code>apiVersion: v2\nname: wordpress\ndescription: A Helm chart for Kubernetes\nhome: https://wordpress.org/\ntype: application\n# chart \u7248\u672c\u53f7\nversion: 0\n# wordpress \u7684\u5e94\u7528\u7248\u672c\nappVersion: 2\n</code></pre> <p>\u7531\u4e8e Wordpress \u5e94\u7528\u672c\u8eab\u662f\u4e00\u6765 MySQL \u6570\u636e\u5e93\u7684\uff0c\u6240\u4ee5\u540c\u6837\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a\u4f9d\u8d56\u8bf4\u660e <code>requirements.yaml</code>\uff1a</p> <pre><code>dependencies:\n- name: mysql\n  version: 2\n  repository: http://mirror.azure.cn/kubernetes/charts/\n  condition: mysql.enabled\n  tags:\n    - wordpress-database\n</code></pre> <p>\u8fd9\u91cc\u4f9d\u8d56\u7684\u5e94\u7528\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>helm search</code> \u547d\u4ee4\u6765\u83b7\u53d6\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u968f\u610f\u6307\u5b9a\u4e00\u4e2a Chart \u7248\u672c\uff1a</p> <pre><code>$ helm search repo stable/mysql\nNAME                    CHART VERSION   APP VERSION     DESCRIPTION                                       \nstable/mysql            2           28          Fast, reliable, scalable, and easy to use open-...\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u4f9d\u8d56\u7684\u6587\u4ef6\u4e2d\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a </p> <pre><code>condition: mysql.enabled\n</code></pre> <p>\u6761\u4ef6\uff0c\u8fd9\u610f\u5473\u7740\u5f53 Values \u503c <code>mysql.enabled</code> \u4e3a true \u7684\u65f6\u5019\u624d\u4f1a\u771f\u6b63\u53bb\u4f9d\u8d56\u8fd9\u4e2a\u5b50 Chart\uff0c\u56e0\u4e3a\u6211\u4eec\u5b8c\u5168\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u4e00\u4e2a\u5916\u90e8\u7684\u6570\u636e\u5e93\u3002\u6240\u4ee5\u9996\u5148\u6211\u4eec\u8981\u5148\u6dfb\u52a0\u4e00\u4e2a <code>mysql.enabled</code> \u7684 Values \u503c\uff0c\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684 <code>values.yaml</code> \u6587\u4ef6\uff1a</p> <pre><code>##\n## MySQL Chart \u914d\u7f6e\uff0c\u53c2\u8003\u5982\u4e0b values.yaml\n## https://github.com/helm/charts/blob/master/stable/mysql/values.yaml\n##\nmysql:\n  ## \u662f\u5426\u90e8\u7f72mysql\u670d\u52a1\u6765\u6ee1\u8db3wordpress\u7684\u9700\u6c42\u3002\u5982\u679c\u8981\u4f7f\u7528\u5916\u90e8\u6570\u636e\u5e93\uff0c\u5c06 enabled \u8bbe\u7f6e\u4e3a false \u5e76\u914d\u7f6e externalDatabase \u53c2\u6570\u3002\n  enabled: true\n  ## todo\uff0c\u5176\u4ed6 mysql \u914d\u7f6e\n\n## \u5f53 mysql.enabled=false \u7684\u65f6\u5019\u4f7f\u7528\u5916\u90e8\u6570\u636e\u5e93\nexternalDatabase:\n  ## \u6570\u636e\u5e93\u5730\u5740\n  host: localhost:3306\n\n  ## Wordpress \u6570\u636e\u5e93\u7684\u975eroot\u7528\u6237\n  user: wordpress\n\n  ## \u6570\u636e\u5e93\u5bc6\u7801\n  password: wordpress\n\n  ## \u6570\u636e\u5e93\u540d\u79f0\n  database: wordpress\n</code></pre> <p>\u4e0a\u9762\u7684 Values \u914d\u7f6e\u5f88\u597d\u7406\u89e3\uff0c\u5c31\u662f\u5982\u679c <code>mysql.enabled=true</code> \u5219\u6211\u4eec\u5c31\u7528 mysql \u8fd9\u4e2a\u5b50 Chart \u53bb\u5b89\u88c5\u4e00\u4e2a MySQL \u6570\u636e\u5e93\uff0c\u5982\u679c\u4e3a false \u5219\u4f7f\u7528\u4e0b\u9762 <code>externalDatabase</code> \u7684\u5916\u90e8\u6570\u636e\u5e93\u4fe1\u606f\u6765\u4f5c\u4e3a wordpress \u7684\u6570\u636e\u5e93\u914d\u7f6e\uff0c\u867d\u7136\u73b0\u5728\u8fd9\u4e9b\u914d\u7f6e\u8fd8\u5b8c\u5168\u6ca1\u6709\u4efb\u4f55\u4f5c\u7528\uff0c\u4f46\u662f\u8fd9\u4e9b\u5374\u662f\u4e00\u5f00\u59cb\u5c31\u5f88\u5bb9\u6613\u8003\u8651\u5230\u7684\u4e8b\u60c5\u3002</p> <p>\u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a <code>templates</code> \u548c <code>charts</code> \u76ee\u5f55\uff0c\u5e76\u5728 <code>charts</code> \u76ee\u5f55\u4e0b\u9762\u83b7\u53d6 mysql \u8fd9\u4e2a\u5b50 chart:</p> <pre><code>$ mkdir templates &amp;&amp; mkdir charts\n$ cd charts &amp;&amp; helm fetch stable/mysql &amp;&amp; cd ..\n</code></pre> <p>\u73b0\u5728\u7684\u6574\u4e2a Chart \u5305\u76ee\u5f55\u7ed3\u6784\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ tree .\n.\n\u251c\u2500\u2500 Chart.yaml\n\u251c\u2500\u2500 charts\n\u2502   \u2514\u2500\u2500 mysql-tgz\n\u251c\u2500\u2500 requirements.yaml\n\u251c\u2500\u2500 templates\n\u2514\u2500\u2500 values.yaml\n\n2 directories, 4 files\n</code></pre> <p>\u63a5\u4e0b\u6765\u5c31\u662f\u6211\u4eec\u7684\u91cd\u5934\u620f\u6a21\u677f\u7684\u5f00\u53d1\u4e86\u3002\u6211\u4eec\u53ef\u4ee5\u5c06\u524d\u9762\u8bfe\u7a0b\u793a\u4f8b\u4e2d\u7684 Wordpress \u8d44\u6e90\u6e05\u5355\u76f4\u63a5\u62f7\u8d1d\u5230 <code>templates</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u5c06 <code>Deployment</code> \u548c <code>Service</code> \u5206\u522b\u653e\u5728\u4e0d\u540c\u7684 YAML \u6587\u4ef6\u4e2d\uff0c\u540c\u6837\u8fd8\u6709\u6570\u636e\u6301\u4e45\u5316\u7684\u8d44\u6e90\u6e05\u5355\uff0c\u4f46\u662f\u8fd9\u91cc\u6211\u4eec\u5c31\u9700\u8981\u5148\u5c06 MySQL \u7684\u90e8\u5206\u79fb\u9664\u6389\uff0c\u56e0\u4e3a\u6211\u4eec\u4f1a\u901a\u8fc7\u5916\u90e8\u6570\u636e\u5e93\u6216\u8005\u5b50 Chart \u6765\u6e32\u67d3\uff0c\u4e0d\u9700\u8981\u5728\u8fd9\u91cc\u663e\u793a\u7684\u58f0\u660e\u4e86\uff0c\u53e6\u5916\u8fd8\u9700\u8981\u5c06\u6240\u6709\u8d44\u6e90\u5bf9\u8c61\u7684\u547d\u540d\u7a7a\u95f4\u53bb\u6389\uff0c\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>helm install</code> \u547d\u4ee4\u76f4\u63a5\u6307\u5b9a\u5373\u53ef\uff0c\u73b0\u5728\u6211\u4eec\u7684\u6a21\u677f\u76ee\u5f55\u7ed3\u6784\u5c31\u5982\u4e0b\u6240\u793a\u4e86\uff1a</p> <pre><code>$ tree templates \ntemplates\n\u251c\u2500\u2500 deployment.yaml\n\u251c\u2500\u2500 pvc.yaml\n\u2514\u2500\u2500 service.yaml\n\n0 directories, 4 files\n</code></pre>"},{"location":"kubernetes_package/example/#_3","title":"\u540d\u79f0","text":"<p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u53bb\u5b89\u88c5\u8c03\u8bd5\u4e0b\u8fd9\u4e2a Chart \u6a21\u677f\uff1a</p> <pre><code>$ helm install --generate-name --dry-run --debug .\ninstall.go:148: [debug] Original chart version: \"\"\ninstall.go:165: [debug] CHART PATH: /Users/ych/devs/workspace/yidianzhishi/course/k8strain/content/helm/manifests/wordpress\n\nload.go:112: Warning: Dependencies are handled in Chart.yaml since apiVersion \"v2\". We recommend migrating dependencies to Chart.yaml.\nError: rendered manifests contain a resource that already exists. Unable to continue with install: existing resource conflict: kind: Middleware, namespace: default, name: redirect-https\nhelm.go:76: [debug] existing resource conflict: kind: Middleware, namespace: default, name: redirect-https\nrendered manifests contain a resource that already exists. Unable to continue with install\nhelm.sh/helm/v3/pkg/action.(*Install).Run\n        /home/circleci/helm.sh/helm/pkg/action/install.go:242\nmain.runInstall\n        /home/circleci/helm.sh/helm/cmd/helm/install.go:209\nmain.newInstallCmd.func1\n        /home/circleci/helm.sh/helm/cmd/helm/install.go:115\ngithub.com/spf13/cobra.(*Command).execute\n        /go/pkg/mod/github.com/spf13/cobra@v5/command.go:826\ngithub.com/spf13/cobra.(*Command).ExecuteC\n        /go/pkg/mod/github.com/spf13/cobra@v5/command.go:914\ngithub.com/spf13/cobra.(*Command).Execute\n        /go/pkg/mod/github.com/spf13/cobra@v5/command.go:864\nmain.main\n        /home/circleci/helm.sh/helm/cmd/helm/helm.go:75\nruntime.main\n        /usr/local/go/src/runtime/proc.go:203\nruntime.goexit\n        /usr/local/go/src/runtime/asm_amds:1357\n</code></pre> <p>\u6211\u4eec\u770b\u5230\u51fa\u73b0\u4e86\u9519\u8bef\uff0c\u5176\u4e2d\u8fd8\u6709\u8fd9\u6837\u7684\u4e00\u6761\u8b66\u544a\u4fe1\u606f </p> <pre><code>load.go:112: Warning: Dependencies are handled in Chart.yaml since apiVersion \"v2\". We recommend migrating dependencies to Chart.yaml.\n</code></pre> <p>\uff0c\u5927\u6982\u610f\u601d\u5c31\u662f\u5728 Helm3 \u4e2d\u4f9d\u8d56\u9879\u7684\u914d\u7f6e\u88ab\u79fb\u52a8\u5230\u4e86 <code>Chart.yaml</code> \u6587\u4ef6\u4e2d\uff0c\u4e5f\u5c31\u662f\u5728 Helm2 \u7248\u672c\u7684\u65f6\u5019\u4f9d\u8d56\u624d\u4f1a\u5728 <code>requirements.yaml</code> \u4e2d\u58f0\u660e\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u5c06 <code>requirements.yaml</code> \u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\u5168\u90e8\u62f7\u8d1d\u5230 <code>Chart.yaml</code> \u6587\u4ef6\u4e2d\u53bb\uff0c\u7136\u540e\u5220\u9664 <code>requirements.yaml</code> \u6587\u4ef6\uff0c\u8fd9\u4e2a\u65f6\u5019\u91cd\u65b0 DEBUG \u4e0b\u5c31\u6ca1\u6709\u8fd9\u4e2a\u63d0\u793a\u4fe1\u606f\u4e86\u3002</p> <p>\u4e0b\u9762\u7684\u9519\u8bef\u63d0\u793a\u57fa\u672c\u4e0a\u90fd\u662f\u7c7b\u4f3c\u4e8e </p> <pre><code>rendered manifests contain a resource that already exists.\n</code></pre> <p>\u8fd9\u6837\u7684\u4fe1\u606f\uff0c\u610f\u601d\u5c31\u662f\u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u5728\u73b0\u6709\u96c6\u7fa4\u4e2d\u5df2\u7ecf\u5305\u542b\u4e86\uff0c\u8fd9\u5f88\u6b63\u5e38\uff0c\u56e0\u4e3a\u6211\u4eec\u7684\u8d44\u6e90\u5bf9\u8c61\u540d\u79f0\u90fd\u662f\u5199\u6b7b\u7684\uff0c\u662f\u975e\u5e38\u6709\u53ef\u80fd\u548c\u73b0\u6709\u7684\u96c6\u7fa4\u51b2\u7a81\u7684\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u6211\u4eec\u8981\u7ed9\u8fd9\u4e9b\u8d44\u6e90\u6e05\u5355\u6539\u540d\uff0c\u5982\u4f55\u624d\u80fd\u907f\u514d\u51b2\u7a81\u53c8\u5177\u6709\u5f88\u597d\u7684\u6269\u5c55\u6027\u5462\uff1f\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u547d\u540d\u6a21\u677f\uff1a</p> <pre><code>{{/*\n\u521b\u5efa\u4e00\u4e2a\u9ed8\u8ba4\u7684\u5e94\u7528\u540d\u79f0\uff0c\u622a\u53d663\u4e2a\u5b57\u7b26\u662f\u56e0\u4e3a Kubernetes \u7684 name \u5c5e\u6027\u7684\u9650\u5236\uff08DNS \u547d\u540d\u89c4\u8303\uff09\u3002\n*/}}\n{{- define \"wordpress.fullname\" -}}\n{{- if .Values.fullnameOverride -}}\n{{- .Values.fullnameOverride | trunc 63 | trimSuffix \"-\" -}}\n{{- else -}}\n{{- $name := default .Chart.Name .Values.nameOverride -}}\n{{- if contains $name .Release.Name -}}\n{{- .Release.Name | trunc 63 | trimSuffix \"-\" -}}\n{{- else -}}\n{{- printf \"%s-%s\" .Release.Name $name | trunc 63 | trimSuffix \"-\" -}}\n{{- end -}}\n{{- end -}}\n{{- end -}}\n</code></pre> <p>\u6839\u636e\u89c4\u8303\u547d\u540d\u6a21\u677f\u7684\u540d\u79f0\u6700\u597d\u4ee5 Chart \u540d\u4f5c\u4e3a\u524d\u7f00\uff0c\u8fd9\u91cc\u6211\u4eec\u547d\u540d\u6210 <code>wordpress.fullname</code>\uff0c\u9996\u5148\u5c31\u662f\u5224\u65ad\u662f\u5426\u5b9a\u4e49\u4e86 <code>fullnameOverride</code> \u8fd9\u4e2a Values \u503c\uff0c\u5982\u679c\u5b9a\u4e49\u4e86\u5219\u622a\u53d6 63 \u4e2a\u5b57\u7b26\u5e76\u79fb\u9664 <code>-</code> \u8fd9\u6837\u7684\u524d\u540e\u7f00\u4f5c\u4e3a\u540d\u79f0\uff0c\u5982\u679c\u6ca1\u6709\u5b9a\u4e49\u5462\uff1f\u5c31\u8981\u68c0\u67e5 Chart \u540d\u662f\u5426\u5305\u542b Release \u540d\u79f0\uff0c\u5982\u679c\u5305\u542b\u5219\u622a\u53d6 Release \u540d\u7684 63 \u4e2a\u5b57\u7b26\u5e76\u79fb\u9664 <code>-</code> \u8fd9\u6837\u7684\u524d\u540e\u7f00\u4f5c\u4e3a\u540d\u79f0\uff0c\u5982\u679c\u4e0d\u5305\u542b\uff0c\u5219\u5c06 Release \u540d\u79f0\u548c Chart \u540d\u79f0\u7528 <code>-</code> \u8fde\u63a5\u8d77\u6765\u4f5c\u4e3a\u540d\u79f0\uff0c\u8fd9\u4e2a\u547d\u540d\u7684\u65b9\u5f0f\u4e5f\u662f\u7b26\u5408\u5927\u90e8\u5206 Chart \u6a21\u677f\u4e2d\u7684\u547d\u540d\uff0c\u4ee5\u540e\u7684\u6a21\u677f\u5f00\u53d1\u4e2d\u90fd\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u3002\u5728 <code>templates</code> \u76ee\u5f55\u4e0b\u9762\u65b0\u5efa\u4e00\u4e2a <code>_helpers.tpl</code> \u8fd9\u6837\u7684 partials \u6587\u4ef6\uff0c\u7136\u540e\u5c06\u4e0a\u9762\u5b9a\u4e49\u7684\u547d\u540d\u6a21\u677f\u653e\u7f6e\u5230\u91cc\u9762\u53bb\u3002\u540e\u9762\u6211\u4eec\u6240\u6709\u7684\u547d\u540d\u6a21\u677f\u90fd\u5c06\u5728\u8be5\u6587\u4ef6\u4e2d\u5b8c\u6210\u3002</p> <p>\u63a5\u4e0b\u6765\u5c06 <code>templates</code> \u76ee\u5f55\u4e0b\u9762\u7684\u6240\u6709\u8d44\u6e90\u5bf9\u8c61 name \u5c5e\u6027\u5168\u90fd\u6362\u6210\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u7684\u547d\u540d\u6a21\u677f\uff0c\u7531\u4e8e\u8fd9\u91cc\u5e76\u6ca1\u6709\u4ec0\u4e48\u7a7a\u683c\u63a7\u5236\u4e4b\u7c7b\u7684\uff0c\u6211\u4eec\u76f4\u63a5\u4f7f\u7528 <code>template</code> \u51fd\u6570\u5373\u53ef\uff0c\u540c\u6837\u4f5c\u4e3a\u60ef\u4f8b\uff0c\u4e5f\u4e60\u60ef\u5c06 Release \u548c Chart \u540d\u79f0\u4e4b\u7c7b\u4f5c\u4e3a Label \u6807\u7b7e\uff0c\u6240\u4ee5\u6700\u7ec8\uff0c\u8fd9\u4e9b\u8d44\u6e90\u6e05\u5355\u7684 Meta \u4fe1\u606f\u5982\u4e0b\u6240\u793a\uff0c\u5982\u679c\u6709\u5176\u4ed6\u989d\u5916\u7684\u4fe1\u606f\u5f53\u7136\u53ef\u4ee5\u968f\u610f\u6dfb\u52a0\uff1a</p> <pre><code>metadata:\n  name: {{ template \"wordpress.fullname\" . }}\n  labels:\n    app: \"{{ template \"wordpress.fullname\" . }}\"\n    chart: \"{{ template \"wordpress.chart\" . }}\"\n    release: {{ .Release.Name | quote }}\n    heritage: {{ .Release.Service | quote }}\n</code></pre> <p>\u7136\u540e\u5f53\u7136\u4e5f\u9700\u8981\u5c06 Deployment \u7684 matchLabels \u548c template \u4e0b\u9762\u7684 Label \u6807\u7b7e\u8fdb\u884c\u4fee\u6539\uff0c\u4ee5\u53ca Service \u7684 <code>selector</code> \u5339\u914d\u7684\u6807\u7b7e\u3002</p> <p>\u540c\u6837\u8fd8\u6709 PVC \u5bf9\u8c61\uff0c\u4ee5\u524d\u6211\u4eec\u76f4\u63a5\u4f7f\u7528\u7684\u4e00\u4e2a\u786e\u5b9a\u540d\u79f0\u7684 PVC \u5bf9\u8c61\uff1a</p> <pre><code>volumes:\n- name: wordpress-data\n  persistentVolumeClaim:\n    claimName: wordpress-pvc\n</code></pre> <p>\u4f46\u662f\u73b0\u5728\u6211\u4eec\u8fd9\u91cc\u4f5c\u4e3a\u6a21\u677f\u5c31\u8981\u8003\u8651\u5230\u5404\u79cd\u60c5\u51b5\u4e86\uff0c\u5f88\u6709\u53ef\u80fd\u4f7f\u7528\u6211\u4eec\u6a21\u677f\u7684\u7528\u6237\u6839\u672c\u5c31\u4e0d\u9700\u8981\u6301\u4e45\u5316\uff0c\u4e5f\u6709\u53ef\u80fd\u76f4\u63a5\u4f20\u9012\u4e00\u4e2a\u5b58\u5728\u7684 PVC \u5bf9\u8c61\u8fdb\u6765\u4f7f\u7528\uff0c\u6240\u4ee5\u8fd9\u91cc\u505a\u4e86\u5982\u4e0b\u6539\u53d8\uff1a</p> <pre><code>volumes:\n- name: wordpress-data\n{{- if .Values.persistence.enabled }}\n  persistentVolumeClaim:\n    claimName: {{ .Values.persistence.existingClaim | default (include \"wordpress.fullname\" .) }}\n{{- else }}\n  emptyDir: {}\n{{ end }}\n</code></pre> <p>\u5f53\u6211\u4eec\u5b9a\u4e49\u4e86 Values \u503c </p> <pre><code>persistence.enabled=true\n</code></pre> <p>\u4e3a true \u65f6\u5019\u5c31\u8868\u793a\u8981\u4f7f\u7528\u6301\u4e45\u5316\u4e86\uff0c\u6240\u4ee5\u8981\u6307\u5b9a\u4e0b\u9762\u7684 <code>claimName</code> \u5c5e\u6027\uff0c\u4f46\u662f\u8fd8\u9700\u8981\u5224\u65ad </p> <pre><code>persistence.existingClaim\n</code></pre> <p>\u8fd9\u4e2a Values \u503c\u662f\u5426\u5b58\u5728\uff0c\u5982\u679c\u5b58\u5728\u5219\u8868\u793a\u76f4\u63a5\u4f7f\u7528\uff0c\u5982\u679c\u4e0d\u5b58\u5728\u5219\u4f7f\u7528\u6211\u4eec\u6a21\u677f\u91cc\u9762\u6e32\u67d3\u7684 PVC \u5bf9\u8c61\uff0c\u5982\u679c\u4e0d\u9700\u8981\u6301\u4e45\u5316\uff0c\u5219\u76f4\u63a5\u4f7f\u7528 <code>emptyDir:{}</code> \u5373\u53ef\u3002\u6700\u540e\u6211\u4eec\u7684 PVC \u5bf9\u8c61\u6a21\u677f\u53d8\u6210\u4e86\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>{{- if and .Values.persistence.enabled (not .Values.persistence.existingClaim) }}\nkind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\n  name: {{ template \"wordpress.fullname\" . }}\n  labels:\n    app: \"{{ template \"wordpress.fullname\" . }}\"\n    chart: \"{{ template \"wordpress.chart\" . }}\"\n    release: {{ .Release.Name | quote }}\n    heritage: {{ .Release.Service | quote }}\nspec:\n  {{- if .Values.persistence.storageClass }}\n  storageClassName: {{ .Values.persistence.storageClass | quote }}\n  {{- end }}\n  accessModes:\n  - {{ .Values.persistence.accessMode | quote }}\n  resources:\n    requests:\n      storage: {{ .Values.persistence.size | quote }}\n{{- end -}}\n</code></pre> <p>\u5176\u4e2d\u8bbf\u95ee\u6a21\u5f0f\u3001\u5b58\u50a8\u5bb9\u91cf\u3001StorageClass\u3001\u5b58\u5728\u7684 PVC \u90fd\u901a\u8fc7 Values \u6765\u6307\u5b9a\uff0c\u589e\u52a0\u4e86\u7075\u6d3b\u6027\u3002\u5bf9\u5e94\u7684 <code>values.yaml</code> \u914d\u7f6e\u90e8\u5206\u6211\u4eec\u53ef\u4ee5\u7ed9\u4e00\u4e2a\u9ed8\u8ba4\u7684\u914d\u7f6e\uff1a</p> <pre><code>## \u662f\u5426\u4f7f\u7528 PVC \u5f00\u542f\u6570\u636e\u6301\u4e45\u5316\npersistence:\n  enabled: true\n  ## \u662f\u5426\u4f7f\u7528 storageClass\uff0c\u5982\u679c\u4e0d\u9002\u7528\u5219\u8865\u914d\u7f6e\n  # storageClass: \"xxx\"\n  ##\n  ## \u5982\u679c\u60f3\u4f7f\u7528\u4e00\u4e2a\u5b58\u5728\u7684 PVC \u5bf9\u8c61\uff0c\u5219\u76f4\u63a5\u4f20\u9012\u7ed9\u4e0b\u9762\u7684 existingClaim \u53d8\u91cf\n  # existingClaim: your-claim\n  accessMode: ReadWriteMany  # \u8bbf\u95ee\u6a21\u5f0f\n  size: 2Gi  # \u5b58\u50a8\u5bb9\u91cf\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53bb\u91cd\u65b0\u505a\u4e00\u6b21 DEBUG\uff0c\u53ef\u4ee5\u770b\u5230\u6b63\u5e38\u4e86\uff0c\u4f46\u662f\u8fd8\u8fdc\u8fdc\u4e0d\u591f\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5b9a\u5236\u5176\u4ed6\u90e8\u5206\u3002</p>"},{"location":"kubernetes_package/example/#_4","title":"\u5b9a\u5236","text":"<p>\u6bd4\u5982\u526f\u672c\u6570\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Values \u6765\u6307\u5b9a\uff0c\u53d8\u6210 </p> <pre><code>replicas: {{ .Values.replicaCount }}\n</code></pre> <p>\u3002</p> <p>\u66f4\u65b0\u7b56\u7565\u4e5f\u53ef\u4ee5\uff0c\u56e0\u4e3a\u66f4\u65b0\u7b56\u7565\u5e76\u4e0d\u662f\u4e00\u5c42\u4e0d\u53d8\u7684\uff0c\u8fd9\u91cc\u548c\u4e4b\u524d\u4e0d\u592a\u4e00\u6837\uff0c\u6211\u4eec\u9700\u8981\u7528\u5230\u4e00\u4e2a\u65b0\u7684\u51fd\u6570 <code>toYaml</code>\uff1a</p> <pre><code>{{- if .Values.updateStrategy }}\nstrategy: {{ toYaml .Values.updateStrategy | nindent 4 }}\n{{- end }}\n</code></pre> <p>\u610f\u601d\u5c31\u662f\u6211\u4eec\u5c06 <code>updateStrategy</code> \u8fd9\u4e2a Values \u503c\u8f6c\u6362\u6210 YAML \u683c\u5f0f\uff0c\u5e76\u4fdd\u75594\u4e2a\u7a7a\u683c\u3002\u7136\u540e\u6dfb\u52a0\u5176\u4ed6\u7684\u914d\u7f6e\uff0c\u6bd4\u5982\u662f\u5426\u9700\u8981\u6dfb\u52a0 nodeSelector\u3001\u5bb9\u5fcd\u3001\u4eb2\u548c\u6027\u8fd9\u4e9b\uff0c\u8fd9\u91cc\u6211\u4eec\u90fd\u662f\u4f7f\u7528 <code>toYaml</code> \u51fd\u6570\u6765\u63a7\u5236\u7a7a\u683c\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>{{- if .Values.nodeSelector }}\n    nodeSelector:\n{{ toYaml .Values.nodeSelector | indent 8 }}\n    {{- end -}}\n  {{- with .Values.affinity }}\n    affinity:\n{{ toYaml . | indent 8 }}\n  {{- end }}\n  {{- with .Values.tolerations }}\n    tolerations:\n{{ toYaml . | indent 8 }}\n  {{- end }}\n</code></pre> <p>\u63a5\u4e0b\u6765\u5f53\u7136\u5c31\u662f\u955c\u50cf\u7684\u914d\u7f6e\u4e86\uff0c\u5982\u679c\u662f\u79c1\u6709\u4ed3\u5e93\u8fd8\u9700\u8981\u6307\u5b9a <code>imagePullSecrets</code>\uff1a</p> <pre><code>{{- if .Values.image.pullSecrets }}\nimagePullSecrets:\n{{- range .Values.image.pullSecrets }}\n- name: {{ . }}\n{{- end }}\n{{- end }}\ncontainers:\n- name: wordpress\n  image: {{ printf \"%s:%s\" .Values.image.name .Values.image.tag }}\n  imagePullPolicy: {{ .Values.image.pullPolicy | quote }}\n  ports:\n  - containerPort: 80\n    name: web\n</code></pre> <p>\u5bf9\u5e94\u7684 Values \u503c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>image:\n  name: wordpress\n  tag: 2-apache\n  ## \u6307\u5b9a imagePullPolicy \u9ed8\u8ba4\u4e3a Always\n  pullPolicy: IfNotPresent\n  ## \u5982\u679c\u662f\u79c1\u6709\u4ed3\u5e93\uff0c\u9700\u8981\u6307\u5b9a imagePullSecrets\n  # pullSecrets:\n  #   - myRegistryKeySecretName\n</code></pre> <p>\u7136\u540e\u5c31\u662f\u6700\u91cd\u8981\u7684\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u90e8\u5206\u4e86\uff0c\u56e0\u4e3a\u6d89\u53ca\u5230\u6570\u636e\u5e93\u7684\u914d\u7f6e\uff0c\u540c\u6837\u6700\u6838\u5fc3\u7684\u4e09\u4e2a\u73af\u5883\u53d8\u91cf\u914d\u7f6e <code>WORDPRESS_DB_HOST</code>\u3001<code>WORDPRESS_DB_USER</code>\u3001</p> <pre><code>WORDPRESS_DB_PASSWORD\n</code></pre> <p>\uff0c\u7531\u4e8e\u53ef\u80fd\u4f7f\u7528\u6211\u4eec\u6a21\u677f\u7684\u7528\u6237\u53ef\u80fd\u4f7f\u7528\u5916\u90e8\u6570\u636e\u5e93\uff0c\u4e5f\u6709\u53ef\u80fd\u4f7f\u7528\u6211\u4eec\u4f9d\u8d56\u7684 mysql \u8fd9\u4e2a\u5b50 Chart\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5206\u522b\u5224\u65ad\u6765\u8fdb\u884c\u6e32\u67d3\uff1a</p> <pre><code>env:\n- name: WORDPRESS_DB_HOST\n{{- if .Values.mysql.enabled }}\n  value: {{ printf \"%s:%d\" (include \"mysql.fullname\" .) (int64 .Values.mysql.service.port) }}\n{{- else }}\n  value: {{ .Values.externalDatabase.host | quote }}\n{{- end }}\n- name: WORDPRESS_DATABASE_NAME\n{{- if .Values.mysql.enabled }}\n  value: {{ .Values.mysql.mysqlDatabase | quote }}\n{{- else }}\n  value: {{ .Values.externalDatabase.database | quote }}\n{{- end }}\n- name: WORDPRESS_DB_USER\n{{- if .Values.mysql.enabled }}\n  value: {{ .Values.mysql.mysqlUser | quote }}\n{{- else }}\n  value: {{ .Values.externalDatabase.user | quote }}\n{{- end }}\n- name: WORDPRESS_DB_PASSWORD\n  valueFrom:\n    secretKeyRef:\n    {{- if .Values.mysql.enabled }}\n      name: {{ template \"mysql.fullname\" . }}\n      key: mysql-password\n    {{- else }}\n      name: {{ printf \"%s-%s\" .Release.Name \"externaldb\" }}\n      key: db-password\n    {{- end }}\n</code></pre> <p>\u6bcf\u4e00\u4e2a\u73af\u5883\u53d8\u91cf\u9996\u5148\u90fd\u662f\u5224\u65ad <code>mysql.enabled</code> \u662f\u5426\u4e3a true\uff0c\u624d\u8868\u793a\u4f7f\u7528\u5b50 Chart \u6765\u6e32\u67d3\uff0c\u800c\u5bf9\u5e94\u7684\u503c\u90fd\u662f\u5b50 Chart \u4e2d\u6e32\u67d3\u8fc7\u540e\u7684\u503c\uff0c\u6240\u4ee5\u4e5f\u9700\u8981\u6211\u4eec\u53bb\u4e86\u89e3\u5b50 Chart \u7684\u6e32\u67d3\u884c\u4e3a\uff0c\u5982\u679c\u4f7f\u7528\u5916\u90e8\u7684\u6570\u636e\u5e93\u5c31\u8981\u7b80\u5355\u5f88\u591a\uff0c\u56e0\u4e3a\u53ea\u9700\u8981\u8bfb\u53d6 Values \u503c\u5373\u53ef\u3002\u53e6\u5916\u4e00\u4e2a\u503c\u5f97\u6ce8\u610f\u7684\u662f\u5982\u679c\u662f\u914d\u7f6e\u7684\u5bc6\u7801\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u53bb\u521b\u5efa\u4e00\u4e2a Secret \u8d44\u6e90\u5bf9\u8c61\u6765\u5f15\u7528\u3002\u6240\u4ee5\u6211\u4eec\u5728 templates \u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u4e86\u4e00\u4e2a </p> <pre><code>externaldb-secrets.yaml\n</code></pre> <p>\u7684\u8d44\u6e90\u6587\u4ef6\uff0c\u91cc\u9762\u914d\u7f6e\u7684\u5bc6\u7801\u901a\u8fc7 <code>b64enc</code> \u51fd\u6570\u8f6c\u6362\u4e3a Base64 \u7f16\u7801\u683c\u5f0f\u3002</p> <pre><code>{{- if not .Values.mysql.enabled }}\napiVersion: v1\nkind: Secret\nmetadata:\n  name: {{ printf \"%s-%s\" .Release.Name \"externaldb\"  }}\n  labels:\n    app: {{ printf \"%s-%s\" .Release.Name \"externaldb\"  }}\n    chart: \"{{ template \"wordpress.chart\" . }}\"\n    release: {{ .Release.Name | quote }}\n    heritage: {{ .Release.Service | quote }}\ntype: Opaque\ndata:\n  db-password: {{ .Values.externalDatabase.password | b64enc | quote }}\n{{- end }}\n</code></pre> <p>\u7136\u540e\u5c31\u662f resource \u8d44\u6e90\u58f0\u660e\uff0c\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u9ed8\u8ba4\u7684 resources \u503c\uff0c\u540c\u6837\u7528 <code>toYaml</code> \u51fd\u6570\u6765\u63a7\u5236\u7a7a\u683c\uff1a</p> <pre><code>resources:\n{{ toYaml .Values.resources | indent 10 }}\n</code></pre> <p>\u6700\u540e\u662f\u5065\u5eb7\u68c0\u67e5\u90e8\u5206\uff0c\u867d\u7136\u6211\u4eec\u4e4b\u524d\u6ca1\u6709\u505a livenessProbe\uff0c\u4f46\u662f\u6211\u4eec\u5f00\u53d1 Chart \u6a21\u677f\u7684\u65f6\u5019\u5c31\u8981\u5c3d\u53ef\u80fd\u8003\u8651\u5468\u5168\u4e00\u70b9\uff0c\u8fd9\u91cc\u6211\u4eec\u52a0\u4e0a\u5b58\u6d3b\u6027\u548c\u53ef\u8bfb\u6027\u4e24\u4e2a\u63a2\u9488\uff0c\u5e76\u4e14\u6839\u636e </p> <pre><code>livenessProbe.enabled\n</code></pre> <p>\u548c </p> <pre><code>readinessProbe.enabled\n</code></pre> <p>\u4e24\u4e2a Values \u503c\u6765\u5224\u65ad\u662f\u5426\u9700\u8981\u6dfb\u52a0\u63a2\u9488\uff0c\u63a2\u9488\u5bf9\u5e94\u7684\u53c2\u6570\u4e5f\u90fd\u901a\u8fc7 Values \u503c\u6765\u914d\u7f6e\uff1a</p> <pre><code>{{- if .Values.livenessProbe.enabled }}\nlivenessProbe:\n  initialDelaySeconds: {{ .Values.livenessProbe.initialDelaySeconds }}\n  periodSeconds: {{ .Values.livenessProbe.periodSeconds }}\n  timeoutSeconds: {{ .Values.livenessProbe.timeoutSeconds }}\n  successThreshold: {{ .Values.livenessProbe.successThreshold }}\n  failureThreshold: {{ .Values.livenessProbe.failureThreshold }}\n  httpGet:\n    path: /wp-login.php\n    port: 80\n{{- end }}\n{{- if .Values.readinessProbe.enabled }}\nreadinessProbe:\n  initialDelaySeconds: {{ .Values.readinessProbe.initialDelaySeconds }}\n  periodSeconds: {{ .Values.readinessProbe.periodSeconds }}\n  timeoutSeconds: {{ .Values.readinessProbe.timeoutSeconds }}\n  successThreshold: {{ .Values.readinessProbe.successThreshold }}\n  failureThreshold: {{ .Values.readinessProbe.failureThreshold }}\n  httpGet:\n    path: /wp-login.php\n    port: 80\n{{- end }}\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u7684 Deployment \u7684\u6a21\u677f\u5c31\u57fa\u672c\u4e0a\u5b8c\u6210\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 DEBUG \u6a21\u5f0f\u6765\u6a21\u62df\u6e32\u67d3\uff1a</p> <pre><code>$ helm install --generate-name --dry-run --debug .\n</code></pre> <p>\u53ef\u4ee5\u6839\u636e\u7ed3\u679c\u6765\u5224\u65ad\u662f\u5426\u7b26\u5408\u6211\u4eec\u7684\u9700\u6c42\u3002</p> <p>\u6700\u540e\u6211\u4eec\u8fd8\u9700\u8981\u6765\u5bf9 Service \u5bf9\u8c61\u505a\u6a21\u677f\u5316\uff0c\u56e0\u4e3a\u524d\u9762\u6211\u4eec\u662f\u9ed8\u8ba4\u7684 <code>NodePort</code> \u7c7b\u578b\uff0c\u6211\u4eec\u9700\u8981\u901a\u8fc7 Values \u6765\u5b9a\u5236\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: {{ template \"wordpress.fullname\" . }}\n  labels:\n    app: \"{{ template \"wordpress.fullname\" . }}\"\n    chart: \"{{ template \"wordpress.chart\" . }}\"\n    release: {{ .Release.Name | quote }}\n    heritage: {{ .Release.Service | quote }}\nspec:\n  selector:\n    app: \"{{ template \"wordpress.fullname\" . }}\"\n  type: {{ .Values.service.type }}\n  {{- if (or (eq .Values.service.type \"LoadBalancer\") (eq .Values.service.type \"NodePort\")) }}\n  externalTrafficPolicy: {{ .Values.service.externalTrafficPolicy | quote }}\n  {{- end }}\n  ports:\n  - name: web\n    port: {{ .Values.service.port }}\n    targetPort: web\n    {{- if (and (eq .Values.service.type \"NodePort\") (not (empty .Values.service.nodePort)))}}\n    nodePort: {{ .Values.service.nodePort }}\n    {{- end }}\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e Values \u503c\u6765\u914d\u7f6e Service \u5bf9\u8c61\u4e86\u3002\u6700\u540e\u5c31\u662f <code>Ingress/IngressRoute</code> \u5bf9\u8c61\u4e86\uff0c\u5927\u5bb6\u53ef\u4ee5\u81ea\u5df1\u5c1d\u8bd5\u8bb2\u8fd9\u90e8\u5206\u8865\u9f50\u3002</p> <p>\u6700\u540e\u5728 <code>templates</code> \u76ee\u5f55\u4e0b\u9762\u52a0\u4e0a <code>NOTES.txt</code> \u6587\u4ef6\u6765\u8bf4\u660e\u5982\u4f55\u4f7f\u7528\u6211\u4eec\u7684 Chart \u5305\u5c31\u53ef\u4ee5\u4e86\uff1a</p> <pre><code>Get the WordPress Manifests Objects:\n\n$ kubectl get all -l app={{ .Release.Name }}\n</code></pre> <p>\u6700\u540e\u6211\u4eec\u6765\u771f\u6b63\u7684\u4f7f\u7528\u6211\u4eec\u7684 Chart \u5305\u5b89\u88c5\u4e00\u6b21\u6765\u6d4b\u8bd5\u4e0b\uff1a</p> <pre><code>$ helm install mychart . --set service.type=NodePort\nNAME: mychart\nLAST DEPLOYED: Sun Mar  8 17:52:04 2020\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 1\nNOTES:\nGet the WordPress Manifests Objects:\n  $ kubectl get all -l app=mychart\n$ helm ls  \nNAME                    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART            APP VERSION\nmychart                 default         1               2020-03-08 17:52:826185 +0800 CST    deployed        wordpress-0  2\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u53ef\u4ee5\u67e5\u770b\u6211\u4eec\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get all -l app=mychart-wordpress\nNAME                                     READY   STATUS    RESTARTS   AGE\npod/mychart-wordpress-5f65786d89-2m45s   1/1     Running   0          70s\n\nNAME                        TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE\nservice/mychart-wordpress   NodePort   229   &lt;none&gt;        80:30427/TCP   70s\n\nNAME                                READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/mychart-wordpress   1/1     1            1           70s\n\nNAME                                           DESIRED   CURRENT   READY   AGE\nreplicaset.apps/mychart-wordpress-5f65786d89   1         1         1       70s\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u901a\u8fc7\u4e0a\u9762\u7684 NodePort \u5c31\u53ef\u4ee5\u53bb\u8bbf\u95ee\u5230\u6211\u4eec\u7684\u5e94\u7528\u4e86\uff0c\u5f53\u7136\u8fd8\u6709\u5f88\u591a\u914d\u7f6e\u6211\u4eec\u90fd\u662f\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 Values \u53bb\u8fdb\u884c\u5b9a\u5236\u7684\u3002</p>"},{"location":"kubernetes_package/helm/","title":"Helm","text":""},{"location":"kubernetes_package/helm/#helm","title":"Helm","text":"<p>Kubernetes \u5305\u7ba1\u7406\u5de5\u5177</p> <p>Helm \u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u7ba1\u7406 Kubernetes \u5e94\u7528\u7a0b\u5e8f - Helm Charts \u53ef\u4ee5\u5b9a\u4e49\u3001\u5b89\u88c5\u548c\u5347\u7ea7\u590d\u6742\u7684 Kubernetes \u5e94\u7528\u7a0b\u5e8f\uff0cCharts \u5305\u5f88\u5bb9\u6613\u521b\u5efa\u3001\u7248\u672c\u7ba1\u7406\u3001\u5206\u4eab\u548c\u5206\u5e03\u3002Helm \u5bf9\u4e8e Kubernetes \u6765\u8bf4\u5c31\u76f8\u5f53\u4e8e yum \u5bf9\u4e8e Centos \u6765\u8bf4\uff0c\u5982\u679c\u6ca1\u6709 yum \u7684\u8bdd\uff0c\u6211\u4eec\u5728 Centos \u4e0b\u9762\u8981\u5b89\u88c5\u4e00\u4e9b\u5e94\u7528\u7a0b\u5e8f\u662f\u6781\u5ea6\u9ebb\u70e6\u7684\uff0c\u540c\u6837\u7684\uff0c\u5bf9\u4e8e\u8d8a\u6765\u8d8a\u590d\u6742\u7684 Kubernetes \u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\uff0c\u5982\u679c\u5355\u7eaf\u4f9d\u9760\u6211\u4eec\u53bb\u624b\u52a8\u7ef4\u62a4\u5e94\u7528\u7a0b\u5e8f\u7684 YAML \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u6765\u8bf4\uff0c\u6210\u672c\u4e5f\u662f\u5de8\u5927\u7684\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u4e86\u89e3\u4e86 Helm \u7684\u4f7f\u7528\u65b9\u6cd5\u3002</p>"},{"location":"kubernetes_package/helm/#_1","title":"\u5b89\u88c5","text":"<p>\u9996\u5148\u5f53\u7136\u9700\u8981\u4e00\u4e2a\u53ef\u7528\u7684 Kubernetes \u96c6\u7fa4\uff0c\u7136\u540e\u5728\u6211\u4eec\u4f7f\u7528 Helm \u7684\u8282\u70b9\u4e0a\u5df2\u7ecf\u914d\u7f6e\u597d\u53ef\u4ee5\u901a\u8fc7 kubectl \u8bbf\u95ee\u96c6\u7fa4\uff0c\u56e0\u4e3a Helm \u5176\u5b9e\u5c31\u662f\u8bfb\u53d6\u7684 kubeconfig \u6587\u4ef6\u6765\u8bbf\u95ee\u96c6\u7fa4\u7684\u3002</p> <p>\u7531\u4e8e Helm V2 \u7248\u672c\u5fc5\u987b\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5b89\u88c5\u4e00\u4e2a Tiller \u670d\u52a1\u8fdb\u884c\u901a\u4fe1\uff0c\u8fd9\u6837\u5927\u5927\u964d\u4f4e\u4e86\u5176\u5b89\u5168\u6027\u548c\u53ef\u7528\u6027\uff0c\u6240\u4ee5\u5728 V3 \u7248\u672c\u4e2d\u79fb\u9664\u4e86\u670d\u52a1\u7aef\uff0c\u91c7\u7528\u4e86\u901a\u7528\u7684 Kubernetes CRD \u8d44\u6e90\u6765\u8fdb\u884c\u7ba1\u7406\uff0c\u8fd9\u6837\u5c31\u53ea\u9700\u8981\u8fde\u63a5\u4e0a Kubernetes \u5373\u53ef\uff0c\u800c\u4e14 V3 \u7248\u672c\u5df2\u7ecf\u53d1\u5e03\u4e86\u7a33\u5b9a\u7248\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u6765\u5b89\u88c5\u6700\u65b0\u7684 v3.0.1 \u7248\u672c\uff0c\u8f6f\u4ef6\u5305\u4e0b\u8f7d\u5730\u5740\u4e3a\uff1ahttps://github.com/helm/helm/releases\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u8282\u70b9\u9009\u62e9\u5408\u9002\u7684\u5305\uff0c\u6bd4\u5982\u6211\u8fd9\u91cc\u662f Mac\uff0c\u5c31\u4e0b\u8f7d MacOS amd64 \u7684\u7248\u672c\u3002</p> <p>\u4e0b\u8f7d\u5230\u672c\u5730\u89e3\u538b\u540e\uff0c\u5c06 helm \u4e8c\u8fdb\u5236\u5305\u6587\u4ef6\u79fb\u52a8\u5230\u4efb\u610f\u7684 PATH \u8def\u5f84\u4e0b\u5373\u53ef\uff1a</p> <pre><code>$ helm version\nversion.BuildInfo{Version:\"v1\", GitCommit:\"7c22ef9ce89e0ebeb7125ba2ebf7d421f3e82ffa\", GitTreeState:\"clean\", GoVersion:\"go4\"}\n</code></pre> <p>\u770b\u5230\u4e0a\u9762\u7684\u7248\u672c\u4fe1\u606f\u8bc1\u660e\u5df2\u7ecf\u6210\u529f\u4e86\u3002</p> <p>\u4e00\u65e6 Helm \u5ba2\u6237\u7aef\u51c6\u5907\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a chart \u4ed3\u5e93\uff0c\u5f53\u7136\u6700\u5e38\u7528\u7684\u5c31\u662f\u5b98\u65b9\u7684 Helm stable charts \u4ed3\u5e93\uff0c\u4f46\u662f\u7531\u4e8e\u5b98\u65b9\u7684 charts \u4ed3\u5e93\u5730\u5740\u9700\u8981\u79d1\u5b66\u4e0a\u7f51\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5fae\u8f6f\u7684 charts \u4ed3\u5e93\u4ee3\u66ff\uff1a</p> <pre><code>$ helm repo add stable http://mirror.azure.cn/kubernetes/charts/\n$ helm repo list\nNAME            URL\nstable          http://mirror.azure.cn/kubernetes/charts/\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u53ef\u4ee5\u7528 search \u547d\u4ee4\u6765\u641c\u7d22\u53ef\u4ee5\u5b89\u88c5\u7684 chart \u5305\uff1a</p> <pre><code>$ helm search repo stable\nNAME                                    CHART VERSION   APP VERSION                     DESCRIPTION\nstable/acs-engine-autoscaler            2           1                           DEPRECATED Scales worker nodes within agent pools\nstable/aerospike                        1           v5                        A Helm chart for Aerospike in Kubernetes\nstable/airflow                          1           4                          Airflow is a platform to programmatically autho...\nstable/ambassador                       0           0                          A Helm chart for Datawire Ambassador\nstable/anchore-engine                   7           2                           Anchore container analysis and policy evaluatio...\nstable/apm-server                       5           0                           The server receives data from the Elastic APM a...\n......\n</code></pre>"},{"location":"kubernetes_package/helm/#_2","title":"\u793a\u4f8b","text":"<p>\u4e3a\u4e86\u5b89\u88c5\u4e00\u4e2a chart \u5305\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>helm install</code> \u547d\u4ee4\uff0cHelm \u6709\u591a\u79cd\u65b9\u6cd5\u6765\u627e\u5230\u548c\u5b89\u88c5 chart \u5305\uff0c\u4f46\u662f\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u5f53\u7136\u662f\u4f7f\u7528\u5b98\u65b9\u7684 <code>stable</code> \u8fd9\u4e2a\u4ed3\u5e93\u76f4\u63a5\u5b89\u88c5\uff1a</p> <p>\u9996\u5148\u4ece\u4ed3\u5e93\u4e2d\u5c06\u53ef\u7528\u7684 charts \u4fe1\u606f\u540c\u6b65\u5230\u672c\u5730\uff0c\u53ef\u4ee5\u786e\u4fdd\u6211\u4eec\u83b7\u53d6\u5230\u6700\u65b0\u7684 charts \u5217\u8868\uff1a</p> <pre><code>$ helm repo update\nHang tight while we grab the latest from your chart repositories...\n...Successfully got an update from the \"stable\" chart repository\nUpdate Complete. \u2388 Happy Helming!\u2388\n</code></pre> <p>\u6bd4\u5982\u6211\u4eec\u73b0\u5728\u5b89\u88c5\u4e00\u4e2a <code>mysql</code> \u5e94\u7528\uff1a</p> <pre><code>$ helm install stable/mysql --generate-name\nNAME: mysql-1575619811\nLAST DEPLOYED: Fri Dec  6 16:10:14 2019\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 1\nNOTES:\nMySQL can be accessed via port 3306 on the following DNS name from within your cluster:\nmysql-15756198default.svc.cluster.local\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>stable/mysql</code> \u8fd9\u4e2a chart \u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\uff0c\u6211\u4eec\u5c06\u5b89\u88c5\u6210\u529f\u7684\u8fd9\u4e2a\u5e94\u7528\u53eb\u505a\u4e00\u4e2a <code>release</code>\uff0c\u7531\u4e8e\u6211\u4eec\u5728\u5b89\u88c5\u7684\u65f6\u5019\u6307\u5b9a\u4e86<code>--generate-name</code> \u53c2\u6570\uff0c\u6240\u4ee5\u751f\u6210\u7684 release \u540d\u79f0\u662f\u968f\u673a\u751f\u6210\u7684\uff0c\u540d\u4e3a <code>mysql-1575619811</code>\u3002\u6211\u4eec\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b release \u5b89\u88c5\u4ee5\u540e\u5bf9\u5e94\u7684 Kubernetes \u8d44\u6e90\u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get all -l release=mysql-1575619811\nNAME                                    READY   STATUS    RESTARTS   AGE\npod/mysql-1575619811-8479b5b796-dgggz   0/1     Pending   0          27m\n\nNAME                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\nservice/mysql-1575619811   ClusterIP   11228   &lt;none&gt;        3306/TCP   27m\n\nNAME                               READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/mysql-1575619811   0/1     1            0           27m\n\nNAME                                          DESIRED   CURRENT   READY   AGE\nreplicaset.apps/mysql-1575619811-8479b5b796   1         1         0       27m\n</code></pre> <p>\u6211\u4eec\u4e5f\u53ef\u4ee5 <code>helm show chart</code> \u547d\u4ee4\u6765\u4e86\u89e3 MySQL \u8fd9\u4e2a chart \u5305\u7684\u4e00\u4e9b\u7279\u6027\uff1a</p> <pre><code>$ helm show chart stable/mysql\n......\n</code></pre> <p>\u5982\u679c\u60f3\u8981\u4e86\u89e3\u66f4\u591a\u4fe1\u606f\uff0c\u53ef\u4ee5\u7528 <code>helm show all</code> \u547d\u4ee4\uff1a</p> <pre><code>$ helm show all stable/mysql\n......\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u65e0\u8bba\u4ec0\u4e48\u65f6\u5019\u5b89\u88c5 chart\uff0c\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 release\uff0c\u6240\u4ee5\u4e00\u4e2a chart \u5305\u662f\u53ef\u4ee5\u591a\u6b21\u5b89\u88c5\u5230\u540c\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u7684\uff0c\u6bcf\u4e2a\u90fd\u53ef\u4ee5\u72ec\u7acb\u7ba1\u7406\u548c\u5347\u7ea7\u3002</p> <p>\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u7528 Helm \u5f88\u5bb9\u6613\u67e5\u770b\u5230\u5df2\u7ecf\u5b89\u88c5\u7684 release\uff1a</p> <pre><code>$ helm ls\nNAME                NAMESPACE   REVISION    UPDATED                                 STATUS      CHART       APP VERSION\nmysql-1575619811    default     1           2019-12-06 16:10:682302 +0800 CST    deployed    mysql-0 27\n</code></pre> <p>\u5982\u679c\u9700\u8981\u5220\u9664\u8fd9\u4e2a release\uff0c\u4e5f\u5f88\u7b80\u5355\uff0c\u53ea\u9700\u8981\u4f7f\u7528 <code>helm uninstall</code> \u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ helm uninstall mysql-1575619811\nrelease \"mysql-1575619811\" uninstalled\n$ kubectl get all -l release=mysql-1575619811\nNo resources found.\n$ helm status mysql-1575619811\nError: release: not found\n</code></pre> <p><code>uninstall</code> \u547d\u4ee4\u4f1a\u4ece Kubernetes \u4e2d\u5220\u9664 release\uff0c\u4e5f\u4f1a\u5220\u9664\u4e0e release \u76f8\u5173\u7684\u6240\u6709 Kubernetes \u8d44\u6e90\u4ee5\u53ca release \u5386\u53f2\u8bb0\u5f55\u3002\u4e5f\u53ef\u4ee5\u5728\u5220\u9664\u7684\u65f6\u5019\u4f7f\u7528 <code>--keep-history</code> \u53c2\u6570\uff0c\u5219\u4f1a\u4fdd\u7559 release \u7684\u5386\u53f2\u8bb0\u5f55\uff0c\u53ef\u4ee5\u83b7\u53d6\u8be5 release \u7684\u72b6\u6001\u5c31\u662f <code>UNINSTALLED</code>\uff0c\u800c\u4e0d\u662f\u627e\u4e0d\u5230 release\u4e86\uff1a</p> <pre><code>$ helm uninstall mysql-1575619811 --keep-history\nrelease \"mysql-1575619811\" uninstalled\n$ helm status mysql-1575619811\nhelm status mysql-1575619811\nNAME: mysql-1575619811\nLAST DEPLOYED: Fri Dec  6 16:47:14 2019\nNAMESPACE: default\nSTATUS: uninstalled\n...\n$ helm ls -a\nNAME                NAMESPACE   REVISION    UPDATED                                 STATUS      CHART       APP VERSION\nmysql-1575619811    default     1           2019-12-06 16:47:415214 +0800 CST    uninstalled mysql-0 27\n</code></pre> <p>\u56e0\u4e3a Helm \u4f1a\u5728\u5220\u9664 release \u540e\u8ddf\u8e2a\u4f60\u7684 release\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u5ba1\u67e5\u5386\u53f2\u751a\u81f3\u53d6\u6d88\u5220\u9664 <code>release</code>\uff08\u4f7f\u7528 <code>helm rollback</code> \u547d\u4ee4\uff09\u3002</p>"},{"location":"kubernetes_package/helm/#_3","title":"\u5b9a\u5236","text":"<p>\u4e0a\u9762\u6211\u4eec\u90fd\u662f\u76f4\u63a5\u4f7f\u7528\u7684 <code>helm install</code> \u547d\u4ee4\u5b89\u88c5\u7684 chart \u5305\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u53ea\u4f1a\u4f7f\u7528 chart \u7684\u9ed8\u8ba4\u914d\u7f6e\u9009\u9879\uff0c\u4f46\u662f\u66f4\u591a\u7684\u65f6\u5019\uff0c\u662f\u5404\u79cd\u5404\u6837\u7684\u9700\u6c42\uff0c\u7d22\u5f15\u6211\u4eec\u5e0c\u671b\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u6765\u5b9a\u5236 chart \u5305\u7684\u914d\u7f6e\u53c2\u6570\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>helm show values</code> \u547d\u4ee4\u6765\u67e5\u770b\u4e00\u4e2a chart \u5305\u7684\u6240\u6709\u53ef\u914d\u7f6e\u7684\u53c2\u6570\u9009\u9879\uff1a</p> <pre><code>$ helm show values stable/mysql\n## mysql image version\n## ref: https://hub.docker.com/r/library/mysql/tags/\n##\nimage: \"mysql\"\nimageTag: \"14\"\n\nbusybox:\n  image: \"busybox\"\n  tag: \"3\"\n\ntestFramework:\n  enabled: true\n  image: \"dduportal/bats\"\n  tag: \"0\"\n## Specify password for root user\n##\n## Default: random 10 character string\n# mysqlRootPassword: testing\n## Create a database user\n##\n# mysqlUser:\n## Default: random 10 character string\n# mysqlPassword:\n## Allow unauthenticated access, uncomment to enable\n##\n# mysqlAllowEmptyPassword: true\n## Create a database\n##\n# mysqlDatabase:\n## Specify an imagePullPolicy (Required)\n## It's recommended to change this to 'Always' if the image tag is 'latest'\n## ref: http://kubernetes.io/docs/user-guide/images/#updating-images\n##\nimagePullPolicy: IfNotPresent\n......\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u770b\u5230\u7684\u6240\u6709\u53c2\u6570\u90fd\u662f\u53ef\u4ee5\u7528\u81ea\u5df1\u7684\u6570\u636e\u6765\u8986\u76d6\u7684\uff0c\u53ef\u4ee5\u5728\u5b89\u88c5\u7684\u65f6\u5019\u901a\u8fc7 YAML \u683c\u5f0f\u7684\u6587\u4ef6\u6765\u4f20\u9012\u8fd9\u4e9b\u53c2\u6570\uff1a</p> <pre><code>$ cat config.yaml\nmysqlUser:\n  user0\nmysqlPassword: user0pwd\nmysqlDatabase: user0db\npersistence:\n  enabled: false\n$ helm install -f config.yaml stable/mysql\nhelm install -f config.yaml mysql stable/mysql\nNAME: mysql\nLAST DEPLOYED: Fri Dec  6 17:46:56 2019\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 1\nNOTES:\nMySQL can be accessed via port 3306 on the following DNS name from within your cluster:\nmysql.default.svc.cluster.local\n......\n</code></pre> <p>release \u5b89\u88c5\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u67e5\u770b\u5bf9\u5e94\u7684 Pod \u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pod -l release=mysql\nNAME                    READY   STATUS            RESTARTS   AGE\nmysql-ddd798f48-gnrzd   0/1     PodInitializing   0          119s\n$ kubectl describe pod  mysql-ddd798f48-gnrzd\n......\nEnvironment:\n      MYSQL_ROOT_PASSWORD:  &lt;set to the key 'mysql-root-password' in secret 'mysql'&gt;  Optional: false\n      MYSQL_PASSWORD:       &lt;set to the key 'mysql-password' in secret 'mysql'&gt;       Optional: false\n      MYSQL_USER:           user0\n      MYSQL_DATABASE:       user0db\n......\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u73af\u5883\u53d8\u91cf </p> <pre><code>MYSQL_USER=user0\uff0cMYSQL_DATABASE=user0db\n</code></pre> <p>\u7684\u503c\u548c\u6211\u4eec\u4e0a\u9762\u914d\u7f6e\u7684\u503c\u662f\u4e00\u81f4\u7684\u3002\u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\uff0c\u6709\u4e24\u79cd\u65b9\u6cd5\u53ef\u4ee5\u4f20\u9012\u914d\u7f6e\u6570\u636e\uff1a</p> <ul> <li><code>--values\uff08\u6216\u8005 -f\uff09</code>\uff1a\u6307\u5b9a\u4e00\u4e2a YAML \u6587\u4ef6\u6765\u8986\u76d6 values \u503c\uff0c\u53ef\u4ee5\u6307\u5b9a\u591a\u4e2a\u503c\uff0c\u6700\u540e\u8fb9\u7684\u6587\u4ef6\u4f18\u5148</li> <li><code>--set</code>\uff1a\u5728\u547d\u4ee4\u884c\u4e0a\u6307\u5b9a\u8986\u76d6\u7684\u914d\u7f6e</li> </ul> <p>\u5982\u679c\u540c\u65f6\u4f7f\u7528\u8fd9\u4e24\u4e2a\u503c\uff0c<code>--set</code> \u5c06\u88ab\u5408\u5e76\u5230\u5177\u6709\u66f4\u9ad8\u4f18\u5148\u7ea7\u7684 <code>--values</code>\uff0c\u4f7f\u7528 <code>--set</code> \u6307\u5b9a\u7684\u503c\u5c06\u6301\u4e45\u5316\u5728 ConfigMap \u4e2d\uff0c\u5bf9\u4e8e\u7ed9\u5b9a\u7684 release\uff0c\u53ef\u4ee5\u4f7f\u7528 </p> <pre><code>helm get values &lt;release-name&gt;\n</code></pre> <p>\u6765\u67e5\u770b\u5df2\u7ecf\u8bbe\u7f6e\u7684\u503c\uff0c\u5df2\u8bbe\u7f6e\u7684\u503c\u4e5f\u901a\u8fc7\u5141\u8bb8 <code>helm upgrade</code> \u5e76\u6307\u5b9a <code>--reset</code> \u503c\u6765\u6e05\u9664\u3002</p> <p><code>--set</code> \u9009\u9879\u63a5\u6536\u96f6\u4e2a\u6216\u591a\u4e2a name/value \u5bf9\uff0c\u6700\u7b80\u5355\u7684\u7528\u6cd5\u5c31\u662f <code>--set name=value</code>\uff0c\u76f8\u5f53\u4e8e YAML \u6587\u4ef6\u4e2d\u7684\uff1a</p> <p><code>name: value</code></p> <p>\u591a\u4e2a\u503c\u4e4b\u95f4\u7528\u5b57\u7b26\u4e32,\u9694\u5f00\uff0c\u7528\u6cd5\u5c31\u662f <code>--set a=b,c=d</code>\uff0c\u76f8\u5f53\u4e8e YAML \u6587\u4ef6\u4e2d\u7684\uff1a</p> <p><code>a: b c: d</code></p> <p>\u4e5f\u652f\u6301\u66f4\u52a0\u590d\u6742\u7684\u8868\u8fbe\u5f0f\uff0c\u4f8b\u5982 </p> <pre><code>--set outer.inner=value\n</code></pre> <p>\uff0c\u5bf9\u5e94 YAML\uff1a</p> <pre><code>outer:\n  inner: value\n</code></pre> <p>\u5bf9\u4e8e\u5217\u8868\u6570\u7ec4\u53ef\u4ee5\u7528 <code>{}</code> \u6765\u5305\u88f9\uff0c\u6bd4\u5982 <code>--set name={a, b, c}</code>\uff0c\u5bf9\u5e94 YAML\uff1a</p> <p><code>name:  - a  - b  - c</code></p> <p>\u4ece Helm 2.5.0 \u5f00\u59cb\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u6570\u7ec4\u7d22\u5f15\u8bed\u6cd5\u6765\u8bbf\u95ee\u5217\u8868\u4e2d\u67d0\u4e2a\u9879\uff0c\u6bd4\u5982 </p> <pre><code>--set servers[0].port=80\n</code></pre> <p>\uff0c\u5bf9\u5e94\u7684 YAML \u4e3a\uff1a</p> <p><code>servers:  - port: 80</code></p> <p>\u4e5f\u53ef\u4ee5\u8fd9\u6837\u8bbe\u7f6e\u591a\u4e2a\u503c\uff0c\u6bd4\u5982 </p> <pre><code>--set servers[0].port=80,servers[0].host=example\n</code></pre> <p>\uff0c\u5bf9\u5e94\u7684 YAML \u4e3a\uff1a</p> <pre><code>servers\n  - port: 80\n    host: example\n</code></pre> <p>\u6709\u65f6\u5019\u4f60\u53ef\u80fd\u9700\u8981\u5728 <code>--set</code> \u9009\u9879\u4e2d\u4f7f\u7528\u7279\u6b8a\u7684\u5b57\u7b26\uff0c\u8fd9\u4e2a\u65f6\u5019\u53ef\u4ee5\u4f7f\u7528\u53cd\u659c\u6760\u6765\u8f6c\u4e49\u5b57\u7b26\uff0c\u6bd4\u5982 </p> <pre><code>--set name=value1\\,value2\n</code></pre> <p>\uff0c\u5bf9\u5e94\u7684 YAML \u4e3a\uff1a</p> <pre><code>name: \"value1,value2\"\n</code></pre> <p>\u7c7b\u4f3c\u7684\uff0c\u4f60\u8fd8\u53ef\u4ee5\u8f6c\u4e49<code>.</code>\uff0c\u5f53 chart \u6a21\u677f\u4e2d\u4f7f\u7528 <code>toYaml</code> \u51fd\u6570\u6765\u89e3\u6790 annotations\u3001labels \u4ee5\u53ca node selectors \u4e4b\u7c7b\u7684\u65f6\u5019\uff0c\u8fd9\u975e\u5e38\u6709\u7528\uff0c\u6bd4\u5982 </p> <pre><code>--set nodeSelector.\"kubernetes\\.io/role\"=master\n</code></pre> <p>\uff0c\u5bf9\u5e94\u7684 YAML \u6587\u4ef6\uff1a</p> <pre><code>nodeSelector:\n  kubernetes.io/role: master\n</code></pre> <p>\u6df1\u5ea6\u5d4c\u5957\u7684\u6570\u636e\u7ed3\u6784\u53ef\u80fd\u5f88\u96be\u4f7f\u7528 <code>--set</code> \u6765\u8868\u793a\uff0c\u6240\u4ee5\u4e00\u822c\u63a8\u8350\u8fd8\u662f\u4f7f\u7528 YAML \u6587\u4ef6\u6765\u8fdb\u884c\u8986\u76d6\uff0c\u5f53\u7136\u5728\u8bbe\u8ba1 chart \u6a21\u677f\u7684\u65f6\u5019\u4e5f\u53ef\u4ee5\u7ed3\u5408\u8003\u8651\u5230 <code>--set</code> \u8fd9\u79cd\u7528\u6cd5\uff0c\u5c3d\u53ef\u80fd\u7684\u63d0\u4f9b\u66f4\u597d\u7684\u652f\u6301\u3002</p>"},{"location":"kubernetes_package/helm/#_4","title":"\u66f4\u591a\u5b89\u88c5\u65b9\u5f0f","text":"<p><code>helm install</code> \u547d\u4ee4\u53ef\u4ee5\u4ece\u591a\u4e2a\u6e90\u8fdb\u884c\u5b89\u88c5\uff1a</p> <ul> <li>chart \u4ed3\u5e93\uff08\u7c7b\u4f3c\u4e8e\u4e0a\u9762\u6211\u4eec\u63d0\u5230\u7684\uff09</li> <li>\u672c\u5730 chart \u538b\u7f29\u5305\uff08helm install foo-0.1.1.tgz\uff09</li> <li>\u672c\u5730\u89e3\u538b\u7f29\u7684 chart \u76ee\u5f55\uff08helm install foo path/to/foo\uff09</li> <li>\u5728\u7ebf\u7684 URL\uff08helm install fool https://example.com/charts/foo-1.2.3.tgz\uff09</li> </ul>"},{"location":"kubernetes_package/helm/#_5","title":"\u5347\u7ea7\u548c\u56de\u6eda","text":"<p>\u5f53\u65b0\u7248\u672c\u7684 chart \u5305\u53d1\u5e03\u7684\u65f6\u5019\uff0c\u6216\u8005\u5f53\u4f60\u8981\u66f4\u6539 release \u7684\u914d\u7f6e\u7684\u65f6\u5019\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>helm upgrade</code> \u547d\u4ee4\u6765\u64cd\u4f5c\u3002\u5347\u7ea7\u9700\u8981\u4e00\u4e2a\u73b0\u6709\u7684 release\uff0c\u5e76\u6839\u636e\u63d0\u4f9b\u7684\u4fe1\u606f\u5bf9\u5176\u8fdb\u884c\u5347\u7ea7\u3002\u56e0\u4e3a Kubernetes charts \u53ef\u80fd\u5f88\u5927\u800c\u4e14\u5f88\u590d\u6742\uff0cHelm \u4f1a\u5c1d\u8bd5\u4ee5\u6700\u5c0f\u7684\u4fb5\u5165\u6027\u8fdb\u884c\u5347\u7ea7\uff0c\u5b83\u53ea\u4f1a\u66f4\u65b0\u81ea\u4e0a\u4e00\u7248\u672c\u4ee5\u6765\u53d1\u751f\u7684\u53d8\u5316\uff1a</p> <pre><code>$ helm upgrade -f panda.yaml mysql stable/mysql\nhelm upgrade -f panda.yaml mysql stable/mysql\nRelease \"mysql\" has been upgraded. Happy Helming!\nNAME: mysql\nLAST DEPLOYED: Fri Dec  6 21:06:11 2019\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 2\n...\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc <code>mysql</code> \u8fd9\u4e2a release \u7528\u76f8\u540c\u7684 chart \u5305\u8fdb\u884c\u5347\u7ea7\uff0c\u4f46\u662f\u65b0\u589e\u4e86\u4e00\u4e2a\u914d\u7f6e\u9879\uff1a</p> <pre><code>mysqlRootPassword: passw0rd\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>helm get values</code> \u6765\u67e5\u770b\u65b0\u8bbe\u7f6e\u662f\u5426\u751f\u6548\uff1a</p> <pre><code>$ helm get values mysql\nUSER-SUPPLIED VALUES:\nmysqlDatabase: user0db\nmysqlPassword: user0pwd\nmysqlRootPassword: passw0rd\nmysqlUser: user0\npersistence:\n  enabled: false\n</code></pre> <p><code>helm get</code> \u547d\u4ee4\u662f\u67e5\u770b\u96c6\u7fa4\u4e2d release \u7684\u975e\u5e38\u6709\u7528\u7684\u547d\u4ee4\uff0c\u6b63\u5982\u6211\u4eec\u5728\u4e0a\u9762\u770b\u5230\u7684\uff0c\u5b83\u663e\u793a\u4e86 <code>panda.yaml</code> \u4e2d\u7684\u65b0\u914d\u7f6e\u503c\u88ab\u90e8\u7f72\u5230\u4e86\u96c6\u7fa4\u4e2d\uff0c\u73b0\u5728\u5982\u679c\u67d0\u4e2a\u7248\u672c\u5728\u53d1\u5e03\u671f\u95f4\u6ca1\u6709\u6309\u8ba1\u5212\u8fdb\u884c\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528 </p> <pre><code>helm rollback [RELEASE] [REVISION]\n</code></pre> <p>\u547d\u4ee4\u5f88\u5bb9\u6613\u56de\u6eda\u5230\u4e4b\u524d\u7684\u7248\u672c\uff1a</p> <pre><code>$ helm ls\nNAME    NAMESPACE   REVISION    UPDATED                                 STATUS      CHART       APP VERSION\nmysql   default     2           2019-12-06 21:06:36358 +0800 CST     deployed    mysql-0 27\n$ helm history mysql\nREVISION    UPDATED                     STATUS      CHART       APP VERSION DESCRIPTION\n1           Fri Dec  6 17:53:03 2019    superseded  mysql-0 27      Install complete\n2           Fri Dec  6 21:06:11 2019    deployed    mysql-0 27      Upgrade complete\n$ helm rollback mysql 1\nRollback was a success! Happy Helming!\n$ kubectl get pods -l release=mysql\nNAME                    READY   STATUS    RESTARTS   AGE\nmysql-ddd798f48-gnrzd   1/1     Running   0          3h25m\n$ helm get values mysql\nUSER-SUPPLIED VALUES:\nmysqlDatabase: user0db\nmysqlPassword: user0pwd\nmysqlUser: user0\npersistence:\n  enabled: false\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 values \u914d\u7f6e\u5df2\u7ecf\u56de\u6eda\u5230\u4e4b\u524d\u7684\u7248\u672c\u4e86\u3002\u4e0a\u9762\u7684\u547d\u4ee4\u56de\u6eda\u5230\u4e86 release \u7684\u7b2c\u4e00\u4e2a\u7248\u672c\uff0c\u6bcf\u6b21\u8fdb\u884c\u5b89\u88c5\u3001\u5347\u7ea7\u6216\u56de\u6eda\u65f6\uff0c\u4fee\u8ba2\u53f7\u90fd\u4f1a\u52a0 1\uff0c\u7b2c\u4e00\u4e2a\u4fee\u8ba2\u53f7\u59cb\u7ec8\u4e3a1\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 </p> <pre><code>helm history [RELEASE]\n</code></pre> <p>\u6765\u67e5\u770b\u67d0\u4e2a\u7248\u672c\u7684\u4fee\u8ba2\u53f7\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u6307\u5b9a\u4e00\u4e9b\u6709\u7528\u7684\u9009\u9879\u6765\u5b9a\u5236 install/upgrade/rollback \u7684\u4e00\u4e9b\u884c\u4e3a\uff0c\u8981\u67e5\u770b\u5b8c\u6574\u7684\u53c2\u6570\u6807\u5fd7\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c </p> <pre><code>helm &lt;command&gt; --help\n</code></pre> <p>\u6765\u67e5\u770b\uff0c\u8fd9\u91cc\u6211\u4eec\u4ecb\u7ecd\u51e0\u4e2a\u6709\u7528\u7684\u53c2\u6570\uff1a</p> <ul> <li><code>--timeout</code>: \u7b49\u5f85 Kubernetes \u547d\u4ee4\u5b8c\u6210\u7684\u65f6\u95f4\uff0c\u9ed8\u8ba4\u662f 300\uff085\u5206\u949f\uff09</li> <li><code>--wait</code>: \u7b49\u5f85\u76f4\u5230\u6240\u6709 Pods \u90fd\u5904\u4e8e\u5c31\u7eea\u72b6\u6001\u3001PVCs \u5df2\u7ecf\u7ed1\u5b9a\u3001Deployments \u5177\u6709\u5904\u4e8e\u5c31\u7eea\u72b6\u6001\u7684\u6700\u5c0f Pods \u6570\u91cf\uff08\u671f\u671b\u503c\u51cf\u53bb maxUnavailable\uff09\u4ee5\u53ca Service \u6709\u4e00\u4e2a IP \u5730\u5740\uff0c\u7136\u540e\u624d\u6807\u8bb0 release \u4e3a\u6210\u529f\u72b6\u6001\u3002\u5b83\u5c06\u7b49\u5f85\u4e0e <code>--timeout</code> \u503c\u4e00\u6837\u957f\u7684\u65f6\u95f4\uff0c\u5982\u679c\u8fbe\u5230\u8d85\u65f6\uff0c\u5219 release \u5c06\u6807\u8bb0\u4e3a\u5931\u8d25\u3002\u6ce8\u610f\uff1a\u5728 Deployment \u5c06\u526f\u672c\u8bbe\u7f6e\u4e3a 1 \u5e76\u4e14\u4f5c\u4e3a\u6eda\u52a8\u66f4\u65b0\u7b56\u7565\u7684\u4e00\u90e8\u5206\uff0cmaxUnavailable \u672a\u8bbe\u7f6e\u4e3a0\u7684\u60c5\u51b5\u4e0b\uff0c<code>--wait</code> \u5c06\u8fd4\u56de\u5c31\u7eea\u72b6\u6001\uff0c\u56e0\u4e3a\u5b83\u5df2\u6ee1\u8db3\u5c31\u7eea\u72b6\u6001\u4e0b\u7684\u6700\u5c0f Pod \u6570\u91cf</li> <li><code>--no-hooks</code>: \u5c06\u4f1a\u8df3\u8fc7\u547d\u4ee4\u7684\u8fd0\u884c hooks</li> <li><code>--recreate-pods</code>: \u4ec5\u9002\u7528\u4e8e upgrade \u548c rollback\uff0c\u8fd9\u4e2a\u6807\u5fd7\u5c06\u5bfc\u81f4\u91cd\u65b0\u521b\u5efa\u6240\u6709\u7684 Pods\u3002\uff08Helm3 \u4e2d\u542f\u7528\u4e86\uff09</li> </ul>"},{"location":"kubernetes_package/templates/access_files/","title":"\u8bbf\u95ee\u6587\u4ef6","text":""},{"location":"kubernetes_package/templates/access_files/#_1","title":"\u8bbf\u95ee\u6587\u4ef6","text":"<p>\u5728\u4e0a\u4e00\u8282\u4e2d\u6211\u4eec\u4ecb\u7ecd\u4e86\u51e0\u79cd\u521b\u5efa\u548c\u8bbf\u95ee\u547d\u540d\u6a21\u677f\u7684\u65b9\u6cd5\uff0c\u8fd9\u4f7f\u5f97\u4ece\u53e6\u4e00\u4e2a\u6a21\u677f\u4e2d\u5bfc\u5165\u4e00\u4e2a\u6a21\u677f\u53d8\u5f97\u5f88\u5bb9\u6613\uff0c\u4f46\u662f\u6709\u65f6\u5019\u9700\u8981\u5bfc\u5165\u4e00\u4e2a\u4e0d\u662f\u6a21\u677f\u7684\u6587\u4ef6\u5e76\u6ce8\u5165\u5176\u5185\u5bb9\uff0c\u800c\u4e0d\u901a\u8fc7\u6a21\u677f\u6e32\u67d3\u5668\u83b7\u5f97\u5185\u5bb9\u3002</p> <p>Helm \u63d0\u4f9b\u4e86\u4e00\u4e2a <code>.Files</code> \u5bf9\u8c61\u5bf9\u6587\u4ef6\u7684\u8bbf\u95ee\uff0c\u4f46\u662f\u5728\u6a21\u677f\u4e2d\u4f7f\u7528\u8fd9\u4e2a\u5bf9\u8c61\u4e4b\u524d\uff0c\u8fd8\u6709\u51e0\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u4e8b\u9879\u503c\u5f97\u4e00\u63d0\uff1a</p> <ul> <li>\u53ef\u4ee5\u5728 Helm chart \u4e2d\u6dfb\u52a0\u989d\u5916\u7684\u6587\u4ef6\uff0c\u8fd9\u4e9b\u6587\u4ef6\u4e5f\u4f1a\u88ab\u6253\u5305\uff0c\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\uff0c\u7531\u4e8e Kubernetes \u5bf9\u8c61\u7684\u5b58\u50a8\u9650\u5236\uff0cCharts \u5fc5\u987b\u5c0f\u4e8e 1M</li> <li> <p>\u7531\u4e8e\u4e00\u4e9b\u5b89\u5168\u539f\u56e0\uff0c\u901a\u8fc7 <code>.Files</code> \u5bf9\u8c61\u65e0\u6cd5\u8bbf\u95ee\u67d0\u4e9b\u6587\u4ef6</p> <ul> <li>\u65e0\u6cd5\u8bbf\u95ee <code>templates/</code> \u4e0b\u9762\u7684\u6587\u4ef6</li> <li>\u65e0\u6cd5\u8bbf\u95ee\u4f7f\u7528 <code>.helmignore</code> \u6392\u9664\u7684\u6587\u4ef6</li> <li> <p>Chart \u4e0d\u4f1a\u4fdd\u7559 UNIX \u6a21\u5f0f\u7684\u4fe1\u606f\uff0c\u6240\u4ee5\uff0c\u5f53\u4f7f\u7528 <code>.Files</code> \u5bf9\u8c61\u65f6\uff0c\u6587\u4ef6\u7ea7\u522b\u7684\u6743\u9650\u4e0d\u4f1a\u5bf9\u6587\u4ef6\u7684\u53ef\u7528\u6027\u4ea7\u751f\u5f71\u54cd\u3002</p> </li> </ul> </li> </ul>"},{"location":"kubernetes_package/templates/access_files/#_2","title":"\u57fa\u672c\u793a\u4f8b","text":"<p>\u73b0\u5728\u6211\u4eec\u6765\u7f16\u5199\u4e00\u4e2a\u6a21\u677f\uff0c\u5c063\u4e2a\u6587\u4ef6\u8bfb\u5165\u5230 <code>ConfigMap</code> \u6a21\u677f\u4e2d\uff0c\u9996\u5148\u6211\u4eec\u5728 chart \u4e2d\u6dfb\u52a03\u4e2a\u6587\u4ef6\uff0c\u5c063\u4e2a\u6587\u4ef6\u90fd\u76f4\u63a5\u653e\u7f6e\u5728 <code>mychart/</code> \u76ee\u5f55\u4e2d\u3002</p> <p><code>config1.toml</code>:</p> <pre><code>message = Hello from config 1\n</code></pre> <p><code>config2.toml</code>:</p> <pre><code>message = This is config 2\n</code></pre> <p><code>config3.toml</code>:</p> <pre><code>message = Goodbye from config 3\n</code></pre> <p>3\u4e2a\u6587\u4ef6\u90fd\u662f\u7b80\u5355\u7684 TOML \u6587\u4ef6\uff0c\u6211\u4eec\u77e5\u9053\u8fd9\u4e9b\u6587\u4ef6\u7684\u540d\u79f0\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>range</code> \u51fd\u6570\u6765\u904d\u5386\u5b83\u4eec\uff0c\u5e76\u5c06\u5176\u5185\u5bb9\u6ce8\u5165\u5230 <code>ConfigMap</code> \u4e2d\u53bb\u3002</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  {{- $files := .Files }}\n  {{- range tuple \"configtoml\" \"configtoml\" \"configtoml\" }}\n  {{ . }}: |-\n    {{ $files.Get . }}\n  {{- end }}\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u58f0\u660e\u4e86\u4e00\u4e2a <code>$files</code> \u7684\u53d8\u91cf\u6765\u4fdd\u5b58 <code>.Files</code> \u5bf9\u8c61\u7684\u5f15\u7528\uff0c\u8fd8\u4f7f\u7528\u4e86 <code>tuple</code> \u51fd\u6570\u6765\u5faa\u73af\u6587\u4ef6\u5217\u8868\uff0c\u7136\u540e\u6211\u4eec\u6253\u5370\u6bcf\u4e2a\u6587\u4ef6\u5939 <code>{{ . }}: |-</code>\uff0c\u540e\u9762\u4f7f\u7528 <code>{{ $files.Get . }}</code> \u83b7\u53d6\u6587\u4ef6\u5185\u5bb9\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6e32\u67d3\u8fd9\u4e2a\u6a21\u677f\u4f1a\u4ea7\u751f\u5305\u542b3\u4e2a\u6587\u4ef6\u5185\u5bb9\u7684\u5355\u4e2a ConfigMap\uff1a</p> <pre><code># Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1576046462-configmap\ndata:\n  configtoml: |-\n    message = Hello from config 1\n\n  configtoml: |-\n    message = This is config 2\n\n  configtoml: |-\n    message = Goodbye from config 3\n</code></pre> <p>\u53e6\u5916\u5728\u5904\u7406\u6587\u4ef6\u7684\u65f6\u5019\uff0c\u5bf9\u6587\u4ef6\u8def\u5f84\u672c\u8eab\u6267\u884c\u4e00\u4e9b\u6807\u51c6\u64cd\u4f5c\u53ef\u80fd\u975e\u5e38\u6709\u7528\uff0c\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cHelm \u4ece Go \u7684\u8def\u5f84\u5305\u4e2d\u5bfc\u5165\u4e86\u8bb8\u591a\u529f\u80fd\u4f9b\u4f60\u4f7f\u7528\uff0c\u5b83\u4eec\u90fd\u53ef\u4ee5\u4f7f\u7528\u4e0e Go \u5305\u4e2d\u76f8\u540c\u7684\u76f8\u540c\u540d\u79f0\u6765\u8bbf\u95ee\uff0c\u4f46\u662f\u9996\u5b57\u6bcd\u9700\u8981\u5c0f\u5199\uff0c\u6bd4\u5982 Base \u9700\u8981\u53d8\u6210 base\uff0c\u5bfc\u5165\u7684\u51fd\u6570\u6709\uff1a- Base - Dir - Ext - IsAbs - Clean\u3002</p>"},{"location":"kubernetes_package/templates/access_files/#glob","title":"Glob \u6a21\u5f0f","text":"<p>\u968f\u7740 chart \u7684\u589e\u957f\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u66f4\u591a\u5730\u7ec4\u7ec7\u6587\u4ef6\uff0c\u56e0\u6b64 Helm \u63d0\u4f9b\u4e86 <code>Files.Glob</code> \u7684\u65b9\u6cd5\u6765\u5e2e\u52a9\u6211\u4eec\u83b7\u53d6\u5177\u6709 <code>glob</code> \u6a21\u5f0f\u7684\u6587\u4ef6\u3002</p> <p><code>.Glob</code> \u8fd4\u56de <code>Files</code> \u7c7b\u578b\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u5728\u8fd4\u56de\u7684\u5bf9\u8c61\u4e0a\u8c03\u7528\u4efb\u4f55 <code>Files</code> \u65b9\u6cd5\u3002\u6bd4\u5982\uff0c\u6211\u4eec\u7684\u6587\u4ef6\u76ee\u5f55\u7ed3\u6784\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>foo/:\n  foo.txt foo.yaml\n\nbar/:\n  bar.go bar.conf baz.yaml\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u7528 <code>Glob</code> \u8fdb\u884c\u591a\u79cd\u9009\u62e9\uff1a</p> <pre><code>{{ range $path := .Files.Glob \"**.yaml\" }}\n{{ $path }}: |\n{{ .Files.Get $path }}\n{{ end }}\n</code></pre> <p>\u6216\u8005</p> <pre><code>{{ range $path, $bytes := .Files.Glob \"foo/*\" }}\n{{ $path }}: '{{ b64enc $bytes }}'\n{{ end }}\n</code></pre>"},{"location":"kubernetes_package/templates/access_files/#configmap_secrets","title":"ConfigMap \u548c Secrets","text":"<p>\u60f3\u8981\u5c06\u6587\u4ef6\u5185\u5bb9\u540c\u65f6\u653e\u5165 ConfigMap \u548c Secrets \u4e2d\uff0c\u4ee5\u4fbf\u5728\u8fd0\u884c\u65f6\u5b89\u88c5\u5230 Pod \u4e2d\uff0c\u8fd9\u79cd\u9700\u6c42\u5f88\u5e38\u89c1\uff0c\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cHelm \u5728 <code>Files</code> \u7c7b\u578b\u4e0a\u6dfb\u52a0\u4e86\u4e00\u4e2a\u5b9e\u7528\u7684\u65b9\u6cd5\u3002</p> <p>\u6839\u636e\u4e0a\u9762\u7684\u76ee\u5f55\u7ed3\u6784\uff0c\u6211\u4eec\u53ef\u4ee5\u6309\u7167\u5982\u4e0b\u7684\u65b9\u5f0f\u8fdb\u884c\u5904\u7406\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: conf\ndata:\n{{ (.Files.Glob \"foo/*\").AsConfig | indent 2 }}\n---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: very-secret\ntype: Opaque\ndata:\n{{ (.Files.Glob \"bar/*\").AsSecrets | indent 2 }}\n</code></pre>"},{"location":"kubernetes_package/templates/access_files/#_3","title":"\u7f16\u7801","text":"<p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u5bfc\u5165\u4e00\u4e2a\u6587\u4ef6\u5e76\u7528 <code>base64</code> \u7f16\u7801\u8fdb\u884c\u7f16\u7801\uff1a</p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: {{ .Release.Name }}-secret\ntype: Opaque\ndata:\n  token: |-\n    {{ .Files.Get \"configtoml\" | b64enc }}\n</code></pre> <p>\u4e0a\u9762\u5c06\u91c7\u7528\u6211\u4eec\u4e0a\u9762\u7684 <code>config1.toml</code> \u6587\u4ef6\u5e76\u5bf9\u5176\u5185\u5bb9\u8fdb\u884c <code>base64</code> \u7f16\u7801\uff0c\u6e32\u67d3\u4f1a\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u7ed3\u679c\uff1a</p> <pre><code># Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: mychart-1576048287-secret\ntype: Opaque\ndata:\n  token: |-\n    bWVzc2FnZSA9IEhlbGxvIGZyb20gY29uZmlnIDEK\n</code></pre>"},{"location":"kubernetes_package/templates/access_files/#lines","title":"Lines","text":"<p>\u6709\u65f6\uff0c\u9700\u8981\u8bbf\u95ee\u6a21\u677f\u4e2d\u6587\u4ef6\u7684\u6bcf\u4e00\u884c\u5185\u5bb9\uff0cHelm \u4e5f\u63d0\u4f9b\u4e86\u65b9\u6cd5\u7684 <code>Lines</code> \u65b9\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>range</code> \u51fd\u6570\u904d\u5386\u6ca1\u884c\u5185\u5bb9\uff1a</p> <pre><code>data:\n  some-file.txt: {{ range .Files.Lines \"foo/bar.txt\" }}\n    {{ . }}{{ end }}\n</code></pre> <p>\u5728 Helm \u5b89\u88c5\u7684\u65f6\u5019\u65e0\u6cd5\u5c06\u6587\u4ef6\u4f20\u9012\u5230 chart \u5916\u90e8\uff0c\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u8981\u6c42\u7528\u6237\u63d0\u4f9b\u6570\u636e\u7684\u8bdd\uff0c\u5219\u5fc5\u987b\u4f7f\u7528 <code>helm install -f</code> \u6216\u8005 <code>helm install --set</code> \u6765\u83b7\u53d6\u3002</p>"},{"location":"kubernetes_package/templates/debug/","title":"\u6a21\u677f\u8c03\u8bd5","text":""},{"location":"kubernetes_package/templates/debug/#_1","title":"\u6a21\u677f\u8c03\u8bd5","text":"<p>\u8c03\u8bd5\u6a21\u677f\u53ef\u80fd\u6bd4\u8f83\u9ebb\u70e6\uff0c\u56e0\u4e3a\u6e32\u67d3\u7684\u6a21\u677f\u4f1a\u53d1\u9001\u5230 Kubernetes API server\uff0c\u800c API server \u53ef\u80fd\u4f1a\u56e0\u4e3a\u683c\u5f0f\u4ee5\u5916\u7684\u4e00\u4e9b\u539f\u56e0\u800c\u62d2\u7edd YAML \u6587\u4ef6\u3002</p> <p>\u4e0b\u9762\u8fd9\u4e9b\u547d\u4ee4\u53ef\u4ee5\u5e2e\u52a9\u4f60\u8c03\u8bd5\u4e00\u4e9b\u95ee\u9898\uff1a</p> <ul> <li><code>helm lint</code> \u662f\u9a8c\u8bc1 chart \u662f\u5426\u9075\u5faa\u6700\u4f73\u5b9e\u8df5\u7684\u9996\u9009\u5de5\u5177</li> <li> <p><code>helm install --dry-run --debug     <pre><code> \u6216\u8005 \n</code></pre>     helm template --debug</code></p> <p>\uff1a\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u4f7f\u7528\u4e86\u8fd9\u4e2a\u6280\u5de7\uff0c\u8fd9\u4e2a\u662f\u8ba9\u670d\u52a1\u5668\u6e32\u67d3\u6a21\u677f\uff0c\u7136\u540e\u8fd4\u56de\u751f\u6210\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u7684\u597d\u65b9\u6cd5\uff0c\u800c\u4e14\u4e0d\u4f1a\u771f\u6b63\u7684\u53bb\u5b89\u88c5\u8fd9\u4e9b\u8d44\u6e90 *   <code>helm get manifest</code>\uff1a\u8fd9\u662f\u67e5\u770b\u670d\u52a1\u5668\u4e0a\u5b89\u88c5\u4e86\u54ea\u4e9b\u6a21\u677f\u7684\u597d\u65b9\u6cd5</p> </li> </ul> <p>\u5f53\u4f60\u7684 YAML \u6587\u4ef6\u65e0\u6cd5\u89e3\u6790\u7684\u65f6\u5019\uff0c\u4f46\u4f60\u60f3\u8981\u67e5\u770b\u751f\u6210\u7684\u5185\u5bb9\u7684\u65f6\u5019\uff0c\u68c0\u7d22 YAML \u7684\u4e00\u79cd\u7b80\u5355\u65b9\u6cd5\u662f\u6ce8\u91ca\u6389\u6a21\u677f\u4e2d\u7684\u95ee\u9898\u90e8\u5206\uff0c\u7136\u540e\u91cd\u65b0\u8fd0\u884c </p> <pre><code>helm install --dry-run --debug\n</code></pre> <p>\uff1a</p> <pre><code>apiVersion: v2\n# some: problem section\n# {{ .Values.foo | quote }}\n</code></pre> <p>\u4e0a\u9762\u7684\u5185\u5bb9\u5c06\u5448\u73b0\u5e76\u8fd4\u56de\u5b8c\u6574\u7684\u6ce8\u91ca\uff1a</p> <pre><code>apiVersion: v2\n# some: problem section\n#  \"bar\"\n</code></pre> <p>\u8fd9\u63d0\u4f9b\u4e86\u4e00\u79cd\u67e5\u770b\u751f\u6210\u7684\u5185\u5bb9\u7684\u5feb\u901f\u65b9\u6cd5\u3002</p>"},{"location":"kubernetes_package/templates/flow/","title":"\u6d41\u7a0b\u63a7\u5236","text":""},{"location":"kubernetes_package/templates/flow/#_1","title":"\u6d41\u7a0b\u63a7\u5236","text":"<p>\u63a7\u5236\u6d41\u7a0b\u4e3a\u6a21\u677f\u4f5c\u8005\u63d0\u4f9b\u4e86\u63a7\u5236\u6a21\u677f\u751f\u6210\u6d41\u7a0b\u7684\u529f\u80fd\uff0cHelm \u7684\u6a21\u677f\u8bed\u8a00\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u4e00\u4e9b\u6d41\u7a0b\u63a7\u5236\uff1a</p> <ul> <li><code>if/else</code> \u6761\u4ef6\u8bed\u53e5</li> <li><code>with</code> \u6307\u5b9a\u4e00\u4e2a\u4f5c\u7528\u57df\u8303\u56f4</li> <li><code>range</code> \u63d0\u4f9b\u7c7b\u4f3c\u4e8e <code>for each</code> \u8fd9\u6837\u7684\u5faa\u73af\u6837\u5f0f</li> </ul> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e9b\u58f0\u660e\u548c\u4f7f\u7528\u547d\u540d\u6a21\u677f\u7684\u64cd\u4f5c\uff1a</p> <ul> <li><code>define</code> \u5728\u6a21\u677f\u5185\u90e8\u58f0\u660e\u4e00\u4e2a\u65b0\u7684\u547d\u540d\u6a21\u677f</li> <li><code>template</code> \u5bfc\u5165\u4e00\u4e2a\u547d\u540d\u6a21\u677f</li> <li><code>block</code> \u58f0\u660e\u4e86\u4e00\u79cd\u7279\u6b8a\u7684\u53ef\u586b\u5145\u6a21\u677f\u533a\u57df\u3002</li> </ul> <p>\u8fd9\u91cc\u6211\u4eec\u5148\u6765\u4e86\u89e3 <code>if</code>\u3001<code>with</code>\u3001<code>range</code> \u8bed\u53e5\u7684\u4f7f\u7528\uff0c\u5176\u4ed6\u5c06\u5728\u540e\u9762\u7684<code>\u547d\u540d\u6a21\u677f</code>\u90e8\u5206\u4ecb\u7ecd\u3002</p>"},{"location":"kubernetes_package/templates/flow/#ifelse","title":"if/else","text":"<p>\u9996\u5148\u6211\u4eec\u5148\u6765\u4e86\u89e3\u4e0b\u6709\u6761\u4ef6\u5730\u5728\u6a21\u677f\u4e2d\u5305\u542b\u4e00\u4e2a\u6587\u672c\u533a\u57df\uff0c\u5c31\u662f <code>if/else</code> \uff0c\u8fd9\u4e2a\u6761\u4ef6\u5224\u65ad\u7684\u57fa\u672c\u7ed3\u6784\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>{{ if PIPELINE }}\n  # Do something\n{{ else if OTHER PIPELINE }}\n  # Do something else\n{{ else }}\n  # Default case\n{{ end }}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u8fd9\u91cc\u5224\u65ad\u7684\u662f\u7ba1\u9053\u800c\u4e0d\u662f\u4e00\u4e2a values \u503c\uff0c\u8fd9\u662f\u56e0\u4e3a\u63a7\u5236\u7ed3\u6784\u53ef\u4ee5\u6267\u884c\u6574\u4e2a\u7ba1\u9053\uff0c\u800c\u4e0d\u4ec5\u4ec5\u662f\u5224\u65ad\u503c\u3002\u5982\u679c\u503c\u4e3a\u4ee5\u4e0b\u7684\u4e00\u4e9b\u5185\u5bb9\uff0c\u5219\u5c06\u7ba1\u9053\u5224\u65ad\u4e3a false\uff1a</p> <ul> <li>\u5e03\u5c14 false</li> <li>\u6570\u5b57\u96f6</li> <li>\u4e00\u4e2a\u7a7a\u5b57\u7b26\u4e32</li> <li>nil\uff08empty \u6216\u8005 null\uff09</li> <li>\u4e00\u4e2a\u7a7a\u96c6\u5408\uff08map\u3001slice\u3001tuple\u3001dict\u3001array\uff09</li> </ul> <p>\u5728\u5176\u4ed6\u6761\u4ef6\u4e0b\uff0c\u6761\u4ef6\u90fd\u4e3a\u771f\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u5728\u4e0a\u9762\u7684\u793a\u4f8b\u6a21\u677f ConfigMap \u4e2d\u6dfb\u52a0\u4e00\u4e2a\u7b80\u5355\u7684\u6761\u4ef6\uff0c\u5982\u679c drink \u8bbe\u7f6e\u4e3a coffee\uff0c\u6211\u4eec\u5c31\u6dfb\u52a0\u53e6\u5916\u4e00\u4e2a\u8bbe\u7f6e\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: {{ .Values.favorite.drink | default \"tea\" | quote }}\n  food: {{ .Values.favorite.food | upper | quote }}\n  {{ if eq .Values.favorite.drink \"coffee\" }}mug: true{{ end }}\n</code></pre> <p>\u6211\u4eec\u628a values.yaml \u6587\u4ef6\u5185\u5bb9\u8bbe\u7f6e\u6210\u4e0b\u9762\u7684\u6837\u5b50\uff1a</p> <pre><code>favorite:\n  # drink: coffee\n  food: pizza\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u6ce8\u91ca\u6389\u4e86 <code>drink: coffee</code>\uff0c\u6240\u4ee5\u6e32\u67d3\u540e\u8f93\u51fa\u4e0d\u4f1a\u5305\u542b <code>mug: true</code> \u7684\u6807\u5fd7\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u628a\u6ce8\u91ca\u53d6\u6d88\u6389\uff0c\u5219\u5e94\u8be5\u8f93\u51fa\u5982\u4e0b\u6240\u793a\u7684\u5185\u5bb9\uff1a</p> <pre><code># Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1575970308-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffee\"\n  food: \"PIZZA\"\n  mug: true\n</code></pre> <p>\u8fd9\u662f\u56e0\u4e3a\u4e0a\u9762\u6a21\u677f\u4e2d\u6211\u4eec\u6dfb\u52a0\u4e86 </p> <pre><code>if eq .Values.favorite.drink \"coffee\"\n</code></pre> <p>\u8fd9\u6837\u7684\u6761\u4ef6\u5224\u65ad\uff0c\u76f8\u5f53\u4e8e\u662f\u5224\u65ad </p> <pre><code>.Values.favorite.drink\n</code></pre> <p>\u503c\u662f\u5426\u7b49\u4e8e <code>\"coffee\"</code>\uff0c\u5982\u679c\u76f8\u7b49\u5219\u6e32\u67d3 <code>mug: true</code>\u3002</p>"},{"location":"kubernetes_package/templates/flow/#_2","title":"\u7a7a\u683c\u63a7\u5236","text":"<p>\u8fd8\u6709\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u529f\u80fd\u70b9\u5c31\u662f\u5173\u4e8e\u7a7a\u683c\u7684\u63a7\u5236\uff0c\u56e0\u4e3a\u7a7a\u683c\u5bf9\u4e8e YAML \u6587\u4ef6\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4e0d\u662f\u8bf4\u4efb\u610f\u7f29\u8fdb\u5c31\u53ef\u4ee5\uff0c\u4f9d\u7136\u8fd8\u662f\u4ee5\u524d\u9762\u7684\u4f8b\u5b50\u4e3a\u4f8b\uff0c\u6211\u4eec\u6765\u683c\u5f0f\u5316\u4e0b\u6a21\u677f\u683c\u5f0f\u4ee5\u66f4\u6613\u4e8e\u9605\u8bfb\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: {{ .Values.favorite.drink | default \"tea\" | quote }}\n  food: {{ .Values.favorite.food | upper | quote }}\n  {{ if eq .Values.favorite.drink \"coffee\" }}\n    mug: true\n  {{ end }}\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u7684\u6a21\u677f\u770b\u4e0a\u53bb\u66f4\u6613\u4e8e\u9605\u8bfb\u4e86\uff0c\u4f46\u662f\u6211\u4eec\u901a\u8fc7\u6a21\u677f\u5f15\u64ce\u6765\u6e32\u67d3\u4e0b\uff0c\u5374\u4f1a\u5f97\u5230\u5982\u4e0b\u7684\u9519\u8bef\u4fe1\u606f\uff1a</p> <pre><code>$ helm install --generate-name --dry-run --debug ./mychart\ninstall.go:148: [debug] Original chart version: \"\"\ninstall.go:165: [debug] CHART PATH: /Users/ych/devs/workspace/yidianzhishi/course/k8strain/content/helm/manifests/mychart\n\nError: YAML parse error on mychart/templates/configmap.yaml: error converting YAML to JSON: yaml: line 9: did not find expected key\n</code></pre> <p>\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u5728\u6a21\u677f\u4e2d\u6dfb\u52a0\u4e86\u7a7a\u683c\uff0c\u751f\u6210\u4e86\u4e0d\u6b63\u786e\u7684 YAML \u6587\u4ef6\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1575970308-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffee\"\n  food: \"PIZZA\"\n    mug: true\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>mug: true</code> \u7684\u7f29\u8fdb\u662f\u6709\u95ee\u9898\u7684\uff0c\u4e0d\u7b26\u5408 YAML \u6587\u4ef6\u683c\u5f0f\uff0c\u73b0\u5728\u6211\u4eec\u8bb2\u7f29\u8fdb\u53bb\u6389\u8bd5\u770b\u770b\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: {{ .Values.favorite.drink | default \"tea\" | quote }}\n  food: {{ .Values.favorite.food | upper | quote }}\n  {{ if eq .Values.favorite.drink \"coffee\" }}\n  mug: true\n  {{ end }}\n</code></pre> <p>\u91cd\u65b0\u6e32\u67d3\u6a21\u677f\uff0c\u7136\u540e\u53ef\u4ee5\u53d1\u73b0\u5df2\u7ecf\u53ef\u4ee5\u6b63\u5e38\u901a\u8fc7\u4e86\uff0c\u4f46\u662f\u6e32\u67d3\u51fa\u6765\u7684 YAML \u6587\u4ef6\u683c\u5f0f\u770b\u4e0a\u53bb\u8fd8\u662f\u6709\u70b9\u5947\u602a\uff1a</p> <pre><code># Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1575971172-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffee\"\n  food: \"PIZZA\"\n\n  mug: true\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5f97\u5230\u7684 YAML \u6587\u4ef6\u4e2d\u591a\u4e86\u4e00\u4e9b\u7a7a\u884c\uff0c\u8fd9\u662f\u56e0\u4e3a\u6a21\u677f\u5f15\u64ce\u6e32\u67d3\u7684\u65f6\u5019\u5b83\u4f1a\u5220\u9664 <code>{{</code> \u548c <code>}}</code> \u4e4b\u95f4\u7684\u5185\u5bb9\uff0c\u4f46\u662f\u4f1a\u5b8c\u5168\u4fdd\u7559\u5176\u4f59\u7684\u7a7a\u683c\u3002\u6211\u4eec\u77e5\u9053\u5728 YAML \u6587\u4ef6\u4e2d\u7a7a\u683c\u662f\u6709\u610f\u4e49\u7684\uff0c\u6240\u4ee5\u7ba1\u7406\u7a7a\u683c\u5c31\u53d8\u5f97\u975e\u5e38\u91cd\u8981\u4e86\uff0c\u4e0d\u8fc7 Helm \u6a21\u677f\u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e9b\u5de5\u5177\u6765\u5e2e\u52a9\u6211\u4eec\u7ba1\u7406\u7a7a\u683c\u3002</p> <p>\u9996\u5148\u53ef\u4ee5\u4f7f\u7528\u7279\u6b8a\u5b57\u7b26\u4fee\u6539\u6a21\u677f\u58f0\u660e\u7684\u82b1\u62ec\u53f7\u8bed\u6cd5\uff0c\u4ee5\u544a\u8bc9\u6a21\u677f\u5f15\u64ce\u53bb\u6389\u7a7a\u683c\u3002<code>{{-</code> \u6dfb\u52a0\u4e86\u7834\u6298\u53f7\u548c\u7a7a\u683c\u8868\u793a\u5e94\u5c06\u5de6\u8fb9\u7684\u7a7a\u683c\u79fb\u9664\uff0c<code>-}}</code>\u8868\u793a\u5c06\u53f3\u8fb9\u7684\u7a7a\u683c\u79fb\u9664\uff0c<code>\u53e6\u5916\u4e5f\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6362\u884c\u7b26\u4e5f\u662f\u7a7a\u683c</code>\u3002</p> <p>\u7a7a\u683c</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u65f6\u5019\u8981\u786e\u4fdd <code>-</code> \u548c\u6307\u4ee4\u7684\u5176\u4f59\u90e8\u5206\u4e4b\u95f4\u8981\u6709\u7a7a\u683c\uff0c<code>{{- 3 }}</code> \u8868\u793a\u5220\u9664\u5de6\u8fb9\u7684\u7a7a\u683c\u5e76\u6253\u53703\uff0c\u4f46\u662f <code>{{-3 }}</code>\u8868\u793a\u6253\u5370<code>-3</code>\u3002</p> <p>\u4f7f\u7528\u8fd9\u4e2a\u8bed\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u4fee\u6539\u4e0a\u9762\u7684\u6a21\u677f\u6765\u79fb\u9664\u591a\u4f59\u7684\u7a7a\u884c\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: {{ .Values.favorite.drink | default \"tea\" | quote }}\n  food: {{ .Values.favorite.food | upper | quote }}\n  {{- if eq .Values.favorite.drink \"coffee\" }}\n  mug: true\n  {{- end }}\n</code></pre> <p>\u6e32\u67d3\u540e\u53ef\u4ee5\u770b\u5230\u7a7a\u884c\u88ab\u79fb\u9664\u6389\u4e86\uff1a</p> <pre><code># Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1575972373-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffee\"\n  food: \"PIZZA\"\n  mug: true\n</code></pre> <p>\u4e3a\u4e86\u66f4\u52a0\u6e05\u695a\u5730\u8bf4\u660e\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u7528<code>*</code>\u6765\u4ee3\u66ff\u5c06\u8981\u5220\u9664\u7684\u6bcf\u4e2a\u7a7a\u683c\uff0c\u884c\u5c3e\u7684<code>*</code>\u8868\u793a\u88ab\u5220\u9664\u7684\u6362\u884c\u7b26\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: {{ .Values.favorite.drink | default \"tea\" | quote }}\n  food: {{ .Values.favorite.food | upper | quote }}*\n**{{- if eq .Values.favorite.drink \"coffee\" }}\n  mug: true*\n**{{- end }}\n</code></pre> <p>\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u7528 <code>{{-</code> \u8868\u793a\u7684\u5c31\u662f\u5220\u9664\u672c\u884c\u5f00\u5934\u7684\u4e24\u4e2a\u7a7a\u683c\u4ee5\u53ca\u4e0a\u4e00\u884c\u7684\u6362\u884c\u7b26\uff0c\u8fd9\u6837\u662f\u4e0d\u662f\u5c31\u5c06\u7a7a\u884c\u90fd\u5220\u9664\u4e86\u554a\u3002</p> <p>\u5728\u4f7f\u7528\u79fb\u9664\u7a7a\u683c\u7684\u65f6\u5019\u8fd8\u9700\u8981\u5c0f\u5fc3\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u64cd\u4f5c\uff1a</p> <pre><code>food: {{ .Values.favorite.food | upper | quote }}\n{{- if eq .Values.favorite.drink \"coffee\" -}}\nmug: true\n{{- end -}}\n</code></pre> <p>\u6211\u4eec\u4f9d\u7136\u8fd8\u662f\u53ef\u4ee5\u7528 <code>*</code> \u6765\u4ee3\u66ff\u7a7a\u683c\u8fdb\u884c\u5206\u6790\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: {{ .Values.favorite.drink | default \"tea\" | quote }}\n  food: {{ .Values.favorite.food | upper | quote }}*\n**{{- if eq .Values.favorite.drink \"coffee\" -}}*\n  mug: true*\n**{{- end -}}\n</code></pre> <p>\u7b2c\u4e00\u4e2a <code>{{-</code> \u4f1a\u5220\u9664\u524d\u9762\u7684\u7a7a\u683c\u548c\u524d\u9762\u7684\u6362\u884c\u7b26\uff0c\u7136\u540e\u540e\u9762\u7684 <code>-}}</code> \u4f1a\u5220\u9664\u5f53\u524d\u884c\u7684\u6362\u884c\u7b26\uff0c\u8fd9\u6837\u5c31\u4f1a\u628a <code>mug: true</code> \u79fb\u52a8\u5230 <code>food: \"PIZZA\"</code> \u540e\u9762\u53bb\u4e86\uff0c\u6700\u7ec8\u6e32\u67d3\u8fc7\u540e\u5c31\u4f1a\u53d8\u6210\uff1a</p> <pre><code>food: \"PIZZA\"mug: true\n</code></pre> <p>\uff0c\u56e0\u4e3a\u5728\u4e24\u4fa7\u90fd\u53bb\u6389\u6362\u884c\u7b26\u3002</p> <p>\u6709\u5173\u6a21\u677f\u4e2d\u7a7a\u683c\u63a7\u5236\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u53ef\u4ee5\u67e5\u770b Go \u6a21\u677f\u5b98\u65b9\u6587\u6863\u4ecb\u7ecd\u3002</p> <p>\u4e0d\u8fc7\u6709\u65f6\u5019\u544a\u8bc9\u6a21\u677f\u7cfb\u7edf\u5982\u4f55\u7f29\u8fdb\u6bd4\u8d77\u53bb\u63a7\u5236\u6a21\u677f\u6307\u4ee4\u7684\u95f4\u8ddd\u66f4\u52a0\u5bb9\u6613\uff0c\u6240\u4ee5\uff0c\u6709\u65f6\u5019\u4f60\u4f1a\u53d1\u73b0\u7f29\u8fdb\u51fd\u6570\uff08</p> <pre><code>{{ indent 2 \"mug: true\" }}\n</code></pre> <p>\uff09\u66f4\u6709\u7528\u3002</p>"},{"location":"kubernetes_package/templates/flow/#with","title":"\u4f7f\u7528 with \u4fee\u6539\u4f5c\u7528\u57df","text":"<p>\u63a5\u4e0b\u6765\u9700\u8981\u4e86\u89e3\u7684\u662f <code>with</code> \u64cd\u4f5c\uff0c\u5b83\u53ef\u4ee5\u63a7\u5236\u53d8\u91cf\u7684\u4f5c\u7528\u57df\uff0c\u7136\u540e\u91cd\u65b0\u7528 <code>.</code> \u8c03\u7528\u5c31\u8868\u793a\u5bf9\u5f53\u524d\u4f5c\u7528\u57df\u7684\u5f15\u7528\uff0c\u6240\u4ee5\uff0c<code>.Values</code> \u662f\u544a\u8bc9\u6a21\u677f\u5f15\u64ce\u5728\u5f53\u524d\u4f5c\u7528\u57df\u4e0b\u5185\u67e5\u627e Values \u5bf9\u8c61\u3002</p> <p><code>with</code> \u8bed\u53e5\u7684\u8bed\u6cd5\u548c <code>if</code> \u8bed\u53e5\u6bd4\u8f83\u7c7b\u4f3c\uff1a</p> <pre><code>{{ with PIPELINE }}\n  # \u9650\u5236\u8303\u56f4\n{{ end }}\n</code></pre> <p>\u8303\u56f4\u53ef\u4ee5\u66f4\u6539\uff0c\u53ef\u4ee5\u8ba9\u4f60\u5c06\u5f53\u524d\u8303\u56f4 <code>.</code> \u8bbe\u7f6e\u4e3a\u7279\u5b9a\u7684\u5bf9\u8c61\uff0c\u4f8b\u5982\uff0c\u6211\u4eec\u4e00\u76f4\u5728\u4f7f\u7528 <code>.Values.favorites</code>\uff0c\u8ba9\u6211\u4eec\u91cd\u5199\u4e0b\u6a21\u677f\u6587\u4ef6 ConfigMap \u6765\u66f4\u6539 <code>.</code> \u7684\u8303\u56f4\u6307\u5411 <code>.Values.favorites</code>\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  {{- with .Values.favorite }}\n  drink: {{ .drink | default \"tea\" | quote }}\n  food: {{ .food | upper | quote }}\n  {{- end }}\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u5c06\u524d\u9762\u7ec3\u4e60\u7684 <code>if</code> \u6761\u4ef6\u8bed\u53e5\u5220\u9664\u4e86\uff0c\u5728\u6a21\u677f\u4e2d\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a </p> <pre><code>{{- with .Values.favorite }}\n</code></pre> <p>\u7684\u8bed\u53e5\uff0c\u610f\u601d\u5c31\u662f\u8bf4\u5728 <code>with</code> \u8bed\u53e5\u7684\u4f5c\u7528\u8303\u56f4\u5185\u53ef\u4ee5\u7528 <code>.</code> \u8868\u793a <code>.Values.favorite</code> \u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5f15\u7528 <code>.drink</code> \u548c <code>.food</code> \u4e86\uff0c\u4f46\u662f\u5728 <code>{{ end }}</code> \u4e4b\u540e\u5c31\u4f1a\u91cd\u7f6e\u4e3a\u4e4b\u524d\u7684\u4f5c\u7528\u57df\u4e86\u3002</p> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u5f97\u662f\uff0c\u5728\u53d7\u9650\u7684\u4f5c\u7528\u57df\u8303\u56f4\u5185\uff0c\u4f60\u65e0\u6cd5\u4ece\u7236\u7ea7\u8303\u56f4\u8bbf\u95ee\u5230\u5176\u4ed6\u5bf9\u8c61\uff0c\u6bd4\u5982\uff0c\u4e0b\u9762\u5f97\u6a21\u677f\u4f1a\u5931\u8d25\uff1a</p> <pre><code>{{- with .Values.favorite }}\ndrink: {{ .drink | default \"tea\" | quote }}\nfood: {{ .food | upper | quote }}\nrelease: {{ .Release.Name }}\n{{- end }}\n</code></pre> <p>\u56e0\u4e3a <code>Release.Name</code> \u5e76\u4e0d\u5728 <code>.</code> \u7684\u9650\u5236\u8303\u56f4\u5185\uff0c\u6240\u4ee5\u4f1a\u4ea7\u751f\u9519\u8bef\uff0c\u4f46\u662f\uff0c\u5982\u679c\u6211\u4eec\u4ea4\u6362\u6700\u540e\u4e24\u884c\uff0c\u5219\u5c31\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\u4e86\uff0c\u56e0\u4e3a <code>{{ end }}</code> \u4e4b\u540e\u4f1a\u91cd\u7f6e\u4f5c\u7528\u57df\u3002</p> <pre><code>{{- with .Values.favorite }}\ndrink: {{ .drink | default \"tea\" | quote }}\nfood: {{ .food | upper | quote }}\n{{- end }}\nrelease: {{ .Release.Name }}\n</code></pre> <p>\u4e0b\u9762\u6211\u5148\u6765\u4e86\u89e3\u4e0b <code>range</code>\uff0c\u7136\u540e\u6211\u4eec\u518d\u53bb\u4e86\u89e3\u4e0b\u6a21\u677f\u53d8\u91cf\uff0c\u5b83\u53ef\u4ee5\u4e3a\u4e0a\u9762\u5f97\u8fd9\u4e2a\u8303\u56f4\u95ee\u9898\u63d0\u4f9b\u4e00\u79cd\u89e3\u51b3\u65b9\u6848\u3002</p>"},{"location":"kubernetes_package/templates/flow/#range","title":"range \u5faa\u73af\u64cd\u4f5c","text":"<p>\u6211\u4eec\u77e5\u9053\u8bb8\u591a\u7f16\u7a0b\u8bed\u8a00\u90fd\u652f\u6301\u4f7f\u7528 <code>for</code> \u5faa\u73af\u3001<code>foreach</code> \u5faa\u73af\u6216\u8005\u7c7b\u4f3c\u529f\u80fd\u673a\u5236\u8fdb\u884c\u5faa\u73af\u8fed\u4ee3\uff0c\u5728 Helm \u5f97\u6a21\u677f\u8bed\u8a00\u4e2d\uff0c\u8fed\u4ee3\u96c6\u5408\u5f97\u65b9\u6cd5\u662f\u4f7f\u7528 <code>range</code> \u8fd0\u7b97\u7b26\u3002</p> <p>\u6bd4\u5982\u9996\u5148\u6211\u4eec\u5728 <code>values.yaml</code> \u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e00\u4efd pizza \u9985\u6599\u5217\u8868\uff1a</p> <pre><code>favorite:\n  drink: coffee\n  food: pizza\npizzaToppings:\n  - mushrooms\n  - cheese\n  - peppers\n  - onions\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6709\u4e86 <code>pizzaToppings</code> \u5217\u8868\uff08\u5728\u6a21\u677f\u4e2d\u79f0\u4e3a\u5207\u7247\uff09\uff0c\u6211\u4eec\u53ef\u4ee5\u6765\u4fee\u6539\u4e0b\u6a21\u677f\u5c06\u5217\u8868\u6253\u5370\u5230 ConfigMap \u4e2d\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  {{- with .Values.favorite }}\n  drink: {{ .drink | default \"tea\" | quote }}\n  food: {{ .food | upper | quote }}\n  {{- end }}\n  toppings: |-\n    {{- range .Values.pizzaToppings }}\n    - {{ . | title | quote }}\n    {{- end }}\n</code></pre> <p>\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u4e0b\u6a21\u677f\u4e2d\u7684 <code>toppings:</code> \u5217\u8868\uff0c<code>range</code> \u51fd\u6570\u5c06\u904d\u5386 <code>Values.pizzaToppings</code> \u5217\u8868\uff0c\u6211\u4eec\u770b\u5230\u91cc\u9762\u4f7f\u7528\u4e86\u4e00\u4e2a <code>.</code>\uff0c\u7c7b\u4f3c\u4e8e\u4e0a\u9762\u6211\u4eec\u7528 <code>with</code> \u8bbe\u7f6e\u8303\u56f4\u4e00\u6837\uff0c\u8fd0\u7b97\u7b26\u4e5f\u662f\u8fd9\u6837\u7684\uff0c\u6bcf\u6b21\u5faa\u73af\uff0c<code>.</code> \u90fd\u4f1a\u88ab\u8bbe\u7f6e\u4e3a\u5f53\u524d\u7684 <code>pizzaTopping</code>\uff0c\u4e5f\u5c31\u662f\u8bf4\u7b2c\u4e00\u6b21\u8bbe\u7f6e\u4e3a<code>mushrooms</code>\uff0c\u7b2c\u4e8c\u6b21\u8fed\u4ee3\u8bbe\u7f6e\u4e3a<code>cheese</code>\uff0c\u4f9d\u6b21\u7c7b\u63a8\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f20\u9012 <code>.</code> \u8fd9\u4e2a\u503c\u5230\u7ba1\u9053\u4e0a\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc </p> <pre><code>{{ . | title | quote }}\n</code></pre> <p>\u5c31\u76f8\u5f53\u4e8e\u53d1\u9001 <code>.</code> \u7ed9 <code>title</code>\uff08\u6807\u9898\u5927\u5c0f\u5199\u51fd\u6570\uff09\u51fd\u6570\uff0c\u7136\u540e\u53d1\u9001\u7ed9 <code>quote</code> \u51fd\u6570\uff0c\u6211\u4eec\u6e32\u67d3\u8fd9\u4e2a\u6a21\u677f\uff0c\u4f1a\u8f93\u51fa\u5982\u4e0b\u7684\u5185\u5bb9\uff1a</p> <pre><code># Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1575975849-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffee\"\n  food: \"PIZZA\"\n  toppings: |-\n    - \"Mushrooms\"\n    - \"Cheese\"\n    - \"Peppers\"\n    - \"Onions\"\n</code></pre> <p>\u5728\u4e0a\u9762\u6a21\u677f\u4e2d\uff0c\u6211\u4eec\u505a\u4e86\u4e00\u4e9b\u5c0f\u5c0f\u7684\u7279\u6b8a\u5904\u7406\uff0c<code>toppings: |-</code> \u884c\u8868\u793a\u58f0\u660e\u4e00\u4e2a\u591a\u884c\u5b57\u7b26\u4e32\uff0c\u6240\u4ee5\u5176\u5b9e\u6211\u4eec\u7684 <code>toppings</code> \u5217\u8868\u4e0d\u662f\u4e00\u4e2a YAML \u5217\u8868\uff0c\u800c\u662f\u4e00\u4e2a\u6bd4\u8f83\u5927\u7684\u5b57\u7b26\u4e32\uff0c\u8fd9\u662f\u56e0\u4e3a ConfigMap \u4e2d\u7684\u6570\u636e\u7531 <code>key/value</code> \u5bf9\u7ec4\u6210\uff0c\u6240\u6709 key \u548c value \u90fd\u662f\u7b80\u5355\u7684\u5b57\u7b26\u4e32\uff0c\u8981\u4e86\u89e3\u4e3a\u4ec0\u4e48\u662f\u8fd9\u6837\u7684\uff0c\u53ef\u4ee5\u67e5\u770b Kubernetes ConfigMap \u6587\u6863\uff0c\u4e0d\u8fc7\u8fd9\u4e2a\u7ec6\u8282\u5bf9\u6211\u4eec\u8fd9\u91cc\u4e0d\u91cd\u8981\u3002</p> <p>YAML</p> <p>\u591a\u884c\u5b57\u7b26\u4e32\u53ef\u4ee5\u4f7f\u7528 <code>|</code> \u4fdd\u7559\u6362\u884c\u7b26\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>&gt;</code> \u6298\u53e0\u6362\u884c\uff0c\u5982\uff1a</p> <pre><code>this: |\n Foo\n Bar\nthat: &gt;\n Foo\n Bar\n</code></pre> <p>\u5bf9\u5e94\u7684\u610f\u601d\u5c31\u662f\uff1a</p> <pre><code>{this: Foo\\nBar\\n, that: Foo Bar\\n}\n</code></pre> <p><code>+</code> \u8868\u793a\u4fdd\u7559\u6587\u5b57\u5757\u672b\u5c3e\u7684\u6362\u884c\uff0c<code>-</code> \u8868\u793a\u5220\u9664\u5b57\u7b26\u4e32\u672b\u5c3e\u7684\u6362\u884c\uff0c\u5982\uff1a</p> <pre><code>s1: |\nFoo\n\ns2: |+\nFoo\n\ns3: |-\nFoo\n</code></pre> <p>\u5bf9\u5e94\u7684\u610f\u601d\u5c31\u662f\uff1a</p> <pre><code>{s1: Foo\\n, s2: Foo\\n\\n\\n, s3: Foo}\n</code></pre> <p>\u6709\u65f6\u5019\uff0c\u5728\u6a21\u677f\u4e2d\u5feb\u901f\u521b\u5efa\u4e00\u4e2a\u5217\u8868\uff0c\u7136\u540e\u904d\u5386\u8be5\u5217\u8868\u5f88\u6709\u7528\uff0cHelm \u6a21\u677f\u5177\u6709\u7b80\u5316\u8be5\u529f\u80fd\u7684\u51fd\u6570\uff1a<code>tuple</code>\u3002\u5143\u7ec4\u662f\u56fa\u5b9a\u5927\u5c0f\u7684\u5217\u8868\u96c6\u5408\uff0c\u4f46\u662f\u5177\u6709\u4efb\u610f\u6570\u636e\u7c7b\u578b\uff0c\u4e0b\u9762\u662f\u5143\u7ec4\u7684\u5927\u6982\u4f7f\u7528\u65b9\u6cd5\uff1a</p> <pre><code>sizes: |-\n  {{- range tuple \"small\" \"medium\" \"large\" }}\n  - {{ . }}\n  {{- end }}\n</code></pre> <p>\u4e0a\u9762\u7684\u6a21\u677f\u6700\u7ec8\u4f1a\u88ab\u6e32\u67d3\u6210\u5982\u4e0b\u7684 YAML\uff1a</p> <pre><code>sizes: |-\n  - small\n  - medium\n  - large\n</code></pre> <p>\u9664\u4e86\u5217\u8868\u548c\u5143\u7ec4\u4e4b\u5916\uff0c<code>range</code> \u8fd8\u53ef\u4ee5\u7528\u4e8e\u904d\u5386\u5b57\u5178\uff0c\u6211\u4eec\u5728\u4e0b\u4e00\u8282\u4ecb\u7ecd\u6a21\u677f\u53d8\u91cf\u7684\u65f6\u5019\u518d\u6765\u4e86\u89e3\u8fd9\u4e2a\u7528\u6cd5\u5427\u3002</p>"},{"location":"kubernetes_package/templates/function/","title":"\u51fd\u6570\u548c\u7ba1\u9053","text":""},{"location":"kubernetes_package/templates/function/#_1","title":"\u51fd\u6570\u548c\u7ba1\u9053","text":"<p>\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u4e86\u5982\u4f55\u5c06\u4fe1\u606f\u52a0\u5165\u5230\u6a21\u677f\u4e2d\uff0c\u4f46\u662f\u8fd9\u4e9b\u4fe1\u606f\u90fd\u662f\u76f4\u63a5\u539f\u6837\u7684\u653e\u7f6e\u8fc7\u53bb\u7684\uff0c\u6709\u65f6\u5019\uff0c\u6211\u4eec\u5e0c\u671b\u4ee5\u4e00\u79cd\u5bf9\u6211\u4eec\u66f4\u6709\u7528\u7684\u65b9\u5f0f\u6765\u8f6c\u6362\u63d0\u4f9b\u7684\u6570\u636e\u3002</p> <p>\u4e0b\u9762\u8ba9\u6211\u4eec\u4ece\u4e00\u4e2a\u6700\u4f73\u5b9e\u8df5\u5f00\u59cb\uff1a\u5c06 <code>.Values</code> \u5bf9\u8c61\u4e2d\u7684\u5b57\u7b26\u4e32\u6ce8\u5165\u6a21\u677f\u65f6\uff0c\u6211\u4eec\u5e94\u8be5\u5f15\u7528\u8fd9\u4e9b\u5b57\u7b26\u4e32\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728 template \u6307\u4ee4\u4e2d\u8c03\u7528 <code>quote</code> \u51fd\u6570\u6765\u5b9e\u73b0\uff0c\u6bd4\u5982\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: {{ quote .Values.favorite.drink }}\n  food: {{ quote .Values.favorite.food }}\n</code></pre> <p>\u6a21\u677f\u51fd\u6570\u9075\u5faa\u7684\u8bed\u6cd5\u89c4\u5219\u662f </p> <pre><code>functionName arg1 arg..\n</code></pre> <p>\uff0c\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u7247\u6bb5\u4e2d\uff0c</p> <pre><code>quote .Values.favorite.drink\n</code></pre> <p>\u4f1a\u8c03\u7528 <code>quote</code> \u51fd\u6570\u5e76\u4f20\u9012\u4e00\u4e2a\u5355\u4e2a\u53c2\u6570\u3002</p> <p>Helm \u670960\u591a\u79cd\u53ef\u7528\u7684\u51fd\u6570\uff0c\u5176\u4e2d\u4e00\u4e9b\u662f\u7531 Go \u6a21\u677f\u8bed\u8a00\u672c\u8eab\u5b9a\u4e49\u7684\uff0c\u5176\u4ed6\u5927\u591a\u6570\u90fd\u662f Sprig \u6a21\u677f\u5e93\u63d0\u4f9b\u7684\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u4f1a\u901a\u8fc7\u90e8\u5206\u793a\u4f8b\u6765\u9010\u6b65\u4ecb\u7ecd\u5176\u4e2d\u7684\u4e00\u4e9b\u529f\u80fd\u51fd\u6570\u3002</p> <p>Helm \u6a21\u677f</p> <p>\u5f53\u6211\u4eec\u8c08\u8bba <code>Helm \u6a21\u677f\u8bed\u8a00</code> \u7684\u65f6\u5019\uff0c\u5c31\u597d\u50cf\u662f\u7279\u5b9a\u4e8e Helm \u4e00\u6837\uff0c\u4f46\u5b9e\u9645\u4e0a\u5b83\u662f Go \u6a21\u677f\u8bed\u8a00\u52a0\u4e0a\u4e00\u4e9b\u989d\u5916\u7684\u51fd\u6570\u4ee5\u53ca\u5404\u79cd\u5c01\u88c5\u7a0b\u5e8f\u7684\u7ec4\u5408\uff0c\u4ee5\u5c06\u67d0\u4e9b\u5bf9\u8c61\u66b4\u9732\u7ed9\u6a21\u677f\u3002\u5f53\u6211\u4eec\u9700\u8981\u5b66\u4e60\u6a21\u677f\u7684\u65f6\u5019\uff0cGo \u6a21\u677f\u4e0a\u6709\u8bb8\u591a\u8d44\u6e90\u4f1a\u5bf9\u6211\u4eec\u6709\u6240\u5e2e\u52a9\u7684\u3002</p>"},{"location":"kubernetes_package/templates/function/#_2","title":"\u7ba1\u9053","text":"<p>\u6a21\u677f\u8bed\u8a00\u6709\u4e00\u4e2a\u5f3a\u5927\u7684\u529f\u80fd\u5c31\u662f<code>\u7ba1\u9053\uff08Pipeline\uff09</code>\u6982\u5ff5\uff0c\u7ba1\u9053\u5229\u7528 UNIX \u7684\u6982\u5ff5\uff0c\u5c06\u4e00\u7cfb\u5217\u6a21\u677f\u547d\u4ee4\u94fe\u63a5\u5728\u4e00\u8d77\uff0c\u4e00\u8d77\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u7ba1\u9053\u662f\u6309\u987a\u5e8f\u5b8c\u6210\u591a\u9879\u5de5\u4f5c\u7684\u6709\u6548\u65b9\u5f0f\uff0c\u6211\u4eec\u6765\u4f7f\u7528\u7ba1\u9053\u91cd\u5199\u4e0a\u9762\u7684\u793a\u4f8b\u6a21\u677f\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: {{ .Values.favorite.drink | quote }}\n  food: {{ .Values.favorite.food | quote }}\n</code></pre> <p>\u5728\u8fd9\u91cc\u6211\u4eec\u6ca1\u6709\u8c03\u7528 <code>quote ARGUMENT</code> \u51fd\u6570\uff0c\u800c\u662f\u98a0\u5012\u4e86\u4e0b\u987a\u5e8f\uff0c\u6211\u4eec\u4f7f\u7528\u7ba1\u9053\u7b26\uff08|\uff09\u5c06\u53c2\u6570<code>\u53d1\u9001</code>\u7ed9\u51fd\u6570\uff1a</p> <pre><code>.Values.favorite.drink | quote\n</code></pre> <p>\uff0c\u4f7f\u7528\u7ba1\u9053\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u591a\u4e2a\u529f\u80fd\u94fe\u63a5\u5728\u4e00\u8d77\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: {{ .Values.favorite.drink | quote }}\n  food: {{ .Values.favorite.food | upper | quote }}\n</code></pre> <p>\u7ba1\u9053\u987a\u5e8f</p> <p>\u53cd\u8f6c\u987a\u5e8f\u662f\u6a21\u677f\u4e2d\u5e38\u89c1\u7684\u505a\u6cd5\uff0c\u6211\u4eec\u4f1a\u770b\u5230 <code>.val | quote</code> \u6bd4 <code>quote .val</code> \u7528\u6cd5\u66f4\u591a\uff0c\u867d\u7136\u4e24\u79cd\u65b9\u6cd5\u90fd\u662f\u53ef\u4ee5\u7684\u3002</p> <p>\u6700\u540e\uff0c\u6a21\u677f\u6e32\u67d3\u540e\uff0c\u4f1a\u4ea7\u751f\u5982\u4e0b\u6240\u793a\u7684\u7ed3\u679c\uff1a</p> <pre><code>$ helm install --generate-name --dry-run --debug ./mychart\ninstall.go:148: [debug] Original chart version: \"\"\ninstall.go:165: [debug] CHART PATH: /Users/ych/devs/workspace/yidianzhishi/course/k8strain/content/helm/manifests/mychart\n\nNAME: mychart-1575966483\nLAST DEPLOYED: Tue Dec 10 16:28:04 2019\nNAMESPACE: default\nSTATUS: pending-install\nREVISION: 1\nTEST SUITE: None\nUSER-SUPPLIED VALUES:\n{}\n\nCOMPUTED VALUES:\nfavorite:\n  drink: coffee\n  food: pizza\nfavoriteDrink: coffee\n\nHOOKS:\nMANIFEST:\n---\n# Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1575966483-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffee\"\n  food: \"PIZZA\"\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 values \u4e2d\u7684 <code>pizza</code> \u503c\u5df2\u7ecf\u88ab\u8f6c\u6362\u6210\u4e86 <code>\"PIZZA\"</code>\u3002\u5f53\u8fd9\u6837\u4f20\u9012\u53c2\u6570\u7684\u65f6\u5019\uff0c\u7b2c\u4e00\u4e2a\u6c42\u503c\u7ed3\u679c\uff08</p> <pre><code>.Values.favorite.drink\n</code></pre> <p>\uff09\u4f1a\u4f5c\u4e3a\u4e00\u4e2a\u53c2\u6570\u53d1\u9001\u7ed9\u51fd\u6570\uff0c\u6211\u4eec\u53ef\u4ee5\u4fee\u6539\u4e0a\u9762\u7684 <code>drink</code> \u793a\u4f8b\uff0c\u7528\u4e00\u4e2a\u5e26\u6709\u4e24\u4e2a\u53c2\u6570\u7684\u51fd\u6570\u8fdb\u884c\u8bf4\u660e\uff1a<code>repeat COUNT STRING</code>\u3002</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: {{ .Values.favorite.drink | repeat 5 | quote }}\n  food: {{ .Values.favorite.food | upper | quote }}\n</code></pre> <p><code>repeat</code> \u51fd\u6570\u5c06\u91cd\u590d\u5b57\u7b26\u4e32\u7ed9\u5b9a\u7684\u6b21\u6570\uff0c\u6e32\u67d3\u540e\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u7684\u8f93\u51fa\u7ed3\u679c\uff1a</p> <pre><code># Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1575966939-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffeecoffeecoffeecoffeecoffee\"\n  food: \"PIZZA\"\n</code></pre>"},{"location":"kubernetes_package/templates/function/#default","title":"<code>default</code> \u51fd\u6570","text":"<p>\u5728\u6a21\u677f\u4e2d\u7ecf\u5e38\u4f1a\u4f7f\u7528\u5230\u7684\u4e00\u4e2a\u51fd\u6570\u662f <code>default</code> \u51fd\u6570\uff1a</p> <pre><code>default DEFAULT_VALUE GIVEN_VALUE\n</code></pre> <p>\uff0c\u8be5\u51fd\u6570\u5141\u8bb8\u4f60\u5728\u6a21\u677f\u5185\u90e8\u6307\u5b9a\u9ed8\u8ba4\u503c\uff0c\u6211\u4eec\u6765\u4fee\u6539\u4e0a\u9762\u793a\u4f8b\u4e2d\u7684\u6a21\u677f\uff1a</p> <pre><code>food: {{ .Values.favorite.food | default \"rice\" | upper | quote }}\n</code></pre> <p>\u6b63\u5e38\u8fd0\u884c\uff0c\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u5f97\u5230 <code>values.yaml</code> \u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684 pizza\uff1a</p> <pre><code># Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1575966939-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffeecoffeecoffeecoffeecoffee\"\n  food: \"PIZZA\"\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u4ece <code>values.yaml</code> \u6587\u4ef6\u4e2d\u79fb\u9664 food \u7684\u5b9a\u4e49\uff1a</p> <pre><code>favorite:\n  drink: coffee\n  # food: pizza\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u8fd0\u884c </p> <pre><code>helm install --generate-name --dry-run --debug ./mychart\n</code></pre> <p>\u5c06\u6e32\u67d3\u6210\u5982\u4e0b\u7684 YAML \u6587\u4ef6\uff1a</p> <pre><code># Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1575967394-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffeecoffeecoffeecoffeecoffee\"\n  food: \"RICE\"\n</code></pre> <p>\u5728\u4e00\u4e2a\u771f\u5b9e\u7684 chart \u6a21\u677f\u4e2d\uff0c\u6240\u6709\u7684\u9759\u6001\u9ed8\u8ba4\u503c\u90fd\u5e94\u4f4d\u4e8e <code>values.yaml</code> \u6587\u4ef6\u4e2d\uff0c\u5e76\u4e14\u4e0d\u5e94\u8be5\u91cd\u590d\u4f7f\u7528 <code>default</code> \u51fd\u6570\uff0c\u4f46\u662f\uff0c\u9ed8\u8ba4\u547d\u4ee4\u975e\u5e38\u9002\u5408\u8ba1\u7b97\u4e0d\u80fd\u5728 <code>values.yaml</code> \u6587\u4ef6\u4e2d\u58f0\u660e\u7684 values \u503c\uff0c\u4f8b\u5982\uff1a</p> <pre><code>food: {{ .Values.favorite.food | default (printf \"%s-rice\" (include \"fullname\" .)) }}\n</code></pre> <p>\u4e0d\u8fc7\u5728\u6709\u4e9b\u5730\u65b9\uff0c<code>if</code> \u6761\u4ef6\u8bed\u53e5\u53ef\u80fd\u6bd4 default \u51fd\u6570\u66f4\u5408\u9002\uff0c\u6211\u4eec\u4f1a\u5728\u540e\u9762\u4e86\u89e3\u5230\u3002</p> <p>\u6a21\u677f\u51fd\u6570\u548c\u7ba1\u9053\u662f\u5c06\u6570\u636e\u8f6c\u6362\u540e\u7136\u540e\u5c06\u5176\u63d2\u5165\u5230 YAML \u6587\u4ef6\u4e2d\u7684\u4e00\u79cd\u5f3a\u5927\u65b9\u6cd5\uff0c\u4f46\u662f\u6709\u7684\u65f6\u5019\u6709\u5fc5\u8981\u6dfb\u52a0\u4e00\u4e9b\u6a21\u677f\u903b\u8f91\uff0c\u8fd9\u4e9b\u903b\u8f91\u6bd4\u4ec5\u4ec5\u63d2\u5165\u5b57\u7b26\u4e32\u8981\u590d\u6742\u5f97\u591a\uff0c\u4e0b\u9762\u6211\u4eec\u5c06\u6765\u4e86\u89e3\u6a21\u677f\u8bed\u8a00\u4e2d\u63d0\u4f9b\u7684\u63a7\u5236\u6d41\u7a0b\u3002</p>"},{"location":"kubernetes_package/templates/function/#_3","title":"\u8fd0\u7b97\u7b26\u51fd\u6570","text":"<p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u6a21\u677f\u4e2d\uff0c\u8fd0\u7b97\u7b26\uff08eq\u3001ne\u3001lt\u3001gt\u3001and\u3001or \u7b49\u7b49\uff09\u5747\u5b9e\u73b0\u4e3a\u51fd\u6570\uff0c\u5728\u7ba1\u9053\u4e2d\uff0c\u8fd0\u7b97\u7b26\u53ef\u4ee5\u7528\u62ec\u53f7<code>\uff08\uff09</code>\u8fdb\u884c\u5206\u5272\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u53bb\u4e86\u89e3\u63a7\u5236\u6d41\u7a0b\u6761\u4ef6\u8bed\u53e5\u3001\u5faa\u73af\u548c\u4f5c\u7528\u57df\u4fee\u9970\u7b26\u7684\u4f7f\u7528\u3002</p>"},{"location":"kubernetes_package/templates/named_templates/","title":"\u547d\u540d\u6a21\u677f","text":""},{"location":"kubernetes_package/templates/named_templates/#_1","title":"\u547d\u540d\u6a21\u677f","text":"<p>\u524d\u9762\u6211\u4eec\u90fd\u662f\u53ea\u64cd\u4f5c\u7684\u4e00\u4e2a\u6a21\u677f\uff0c\u73b0\u5728\u6211\u4eec\u6765\u5c1d\u8bd5\u4f7f\u7528\u591a\u4e2a\u6a21\u677f\u6587\u4ef6\u3002\u5728\u672c\u8282\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u4e86\u89e3\u5230\u5982\u4f55\u5728\u4e00\u4e2a\u6587\u4ef6\u4e2d\u5b9a\u4e49\u547d\u540d\u6a21\u677f\uff0c\u7136\u540e\u5728\u5176\u4ed6\u5730\u65b9\u4f7f\u7528\u5b83\u4eec\u3002\u547d\u540d\u6a21\u677f\uff08\u6709\u65f6\u4e5f\u53eb\u5b50\u6a21\u677f\uff09\u53ea\u662f\u5728\u6587\u4ef6\u5185\u90e8\u5b9a\u4e49\u7684\u6709\u540d\u79f0\u7684\u6a21\u677f\u3002\u4e3b\u8981\u6709\u4e24\u79cd\u521b\u5efa\u65b9\u5f0f\u4ee5\u53ca\u51e0\u79cd\u4e0d\u540c\u7684\u4f7f\u7528\u65b9\u5f0f\u3002</p> <p>\u5f53\u4f7f\u7528\u547d\u540d\u6a21\u677f\u7684\u65f6\u5019\u6709\u51e0\u4e2a\u91cd\u8981\u7ec6\u8282\uff1a\u6a21\u677f\u540d\u79f0\u662f<code>\u5168\u5c40</code>\u7684\uff0c\u5982\u679c\u58f0\u660e\u4e24\u4e2a\u5177\u6709\u76f8\u540c\u540d\u79f0\u7684\u6a21\u677f\uff0c\u5219\u4f1a\u4f7f\u7528\u6700\u540e\u88ab\u52a0\u8f7d\u7684\u6a21\u677f\u3002\u7531\u4e8e\u5b50 chart \u4e2d\u7684\u6a21\u677f\u662f\u4e0e\u9876\u7ea7\u6a21\u677f\u4e00\u8d77\u7f16\u8bd1\u7684\uff0c\u6240\u4ee5\u9700\u8981\u8c28\u614e\u547d\u540d\u3002</p> <p>\u4e00\u79cd\u6d41\u884c\u7684\u547d\u540d\u7ea6\u5b9a\u662f\u5728\u6bcf\u4e2a\u5b9a\u4e49\u7684\u6a21\u677f\u524d\u6dfb\u52a0 chart \u540d\u79f0\uff1a</p> <pre><code>{{ define \"mychart.labels\" }}\n</code></pre> <p>\uff0c\u901a\u8fc7\u4f7f\u7528\u7279\u5b9a\u7684 chart \u540d\u4f5c\u4e3a\u524d\u7f00\uff0c\u6211\u4eec\u53ef\u4ee5\u907f\u514d\u7531\u4e8e\u4e24\u4e2a\u4e0d\u540c\u7684 chart \u5b9e\u73b0\u4e86\u76f8\u540c\u540d\u79f0\u7684\u6a21\u677f\u800c\u5f15\u8d77\u7684\u51b2\u7a81\u3002</p>"},{"location":"kubernetes_package/templates/named_templates/#partials_","title":"partials \u548c _ \u6587\u4ef6","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u53ea\u4f7f\u7528\u4e86\u4e00\u4e2a\u6a21\u677f\u6587\u4ef6\uff0c\u4f46\u662f Helm \u7684\u6a21\u677f\u8bed\u8a00\u5141\u8bb8\u6211\u4eec\u521b\u5efa\u547d\u540d\u7684\u5d4c\u5165\u5f0f\u6a21\u677f\uff0c\u53ef\u4ee5\u5728\u5176\u4ed6\u4f4d\u7f6e\u8fdb\u884c\u8bbf\u95ee\u3002\u5728\u7f16\u5199\u8fd9\u4e9b\u6a21\u677f\u4e4b\u524d\uff0c\u6709\u4e00\u4e9b\u503c\u5f97\u4e00\u63d0\u7684\u547d\u540d\u7ea6\u5b9a\uff1a</p> <ul> <li><code>templates/</code> \u4e2d\u7684\u5927\u591a\u6570\u6587\u4ef6\u90fd\u88ab\u89c6\u4e3a Kubernetes \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff08NOTES.txt \u9664\u5916\uff09</li> <li>\u4ee5 <code>_</code> \u5f00\u5934\u547d\u540d\u7684\u6587\u4ef6\u4e5f\u4e0d\u4f1a\u88ab\u5f53\u505a Kubernetes \u8d44\u6e90\u6e05\u5355\u6587\u4ef6</li> <li>\u4e0b\u5212\u7ebf\u5f00\u5934\u7684\u6587\u4ef6\u4e0d\u4f1a\u88ab\u5f53\u505a\u8d44\u6e90\u6e05\u5355\u4e4b\u5916\uff0c\u8fd8\u53ef\u4ee5\u88ab\u5176\u4ed6 chart \u6a21\u677f\u8c03\u7528</li> </ul> <p><code>_</code> \u5f00\u5934\u7684\u8fd9\u4e9b\u6587\u4ef6\u5176\u5b9e\u5c31\u662f Helm \u4e2d\u7684 <code>partials</code> \u6587\u4ef6\uff0c\u6240\u4ee5\u5176\u5b9e\u6211\u4eec\u5b8c\u5168\u53ef\u4ee5\u5c06\u547d\u540d\u6a21\u677f\u5b9a\u4e49\u5728\u8fd9\u4e9b <code>partials</code> \u6587\u4ef6\u4e2d\uff0c\u9ed8\u8ba4\u5c31\u662f <code>_helpers.tpl</code> \u6587\u4ef6\uff0c\u5176\u5b9e\u5728\u524d\u9762\u6211\u4eec\u521b\u5efa\u7684 <code>mychart</code> \u5305\u4e2d\u4e5f\u53ef\u4ee5\u627e\u5230\u8fd9\u4e2a\u6587\u4ef6\u3002</p>"},{"location":"kubernetes_package/templates/named_templates/#define_template","title":"<code>define</code> \u548c <code>template</code>","text":"<p><code>define</code> \u5173\u952e\u5b57\u53ef\u4ee5\u8ba9\u6211\u4eec\u5728\u6a21\u677f\u6587\u4ef6\u4e2d\u521b\u5efa\u547d\u540d\u6a21\u677f\uff0c\u5b83\u7684\u8bed\u6cd5\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>{{ define \"MY.NAME\" }}\n  # \u6a21\u677f\u5185\u5bb9\u533a\u57df\n{{ end }}\n</code></pre> <p>\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a\u6a21\u677f\u6765\u5c01\u88c5\u4e0b Kubernetes \u7684 labels \u6807\u7b7e\uff1a</p> <pre><code>{{- define \"mychart.labels\" }}\n  labels:\n    generator: helm\n    date: {{ now | htmlDate }}\n{{- end }}\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u5c06\u8be5\u6a21\u677f\u5d4c\u5165\u5230\u524d\u9762\u7684 ConfigMap \u6a21\u677f\u4e2d\uff0c\u7136\u540e\u5c06\u5176\u5305\u542b\u5728\u6a21\u677f\u4e2d\uff1a</p> <pre><code>{{- define \"mychart.labels\" }}\n  labels:\n    generator: helm\n    date: {{ now | htmlDate }}\n{{- end }}\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\n  {{- template \"mychart.labels\" }}\ndata:\n  myvalue: \"Hello World\"\n  {{- range $key, $val := .Values.favorite }}\n  {{ $key }}: {{ $val | quote }}\n  {{- end }}\n</code></pre> <p>\u5f53\u6a21\u677f\u5f15\u64ce\u8bfb\u53d6\u8fd9\u4e2a\u6587\u4ef6\u7684\u65f6\u5019\uff0c\u5b83\u4f1a\u5b58\u50a8 <code>mychart.labels</code> \u7684\u5f15\u7528\uff0c\u76f4\u5230\u8be5\u6a21\u677f\u88ab\u8c03\u7528\uff0c\u7136\u540e\u4f1a\u5185\u8054\u6e32\u67d3\u8be5\u6a21\u677f\u3002\u6211\u4eec\u6e32\u67d3\u8fd9\u4e2a\u6a21\u677f\u53ef\u4ee5\u90fd\u5230\u5982\u4e0b\u6240\u793a\u7684\u7ed3\u679c\uff08\u8bb0\u5f97\u5148\u5220\u6389\u9ed8\u8ba4\u751f\u6210\u7684 <code>_helpers.tpl</code> \u6587\u4ef6\uff09\uff1a</p> <pre><code># Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1576034036-configmap\n  labels:\n    generator: helm\n    date: 2019-12-11\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffee\"\n  food: \"pizza\"\n</code></pre> <p>\u4e00\u822c\u6765\u8bf4\uff0cHelm \u4e2d\u7ea6\u5b9a\u5c06\u8fd9\u4e9b\u6a21\u677f\u7edf\u4e00\u653e\u5230\u4e00\u4e2a partials \u6587\u4ef6\u4e2d\uff0c\u901a\u5e38\u5c31\u662f <code>_helpers.tpl</code> \u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u5c06\u4e0a\u9762\u7684\u547d\u540d\u6a21\u677f\u79fb\u52a8\u5230\u8be5\u6587\u4ef6\uff08</p> <pre><code>templates/_helpers.tpl\n</code></pre> <p>\uff09\u4e2d\u53bb\uff1a</p> <pre><code>{{/* \u751f\u6210\u57fa\u672c\u7684 Label \u6807\u7b7e */}}\n{{- define \"mychart.labels\" }}\n  labels:\n    generator: helm\n    date: {{ now | htmlDate }}\n{{- end }}\n</code></pre> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u6211\u4eec\u4e5f\u4f1a\u7528\u4e00\u4e2a\u7b80\u5355\u7684\u5757\uff08<code>{{/*...*/}}</code>\uff09\u6765\u6ce8\u91ca\u8fd9\u4e2a\u547d\u540d\u6a21\u677f\u7684\u4f5c\u7528\u3002</p> <p>\u73b0\u5728\u867d\u7136\u6211\u4eec\u628a\u547d\u540d\u6a21\u677f\u653e\u5230\u4e86 <code>_helpers.tpl</code> \u6587\u4ef6\u4e2d\uff0c\u4f46\u662f\u6211\u4eec\u5728 <code>configmap.yaml</code> \u6a21\u677f\u4e2d\u8fd8\u662f\u53ef\u4ee5\u8bbf\u95ee\uff0c\u56e0\u4e3a\u547d\u540d\u6a21\u677f\u662f\u5168\u5c40\u7684\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\n  {{- template \"mychart.labels\" }}\ndata:\n  myvalue: \"Hello World\"\n  {{- range $key, $val := .Values.favorite }}\n  {{ $key }}: {{ $val | quote }}\n  {{- end }}\n</code></pre> <p>\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u63d0\u5230\u8fc7\u547d\u540d\u6a21\u677f\u662f\u5168\u5c40\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u518d\u6e32\u67d3\u4e0b\u4e0a\u9762\u7684\u6a21\u677f\u53ef\u4ee5\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c\u3002</p>"},{"location":"kubernetes_package/templates/named_templates/#_2","title":"\u8bbe\u7f6e\u6a21\u677f\u8303\u56f4","text":"<p>\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u7684\u6a21\u677f\u4e2d\uff0c\u8fd8\u6ca1\u6709\u4f7f\u7528\u5230\u4efb\u4f55\u5bf9\u8c61\uff0c\u53ea\u4f7f\u7528\u4e86\u51fd\u6570\uff0c\u73b0\u5728\u6211\u4eec\u6765\u4fee\u6539\u4e0b\u5b9a\u4e49\u7684\u547d\u540d\u6a21\u677f\uff0c\u5305\u542b chart \u7684\u540d\u79f0\u548c\u7248\u672c\uff1a</p> <pre><code>{{/* \u751f\u6210\u57fa\u672c\u7684 Label \u6807\u7b7e */}}\n{{- define \"mychart.labels\" }}\n  labels:\n    generator: helm\n    date: {{ now | htmlDate }}\n    chart: {{ .Chart.Name }}\n    version: {{ .Chart.Version }}\n{{- end }}\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6765\u6e32\u67d3\u4e0b\u6a21\u677f\uff0c\u4f1a\u51fa\u73b0\u4e0b\u9762\u7684\u9519\u8bef\uff1a</p> <pre><code>$ helm install --generate-name --dry-run --debug ./my\nchart\ninstall.go:148: [debug] Original chart version: \"\"\ninstall.go:165: [debug] CHART PATH: /Users/ych/devs/workspace/yidianzhishi/cour\nse/k8strain/content/helm/manifests/mychart\n\nError: unable to build kubernetes objects from release manifest: error validati\nng \"\": error validating data: [unknown object type \"nil\" in ConfigMap.metadata.\nlabels.chart, unknown object type \"nil\" in ConfigMap.metadata.labels.version]\nhelm.go:76: [debug] error validating \"\": error validating data: [unknown object\n type \"nil\" in ConfigMap.metadata.labels.chart, unknown object type \"nil\" in Co\nnfigMap.metadata.labels.version]\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u63d0\u793a <code>labels.chart</code> \u4e3a <code>nil</code>\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u4f7f\u7528\u7684 <code>.Chart.Name</code> \u4e0d\u5728\u5b9a\u4e49\u7684\u8fd9\u4e2a\u6a21\u677f\u7684\u4f5c\u7528\u57df\u8303\u56f4\u5185\uff0c\u5f53\u6e32\u67d3\u547d\u540d\u6a21\u677f\uff08\u4f7f\u7528 <code>define</code> \u5b9a\u4e49\uff09\u7684\u65f6\u5019\uff0c\u5b83\u5c06\u63a5\u6536\u6a21\u677f\u8c03\u7528\u4f20\u9012\u7684\u4f5c\u7528\u57df\u3002\u5728\u6211\u4eec\u8fd9\u4e2a\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u662f\u8fd9\u6837\u5f15\u7528\u8fd9\u4e2a\u6a21\u677f\u7684\uff1a</p> <pre><code>{{- template \"mychart.labels\" }}\n</code></pre> <p>\u6ca1\u6709\u4f20\u5165\u4efb\u4f55\u4f5c\u7528\u57df\uff0c\u6240\u4ee5\u5728\u6a21\u677f\u5185\u6211\u4eec\u65e0\u6cd5\u8bbf\u95ee <code>.</code> \u4e2d\u7684\u4efb\u4f55\u5185\u5bb9\uff0c\u5f53\u7136\u8981\u89e3\u51b3\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u53ea\u9700\u8981\u628a\u4f5c\u7528\u57df\u8303\u56f4\u4f20\u9012\u7ed9\u6a21\u677f\u5373\u53ef\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\n  {{- template \"mychart.labels\" . }}\n......\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u5728\u4f7f\u7528 <code>template</code> \u8c03\u7528\u6a21\u677f\u7684\u65f6\u5019\u4f20\u9012\u4e86 <code>.</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u5f88\u5bb9\u6613\u4f20\u9012 <code>.Values</code> \u6216\u8005 <code>.Values.favorite</code> \u6216\u8005\u6211\u4eec\u60f3\u8981\u7684\u4efb\u4f55\u8303\u56f4\uff0c\u4f46\u662f\u8fd9\u91cc\u6211\u4eec\u60f3\u8981\u7684\u662f\u9876\u7ea7\u4f5c\u7528\u57df\uff0c\u6240\u4ee5\u6211\u4eec\u4f20\u9012\u7684\u662f <code>.</code>\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u518d\u6765\u91cd\u65b0\u6e32\u67d3\u6211\u4eec\u7684\u6a21\u677f\uff0c\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u7ed3\u679c\uff1a</p> <pre><code># Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1576035668-configmap\n  labels:\n    generator: helm\n    date: 2019-12-11\n    chart: mychart\n    version: 0\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffee\"\n  food: \"pizza\"\n</code></pre> <p>\u73b0\u5728 <code>{{ .Chart.Name }}</code> \u89e3\u6790\u4e3a\u4e86 mychart\uff0c\u800c <code>{{ .Chart.Version }}</code> \u89e3\u6790\u4e3a\u4e86 <code>0.1.0</code>\u3002</p>"},{"location":"kubernetes_package/templates/named_templates/#include","title":"include \u51fd\u6570","text":"<p>\u5047\u8bbe\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u7b80\u5355\u6a21\u677f\uff1a</p> <pre><code>{{- define \"mychart.app\" -}}\napp_name: {{ .Chart.Name }}\napp_version: \"{{ .Chart.Version }}\"\n{{- end -}}\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u60f3\u628a\u4e0a\u9762\u7684\u5185\u5bb9\u63d2\u5165\u5230\u6a21\u677f\u7684 <code>labels</code> \u90e8\u5206\uff0c\u5728 <code>data</code> \u90e8\u5206\u4e5f\u60f3\u8981\u8fd9\u4e2a\u5185\u5bb9\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\n  labels:\n    {{ template \"mychart.app\" . }}\ndata:\n  myvalue: \"Hello World\"\n  {{- range $key, $val := .Values.favorite }}\n  {{ $key }}: {{ $val | quote }}\n  {{- end }}\n{{ template \"mychart.app\" . }}\n</code></pre> <p>\u4f46\u662f\u6211\u4eec\u76f4\u63a5\u6e32\u67d3\u4e0a\u9762\u7684\u6a21\u677f\u8fd8\u662f\u4f1a\u6709\u9519\u8bef\uff1a</p> <pre><code>$ helm install --generate-name --dry-run --debug ./my\nchart\ninstall.go:148: [debug] Original chart version: \"\"\ninstall.go:165: [debug] CHART PATH: /Users/ych/devs/workspace/yidianzhishi/cour\nse/k8strain/content/helm/manifests/mychart\n\nError: unable to build kubernetes objects from release manifest: error validati\nng \"\": error validating data: [ValidationError(ConfigMap): unknown field \"app_n\name\" in io.k8s.api.core.vConfigMap, ValidationError(ConfigMap): unknown field\n \"app_version\" in io.k8s.api.core.vConfigMap]\nhelm.go:76: [debug] error validating \"\": error validating data: [ValidationErro\nr(ConfigMap): unknown field \"app_name\" in io.k8s.api.core.vConfigMap, Validat\nionError(ConfigMap): unknown field \"app_version\" in io.k8s.api.core.vConfigMap]\n......\n</code></pre> <p>\u56e0\u4e3a <code>template</code> \u53ea\u662f\u4e00\u4e2a\u52a8\u4f5c\uff0c\u800c\u4e0d\u662f\u4e00\u4e2a\u51fd\u6570\uff0c\u6240\u4ee5\u65e0\u6cd5\u5c06\u6a21\u677f\u8c03\u7528\u7684\u8f93\u51fa\u4f20\u9012\u7ed9\u5176\u4ed6\u51fd\u6570\uff0c\u53ea\u662f\u5185\u8054\u63d2\u5165\uff0c\u76f8\u5f53\u4e8e\u6e32\u67d3\u7684\u7ed3\u679c\u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: measly-whippet-configmap\n  labels:\n    app_name: mychart\napp_version: \"0+1478129847\"\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffee\"\n  food: \"pizza\"\n  app_name: mychart\napp_version: \"0+1478129847\"\n</code></pre> <p>\u5f88\u660e\u663e\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u662f\u4e0d\u7b26\u5408 ConfigMap \u8d44\u6e90\u5bf9\u8c61\u7684\u683c\u5f0f\u8981\u6c42\u7684\uff0c\u6240\u4ee5\u62a5\u9519\u4e86\u3002\u4e3a\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cHelm \u63d0\u4f9b\u4e86\u4ee3\u66ff <code>template</code> \u7684\u51fd\u6570 <code>include</code>\uff0c\u53ef\u4ee5\u5c06\u6a21\u677f\u7684\u5185\u5bb9\u5bfc\u5165\u5230\u5f53\u524d\u7684\u7ba1\u9053\u4e2d\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5728\u7ba1\u9053\u4e2d\u4f20\u9012\u7ed9\u5176\u4ed6\u51fd\u6570\u8fdb\u884c\u5904\u7406\u4e86\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\n  labels:\n{{ include \"mychart.app\" . | indent 4 }}\ndata:\n  myvalue: \"Hello World\"\n  {{- range $key, $val := .Values.favorite }}\n  {{ $key }}: {{ $val | quote }}\n  {{- end }}\n{{ include \"mychart.app\" . | indent 2 }}\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u6e32\u67d3\u5c31\u53ef\u4ee5\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c\u4e86\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u7528 <code>include</code> \u51fd\u6570\u5f97\u5230\u6a21\u677f\u5185\u5bb9\u540e\u901a\u8fc7\u7ba1\u9053\u4f20\u7ed9\u4e86\u540e\u9762\u7684 <code>indent</code> \u51fd\u6570\u6765\u4fdd\u8bc1\u4e86\u7f29\u8fdb\uff1a</p> <pre><code>Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1576036671-configmap\n  labels:\n    app_name: mychart\n    app_version: \"0\"\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffee\"\n  food: \"pizza\"\n  app_name: mychart\n  app_version: \"0\"\n</code></pre> <p>\u5efa\u8bae</p> <p>\u5728 Helm \u6a21\u677f\u4e2d\u6700\u597d\u4f7f\u7528 <code>include</code> \u800c\u4e0d\u662f <code>template</code>\uff0c\u8fd9\u6837\u53ef\u4ee5\u66f4\u597d\u5730\u5904\u7406 YAML \u6587\u6863\u7684\u8f93\u51fa\u683c\u5f0f\u3002</p> <p>\u6709\u65f6\u5019\u5982\u679c\u6211\u4eec\u53ea\u60f3\u5bfc\u5165\u5185\u5bb9\u800c\u4e0d\u662f\u6a21\u677f\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u63cf\u8ff0\u7684 <code>.Files</code> \u5bf9\u8c61\u6765\u8bbf\u95ee\u6587\u4ef6\u5b9e\u73b0\u3002</p>"},{"location":"kubernetes_package/templates/notes_files/","title":"NOTES.txt \u6587\u4ef6","text":""},{"location":"kubernetes_package/templates/notes_files/#notestxt","title":"NOTES.txt \u6587\u4ef6","text":"<p>\u5728\u672c\u8282\u4e2d\u6211\u4eec\u5c06\u6765\u4e86\u89e3\u4e3a chart \u7528\u6237\u63d0\u4f9b\u8bf4\u660e\u7684\u4e00\u4e2a <code>NOTES.txt</code> \u6587\u4ef6\uff0c\u5728 chart \u5b89\u88c5\u6216\u8005\u5347\u7ea7\u7ed3\u675f\u65f6\uff0cHelm \u53ef\u4ee5\u4e3a\u7528\u6237\u6253\u5370\u51fa\u4e00\u4e9b\u6709\u7528\u7684\u4fe1\u606f\uff0c\u4f7f\u7528\u6a21\u677f\u4e5f\u53ef\u4ee5\u81ea\u5b9a\u4e49\u8fd9\u4e9b\u4fe1\u606f\u3002</p> <p>\u8981\u5c06\u5b89\u88c5\u8bf4\u660e\u6dfb\u52a0\u5230 chart \u4e2d\uff0c\u53ea\u9700\u8981\u521b\u5efa\u4e00\u4e2a <code>templates/NOTES.txt</code> \u6587\u4ef6\uff0c\u8be5\u6587\u4ef6\u7eaf\u6587\u672c\u7684\uff0c\u4f46\u662f\u53ef\u4ee5\u50cf\u6a21\u677f\u4e00\u6837\u8fdb\u884c\u5904\u7406\uff0c\u5e76\u5177\u6709\u6240\u6709\u5e38\u89c4\u6a21\u677f\u7684\u529f\u80fd\u548c\u53ef\u7528\u5bf9\u8c61\u3002</p> <p>\u73b0\u5728\u8ba9\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a\u7b80\u5355\u7684 <code>NOTES.txt</code> \u6587\u4ef6\uff1a</p> <pre><code>Thank you for installing {{ .Chart.Name }}.\n\nYour release is named {{ .Release.Name }}.\n\nTo learn more about the release, try:\n\n  $ helm status {{ .Release.Name }}\n  $ helm get {{ .Release.Name }}\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u8fd0\u884c </p> <pre><code>helm install ./mychart\n</code></pre> <p>\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u5e95\u90e8\u770b\u5230\u8fd9\u6837\u7684\u6d88\u606f\uff1a</p> <pre><code>RESOURCES:\n==&gt; v1/Secret\nNAME                   TYPE      DATA      AGE\nrude-cardinal-secret   Opaque    1         0s\n\n==&gt; v1/ConfigMap\nNAME                      DATA      AGE\nrude-cardinal-configmap   3         0s\n\n\nNOTES:\nThank you for installing mychart.\n\nYour release is named rude-cardinal.\n\nTo learn more about the release, try:\n  $ helm status rude-cardinal\n  $ helm get rude-cardinal\n</code></pre> <p>\u7528\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u5411\u7528\u6237\u63d0\u4f9b\u4e00\u4e2a\u6709\u5173\u5982\u4f55\u4f7f\u7528\u5176\u65b0\u5b89\u88c5\u7684 chart \u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u5f3a\u70c8\u5efa\u8bae\u521b\u5efa <code>NOTES.txt</code> \u6587\u4ef6\uff0c\u867d\u7136\u8fd9\u4e0d\u662f\u5fc5\u987b\u7684\u3002</p>"},{"location":"kubernetes_package/templates/objects/","title":"\u5185\u7f6e\u5bf9\u8c61","text":""},{"location":"kubernetes_package/templates/objects/#_1","title":"\u5185\u7f6e\u5bf9\u8c61","text":"<p>\u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86 Helm Chart \u7684\u4e00\u4e9b\u57fa\u672c\u6982\u5ff5\u548c\u4f7f\u7528\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u91cd\u70b9\u4ecb\u7ecd\u4e0b Chart \u6a21\u677f\u7684\u7f16\u5199\u3002\u6a21\u677f\u4f1a\u6e32\u67d3\u6210 Kubernetes \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u4e0b\u9762\u6211\u4eec\u5c06\u6765\u5b66\u4e60\u4e0b\u6a21\u677f\u7684\u7ed3\u6784\uff0c\u5982\u4f55\u4f7f\u7528\u5b83\u4eec\uff0c\u5982\u4f55\u7f16\u5199 Go \u6a21\u677f\u4ee5\u53ca\u5982\u4f55\u8c03\u8bd5\u3002</p> <p>\u5bf9\u8c61\u4ece\u6a21\u677f\u5f15\u64ce\u4f20\u9012\u5230\u6a21\u677f\u4e2d\uff0c\u5728\u4ee3\u7801\u4e2d\u53ef\u4ee5\u4f20\u9012\u5bf9\u8c61\uff0c\u4e5f\u6709\u4e00\u79cd\u65b9\u6cd5\u53ef\u4ee5\u5728\u6a21\u677f\u5b8f\u521b\u5efa\u65b0\u7684\u5bf9\u8c61\uff0c\u6bd4\u5982 <code>tuple</code> \u51fd\u6570\u3002\u5bf9\u8c61\u53ef\u4ee5\u5f88\u7b80\u5355\uff0c\u4e5f\u53ef\u4ee5\u5305\u542b\u5176\u4ed6\u5bf9\u8c61\u6216\u51fd\u6570\uff0c\u4f8b\u5982\uff0cRelease \u5bf9\u8c61\u5c31\u5305\u542b\u51e0\u4e2a\u5bf9\u8c61\uff08\u6bd4\u5982 Release.Name\uff09\uff0cFiles \u5bf9\u8c61\u5c31\u5305\u542b\u51e0\u4e2a\u51fd\u6570\u3002</p> <p>\u524d\u9762\u63d0\u5230\u8fc7\u6211\u4eec\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u4f7f\u7528 <code>{{ .Release.Name }}</code> \u83b7\u53d6 release \u7684\u540d\u79f0\uff0cRelease \u662f\u6211\u4eec\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u8bbf\u95ee\u7684\u51e0\u4e2a\u9876\u7ea7\u5bf9\u8c61\u4e4b\u4e00\uff1a</p> <ul> <li> <p><code>Release</code>\uff1a\u8be5\u5bf9\u8c61\u63cf\u8ff0\u4e86 release \u672c\u8eab\u7684\u76f8\u5173\u4fe1\u606f\uff0c\u5b83\u5185\u90e8\u6709\u51e0\u4e2a\u5bf9\u8c61\uff1a</p> <ul> <li><code>Release.Name</code>\uff1arelease \u540d\u79f0</li> <li><code>Release.Namespace</code>\uff1arelease \u5b89\u88c5\u5230\u7684\u547d\u540d\u7a7a\u95f4</li> <li><code>Release.IsUpgrade</code>\uff1a\u5982\u679c\u5f53\u524d\u64cd\u4f5c\u662f\u5347\u7ea7\u6216\u56de\u6eda\uff0c\u5219\u8be5\u503c\u4e3a true</li> <li><code>Release.IsInstall</code>\uff1a\u5982\u679c\u5f53\u524d\u64cd\u4f5c\u662f\u5b89\u88c5\uff0c\u5219\u5c06\u5176\u8bbe\u7f6e\u4e3a true</li> <li><code>Release.Revision</code>\uff1arelease \u7684 revision \u7248\u672c\u53f7\uff0c\u5728\u5b89\u88c5\u7684\u65f6\u5019\uff0c\u503c\u4e3a1\uff0c\u6bcf\u6b21\u5347\u7ea7\u6216\u56de\u6eda\u90fd\u4f1a\u589e\u52a0</li> <li><code>Reelase.Service</code>\uff1a\u6e32\u67d3\u5f53\u524d\u6a21\u677f\u7684\u670d\u52a1\uff0c\u5728 Helm \u4e0a\uff0c\u5b9e\u9645\u4e0a\u8be5\u503c\u59cb\u7ec8\u4e3a Helm</li> <li> <p><code>Values</code>\uff1a\u4ece <code>values.yaml</code> \u6587\u4ef6\u548c\u7528\u6237\u63d0\u4f9b\u7684 values \u6587\u4ef6\u4f20\u9012\u5230\u6a21\u677f\u7684 Values \u503c\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cValues \u662f\u7a7a\u7684\u3002</p> </li> </ul> </li> <li> <p><code>Chart</code>\uff1a\u83b7\u53d6 <code>Chart.yaml</code> \u6587\u4ef6\u7684\u5185\u5bb9\uff0c\u8be5\u6587\u4ef6\u4e2d\u7684\u4efb\u4f55\u6570\u636e\u90fd\u53ef\u4ee5\u8bbf\u95ee\uff0c\u4f8b\u5982 </p> <pre><code>{{ .Chart.Name }}-{{ .Chart.Version}}\n</code></pre> <p>\u53ef\u4ee5\u6e32\u67d3\u6210 <code>mychart-0.1.0</code>\uff0c\u8be5\u5bf9\u8c61\u4e0b\u9762\u53ef\u7528\u7684\u5b57\u6bb5\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u63d0\u5230\u8fc7\u4e86\u3002 *   &gt; <code>Files</code>\uff1a\u53ef\u4ee5\u8bbf\u95ee chart \u4e2d\u7684\u6240\u6709\u975e\u7279\u6b8a\u6587\u4ef6\uff0c\u867d\u7136\u65e0\u6cd5\u4f7f\u7528\u5b83\u6765\u8bbf\u95ee\u6a21\u677f\u6587\u4ef6\uff0c\u4f46\u662f\u53ef\u4ee5\u6765\u8bbf\u95ee chart \u4e2d\u7684\u5176\u4ed6\u6587\u4ef6\u3002</p> <ul> <li> <p><code>Files.Get</code>\uff1a\u7528\u4e8e\u6839\u636e\u540d\u79f0\u83b7\u53d6\u6587\u4ef6\uff08\u6bd4\u5982 </p> <pre><code>.Files.Get config.ini\n</code></pre> <p>\uff09     *   <code>Files.GetBytes</code>\uff1a\u7528\u4e8e\u4ee5 bytes \u6570\u7ec4\u800c\u4e0d\u662f\u5b57\u7b26\u4e32\u7684\u5f62\u5f0f\u6765\u83b7\u53d6\u6587\u4ef6\u5185\u5bb9\u7684\u51fd\u6570\uff0c\u8fd9\u5bf9\u4e8e\u7c7b\u4f3c\u4e8e\u56fe\u7247\u4e4b\u7c7b\u7684\u4e1c\u897f\u5f88\u6709\u7528     *   <code>Files.Glob</code>\uff1a\u7528\u4e8e\u8fd4\u56de\u540d\u79f0\u4e8e\u7ed9\u5b9a\u7684 shell glob \u6a21\u5f0f\u5339\u914d\u7684\u6587\u4ef6\u5217\u8868     *   <code>Files.Lines</code>\uff1a\u53ef\u4ee5\u9010\u884c\u8bfb\u53d6\u6587\u4ef6\u7684\u51fd\u6570\uff0c\u5bf9\u4e8e\u904d\u5386\u6587\u4ef6\u4e2d\u7684\u6bcf\u884c\u5185\u5bb9\u5f88\u6709\u7528     *   <code>Files.AsSecrets</code>\uff1a\u5c06\u6587\u4ef6\u5185\u5bb9\u4ee5 Base64 \u7f16\u7801\u7684\u5b57\u7b26\u4e32\u8fd4\u56de\u7684\u51fd\u6570     *   <code>Files.AsConfig</code>\uff1a\u5c06\u6587\u4ef6\u6b63\u6587\u4f5c\u4e3a YAML \u5b57\u5178\u8fd4\u56de\u7684\u51fd\u6570 *   &gt; <code>Capabilities</code>\uff1a\u63d0\u4f9b\u4e86\u83b7\u53d6\u6709\u5173 Kubernetes \u96c6\u7fa4\u652f\u6301\u529f\u80fd\u7684\u4fe1\u606f\u7684\u5bf9\u8c61</p> </li> <li> <p><code>Capabilities.APIVersions</code></p> <p>\uff1a\u652f\u6301\u7684\u7248\u672c\u96c6\u5408     *   <code>Capabilities.APIVersions.Has $version</code></p> <p>\uff1a\u5224\u65ad\u4e00\u4e2a\u7248\u672c\uff08\u6bd4\u5982 <code>batch/v1</code>\uff09\u6216\u8d44\u6e90\uff08\u6bd4\u5982 <code>apps/v1/Deployment</code>\uff09\u662f\u5426\u53ef\u7528     *   <code>Capabilities.Kube.Version</code></p> <p>\uff1aKubernetes \u7684\u7248\u672c     *   <code>Capabilities.Kube</code>\uff1a\u662f Kubernetes \u7248\u672c\u7684\u7f29\u5199     *   <code>Capabilities.Kube.Major</code></p> <p>\uff1aKubernetes \u4e3b\u7248\u672c     *   <code>Capabilities.Kube.Minor</code></p> <p>\uff1aKubernetes \u7684\u6b21\u7248\u672c *   &gt; <code>Template</code>\uff1a\u5305\u542b\u5f53\u524d\u6b63\u5728\u6267\u884c\u7684\u6a21\u677f\u7684\u76f8\u5173\u4fe1\u606f</p> </li> <li> <p><code>Name</code>\uff1a\u5f53\u524d\u6a21\u677f\u7684\u547d\u540d\u7a7a\u95f4\u6587\u4ef6\u8def\u5f84\uff08\u6bd4\u5982 </p> <pre><code>mychart/templates/mytemplate.yaml\n</code></pre> <p>\uff09     *   <code>BaePath</code>\uff1a\u5f53\u524d chart \u7684\u6a21\u677f\u76ee\u5f55\u7684\u547d\u540d\u7a7a\u95f4\u8def\u5f84\uff08\u6bd4\u5982 <code>mychart/templates</code>\uff09</p> </li> </ul> </li> </ul> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u5185\u7f6e\u7684\u5bf9\u8c61\u59cb\u7ec8\u662f\u4ee5\u5927\u5199\u5b57\u6bcd\u5f00\u5934\u7684\uff0c\u8fd9\u4e5f\u662f\u7b26\u5408 Go \u7684\u547d\u540d\u7ea6\u5b9a\u7684\uff0c\u521b\u5efa\u81ea\u5df1\u7684\u540d\u79f0\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u81ea\u7531\u4f7f\u7528\u9002\u5408\u4f60\u56e2\u961f\u7684\u7ea6\u5b9a\uff0c\u4e00\u4e9b\u56e2\u961f\uff0c\u6bd4\u5982 Kubernetes Charts \u56e2\u961f\uff0c\u9009\u62e9\u4ec5\u4f7f\u7528\u9996\u5b57\u6bcd\u5c0f\u5199\uff0c\u4ee5\u533a\u5206\u672c\u5730\u540d\u79f0\u548c\u5185\u7f6e\u540d\u79f0\uff0c\u8fd9\u91cc\u6211\u4eec\u4e5f\u4f1a\u9075\u5faa\u8be5\u7ea6\u5b9a\u3002</p>"},{"location":"kubernetes_package/templates/subcharts_and_globals/","title":"\u5b50chart\u4e0e\u5168\u5c40\u503c","text":""},{"location":"kubernetes_package/templates/subcharts_and_globals/#subcharts_global_values","title":"Subcharts \u548c Global Values","text":"<p>\u5230\u73b0\u5728\u4e3a\u6b62\uff0c\u6211\u4eec\u4ece\u5355\u4e00\u6a21\u677f\uff0c\u5230\u591a\u4e2a\u6a21\u677f\u6587\u4ef6\uff0c\u4f46\u662f\u90fd\u4ec5\u4ec5\u662f\u5904\u7406\u7684\u4e00\u4e2a chart \u5305\uff0c\u4f46\u662f charts \u53ef\u80fd\u5177\u6709\u4e00\u4e9b\u4f9d\u8d56\u9879\uff0c\u6211\u4eec\u79f0\u4e3a <code>subcharts\uff08\u5b50 chart\uff09</code>\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a\u5b50 chart\u3002</p> <p>\u540c\u6837\u5728\u6df1\u5165\u4e86\u89e3\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3\u4e0b\u5b50 chart \u76f8\u5173\u7684\u4e00\u4e9b\u4fe1\u606f\u3002</p> <ul> <li>\u5b50 chart \u662f<code>\u72ec\u7acb</code>\u7684\uff0c\u8fd9\u610f\u5473\u7740\u5b50 chart \u4e0d\u80fd\u663e\u793a\u4f9d\u8d56\u5176\u7236 chart</li> <li>\u6240\u4ee5\u5b50 chart \u65e0\u6cd5\u8bbf\u95ee\u5176\u7236\u7ea7\u7684\u503c</li> <li>\u7236 chart \u53ef\u4ee5\u8986\u76d6\u5b50 chart \u7684\u503c</li> <li>Helm \u4e2d\u6709\u53ef\u4ee5\u88ab\u6240\u6709 charts \u8bbf\u95ee\u7684\u5168\u5c40\u503c\u7684\u6982\u5ff5</li> </ul>"},{"location":"kubernetes_package/templates/subcharts_and_globals/#chart","title":"\u521b\u5efa\u5b50chart","text":"<p>\u540c\u6837\u8fd8\u662f\u5728\u4e4b\u524d\u64cd\u4f5c\u7684 <code>mychart/</code> \u8fd9\u4e2a chart \u5305\u4e2d\uff0c\u6211\u4eec\u6765\u5c1d\u8bd5\u6dfb\u52a0\u4e00\u4e9b\u65b0\u7684\u5b50 chart\uff1a</p> <pre><code>$ cd mychart/charts\n$ helm create mysubchart\nCreating mysubchart\n$ rm -rf mysubchart/templates/*.*\n</code></pre> <p>\u548c\u524d\u9762\u4e00\u6837\uff0c\u6211\u4eec\u5220\u9664\u4e86\u6240\u6709\u7684\u57fa\u672c\u6a21\u677f\uff0c\u8fd9\u6837\u6211\u4eec\u53ef\u4ee5\u4ece\u5934\u5f00\u59cb\u3002</p>"},{"location":"kubernetes_package/templates/subcharts_and_globals/#values","title":"\u6dfb\u52a0 values \u548c \u6a21\u677f","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u4e3a mysubchart \u8fd9\u4e2a\u5b50 chart \u521b\u5efa\u4e00\u4e2a\u7b80\u5355\u7684\u6a21\u677f\u548c values \u503c\u6587\u4ef6\uff0c</p> <pre><code>mychart/charts/mysubchart\n</code></pre> <p>\u4e2d\u5df2\u7ecf\u6709\u4e00\u4e2a <code>values.yaml</code> \u6587\u4ef6\u4e86\uff0c\u5728\u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e0b\u9762\u7684 values\uff1a</p> <p><code>dessert: cake</code></p> <p>\u4e0b\u9762\u6211\u4eec\u518d\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 ConfigMap \u6a21\u677f </p> <pre><code>mychart/charts/mysubchart/templates/configmap.yaml\n</code></pre> <p>\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-cfgmap2\ndata:\n  dessert: {{ .Values.dessert }}\n</code></pre> <p>\u56e0\u4e3a\u6bcf\u4e2a\u5b50 chart \u90fd\u662f\u72ec\u7acb\u7684 chart\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5355\u72ec\u6d4b\u8bd5 <code>mysubchart</code>\uff1a</p> <pre><code>helm install --generate-name --dry-run --debug mychart/charts/mysubchart\ninstall.go:148: [debug] Original chart version: \"\"\ninstall.go:165: [debug] CHART PATH: /Users/ych/devs/workspace/yidianzhishi/course/k8strain/content/helm/manifests/mychart/charts/mysubchart\n\nNAME: mysubchart-1576050755\nLAST DEPLOYED: Wed Dec 11 15:52:36 2019\nNAMESPACE: default\nSTATUS: pending-install\nREVISION: 1\nTEST SUITE: None\nUSER-SUPPLIED VALUES:\n{}\n\nCOMPUTED VALUES:\ndessert: cake\n\nHOOKS:\nMANIFEST:\n---\n# Source: mysubchart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mysubchart-1576050755-cfgmap2\ndata:\n  dessert: cake\n</code></pre>"},{"location":"kubernetes_package/templates/subcharts_and_globals/#chart_values","title":"\u4ece\u7236 chart \u8986\u76d6 values","text":"<p>\u6211\u4eec\u539f\u6765\u7684 chart - mychart \u73b0\u5728\u662f mysubchart \u7684\u7236\u7ea7 chart \u4e86\u3002\u7531\u4e8e mychart \u662f\u7236\u7ea7\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728 mychart \u4e2d\u6307\u5b9a\u914d\u7f6e\uff0c\u5e76\u5c06\u8be5\u914d\u7f6e\u53d1\u9001\u5230 mysubchart \u4e2d\u53bb\uff0c\u6bd4\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd9\u6837\u4fee\u6539 <code>mychart/values.yaml</code>\uff1a</p> <pre><code>favorite:\n  drink: coffee\n  food: pizza\npizzaToppings:\n  - mushrooms\n  - cheese\n  - peppers\n  - onions\n\nmysubchart:\n  dessert: ice cream\n</code></pre> <p>\u6700\u540e\u4e24\u884c\uff0c<code>mysubchart</code> \u90e8\u5206\u4e2d\u7684\u6240\u6709\u6307\u4ee4\u90fd\u56de\u88ab\u53d1\u9001\u5230 <code>mysubchart</code> \u5b50 chart \u4e2d\uff0c\u6240\u4ee5\uff0c\u5982\u679c\u6211\u4eec\u73b0\u5728\u6e32\u67d3\u6a21\u677f\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>mysubchart</code> \u7684 ConfigMap \u4f1a\u88ab\u6e32\u67d3\u6210\u5982\u4e0b\u7684\u5185\u5bb9\uff1a</p> <pre><code># Source: mychart/charts/mysubchart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1576051914-cfgmap2\ndata:\n  dessert: ice cream\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u9876\u5c42\u7684 values \u503c\u8986\u76d6\u4e86\u5b50 chart \u4e2d\u7684\u503c\u3002\u8fd9\u91cc\u6709\u4e00\u4e2a\u7ec6\u8282\u9700\u8981\u6ce8\u610f\uff0c\u6211\u4eec\u6ca1\u6709\u5c06 </p> <pre><code>mychart/charts/mysubchart/templates/configmap.yaml\n</code></pre> <p>\u6a21\u677f\u66f4\u6539\u4e3a\u6307\u5411 </p> <pre><code>.Values.mysubchart.dessert\n</code></pre> <p>\uff0c\u56e0\u4e3a\u4ece\u8be5\u6a21\u677f\u7684\u7edd\u5ea6\u6765\u770b\uff0c\u8be5\u503c\u4ecd\u7136\u4f4d\u4e8e <code>.Values.dessert</code>\uff0c\u5f53\u6a21\u677f\u5f15\u64ce\u4f20\u9012 values \u503c\u7684\u65f6\u5019\uff0c\u5b83\u4f1a\u8bbe\u7f6e\u8fd9\u4e2a\u4f5c\u7528\u57df\uff0c\u6240\u4ee5\uff0c\u5bf9\u4e8e <code>mysubchart</code> \u6a21\u677f\uff0c<code>.Values</code> \u4e2d\u4ec5\u4ec5\u63d0\u4f9b\u7528\u4e8e\u8be5\u5b50 chart \u7684\u503c\u3002</p> <p>\u4f46\u662f\u6709\u65f6\u5019\u5982\u679c\u6211\u4eec\u786e\u5b9e\u5e0c\u671b\u67d0\u4e9b\u503c\u53ef\u4ee5\u7528\u4e8e\u6240\u6709\u6a21\u677f\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u4f7f\u7528\u5168\u5c40 chart values \u503c\u6765\u5b8c\u6210\u4e86\u3002</p>"},{"location":"kubernetes_package/templates/subcharts_and_globals/#_1","title":"\u5168\u5c40\u503c","text":"<p>\u5168\u5c40\u503c\u662f\u53ef\u4ee5\u4ece\u4efb\u4f55 chart \u6216\u5b50 chart \u4e2d\u90fd\u53ef\u4ee5\u8bbf\u95ee\u7684\u503c\uff0c\u5168\u5c40\u503c\u9700\u8981\u663e\u793a\u7684\u58f0\u660e\uff0c\u4e0d\u80fd\u5c06\u73b0\u6709\u7684\u975e\u5168\u5c40\u5bf9\u8c61\u5f53\u4f5c\u5168\u5c40\u5bf9\u8c61\u4f7f\u7528\u3002</p> <p>Values \u6570\u636e\u7c7b\u578b\u5177\u6709\u4e00\u4e2a\u540d\u4e3a <code>Values.global</code> \u7684\u4fdd\u7559\u90e8\u5206\uff0c\u53ef\u4ee5\u5728\u5176\u4e2d\u8bbe\u7f6e\u5168\u5c40\u503c\uff0c\u6211\u4eec\u5728 <code>mychart/values.yaml</code> \u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u5168\u5c40\u503c\uff1a</p> <pre><code>favorite:\n  drink: coffee\n  food: pizza\npizzaToppings:\n  - mushrooms\n  - cheese\n  - peppers\n  - onions\n\nmysubchart:\n  dessert: ice cream\n\nglobal:\n  salad: caesar\n</code></pre> <p>\u7531\u4e8e\u5168\u5c40\u503c\u7684\u539f\u56e0\uff0c\u5728 </p> <pre><code>mychart/templates/configmap.yaml\n</code></pre> <p>\u548c </p> <pre><code>mysubchart/templates/configmap.yaml\n</code></pre> <p>\u4e0b\u9762\u90fd\u5e94\u8be5\u53ef\u4ee5\u4ee5 </p> <pre><code>{{ .Values.global.salad }}\n</code></pre> <p>\u7684\u5f62\u5f0f\u6765\u8bbf\u95ee\u8fd9\u4e2a\u503c\u3002</p> <p>``` mychart/templates/configmap.yaml <pre><code>\uff1a\n</code></pre> apiVersion: v1 kind: ConfigMap metadata:   name: {{ .Release.Name }}-configmap data:   salad: {{ .Values.global.salad }} <pre><code>&gt; ```\nmysubchart/templates/configmap.yaml\n</code></pre></p> <p>:</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-cfgmap2\ndata:\n  dessert: {{ .Values.dessert }}\n  salad: {{ .Values.global.salad }}\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u6e32\u67d3\u8fd9\u4e2a\u6a21\u677f\uff0c\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u5185\u5bb9\uff1a</p> <pre><code>---\n# Source: mychart/charts/mysubchart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1576053485-cfgmap2\ndata:\n  dessert: ice cream\n  salad: caesar\n---\n# Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1576053485-configmap\ndata:\n  salad: caesar\n</code></pre> <p>\u5168\u5c40\u503c\u5bf9\u4e8e\u4f20\u9012\u8fd9\u6837\u7684\u6570\u636e\u6bd4\u8f83\u6709\u7528\u3002</p>"},{"location":"kubernetes_package/templates/subcharts_and_globals/#_2","title":"\u5171\u4eab\u6a21\u677f","text":"<p>\u7236\u7ea7 chart \u548c\u5b50 chart \u53ef\u4ee5\u5171\u4eab\u6a21\u677f\uff0c\u4efb\u4f55 chart \u4e2d\u5df2\u5b9a\u4e49\u7684\u5757\u90fd\u53ef\u4ee5\u7528\u4e8e\u5176\u4ed6 chart\u3002\u6bd4\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a\u7b80\u5355\u7684\u6a21\u677f\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>{{- define \"labels\" }}from: mychart{{ end }}\n</code></pre> <p>\u524d\u9762\u6211\u4eec\u63d0\u5230\u8fc7\u53ef\u4ee5\u4f7f\u7528\u5728\u6a21\u677f\u4e2d\u4f7f\u7528 <code>include</code> \u548c <code>template</code>\uff0c\u4f46\u662f\u4f7f\u7528 <code>include</code> \u7684\u4e00\u4e2a\u4f18\u70b9\u662f\u53ef\u4ee5\u52a8\u6001\u5f15\u5165\u6a21\u677f\u7684\u5185\u5bb9\uff1a</p> <pre><code>{{ include $mytemplate }}\n</code></pre>"},{"location":"kubernetes_package/templates/values/","title":"Values","text":""},{"location":"kubernetes_package/templates/values/#values","title":"Values \u6587\u4ef6","text":"<p>\u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86 Helm \u6a21\u677f\u63d0\u4f9b\u7684\u5185\u7f6e\u5bf9\u8c61\uff0c\u5176\u4e2d\u5c31\u6709\u4e00\u4e2a\u5185\u7f6e\u5bf9\u8c61 <code>Values</code>\uff0c\u8be5\u5bf9\u8c61\u63d0\u4f9b\u5bf9\u4f20\u9012\u5230 chart \u5fe0\u7684 values \u503c\u7684\u8bbf\u95ee\uff0c\u5176\u5185\u5bb9\u4e3b\u8981\u67094\u4e2a\u6765\u6e90\uff1a</p> <ul> <li>chart \u6587\u4ef6\u4e2d\u7684 <code>values.yaml</code> \u6587\u4ef6</li> <li>\u5982\u679c\u8fd9\u662f\u5b50 chart\uff0c\u7236 chart \u7684 <code>values.yaml</code> \u6587\u4ef6</li> <li> <p>\u7528 <code>-f</code> \u53c2\u6570\u4f20\u9012\u7ed9 <code>helm install</code> \u6216 <code>helm upgrade</code> \u7684 values \u503c\u6587\u4ef6\uff08\u4f8b\u5982 </p> <pre><code>helm install -f myvals.yaml ./mychart\n</code></pre> <p>\uff09 *   \u7528 <code>--set</code> \u4f20\u9012\u7684\u5404\u4e2a\u53c2\u6570\uff08\u4f8b\u5982 </p> <pre><code>helm install --set foo=bar ./mychart\n</code></pre> <p>\uff09</p> </li> </ul> <p><code>values.yaml</code> \u6587\u4ef6\u662f\u9ed8\u8ba4\u503c\uff0c\u53ef\u4ee5\u88ab\u7236 chart \u7684 <code>values.yaml</code> \u6587\u4ef6\u8986\u76d6\uff0c\u800c\u540e\u8005\u53c8\u53ef\u4ee5\u7531\u7528\u6237\u63d0\u4f9b\u7684 values \u503c\u6587\u4ef6\u8986\u76d6\uff0c\u800c\u8be5\u6587\u4ef6\u53c8\u53ef\u4ee5\u88ab <code>--set</code> \u53c2\u6570\u8986\u76d6\u3002</p> <p>values \u503c\u6587\u4ef6\u662f\u7eaf YAML \u6587\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u6765\u7f16\u8f91 <code>mychart/values.yaml</code> \u6587\u4ef6\u7136\u540e\u7f16\u8f91 <code>ConfigMap</code> \u6a21\u677f\u3002\u5220\u9664 <code>values.yaml</code> \u4e2d\u7684\u9ed8\u8ba4\u8bbe\u7f6e\u540e\uff0c\u6211\u4eec\u5c06\u53ea\u8bbe\u7f6e\u4e00\u4e2a\u53c2\u6570\uff1a</p> <pre><code>favoriteDrink: coffee\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u76f4\u63a5\u4f7f\u7528\u5b83\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: {{ .Values.favoriteDrink }}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5728\u6700\u540e\u4e00\u884c\u6211\u4eec\u5c06 <code>favoriteDrink</code> \u4f5c\u4e3a <code>Values</code> \u7684\u5c5e\u6027\u8fdb\u884c\u8bbf\u95ee\uff1a</p> <pre><code>{{ .Values.favoriteDrink }}\n</code></pre> <p>\u3002\u6211\u4eec\u53ef\u4ee5\u6765\u770b\u770b\u662f\u5982\u4f55\u6e32\u67d3\u7684\uff1a</p> <pre><code>$ helm install --generate-name --dry-run --debug ./mychart\ninstall.go:148: [debug] Original chart version: \"\"\ninstall.go:165: [debug] CHART PATH: /Users/ych/devs/workspace/yidianzhishi/course/k8strain/content/helm/manifests/mychart\n\nNAME: mychart-1575963545\nLAST DEPLOYED: Tue Dec 10 15:39:06 2019\nNAMESPACE: default\nSTATUS: pending-install\nREVISION: 1\nTEST SUITE: None\nUSER-SUPPLIED VALUES:\n{}\n\nCOMPUTED VALUES:\nfavoriteDrink: coffee\n\nHOOKS:\nMANIFEST:\n---\n# Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1575963545-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: coffee\n</code></pre> <p>\u7531\u4e8e\u5728\u9ed8\u8ba4\u7684 <code>values.yaml</code> \u6587\u4ef6\u4e2d\u5c06 favoriteDrink \u8bbe\u7f6e\u4e3a\u4e86 coffee\uff0c\u6240\u4ee5\u8fd9\u5c31\u662f\u6a21\u677f\u4e2d\u663e\u793a\u7684\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u8c03\u7528 <code>helm install</code> \u7684\u8fc7\u7a0b\u4e2d\u6dfb\u52a0 <code>--set</code> \u53c2\u6570\u6765\u8986\u76d6\u5b83\uff1a</p> <pre><code>$ helm install --generate-name --dry-run --debug --set favoriteDrink=slurm ./mychart\ninstall.go:148: [debug] Original chart version: \"\"\ninstall.go:165: [debug] CHART PATH: /Users/ych/devs/workspace/yidianzhishi/course/k8strain/content/helm/manifests/mychart\n\nNAME: mychart-1575963760\nLAST DEPLOYED: Tue Dec 10 15:42:43 2019\nNAMESPACE: default\nSTATUS: pending-install\nREVISION: 1\nTEST SUITE: None\nUSER-SUPPLIED VALUES:\nfavoriteDrink: slurm\n\nCOMPUTED VALUES:\nfavoriteDrink: slurm\n\nHOOKS:\nMANIFEST:\n---\n# Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1575963760-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: slurm\n</code></pre> <p>\u56e0\u4e3a <code>--set</code> \u7684\u4f18\u5148\u7ea7\u9ad8\u4e8e\u9ed8\u8ba4\u7684 <code>values.yaml</code> \u6587\u4ef6\uff0c\u6240\u4ee5\u6211\u4eec\u7684\u6a21\u677f\u4f1a\u751f\u6210 <code>drink: slurm</code>\u3002Values \u503c\u6587\u4ef6\u4e5f\u53ef\u4ee5\u5305\u542b\u66f4\u591a\u7ed3\u6784\u5316\u7684\u5185\u5bb9\uff0c\u4f8b\u5982\u6211\u4eec\u53ef\u4ee5\u5728 <code>values.yaml</code> \u6587\u4ef6\u4e2d\u521b\u5efa\u4e00\u4e2a favorite \u7684\u90e8\u5206\uff0c\u7136\u540e\u5728\u5176\u4e2d\u6dfb\u52a0\u51e0\u4e2a keys\uff1a</p> <pre><code>favorite:\n  drink: coffee\n  food: pizza\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u518d\u53bb\u4fee\u6539\u4e0b\u6211\u4eec\u7684\u6a21\u677f\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: {{ .Values.favorite.drink }}\n  food: {{ .Values.favorite.food }}\n</code></pre> <p>\u867d\u7136\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u6765\u6784\u9020\u6570\u636e\uff0c\u4f46\u662f\u8fd8\u662f\u5efa\u8bae\u4f60\u5c06 values \u6811\u4fdd\u6301\u66f4\u6d45\uff0c\u8fd9\u6837\u5728\u4f7f\u7528\u7684\u65f6\u5019\u66f4\u52a0\u7b80\u5355\u3002\u5f53\u6211\u4eec\u8003\u8651\u4e3a\u5b50 chart \u5206\u914d values \u503c\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u5230\u5982\u4f55\u4f7f\u7528\u6811\u5f62\u7ed3\u6784\u6765\u547d\u540d values \u503c\u4e86\u3002</p>"},{"location":"kubernetes_package/templates/values/#key","title":"\u5220\u9664\u9ed8\u8ba4 KEY","text":"<p>\u5982\u679c\u4f60\u9700\u8981\u4ece\u9ed8\u8ba4\u503c\u4e2d\u5220\u9664 key\uff0c\u5219\u53ef\u4ee5\u5c06\u8be5 key \u7684\u503c\u8986\u76d6\u4e3a null\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cHelm \u5c06\u4ece\u8986\u76d6\u7684 values \u4e2d\u5220\u9664\u8be5 key\u3002\u4f8b\u5982\uff0c\u5728 Drupal chart \u4e2d\u914d\u7f6e\u4e00\u4e2a liveness \u63a2\u9488:</p> <pre><code>livenessProbe:\n  httpGet:\n    path: /user/login\n    port: http\n  initialDelaySeconds: 120\n</code></pre> <p>\u5982\u679c\u4f60\u60f3\u4f7f\u7528 </p> <pre><code>--set livenessProbe.exec.command=[cat, docroot/CHANGELOG.txt]\n</code></pre> <p>\u5c06 livenessProbe \u7684\u5904\u7406\u7a0b\u5e8f\u8986\u76d6\u4e3a <code>exec</code> \u800c\u4e0d\u662f <code>httpGet</code>\uff0c\u5219 Helm \u4f1a\u5c06\u9ed8\u8ba4\u952e\u548c\u8986\u76d6\u952e\u5408\u5e76\u5728\u4e00\u8d77\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>livenessProbe:\n  httpGet:\n    path: /user/login\n    port: http\n  exec:\n    command:\n    - cat\n    - docroot/CHANGELOG.txt\n  initialDelaySeconds: 120\n</code></pre> <p>\u4f46\u662f\uff0c\u8fd9\u6837\u5374\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u56e0\u4e3a\u4f60\u4e0d\u80fd\u58f0\u660e\u591a\u4e2a livenessProbe \u5904\u7406\u7a0b\u5e8f\uff0c\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4f60\u53ef\u4ee5\u8ba9 Helm \u901a\u8fc7\u5c06 </p> <pre><code>livenessProbe.httpGet\n</code></pre> <p>\u8bbe\u7f6e\u4e3a null \u6765\u5220\u9664\u5b83\uff1a</p> <pre><code>$ helm install stable/drupal --set image=my-registry/drupal:0 --set livenessProbe.exec.command=[cat, docroot/CHANGELOG.txt] --set livenessProbe.httpGet=null\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u5230\u4e86\u51e0\u4e2a\u5185\u7f6e\u5bf9\u8c61\uff0c\u5e76\u5229\u7528\u5b83\u4eec\u5c06\u4fe1\u606f\u6ce8\u5165\u5230\u4e86\u6a21\u677f\u4e2d\uff0c\u73b0\u5728\u6211\u4eec\u6765\u770b\u770b\u6a21\u677f\u5f15\u64ce\u7684\u53e6\u5916\u65b9\u9762\uff1a\u51fd\u6570\u548c\u7ba1\u9053\u3002</p>"},{"location":"kubernetes_package/templates/variables/","title":"\u53d8\u91cf","text":""},{"location":"kubernetes_package/templates/variables/#_1","title":"\u53d8\u91cf","text":"<p>\u6709\u4e86\u51fd\u6570\u3001\u7ba1\u9053\u3001\u5bf9\u8c61\u4ee5\u53ca\u63a7\u5236\u7ed3\u6784\uff0c\u6211\u4eec\u53ef\u4ee5\u60f3\u8c61\u4e0b\u5927\u591a\u6570\u7f16\u7a0b\u8bed\u8a00\u4e2d\u66f4\u57fa\u672c\u7684\u601d\u60f3\u4e4b\u4e00\uff1a<code>\u53d8\u91cf</code>\u3002\u5728\u6a21\u677f\u4e2d\uff0c\u53d8\u91cf\u7684\u4f7f\u7528\u9891\u7387\u8f83\u4f4e\uff0c\u4f46\u662f\uff0c\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u4f7f\u7528\u4ed6\u4eec\u6765\u7b80\u5316\u4ee3\u7801\uff0c\u4ee5\u53ca\u66f4\u597d\u5730\u4f7f\u7528 <code>with</code> \u548c <code>range</code>\u3002</p> <p>\u5728\u524d\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u77e5\u9053\u4e0b\u9762\u7684\u6a21\u677f\u6e32\u67d3\u4f1a\u51fa\u9519\uff1a</p> <pre><code>{{- with .Values.favorite }}\ndrink: {{ .drink | default \"tea\" | quote }}\nfood: {{ .food | upper | quote }}\nrelease: {{ .Release.Name }}\n{{- end }}\n</code></pre> <p>\u56e0\u4e3a <code>Release.Name</code> \u4e0d\u5728 <code>with</code> \u8bed\u53e5\u5757\u9650\u5236\u7684\u8303\u56f4\u4e4b\u5185\uff0c\u89e3\u51b3\u4f5c\u7528\u57df\u95ee\u9898\u7684\u4e00\u79cd\u65b9\u6cd5\u662f\u5c06\u5bf9\u8c61\u5206\u914d\u7ed9\u5728\u4e0d\u8003\u8651\u5f53\u524d\u4f5c\u7528\u57df\u60c5\u51b5\u4e0b\u8bbf\u95ee\u7684\u53d8\u91cf\u3002</p> <p>\u5728 Helm \u6a21\u677f\u4e2d\uff0c\u53d8\u91cf\u662f\u5bf9\u53e6\u5916\u4e00\u4e2a\u5bf9\u8c61\u7684\u547d\u540d\u5f15\u7528\u3002\u5b83\u9075\u5faa <code>$name</code> \u683c\u5f0f\uff0c\u53d8\u91cf\u4f7f\u7528\u7279\u6b8a\u7684\u8d4b\u503c\u8fd0\u7b97\u7b26\u8fdb\u884c\u8d4b\u503c <code>:=</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u4fee\u6539\u4e0a\u9762\u7684\u6a21\u677f\uff0c\u4e3a <code>Release.Name</code> \u58f0\u660e\u4e00\u4e2a\u53d8\u91cf\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  {{- $relname := .Release.Name -}}\n  {{- with .Values.favorite }}\n  drink: {{ .drink | default \"tea\" | quote }}\n  food: {{ .food | upper | quote }}\n  release: {{ $relname }}\n  {{- end }}\n</code></pre> <p>\u6ce8\u610f\u5728 <code>with</code> \u8bed\u53e5\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u5206\u914d\u4e86 </p> <pre><code>$relname := .Release.Name\n</code></pre> <p>\uff0c\u7136\u540e\u5728 <code>with</code> \u8bed\u53e5\u5757\u4e2d\uff0c<code>$relname</code> \u53d8\u91cf\u4ecd\u7136\u8868\u793a release \u7684\u540d\u79f0\uff0c\u6211\u4eec\u6e32\u67d3\u8be5\u6a21\u677f\uff0c\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u7684\u6b63\u786e\u7ed3\u679c\uff1a</p> <pre><code># Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1575982655-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffee\"\n  food: \"PIZZA\"\n  release: mychart-1575982655\n</code></pre> <p>\u53d8\u91cf\u5728 <code>range</code> \u5faa\u73af\u91cc\u9762\u975e\u5e38\u6709\u7528\uff0c\u5b83\u4eec\u53ef\u4ee5\u7528\u4e8e\u7c7b\u4f3c\u4e8e\u5217\u8868\u7684\u5bf9\u8c61\u6765\u6355\u83b7\u7d22\u5f15\u548c value \u503c\uff1a</p> <pre><code>toppings: |-\n  {{- range $index, $topping := .Values.pizzaToppings }}\n    {{ $index }}: {{ $topping }}\n  {{- end }}\n</code></pre> <p>\u6ce8\u610f <code>range</code> \u5728\u524d\u9762\uff0c\u7136\u540e\u662f\u53d8\u91cf\uff0c\u7136\u540e\u662f\u8d4b\u503c\u8fd0\u7b97\u7b26\uff0c\u7136\u540e\u624d\u662f\u5217\u8868\uff0c\u8fd9\u4f1a\u5c06\u6574\u6570\u7d22\u5f15\uff08\u4ece0\u5f00\u59cb\uff09\u5206\u914d\u7ed9 <code>$index</code>\uff0c\u5e76\u5c06 value \u503c\u5206\u914d\u7ed9 <code>$topping</code>\uff0c\u4e0a\u9762\u7684\u5185\u5bb9\u4f1a\u88ab\u6e32\u67d3\u6210\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>toppings: |-\n  0: mushrooms\n  1: cheese\n  2: peppers\n  3: onions\n</code></pre> <p>\u5bf9\u4e8e\u540c\u65f6\u5177\u6709 key \u548c value \u7684\u6570\u636e\u7ed3\u6784\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>range</code> \u6765\u83b7\u5f97 key\u3001value \u7684\u503c\uff0c\u6bd4\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u50cf\u8fd9\u6837\u5faa\u73af\u904d\u5386 <code>.Values.favorite</code>\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ .Release.Name }}-configmap\ndata:\n  myvalue: \"Hello World\"\n  {{- range $key, $val := .Values.favorite }}\n  {{ $key }}: {{ $val | quote }}\n  {{- end }}\n</code></pre> <p>\u5728\u7b2c\u4e00\u6b21\u8fed\u4ee3\u4e2d\uff0c<code>$key</code> \u662f <code>drink</code>\uff0c<code>$val</code> \u662f <code>coffee</code>\uff0c\u5728\u7b2c\u4e8c\u6b21\u8fed\u4ee3\u4e2d\uff0c<code>$key</code> \u662f <code>food</code>\uff0c<code>$val</code> \u662f <code>pizza</code>\u3002\u8fd0\u884c\u4e0a\u9762\u7684\u547d\u4ee4\u5c06\u751f\u6210\u4e0b\u9762\u7684\u5185\u5bb9\uff1a</p> <pre><code># Source: mychart/templates/configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mychart-1575983119-configmap\ndata:\n  myvalue: \"Hello World\"\n  drink: \"coffee\"\n  food: \"pizza\"\n</code></pre> <p>\u4e00\u822c\u6765\u8bf4\u53d8\u91cf\u4e0d\u662f\u5168\u5c40\u7684\uff0c\u5b83\u4eec\u7684\u4f5c\u7528\u57df\u662f\u58f0\u660e\u5b83\u4eec\u7684\u5757\u533a\u57df\uff0c\u4e4b\u524d\uff0c\u6211\u4eec\u5728\u6a21\u677f\u7684\u9876\u5c42\u5206\u914d\u4e86 <code>$relname</code>\uff0c\u8be5\u53d8\u91cf\u5c06\u5728\u6574\u4e2a\u6a21\u677f\u7684\u8303\u56f4\u5185\uff0c\u4f46\u662f\u5728\u6211\u4eec\u4e0a\u9762\u7684\u793a\u4f8b\u4e2d\uff0c<code>$key</code> \u548c <code>$val</code> \u4f5c\u7528\u57df\u53ea\u5728 </p> <pre><code>{{ range... }}{{ end }}\n</code></pre> <p>\u533a\u57df\u5185\u3002</p> <p>\u4f46\u662f\uff0c\u6709\u4e00\u4e2a\u59cb\u7ec8\u662f\u5168\u5c40\u53d8\u91cf\u7684 <code>$</code> \u59cb\u7ec8\u6307\u5411\u9876\u5c42\u6839\u4e0a\u4e0b\u6587\uff0c\u5f53\u6211\u4eec\u5728 <code>range</code> \u5faa\u73af\u5185\u9700\u8981\u77e5\u9053 chart \u5305\u7684 release \u540d\u79f0\u7684\u65f6\u5019\uff0c\u8be5\u529f\u80fd\u5c31\u975e\u5e38\u6709\u7528\u4e86\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u6a21\u677f\u6587\u4ef6\uff1a</p> <pre><code>{{- range .Values.tlsSecrets }}\napiVersion: v1\nkind: Secret\nmetadata:\n  name: {{ .name }}\n  labels:\n    # helm \u6a21\u677f\u7ecf\u5e38\u4f7f\u7528 `.`\uff0c\u4f46\u662f\u8fd9\u91cc\u662f\u65e0\u6548\u7684\uff0c\u7528 `$` \u662f\u53ef\u4ee5\u751f\u6548\u7684\u3002\n    app.kubernetes.io/name: {{ template \"fullname\" $ }}\n    # \u8fd9\u91cc\u4e0d\u80fd\u5f15\u7528 `.Chart.Name`\uff0c\u4f46\u662f\u53ef\u7528\u4f7f\u7528 `$.Chart.Name`\n    helm.sh/chart: \"{{ $.Chart.Name }}-{{ $.Chart.Version }}\"\n    app.kubernetes.io/instance: \"{{ $.Release.Name }}\"\n    # \u503c\u6765\u81ea\u4e8e Chart.yaml \u6587\u4ef6\u4e2d\u7684 appVersion\n    app.kubernetes.io/version: \"{{ $.Chart.AppVersion }}\"\n    app.kubernetes.io/managed-by: \"{{ $.Release.Service }}\"\ntype: kubernetes.io/tls\ndata:\n  tls.crt: {{ .certificate }}\n  tls.key: {{ .key }}\n---\n{{- end }}\n</code></pre> <p>\u5230\u73b0\u5728\u4e3a\u6b62\uff0c\u6211\u4eec\u53ea\u7814\u7a76\u4e86\u5728\u4e00\u4e2a\u6587\u4ef6\u4e2d\u58f0\u660e\u7684\u4e00\u4e2a\u6a21\u677f\uff0c\u4f46\u662f\uff0cHelm \u6a21\u677f\u8bed\u8a00\u7684\u5f3a\u5927\u529f\u80fd\u4e4b\u4e00\u662f\u5b83\u80fd\u591f\u58f0\u660e\u591a\u4e2a\u6a21\u677f\u5e76\u5c06\u5176\u4e00\u8d77\u4f7f\u7528\u3002\u6211\u4eec\u5c06\u5728\u4e0b\u9762\u7684\u7ae0\u8282\u4e2d\u6765\u8ba8\u8bba\u8fd9\u4e00\u70b9\u3002</p>"},{"location":"kubernetes_scheduler/overview/","title":"\u8c03\u5ea6\u5668\u4ecb\u7ecd","text":""},{"location":"kubernetes_scheduler/overview/#_1","title":"\u8c03\u5ea6\u5668","text":"<p><code>kube-scheduler</code> \u662f kubernetes \u7684\u6838\u5fc3\u7ec4\u4ef6\u4e4b\u4e00\uff0c\u4e3b\u8981\u8d1f\u8d23\u6574\u4e2a\u96c6\u7fa4\u8d44\u6e90\u7684\u8c03\u5ea6\u529f\u80fd\uff0c\u6839\u636e\u7279\u5b9a\u7684\u8c03\u5ea6\u7b97\u6cd5\u548c\u7b56\u7565\uff0c\u5c06 Pod \u8c03\u5ea6\u5230\u6700\u4f18\u7684\u5de5\u4f5c\u8282\u70b9\u4e0a\u9762\u53bb\uff0c\u4ece\u800c\u66f4\u52a0\u5408\u7406\u3001\u66f4\u52a0\u5145\u5206\u7684\u5229\u7528\u96c6\u7fa4\u7684\u8d44\u6e90\uff0c\u8fd9\u4e5f\u662f\u6211\u4eec\u9009\u62e9\u4f7f\u7528 kubernetes \u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7406\u7531\u3002\u5982\u679c\u4e00\u95e8\u65b0\u7684\u6280\u672f\u4e0d\u80fd\u5e2e\u52a9\u4f01\u4e1a\u8282\u7ea6\u6210\u672c\u3001\u63d0\u4f9b\u6548\u7387\uff0c\u6211\u76f8\u4fe1\u662f\u5f88\u96be\u63a8\u8fdb\u7684\u3002</p>"},{"location":"kubernetes_scheduler/overview/#_2","title":"\u8c03\u5ea6\u6d41\u7a0b","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>kube-scheduler</code> \u63d0\u4f9b\u7684\u9ed8\u8ba4\u8c03\u5ea6\u5668\u80fd\u591f\u6ee1\u8db3\u6211\u4eec\u7edd\u5927\u591a\u6570\u7684\u8981\u6c42\uff0c\u6211\u4eec\u524d\u9762\u548c\u5927\u5bb6\u63a5\u89e6\u7684\u793a\u4f8b\u4e5f\u57fa\u672c\u4e0a\u7528\u7684\u9ed8\u8ba4\u7684\u7b56\u7565\uff0c\u90fd\u53ef\u4ee5\u4fdd\u8bc1\u6211\u4eec\u7684 Pod \u53ef\u4ee5\u88ab\u5206\u914d\u5230\u8d44\u6e90\u5145\u8db3\u7684\u8282\u70b9\u4e0a\u8fd0\u884c\u3002\u4f46\u662f\u5728\u5b9e\u9645\u7684\u7ebf\u4e0a\u9879\u76ee\u4e2d\uff0c\u53ef\u80fd\u6211\u4eec\u81ea\u5df1\u4f1a\u6bd4 kubernetes \u66f4\u52a0\u4e86\u89e3\u6211\u4eec\u81ea\u5df1\u7684\u5e94\u7528\uff0c\u6bd4\u5982\u6211\u4eec\u5e0c\u671b\u4e00\u4e2a Pod \u53ea\u80fd\u8fd0\u884c\u5728\u7279\u5b9a\u7684\u51e0\u4e2a\u8282\u70b9\u4e0a\uff0c\u6216\u8005\u8fd9\u51e0\u4e2a\u8282\u70b9\u53ea\u80fd\u7528\u6765\u8fd0\u884c\u7279\u5b9a\u7c7b\u578b\u7684\u5e94\u7528\uff0c\u8fd9\u5c31\u9700\u8981\u6211\u4eec\u7684\u8c03\u5ea6\u5668\u80fd\u591f\u53ef\u63a7\u3002</p> <p><code>kube-scheduler</code> \u7684\u4e3b\u8981\u4f5c\u7528\u5c31\u662f\u6839\u636e\u7279\u5b9a\u7684\u8c03\u5ea6\u7b97\u6cd5\u548c\u8c03\u5ea6\u7b56\u7565\u5c06 Pod \u8c03\u5ea6\u5230\u5408\u9002\u7684 Node \u8282\u70b9\u4e0a\u53bb\uff0c\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u4e8c\u8fdb\u5236\u7a0b\u5e8f\uff0c\u542f\u52a8\u4e4b\u540e\u4f1a\u4e00\u76f4\u76d1\u542c API Server\uff0c\u83b7\u53d6\u5230 <code>PodSpec.NodeName</code> \u4e3a\u7a7a\u7684 Pod\uff0c\u5bf9\u6bcf\u4e2a Pod \u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a binding\u3002</p> <p></p> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u5728\u6211\u4eec\u770b\u6765\u597d\u50cf\u6bd4\u8f83\u7b80\u5355\uff0c\u4f46\u5728\u5b9e\u9645\u7684\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u9700\u8981\u8003\u8651\u7684\u95ee\u9898\u5c31\u6709\u5f88\u591a\u4e86\uff1a</p> <ul> <li>\u5982\u4f55\u4fdd\u8bc1\u5168\u90e8\u7684\u8282\u70b9\u8c03\u5ea6\u7684\u516c\u5e73\u6027\uff1f\u8981\u77e5\u9053\u5e76\u4e0d\u662f\u6240\u6709\u8282\u70b9\u8d44\u6e90\u914d\u7f6e\u4e00\u5b9a\u90fd\u662f\u4e00\u6837\u7684</li> <li>\u5982\u4f55\u4fdd\u8bc1\u6bcf\u4e2a\u8282\u70b9\u90fd\u80fd\u88ab\u5206\u914d\u8d44\u6e90\uff1f</li> <li>\u96c6\u7fa4\u8d44\u6e90\u5982\u4f55\u80fd\u591f\u88ab\u9ad8\u6548\u5229\u7528\uff1f</li> <li>\u96c6\u7fa4\u8d44\u6e90\u5982\u4f55\u624d\u80fd\u88ab\u6700\u5927\u5316\u4f7f\u7528\uff1f</li> <li>\u5982\u4f55\u4fdd\u8bc1 Pod \u8c03\u5ea6\u7684\u6027\u80fd\u548c\u6548\u7387\uff1f</li> <li>\u7528\u6237\u662f\u5426\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u5b9e\u9645\u9700\u6c42\u5b9a\u5236\u81ea\u5df1\u7684\u8c03\u5ea6\u7b56\u7565\uff1f</li> </ul> <p>\u8003\u8651\u5230\u5b9e\u9645\u73af\u5883\u4e2d\u7684\u5404\u79cd\u590d\u6742\u60c5\u51b5\uff0ckubernetes \u7684\u8c03\u5ea6\u5668\u91c7\u7528\u63d2\u4ef6\u5316\u7684\u5f62\u5f0f\u5b9e\u73b0\uff0c\u53ef\u4ee5\u65b9\u4fbf\u7528\u6237\u8fdb\u884c\u5b9a\u5236\u6216\u8005\u4e8c\u6b21\u5f00\u53d1\uff0c\u6211\u4eec\u53ef\u4ee5\u81ea\u5b9a\u4e49\u4e00\u4e2a\u8c03\u5ea6\u5668\u5e76\u4ee5\u63d2\u4ef6\u5f62\u5f0f\u548c kubernetes \u8fdb\u884c\u96c6\u6210\u3002</p> <p>kubernetes \u8c03\u5ea6\u5668\u7684\u6e90\u7801\u4f4d\u4e8e </p> <pre><code>kubernetes/pkg/scheduler\n</code></pre> <p>\u4e2d\uff0c\u5927\u4f53\u7684\u4ee3\u7801\u76ee\u5f55\u7ed3\u6784\u5982\u4e0b\u6240\u793a\uff1a(\u4e0d\u540c\u7684\u7248\u672c\u76ee\u5f55\u7ed3\u6784\u53ef\u80fd\u4e0d\u592a\u4e00\u6837)</p> <pre><code>kubernetes/pkg/scheduler\n-- scheduler.go         //\u8c03\u5ea6\u76f8\u5173\u7684\u5177\u4f53\u5b9e\u73b0\n|-- algorithm\n|   |-- predicates      //\u8282\u70b9\u7b5b\u9009\u7b56\u7565\n|   |-- priorities      //\u8282\u70b9\u6253\u5206\u7b56\u7565\n|-- algorithmprovider\n|   |-- defaults         //\u5b9a\u4e49\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\n</code></pre> <p>\u5176\u4e2d Scheduler \u521b\u5efa\u548c\u8fd0\u884c\u7684\u6838\u5fc3\u7a0b\u5e8f\uff0c\u5bf9\u5e94\u7684\u4ee3\u7801\u5728 </p> <pre><code>pkg/scheduler/scheduler.go\n</code></pre> <p>\uff0c\u5982\u679c\u8981\u67e5\u770b<code>kube-scheduler</code> \u7684\u5165\u53e3\u7a0b\u5e8f\uff0c\u5bf9\u5e94\u7684\u4ee3\u7801\u5728 </p> <pre><code>cmd/kube-scheduler/scheduler.go\n</code></pre> <p>\u3002</p> <p>\u8c03\u5ea6\u4e3b\u8981\u5206\u4e3a\u4ee5\u4e0b\u51e0\u4e2a\u90e8\u5206\uff1a</p> <ul> <li>\u9996\u5148\u662f<code>\u9884\u9009\u8fc7\u7a0b</code>\uff0c\u8fc7\u6ee4\u6389\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u8282\u70b9\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u79f0\u4e3a<code>Predicates</code>\uff08\u8fc7\u6ee4\uff09</li> <li>\u7136\u540e\u662f<code>\u4f18\u9009\u8fc7\u7a0b</code>\uff0c\u5bf9\u901a\u8fc7\u7684\u8282\u70b9\u6309\u7167\u4f18\u5148\u7ea7\u6392\u5e8f\uff0c\u79f0\u4e4b\u4e3a<code>Priorities</code>\uff08\u6253\u5206\uff09</li> <li>\u6700\u540e\u4ece\u4e2d\u9009\u62e9\u4f18\u5148\u7ea7\u6700\u9ad8\u7684\u8282\u70b9\uff0c\u5982\u679c\u4e2d\u95f4\u4efb\u4f55\u4e00\u6b65\u9aa4\u6709\u9519\u8bef\uff0c\u5c31\u76f4\u63a5\u8fd4\u56de\u9519\u8bef</li> </ul> <p><code>Predicates</code> \u9636\u6bb5\u9996\u5148\u904d\u5386\u5168\u90e8\u8282\u70b9\uff0c\u8fc7\u6ee4\u6389\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u8282\u70b9\uff0c\u5c5e\u4e8e<code>\u5f3a\u5236\u6027</code>\u89c4\u5219\uff0c\u8fd9\u4e00\u9636\u6bb5\u8f93\u51fa\u7684\u6240\u6709\u6ee1\u8db3\u8981\u6c42\u7684\u8282\u70b9\u5c06\u88ab\u8bb0\u5f55\u5e76\u4f5c\u4e3a\u7b2c\u4e8c\u9636\u6bb5\u7684\u8f93\u5165\uff0c\u5982\u679c\u6240\u6709\u7684\u8282\u70b9\u90fd\u4e0d\u6ee1\u8db3\u6761\u4ef6\uff0c\u90a3\u4e48 Pod \u5c06\u4f1a\u4e00\u76f4\u5904\u4e8e Pending \u72b6\u6001\uff0c\u76f4\u5230\u6709\u8282\u70b9\u6ee1\u8db3\u6761\u4ef6\uff0c\u5728\u8fd9\u671f\u95f4\u8c03\u5ea6\u5668\u4f1a\u4e0d\u65ad\u7684\u91cd\u8bd5\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u5728\u90e8\u7f72\u5e94\u7528\u7684\u65f6\u5019\uff0c\u5982\u679c\u53d1\u73b0\u6709 Pod \u4e00\u76f4\u5904\u4e8e Pending \u72b6\u6001\uff0c\u90a3\u4e48\u5c31\u662f\u6ca1\u6709\u6ee1\u8db3\u8c03\u5ea6\u6761\u4ef6\u7684\u8282\u70b9\uff0c\u8fd9\u4e2a\u65f6\u5019\u53ef\u4ee5\u53bb\u68c0\u67e5\u4e0b\u8282\u70b9\u8d44\u6e90\u662f\u5426\u53ef\u7528\u3002</p> <p><code>Priorities</code> \u9636\u6bb5\u5373\u518d\u6b21\u5bf9\u8282\u70b9\u8fdb\u884c\u7b5b\u9009\uff0c\u5982\u679c\u6709\u591a\u4e2a\u8282\u70b9\u90fd\u6ee1\u8db3\u6761\u4ef6\u7684\u8bdd\uff0c\u90a3\u4e48\u7cfb\u7edf\u4f1a\u6309\u7167\u8282\u70b9\u7684\u4f18\u5148\u7ea7(<code>priorites</code>)\u5927\u5c0f\u5bf9\u8282\u70b9\u8fdb\u884c\u6392\u5e8f\uff0c\u6700\u540e\u9009\u62e9\u4f18\u5148\u7ea7\u6700\u9ad8\u7684\u8282\u70b9\u6765\u90e8\u7f72 Pod \u5e94\u7528\u3002</p> <p>\u4e0b\u9762\u662f\u8c03\u5ea6\u8fc7\u7a0b\u7684\u7b80\u5355\u793a\u610f\u56fe\uff1a</p> <p></p> <p>\u66f4\u8be6\u7ec6\u7684\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ul> <li>\u9996\u5148\uff0c\u5ba2\u6237\u7aef\u901a\u8fc7 API Server \u7684 REST API \u6216\u8005 kubectl \u5de5\u5177\u521b\u5efa Pod \u8d44\u6e90</li> <li>API Server \u6536\u5230\u7528\u6237\u8bf7\u6c42\u540e\uff0c\u5b58\u50a8\u76f8\u5173\u6570\u636e\u5230 etcd \u6570\u636e\u5e93\u4e2d</li> <li> <p>\u8c03\u5ea6\u5668\u76d1\u542c API Server \u67e5\u770b\u5230\u8fd8\u672a\u88ab\u8c03\u5ea6(bind)\u7684 Pod \u5217\u8868\uff0c\u5faa\u73af\u904d\u5386\u5730\u4e3a\u6bcf\u4e2a Pod \u5c1d\u8bd5\u5206\u914d\u8282\u70b9\uff0c\u8fd9\u4e2a\u5206\u914d\u8fc7\u7a0b\u5c31\u662f\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u7684\u4e24\u4e2a\u9636\u6bb5\uff1a</p> <ul> <li>\u9884\u9009\u9636\u6bb5(Predicates)\uff0c\u8fc7\u6ee4\u8282\u70b9\uff0c\u8c03\u5ea6\u5668\u7528\u4e00\u7ec4\u89c4\u5219\u8fc7\u6ee4\u6389\u4e0d\u7b26\u5408\u8981\u6c42\u7684 Node \u8282\u70b9\uff0c\u6bd4\u5982 Pod \u8bbe\u7f6e\u4e86\u8d44\u6e90\u7684 request\uff0c\u90a3\u4e48\u53ef\u7528\u8d44\u6e90\u6bd4 Pod \u9700\u8981\u7684\u8d44\u6e90\u5c11\u7684\u4e3b\u673a\u663e\u7136\u5c31\u4f1a\u88ab\u8fc7\u6ee4\u6389</li> <li>\u4f18\u9009\u9636\u6bb5(Priorities)\uff0c\u4e3a\u8282\u70b9\u7684\u4f18\u5148\u7ea7\u6253\u5206\uff0c\u5c06\u4e0a\u4e00\u9636\u6bb5\u8fc7\u6ee4\u51fa\u6765\u7684 Node \u5217\u8868\u8fdb\u884c\u6253\u5206\uff0c\u8c03\u5ea6\u5668\u4f1a\u8003\u8651\u4e00\u4e9b\u6574\u4f53\u7684\u4f18\u5316\u7b56\u7565\uff0c\u6bd4\u5982\u628a Deployment \u63a7\u5236\u7684\u591a\u4e2a Pod \u526f\u672c\u5c3d\u91cf\u5206\u5e03\u5230\u4e0d\u540c\u7684\u4e3b\u673a\u4e0a\uff0c\u4f7f\u7528\u6700\u4f4e\u8d1f\u8f7d\u7684\u4e3b\u673a\u7b49\u7b49\u7b56\u7565</li> <li> <p>\u7ecf\u8fc7\u4e0a\u9762\u7684\u9636\u6bb5\u8fc7\u6ee4\u540e\u9009\u62e9\u6253\u5206\u6700\u9ad8\u7684 Node \u8282\u70b9\u548c Pod \u8fdb\u884c <code>binding</code> \u64cd\u4f5c\uff0c\u7136\u540e\u5c06\u7ed3\u679c\u5b58\u50a8\u5230 etcd \u4e2d \u6700\u540e\u88ab\u9009\u62e9\u51fa\u6765\u7684 Node \u8282\u70b9\u5bf9\u5e94\u7684 kubelet \u53bb\u6267\u884c\u521b\u5efa Pod \u7684\u76f8\u5173\u64cd\u4f5c\uff08\u5f53\u7136\u4e5f\u662f watch APIServer \u53d1\u73b0\u7684\uff09\u3002</p> </li> </ul> </li> </ul> <p>\u5176\u4e2d <code>Predicates</code> \u8fc7\u6ee4\u6709\u4e00\u7cfb\u5217\u7684\u9ed8\u8ba4\u8c03\u5ea6\u7b56\u7565\u7b97\u6cd5\u53ef\u4ee5\u4f7f\u7528\uff0c\u6211\u4eec\u8fd9\u91cc\u7b80\u5355\u5217\u4e3e\u51e0\u4e2a\uff1a</p> <ul> <li>PodFitsResources\uff1a\u8282\u70b9\u4e0a\u5269\u4f59\u7684\u8d44\u6e90\uff08\u5982 CPU \u548c\u5185\u5b58\uff09\u662f\u5426\u6ee1\u8db3 Pod \u8bf7\u6c42\u7684\u8d44\u6e90</li> <li>PodFitsHost\uff1a\u5982\u679c Pod \u6307\u5b9a\u4e86 NodeName\uff0c\u68c0\u67e5\u8282\u70b9\u540d\u79f0\u662f\u5426\u548c NodeName \u5339\u914d</li> <li>PodFitsHostPorts\uff1a\u5982\u679c Pod \u4e2d\u5b9a\u4e49\u4e86 hostPort \u5c5e\u6027\uff0c\u90a3\u4e48\u9700\u8981\u5148\u68c0\u67e5\u8fd9\u4e2a\u6307\u5b9a\u7aef\u53e3\u662f\u5426\u5df2\u7ecf\u88ab\u8282\u70b9\u4e0a\u5176\u4ed6\u670d\u52a1\u5360\u7528\u4e86</li> <li>PodMatchNodeSelector\uff1a\u68c0\u67e5 Node \u7684\u6807\u7b7e\u662f\u5426\u80fd\u5339\u914d Pod \u7684 nodeSelector \u7684\u6807\u7b7e\u503c</li> <li>NoDiskConflict\uff1a\u68c0\u67e5 Pod \u8bf7\u6c42\u7684\u5b58\u50a8\u5377\u5728 Node \u4e0a\u662f\u5426\u53ef\u7528\uff0c\u82e5\u4e0d\u5b58\u5728\u51b2\u7a81\u5219\u901a\u8fc7\u68c0\u67e5</li> <li>NoVolumeZoneConflict\uff1a\u68c0\u6d4b Pod \u8bf7\u6c42\u7684 Volumes \u5728\u8282\u70b9\u4e0a\u662f\u5426\u53ef\u7528\uff0c\u56e0\u4e3a\u67d0\u4e9b\u5b58\u50a8\u5377\u5b58\u5728\u533a\u57df\u8c03\u5ea6\u7ea6\u675f</li> <li>CheckNodeDiskPressure\uff1a\u68c0\u67e5\u8282\u70b9\u78c1\u76d8\u7a7a\u95f4\u662f\u5426\u7b26\u5408\u8981\u6c42</li> <li>CheckNodeMemoryPressure\uff1a\u68c0\u67e5\u8282\u70b9\u5185\u5b58\u662f\u5426\u591f\u7528</li> <li>CheckNodeCondition\uff1aNode \u53ef\u4ee5\u4e0a\u62a5\u5176\u81ea\u8eab\u7684\u72b6\u6001\uff0c\u5982\u78c1\u76d8\u3001\u7f51\u7edc\u4e0d\u53ef\u7528\uff0c\u8868\u660e kubelet \u672a\u51c6\u5907\u58d5\u8fd0\u884c Pod\uff0c\u5982\u679c\u8282\u70b9\u88ab\u8bbe\u7f6e\u6210\u8fd9\u79cd\u72b6\u6001\uff0c\u90a3\u4e48 Pod \u4e0d\u4f1a\u88ab\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9\u4e0a</li> <li>PodToleratesNodeTaints\uff1a\u68c0\u67e5 Pod \u5c5e\u6027\u4e0a\u7684 tolerations \u80fd\u5426\u5bb9\u5fcd\u8282\u70b9\u7684 taints \u6c61\u70b9</li> <li>CheckVolumeBinding\uff1a\u68c0\u67e5\u8282\u70b9\u4e0a\u5df2\u7ecf\u7ed1\u5b9a\u7684\u548c\u672a\u7ed1\u5b9a\u7684 PVC \u80fd\u5426\u6ee1\u8db3 Pod \u7684\u5b58\u50a8\u5377\u9700\u6c42</li> </ul> <p>\u9664\u4e86\u8fd9\u4e9b\u8fc7\u6ee4\u7b97\u6cd5\u4e4b\u5916\uff0c\u8fd8\u6709\u4e00\u4e9b\u5176\u4ed6\u7684\u7b97\u6cd5\uff0c\u66f4\u591a\u66f4\u8be6\u7ec6\u7684\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u6e90\u7801\u6587\u4ef6\uff1a</p> <pre><code>k8s.io/kubernetes/pkg/scheduler/algorithm/predicates/predicates.go\n</code></pre> <p>\u3002</p> <p>\u800c <code>Priorities</code> \u4f18\u5148\u7ea7\u662f\u7531\u4e00\u7cfb\u5217\u952e\u503c\u5bf9\u7ec4\u6210\u7684\uff0c\u952e\u662f\u8be5\u4f18\u5148\u7ea7\u7684\u540d\u79f0\uff0c\u503c\u662f\u5b83\u7684\u6743\u91cd\u503c\uff0c\u540c\u6837\uff0c\u6211\u4eec\u8fd9\u91cc\u7ed9\u5927\u5bb6\u5217\u4e3e\u51e0\u4e2a\u5177\u6709\u4ee3\u8868\u6027\u7684\u9009\u9879\uff1a</p> <ul> <li>LeastRequestedPriority\uff1a\u901a\u8fc7\u8ba1\u7b97 CPU \u548c\u5185\u5b58\u7684\u4f7f\u7528\u7387\u6765\u51b3\u5b9a\u6743\u91cd\uff0c\u4f7f\u7528\u7387\u8d8a\u4f4e\u6743\u91cd\u8d8a\u9ad8\uff0c\u5f53\u7136\u6b63\u5e38\u80af\u5b9a\u4e5f\u662f\u8d44\u6e90\u662f\u4f7f\u7528\u7387\u8d8a\u4f4e\u6743\u91cd\u8d8a\u9ad8\uff0c\u80fd\u7ed9\u522b\u7684 Pod \u8fd0\u884c\u7684\u53ef\u80fd\u6027\u5c31\u8d8a\u5927</li> <li>SelectorSpreadPriority\uff1a\u4e3a\u4e86\u66f4\u597d\u7684\u9ad8\u53ef\u7528\uff0c\u5bf9\u540c\u5c5e\u4e8e\u4e00\u4e2a Deployment \u6216\u8005 RC \u4e0b\u9762\u7684\u591a\u4e2a Pod \u526f\u672c\uff0c\u5c3d\u91cf\u8c03\u5ea6\u5230\u591a\u4e2a\u4e0d\u540c\u7684\u8282\u70b9\u4e0a\uff0c\u5f53\u4e00\u4e2a Pod \u88ab\u8c03\u5ea6\u7684\u65f6\u5019\uff0c\u4f1a\u5148\u53bb\u67e5\u627e\u8be5 Pod \u5bf9\u5e94\u7684 controller\uff0c\u7136\u540e\u67e5\u770b\u8be5 controller \u4e0b\u9762\u7684\u5df2\u5b58\u5728\u7684 Pod\uff0c\u8fd0\u884c Pod \u8d8a\u5c11\u7684\u8282\u70b9\u6743\u91cd\u8d8a\u9ad8</li> <li>InterPodAffinityPriority\uff1a\u904d\u5386 Pod \u7684\u4eb2\u548c\u6027\u6761\u76ee\uff0c\u5e76\u5c06\u90a3\u4e9b\u80fd\u591f\u5339\u914d\u5230\u7ed9\u5b9a\u8282\u70b9\u7684\u6761\u76ee\u7684\u6743\u91cd\u76f8\u52a0\uff0c\u7ed3\u679c\u503c\u8d8a\u5927\u7684\u8282\u70b9\u5f97\u5206\u8d8a\u9ad8</li> <li>MostRequestedPriority\uff1a\u7a7a\u95f2\u8d44\u6e90\u6bd4\u4f8b\u8d8a\u4f4e\u7684 Node \u5f97\u5206\u8d8a\u9ad8\uff0c\u8fd9\u4e2a\u8c03\u5ea6\u7b56\u7565\u5c06\u4f1a\u628a\u4f60\u7684\u6240\u6709\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff08Pod\uff09\u8c03\u5ea6\u5230\u5c3d\u91cf\u5c11\u7684\u8282\u70b9\u4e0a</li> <li>RequestedToCapacityRatioPriority\uff1a\u4e3a Node \u4e0a\u6bcf\u4e2a\u8d44\u6e90\u5360\u7528\u6bd4\u4f8b\u8bbe\u5b9a\u5f97\u5206\u503c\uff0c\u7ed9\u8d44\u6e90\u6253\u5206\u51fd\u6570\u5728\u6253\u5206\u65f6\u4f7f\u7528</li> <li>BalancedResourceAllocation\uff1a\u4f18\u9009\u90a3\u4e9b\u4f7f\u5f97\u8d44\u6e90\u5229\u7528\u7387\u66f4\u4e3a\u5747\u8861\u7684\u8282\u70b9\u3002</li> <li> <p>NodePreferAvoidPodsPriority\uff1a\u8fd9\u4e2a\u7b56\u7565\u5c06\u6839\u636e Node \u7684\u6ce8\u89e3\u4fe1\u606f\u4e2d\u662f\u5426\u542b\u6709 </p> <pre><code>scheduler.alpha.kubernetes.io/preferAvoidPods\n</code></pre> <p>\u6765\u8ba1\u7b97\u5176\u4f18\u5148\u7ea7\uff0c\u4f7f\u7528\u8fd9\u4e2a\u7b56\u7565\u53ef\u4ee5\u5c06\u4e24\u4e2a\u4e0d\u540c Pod \u8fd0\u884c\u5728\u4e0d\u540c\u7684 Node \u4e0a *   NodeAffinityPriority\uff1a\u57fa\u4e8e Pod \u5c5e\u6027\u4e2d </p> <pre><code>PreferredDuringSchedulingIgnoredDuringExecution\n</code></pre> <p>\u6765\u8fdb\u884c Node \u4eb2\u548c\u6027\u8c03\u5ea6 *   TaintTolerationPriority\uff1a\u57fa\u4e8e Pod \u4e2d\u5bf9\u6bcf\u4e2a Node \u4e0a\u6c61\u70b9\u5bb9\u5fcd\u7a0b\u5ea6\u8fdb\u884c\u4f18\u5148\u7ea7\u8bc4\u4f30\uff0c\u8fd9\u4e2a\u7b56\u7565\u80fd\u591f\u8c03\u6574\u5f85\u9009 Node \u7684\u6392\u540d *   ImageLocalityPriority\uff1aNode \u4e0a\u5df2\u7ecf\u62e5\u6709 Pod \u9700\u8981\u7684\u5bb9\u5668\u955c\u50cf\u7684 Node \u4f1a\u6709\u8f83\u9ad8\u7684\u4f18\u5148\u7ea7 *   ServiceSpreadingPriority\uff1a\u8fd9\u4e2a\u8c03\u5ea6\u7b56\u7565\u7684\u4e3b\u8981\u76ee\u7684\u662f\u786e\u4fdd\u5c06\u5f52\u5c5e\u4e8e\u540c\u4e00\u4e2a Service \u7684 Pod \u8c03\u5ea6\u5230\u4e0d\u540c\u7684 Node \u4e0a\uff0c\u5982\u679c Node \u4e0a\u6ca1\u6709\u5f52\u5c5e\u4e8e\u540c\u4e00\u4e2a Service \u7684 Pod\uff0c\u8fd9\u4e2a\u7b56\u7565\u66f4\u503e\u5411\u4e8e\u5c06 Pod \u8c03\u5ea6\u5230\u8fd9\u7c7b Node \u4e0a\u3002\u6700\u7ec8\u7684\u76ee\u7684\uff1a\u5373\u4f7f\u5728\u4e00\u4e2a Node \u5b95\u673a\u4e4b\u540e Service \u4e5f\u5177\u6709\u5f88\u5f3a\u5bb9\u707e\u80fd\u529b\u3002 *   CalculateAntiAffinityPriorityMap\uff1a\u8fd9\u4e2a\u7b56\u7565\u4e3b\u8981\u662f\u7528\u6765\u5b9e\u73b0 Pod \u53cd\u4eb2\u548c\u7684 *   EqualPriorityMap\uff1a\u5c06\u6240\u6709\u7684 Node \u8bbe\u7f6e\u6210\u76f8\u540c\u7684\u6743\u91cd\u4e3a 1</p> </li> </ul> <p>\u9664\u4e86\u8fd9\u4e9b\u7b56\u7565\u4e4b\u5916\uff0c\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684\u7b56\u7565\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u6e90\u7801\u6587\u4ef6\uff1a</p> <pre><code>k8s.io/kubernetes/pkg/scheduler/algorithm/priorities/\n</code></pre> <p>\u4e86\u89e3\u66f4\u591a\u4fe1\u606f\u3002\u6bcf\u4e00\u4e2a\u4f18\u5148\u7ea7\u51fd\u6570\u4f1a\u8fd4\u56de\u4e00\u4e2a <code>0-10</code> \u7684\u5206\u6570\uff0c\u5206\u6570\u8d8a\u9ad8\u8868\u793a\u8282\u70b9\u8d8a\u4f18\uff0c\u540c\u65f6\u6bcf\u4e00\u4e2a\u51fd\u6570\u4e5f\u4f1a\u5bf9\u5e94\u4e00\u4e2a\u8868\u793a\u6743\u91cd\u7684\u503c\u3002\u6700\u7ec8\u4e3b\u673a\u7684\u5f97\u5206\u7528\u4ee5\u4e0b\u516c\u5f0f\u8ba1\u7b97\u5f97\u51fa\uff1a</p> <pre><code>finalScoreNode = (weight1 * priorityFunc1) + (weight2 * priorityFunc2) + \u2026 + (weightn * priorityFuncn)\n</code></pre>"},{"location":"kubernetes_scheduler/overview/#_3","title":"\u8c03\u5ea6\u5668\u8c03\u4f18","text":"<p>\u4f5c\u4e3a kubernetes \u96c6\u7fa4\u7684\u9ed8\u8ba4\u8c03\u5ea6\u5668\uff0ckube-scheduler \u4e3b\u8981\u8d1f\u8d23\u5c06 Pod \u8c03\u5ea6\u5230\u96c6\u7fa4\u7684 Node \u4e0a\u3002\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\uff0c\u6ee1\u8db3\u4e00\u4e2a Pod \u8c03\u5ea6\u8bf7\u6c42\u7684\u6240\u6709\u8282\u70b9\u79f0\u4e4b\u4e3a <code>\u53ef\u8c03\u5ea6 Node</code>\uff0c\u8c03\u5ea6\u5668\u5148\u5728\u96c6\u7fa4\u4e2d\u627e\u5230\u4e00\u4e2a Pod \u7684\u53ef\u8c03\u5ea6 Node\uff0c\u7136\u540e\u6839\u636e\u4e00\u7cfb\u5217\u51fd\u6570\u5bf9\u8fd9\u4e9b\u53ef\u8c03\u5ea6 Node \u8fdb\u884c\u6253\u5206\uff0c\u4e4b\u540e\u9009\u51fa\u5176\u4e2d\u5f97\u5206\u6700\u9ad8\u7684 Node \u6765\u8fd0\u884c Pod\uff0c\u6700\u540e\uff0c\u8c03\u5ea6\u5668\u5c06\u8fd9\u4e2a\u8c03\u5ea6\u51b3\u5b9a\u544a\u77e5 <code>kube-apiserver</code>\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u53eb\u505a<code>\u7ed1\u5b9a</code>\u3002</p> <p>\u5728 Kubernetes 1.12 \u7248\u672c\u4e4b\u524d\uff0ckube-scheduler \u4f1a\u68c0\u67e5\u96c6\u7fa4\u4e2d\u6240\u6709\u8282\u70b9\u7684\u53ef\u8c03\u5ea6\u6027\uff0c\u5e76\u4e14\u7ed9\u53ef\u8c03\u5ea6\u8282\u70b9\u6253\u5206\u3002Kubernetes 1.12 \u7248\u672c\u6dfb\u52a0\u4e86\u4e00\u4e2a\u65b0\u7684\u529f\u80fd\uff0c\u5141\u8bb8\u8c03\u5ea6\u5668\u5728\u627e\u5230\u4e00\u5b9a\u6570\u91cf\u7684\u53ef\u8c03\u5ea6\u8282\u70b9\u4e4b\u540e\u5c31\u505c\u6b62\u7ee7\u7eed\u5bfb\u627e\u53ef\u8c03\u5ea6\u8282\u70b9\u3002\u8be5\u529f\u80fd\u80fd\u63d0\u9ad8\u8c03\u5ea6\u5668\u5728\u5927\u89c4\u6a21\u96c6\u7fa4\u4e0b\u7684\u8c03\u5ea6\u6027\u80fd\uff0c\u8fd9\u4e2a\u6570\u503c\u662f\u96c6\u7fa4\u89c4\u6a21\u7684\u767e\u5206\u6bd4\uff0c\u8fd9\u4e2a\u767e\u5206\u6bd4\u901a\u8fc7 </p> <pre><code>percentageOfNodesToScore\n</code></pre> <p>\u53c2\u6570\u6765\u8fdb\u884c\u914d\u7f6e\uff0c\u5176\u503c\u7684\u8303\u56f4\u5728 1 \u5230 100 \u4e4b\u95f4\uff0c\u6700\u5927\u503c\u5c31\u662f 100%\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3a 0 \u5c31\u4ee3\u8868\u6ca1\u6709\u63d0\u4f9b\u8fd9\u4e2a\u53c2\u6570\u914d\u7f6e\u3002Kubernetes 1.14 \u7248\u672c\u53c8\u52a0\u5165\u4e86\u4e00\u4e2a\u7279\u6027\uff0c\u5728\u8be5\u53c2\u6570\u6ca1\u6709\u88ab\u7528\u6237\u914d\u7f6e\u7684\u60c5\u51b5\u4e0b\uff0c\u8c03\u5ea6\u5668\u4f1a\u6839\u636e\u96c6\u7fa4\u7684\u89c4\u6a21\u81ea\u52a8\u8bbe\u7f6e\u4e00\u4e2a\u96c6\u7fa4\u6bd4\u4f8b\uff0c\u7136\u540e\u901a\u8fc7\u8fd9\u4e2a\u6bd4\u4f8b\u7b5b\u9009\u4e00\u5b9a\u6570\u91cf\u7684\u53ef\u8c03\u5ea6\u8282\u70b9\u8fdb\u5165\u6253\u5206\u9636\u6bb5\u3002\u8be5\u7279\u6027\u4f7f\u7528<code>\u7ebf\u6027\u516c\u5f0f</code>\u8ba1\u7b97\u51fa\u96c6\u7fa4\u6bd4\u4f8b\uff0c\u6bd4\u5982100\u4e2a\u8282\u70b9\u7684\u96c6\u7fa4\u4e0b\u4f1a\u53d6 50%\uff0c\u5728 5000\u8282\u70b9\u7684\u96c6\u7fa4\u4e0b\u53d6 10%\uff0c\u8fd9\u4e2a\u81ea\u52a8\u8bbe\u7f6e\u7684\u53c2\u6570\u7684\u6700\u4f4e\u503c\u662f 5%\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u8c03\u5ea6\u5668\u81f3\u5c11\u4f1a\u5bf9\u96c6\u7fa4\u4e2d 5% \u7684\u8282\u70b9\u8fdb\u884c\u6253\u5206\uff0c\u9664\u975e\u7528\u6237\u5c06\u8be5\u53c2\u6570\u8bbe\u7f6e\u7684\u4f4e\u4e8e 5\u3002</p> <p>\u6ce8\u610f</p> <p>\u5f53\u96c6\u7fa4\u4e2d\u7684\u53ef\u8c03\u5ea6\u8282\u70b9\u5c11\u4e8e 50 \u4e2a\u65f6\uff0c\u8c03\u5ea6\u5668\u4ecd\u7136\u4f1a\u53bb\u68c0\u67e5\u6240\u6709\u8282\u70b9\uff0c\u56e0\u4e3a\u53ef\u8c03\u5ea6\u8282\u70b9\u592a\u5c11\uff0c\u4e0d\u8db3\u4ee5\u505c\u6b62\u8c03\u5ea6\u5668\u6700\u521d\u7684\u8fc7\u6ee4\u9009\u62e9\u3002\u5982\u679c\u6211\u4eec\u60f3\u8981\u5173\u6389\u8fd9\u4e2a\u8303\u56f4\u53c2\u6570\uff0c\u53ef\u4ee5\u5c06 </p> <pre><code>percentageOfNodesToScore\n</code></pre> <p>\u503c\u8bbe\u7f6e\u6210 100\u3002</p> <p>``` percentageOfNodesToScore <pre><code> \u7684\u503c\u5fc5\u987b\u5728 1 \u5230 100 \u4e4b\u95f4\uff0c\u800c\u4e14\u5176\u9ed8\u8ba4\u503c\u662f\u901a\u8fc7\u96c6\u7fa4\u7684\u89c4\u6a21\u8ba1\u7b97\u5f97\u6765\u7684\uff0c\u53e6\u5916 `50` \u4e2a Node \u7684\u6570\u503c\u662f\u786c\u7f16\u7801\u5728\u7a0b\u5e8f\u91cc\u9762\u7684\uff0c\u8bbe\u7f6e\u8fd9\u4e2a\u503c\u7684\u4f5c\u7528\u5728\u4e8e\uff1a`\u5f53\u96c6\u7fa4\u7684\u89c4\u6a21\u662f\u6570\u767e\u4e2a\u8282\u70b9\u5e76\u4e14 percentageOfNodesToScore \u53c2\u6570\u8bbe\u7f6e\u7684\u8fc7\u4f4e\u7684\u65f6\u5019\uff0c\u8c03\u5ea6\u5668\u7b5b\u9009\u5230\u7684\u53ef\u8c03\u5ea6\u8282\u70b9\u6570\u76ee\u57fa\u672c\u4e0d\u4f1a\u53d7\u5230\u8be5\u53c2\u6570\u5f71\u54cd`\u3002\u5f53\u96c6\u7fa4\u89c4\u6a21\u8f83\u5c0f\u65f6\uff0c\u8fd9\u4e2a\u8bbe\u7f6e\u5bf9\u8c03\u5ea6\u5668\u6027\u80fd\u63d0\u5347\u5e76\u4e0d\u660e\u663e\uff0c\u4f46\u662f\u5728\u8d85\u8fc7 1000 \u4e2a Node \u7684\u96c6\u7fa4\u4e2d\uff0c\u5c06\u8c03\u4f18\u53c2\u6570\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u8f83\u4f4e\u7684\u503c\u53ef\u4ee5\u5f88\u660e\u663e\u7684\u63d0\u5347\u8c03\u5ea6\u5668\u6027\u80fd\u3002\n\n&gt; \u4e0d\u8fc7\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u8be5\u53c2\u6570\u8bbe\u7f6e\u540e\u53ef\u80fd\u4f1a\u5bfc\u81f4\u53ea\u6709\u96c6\u7fa4\u4e2d\u5c11\u6570\u8282\u70b9\u88ab\u9009\u4e3a\u53ef\u8c03\u5ea6\u8282\u70b9\uff0c\u5f88\u591a Node \u90fd\u6ca1\u6709\u8fdb\u5165\u5230\u6253\u5206\u9636\u6bb5\uff0c\u8fd9\u6837\u5c31\u4f1a\u9020\u6210\u4e00\u79cd\u540e\u679c\uff0c\u4e00\u4e2a\u672c\u6765\u53ef\u4ee5\u5728\u6253\u5206\u9636\u6bb5\u5f97\u5206\u5f88\u9ad8\u7684 Node \u751a\u81f3\u90fd\u4e0d\u80fd\u8fdb\u5165\u6253\u5206\u9636\u6bb5\uff0c\u7531\u4e8e\u8fd9\u4e2a\u539f\u56e0\uff0c\u6240\u4ee5\u8fd9\u4e2a\u53c2\u6570\u4e0d\u5e94\u8be5\u88ab\u8bbe\u7f6e\u6210\u4e00\u4e2a\u5f88\u4f4e\u7684\u503c\uff0c\u901a\u5e38\u7684\u505a\u6cd5\u662f\u4e0d\u4f1a\u5c06\u8fd9\u4e2a\u53c2\u6570\u7684\u503c\u8bbe\u7f6e\u7684\u4f4e\u4e8e 10\uff0c\u5f88\u4f4e\u7684\u53c2\u6570\u503c\u4e00\u822c\u5728\u8c03\u5ea6\u5668\u7684\u541e\u5410\u91cf\u5f88\u9ad8\u4e14\u5bf9 Node \u7684\u6253\u5206\u4e0d\u91cd\u8981\u7684\u60c5\u51b5\u4e0b\u624d\u4f7f\u7528\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u53ea\u6709\u5f53\u4f60\u66f4\u503e\u5411\u4e8e\u5728\u53ef\u8c03\u5ea6\u8282\u70b9\u4e2d\u4efb\u610f\u9009\u62e9\u4e00\u4e2a Node \u6765\u8fd0\u884c\u8fd9\u4e2a Pod \u65f6\uff0c\u624d\u4f7f\u7528\u5f88\u4f4e\u7684\u53c2\u6570\u8bbe\u7f6e\u3002\n\n&gt; \u5982\u679c\u4f60\u7684\u96c6\u7fa4\u89c4\u6a21\u53ea\u6709\u6570\u767e\u4e2a\u8282\u70b9\u6216\u8005\u66f4\u5c11\uff0c\u5b9e\u9645\u4e0a\u5e76\u4e0d\u63a8\u8350\u4f60\u5c06\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u5f97\u6bd4\u9ed8\u8ba4\u503c\u66f4\u4f4e\uff0c\u56e0\u4e3a\u8fd9\u79cd\u60c5\u51b5\u4e0b\u4e0d\u592a\u4f1a\u6709\u6548\u7684\u63d0\u9ad8\u8c03\u5ea6\u5668\u6027\u80fd\u3002\n\n### \u81ea\u5b9a\u4e49\u8c03\u5ea6\u5668 \n\n&gt; \u4e00\u822c\u6765\u8bf4\uff0c\u6211\u4eec\u67094\u79cd\u6269\u5c55 Kubernetes \u8c03\u5ea6\u5668\u7684\u65b9\u6cd5\u3002\n\n*   &gt; \u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u76f4\u63a5 clone \u5b98\u65b9\u7684 kube-scheduler \u6e90\u4ee3\u7801\uff0c\u5728\u5408\u9002\u7684\u4f4d\u7f6e\u76f4\u63a5\u4fee\u6539\u4ee3\u7801\uff0c\u7136\u540e\u91cd\u65b0\u7f16\u8bd1\u8fd0\u884c\u4fee\u6539\u540e\u7684\u7a0b\u5e8f\uff0c\u5f53\u7136\u8fd9\u79cd\u65b9\u6cd5\u662f\u6700\u4e0d\u5efa\u8bae\u4f7f\u7528\u7684\uff0c\u4e5f\u4e0d\u5b9e\u7528\uff0c\u56e0\u4e3a\u9700\u8981\u82b1\u8d39\u5927\u91cf\u989d\u5916\u7684\u7cbe\u529b\u6765\u548c\u4e0a\u6e38\u7684\u8c03\u5ea6\u7a0b\u5e8f\u66f4\u6539\u4fdd\u6301\u4e00\u81f4\u3002\n\n*   &gt; \u7b2c\u4e8c\u79cd\u65b9\u6cd5\u5c31\u662f\u548c\u9ed8\u8ba4\u7684\u8c03\u5ea6\u7a0b\u5e8f\u4e00\u8d77\u8fd0\u884c\u72ec\u7acb\u7684\u8c03\u5ea6\u7a0b\u5e8f\uff0c\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\u548c\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u8c03\u5ea6\u5668\u53ef\u4ee5\u901a\u8fc7 Pod \u7684 `spec.schedulerName` \u6765\u8986\u76d6\u5404\u81ea\u7684 Pod\uff0c\u9ed8\u8ba4\u662f\u4f7f\u7528 default \u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\uff0c\u4f46\u662f\u591a\u4e2a\u8c03\u5ea6\u7a0b\u5e8f\u5171\u5b58\u7684\u60c5\u51b5\u4e0b\u4e5f\u6bd4\u8f83\u9ebb\u70e6\uff0c\u6bd4\u5982\u5f53\u591a\u4e2a\u8c03\u5ea6\u5668\u5c06 Pod \u8c03\u5ea6\u5230\u540c\u4e00\u4e2a\u8282\u70b9\u7684\u65f6\u5019\uff0c\u53ef\u80fd\u4f1a\u9047\u5230\u4e00\u4e9b\u95ee\u9898\uff0c\u56e0\u4e3a\u5f88\u6709\u53ef\u80fd\u4e24\u4e2a\u8c03\u5ea6\u5668\u90fd\u540c\u65f6\u5c06\u4e24\u4e2a Pod \u8c03\u5ea6\u5230\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u53bb\uff0c\u4f46\u662f\u5f88\u6709\u53ef\u80fd\u5176\u4e2d\u4e00\u4e2a Pod \u8fd0\u884c\u540e\u5176\u5b9e\u8d44\u6e90\u5c31\u6d88\u8017\u5b8c\u4e86\uff0c\u5e76\u4e14\u7ef4\u62a4\u4e00\u4e2a\u9ad8\u8d28\u91cf\u7684\u81ea\u5b9a\u4e49\u8c03\u5ea6\u7a0b\u5e8f\u4e5f\u4e0d\u662f\u5f88\u5bb9\u6613\u7684\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u5168\u9762\u4e86\u89e3\u9ed8\u8ba4\u7684\u8c03\u5ea6\u7a0b\u5e8f\uff0c\u6574\u4f53 Kubernetes \u7684\u67b6\u6784\u77e5\u8bc6\u4ee5\u53ca\u5404\u79cd Kubernetes API \u5bf9\u8c61\u7684\u5404\u79cd\u5173\u7cfb\u6216\u9650\u5236\u3002\n\n*   &gt; \u7b2c\u4e09\u79cd\u65b9\u6cd5\u662f\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\uff0c\u8fd9\u4e2a\u65b9\u6848\u76ee\u524d\u662f\u4e00\u4e2a\u53ef\u884c\u7684\u65b9\u6848\uff0c\u53ef\u4ee5\u548c\u4e0a\u6e38\u8c03\u5ea6\u7a0b\u5e8f\u517c\u5bb9\uff0c\u6240\u8c13\u7684\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u53ef\u914d\u7f6e\u7684 Webhook \u800c\u5df2\uff0c\u91cc\u9762\u5305\u542b `\u8fc7\u6ee4\u5668` \u548c `\u4f18\u5148\u7ea7` \u4e24\u4e2a\u7aef\u70b9\uff0c\u5206\u522b\u5bf9\u5e94\u8c03\u5ea6\u5468\u671f\u4e2d\u7684\u4e24\u4e2a\u4e3b\u8981\u9636\u6bb5\uff08\u8fc7\u6ee4\u548c\u6253\u5206\uff09\u3002\n\n*   &gt; \u7b2c\u56db\u79cd\u65b9\u6cd5\u662f\u901a\u8fc7\u8c03\u5ea6\u6846\u67b6\uff08Scheduling Framework\uff09\uff0cKubernetes v1.15 \u7248\u672c\u4e2d\u5f15\u5165\u4e86\u53ef\u63d2\u62d4\u67b6\u6784\u7684\u8c03\u5ea6\u6846\u67b6\uff0c\u4f7f\u5f97\u5b9a\u5236\u8c03\u5ea6\u5668\u8fd9\u4e2a\u4efb\u52a1\u53d8\u5f97\u66f4\u52a0\u7684\u5bb9\u6613\u3002\u8c03\u5e93\u6846\u67b6\u5411\u73b0\u6709\u7684\u8c03\u5ea6\u5668\u4e2d\u6dfb\u52a0\u4e86\u4e00\u7ec4\u63d2\u4ef6\u5316\u7684 API\uff0c\u8be5 API \u5728\u4fdd\u6301\u8c03\u5ea6\u7a0b\u5e8f\u6838\u5fc3\u7b80\u5355\u4e14\u6613\u4e8e\u7ef4\u62a4\u7684\u540c\u65f6\uff0c\u4f7f\u5f97\u5927\u90e8\u5206\u7684\u8c03\u5ea6\u529f\u80fd\u4ee5\u63d2\u4ef6\u7684\u5f62\u5f0f\u5b58\u5728\uff0c\u800c\u4e14\u5728\u6211\u4eec\u73b0\u5728\u7684 v1.26 \u7248\u672c\u4e2d\u4e0a\u9762\u7684 `\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f` \u4e5f\u5df2\u7ecf\u88ab\u5e9f\u5f03\u4e86\uff0c\u6240\u4ee5\u4ee5\u540e\u8c03\u5ea6\u6846\u67b6\u624d\u662f\u81ea\u5b9a\u4e49\u8c03\u5ea6\u5668\u7684\u6838\u5fc3\u65b9\u5f0f\u3002\n\n&gt; \u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u4ecb\u7ecd\u4e0b\u540e\u9762\u4e24\u79cd\u65b9\u5f0f\u7684\u5b9e\u73b0\u3002\n\n### \u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f \n\n&gt; \u5728\u8fdb\u5165\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u4e4b\u524d\uff0c\u6211\u4eec\u518d\u6765\u4e86\u89e3\u4e0b Kubernetes \u8c03\u5ea6\u7a0b\u5e8f\u662f\u5982\u4f55\u5de5\u4f5c\u7684:\n\n1.  \u9ed8\u8ba4\u8c03\u5ea6\u5668\u6839\u636e\u6307\u5b9a\u7684\u53c2\u6570\u542f\u52a8\uff08\u6211\u4eec\u4f7f\u7528 kubeadm \u642d\u5efa\u7684\u96c6\u7fa4\uff0c\u542f\u52a8\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e \n\n    ```\n    /etc/kubernetes/manifests/kube-schdueler.yaml\n    ```\n\n    \uff09\n2.  watch apiserver\uff0c\u5c06 `spec.nodeName` \u4e3a\u7a7a\u7684 Pod \u653e\u5165\u8c03\u5ea6\u5668\u5185\u90e8\u7684\u8c03\u5ea6\u961f\u5217\u4e2d\n3.  \u4ece\u8c03\u5ea6\u961f\u5217\u4e2d Pop \u51fa\u4e00\u4e2a Pod\uff0c\u5f00\u59cb\u4e00\u4e2a\u6807\u51c6\u7684\u8c03\u5ea6\u5468\u671f\n4.  \u4ece Pod \u5c5e\u6027\u4e2d\u68c0\u7d22\u201c\u786c\u6027\u8981\u6c42\u201d\uff08\u6bd4\u5982 CPU/\u5185\u5b58\u8bf7\u6c42\u503c\uff0cnodeSelector/nodeAffinity\uff09\uff0c\u7136\u540e\u8fc7\u6ee4\u9636\u6bb5\u53d1\u751f\uff0c\u5728\u8be5\u9636\u6bb5\u8ba1\u7b97\u51fa\u6ee1\u8db3\u8981\u6c42\u7684\u8282\u70b9\u5019\u9009\u5217\u8868\n5.  \u4ece Pod \u5c5e\u6027\u4e2d\u68c0\u7d22\u201c\u8f6f\u9700\u6c42\u201d\uff0c\u5e76\u5e94\u7528\u4e00\u4e9b\u9ed8\u8ba4\u7684\u201c\u8f6f\u7b56\u7565\u201d\uff08\u6bd4\u5982 Pod \u503e\u5411\u4e8e\u5728\u8282\u70b9\u4e0a\u66f4\u52a0\u805a\u62e2\u6216\u5206\u6563\uff09\uff0c\u6700\u540e\uff0c\u5b83\u4e3a\u6bcf\u4e2a\u5019\u9009\u8282\u70b9\u7ed9\u51fa\u4e00\u4e2a\u5206\u6570\uff0c\u5e76\u6311\u9009\u51fa\u5f97\u5206\u6700\u9ad8\u7684\u6700\u7ec8\u83b7\u80dc\u8005\n6.  \u548c apiserver \u901a\u4fe1\uff08\u53d1\u9001\u7ed1\u5b9a\u8c03\u7528\uff09\uff0c\u7136\u540e\u8bbe\u7f6e Pod \u7684 `spec.nodeName` \u5c5e\u6027\u4ee5\u8868\u793a\u5c06\u8be5 Pod \u8c03\u5ea6\u5230\u7684\u8282\u70b9\u3002\n\n&gt; \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b\u5b98\u65b9\u6587\u6863\uff0c\u53ef\u4ee5\u901a\u8fc7 `--config` \u53c2\u6570\u6307\u5b9a\u8c03\u5ea6\u5668\u5c06\u4f7f\u7528\u54ea\u4e9b\u53c2\u6570\uff0c\u8be5\u914d\u7f6e\u6587\u4ef6\u5e94\u8be5\u5305\u542b\u4e00\u4e2a KubeSchedulerConfiguration \u5bf9\u8c61\uff0c\u5982\u4e0b\u6240\u793a\u683c\u5f0f\uff1a\uff08/etc/kubernetes/scheduler-extender.yaml)\n</code></pre></p>"},{"location":"kubernetes_scheduler/overview/#--config","title":"\u901a\u8fc7\"--config\" \u4f20\u9012\u6587\u4ef6\u5185\u5bb9","text":"<p>apiVersion: kubescheduler.config.k8s.io/v1alpha1 kind: KubeSchedulerConfiguration clientConnection:   kubeconfig: \"/etc/kubernetes/scheduler.conf\" algorithmSource:   policy:     file:       path: \"/etc/kubernetes/scheduler-extender-policy.yaml\"  # \u6307\u5b9a\u81ea\u5b9a\u4e49\u8c03\u5ea6\u7b56\u7565\u6587\u4ef6 <pre><code>&gt; \u6211\u4eec\u5728\u8fd9\u91cc\u5e94\u8be5\u8f93\u5165\u7684\u5173\u952e\u53c2\u6570\u662f \n</code></pre> algorithmSource.policy <pre><code>\uff0c\u8fd9\u4e2a\u7b56\u7565\u6587\u4ef6\u53ef\u4ee5\u662f\u672c\u5730\u6587\u4ef6\u4e5f\u53ef\u4ee5\u662f ConfigMap \u8d44\u6e90\u5bf9\u8c61\uff0c\u8fd9\u53d6\u51b3\u4e8e\u8c03\u5ea6\u7a0b\u5e8f\u7684\u90e8\u7f72\u65b9\u5f0f\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\u662f\u9759\u6001 Pod \u65b9\u5f0f\u542f\u52a8\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u7528\u672c\u5730\u6587\u4ef6\u7684\u5f62\u5f0f\u6765\u914d\u7f6e\u3002\n\n&gt; \u8be5\u7b56\u7565\u6587\u4ef6 \n</code></pre> /etc/kubernetes/scheduler-extender-policy.yaml <pre><code> \u5e94\u8be5\u9075\u5faa kubernetes/pkg/scheduler/apis/config/legacy_types.go#L28 \u7684\u8981\u6c42\uff0c\u5728\u6211\u4eec\u8fd9\u91cc\u7684 v1.26.2 \u7248\u672c\u4e2d\u5df2\u7ecf\u652f\u6301 JSON \u548c YAML \u4e24\u79cd\u683c\u5f0f\u7684\u7b56\u7565\u6587\u4ef6\uff0c\u4e0b\u9762\u662f\u6211\u4eec\u5b9a\u4e49\u7684\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\uff0c\u53ef\u4ee5\u67e5\u770b Extender \u63cf\u8ff0\u4e86\u89e3\u7b56\u7565\u6587\u4ef6\u7684\u5b9a\u4e49\u89c4\u8303\uff1a\n</code></pre> apiVersion: v1 kind: Policy extenders: - urlPrefix: \"http://11:8888/\"   filterVerb: \"filter\"   prioritizeVerb: \"prioritize\"   weight: 1   enableHttps: false <pre><code>&gt; \u81ea\u5b9a\u4e49\n\n&gt; \u6211\u4eec\u8fd9\u91cc\u7684 Policy \u7b56\u7565\u6587\u4ef6\u662f\u901a\u8fc7\u5b9a\u4e49 `extenders` \u6765\u6269\u5c55\u8c03\u5ea6\u5668\u7684\uff0c\u6709\u65f6\u5019\u6211\u4eec\u4e0d\u9700\u8981\u53bb\u7f16\u5199\u4ee3\u7801\uff0c\u53ef\u4ee5\u76f4\u63a5\u5728\u8be5\u914d\u7f6e\u6587\u4ef6\u4e2d\u901a\u8fc7\u6307\u5b9a `predicates` \u548c `priorities` \u6765\u8fdb\u884c\u81ea\u5b9a\u4e49\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a\u5219\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u7684 `DefaultProvier`\u3002\n</code></pre> {   \"kind\": \"Policy\",   \"apiVersion\": \"v1\",   \"predicates\": [{         \"name\": \"MatchNodeSelector\"     }, {         \"name\": \"PodFitsResources\"     }, {         \"name\": \"PodFitsHostPorts\"     },{         \"name\": \"HostName\"     }   ],   \"priorities\": [{         \"name\": \"EqualPriority\",         \"weight\": 2     }, {         \"name\": \"ImageLocalityPriority\",         \"weight\": 4     }, {         \"name\": \"LeastRequestedPriority\",         \"weight\": 2     }, {         \"name\": \"BalancedResourceAllocation\",         \"weight\": 2     }   ],   \"extenders\": [{         \"urlPrefix\": \"/prefix\",         \"filterVerb\": \"filter\",         \"prioritizeVerb\": \"prioritize\",         \"weight\": 1,         \"bindVerb\": \"bind\",         \"enableHttps\": false   }] } <pre><code>&gt; \u6539\u7b56\u7565\u6587\u4ef6\u5b9a\u4e49\u4e86\u4e00\u4e2a HTTP \u7684\u6269\u5c55\u7a0b\u5e8f\u670d\u52a1\uff0c\u8be5\u670d\u52a1\u8fd0\u884c\u5728 `127.0.0.1:8888` \u4e0b\u9762\uff0c\u5e76\u4e14\u5df2\u7ecf\u5c06\u8be5\u7b56\u7565\u6ce8\u518c\u5230\u4e86\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\u4e2d\uff0c\u8fd9\u6837\u5728\u8fc7\u6ee4\u548c\u6253\u5206\u9636\u6bb5\u7ed3\u675f\u540e\uff0c\u53ef\u4ee5\u5c06\u7ed3\u679c\u5206\u522b\u4f20\u9012\u7ed9\u8be5\u6269\u5c55\u7a0b\u5e8f\u7684\u7aef\u70b9 \n</code></pre> / <pre><code> \u548c \n</code></pre> / <pre><code>\uff0c\u5728\u6269\u5c55\u7a0b\u5e8f\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u8fdb\u4e00\u6b65\u8fc7\u6ee4\u5e76\u786e\u5b9a\u4f18\u5148\u7ea7\uff0c\u4ee5\u9002\u5e94\u6211\u4eec\u7684\u7279\u5b9a\u4e1a\u52a1\u9700\u6c42\u3002\n\n#### \u793a\u4f8b \n\n&gt; \u6211\u4eec\u76f4\u63a5\u7528 golang \u6765\u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u7684\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\uff0c\u5f53\u7136\u4f60\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u4efb\u4f55\u7f16\u7a0b\u8bed\u8a00\uff0c\u5982\u4e0b\u6240\u793a\uff1a\n</code></pre> func main() {     router := httprouter.New()     router.GET(\"/\", Index)     router.POST(\"/filter\", Filter)     router.POST(\"/prioritize\", Prioritize) <pre><code>log.Fatal(http.ListenAndServe(\":8888\", router))\n</code></pre> <p>} ``` </p> <p>\u7136\u540e\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u5b9e\u73b0 <code>/filter</code> \u548c <code>/prioritize</code> \u4e24\u4e2a\u7aef\u70b9\u7684\u5904\u7406\u7a0b\u5e8f\u3002</p> <p>\u5176\u4e2d <code>Filter</code> \u8fd9\u4e2a\u6269\u5c55\u51fd\u6570\u63a5\u6536\u4e00\u4e2a\u8f93\u5165\u7c7b\u578b\u4e3a </p> <p><code>schedulerapi.ExtenderArgs</code></p> <p>\u7684\u53c2\u6570\uff0c\u7136\u540e\u8fd4\u56de\u4e00\u4e2a\u7c7b\u578b\u4e3a </p> <p><code>*schedulerapi.ExtenderFilterResult</code></p> <p>\u7684\u503c\u3002\u5728\u51fd\u6570\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u8fdb\u4e00\u6b65\u8fc7\u6ee4\u8f93\u5165\u7684\u8282\u70b9\uff1a</p> <p>``` // filter \u6839\u636e\u6269\u5c55\u7a0b\u5e8f\u5b9a\u4e49\u7684\u9884\u9009\u89c4\u5219\u6765\u8fc7\u6ee4\u8282\u70b9 func filter(args schedulerapi.ExtenderArgs) *schedulerapi.ExtenderFilterResult {     var filteredNodes []vNode     failedNodes := make(schedulerapi.FailedNodesMap)     pod := args.Pod</p> <pre><code>for _, node := range args.Nodes.Items {\n    fits, failReasons, _ := podFitsOnNode(pod, node)\n    if fits {\n        filteredNodes = append(filteredNodes, node)\n    } else {\n        failedNodes[node.Name] = strings.Join(failReasons, \",\")\n    }\n}\n\nresult := schedulerapi.ExtenderFilterResult{\n    Nodes: &amp;vNodeList{\n        Items: filteredNodes,\n    },\n    FailedNodes: failedNodes,\n    Error:       \"\",\n}\n\nreturn &amp;result\n</code></pre> <p>} ``` </p> <p>\u5728\u8fc7\u6ee4\u51fd\u6570\u4e2d\uff0c\u6211\u4eec\u5faa\u73af\u6bcf\u4e2a\u8282\u70b9\u7136\u540e\u7528\u6211\u4eec\u81ea\u5df1\u5b9e\u73b0\u7684\u4e1a\u52a1\u903b\u8f91\u6765\u5224\u65ad\u662f\u5426\u5e94\u8be5\u6279\u51c6\u8be5\u8282\u70b9\uff0c\u8fd9\u91cc\u6211\u4eec\u5b9e\u73b0\u6bd4\u8f83\u7b80\u5355\uff0c\u5728 <code>podFitsOnNode()</code> \u51fd\u6570\u4e2d\u6211\u4eec\u53ea\u662f\u7b80\u5355\u7684\u68c0\u67e5\u968f\u673a\u6570\u662f\u5426\u4e3a\u5076\u6570\u6765\u5224\u65ad\u5373\u53ef\uff0c\u5982\u679c\u662f\u7684\u8bdd\u6211\u4eec\u5c31\u8ba4\u4e3a\u8fd9\u662f\u4e00\u4e2a\u5e78\u8fd0\u7684\u8282\u70b9\uff0c\u5426\u5219\u62d2\u7edd\u6279\u51c6\u8be5\u8282\u70b9\u3002</p> <p>``` var predicatesSorted = []string{LuckyPred}</p> <p>var predicatesFuncs = map[string]FitPredicate{     LuckyPred: LuckyPredicate, }</p> <p>type FitPredicate func(pod *vPod, node vNode) (bool, []string, error)</p> <p>func podFitsOnNode(pod *vPod, node vNode) (bool, []string, error) {     fits := true     var failReasons []string     for _, predicateKey := range predicatesSorted {         fit, failures, err := predicatesFuncspredicateKey         if err != nil {             return false, nil, err         }         fits = fits &amp;&amp; fit         failReasons = append(failReasons, failures...)     }     return fits, failReasons, nil }</p> <p>func LuckyPredicate(pod *vPod, node vNode) (bool, []string, error) {     lucky := rand.Intn(2) == 0     if lucky {         log.Printf(\"pod %v/%v is lucky to fit on node %v\\n\", pod.Name, pod.Namespace, node.Name)         return true, nil, nil     }     log.Printf(\"pod %v/%v is unlucky to fit on node %v\\n\", pod.Name, pod.Namespace, node.Name)     return false, []string{LuckyPredFailMsg}, nil } <pre><code>&gt; \u540c\u6837\u7684\u6253\u5206\u529f\u80fd\u7528\u540c\u6837\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\uff0c\u6211\u4eec\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u968f\u673a\u7ed9\u51fa\u4e00\u4e2a\u5206\u6570\uff1a\n</code></pre> // it's webhooked to pkg/scheduler/core/generic_scheduler.go#PrioritizeNodes() // \u8fd9\u4e2a\u51fd\u6570\u8f93\u51fa\u7684\u5206\u6570\u4f1a\u88ab\u6dfb\u52a0\u4f1a\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668 func prioritize(args schedulerapi.ExtenderArgs) *schedulerapi.HostPriorityList {     pod := args.Pod     nodes := args.Nodes.Items</p> <pre><code>hostPriorityList := make(schedulerapi.HostPriorityList, len(nodes))\nfor i, node := range nodes {\n    score := rand.Intn(schedulerapi.MaxPriority + 1)  // \u5728\u6700\u5927\u4f18\u5148\u7ea7\u5185\u968f\u673a\u53d6\u4e00\u4e2a\u503c\n    log.Printf(luckyPrioMsg, pod.Name, pod.Namespace, score)\n    hostPriorityList[i] = schedulerapi.HostPriority{\n        Host:  node.Name,\n        Score: score,\n    }\n}\n\nreturn &amp;hostPriorityList\n</code></pre> <p>} ``` </p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u7f16\u8bd1\u6253\u5305\u6211\u4eec\u7684\u5e94\u7528\uff1a</p> <p><code>$ GOOS=linux GOARCH=amd64 go build -o app</code></p> <p>\u4ee3\u7801</p> <p>\u672c\u8282\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u5b8c\u6574\u7684\u4ee3\u7801\u83b7\u53d6\u5730\u5740\uff1ahttps://github.com/cnych/sample-scheduler-extender\u3002</p> <p>\u6784\u5efa\u5b8c\u6210\u540e\uff0c\u5c06\u5e94\u7528 <code>app</code> \u62f7\u8d1d\u5230 <code>kube-scheduler</code> \u6240\u5728\u7684\u8282\u70b9\u76f4\u63a5\u8fd0\u884c\u5373\u53ef\u3002\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684\u7b56\u7565\u6587\u4ef6\u914d\u7f6e\u5230 <code>kube-scheduler</code> \u7ec4\u4ef6\u4e2d\u53bb\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u96c6\u7fa4\u662f kubeadm \u642d\u5efa\u7684\uff0c\u6240\u4ee5\u76f4\u63a5\u4fee\u6539\u6587\u4ef6 </p> <p><code>/etc/kubernetes/manifests/kube-schduler.yaml</code></p> <p>\u6587\u4ef6\u5373\u53ef\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>apiVersion: v1 kind: Pod metadata:   creationTimestamp: null   labels:     component: kube-scheduler     tier: control-plane   name: kube-scheduler   namespace: kube-system spec:   containers:   - command:     - kube-scheduler     - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf     - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf     - --bind-address=11     - --kubeconfig=/etc/kubernetes/scheduler.conf     - --leader-elect=true     - --config=/etc/kubernetes/scheduler-extender.yaml     - --v=9     image: gcr.azk8s.cn/google_containers/kube-scheduler:v2     imagePullPolicy: IfNotPresent     livenessProbe:       failureThreshold: 8       httpGet:         host: 11         path: /healthz         port: 10251         scheme: HTTP       initialDelaySeconds: 15       timeoutSeconds: 15     name: kube-scheduler     resources:       requests:         cpu: 100m     volumeMounts:     - mountPath: /etc/kubernetes/scheduler.conf       name: kubeconfig       readOnly: true     - mountPath: /etc/kubernetes/scheduler-extender.yaml       name: extender       readOnly: true     - mountPath: /etc/kubernetes/scheduler-extender-policy.yaml       name: extender-policy       readOnly: true   hostNetwork: true   priorityClassName: system-cluster-critical   volumes:   - hostPath:       path: /etc/kubernetes/scheduler.conf       type: FileOrCreate     name: kubeconfig   - hostPath:       path: /etc/kubernetes/scheduler-extender.yaml       type: FileOrCreate     name: extender   - hostPath:       path: /etc/kubernetes/scheduler-extender-policy.yaml       type: FileOrCreate     name: extender-policy status: {}</code></p> <p>\u6ce8\u610f</p> <p>\u5f53\u7136\u6211\u4eec\u8fd9\u4e2a\u5730\u65b9\u662f\u76f4\u63a5\u5728\u7cfb\u7edf\u9ed8\u8ba4\u7684 <code>kube-scheduler</code> \u4e0a\u9762\u914d\u7f6e\u7684\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u590d\u5236\u4e00\u4e2a\u8c03\u5ea6\u5668\u7684 YAML \u6587\u4ef6\u7136\u540e\u66f4\u6539\u4e0b schedulerName \u6765\u90e8\u7f72\uff0c\u8fd9\u6837\u5c31\u4e0d\u4f1a\u5f71\u54cd\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\u4e86\uff0c\u7136\u540e\u5728\u9700\u8981\u4f7f\u7528\u8fd9\u4e2a\u6d4b\u8bd5\u7684\u8c03\u5ea6\u5668\u7684 Pod \u4e0a\u9762\u6307\u5b9a <code>spec.schedulerName</code> \u5373\u53ef\u3002\u5bf9\u4e8e\u591a\u8c03\u5ea6\u5668\u7684\u4f7f\u7528\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863 \u914d\u7f6e\u591a\u4e2a\u8c03\u5ea6\u5668\u3002</p> <p><code>kube-scheduler</code> \u91cd\u65b0\u914d\u7f6e\u540e\u53ef\u4ee5\u67e5\u770b\u65e5\u5fd7\u6765\u9a8c\u8bc1\u662f\u5426\u91cd\u542f\u6210\u529f\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e00\u5b9a\u9700\u8981\u5c06 </p> <p><code>/etc/kubernetes/scheduler-extender.yaml</code></p> <p>\u548c </p> <p><code>/etc/kubernetes/scheduler-extender-policy.yaml</code></p> <p>\u4e24\u4e2a\u6587\u4ef6\u6302\u8f7d\u5230 Pod \u4e2d\u53bb\uff1a</p> <p><code>$ kubectl logs -f kube-scheduler-ydzs-master -n kube-system I0102 15:17:824657       1 serving.go:319] Generated self-signed cert in-memory I0102 15:17:472276       1 server.go:143] Version: v2 I0102 15:17:472674       1 defaults.go:91] TaintNodesByCondition is enabled, PodToleratesNodeTaints predicate is mandatory W0102 15:17:479704       1 authorization.go:47] Authorization is disabled W0102 15:17:479733       1 authentication.go:79] Authentication is disabled I0102 15:17:479777       1 deprecated_insecure_serving.go:51] Serving healthz insecurely on [::]:10251 I0102 15:17:480559       1 secure_serving.go:123] Serving securely on 11:10259 I0102 15:17:682180       1 leaderelection.go:241] attempting to acquire leader lease  kube-system/kube-scheduler... I0102 15:17:500505       1 leaderelection.go:251] successfully acquired lease kube-system/kube-scheduler</code></p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u521b\u5efa\u5e76\u914d\u7f6e\u4e86\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u8c03\u5ea6\u6269\u5c55\u7a0b\u5e8f\uff0c\u73b0\u5728\u6211\u4eec\u6765\u8fd0\u884c\u4e00\u4e2a Deployment \u67e5\u770b\u5176\u5de5\u4f5c\u539f\u7406\uff0c\u6211\u4eec\u51c6\u5907\u4e00\u4e2a\u5305\u542b20\u4e2a\u526f\u672c\u7684\u90e8\u7f72 Yaml\uff1a(test-scheduler.yaml)</p> <p><code>apiVersion: apps/v1 kind: Deployment metadata:   name: pause spec:   replicas: 20   selector:     matchLabels:       app: pause   template:     metadata:       labels:         app: pause     spec:       containers:       - name: pause         image: gcr.azk8s.cn/google_containers/pause:1</code></p> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <p><code>$ kuectl apply -f test-scheduler.yaml deployment.apps/pause created</code></p> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53bb\u67e5\u770b\u4e0b\u6211\u4eec\u7f16\u5199\u7684\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u65e5\u5fd7\uff1a</p> <p><code>$ ./app ...... 2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is unlucky to fit on node ydzs-node1 2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is lucky to get score 7 2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is lucky to get score 9 2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is unlucky to fit on node ydzs-node3 2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is unlucky to fit on node ydzs-node4 2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to fit on node ydzs-node1 2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to fit on node ydzs-node2 2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to get score 4 2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to get score 8 ......</code></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pod \u8c03\u5ea6\u7684\u8fc7\u7a0b\uff0c\u53e6\u5916\u9ed8\u8ba4\u8c03\u5ea6\u7a0b\u5e8f\u4f1a\u5b9a\u671f\u91cd\u8bd5\u5931\u8d25\u7684 Pod\uff0c\u56e0\u6b64\u5b83\u4eec\u5c06\u4e00\u6b21\u53c8\u4e00\u6b21\u5730\u91cd\u65b0\u4f20\u9012\u5230\u6211\u4eec\u7684\u8c03\u5ea6\u6269\u5c55\u7a0b\u5e8f\u4e0a\uff0c\u6211\u4eec\u7684\u903b\u8f91\u662f\u68c0\u67e5\u968f\u673a\u6570\u662f\u5426\u4e3a\u5076\u6570\uff0c\u6240\u4ee5\u6700\u7ec8\u6240\u6709 Pod \u90fd\u5c06\u5904\u4e8e\u8fd0\u884c\u72b6\u6001\u3002</p> <p>\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u53ef\u80fd\u662f\u5728\u4e00\u4e9b\u60c5\u51b5\u4e0b\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u9700\u6c42\uff0c\u4f46\u662f\u4ed6\u4ecd\u7136\u6709\u4e00\u4e9b\u9650\u5236\u548c\u7f3a\u70b9\uff1a</p> <ul> <li>\u901a\u4fe1\u6210\u672c\uff1a\u6570\u636e\u5728\u9ed8\u8ba4\u8c03\u5ea6\u7a0b\u5e8f\u548c\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u4e4b\u95f4\u4ee5 <code>http\uff08s\uff09</code>\u4f20\u8f93\uff0c\u5728\u6267\u884c\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u7684\u65f6\u5019\u6709\u4e00\u5b9a\u6210\u672c</li> <li>\u6709\u9650\u7684\u6269\u5c55\u70b9\uff1a\u6269\u5c55\u7a0b\u5e8f\u53ea\u80fd\u5728\u67d0\u4e9b\u9636\u6bb5\u7684\u672b\u5c3e\u53c2\u4e0e\uff0c\u4f8b\u5982<code>\u201c Filter\u201d</code>\u548c<code>\u201c Prioritize\u201d</code>\uff0c\u5b83\u4eec\u4e0d\u80fd\u5728\u4efb\u4f55\u9636\u6bb5\u7684\u5f00\u59cb\u6216\u4e2d\u95f4\u88ab\u8c03\u7528</li> <li>\u51cf\u6cd5\u4f18\u4e8e\u52a0\u6cd5\uff1a\u4e0e\u9ed8\u8ba4\u8c03\u5ea6\u7a0b\u5e8f\u4f20\u9012\u7684\u8282\u70b9\u5019\u9009\u5217\u8868\u76f8\u6bd4\uff0c\u6211\u4eec\u53ef\u80fd\u6709\u4e00\u4e9b\u9700\u6c42\u9700\u8981\u6dfb\u52a0\u65b0\u7684\u5019\u9009\u8282\u70b9\u5217\u8868\uff0c\u4f46\u8fd9\u662f\u6bd4\u8f83\u5192\u9669\u7684\u64cd\u4f5c\uff0c\u56e0\u4e3a\u4e0d\u80fd\u4fdd\u8bc1\u65b0\u8282\u70b9\u53ef\u4ee5\u901a\u8fc7\u5176\u4ed6\u8981\u6c42\uff0c\u6240\u4ee5\uff0c\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u6700\u597d\u6267\u884c<code>\u201c\u51cf\u6cd5\u201d</code>\uff08\u8fdb\u4e00\u6b65\u8fc7\u6ee4\uff09\uff0c\u800c\u4e0d\u662f<code>\u201c\u52a0\u6cd5\u201d</code>\uff08\u6dfb\u52a0\u8282\u70b9\uff09</li> <li>\u7f13\u5b58\u5171\u4eab\uff1a\u4e0a\u9762\u53ea\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u6d4b\u8bd5\u793a\u4f8b\uff0c\u4f46\u5728\u771f\u5b9e\u7684\u9879\u76ee\u4e2d\uff0c\u6211\u4eec\u662f\u9700\u8981\u901a\u8fc7\u67e5\u770b\u6574\u4e2a\u96c6\u7fa4\u7684\u72b6\u6001\u6765\u505a\u51fa\u8c03\u5ea6\u51b3\u7b56\u7684\uff0c\u9ed8\u8ba4\u8c03\u5ea6\u7a0b\u5e8f\u53ef\u4ee5\u5f88\u597d\u5730\u8c03\u5ea6\u51b3\u7b56\uff0c\u4f46\u662f\u65e0\u6cd5\u5171\u4eab\u5176\u7f13\u5b58\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u5fc5\u987b\u6784\u5efa\u548c\u7ef4\u62a4\u81ea\u5df1\u7684\u7f13\u5b58</li> </ul> <p>\u7531\u4e8e\u8fd9\u4e9b\u5c40\u9650\u6027\uff0cKubernetes \u8c03\u5ea6\u5c0f\u7ec4\u5c31\u63d0\u51fa\u4e86\u4e0a\u9762\u7b2c\u56db\u79cd\u65b9\u6cd5\u6765\u8fdb\u884c\u66f4\u597d\u7684\u6269\u5c55\uff0c\u4e5f\u5c31\u662f</p> <p><code>\u8c03\u5ea6\u6846\u67b6\uff08Scheduler Framework\uff09</code></p> <p>\uff0c\u5b83\u57fa\u672c\u4e0a\u53ef\u4ee5\u89e3\u51b3\u6211\u4eec\u9047\u5230\u7684\u6240\u6709\u96be\u9898\uff0c\u73b0\u5728\u4e5f\u5df2\u7ecf\u6210\u5b98\u65b9\u63a8\u8350\u7684\u6269\u5c55\u65b9\u5f0f\uff0c\u6240\u4ee5\u8fd9\u5c06\u662f\u4ee5\u540e\u6269\u5c55\u8c03\u5ea6\u5668\u7684\u6700\u4e3b\u6d41\u7684\u65b9\u5f0f\u3002 </p>"},{"location":"kubernetes_scheduler/overview/#_4","title":"\u8c03\u5ea6\u6846\u67b6","text":"<p>\u8c03\u5ea6\u6846\u67b6\u5b9a\u4e49\u4e86\u4e00\u7ec4\u6269\u5c55\u70b9\uff0c\u7528\u6237\u53ef\u4ee5\u5b9e\u73b0\u6269\u5c55\u70b9\u5b9a\u4e49\u7684\u63a5\u53e3\u6765\u5b9a\u4e49\u81ea\u5df1\u7684\u8c03\u5ea6\u903b\u8f91\uff08\u6211\u4eec\u79f0\u4e4b\u4e3a<code>\u6269\u5c55</code>\uff09\uff0c\u5e76\u5c06\u6269\u5c55\u6ce8\u518c\u5230\u6269\u5c55\u70b9\u4e0a\uff0c\u8c03\u5ea6\u6846\u67b6\u5728\u6267\u884c\u8c03\u5ea6\u5de5\u4f5c\u6d41\u65f6\uff0c\u9047\u5230\u5bf9\u5e94\u7684\u6269\u5c55\u70b9\u65f6\uff0c\u5c06\u8c03\u7528\u7528\u6237\u6ce8\u518c\u7684\u6269\u5c55\u3002\u8c03\u5ea6\u6846\u67b6\u5728\u9884\u7559\u6269\u5c55\u70b9\u65f6\uff0c\u90fd\u662f\u6709\u7279\u5b9a\u7684\u76ee\u7684\uff0c\u6709\u4e9b\u6269\u5c55\u70b9\u4e0a\u7684\u6269\u5c55\u53ef\u4ee5\u6539\u53d8\u8c03\u5ea6\u7a0b\u5e8f\u7684\u51b3\u7b56\u65b9\u6cd5\uff0c\u6709\u4e9b\u6269\u5c55\u70b9\u4e0a\u7684\u6269\u5c55\u53ea\u662f\u53d1\u9001\u4e00\u4e2a\u901a\u77e5\u3002</p> <p>\u6211\u4eec\u77e5\u9053\u6bcf\u5f53\u8c03\u5ea6\u4e00\u4e2a Pod \u65f6\uff0c\u90fd\u4f1a\u6309\u7167\u4e24\u4e2a\u8fc7\u7a0b\u6765\u6267\u884c\uff1a\u8c03\u5ea6\u8fc7\u7a0b\u548c\u7ed1\u5b9a\u8fc7\u7a0b\u3002</p> <p>\u8c03\u5ea6\u8fc7\u7a0b\u4e3a Pod \u9009\u62e9\u4e00\u4e2a\u5408\u9002\u7684\u8282\u70b9\uff0c\u7ed1\u5b9a\u8fc7\u7a0b\u5219\u5c06\u8c03\u5ea6\u8fc7\u7a0b\u7684\u51b3\u7b56\u5e94\u7528\u5230\u96c6\u7fa4\u4e2d\uff08\u4e5f\u5c31\u662f\u5728\u88ab\u9009\u5b9a\u7684\u8282\u70b9\u4e0a\u8fd0\u884c Pod\uff09\uff0c\u5c06\u8c03\u5ea6\u8fc7\u7a0b\u548c\u7ed1\u5b9a\u8fc7\u7a0b\u5408\u5728\u4e00\u8d77\uff0c\u79f0\u4e4b\u4e3a<code>\u8c03\u5ea6\u4e0a\u4e0b\u6587\uff08scheduling context\uff09</code>\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\u8c03\u5ea6\u8fc7\u7a0b\u662f<code>\u540c\u6b65</code>\u8fd0\u884c\u7684\uff08\u540c\u4e00\u65f6\u95f4\u70b9\u53ea\u4e3a\u4e00\u4e2a Pod \u8fdb\u884c\u8c03\u5ea6\uff09\uff0c\u7ed1\u5b9a\u8fc7\u7a0b\u53ef\u5f02\u6b65\u8fd0\u884c\uff08\u540c\u4e00\u65f6\u95f4\u70b9\u53ef\u5e76\u53d1\u4e3a\u591a\u4e2a Pod \u6267\u884c\u7ed1\u5b9a\uff09\u3002</p> <p>\u8c03\u5ea6\u8fc7\u7a0b\u548c\u7ed1\u5b9a\u8fc7\u7a0b\u9047\u5230\u5982\u4e0b\u60c5\u51b5\u65f6\u4f1a\u4e2d\u9014\u9000\u51fa\uff1a</p> <ul> <li>\u8c03\u5ea6\u7a0b\u5e8f\u8ba4\u4e3a\u5f53\u524d\u6ca1\u6709\u8be5 Pod \u7684\u53ef\u9009\u8282\u70b9</li> <li>\u5185\u90e8\u9519\u8bef</li> </ul> <p>\u8fd9\u4e2a\u65f6\u5019\uff0c\u8be5 Pod \u5c06\u88ab\u653e\u56de\u5230 <code>\u5f85\u8c03\u5ea6\u961f\u5217</code>\uff0c\u5e76\u7b49\u5f85\u4e0b\u6b21\u91cd\u8bd5\u3002 </p>"},{"location":"kubernetes_scheduler/overview/#extension_points","title":"\u6269\u5c55\u70b9\uff08Extension Points\uff09","text":"<p>\u4e0b\u56fe\u5c55\u793a\u4e86\u8c03\u5ea6\u6846\u67b6\u4e2d\u7684\u8c03\u5ea6\u4e0a\u4e0b\u6587\u53ca\u5176\u4e2d\u7684\u6269\u5c55\u70b9\uff0c\u4e00\u4e2a\u6269\u5c55\u53ef\u4ee5\u6ce8\u518c\u591a\u4e2a\u6269\u5c55\u70b9\uff0c\u4ee5\u4fbf\u53ef\u4ee5\u6267\u884c\u66f4\u590d\u6742\u7684\u6709\u72b6\u6001\u7684\u4efb\u52a1\u3002</p> <p></p> <ol> <li><code>QueueSort</code> \u6269\u5c55\u7528\u4e8e\u5bf9 Pod \u7684\u5f85\u8c03\u5ea6\u961f\u5217\u8fdb\u884c\u6392\u5e8f\uff0c\u4ee5\u51b3\u5b9a\u5148\u8c03\u5ea6\u54ea\u4e2a Pod\uff0c<code>QueueSort</code> \u6269\u5c55\u672c\u8d28\u4e0a\u53ea\u9700\u8981\u5b9e\u73b0\u4e00\u4e2a\u65b9\u6cd5 <code>Less(Pod1, Pod2)</code> \u7528\u4e8e\u6bd4\u8f83\u4e24\u4e2a Pod \u8c01\u66f4\u4f18\u5148\u83b7\u5f97\u8c03\u5ea6\u5373\u53ef\uff0c\u540c\u4e00\u65f6\u95f4\u70b9\u53ea\u80fd\u6709\u4e00\u4e2a <code>QueueSort</code> \u63d2\u4ef6\u751f\u6548\u3002</li> <li><code>Pre-filter</code> \u6269\u5c55\u7528\u4e8e\u5bf9 Pod \u7684\u4fe1\u606f\u8fdb\u884c\u9884\u5904\u7406\uff0c\u6216\u8005\u68c0\u67e5\u4e00\u4e9b\u96c6\u7fa4\u6216 Pod \u5fc5\u987b\u6ee1\u8db3\u7684\u524d\u63d0\u6761\u4ef6\uff0c\u5982\u679c <code>pre-filter</code> \u8fd4\u56de\u4e86 error\uff0c\u5219\u8c03\u5ea6\u8fc7\u7a0b\u7ec8\u6b62\u3002</li> <li><code>Filter</code> \u6269\u5c55\u7528\u4e8e\u6392\u9664\u90a3\u4e9b\u4e0d\u80fd\u8fd0\u884c\u8be5 Pod \u7684\u8282\u70b9\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8282\u70b9\uff0c\u8c03\u5ea6\u5668\u5c06\u6309\u987a\u5e8f\u6267\u884c <code>filter</code> \u6269\u5c55\uff1b\u5982\u679c\u4efb\u4f55\u4e00\u4e2a <code>filter</code> \u5c06\u8282\u70b9\u6807\u8bb0\u4e3a\u4e0d\u53ef\u9009\uff0c\u5219\u4f59\u4e0b\u7684 <code>filter</code> \u6269\u5c55\u5c06\u4e0d\u4f1a\u88ab\u6267\u884c\u3002\u8c03\u5ea6\u5668\u53ef\u4ee5\u540c\u65f6\u5bf9\u591a\u4e2a\u8282\u70b9\u6267\u884c <code>filter</code> \u6269\u5c55\u3002</li> <li><code>Post-filter</code> \u662f\u4e00\u4e2a\u901a\u77e5\u7c7b\u578b\u7684\u6269\u5c55\u70b9\uff0c\u8c03\u7528\u8be5\u6269\u5c55\u7684\u53c2\u6570\u662f <code>filter</code> \u9636\u6bb5\u7ed3\u675f\u540e\u88ab\u7b5b\u9009\u4e3a<code>\u53ef\u9009\u8282\u70b9</code>\u7684\u8282\u70b9\u5217\u8868\uff0c\u53ef\u4ee5\u5728\u6269\u5c55\u4e2d\u4f7f\u7528\u8fd9\u4e9b\u4fe1\u606f\u66f4\u65b0\u5185\u90e8\u72b6\u6001\uff0c\u6216\u8005\u4ea7\u751f\u65e5\u5fd7\u6216 metrics \u4fe1\u606f\u3002</li> <li><code>Scoring</code> \u6269\u5c55\u7528\u4e8e\u4e3a\u6240\u6709\u53ef\u9009\u8282\u70b9\u8fdb\u884c\u6253\u5206\uff0c\u8c03\u5ea6\u5668\u5c06\u9488\u5bf9\u6bcf\u4e00\u4e2a\u8282\u70b9\u8c03\u7528 <code>Soring</code> \u6269\u5c55\uff0c\u8bc4\u5206\u7ed3\u679c\u662f\u4e00\u4e2a\u8303\u56f4\u5185\u7684\u6574\u6570\u3002\u5728 <code>normalize scoring</code> \u9636\u6bb5\uff0c\u8c03\u5ea6\u5668\u5c06\u4f1a\u628a\u6bcf\u4e2a <code>scoring</code> \u6269\u5c55\u5bf9\u5177\u4f53\u67d0\u4e2a\u8282\u70b9\u7684\u8bc4\u5206\u7ed3\u679c\u548c\u8be5\u6269\u5c55\u7684\u6743\u91cd\u5408\u5e76\u8d77\u6765\uff0c\u4f5c\u4e3a\u6700\u7ec8\u8bc4\u5206\u7ed3\u679c\u3002</li> <li><code>Normalize scoring</code> \u6269\u5c55\u5728\u8c03\u5ea6\u5668\u5bf9\u8282\u70b9\u8fdb\u884c\u6700\u7ec8\u6392\u5e8f\u4e4b\u524d\u4fee\u6539\u6bcf\u4e2a\u8282\u70b9\u7684\u8bc4\u5206\u7ed3\u679c\uff0c\u6ce8\u518c\u5230\u8be5\u6269\u5c55\u70b9\u7684\u6269\u5c55\u5728\u88ab\u8c03\u7528\u65f6\uff0c\u5c06\u83b7\u5f97\u540c\u4e00\u4e2a\u63d2\u4ef6\u4e2d\u7684 <code>scoring</code> \u6269\u5c55\u7684\u8bc4\u5206\u7ed3\u679c\u4f5c\u4e3a\u53c2\u6570\uff0c\u8c03\u5ea6\u6846\u67b6\u6bcf\u6267\u884c\u4e00\u6b21\u8c03\u5ea6\uff0c\u90fd\u5c06\u8c03\u7528\u6240\u6709\u63d2\u4ef6\u4e2d\u7684\u4e00\u4e2a <code>normalize scoring</code> \u6269\u5c55\u4e00\u6b21\u3002</li> <li><code>Reserve</code> \u662f\u4e00\u4e2a\u901a\u77e5\u6027\u8d28\u7684\u6269\u5c55\u70b9\uff0c\u6709\u72b6\u6001\u7684\u63d2\u4ef6\u53ef\u4ee5\u4f7f\u7528\u8be5\u6269\u5c55\u70b9\u6765\u83b7\u5f97\u8282\u70b9\u4e0a\u4e3a Pod \u9884\u7559\u7684\u8d44\u6e90\uff0c\u8be5\u4e8b\u4ef6\u53d1\u751f\u5728\u8c03\u5ea6\u5668\u5c06 Pod \u7ed1\u5b9a\u5230\u8282\u70b9\u4e4b\u524d\uff0c\u76ee\u7684\u662f\u907f\u514d\u8c03\u5ea6\u5668\u5728\u7b49\u5f85 Pod \u4e0e\u8282\u70b9\u7ed1\u5b9a\u7684\u8fc7\u7a0b\u4e2d\u8c03\u5ea6\u65b0\u7684 Pod \u5230\u8282\u70b9\u4e0a\u65f6\uff0c\u53d1\u751f\u5b9e\u9645\u4f7f\u7528\u8d44\u6e90\u8d85\u51fa\u53ef\u7528\u8d44\u6e90\u7684\u60c5\u51b5\u3002\uff08\u56e0\u4e3a\u7ed1\u5b9a Pod \u5230\u8282\u70b9\u4e0a\u662f\u5f02\u6b65\u53d1\u751f\u7684\uff09\u3002\u8fd9\u662f\u8c03\u5ea6\u8fc7\u7a0b\u7684\u6700\u540e\u4e00\u4e2a\u6b65\u9aa4\uff0cPod \u8fdb\u5165 reserved \u72b6\u6001\u4ee5\u540e\uff0c\u8981\u4e48\u5728\u7ed1\u5b9a\u5931\u8d25\u65f6\u89e6\u53d1 Unreserve \u6269\u5c55\uff0c\u8981\u4e48\u5728\u7ed1\u5b9a\u6210\u529f\u65f6\uff0c\u7531 Post-bind \u6269\u5c55\u7ed3\u675f\u7ed1\u5b9a\u8fc7\u7a0b\u3002</li> <li> <p><code>Permit</code> \u6269\u5c55\u7528\u4e8e\u963b\u6b62\u6216\u8005\u5ef6\u8fdf Pod \u4e0e\u8282\u70b9\u7684\u7ed1\u5b9a\u3002Permit \u6269\u5c55\u53ef\u4ee5\u505a\u4e0b\u9762\u4e09\u4ef6\u4e8b\u4e2d\u7684\u4e00\u9879\uff1a</p> <ul> <li>approve\uff08\u6279\u51c6\uff09\uff1a\u5f53\u6240\u6709\u7684 permit \u6269\u5c55\u90fd approve \u4e86 Pod \u4e0e\u8282\u70b9\u7684\u7ed1\u5b9a\uff0c\u8c03\u5ea6\u5668\u5c06\u7ee7\u7eed\u6267\u884c\u7ed1\u5b9a\u8fc7\u7a0b</li> <li>deny\uff08\u62d2\u7edd\uff09\uff1a\u5982\u679c\u4efb\u4f55\u4e00\u4e2a permit \u6269\u5c55 deny \u4e86 Pod \u4e0e\u8282\u70b9\u7684\u7ed1\u5b9a\uff0cPod \u5c06\u88ab\u653e\u56de\u5230\u5f85\u8c03\u5ea6\u961f\u5217\uff0c\u6b64\u65f6\u5c06\u89e6\u53d1 <code>Unreserve</code> \u6269\u5c55</li> <li>wait\uff08\u7b49\u5f85\uff09\uff1a\u5982\u679c\u4e00\u4e2a permit \u6269\u5c55\u8fd4\u56de\u4e86 wait\uff0c\u5219 Pod \u5c06\u4fdd\u6301\u5728 permit \u9636\u6bb5\uff0c\u76f4\u5230\u88ab\u5176\u4ed6\u6269\u5c55 approve\uff0c\u5982\u679c\u8d85\u65f6\u4e8b\u4ef6\u53d1\u751f\uff0cwait \u72b6\u6001\u53d8\u6210 deny\uff0cPod \u5c06\u88ab\u653e\u56de\u5230\u5f85\u8c03\u5ea6\u961f\u5217\uff0c\u6b64\u65f6\u5c06\u89e6\u53d1 Unreserve \u6269\u5c55</li> <li> <p><code>Pre-bind</code> \u6269\u5c55\u7528\u4e8e\u5728 Pod \u7ed1\u5b9a\u4e4b\u524d\u6267\u884c\u67d0\u4e9b\u903b\u8f91\u3002\u4f8b\u5982\uff0cpre-bind \u6269\u5c55\u53ef\u4ee5\u5c06\u4e00\u4e2a\u57fa\u4e8e\u7f51\u7edc\u7684\u6570\u636e\u5377\u6302\u8f7d\u5230\u8282\u70b9\u4e0a\uff0c\u4ee5\u4fbf Pod \u53ef\u4ee5\u4f7f\u7528\u3002\u5982\u679c\u4efb\u4f55\u4e00\u4e2a <code>pre-bind</code> \u6269\u5c55\u8fd4\u56de\u9519\u8bef\uff0cPod \u5c06\u88ab\u653e\u56de\u5230\u5f85\u8c03\u5ea6\u961f\u5217\uff0c\u6b64\u65f6\u5c06\u89e6\u53d1 Unreserve \u6269\u5c55\u3002</p> </li> </ul> </li> <li> <p><code>Bind</code> \u6269\u5c55\u7528\u4e8e\u5c06 Pod \u7ed1\u5b9a\u5230\u8282\u70b9\u4e0a\uff1a</p> <ul> <li>\u53ea\u6709\u6240\u6709\u7684 pre-bind \u6269\u5c55\u90fd\u6210\u529f\u6267\u884c\u4e86\uff0cbind \u6269\u5c55\u624d\u4f1a\u6267\u884c</li> <li>\u8c03\u5ea6\u6846\u67b6\u6309\u7167 bind \u6269\u5c55\u6ce8\u518c\u7684\u987a\u5e8f\u9010\u4e2a\u8c03\u7528 bind \u6269\u5c55</li> <li>\u5177\u4f53\u67d0\u4e2a bind \u6269\u5c55\u53ef\u4ee5\u9009\u62e9\u5904\u7406\u6216\u8005\u4e0d\u5904\u7406\u8be5 Pod</li> <li>\u5982\u679c\u67d0\u4e2a bind \u6269\u5c55\u5904\u7406\u4e86\u8be5 Pod \u4e0e\u8282\u70b9\u7684\u7ed1\u5b9a\uff0c\u4f59\u4e0b\u7684 bind \u6269\u5c55\u5c06\u88ab\u5ffd\u7565</li> <li> <p><code>Post-bind</code> \u662f\u4e00\u4e2a\u901a\u77e5\u6027\u8d28\u7684\u6269\u5c55\uff1a</p> </li> <li> <p>Post-bind \u6269\u5c55\u5728 Pod \u6210\u529f\u7ed1\u5b9a\u5230\u8282\u70b9\u4e0a\u4e4b\u540e\u88ab\u52a8\u8c03\u7528</p> </li> <li>Post-bind \u6269\u5c55\u662f\u7ed1\u5b9a\u8fc7\u7a0b\u7684\u6700\u540e\u4e00\u4e2a\u6b65\u9aa4\uff0c\u53ef\u4ee5\u7528\u6765\u6267\u884c\u8d44\u6e90\u6e05\u7406\u7684\u52a8\u4f5c</li> <li> <p><code>Unreserve</code> \u662f\u4e00\u4e2a\u901a\u77e5\u6027\u8d28\u7684\u6269\u5c55\uff0c\u5982\u679c\u4e3a Pod \u9884\u7559\u4e86\u8d44\u6e90\uff0cPod \u53c8\u5728\u88ab\u7ed1\u5b9a\u8fc7\u7a0b\u4e2d\u88ab\u62d2\u7edd\u7ed1\u5b9a\uff0c\u5219 unreserve \u6269\u5c55\u5c06\u88ab\u8c03\u7528\u3002Unreserve \u6269\u5c55\u5e94\u8be5\u91ca\u653e\u5df2\u7ecf\u4e3a Pod \u9884\u7559\u7684\u8282\u70b9\u4e0a\u7684\u8ba1\u7b97\u8d44\u6e90\u3002\u5728\u4e00\u4e2a\u63d2\u4ef6\u4e2d\uff0creserve \u6269\u5c55\u548c unreserve \u6269\u5c55\u5e94\u8be5\u6210\u5bf9\u51fa\u73b0\u3002</p> </li> </ul> </li> </ol> <p>\u5982\u679c\u6211\u4eec\u8981\u5b9e\u73b0\u81ea\u5df1\u7684\u63d2\u4ef6\uff0c\u5fc5\u987b\u5411\u8c03\u5ea6\u6846\u67b6\u6ce8\u518c\u63d2\u4ef6\u5e76\u5b8c\u6210\u914d\u7f6e\uff0c\u53e6\u5916\u8fd8\u5fc5\u987b\u5b9e\u73b0\u6269\u5c55\u70b9\u63a5\u53e3\uff0c\u5bf9\u5e94\u7684\u6269\u5c55\u70b9\u63a5\u53e3\u6211\u4eec\u53ef\u4ee5\u5728\u6e90\u7801 </p> <p><code>pkg/scheduler/framework/v1alpha1/interface.go</code></p> <p>\u6587\u4ef6\u4e2d\u627e\u5230\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p>``` // Plugin is the parent type for all the scheduling framework plugins. type Plugin interface {     Name() string }</p> <p>type QueueSortPlugin interface {     Plugin     Less(*PodInfo, *PodInfo) bool }</p> <p>// PreFilterPlugin is an interface that must be implemented by \"prefilter\" plugins. // These plugins are called at the beginning of the scheduling cycle. type PreFilterPlugin interface {     Plugin     PreFilter(pc *PluginContext, p *vPod) *Status }</p> <p>// FilterPlugin is an interface for Filter plugins. These plugins are called at the // filter extension point for filtering out hosts that cannot run a pod. // This concept used to be called 'predicate' in the original scheduler. // These plugins should return \"Success\", \"Unschedulable\" or \"Error\" in Status.code. // However, the scheduler accepts other valid codes as well. // Anything other than \"Success\" will lead to exclusion of the given host from // running the pod. type FilterPlugin interface {     Plugin     Filter(pc *PluginContext, pod *vPod, nodeName string) *Status }</p> <p>// PostFilterPlugin is an interface for Post-filter plugin. Post-filter is an // informational extension point. Plugins will be called with a list of nodes // that passed the filtering phase. A plugin may use this data to update internal // state or to generate logs/metrics. type PostFilterPlugin interface {     Plugin     PostFilter(pc *PluginContext, pod *vPod, nodes []*vNode, filteredNodesStatuses NodeToStatusMap) *Status }</p> <p>// ScorePlugin is an interface that must be implemented by \"score\" plugins to rank // nodes that passed the filtering phase. type ScorePlugin interface {     Plugin     Score(pc *PluginContext, p *vPod, nodeName string) (int, *Status) }</p> <p>// ScoreWithNormalizePlugin is an interface that must be implemented by \"score\" // plugins that also need to normalize the node scoring results produced by the same // plugin's \"Score\" method. type ScoreWithNormalizePlugin interface {     ScorePlugin     NormalizeScore(pc *PluginContext, p *vPod, scores NodeScoreList) *Status }</p> <p>// ReservePlugin is an interface for Reserve plugins. These plugins are called // at the reservation point. These are meant to update the state of the plugin. // This concept used to be called 'assume' in the original scheduler. // These plugins should return only Success or Error in Status.code. However, // the scheduler accepts other valid codes as well. Anything other than Success // will lead to rejection of the pod. type ReservePlugin interface {     Plugin     Reserve(pc *PluginContext, p *vPod, nodeName string) *Status }</p> <p>// PreBindPlugin is an interface that must be implemented by \"prebind\" plugins. // These plugins are called before a pod being scheduled. type PreBindPlugin interface {     Plugin     PreBind(pc *PluginContext, p *vPod, nodeName string) *Status }</p> <p>// PostBindPlugin is an interface that must be implemented by \"postbind\" plugins. // These plugins are called after a pod is successfully bound to a node. type PostBindPlugin interface {     Plugin     PostBind(pc *PluginContext, p *vPod, nodeName string) }</p> <p>// UnreservePlugin is an interface for Unreserve plugins. This is an informational // extension point. If a pod was reserved and then rejected in a later phase, then // un-reserve plugins will be notified. Un-reserve plugins should clean up state // associated with the reserved Pod. type UnreservePlugin interface {     Plugin     Unreserve(pc *PluginContext, p *vPod, nodeName string) }</p> <p>// PermitPlugin is an interface that must be implemented by \"permit\" plugins. // These plugins are called before a pod is bound to a node. type PermitPlugin interface {     Plugin     Permit(pc *PluginContext, p *vPod, nodeName string) (*Status, time.Duration) }</p> <p>// BindPlugin is an interface that must be implemented by \"bind\" plugins. Bind // plugins are used to bind a pod to a Node. type BindPlugin interface {     Plugin     Bind(pc *PluginContext, p *vPod, nodeName string) *Status } <pre><code>&gt; \u5bf9\u4e8e\u8c03\u5ea6\u6846\u67b6\u63d2\u4ef6\u7684\u542f\u7528\u6216\u8005\u7981\u7528\uff0c\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684 KubeSchedulerConfiguration \u8d44\u6e90\u5bf9\u8c61\u6765\u8fdb\u884c\u914d\u7f6e\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\u7684\u914d\u7f6e\u542f\u7528\u4e86\u4e00\u4e2a\u5b9e\u73b0\u4e86 `reserve` \u548c `preBind` \u6269\u5c55\u70b9\u7684\u63d2\u4ef6\uff0c\u5e76\u4e14\u7981\u7528\u4e86\u53e6\u5916\u4e00\u4e2a\u63d2\u4ef6\uff0c\u540c\u65f6\u4e3a\u63d2\u4ef6 foo \u63d0\u4f9b\u4e86\u4e00\u4e9b\u914d\u7f6e\u4fe1\u606f\uff1a\n</code></pre> apiVersion: kubescheduler.config.k8s.io/v1alpha1 kind: KubeSchedulerConfiguration</p> <p>...</p> <p>plugins:   reserve:     enabled:     - name: foo     - name: bar     disabled:     - name: baz   preBind:     enabled:     - name: foo     disabled:     - name: baz</p> <p>pluginConfig: - name: foo   args: &gt;     foo\u63d2\u4ef6\u53ef\u4ee5\u89e3\u6790\u7684\u4efb\u610f\u5185\u5bb9 <pre><code>&gt; \u6269\u5c55\u7684\u8c03\u7528\u987a\u5e8f\u5982\u4e0b\uff1a\n\n*   \u5982\u679c\u67d0\u4e2a\u6269\u5c55\u70b9\u6ca1\u6709\u914d\u7f6e\u5bf9\u5e94\u7684\u6269\u5c55\uff0c\u8c03\u5ea6\u6846\u67b6\u5c06\u4f7f\u7528\u9ed8\u8ba4\u63d2\u4ef6\u4e2d\u7684\u6269\u5c55\n*   \u5982\u679c\u4e3a\u67d0\u4e2a\u6269\u5c55\u70b9\u914d\u7f6e\u4e14\u6fc0\u6d3b\u4e86\u6269\u5c55\uff0c\u5219\u8c03\u5ea6\u6846\u67b6\u5c06\u5148\u8c03\u7528\u9ed8\u8ba4\u63d2\u4ef6\u7684\u6269\u5c55\uff0c\u518d\u8c03\u7528\u914d\u7f6e\u4e2d\u7684\u6269\u5c55\n*   \u9ed8\u8ba4\u63d2\u4ef6\u7684\u6269\u5c55\u59cb\u7ec8\u88ab\u6700\u5148\u8c03\u7528\uff0c\u7136\u540e\u6309\u7167 \n\n    ```\n    KubeSchedulerConfiguration\n    ```\n\n     \u4e2d\u6269\u5c55\u7684\u6fc0\u6d3b `enabled` \u987a\u5e8f\u9010\u4e2a\u8c03\u7528\u6269\u5c55\u70b9\u7684\u6269\u5c55\n*   \u53ef\u4ee5\u5148\u7981\u7528\u9ed8\u8ba4\u63d2\u4ef6\u7684\u6269\u5c55\uff0c\u7136\u540e\u5728 `enabled` \u5217\u8868\u4e2d\u7684\u67d0\u4e2a\u4f4d\u7f6e\u6fc0\u6d3b\u9ed8\u8ba4\u63d2\u4ef6\u7684\u6269\u5c55\uff0c\u8fd9\u79cd\u505a\u6cd5\u53ef\u4ee5\u6539\u53d8\u9ed8\u8ba4\u63d2\u4ef6\u7684\u6269\u5c55\u88ab\u8c03\u7528\u65f6\u7684\u987a\u5e8f\n\n&gt; \u5047\u8bbe\u9ed8\u8ba4\u63d2\u4ef6 foo \u5b9e\u73b0\u4e86 `reserve` \u6269\u5c55\u70b9\uff0c\u6b64\u65f6\u6211\u4eec\u8981\u6dfb\u52a0\u4e00\u4e2a\u63d2\u4ef6 bar\uff0c\u60f3\u8981\u5728 foo \u4e4b\u524d\u88ab\u8c03\u7528\uff0c\u5219\u5e94\u8be5\u5148\u7981\u7528 foo \u518d\u6309\u7167 bar foo \u7684\u987a\u5e8f\u6fc0\u6d3b\u3002\u793a\u4f8b\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a\n</code></pre> apiVersion: kubescheduler.config.k8s.io/v1alpha1 kind: KubeSchedulerConfiguration</p> <p>...</p> <p>plugins:   reserve:     enabled:     - name: bar     - name: foo     disabled:     - name: foo <pre><code>&gt; \u5728\u6e90\u7801\u76ee\u5f55 \n</code></pre> pkg/scheduler/framework/plugins/examples <pre><code> \u4e2d\u6709\u51e0\u4e2a\u793a\u8303\u63d2\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u53c2\u7167\u5176\u5b9e\u73b0\u65b9\u5f0f\u3002\n\n#### \u793a\u4f8b \n\n&gt; \u5176\u5b9e\u8981\u5b9e\u73b0\u4e00\u4e2a\u8c03\u5ea6\u6846\u67b6\u7684\u63d2\u4ef6\uff0c\u5e76\u4e0d\u96be\uff0c\u6211\u4eec\u53ea\u8981\u5b9e\u73b0\u5bf9\u5e94\u7684\u6269\u5c55\u70b9\uff0c\u7136\u540e\u5c06\u63d2\u4ef6\u6ce8\u518c\u5230\u8c03\u5ea6\u5668\u4e2d\u5373\u53ef\uff0c\u4e0b\u9762\u662f\u9ed8\u8ba4\u8c03\u5ea6\u5668\u5728\u521d\u59cb\u5316\u7684\u65f6\u5019\u6ce8\u518c\u7684\u63d2\u4ef6\uff1a\n</code></pre> func NewRegistry() Registry {     return Registry{         // FactoryMap:         // New plugins are registered here.         // example:         // {         //  stateful_plugin.Name: stateful.NewStatefulMultipointExample,         //  fooplugin.Name: fooplugin.New,         // }     } } <pre><code>&gt; \u4f46\u662f\u53ef\u4ee5\u770b\u5230\u9ed8\u8ba4\u5e76\u6ca1\u6709\u6ce8\u518c\u4e00\u4e9b\u63d2\u4ef6\uff0c\u6240\u4ee5\u8981\u60f3\u8ba9\u8c03\u5ea6\u5668\u80fd\u591f\u8bc6\u522b\u6211\u4eec\u7684\u63d2\u4ef6\u4ee3\u7801\uff0c\u5c31\u9700\u8981\u81ea\u5df1\u6765\u5b9e\u73b0\u4e00\u4e2a\u8c03\u5ea6\u5668\u4e86\uff0c\u5f53\u7136\u8fd9\u4e2a\u8c03\u5ea6\u5668\u6211\u4eec\u5b8c\u5168\u6ca1\u5fc5\u8981\u5b8c\u5168\u81ea\u5df1\u5b9e\u73b0\uff0c\u76f4\u63a5\u8c03\u7528\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\uff0c\u7136\u540e\u5728\u4e0a\u9762\u7684 `NewRegistry()` \u51fd\u6570\u4e2d\u5c06\u6211\u4eec\u7684\u63d2\u4ef6\u6ce8\u518c\u8fdb\u53bb\u5373\u53ef\u3002\u5728 `kube-scheduler` \u7684\u6e90\u7801\u6587\u4ef6 \n</code></pre> kubernetes/cmd/kube-scheduler/app/server.go <pre><code> \u4e2d\u6709\u4e00\u4e2a `NewSchedulerCommand` \u5165\u53e3\u51fd\u6570\uff0c\u5176\u4e2d\u7684\u53c2\u6570\u662f\u4e00\u4e2a\u7c7b\u578b\u4e3a `Option` \u7684\u5217\u8868\uff0c\u800c\u8fd9\u4e2a `Option` \u6070\u597d\u5c31\u662f\u4e00\u4e2a\u63d2\u4ef6\u914d\u7f6e\u7684\u5b9a\u4e49\uff1a\n</code></pre> // Option configures a framework.Registry. type Option func(framework.Registry) error</p> <p>// NewSchedulerCommand creates a *cobra.Command object with default parameters and registryOptions func NewSchedulerCommand(registryOptions ...Option) *cobra.Command {   ...... } <pre><code>&gt; \u6240\u4ee5\u6211\u4eec\u5b8c\u5168\u5c31\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528\u8fd9\u4e2a\u51fd\u6570\u6765\u4f5c\u4e3a\u6211\u4eec\u7684\u51fd\u6570\u5165\u53e3\uff0c\u5e76\u4e14\u4f20\u5165\u6211\u4eec\u81ea\u5df1\u5b9e\u73b0\u7684\u63d2\u4ef6\u4f5c\u4e3a\u53c2\u6570\u5373\u53ef\uff0c\u800c\u4e14\u8be5\u6587\u4ef6\u4e0b\u9762\u8fd8\u6709\u4e00\u4e2a\u540d\u4e3a `WithPlugin` \u7684\u51fd\u6570\u53ef\u4ee5\u6765\u521b\u5efa\u4e00\u4e2a `Option` \u5b9e\u4f8b\uff1a\n</code></pre> // WithPlugin creates an Option based on plugin name and factory. func WithPlugin(name string, factory framework.PluginFactory) Option {     return func(registry framework.Registry) error {         return registry.Register(name, factory)     } } <pre><code>&gt; \u6240\u4ee5\u6700\u7ec8\u6211\u4eec\u7684\u5165\u53e3\u51fd\u6570\u5982\u4e0b\u6240\u793a\uff1a\n</code></pre> func main() {     rand.Seed(time.Now().UTC().UnixNano())</p> <pre><code>command := app.NewSchedulerCommand(\n    app.WithPlugin(sample.Name, sample.New), \n)\n\nlogs.InitLogs()\ndefer logs.FlushLogs()\n\nif err := command.Execute(); err != nil {\n    _, _ = fmt.Fprintf(os.Stderr, \"%v\\\\n\", err)\n    os.Exit(1)\n}\n</code></pre> <p>} <pre><code>&gt; \u5176\u4e2d \n</code></pre> app.WithPlugin(sample.Name, sample.New) <pre><code> \u5c31\u662f\u6211\u4eec\u63a5\u4e0b\u6765\u8981\u5b9e\u73b0\u7684\u63d2\u4ef6\uff0c\u4ece `WithPlugin` \u51fd\u6570\u7684\u53c2\u6570\u4e5f\u53ef\u4ee5\u770b\u51fa\u6211\u4eec\u8fd9\u91cc\u7684 `sample.New` \u5fc5\u987b\u662f\u4e00\u4e2a \n</code></pre> framework.PluginFactory <pre><code> \u7c7b\u578b\u7684\u503c\uff0c\u800c `PluginFactory` \u7684\u5b9a\u4e49\u5c31\u662f\u4e00\u4e2a\u51fd\u6570\uff1a\n</code></pre> type PluginFactory = func(configuration *runtime.Unknown, f FrameworkHandle) (Plugin, error) <pre><code>&gt; \u6240\u4ee5 `sample.New` \u5b9e\u9645\u4e0a\u5c31\u662f\u4e0a\u9762\u7684\u8fd9\u4e2a\u51fd\u6570\uff0c\u5728\u8fd9\u4e2a\u51fd\u6570\u4e2d\u6211\u4eec\u53ef\u4ee5\u83b7\u53d6\u5230\u63d2\u4ef6\u4e2d\u7684\u4e00\u4e9b\u6570\u636e\u7136\u540e\u8fdb\u884c\u903b\u8f91\u5904\u7406\u5373\u53ef\uff0c\u63d2\u4ef6\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff0c\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u7b80\u5355\u83b7\u53d6\u4e0b\u6570\u636e\u6253\u5370\u65e5\u5fd7\uff0c\u5982\u679c\u4f60\u6709\u5b9e\u9645\u9700\u6c42\u7684\u53ef\u4ee5\u6839\u636e\u83b7\u53d6\u7684\u6570\u636e\u5c31\u884c\u5904\u7406\u5373\u53ef\uff0c\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u5b9e\u73b0\u4e86 `PreFilter`\u3001`Filter`\u3001`PreBind` \u4e09\u4e2a\u6269\u5c55\u70b9\uff0c\u5176\u4ed6\u7684\u53ef\u4ee5\u7528\u540c\u6837\u7684\u65b9\u5f0f\u6765\u6269\u5c55\u5373\u53ef\uff1a\n</code></pre> // \u63d2\u4ef6\u540d\u79f0 const Name = \"sample-plugin\"</p> <p>type Args struct {     FavoriteColor  string <code>json:\"favorite_color,omitempty\"</code>     FavoriteNumber int    <code>json:\"favorite_number,omitempty\"</code>     ThanksTo       string <code>json:\"thanks_to,omitempty\"</code> }</p> <p>type Sample struct {     args   *Args     handle framework.FrameworkHandle }</p> <p>func (s *Sample) Name() string {     return Name }</p> <p>func (s *Sample) PreFilter(pc *framework.PluginContext, pod *vPod) *framework.Status {     klog.V(3).Infof(\"prefilter pod: %v\", pod.Name)     return framework.NewStatus(framework.Success, \"\") }</p> <p>func (s *Sample) Filter(pc *framework.PluginContext, pod *vPod, nodeName string) *framework.Status {     klog.V(3).Infof(\"filter pod: %v, node: %v\", pod.Name, nodeName)     return framework.NewStatus(framework.Success, \"\") }</p> <p>func (s *Sample) PreBind(pc *framework.PluginContext, pod *vPod, nodeName string) *framework.Status {     if nodeInfo, ok := s.handle.NodeInfoSnapshot().NodeInfoMap[nodeName]; !ok {         return framework.NewStatus(framework.Error, fmt.Sprintf(\"prebind get node info error: %+v\", nodeName))     } else {         klog.V(3).Infof(\"prebind node info: %+v\", nodeInfo.Node())         return framework.NewStatus(framework.Success, \"\")     } }</p> <p>//type PluginFactory = func(configuration *runtime.Unknown, f FrameworkHandle) (Plugin, error) func New(configuration *runtime.Unknown, f framework.FrameworkHandle) (framework.Plugin, error) {     args := &amp;Args{}     if err := framework.DecodeInto(configuration, args); err != nil {         return nil, err     }     klog.V(3).Infof(\"get plugin config args: %+v\", args)     return &amp;Sample{         args: args,         handle: f,     }, nil } <pre><code>&gt; &gt; \u5b8c\u6574\u4ee3\u7801\u53ef\u4ee5\u524d\u5f80\u4ed3\u5e93 https://github.com/cnych/sample-scheduler-framework \u83b7\u53d6\u3002\n\n&gt; \u5b9e\u73b0\u5b8c\u6210\u540e\uff0c\u7f16\u8bd1\u6253\u5305\u6210\u955c\u50cf\u5373\u53ef\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u5f53\u6210\u666e\u901a\u7684\u5e94\u7528\u7528\u4e00\u4e2a `Deployment` \u63a7\u5236\u5668\u6765\u90e8\u7f72\u5373\u53ef\uff0c\u7531\u4e8e\u6211\u4eec\u9700\u8981\u53bb\u83b7\u53d6\u96c6\u7fa4\u4e2d\u7684\u4e00\u4e9b\u8d44\u6e90\u5bf9\u8c61\uff0c\u6240\u4ee5\u5f53\u7136\u9700\u8981\u7533\u8bf7 RBAC \u6743\u9650\uff0c\u7136\u540e\u540c\u6837\u901a\u8fc7 `--config` \u53c2\u6570\u6765\u914d\u7f6e\u6211\u4eec\u7684\u8c03\u5ea6\u5668\uff0c\u540c\u6837\u8fd8\u662f\u4f7f\u7528\u4e00\u4e2a \n</code></pre> KubeSchedulerConfiguration <pre><code> \u8d44\u6e90\u5bf9\u8c61\u914d\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7 `plugins` \u6765\u542f\u7528\u6216\u8005\u7981\u7528\u6211\u4eec\u5b9e\u73b0\u7684\u63d2\u4ef6\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7 `pluginConfig` \u6765\u4f20\u9012\u4e00\u4e9b\u53c2\u6570\u503c\u7ed9\u63d2\u4ef6\uff1a\n</code></pre> kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata:   name: sample-scheduler-clusterrole rules:   - apiGroups:       - \"\"     resources:       - endpoints       - events     verbs:       - create       - get       - update   - apiGroups:       - \"\"     resources:       - nodes     verbs:       - get       - list       - watch   - apiGroups:       - \"\"     resources:       - pods     verbs:       - delete       - get       - list       - watch       - update   - apiGroups:       - \"\"     resources:       - bindings       - pods/binding     verbs:       - create   - apiGroups:       - \"\"     resources:       - pods/status     verbs:       - patch       - update   - apiGroups:       - \"\"     resources:       - replicationcontrollers       - services     verbs:       - get       - list       - watch   - apiGroups:       - apps       - extensions     resources:       - replicasets     verbs:       - get       - list       - watch   - apiGroups:       - apps     resources:       - statefulsets     verbs:       - get       - list       - watch   - apiGroups:       - policy     resources:       - poddisruptionbudgets     verbs:       - get       - list       - watch   - apiGroups:       - \"\"     resources:       - persistentvolumeclaims       - persistentvolumes     verbs:       - get       - list       - watch   - apiGroups:       - \"\"     resources:       - configmaps     verbs:       - get       - list       - watch   - apiGroups:       - \"storage.k8s.io\"     resources:       - storageclasses       - csinodes     verbs:       - get       - list       - watch   - apiGroups:       - \"coordination.k8s.io\"     resources:       - leases     verbs:       - create       - get       - list       - update   - apiGroups:       - \"events.k8s.io\"     resources:       - events     verbs:       - create       - patch       - update</p> <p>apiVersion: v1 kind: ServiceAccount metadata:   name: sample-scheduler-sa   namespace: kube-system</p> <p>kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata:   name: sample-scheduler-clusterrolebinding   namespace: kube-system roleRef:   apiGroup: rbac.authorization.k8s.io   kind: ClusterRole   name: sample-scheduler-clusterrole subjects: - kind: ServiceAccount   name: sample-scheduler-sa   namespace: kube-system</p> <p>apiVersion: v1 kind: ConfigMap metadata:   name: scheduler-config   namespace: kube-system data:   scheduler-config.yaml: |     apiVersion: kubescheduler.config.k8s.io/v1alpha1     kind: KubeSchedulerConfiguration     schedulerName: sample-scheduler     leaderElection:       leaderElect: true       lockObjectName: sample-scheduler       lockObjectNamespace: kube-system     plugins:       preFilter:         enabled:         - name: \"sample-plugin\"       filter:         enabled:         - name: \"sample-plugin\"       preBind:         enabled:         - name: \"sample-plugin\"     pluginConfig:     - name: \"sample-plugin\"       args:         favorite_color: \"#326CE5\"         favorite_number: 7         thanks_to: \"thockin\"</p> <p>apiVersion: apps/v1 kind: Deployment metadata:   name: sample-scheduler   namespace: kube-system   labels:     component: sample-scheduler spec:   replicas: 1   selector:     matchLabels:       component: sample-scheduler   template:     metadata:       labels:         component: sample-scheduler     spec:       serviceAccount: sample-scheduler-sa       priorityClassName: system-cluster-critical       volumes:         - name: scheduler-config           configMap:             name: scheduler-config       containers:         - name: scheduler-ctrl           image: cnych/sample-scheduler:v6           imagePullPolicy: IfNotPresent           args:             - sample-scheduler-framework             - --config=/etc/kubernetes/scheduler-config.yaml             - --v=3           resources:             requests:               cpu: \"50m\"           volumeMounts:             - name: scheduler-config               mountPath: /etc/kubernetes <pre><code>&gt; \u76f4\u63a5\u90e8\u7f72\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u90e8\u7f72\u4e86\u4e00\u4e2a\u540d\u4e3a `sample-scheduler` \u7684\u8c03\u5ea6\u5668\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u90e8\u7f72\u4e00\u4e2a\u5e94\u7528\u6765\u4f7f\u7528\u8fd9\u4e2a\u8c03\u5ea6\u5668\u8fdb\u884c\u8c03\u5ea6\uff1a\n</code></pre> apiVersion: apps/v1 kind: Deployment metadata:   name: test-scheduler spec:   replicas: 1   selector:     matchLabels:       app: test-scheduler   template:     metadata:       labels:         app: test-scheduler     spec:       schedulerName: sample-scheduler       containers:       - image: nginx         imagePullPolicy: IfNotPresent         name: nginx         ports:         - containerPort: 80 <pre><code>&gt; \u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u73b0\u5728\u624b\u52a8\u6307\u5b9a\u4e86\u4e00\u4e2a `schedulerName` \u7684\u5b57\u6bb5\uff0c\u5c06\u5176\u8bbe\u7f6e\u6210\u4e0a\u9762\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u8c03\u5ea6\u5668\u540d\u79f0 `sample-scheduler`\u3002\n\n&gt; \u6211\u4eec\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u521b\u5efa\u5b8c\u6210\u540e\u67e5\u770b\u6211\u4eec\u81ea\u5b9a\u4e49\u8c03\u5ea6\u5668\u7684\u65e5\u5fd7\u4fe1\u606f\uff1a\n</code></pre> $ kubectl get pods -n kube-system -l component=sample-scheduler NAME                               READY   STATUS    RESTARTS   AGE sample-scheduler-7c469787f-rwhhd   1/1     Running   0          13m $ kubectl logs -f sample-scheduler-7c469787f-rwhhd -n kube-system I0104 08:24:087881       1 scheduler.go:530] Attempting to schedule pod: default/test-scheduler-6d779d9465-rq2bb I0104 08:24:087992       1 plugins.go:23] prefilter pod: test-scheduler-6d779d9465-rq2bb I0104 08:24:088657       1 plugins.go:28] filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-node1 I0104 08:24:088797       1 plugins.go:28] filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-node2 I0104 08:24:088871       1 plugins.go:28] filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-node3 I0104 08:24:088946       1 plugins.go:28] filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-node4 I0104 08:24:088992       1 plugins.go:28] filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-master I0104 08:24:090653       1 plugins.go:36] prebind node info: &amp;Node{ObjectMeta:{ydzs-node3   /api/v1/nodes/ydzs-node3 1ff6e228-4d98-4737-b6d3-30a5d55ccdc2 15466372 0 2019-11-10 09:05:09 +0000 UTC   ......} I0104 08:24:091761       1 factory.go:610] Attempting to bind test-scheduler-6d779d9465-rq2bb to ydzs-node3 I0104 08:24:104994       1 scheduler.go:667] pod default/test-scheduler-6d779d9465-rq2bb is bound successfully on node \"ydzs-node3\", 5 nodes evaluated, 4 nodes were found feasible. Bound node resource: \"Capacity: CPU&lt;4&gt;|Memory&lt;8008820Ki&gt;|Pods&lt;110&gt;|StorageEphemeral&lt;17921Mi&gt;; Allocatable: CPU&lt;4&gt;|Memory&lt;7906420Ki&gt;|Pods&lt;110&gt;|StorageEphemeral&lt;16912377419&gt;.\". <pre><code>&gt; \u53ef\u4ee5\u770b\u5230\u5f53\u6211\u4eec\u521b\u5efa\u5b8c Pod \u540e\uff0c\u5728\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u8c03\u5ea6\u5668\u4e2d\u5c31\u51fa\u73b0\u4e86\u5bf9\u5e94\u7684\u65e5\u5fd7\uff0c\u5e76\u4e14\u5728\u6211\u4eec\u5b9a\u4e49\u7684\u6269\u5c55\u70b9\u4e0a\u9762\u90fd\u51fa\u73b0\u4e86\u5bf9\u5e94\u7684\u65e5\u5fd7\uff0c\u8bc1\u660e\u6211\u4eec\u7684\u793a\u4f8b\u6210\u529f\u4e86\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b Pod \u7684 `schedulerName` \u6765\u9a8c\u8bc1\uff1a\n</code></pre> $ kubectl get pods NAME                                      READY   STATUS    RESTARTS   AGE test-scheduler-6d779d9465-rq2bb           1/1     Running   0          22m $ kubectl get pod test-scheduler-6d779d9465-rq2bb -o yaml ...... restartPolicy: Always schedulerName: sample-scheduler securityContext: {} serviceAccount: default ...... <pre><code>&gt; \u5728\u6700\u65b0\u7684 Kubernetes v1.17 \u7248\u672c\u4e2d\uff0c`Scheduler Framework` \u5185\u7f6e\u7684\u9884\u9009\u548c\u4f18\u9009\u51fd\u6570\u5df2\u7ecf\u5168\u90e8\u63d2\u4ef6\u5316\uff0c\u6240\u4ee5\u8981\u6269\u5c55\u8c03\u5ea6\u5668\u6211\u4eec\u5e94\u8be5\u638c\u63e1\u5e76\u7406\u89e3\u8c03\u5ea6\u6846\u67b6\u8fd9\u79cd\u65b9\u5f0f\u3002\n\n### \u4f18\u5148\u7ea7\u8c03\u5ea6 \n\n&gt; \u4e0e\u524d\u9762\u6240\u8bb2\u7684\u8c03\u5ea6\u4f18\u9009\u7b56\u7565\u4e2d\u7684\u4f18\u5148\u7ea7\uff08Priorities\uff09\u4e0d\u540c\uff0c\u524d\u9762\u6240\u8bb2\u7684\u4f18\u5148\u7ea7\u6307\u7684\u662f\u8282\u70b9\u4f18\u5148\u7ea7\uff0c\u800c\u6211\u4eec\u8fd9\u91cc\u6240\u8bf4\u7684\u4f18\u5148\u7ea7\u6307\u7684\u662f Pod \u7684\u4f18\u5148\u7ea7\uff0c\u9ad8\u4f18\u5148\u7ea7\u7684 Pod \u4f1a\u4f18\u5148\u88ab\u8c03\u5ea6\uff0c\u6216\u8005\u5728\u8d44\u6e90\u4e0d\u8db3\u4f4e\u60c5\u51b5\u727a\u7272\u4f4e\u4f18\u5148\u7ea7\u7684 Pod\uff0c\u4ee5\u4fbf\u4e8e\u91cd\u8981\u7684 Pod \u80fd\u591f\u5f97\u5230\u8d44\u6e90\u90e8\u7f72\u3002\n\n&gt; \u8981\u5b9a\u4e49 Pod \u4f18\u5148\u7ea7\uff0c\u5c31\u9700\u8981\u5148\u5b9a\u4e49 `PriorityClass` \u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u6ca1\u6709 Namespace \u7684\u9650\u5236\uff1a\n</code></pre> apiVersion: v1 kind: PriorityClass metadata:   name: high-priority value: 1000000 globalDefault: false description: \"This priority class should be used for XYZ service pods only.\" <pre><code>&gt; \u5176\u4e2d\uff1a\n\n*   value \u4e3a 32 \u4f4d\u6574\u6570\u7684\u4f18\u5148\u7ea7\uff0c\u8be5\u503c\u8d8a\u5927\uff0c\u4f18\u5148\u7ea7\u8d8a\u9ad8\n*   globalDefault \u7528\u4e8e\u672a\u914d\u7f6e PriorityClassName \u7684 Pod\uff0c\u6574\u4e2a\u96c6\u7fa4\u4e2d\u5e94\u8be5\u53ea\u6709\u4e00\u4e2a `PriorityClass` \u5c06\u5176\u8bbe\u7f6e\u4e3a true\n\n&gt; \u7136\u540e\u901a\u8fc7\u5728 Pod \u7684 \n</code></pre> spec.priorityClassName <pre><code> \u4e2d\u6307\u5b9a\u5df2\u5b9a\u4e49\u7684 `PriorityClass` \u540d\u79f0\u5373\u53ef\uff1a\n</code></pre> apiVersion: v1 kind: Pod metadata:   name: nginx   labels:     app: nginx spec:   containers:   - name: nginx     image: nginx     imagePullPolicy: IfNotPresent   priorityClassName: high-priority ``` <p>\u53e6\u5916\u4e00\u4e2a\u503c\u5f97\u6ce8\u610f\u7684\u662f\u5f53\u8282\u70b9\u6ca1\u6709\u8db3\u591f\u7684\u8d44\u6e90\u4f9b\u8c03\u5ea6\u5668\u8c03\u5ea6 Pod\uff0c\u5bfc\u81f4 Pod \u5904\u4e8e pending \u65f6\uff0c\u62a2\u5360\uff08preemption\uff09\u903b\u8f91\u5c31\u4f1a\u88ab\u89e6\u53d1\uff0c\u62a2\u5360\u4f1a\u5c1d\u8bd5\u4ece\u4e00\u4e2a\u8282\u70b9\u5220\u9664\u4f4e\u4f18\u5148\u7ea7\u7684 Pod\uff0c\u4ece\u800c\u91ca\u653e\u8d44\u6e90\u4f7f\u9ad8\u4f18\u5148\u7ea7\u7684 Pod \u5f97\u5230\u8282\u70b9\u8d44\u6e90\u8fdb\u884c\u90e8\u7f72\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u901a\u8fc7\u4e0b\u9762\u7684\u56fe\u518d\u53bb\u56de\u987e\u4e0b kubernetes \u7684\u8c03\u5ea6\u8fc7\u7a0b\u5c31\u6e05\u6670\u5f88\u591a\u4e86\uff1a</p> <p></p>"},{"location":"kubernetes_scheduler/usage/","title":"Pod \u8c03\u5ea6","text":""},{"location":"kubernetes_scheduler/usage/#_1","title":"\u8c03\u5ea6","text":"<p>\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u90e8\u7f72\u7684 Pod \u662f\u901a\u8fc7\u96c6\u7fa4\u7684\u81ea\u52a8\u8c03\u5ea6\u7b56\u7565\u6765\u9009\u62e9\u8282\u70b9\u7684\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8c03\u5ea6\u5668\u8003\u8651\u7684\u662f\u8d44\u6e90\u8db3\u591f\uff0c\u5e76\u4e14\u8d1f\u8f7d\u5c3d\u91cf\u5e73\u5747\uff0c\u4f46\u662f\u6709\u7684\u65f6\u5019\u6211\u4eec\u9700\u8981\u80fd\u591f\u66f4\u52a0\u7ec6\u7c92\u5ea6\u7684\u53bb\u63a7\u5236 Pod \u7684\u8c03\u5ea6\uff0c\u6bd4\u5982\u6211\u4eec\u5e0c\u671b\u4e00\u4e9b\u673a\u5668\u5b66\u4e60\u7684\u5e94\u7528\u53ea\u8dd1\u5728\u6709 GPU \u7684\u8282\u70b9\u4e0a\uff1b\u4f46\u662f\u6709\u7684\u65f6\u5019\u6211\u4eec\u7684\u670d\u52a1\u4e4b\u95f4\u4ea4\u6d41\u6bd4\u8f83\u9891\u7e41\uff0c\u53c8\u5e0c\u671b\u80fd\u591f\u5c06\u8fd9\u670d\u52a1\u7684 Pod \u90fd\u8c03\u5ea6\u5230\u540c\u4e00\u4e2a\u7684\u8282\u70b9\u4e0a\u3002\u8fd9\u5c31\u9700\u8981\u4f7f\u7528\u4e00\u4e9b\u8c03\u5ea6\u65b9\u5f0f\u6765\u63a7\u5236 Pod \u7684\u8c03\u5ea6\u4e86\uff0c\u4e3b\u8981\u6709\u4e24\u4e2a\u6982\u5ff5\uff1a<code>\u4eb2\u548c\u6027\u548c\u53cd\u4eb2\u548c\u6027</code>\uff0c\u4eb2\u548c\u6027\u53c8\u5206\u6210\u8282\u70b9\u4eb2\u548c\u6027(nodeAffinity)\u548c Pod \u4eb2\u548c\u6027(podAffinity)\u3002</p>"},{"location":"kubernetes_scheduler/usage/#nodeselector","title":"nodeSelector","text":"<p>\u5728\u4e86\u89e3\u4eb2\u548c\u6027\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u6765\u4e86\u89e3\u4e00\u4e2a\u975e\u5e38\u5e38\u7528\u7684\u8c03\u5ea6\u65b9\u5f0f\uff1a<code>nodeSelector</code>\u3002\u6211\u4eec\u77e5\u9053 label \u6807\u7b7e\u662f kubernetes \u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u6982\u5ff5\uff0c\u7528\u6237\u53ef\u4ee5\u975e\u5e38\u7075\u6d3b\u7684\u5229\u7528 label \u6765\u7ba1\u7406\u96c6\u7fa4\u4e2d\u7684\u8d44\u6e90\uff0c\u6bd4\u5982\u6700\u5e38\u89c1\u7684 Service \u5bf9\u8c61\u901a\u8fc7 label \u53bb\u5339\u914d Pod \u8d44\u6e90\uff0c\u800c Pod \u7684\u8c03\u5ea6\u4e5f\u53ef\u4ee5\u6839\u636e\u8282\u70b9\u7684 label \u6765\u8fdb\u884c\u8c03\u5ea6\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u6211\u4eec\u7684 node \u7684 label\uff1a</p> <pre><code>$ kubectl get nodes --show-labels\nNAME          STATUS   ROLES    AGE   VERSION   LABELS\nydzs-master   Ready    master   55d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-master,kubernetes.io/os=linux,node-role.kubernetes.io/master=\nydzs-node1    Ready    &lt;none&gt;   55d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node1,kubernetes.io/os=linux\nydzs-node2    Ready    &lt;none&gt;   55d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node2,kubernetes.io/os=linux\nydzs-node3    Ready    &lt;none&gt;   53d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node3,kubernetes.io/os=linux,monitor=prometheus\nydzs-node4    Ready    &lt;none&gt;   53d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node4,kubernetes.io/os=linux\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5148\u7ed9\u8282\u70b9 ydzs-node2 \u589e\u52a0\u4e00\u4e2a<code>com=youdianzhishi</code>\u7684\u6807\u7b7e\uff0c\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl label nodes ydzs-node2 com=youdianzhishi\nnode/ydzs-node2 labeled\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u7684 <code>--show-labels</code> \u53c2\u6570\u53ef\u4ee5\u67e5\u770b\u4e0a\u8ff0\u6807\u7b7e\u662f\u5426\u751f\u6548\u3002\u5f53\u8282\u70b9\u88ab\u6253\u4e0a\u4e86\u76f8\u5173\u6807\u7b7e\u540e\uff0c\u5728\u8c03\u5ea6\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u6807\u7b7e\u4e86\uff0c\u53ea\u9700\u8981\u5728 Pod \u7684 spec \u5b57\u6bb5\u4e2d\u6dfb\u52a0 <code>nodeSelector</code> \u5b57\u6bb5\uff0c\u91cc\u9762\u662f\u6211\u4eec\u9700\u8981\u88ab\u8c03\u5ea6\u7684\u8282\u70b9\u7684 label \u6807\u7b7e\uff0c\u6bd4\u5982\uff0c\u4e0b\u9762\u7684 Pod \u6211\u4eec\u8981\u5f3a\u5236\u8c03\u5ea6\u5230 ydzs-node2 \u8fd9\u4e2a\u8282\u70b9\u4e0a\u53bb\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 nodeSelector \u6765\u8868\u793a\u4e86\uff1a(node-selector-demo.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  labels:\n    app: busybox-pod\n  name: test-busybox\nspec:\n  containers:\n  - command:\n    - sleep\n    - \"3600\"\n    image: busybox\n    imagePullPolicy: Always\n    name: test-busybox\n  nodeSelector:\n    com: youdianzhishi\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 describe \u547d\u4ee4\u67e5\u770b\u8c03\u5ea6\u7ed3\u679c\uff1a</p> <pre><code>$ kubectl apply -f pod-selector-demo.yaml \npod/test-busybox created\n$ kubectl describe pod test-busybox\nName:         test-busybox\nNamespace:    default\nPriority:     0\nNode:         ydzs-node2/123\n......\nNode-Selectors:  com=youdianzhishi\nTolerations:     node.kubernetes.io/not-ready:NoExecute for 300s\n                 node.kubernetes.io/unreachable:NoExecute for 300s\nEvents:\n  Type    Reason     Age        From                 Message\n  ----    ------     ----       ----                 -------\n  Normal  Scheduled  &lt;unknown&gt;  default-scheduler    Successfully assigned default/test-busybox to ydzs-node2\n  Normal  Pulling    13s        kubelet, ydzs-node2  Pulling image \"busybox\"\n  Normal  Pulled     10s        kubelet, ydzs-node2  Successfully pulled image \"busybox\"\n  Normal  Created    10s        kubelet, ydzs-node2  Created container test-busybox\n  Normal  Started    9s         kubelet, ydzs-node2  Started container test-busybox\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Events \u4e0b\u9762\u7684\u4fe1\u606f\uff0c\u6211\u4eec\u7684 Pod \u901a\u8fc7\u9ed8\u8ba4\u7684 <code>default-scheduler</code> \u8c03\u5ea6\u5668\u88ab\u7ed1\u5b9a\u5230\u4e86 ydzs-node2 \u8282\u70b9\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f<code>nodeSelector</code> \u5c5e\u4e8e\u5f3a\u5236\u6027\u7684\uff0c\u5982\u679c\u6211\u4eec\u7684\u76ee\u6807\u8282\u70b9\u6ca1\u6709\u53ef\u7528\u7684\u8d44\u6e90\uff0c\u6211\u4eec\u7684 Pod \u5c31\u4f1a\u4e00\u76f4\u5904\u4e8e <code>Pending</code> \u72b6\u6001\u3002</p> <p>\u901a\u8fc7\u4e0a\u9762\u7684\u4f8b\u5b50\u6211\u4eec\u53ef\u4ee5\u611f\u53d7\u5230 <code>nodeSelector</code> \u7684\u65b9\u5f0f\u6bd4\u8f83\u76f4\u89c2\uff0c\u4f46\u662f\u8fd8\u591f\u7075\u6d3b\uff0c\u63a7\u5236\u7c92\u5ea6\u504f\u5927\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u548c\u5927\u5bb6\u4e86\u89e3\u4e0b\u66f4\u52a0\u7075\u6d3b\u7684\u65b9\u5f0f\uff1a\u8282\u70b9\u4eb2\u548c\u6027(nodeAffinity)\u3002</p>"},{"location":"kubernetes_scheduler/usage/#_2","title":"\u4eb2\u548c\u6027\u548c\u53cd\u4eb2\u548c\u6027\u8c03\u5ea6","text":"<p>\u524d\u9762\u6211\u4eec\u4e86\u89e3\u4e86 kubernetes \u8c03\u5ea6\u5668\u7684\u8c03\u5ea6\u6d41\u7a0b\uff0c\u6211\u4eec\u77e5\u9053\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\u5728\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u7ecf\u8fc7\u4e86 <code>predicates</code> \u548c <code>priorities</code> \u4e24\u4e2a\u9636\u6bb5\uff0c\u4f46\u662f\u5728\u5b9e\u9645\u7684\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5f80\u5f80\u6211\u4eec\u9700\u8981\u6839\u636e\u81ea\u5df1\u7684\u4e00\u4e9b\u5b9e\u9645\u9700\u6c42\u6765\u63a7\u5236 Pod \u7684\u8c03\u5ea6\uff0c\u8fd9\u5c31\u9700\u8981\u7528\u5230 <code>nodeAffinity(\u8282\u70b9\u4eb2\u548c\u6027)</code>\u3001<code>podAffinity(pod \u4eb2\u548c\u6027)</code> \u4ee5\u53ca </p> <pre><code>podAntiAffinity(pod \u53cd\u4eb2\u548c\u6027)\n</code></pre> <p>\u3002</p> <p>\u4eb2\u548c\u6027\u8c03\u5ea6\u53ef\u4ee5\u5206\u6210<code>\u8f6f\u7b56\u7565</code>\u548c<code>\u786c\u7b56\u7565</code>\u4e24\u79cd\u65b9\u5f0f:</p> <ul> <li><code>\u8f6f\u7b56\u7565</code>\u5c31\u662f\u5982\u679c\u73b0\u5728\u6ca1\u6709\u6ee1\u8db3\u8c03\u5ea6\u8981\u6c42\u7684\u8282\u70b9\u7684\u8bdd\uff0cPod \u5c31\u4f1a\u5ffd\u7565\u8fd9\u6761\u89c4\u5219\uff0c\u7ee7\u7eed\u5b8c\u6210\u8c03\u5ea6\u8fc7\u7a0b\uff0c\u8bf4\u767d\u4e86\u5c31\u662f\u6ee1\u8db3\u6761\u4ef6\u6700\u597d\u4e86\uff0c\u6ca1\u6709\u7684\u8bdd\u4e5f\u65e0\u6240\u8c13</li> <li><code>\u786c\u7b56\u7565</code>\u5c31\u6bd4\u8f83\u5f3a\u786c\u4e86\uff0c\u5982\u679c\u6ca1\u6709\u6ee1\u8db3\u6761\u4ef6\u7684\u8282\u70b9\u7684\u8bdd\uff0c\u5c31\u4e0d\u65ad\u91cd\u8bd5\u76f4\u5230\u6ee1\u8db3\u6761\u4ef6\u4e3a\u6b62\uff0c\u7b80\u5355\u8bf4\u5c31\u662f\u4f60\u5fc5\u987b\u6ee1\u8db3\u6211\u7684\u8981\u6c42\uff0c\u4e0d\u7136\u5c31\u4e0d\u5e72\u4e86</li> </ul> <p>\u5bf9\u4e8e\u4eb2\u548c\u6027\u548c\u53cd\u4eb2\u548c\u6027\u90fd\u6709\u8fd9\u4e24\u79cd\u89c4\u5219\u53ef\u4ee5\u8bbe\u7f6e\uff1a </p> <pre><code>preferredDuringSchedulingIgnoredDuringExecution\n</code></pre> <p>\u548c</p> <pre><code>requiredDuringSchedulingIgnoredDuringExecution\n</code></pre> <p>\uff0c\u524d\u9762\u7684\u5c31\u662f\u8f6f\u7b56\u7565\uff0c\u540e\u9762\u7684\u5c31\u662f\u786c\u7b56\u7565\u3002</p>"},{"location":"kubernetes_scheduler/usage/#_3","title":"\u8282\u70b9\u4eb2\u548c\u6027","text":"<p>\u8282\u70b9\u4eb2\u548c\u6027\uff08nodeAffinity\uff09\u4e3b\u8981\u662f\u7528\u6765\u63a7\u5236 Pod \u8981\u90e8\u7f72\u5728\u54ea\u4e9b\u8282\u70b9\u4e0a\uff0c\u4ee5\u53ca\u4e0d\u80fd\u90e8\u7f72\u5728\u54ea\u4e9b\u8282\u70b9\u4e0a\u7684\uff0c\u5b83\u53ef\u4ee5\u8fdb\u884c\u4e00\u4e9b\u7b80\u5355\u7684\u903b\u8f91\u7ec4\u5408\u4e86\uff0c\u4e0d\u53ea\u662f\u7b80\u5355\u7684\u76f8\u7b49\u5339\u914d\u3002</p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u7528\u4e00\u4e2a Deployment \u6765\u7ba1\u74068\u4e2a Pod \u526f\u672c\uff0c\u73b0\u5728\u6211\u4eec\u6765\u63a7\u5236\u4e0b\u8fd9\u4e9b Pod \u7684\u8c03\u5ea6\uff0c\u5982\u4e0b\u4f8b\u5b50\uff1a\uff08node-affinity-demo.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: node-affinity\n  labels:\n    app: node-affinity\nspec:\n  replicas: 8\n  selector:\n    matchLabels:\n      app: node-affinity\n  template:\n    metadata:\n      labels:\n        app: node-affinity\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - containerPort: 80\n          name: nginxweb\n      affinity:\n        nodeAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:  # \u786c\u7b56\u7565\n            nodeSelectorTerms:\n            - matchExpressions:\n              - key: kubernetes.io/hostname\n                operator: NotIn\n                values:\n                - ydzs-node3\n          preferredDuringSchedulingIgnoredDuringExecution:  # \u8f6f\u7b56\u7565\n          - weight: 1\n            preference:\n              matchExpressions:\n              - key: com\n                operator: In\n                values:\n                - youdianzhishi\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a Pod \u9996\u5148\u662f\u8981\u6c42\u4e0d\u80fd\u8fd0\u884c\u5728 ydzs-node3 \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff0c\u5982\u679c\u6709\u4e2a\u8282\u70b9\u6ee1\u8db3 <code>com=youdianzhishi</code> \u7684\u8bdd\u5c31\u4f18\u5148\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9\u4e0a\u3002</p> <p>\u7531\u4e8e\u4e0a\u9762 ydzs-node02 \u8282\u70b9\u6211\u4eec\u6253\u4e0a\u4e86 <code>com=youdianzhishi</code> \u8fd9\u6837\u7684 label \u6807\u7b7e\uff0c\u6240\u4ee5\u6309\u8981\u6c42\u4f1a\u4f18\u5148\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9\u6765\u7684\uff0c\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u8fd9\u4e2a Pod\uff0c\u7136\u540e\u67e5\u770b\u5177\u4f53\u7684\u8c03\u5ea6\u60c5\u51b5\u662f\u5426\u6ee1\u8db3\u6211\u4eec\u7684\u8981\u6c42\u3002</p> <pre><code>$ kubectl apply -f node-affinty-demo.yaml \ndeployment.apps/node-affinity created\n$ kubectl get pods -l app=node-affinity -o wide\nNAME                            READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES\nnode-affinity-cdd9d54d9-bgbbh   1/1     Running   0          2m28s   2247   ydzs-node2   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-dlbck   1/1     Running   0          2m28s   216    ydzs-node4   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-g2jr6   1/1     Running   0          2m28s   217    ydzs-node4   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-gzr58   1/1     Running   0          2m28s   2118   ydzs-node1   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-hcv7r   1/1     Running   0          2m28s   2246   ydzs-node2   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-kvxw4   1/1     Running   0          2m28s   2245   ydzs-node2   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-p4mmk   1/1     Running   0          2m28s   2244   ydzs-node2   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-t5mff   1/1     Running   0          2m28s   2117   ydzs-node1   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u4ece\u7ed3\u679c\u53ef\u4ee5\u770b\u51fa\u67094\u4e2a Pod \u88ab\u90e8\u7f72\u5230\u4e86 ydzs-node2 \u8282\u70b9\u4e0a\uff0c\u4f46\u662f\u53ef\u4ee5\u770b\u5230\u5e76\u6ca1\u6709\u4e00\u4e2a Pod \u88ab\u90e8\u7f72\u5230 ydzs-node3 \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff0c\u56e0\u4e3a\u6211\u4eec\u7684\u786c\u7b56\u7565\u5c31\u662f\u4e0d\u5141\u8bb8\u90e8\u7f72\u5230\u8be5\u8282\u70b9\u4e0a\uff0c\u800c ydzs-node2 \u662f\u8f6f\u7b56\u7565\uff0c\u6240\u4ee5\u4f1a\u5c3d\u91cf\u6ee1\u8db3\u3002\u8fd9\u91cc\u7684\u5339\u914d\u903b\u8f91\u662f label \u6807\u7b7e\u7684\u503c\u5728\u67d0\u4e2a\u5217\u8868\u4e2d\uff0c\u73b0\u5728 Kubernetes \u63d0\u4f9b\u7684\u64cd\u4f5c\u7b26\u6709\u4e0b\u9762\u7684\u51e0\u79cd\uff1a</p> <ul> <li>In\uff1alabel \u7684\u503c\u5728\u67d0\u4e2a\u5217\u8868\u4e2d</li> <li>NotIn\uff1alabel \u7684\u503c\u4e0d\u5728\u67d0\u4e2a\u5217\u8868\u4e2d</li> <li>Gt\uff1alabel \u7684\u503c\u5927\u4e8e\u67d0\u4e2a\u503c</li> <li>Lt\uff1alabel \u7684\u503c\u5c0f\u4e8e\u67d0\u4e2a\u503c</li> <li>Exists\uff1a\u67d0\u4e2a label \u5b58\u5728</li> <li>DoesNotExist\uff1a\u67d0\u4e2a label \u4e0d\u5b58\u5728</li> </ul> <p>\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f\u5982\u679c <code>nodeSelectorTerms</code> \u4e0b\u9762\u6709\u591a\u4e2a\u9009\u9879\u7684\u8bdd\uff0c\u6ee1\u8db3\u4efb\u4f55\u4e00\u4e2a\u6761\u4ef6\u5c31\u53ef\u4ee5\u4e86\uff1b\u5982\u679c <code>matchExpressions</code>\u6709\u591a\u4e2a\u9009\u9879\u7684\u8bdd\uff0c\u5219\u5fc5\u987b\u540c\u65f6\u6ee1\u8db3\u8fd9\u4e9b\u6761\u4ef6\u624d\u80fd\u6b63\u5e38\u8c03\u5ea6 Pod\u3002</p>"},{"location":"kubernetes_scheduler/usage/#pod","title":"Pod \u4eb2\u548c\u6027","text":"<p>Pod \u4eb2\u548c\u6027\uff08podAffinity\uff09\u4e3b\u8981\u89e3\u51b3 Pod \u53ef\u4ee5\u548c\u54ea\u4e9b Pod \u90e8\u7f72\u5728\u540c\u4e00\u4e2a\u62d3\u6251\u57df\u4e2d\u7684\u95ee\u9898\uff08\u5176\u4e2d\u62d3\u6251\u57df\u7528\u4e3b\u673a\u6807\u7b7e\u5b9e\u73b0\uff0c\u53ef\u4ee5\u662f\u5355\u4e2a\u4e3b\u673a\uff0c\u4e5f\u53ef\u4ee5\u662f\u591a\u4e2a\u4e3b\u673a\u7ec4\u6210\u7684 cluster\u3001zone \u7b49\u7b49\uff09\uff0c\u800c Pod \u53cd\u4eb2\u548c\u6027\u4e3b\u8981\u662f\u89e3\u51b3 Pod \u4e0d\u80fd\u548c\u54ea\u4e9b Pod \u90e8\u7f72\u5728\u540c\u4e00\u4e2a\u62d3\u6251\u57df\u4e2d\u7684\u95ee\u9898\uff0c\u5b83\u4eec\u90fd\u662f\u5904\u7406\u7684 Pod \u4e0e Pod \u4e4b\u95f4\u7684\u5173\u7cfb\uff0c\u6bd4\u5982\u4e00\u4e2a Pod \u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\u4e86\uff0c\u90a3\u4e48\u6211\u8fd9\u4e2a\u4e5f\u5f97\u5728\u8fd9\u4e2a\u8282\u70b9\uff0c\u6216\u8005\u4f60\u8fd9\u4e2a Pod \u5728\u8282\u70b9\u4e0a\u4e86\uff0c\u90a3\u4e48\u6211\u5c31\u4e0d\u60f3\u548c\u4f60\u5f85\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u3002</p> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u53ea\u6709\u4e00\u4e2a\u96c6\u7fa4\uff0c\u5e76\u6ca1\u6709\u533a\u57df\u6216\u8005\u673a\u623f\u7684\u6982\u5ff5\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u76f4\u63a5\u4f7f\u7528\u4e3b\u673a\u540d\u6765\u4f5c\u4e3a\u62d3\u6251\u57df\uff0c\u628a Pod \u521b\u5efa\u5728\u540c\u4e00\u4e2a\u4e3b\u673a\u4e0a\u9762\u3002</p> <pre><code>$ kubectl get nodes --show-labels\nNAME          STATUS   ROLES    AGE   VERSION   LABELS\nydzs-master   Ready    master   55d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-master,kubernetes.io/os=linux,node-role.kubernetes.io/master=\nydzs-node1    Ready    &lt;none&gt;   55d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node1,kubernetes.io/os=linux\nydzs-node2    Ready    &lt;none&gt;   55d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,com=youdianzhishi,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node2,kubernetes.io/os=linux\nydzs-node3    Ready    &lt;none&gt;   53d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node3,kubernetes.io/os=linux,monitor=prometheus\nydzs-node4    Ready    &lt;none&gt;   53d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node4,kubernetes.io/os=linux\n</code></pre> <p>\u540c\u6837\uff0c\u8fd8\u662f\u9488\u5bf9\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6211\u4eec\u6765\u6d4b\u8bd5\u4e0b Pod \u7684\u4eb2\u548c\u6027\uff1a\uff08pod-affinity-demo.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: pod-affinity\n  labels:\n    app: pod-affinity\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: pod-affinity\n  template:\n    metadata:\n      labels:\n        app: pod-affinity\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n          name: nginxweb\n      affinity:\n        podAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:  # \u786c\u7b56\u7565\n          - labelSelector:\n              matchExpressions:\n              - key: app\n                operator: In\n                values:\n                - busybox-pod\n            topologyKey: kubernetes.io/hostname\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u7684 Pod \u9700\u8981\u8c03\u5ea6\u5230\u67d0\u4e2a\u6307\u5b9a\u7684\u8282\u70b9\u4e0a\uff0c\u5e76\u4e14\u8be5\u8282\u70b9\u4e0a\u8fd0\u884c\u4e86\u4e00\u4e2a\u5e26\u6709 <code>app=busybox-pod</code> \u6807\u7b7e\u7684 Pod\u3002\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u6709\u6807\u7b7e <code>app=busybox-pod</code> \u7684 pod \u5217\u8868\uff1a</p> <pre><code>$ kubectl get pods -l app=busybox-pod -o wide\nNAME           READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES\ntest-busybox   1/1     Running   0          27m   2242   ydzs-node2   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u770b\u5230\u8fd9\u4e2a Pod \u8fd0\u884c\u5728\u4e86 ydzs-node2 \u7684\u8282\u70b9\u4e0a\u9762\uff0c\u6240\u4ee5\u6309\u7167\u4e0a\u9762\u7684\u4eb2\u548c\u6027\u6765\u8bf4\uff0c\u4e0a\u9762\u6211\u4eec\u90e8\u7f72\u76843\u4e2a Pod \u526f\u672c\u4e5f\u5e94\u8be5\u8fd0\u884c\u5728 ydzs-node2 \u8282\u70b9\u4e0a\uff1a</p> <pre><code>$ kubectl apply -f pod-affinity-demo.yaml \ndeployment.apps/pod-affinity created\n$ kubectl get pods -o wide -l app=pod-affinity\nNAME                            READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES\npod-affinity-587f9b5b58-5nxmf   1/1     Running   0          26s   2249   ydzs-node2   &lt;none&gt;           &lt;none&gt;\npod-affinity-587f9b5b58-m2j7s   1/1     Running   0          26s   2248   ydzs-node2   &lt;none&gt;           &lt;none&gt;\npod-affinity-587f9b5b58-vrd7b   1/1     Running   0          26s   2250   ydzs-node2   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u628a\u4e0a\u9762\u7684 test-busybox \u548c pod-affinity \u8fd9\u4e2a Deployment \u90fd\u5220\u9664\uff0c\u7136\u540e\u91cd\u65b0\u521b\u5efa pod-affinity \u8fd9\u4e2a\u8d44\u6e90\uff0c\u770b\u770b\u80fd\u4e0d\u80fd\u6b63\u5e38\u8c03\u5ea6\u5462\uff1a</p> <pre><code>$ kubectl delete -f node-selector-demo.yaml\npod \"test-busybox\" deleted\n$  kubectl delete -f pod-affinity-demo.yaml\ndeployment.apps \"pod-affinity\" deleted\n$ kubectl apply -f pod-affinity-demo.yaml\ndeployment.apps/pod-affinity created\n$ kubectl get pods -o wide -l app=pod-affinity\nNAME                            READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES\npod-affinity-587f9b5b58-bbfgr   0/1     Pending   0          18s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;\npod-affinity-587f9b5b58-lwc8n   0/1     Pending   0          18s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;\npod-affinity-587f9b5b58-pc7ql   0/1     Pending   0          18s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u90fd\u5904\u4e8e <code>Pending</code> \u72b6\u6001\u4e86\uff0c\u8fd9\u662f\u56e0\u4e3a\u73b0\u5728\u6ca1\u6709\u4e00\u4e2a\u8282\u70b9\u4e0a\u9762\u62e5\u6709 <code>app=busybox-pod</code> \u8fd9\u4e2a\u6807\u7b7e\u7684 Pod\uff0c\u800c\u4e0a\u9762\u6211\u4eec\u7684\u8c03\u5ea6\u4f7f\u7528\u7684\u662f\u786c\u7b56\u7565\uff0c\u6240\u4ee5\u5c31\u6ca1\u529e\u6cd5\u8fdb\u884c\u8c03\u5ea6\u4e86\uff0c\u5927\u5bb6\u53ef\u4ee5\u53bb\u5c1d\u8bd5\u4e0b\u91cd\u65b0\u5c06 test-busybox \u8fd9\u4e2a Pod \u8c03\u5ea6\u5230\u5176\u4ed6\u8282\u70b9\u4e0a\uff0c\u89c2\u5bdf\u4e0b\u4e0a\u9762\u76843\u4e2a\u526f\u672c\u4f1a\u4e0d\u4f1a\u4e5f\u88ab\u8c03\u5ea6\u5230\u5bf9\u5e94\u7684\u8282\u70b9\u4e0a\u53bb\u3002</p> <p>\u6211\u4eec\u8fd9\u4e2a\u5730\u65b9\u4f7f\u7528\u7684\u662f </p> <pre><code>kubernetes.io/hostname\n</code></pre> <p>\u8fd9\u4e2a\u62d3\u6251\u57df\uff0c\u610f\u601d\u5c31\u662f\u6211\u4eec\u5f53\u524d\u8c03\u5ea6\u7684 Pod \u8981\u548c\u76ee\u6807\u7684 Pod \u5904\u4e8e\u540c\u4e00\u4e2a\u4e3b\u673a\u4e0a\u9762\uff0c\u56e0\u4e3a\u8981\u5904\u4e8e\u540c\u4e00\u4e2a\u62d3\u6251\u57df\u4e0b\u9762\uff0c\u4e3a\u4e86\u8bf4\u660e\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u628a\u62d3\u6251\u57df\u6539\u6210 </p> <pre><code>beta.kubernetes.io/os\n</code></pre> <p>\uff0c\u540c\u6837\u7684\u6211\u4eec\u5f53\u524d\u8c03\u5ea6\u7684 Pod \u8981\u548c\u76ee\u6807\u7684 Pod \u5904\u4e8e\u540c\u4e00\u4e2a\u62d3\u6251\u57df\u4e2d\uff0c\u76ee\u6807\u7684 Pod \u662f\u62e5\u6709 </p> <pre><code>beta.kubernetes.io/os=linux\n</code></pre> <p>\u7684\u6807\u7b7e\uff0c\u800c\u6211\u4eec\u8fd9\u91cc\u6240\u6709\u8282\u70b9\u90fd\u6709\u8fd9\u6837\u7684\u6807\u7b7e\uff0c\u8fd9\u4e5f\u5c31\u610f\u5473\u7740\u6211\u4eec\u6240\u6709\u8282\u70b9\u90fd\u5728\u540c\u4e00\u4e2a\u62d3\u6251\u57df\u4e2d\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u7684 Pod \u53ef\u4ee5\u88ab\u8c03\u5ea6\u5230\u4efb\u4f55\u4e00\u4e2a\u8282\u70b9\uff0c\u91cd\u65b0\u8fd0\u884c\u4e0a\u9762\u7684 <code>app=busybox-pod</code> \u7684 Pod\uff0c\u7136\u540e\u518d\u66f4\u65b0\u4e0b\u6211\u4eec\u8fd9\u91cc\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get pods -o wide -l app=pod-affinity\nNAME                           READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES\npod-affinity-76c56567c-792n4   1/1     Running   0          2m59s   2254   ydzs-node2   &lt;none&gt;           &lt;none&gt;\npod-affinity-76c56567c-8s2pd   1/1     Running   0          3m53s   218    ydzs-node4   &lt;none&gt;           &lt;none&gt;\npod-affinity-76c56567c-hx7ck   1/1     Running   0          2m52s   223    ydzs-node3   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u662f\u5206\u522b\u8fd0\u884c\u57283\u4e2a\u8282\u70b9\u4e0b\u9762\u7684\uff0c\u56e0\u4e3a\u4ed6\u4eec\u90fd\u5c5e\u4e8e </p> <pre><code>beta.kubernetes.io/os\n</code></pre> <p>\u8fd9\u4e2a\u62d3\u6251\u57df\u3002</p>"},{"location":"kubernetes_scheduler/usage/#pod_1","title":"Pod \u53cd\u4eb2\u548c\u6027","text":"<p>Pod \u53cd\u4eb2\u548c\u6027\uff08podAntiAffinity\uff09\u5219\u662f\u53cd\u7740\u6765\u7684\uff0c\u6bd4\u5982\u4e00\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e86\u67d0\u4e2a Pod\uff0c\u90a3\u4e48\u6211\u4eec\u7684\u6a21\u677f Pod \u5219\u4e0d\u5e0c\u671b\u88ab\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9\u4e0a\u9762\u53bb\u4e86\u3002\u6211\u4eec\u628a\u4e0a\u9762\u7684 <code>podAffinity</code> \u76f4\u63a5\u6539\u6210 <code>podAntiAffinity</code>\uff1a(pod-antiaffinity-demo.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: pod-antiaffinity\n  labels:\n    app: pod-antiaffinity\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: pod-antiaffinity\n  template:\n    metadata:\n      labels:\n        app: pod-antiaffinity\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n          name: nginxweb\n      affinity:\n        podAntiAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:  # \u786c\u7b56\u7565\n          - labelSelector:\n              matchExpressions:\n              - key: app\n                operator: In\n                values:\n                - busybox-pod\n            topologyKey: kubernetes.io/hostname\n</code></pre> <p>\u8fd9\u91cc\u7684\u610f\u601d\u5c31\u662f\u5982\u679c\u4e00\u4e2a\u8282\u70b9\u4e0a\u9762\u6709\u4e00\u4e2a <code>app=busybox-pod</code> \u8fd9\u6837\u7684 Pod \u7684\u8bdd\uff0c\u90a3\u4e48\u6211\u4eec\u7684 Pod \u5c31\u522b\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9\u4e0a\u9762\u6765\uff0c\u4e0a\u9762\u6211\u4eec\u628a<code>app=busybox-pod</code> \u8fd9\u4e2a Pod \u56fa\u5b9a\u5230\u4e86 ydzs-node2 \u8fd9\u4e2a\u8282\u70b9\u4e0a\u9762\u7684\uff0c\u6240\u4ee5\u6b63\u5e38\u6765\u8bf4\u6211\u4eec\u8fd9\u91cc\u7684 Pod \u4e0d\u4f1a\u51fa\u73b0\u5728\u8be5\u8282\u70b9\u4e0a\uff1a</p> <pre><code>$ kubectl apply -f pod-antiaffinity-demo.yaml \ndeployment.apps/pod-antiaffinity created\n$ kubectl get pods -l app=pod-antiaffinity -o wide\nNAME                                READY   STATUS    RESTARTS   AGE   IP            NODE         NOMINATED NODE   READINESS GATES\npod-antiaffinity-84d5bf9df4-9c9qk   1/1     Running   0          73s   219   ydzs-node4   &lt;none&gt;           &lt;none&gt;\npod-antiaffinity-84d5bf9df4-q6lkm   1/1     Running   0          67s   224   ydzs-node3   &lt;none&gt;           &lt;none&gt;\npod-antiaffinity-84d5bf9df4-vk9tc   1/1     Running   0          57s   225   ydzs-node3   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6ca1\u6709\u88ab\u8c03\u5ea6\u5230 ydzs-node2 \u8282\u70b9\u4e0a\uff0c\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f Pod \u53cd\u4eb2\u548c\u6027\u3002\u5927\u5bb6\u53ef\u4ee5\u601d\u8003\u4e0b\uff0c\u5982\u679c\u8fd9\u91cc\u6211\u4eec\u5c06\u62d3\u6251\u57df\u66f4\u6539\u6210 </p> <pre><code>beta.kubernetes.io/os\n</code></pre> <p>\u4f1a\u600e\u4e48\u6837\u5462\uff1f\u53ef\u4ee5\u81ea\u5df1\u53bb\u6d4b\u8bd5\u4e0b\u770b\u770b\u3002</p>"},{"location":"kubernetes_scheduler/usage/#_4","title":"\u6c61\u70b9\u4e0e\u5bb9\u5fcd","text":"<p>\u5bf9\u4e8e <code>nodeAffinity</code> \u65e0\u8bba\u662f\u786c\u7b56\u7565\u8fd8\u662f\u8f6f\u7b56\u7565\u65b9\u5f0f\uff0c\u90fd\u662f\u8c03\u5ea6 Pod \u5230\u9884\u671f\u8282\u70b9\u4e0a\uff0c\u800c\u6c61\u70b9\uff08Taints\uff09\u6070\u597d\u4e0e\u4e4b\u76f8\u53cd\uff0c\u5982\u679c\u4e00\u4e2a\u8282\u70b9\u6807\u8bb0\u4e3a Taints \uff0c\u9664\u975e Pod \u4e5f\u88ab\u6807\u8bc6\u4e3a\u53ef\u4ee5\u5bb9\u5fcd\u6c61\u70b9\u8282\u70b9\uff0c\u5426\u5219\u8be5 Taints \u8282\u70b9\u4e0d\u4f1a\u88ab\u8c03\u5ea6 Pod\u3002</p> <p>\u6bd4\u5982\u7528\u6237\u5e0c\u671b\u628a Master \u8282\u70b9\u4fdd\u7559\u7ed9 Kubernetes \u7cfb\u7edf\u7ec4\u4ef6\u4f7f\u7528\uff0c\u6216\u8005\u628a\u4e00\u7ec4\u5177\u6709\u7279\u6b8a\u8d44\u6e90\u9884\u7559\u7ed9\u67d0\u4e9b Pod\uff0c\u5219\u6c61\u70b9\u5c31\u5f88\u6709\u7528\u4e86\uff0cPod \u4e0d\u4f1a\u518d\u88ab\u8c03\u5ea6\u5230 taint \u6807\u8bb0\u8fc7\u7684\u8282\u70b9\u3002\u6211\u4eec\u4f7f\u7528 kubeadm \u642d\u5efa\u7684\u96c6\u7fa4\u9ed8\u8ba4\u5c31\u7ed9 master \u8282\u70b9\u6dfb\u52a0\u4e86\u4e00\u4e2a\u6c61\u70b9\u6807\u8bb0\uff0c\u6240\u4ee5\u6211\u4eec\u770b\u5230\u6211\u4eec\u5e73\u65f6\u7684 Pod \u90fd\u6ca1\u6709\u88ab\u8c03\u5ea6\u5230 master \u4e0a\u53bb\uff1a</p> <pre><code>$ kubectl describe node ydzs-master\nName:               ydzs-master\nRoles:              master\nLabels:             beta.kubernetes.io/arch=amd64\n                    beta.kubernetes.io/os=linux\n                    kubernetes.io/arch=amd64\n                    kubernetes.io/hostname=ydzs-master\n                    kubernetes.io/os=linux\n                    node-role.kubernetes.io/master=\n......\nTaints:             node-role.kubernetes.io/master:NoSchedule\nUnschedulable:      false\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684\u547d\u4ee4\u67e5\u770b master \u8282\u70b9\u7684\u4fe1\u606f\uff0c\u5176\u4e2d\u6709\u4e00\u6761\u5173\u4e8e Taints \u7684\u4fe1\u606f\uff1a</p> <pre><code>node-role.kubernetes.io/master:NoSchedule\n</code></pre> <p>\uff0c\u5c31\u8868\u793amaster \u8282\u70b9\u6253\u4e86\u4e00\u4e2a\u6c61\u70b9\u7684\u6807\u8bb0\uff0c\u5176\u4e2d\u5f71\u54cd\u7684\u53c2\u6570\u662f <code>NoSchedule</code>\uff0c\u8868\u793a Pod \u4e0d\u4f1a\u88ab\u8c03\u5ea6\u5230\u6807\u8bb0\u4e3a taints \u7684\u8282\u70b9\uff0c\u9664\u4e86 <code>NoSchedule</code> \u5916\uff0c\u8fd8\u6709\u53e6\u5916\u4e24\u4e2a\u9009\u9879\uff1a</p> <ul> <li>PreferNoSchedule\uff1aNoSchedule \u7684\u8f6f\u7b56\u7565\u7248\u672c\uff0c\u8868\u793a\u5c3d\u91cf\u4e0d\u8c03\u5ea6\u5230\u6c61\u70b9\u8282\u70b9\u4e0a\u53bb</li> <li>NoExecute\uff1a\u8be5\u9009\u9879\u610f\u5473\u7740\u4e00\u65e6 Taint \u751f\u6548\uff0c\u5982\u8be5\u8282\u70b9\u5185\u6b63\u5728\u8fd0\u884c\u7684 Pod \u6ca1\u6709\u5bf9\u5e94\u5bb9\u5fcd\uff08Tolerate\uff09\u8bbe\u7f6e\uff0c\u5219\u4f1a\u76f4\u63a5\u88ab\u9010\u51fa</li> </ul> <p>\u6c61\u70b9 taint \u6807\u8bb0\u8282\u70b9\u7684\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl taint nodes ydzs-node2 test=node2:NoSchedule\nnode \"ydzs-node2\" tainted\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u540d\u5c06 ydzs-node2 \u8282\u70b9\u6807\u8bb0\u4e3a\u4e86\u6c61\u70b9\uff0c\u5f71\u54cd\u7b56\u7565\u662f <code>NoSchedule</code>\uff0c\u53ea\u4f1a\u5f71\u54cd\u65b0\u7684 Pod \u8c03\u5ea6\uff0c\u5982\u679c\u4ecd\u7136\u5e0c\u671b\u67d0\u4e2a Pod \u8c03\u5ea6\u5230 taint \u8282\u70b9\u4e0a\uff0c\u5219\u5fc5\u987b\u5728 Spec \u4e2d\u505a\u51fa Toleration \u5b9a\u4e49\uff0c\u624d\u80fd\u8c03\u5ea6\u5230\u8be5\u8282\u70b9\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u60f3\u8981\u5c06\u4e00\u4e2a Pod \u8c03\u5ea6\u5230 master \u8282\u70b9\uff1a(taint-demo.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: taint\n  labels:\n    app: taint\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: taint\n  template:\n    metadata:\n      labels:\n        app: taint\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - name: http\n          containerPort: 80\n      tolerations:\n      - key: \"node-role.kubernetes.io/master\"\n        operator: \"Exists\"\n        effect: \"NoSchedule\"\n</code></pre> <p>\u7531\u4e8e master \u8282\u70b9\u88ab\u6807\u8bb0\u4e3a\u4e86\u6c61\u70b9\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u8981\u60f3 Pod \u80fd\u591f\u8c03\u5ea6\u5230\u6539\u8282\u70b9\u53bb\uff0c\u5c31\u9700\u8981\u589e\u52a0\u5bb9\u5fcd\u7684\u58f0\u660e\uff1a</p> <pre><code>tolerations:\n- key: \"node-role.kubernetes.io/master\"\n  operator: \"Exists\"\n  effect: \"NoSchedule\"\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\uff0c\u67e5\u770b\u7ed3\u679c\uff1a</p> <pre><code>$ kubectl apply -f taint-demo.yaml\ndeployment.apps \"taint\" created\n$ kubectl get pods -o wide\nNAME                                      READY     STATUS             RESTARTS   AGE       IP             NODE\n......\ntaint-845d8bb4fb-57mhm                    1/1       Running            0          1m        2247   ydzs-node2\ntaint-845d8bb4fb-bbvmp                    1/1       Running            0          1m        233    ydzs-master\ntaint-845d8bb4fb-zb78x                    1/1       Running            0          1m        2246   ydzs-node2\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a Pod \u526f\u672c\u88ab\u8c03\u5ea6\u5230\u4e86 master \u8282\u70b9\uff0c\u8fd9\u5c31\u662f\u5bb9\u5fcd\u7684\u4f7f\u7528\u65b9\u6cd5\u3002</p> <p>\u5bf9\u4e8e <code>tolerations</code> \u5c5e\u6027\u7684\u5199\u6cd5\uff0c\u5176\u4e2d\u7684 key\u3001value\u3001effect \u4e0e Node \u7684 Taint \u8bbe\u7f6e\u9700\u4fdd\u6301\u4e00\u81f4\uff0c \u8fd8\u6709\u4ee5\u4e0b\u51e0\u70b9\u8bf4\u660e\uff1a</p> <ul> <li>\u5982\u679c operator \u7684\u503c\u662f <code>Exists</code>\uff0c\u5219 value \u5c5e\u6027\u53ef\u7701\u7565</li> <li>\u5982\u679c operator \u7684\u503c\u662f <code>Equal</code>\uff0c\u5219\u8868\u793a\u5176 key \u4e0e value \u4e4b\u95f4\u7684\u5173\u7cfb\u662f equal(\u7b49\u4e8e)</li> <li>\u5982\u679c\u4e0d\u6307\u5b9a operator \u5c5e\u6027\uff0c\u5219\u9ed8\u8ba4\u503c\u4e3a <code>Equal</code></li> </ul> <p>\u53e6\u5916\uff0c\u8fd8\u6709\u4e24\u4e2a\u7279\u6b8a\u503c\uff1a</p> <ul> <li>\u7a7a\u7684 key \u5982\u679c\u518d\u914d\u5408 <code>Exists</code> \u5c31\u80fd\u5339\u914d\u6240\u6709\u7684 key \u4e0e value\uff0c\u4e5f\u5c31\u662f\u662f\u80fd\u5bb9\u5fcd\u6240\u6709\u8282\u70b9\u7684\u6240\u6709 Taints</li> <li>\u7a7a\u7684 effect \u5339\u914d\u6240\u6709\u7684 effect</li> </ul> <p>\u6700\u540e\u5982\u679c\u6211\u4eec\u8981\u53d6\u6d88\u8282\u70b9\u7684\u6c61\u70b9\u6807\u8bb0\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl taint nodes ydzs-node2 test-\nnode \"ydzs-node2\" untainted\n</code></pre>"},{"location":"kubernetes_security/admission/","title":"\u51c6\u5165\u63a7\u5236\u5668","text":""},{"location":"kubernetes_security/admission/#_1","title":"\u51c6\u5165\u63a7\u5236\u5668","text":"<p>Kubernetes \u63d0\u4f9b\u4e86\u9700\u8981\u6269\u5c55\u5176\u5185\u7f6e\u529f\u80fd\u7684\u65b9\u6cd5\uff0c\u6700\u5e38\u7528\u7684\u53ef\u80fd\u662f\u81ea\u5b9a\u4e49\u8d44\u6e90\u7c7b\u578b\u548c\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u4e86\uff0c\u9664\u6b64\u4e4b\u5916\uff0cKubernetes \u8fd8\u6709\u4e00\u4e9b\u5176\u4ed6\u975e\u5e38\u6709\u8da3\u7684\u529f\u80fd\uff0c\u6bd4\u5982 <code>admission webhooks</code> \u5c31\u53ef\u4ee5\u7528\u4e8e\u6269\u5c55 API\uff0c\u7528\u4e8e\u4fee\u6539\u67d0\u4e9b Kubernetes \u8d44\u6e90\u7684\u57fa\u672c\u884c\u4e3a\u3002</p> <p>\u51c6\u5165\u63a7\u5236\u5668\u662f\u5728\u5bf9\u8c61\u6301\u4e45\u5316\u4e4b\u524d\u7528\u4e8e\u5bf9 Kubernetes API Server \u7684\u8bf7\u6c42\u8fdb\u884c\u62e6\u622a\u7684\u4ee3\u7801\u6bb5\uff0c\u5728\u8bf7\u6c42\u7ecf\u8fc7<code>\u8eab\u4efd\u9a8c\u8bc1</code>\u548c<code>\u6388\u6743\u4e4b\u540e</code>\u653e\u884c\u901a\u8fc7\u3002\u51c6\u5165\u63a7\u5236\u5668\u53ef\u80fd\u6b63\u5728 <code>validating</code>\u3001<code>mutating</code> \u6216\u8005\u90fd\u5728\u6267\u884c\uff0c<code>Mutating</code> \u63a7\u5236\u5668\u53ef\u4ee5\u4fee\u6539\u4ed6\u4eec\u5904\u7406\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c<code>Validating</code> \u63a7\u5236\u5668\u4e0d\u4f1a\uff0c\u5982\u679c\u4efb\u4f55\u4e00\u4e2a\u9636\u6bb5\u4e2d\u7684\u4efb\u4f55\u63a7\u5236\u5668\u62d2\u7edd\u4e86\u8bf7\u6c42\uff0c\u5219\u4f1a\u7acb\u5373\u62d2\u7edd\u6574\u4e2a\u8bf7\u6c42\uff0c\u5e76\u5c06\u9519\u8bef\u8fd4\u56de\u7ed9\u6700\u7ec8\u7684\u7528\u6237\u3002</p> <p>\u8fd9\u610f\u5473\u7740\u6709\u4e00\u4e9b\u7279\u6b8a\u7684\u63a7\u5236\u5668\u53ef\u4ee5\u62e6\u622a Kubernetes API \u8bf7\u6c42\uff0c\u5e76\u6839\u636e\u81ea\u5b9a\u4e49\u7684\u903b\u8f91\u4fee\u6539\u6216\u8005\u62d2\u7edd\u5b83\u4eec\u3002Kubernetes \u6709\u81ea\u5df1\u5b9e\u73b0\u7684\u4e00\u4e2a\u63a7\u5236\u5668\u5217\u8868\uff1ahttps://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-do\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u7f16\u5199\u81ea\u5df1\u7684\u63a7\u5236\u5668\uff0c\u867d\u7136\u8fd9\u4e9b\u63a7\u5236\u5668\u542c\u8d77\u6765\u529f\u80fd\u6bd4\u8f83\u5f3a\u5927\uff0c\u4f46\u662f\u8fd9\u4e9b\u63a7\u5236\u5668\u9700\u8981\u88ab\u7f16\u8bd1\u8fdb kube-apiserver\uff0c\u5e76\u4e14\u53ea\u80fd\u5728 apiserver \u542f\u52a8\u65f6\u542f\u52a8\u3002</p> <p>\u7531\u4e8e\u4e0a\u9762\u7684\u63a7\u5236\u5668\u7684\u9650\u5236\uff0c\u6211\u4eec\u5c31\u9700\u8981\u7528\u5230<code>\u52a8\u6001</code>\u7684\u6982\u5ff5\u4e86\uff0c\u800c\u4e0d\u662f\u548c apiserver \u8026\u5408\u5728\u4e00\u8d77\uff0c<code>Admission webhooks</code> \u5c31\u901a\u8fc7\u4e00\u79cd\u52a8\u6001\u914d\u7f6e\u65b9\u6cd5\u89e3\u51b3\u4e86\u8fd9\u4e2a\u9650\u5236\u95ee\u9898\u3002</p>"},{"location":"kubernetes_security/admission/#admission_webhook","title":"admission webhook \u662f\u4ec0\u4e48?","text":"<p>\u5728 Kubernetes apiserver \u4e2d\u5305\u542b\u4e24\u4e2a\u7279\u6b8a\u7684\u51c6\u5165\u63a7\u5236\u5668\uff1a</p> <pre><code>MutatingAdmissionWebhook\n</code></pre> <p>\u548c</p> <pre><code>ValidatingAdmissionWebhook\n</code></pre> <p>\uff0c\u8fd9\u4e24\u4e2a\u63a7\u5236\u5668\u5c06\u53d1\u9001\u51c6\u5165\u8bf7\u6c42\u5230\u5916\u90e8\u7684 HTTP \u56de\u8c03\u670d\u52a1\u5e76\u63a5\u6536\u4e00\u4e2a\u51c6\u5165\u54cd\u5e94\u3002\u5982\u679c\u542f\u7528\u4e86\u8fd9\u4e24\u4e2a\u51c6\u5165\u63a7\u5236\u5668\uff0cKubernetes \u7ba1\u7406\u5458\u53ef\u4ee5\u5728\u96c6\u7fa4\u4e2d\u521b\u5efa\u548c\u914d\u7f6e\u4e00\u4e2a admission webhook\u3002</p> <p></p> <p>\u6574\u4f53\u7684\u6b65\u9aa4\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li> <ol> <li>\u68c0\u67e5\u96c6\u7fa4\u4e2d\u662f\u5426\u542f\u7528\u4e86 admission webhook \u63a7\u5236\u5668\uff0c\u5e76\u6839\u636e\u9700\u8981\u8fdb\u884c\u914d\u7f6e\u3002</li> </ol> </li> <li> <ol> <li>\u7f16\u5199\u5904\u7406\u51c6\u5165\u8bf7\u6c42\u7684 HTTP \u56de\u8c03\uff0c\u56de\u8c03\u53ef\u4ee5\u662f\u4e00\u4e2a\u90e8\u7f72\u5728\u96c6\u7fa4\u4e2d\u7684\u7b80\u5355 HTTP \u670d\u52a1\uff0c\u751a\u81f3\u4e5f\u53ef\u4ee5\u662f\u4e00\u4e2a <code>serverless</code> \u51fd\u6570\uff0c\u4f8b\u5982 https://github.com/kelseyhightower/denyenv-validating-admission-webhook \u8fd9\u4e2a\u9879\u76ee\u3002</li> </ol> </li> <li> <ol> <li> <p>\u901a\u8fc7 </p> <pre><code>MutatingWebhookConfiguration\n</code></pre> <p>\u548c </p> <pre><code>ValidatingWebhookConfiguration\n</code></pre> <p>\u8d44\u6e90\u914d\u7f6e admission webhook\u3002</p> </li> </ol> </li> </ul> <p>\u8fd9\u4e24\u79cd\u7c7b\u578b\u7684 admission webhook \u4e4b\u95f4\u7684\u533a\u522b\u662f\u975e\u5e38\u660e\u663e\u7684\uff1a<code>validating webhooks</code> \u53ef\u4ee5\u62d2\u7edd\u8bf7\u6c42\uff0c\u4f46\u662f\u5b83\u4eec\u5374\u4e0d\u80fd\u4fee\u6539\u51c6\u5165\u8bf7\u6c42\u4e2d\u83b7\u53d6\u7684\u5bf9\u8c61\uff0c\u800c <code>mutating webhooks</code> \u53ef\u4ee5\u5728\u8fd4\u56de\u51c6\u5165\u54cd\u5e94\u4e4b\u524d\u901a\u8fc7\u521b\u5efa\u8865\u4e01\u6765\u4fee\u6539\u5bf9\u8c61\uff0c\u5982\u679c webhook \u62d2\u7edd\u4e86\u4e00\u4e2a\u8bf7\u6c42\uff0c\u5219\u4f1a\u5411\u6700\u7ec8\u7528\u6237\u8fd4\u56de\u9519\u8bef\u3002</p> <p>\u73b0\u5728\u975e\u5e38\u706b\u70ed\u7684\u7684 Service Mesh \u5e94\u7528 <code>istio</code> \u5c31\u662f\u901a\u8fc7 mutating webhooks \u6765\u81ea\u52a8\u5c06 <code>Envoy</code> \u8fd9\u4e2a sidecar \u5bb9\u5668\u6ce8\u5165\u5230 Pod \u4e2d\u53bb\u7684\uff1ahttps://istio.io/docs/setup/kubernetes/sidecar-injection/\u3002</p>"},{"location":"kubernetes_security/admission/#admission_webhook_1","title":"\u521b\u5efa\u914d\u7f6e\u4e00\u4e2a Admission Webhook","text":"<p>\u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86 Admission Webhook \u7684\u7406\u8bba\u77e5\u8bc6\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5728\u4e00\u4e2a\u771f\u5b9e\u7684 Kubernetes \u96c6\u7fa4\u4e2d\u6765\u5b9e\u9645\u6d4b\u8bd5\u4f7f\u7528\u4e0b\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a webhook \u7684 webserver\uff0c\u5c06\u5176\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\uff0c\u7136\u540e\u521b\u5efa webhook \u914d\u7f6e\u67e5\u770b\u662f\u5426\u751f\u6548\u3002</p> <p>\u9996\u5148\u786e\u4fdd\u5728 apiserver \u4e2d\u542f\u7528\u4e86 </p> <pre><code>MutatingAdmissionWebhook\n</code></pre> <p>\u548c </p> <pre><code>ValidatingAdmissionWebhook\n</code></pre> <p>\u8fd9\u4e24\u4e2a\u63a7\u5236\u5668\uff0c\u7531\u4e8e\u6211\u8fd9\u91cc\u96c6\u7fa4\u4f7f\u7528\u7684\u662f kubeadm \u642d\u5efa\u7684\uff0c\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b apiserver Pod \u7684\u914d\u7f6e\uff1a</p> <pre><code>$ kubectl get pods kube-apiserver-ydzs-master -n kube-system -o yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  labels:\n    component: kube-apiserver\n    tier: control-plane\n  name: kube-apiserver-ydzs-master\n  namespace: kube-system\n......\nspec:\n  containers:\n  - command:\n    - kube-apiserver\n    - --advertise-address=111\n    - --allow-privileged=true\n    - --authorization-mode=Node,RBAC\n    - --client-ca-file=/etc/kubernetes/pki/ca.crt\n    - --enable-admission-plugins=NodeRestriction,MutatingAdmissionWebhook,ValidatingAdmissionWebhook\n......\n</code></pre> <p>\u4e0a\u9762\u7684 </p> <pre><code>enable-admission-plugins\n</code></pre> <p>\u53c2\u6570\u4e2d\u5e26\u4e0a\u4e86 </p> <pre><code>MutatingAdmissionWebhook\n</code></pre> <p>\u548c</p> <pre><code>ValidatingAdmissionWebhook\n</code></pre> <p>\u4e24\u4e2a\u51c6\u5165\u63a7\u5236\u63d2\u4ef6\uff0c\u5982\u679c\u6ca1\u6709\u7684\uff08\u5f53\u524d v1.26.2 \u7248\u672c\u9ed8\u8ba4\u5df2\u7ecf\u5f00\u542f\uff09\uff0c\u9700\u8981\u6dfb\u52a0\u4e0a\u8fd9\u4e24\u4e2a\u53c2\u6570\uff0c\u7136\u540e\u91cd\u542f apiserver\u3002</p> <p>\u7136\u540e\u901a\u8fc7\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u68c0\u67e5\u96c6\u7fa4\u4e2d\u662f\u5426\u542f\u7528\u4e86\u51c6\u5165\u6ce8\u518c API\uff1a</p> <pre><code>$ kubectl api-versions |grep admission\n\nadmissionregistration.k8s.io/v1beta1\n</code></pre>"},{"location":"kubernetes_security/admission/#webhook","title":"\u7f16\u5199 webhook","text":"<p>\u6ee1\u8db3\u4e86\u524d\u9762\u7684\u5148\u51b3\u6761\u4ef6\u540e\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5b9e\u73b0\u4e00\u4e2a webhook \u793a\u4f8b\uff0c\u901a\u8fc7\u76d1\u542c\u4e24\u4e2a\u4e0d\u540c\u7684 HTTP \u7aef\u70b9\uff08validate \u548c mutate\uff09\u6765\u8fdb\u884c <code>validating</code> \u548c <code>mutating webhook</code> \u9a8c\u8bc1\u3002</p> <p>\u8fd9\u4e2a webhook \u7684\u5b8c\u6574\u4ee3\u7801\u53ef\u4ee5\u5728 Github \u4e0a\u83b7\u53d6\uff1ahttps://github.com/cnych/admission-webhook-example\uff0c\u8be5\u4ed3\u5e93 Fork \u81ea\u9879\u76ee https://github.com/banzaicloud/admission-webhook-example\u3002\u8fd9\u4e2a webhook \u662f\u4e00\u4e2a\u7b80\u5355\u7684\u5e26 TLS \u8ba4\u8bc1\u7684 HTTP \u670d\u52a1\uff0c\u7528 Deployment \u65b9\u5f0f\u90e8\u7f72\u5728\u6211\u4eec\u7684\u96c6\u7fa4\u4e2d\u3002</p> <p>\u4ee3\u7801\u4e2d\u4e3b\u8981\u7684\u903b\u8f91\u5728\u4e24\u4e2a\u6587\u4ef6\u4e2d\uff1a<code>main.go</code> \u548c <code>webhook.go</code>\uff0cmain.go \u6587\u4ef6\u5305\u542b\u521b\u5efa HTTP \u670d\u52a1\u7684\u4ee3\u7801\uff0c\u800cwebhook.go \u5305\u542b validates \u548c mutates \u4e24\u4e2a webhook \u7684\u903b\u8f91\uff0c\u5927\u90e8\u5206\u4ee3\u7801\u90fd\u6bd4\u8f83\u7b80\u5355\uff0c\u9996\u5148\u67e5\u770b main.go \u6587\u4ef6\uff0c\u67e5\u770b\u5982\u4f55\u4f7f\u7528\u6807\u51c6 golang \u5305\u6765\u542f\u52a8 HTTP \u670d\u52a1\uff0c\u4ee5\u53ca\u5982\u4f55\u4ece\u547d\u4ee4\u884c\u6807\u5fd7\u4e2d\u8bfb\u53d6 TLS \u914d\u7f6e\u7684\u8bc1\u4e66\uff1a</p> <pre><code>flag.StringVar(&amp;parameters.certFile, \"tlsCertFile\", \"/etc/webhook/certs/cert.pem\", \"File containing the x509 Certificate for HTTPS.\")\nflag.StringVar(&amp;parameters.keyFile, \"tlsKeyFile\", \"/etc/webhook/certs/key.pem\", \"File containing the x509 private key to --tlsCertFile.\")\n</code></pre> <p>\u7136\u540e\u4e00\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u662f serve \u51fd\u6570\uff0c\u7528\u6765\u5904\u7406\u4f20\u5165\u7684 mutate \u548c validating \u51fd\u6570 \u7684 HTTP \u8bf7\u6c42\u3002\u8be5\u51fd\u6570\u4ece\u8bf7\u6c42\u4e2d\u53cd\u5e8f\u5217\u5316 <code>AdmissionReview</code> \u5bf9\u8c61\uff0c\u6267\u884c\u4e00\u4e9b\u57fa\u672c\u7684\u5185\u5bb9\u6821\u9a8c\uff0c\u6839\u636e URL \u8def\u5f84\u8c03\u7528\u76f8\u5e94\u7684 mutate \u548c validate \u51fd\u6570\uff0c\u7136\u540e\u5e8f\u5217\u5316 AdmissionReview \u5bf9\u8c61\uff1a</p> <pre><code>func (whsvr *WebhookServer) serve(w http.ResponseWriter, r *http.Request) {\n    var body []byte\n    if r.Body != nil {\n        if data, err := ioutil.ReadAll(r.Body); err == nil {\n            body = data\n        }\n    }\n    if len(body) == 0 {\n        glog.Error(\"empty body\")\n        http.Error(w, \"empty body\", http.StatusBadRequest)\n        return\n    }\n\n    // \u6821\u9a8c Content-Type\n    contentType := r.Header.Get(\"Content-Type\")\n    if contentType != \"application/json\" {\n        glog.Errorf(\"Content-Type=%s, expect application/json\", contentType)\n        http.Error(w, \"invalid Content-Type, expect `application/json`\", http.StatusUnsupportedMediaType)\n        return\n    }\n\n    var admissionResponse *v1betaAdmissionResponse\n    ar := v1betaAdmissionReview{}\n    if _, _, err := deserializer.Decode(body, nil, &amp;ar); err != nil {\n        glog.Errorf(\"Can't decode body: %v\", err)\n        admissionResponse = &amp;v1betaAdmissionResponse{\n            Result: &amp;metavStatus{\n                Message: err.Error(),\n            },\n        }\n    } else {\n        fmt.Println(r.URL.Path)\n        if r.URL.Path == \"/mutate\" {\n            admissionResponse = whsvr.mutate(&amp;ar)\n        } else if r.URL.Path == \"/validate\" {\n            admissionResponse = whsvr.validate(&amp;ar)\n        }\n    }\n\n    admissionReview := v1betaAdmissionReview{}\n    if admissionResponse != nil {\n        admissionReview.Response = admissionResponse\n        if ar.Request != nil {\n            admissionReview.Response.UID = ar.Request.UID\n        }\n    }\n\n    resp, err := json.Marshal(admissionReview)\n    if err != nil {\n        glog.Errorf(\"Can't encode response: %v\", err)\n        http.Error(w, fmt.Sprintf(\"could not encode response: %v\", err), http.StatusInternalServerError)\n    }\n    glog.Infof(\"Ready to write reponse ...\")\n    if _, err := w.Write(resp); err != nil {\n        glog.Errorf(\"Can't write response: %v\", err)\n        http.Error(w, fmt.Sprintf(\"could not write response: %v\", err), http.StatusInternalServerError)\n    }\n}\n</code></pre> <p>\u4e3b\u8981\u7684\u51c6\u5165\u903b\u8f91\u662f validate \u548c mutate \u4e24\u4e2a\u51fd\u6570\u3002validate \u51fd\u6570\u68c0\u67e5\u8d44\u6e90\u5bf9\u8c61\u662f\u5426\u9700\u8981\u6821\u9a8c\uff1a\u4e0d\u9a8c\u8bc1 kube-system \u548c kube-public \u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u8d44\u6e90\uff0c\u5982\u679c\u60f3\u8981\u663e\u793a\u7684\u58f0\u660e\u4e0d\u9a8c\u8bc1\u67d0\u4e2a\u8d44\u6e90\uff0c\u53ef\u4ee5\u901a\u8fc7\u5728\u8d44\u6e90\u5bf9\u8c61\u4e2d\u6dfb\u52a0\u4e00\u4e2a </p> <pre><code>admission-webhook-example.qikqiak.com/validate=false\n</code></pre> <p>\u7684 annotation \u8fdb\u884c\u58f0\u660e\u3002\u5982\u679c\u9700\u8981\u9a8c\u8bc1\uff0c\u5219\u6839\u636e\u8d44\u6e90\u7c7b\u578b\u7684 kind\uff0c\u548c\u6807\u7b7e\u4e0e\u5176\u5bf9\u5e94\u9879\u8fdb\u884c\u6bd4\u8f83\uff0c\u5c06 service \u6216\u8005 deployment \u8d44\u6e90\u4ece\u8bf7\u6c42\u4e2d\u53cd\u5e8f\u5217\u5316\u51fa\u6765\u3002\u5982\u679c\u7f3a\u5c11\u67d0\u4e9b label \u6807\u7b7e\uff0c\u5219\u54cd\u5e94\u4e2d\u7684 Allowed \u4f1a\u88ab\u8bbe\u7f6e\u4e3a false\u3002\u5982\u679c\u9a8c\u8bc1\u5931\u8d25\uff0c\u5219\u4f1a\u5728\u54cd\u5e94\u4e2d\u5199\u5165\u5931\u8d25\u539f\u56e0\uff0c\u6700\u7ec8\u7528\u6237\u5728\u5c1d\u8bd5\u521b\u5efa\u8d44\u6e90\u65f6\u4f1a\u6536\u5230\u5931\u8d25\u7684\u4fe1\u606f\u3002validate \u51fd\u6570\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// validate deployments and services\nfunc (whsvr *WebhookServer) validate(ar *v1betaAdmissionReview) *v1betaAdmissionResponse {\n    req := ar.Request\n    var (\n        availableLabels                 map[string]string\n        objectMeta                      *metavObjectMeta\n        resourceNamespace, resourceName string\n    )\n\n    glog.Infof(\"AdmissionReview for Kind=%v, Namespace=%v Name=%v (%v) UID=%v patchOperation=%v UserInfo=%v\",\n        req.Kind, req.Namespace, req.Name, resourceName, req.UID, req.Operation, req.UserInfo)\n\n    switch req.Kind.Kind {\n    case \"Deployment\":\n        var deployment appsvDeployment\n        if err := json.Unmarshal(req.Object.Raw, &amp;deployment); err != nil {\n            glog.Errorf(\"Could not unmarshal raw object: %v\", err)\n            return &amp;v1betaAdmissionResponse{\n                Result: &amp;metavStatus{\n                    Message: err.Error(),\n                },\n            }\n        }\n        resourceName, resourceNamespace, objectMeta = deployment.Name, deployment.Namespace, &amp;deployment.ObjectMeta\n        availableLabels = deployment.Labels\n    case \"Service\":\n        var service corevService\n        if err := json.Unmarshal(req.Object.Raw, &amp;service); err != nil {\n            glog.Errorf(\"Could not unmarshal raw object: %v\", err)\n            return &amp;v1betaAdmissionResponse{\n                Result: &amp;metavStatus{\n                    Message: err.Error(),\n                },\n            }\n        }\n        resourceName, resourceNamespace, objectMeta = service.Name, service.Namespace, &amp;service.ObjectMeta\n        availableLabels = service.Labels\n    }\n\n    if !validationRequired(ignoredNamespaces, objectMeta) {\n        glog.Infof(\"Skipping validation for %s/%s due to policy check\", resourceNamespace, resourceName)\n        return &amp;v1betaAdmissionResponse{\n            Allowed: true,\n        }\n    }\n\n    allowed := true\n    var result *metavStatus\n    glog.Info(\"available labels:\", availableLabels)\n    glog.Info(\"required labels\", requiredLabels)\n    for _, rl := range requiredLabels {\n        if _, ok := availableLabels[rl]; !ok {\n            allowed = false\n            result = &amp;metavStatus{\n                Reason: \"required labels are not set\",\n            }\n            break\n        }\n    }\n\n    return &amp;v1betaAdmissionResponse{\n        Allowed: allowed,\n        Result:  result,\n    }\n}\n</code></pre> <p>\u5224\u65ad\u662f\u5426\u9700\u8981\u8fdb\u884c\u6821\u9a8c\u7684\u65b9\u6cd5\u5982\u4e0b\uff0c\u53ef\u4ee5\u901a\u8fc7 namespace \u8fdb\u884c\u5ffd\u7565\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7 annotations \u8bbe\u7f6e\u8fdb\u884c\u914d\u7f6e\uff1a</p> <pre><code>func validationRequired(ignoredList []string, metadata *metavObjectMeta) bool {\n    required := admissionRequired(ignoredList, admissionWebhookAnnotationValidateKey, metadata)\n    glog.Infof(\"Validation policy for %v/%v: required:%v\", metadata.Namespace, metadata.Name, required)\n    return required\n}\n\nfunc admissionRequired(ignoredList []string, admissionAnnotationKey string, metadata *metavObjectMeta) bool {\n    // skip special kubernetes system namespaces\n    for _, namespace := range ignoredList {\n        if metadata.Namespace == namespace {\n            glog.Infof(\"Skip validation for %v for it's in special namespace:%v\", metadata.Name, metadata.Namespace)\n            return false\n        }\n    }\n\n    annotations := metadata.GetAnnotations()\n    if annotations == nil {\n        annotations = map[string]string{}\n    }\n\n    var required bool\n    switch strings.ToLower(annotations[admissionAnnotationKey]) {\n    default:\n        required = true\n    case \"n\", \"no\", \"false\", \"off\":\n        required = false\n    }\n    return required\n}\n</code></pre> <p>mutate \u51fd\u6570\u7684\u4ee3\u7801\u662f\u975e\u5e38\u7c7b\u4f3c\u7684\uff0c\u4f46\u4e0d\u662f\u4ec5\u4ec5\u6bd4\u8f83\u6807\u7b7e\u5e76\u5728\u54cd\u5e94\u4e2d\u8bbe\u7f6e Allowed\uff0c\u800c\u662f\u521b\u5efa\u4e00\u4e2a\u8865\u4e01\uff0c\u5c06\u7f3a\u5931\u7684\u6807\u7b7e\u6dfb\u52a0\u5230\u8d44\u6e90\u4e2d\uff0c\u5e76\u5c06 not_available \u8bbe\u7f6e\u4e3a\u6807\u7b7e\u7684\u503c\u3002</p> <pre><code>// main mutation process\nfunc (whsvr *WebhookServer) mutate(ar *v1betaAdmissionReview) *v1betaAdmissionResponse {\n    req := ar.Request\n    var (\n        availableLabels, availableAnnotations map[string]string\n        objectMeta                            *metavObjectMeta\n        resourceNamespace, resourceName       string\n    )\n\n    glog.Infof(\"AdmissionReview for Kind=%v, Namespace=%v Name=%v (%v) UID=%v patchOperation=%v UserInfo=%v\",\n        req.Kind, req.Namespace, req.Name, resourceName, req.UID, req.Operation, req.UserInfo)\n\n    switch req.Kind.Kind {\n    case \"Deployment\":\n        var deployment appsvDeployment\n        if err := json.Unmarshal(req.Object.Raw, &amp;deployment); err != nil {\n            glog.Errorf(\"Could not unmarshal raw object: %v\", err)\n            return &amp;v1betaAdmissionResponse{\n                Result: &amp;metavStatus{\n                    Message: err.Error(),\n                },\n            }\n        }\n        resourceName, resourceNamespace, objectMeta = deployment.Name, deployment.Namespace, &amp;deployment.ObjectMeta\n        availableLabels = deployment.Labels\n    case \"Service\":\n        var service corevService\n        if err := json.Unmarshal(req.Object.Raw, &amp;service); err != nil {\n            glog.Errorf(\"Could not unmarshal raw object: %v\", err)\n            return &amp;v1betaAdmissionResponse{\n                Result: &amp;metavStatus{\n                    Message: err.Error(),\n                },\n            }\n        }\n        resourceName, resourceNamespace, objectMeta = service.Name, service.Namespace, &amp;service.ObjectMeta\n        availableLabels = service.Labels\n    }\n\n    if !mutationRequired(ignoredNamespaces, objectMeta) {\n        glog.Infof(\"Skipping validation for %s/%s due to policy check\", resourceNamespace, resourceName)\n        return &amp;v1betaAdmissionResponse{\n            Allowed: true,\n        }\n    }\n\n    annotations := map[string]string{admissionWebhookAnnotationStatusKey: \"mutated\"}\n    patchBytes, err := createPatch(availableAnnotations, annotations, availableLabels, addLabels)\n    if err != nil {\n        return &amp;v1betaAdmissionResponse{\n            Result: &amp;metavStatus{\n                Message: err.Error(),\n            },\n        }\n    }\n\n    glog.Infof(\"AdmissionResponse: patch=%v\\\\n\", string(patchBytes))\n    return &amp;v1betaAdmissionResponse{\n        Allowed: true,\n        Patch:   patchBytes,\n        PatchType: func() *v1betaPatchType {\n            pt := v1betaPatchTypeJSONPatch\n            return &amp;pt\n        }(),\n    }\n}\n</code></pre>"},{"location":"kubernetes_security/admission/#_2","title":"\u6784\u5efa","text":"<p>\u5176\u5b9e\u6211\u4eec\u5df2\u7ecf\u5c06\u4ee3\u7801\u6253\u5305\u6210\u4e00\u4e2a docker \u955c\u50cf\u4e86\uff0c\u4f60\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\uff0c\u955c\u50cf\u4ed3\u5e93\u5730\u5740\u4e3a\uff1a</p> <pre><code>cnych/admission-webhook-example:v1\n</code></pre> <p>\u3002\u5f53\u7136\u5982\u679c\u4f60\u5e0c\u671b\u66f4\u6539\u90e8\u5206\u4ee3\u7801\uff0c\u90a3\u5c31\u9700\u8981\u91cd\u65b0\u6784\u5efa\u9879\u76ee\u4e86\uff0c\u7531\u4e8e\u8fd9\u4e2a\u9879\u76ee\u91c7\u7528 go \u8bed\u8a00\u5f00\u53d1\uff0c\u5305\u7ba1\u7406\u5de5\u5177\u66f4\u6539\u4e3a\u4e86 <code>go mod</code>\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u786e\u4fdd\u6784\u5efa\u73af\u5883\u63d0\u524d\u5b89\u88c5\u597d go \u73af\u5883\uff0c\u5f53\u7136 docker \u4e5f\u662f\u5fc5\u4e0d\u53ef\u5c11\u7684\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u7684\u662f\u6253\u5305\u6210\u4e00\u4e2a docker \u955c\u50cf\u3002</p> <p>\u83b7\u53d6\u9879\u76ee\uff1a</p> <pre><code>$ mkdir admission-webhook &amp;&amp; cd admission-webhook\n$ git clone https://github.com/cnych/admission-webhook-example.git\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4ee3\u7801\u6839\u76ee\u5f55\u4e0b\u9762\u6709\u4e00\u4e2a build \u7684\u811a\u672c\uff0c\u53ea\u9700\u8981\u63d0\u4f9b\u6211\u4eec\u81ea\u5df1\u7684 docker \u955c\u50cf\u7528\u6237\u540d\u7136\u540e\u76f4\u63a5\u6784\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ export DOCKER_USER=cnych\n$ ./build\n</code></pre>"},{"location":"kubernetes_security/admission/#_3","title":"\u90e8\u7f72","text":"<p>\u4e3a\u4e86\u90e8\u7f72 webhook server\uff0c\u6211\u4eec\u9700\u8981\u5728\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\u4e2d\u521b\u5efa\u4e00\u4e2a service \u548c deployment \u8d44\u6e90\u5bf9\u8c61\uff0c\u90e8\u7f72\u662f\u975e\u5e38\u7b80\u5355\u7684\uff0c\u53ea\u662f\u9700\u8981\u914d\u7f6e\u670d\u52a1\u7684 TLS \u914d\u7f6e\u3002\u6211\u4eec\u53ef\u4ee5\u5728\u4ee3\u7801\u6839\u76ee\u5f55\u4e0b\u9762\u7684 deployment \u6587\u4ef6\u5939\u4e0b\u9762\u67e5\u770b<code>deployment.yaml</code> \u6587\u4ef6\u4e2d\u5173\u4e8e\u8bc1\u4e66\u7684\u914d\u7f6e\u58f0\u660e\uff0c\u4f1a\u53d1\u73b0\u4ece\u547d\u4ee4\u884c\u53c2\u6570\u4e2d\u8bfb\u53d6\u7684\u8bc1\u4e66\u548c\u79c1\u94a5\u6587\u4ef6\u662f\u901a\u8fc7\u4e00\u4e2a secret \u5bf9\u8c61\u6302\u8f7d\u8fdb\u6765\u7684\uff1a</p> <pre><code>args:\n    - -tlsCertFile=/etc/webhook/certs/cert.pem\n    - -tlsKeyFile=/etc/webhook/certs/key.pem\n[...]\n    volumeMounts:\n    - name: webhook-certs\n        mountPath: /etc/webhook/certs\n        readOnly: true\nvolumes:\n- name: webhook-certs\n  secret:\n  secretName: admission-webhook-example-certs\n</code></pre> <p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5bf9\u4e8e TLS \u8bc1\u4e66\uff08\u7279\u522b\u662f\u79c1\u94a5\uff09\u7684\u5904\u7406\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u7c7b\u4f3c\u4e8e <code>cert-manager</code> \u4e4b\u7c7b\u7684\u5de5\u5177\u6765\u81ea\u52a8\u5904\u7406 TLS \u8bc1\u4e66\uff0c\u6216\u8005\u5c06\u79c1\u94a5\u5bc6\u94a5\u5b58\u50a8\u5728 Vault \u4e2d\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u5b58\u5728 secret \u8d44\u6e90\u5bf9\u8c61\u4e2d\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u7c7b\u578b\u7684\u8bc1\u4e66\uff0c\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u8bbe\u7f6e\u7684 CA \u8bc1\u4e66\u662f\u9700\u8981\u8ba9 apiserver \u80fd\u591f\u9a8c\u8bc1\u7684\uff0c\u6211\u4eec\u8fd9\u91cc\u53ef\u4ee5\u91cd\u7528 Istio \u9879\u76ee\u4e2d\u7684\u751f\u6210\u7684\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\u811a\u672c\u3002\u901a\u8fc7\u53d1\u9001\u8bf7\u6c42\u5230 apiserver\uff0c\u83b7\u53d6\u8ba4\u8bc1\u4fe1\u606f\uff0c\u7136\u540e\u4f7f\u7528\u83b7\u5f97\u7684\u7ed3\u679c\u6765\u521b\u5efa\u9700\u8981\u7684 secret \u5bf9\u8c61\u3002</p> <p>\u9996\u5148\uff0c\u8fd0\u884c\u8be5\u811a\u672c\u68c0\u67e5 secret \u5bf9\u8c61\u4e2d\u662f\u5426\u6709\u8bc1\u4e66\u548c\u79c1\u94a5\u4fe1\u606f\uff1a</p> <pre><code>$ ./deployment/webhook-create-signed-cert.sh\ncreating certs in tmpdir /var/folders/x3/wjy_1z155pdf8jg_jgpmf6kc0000gn/T/tmp.IboFfX97 \nGenerating RSA private key, 2048 bit long modulus (2 primes)\n..................+++++\n........+++++\ne is 65537 (0x010001)\ncertificatesigningrequest.certificates.k8s.io/admission-webhook-example-svc.default created\nNAME                                    AGE   REQUESTOR          CONDITION\nadmission-webhook-example-svc.default   1s    kubernetes-admin   Pending\ncertificatesigningrequest.certificates.k8s.io/admission-webhook-example-svc.default approved\nsecret/admission-webhook-example-certs created\n$ kubectl get secret admission-webhook-example-certs\nNAME                              TYPE     DATA   AGE\nadmission-webhook-example-certs   Opaque   2      28s\n</code></pre> <p>\u4e00\u65e6 secret \u5bf9\u8c61\u521b\u5efa\u6210\u529f\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u521b\u5efa deployment \u548c service \u5bf9\u8c61\u3002</p> <pre><code>$ kubectl apply -f deployment/rbac.yaml\n$ kubectl apply -f deployment/deployment.yaml\ndeployment.apps \"admission-webhook-example-deployment\" created\n$ kubectl apply -f deployment/service.yaml\nservice \"admission-webhook-example-svc\" created\n</code></pre>"},{"location":"kubernetes_security/admission/#webhook_1","title":"\u914d\u7f6e webhook","text":"<p>\u73b0\u5728\u6211\u4eec\u7684 webhook \u670d\u52a1\u8fd0\u884c\u8d77\u6765\u4e86\uff0c\u5b83\u53ef\u4ee5\u63a5\u6536\u6765\u81ea apiserver \u7684\u8bf7\u6c42\u3002\u4f46\u662f\u6211\u4eec\u8fd8\u9700\u8981\u5728 kubernetes \u4e0a\u521b\u5efa\u4e00\u4e9b\u914d\u7f6e\u8d44\u6e90\u3002\u9996\u5148\u6765\u914d\u7f6e validating \u8fd9\u4e2a webhook\uff0c\u67e5\u770b webhook \u914d\u7f6e\uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230\u5b83\u91cc\u9762\u5305\u542b\u4e00\u4e2a <code>CA_BUNDLE</code> \u7684\u5360\u4f4d\u7b26\uff1a</p> <pre><code>clientConfig:\n  service:\n        name: admission-webhook-example-svc\n        namespace: default\n        path: \"/validate\"\n    caBundle: ${CA_BUNDLE}\n</code></pre> <p>CA \u8bc1\u4e66\u5e94\u63d0\u4f9b\u7ed9 admission webhook \u914d\u7f6e\uff0c\u8fd9\u6837 apiserver \u624d\u53ef\u4ee5\u4fe1\u4efb webhook server \u63d0\u4f9b\u7684 TLS \u8bc1\u4e66\u3002\u56e0\u4e3a\u6211\u4eec\u4e0a\u9762\u5df2\u7ecf\u4f7f\u7528 Kubernetes API \u7b7e\u7f72\u4e86\u8bc1\u4e66\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u6211\u4eec\u7684 kubeconfig \u4e2d\u7684 CA \u8bc1\u4e66\u6765\u7b80\u5316\u64cd\u4f5c\u3002\u4ee3\u7801\u4ed3\u5e93\u4e2d\u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5c0f\u811a\u672c\u7528\u6765\u66ff\u6362 CA_BUNDLE \u8fd9\u4e2a\u5360\u4f4d\u7b26\uff0c\u521b\u5efa <code>validating webhook</code> \u4e4b\u524d\u8fd0\u884c\u8be5\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ cat ./deployment/validatingwebhook.yaml | ./deployment/webhook-patch-ca-bundle.sh &gt; ./deployment/validatingwebhook-ca-bundle.yaml\n</code></pre> <p>\u6267\u884c\u5b8c\u6210\u540e\u53ef\u4ee5\u67e5\u770b </p> <pre><code>validatingwebhook-ca-bundle.yaml\n</code></pre> <p>\u6587\u4ef6\u4e2d\u7684 <code>CA_BUNDLE</code> \u5360\u4f4d\u7b26\u7684\u503c\u662f\u5426\u5df2\u7ecf\u88ab\u66ff\u6362\u6389\u4e86\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f <code>clientConfig</code> \u91cc\u9762\u7684 path \u8def\u5f84\u662f <code>/validate</code>\uff0c\u56e0\u4e3a\u6211\u4eec\u4ee3\u7801\u5728\u662f\u5c06 validate \u548c mutate \u96c6\u6210\u5728\u4e00\u4e2a\u670d\u52a1\u4e2d\u7684\u3002</p> <p>\u7136\u540e\u5c31\u662f\u9700\u8981\u914d\u7f6e\u4e00\u4e9b RBAC \u89c4\u5219\uff0c\u6211\u4eec\u60f3\u5728 deployment \u6216 service \u521b\u5efa\u65f6\u62e6\u622a API \u8bf7\u6c42\uff0c\u6240\u4ee5 apiGroups \u548capiVersions \u5bf9\u5e94\u7684\u503c\u5206\u522b\u4e3a <code>apps/v1</code> \u5bf9\u5e94 deployment\uff0cv1 \u5bf9\u5e94 service\u3002</p> <p>webhook \u7684\u6700\u540e\u4e00\u90e8\u5206\u662f\u914d\u7f6e\u4e00\u4e2a <code>namespaceSelector</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u4e3a webhook \u5de5\u4f5c\u7684\u547d\u540d\u7a7a\u95f4\u5b9a\u4e49\u4e00\u4e2a selector\uff0c\u8fd9\u4e2a\u914d\u7f6e\u4e0d\u662f\u5fc5\u987b\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u6dfb\u52a0\u4e86\u4e0b\u9762\u7684\u914d\u7f6e\uff1a</p> <pre><code>namespaceSelector:\n  matchLabels:\n      admission-webhook-example: enabled\n</code></pre> <p>\u5219\u6211\u4eec\u7684 webhook \u4f1a\u53ea\u9002\u7528\u4e8e\u8bbe\u7f6e\u4e86 </p> <pre><code>admission-webhook-example=enabled\n</code></pre> <p>\u6807\u7b7e\u7684 namespaces\u3002</p> <p>\u6240\u4ee5\uff0c\u9996\u5148\u9700\u8981\u5728 default \u8fd9\u4e2a namespace \u4e2d\u6dfb\u52a0\u8be5\u6807\u7b7e\uff1a</p> <pre><code>$ kubectl label namespace default admission-webhook-example=enabled\nnamespace \"default\" labeled\n</code></pre> <p>\u6700\u540e\uff0c\u521b\u5efa\u8fd9\u4e2a validating webhook \u914d\u7f6e\u5bf9\u8c61\uff0c\u8fd9\u4f1a\u52a8\u6001\u5730\u5c06 webhook \u6dfb\u52a0\u5230 webhook \u94fe\u4e0a\uff0c\u6240\u4ee5\u4e00\u65e6\u521b\u5efa\u8d44\u6e90\uff0c\u5c31\u4f1a\u62e6\u622a\u8bf7\u6c42\u7136\u540e\u8c03\u7528\u6211\u4eec\u7684 webhook \u670d\u52a1\uff1a</p> <pre><code>$ kubectl apply -f deployment/validatingwebhook-ca-bundle.yaml\nvalidatingwebhookconfiguration.admissionregistration.k8s.io \"validation-webhook-example-cfg\" created\n</code></pre>"},{"location":"kubernetes_security/admission/#_4","title":"\u6d4b\u8bd5","text":"<p>\u73b0\u5728\u8ba9\u6211\u4eec\u521b\u5efa\u4e00\u4e2a deployment \u8d44\u6e90\u6765\u9a8c\u8bc1\u4e0b\u662f\u5426\u6709\u6548\uff0c\u4ee3\u7801\u4ed3\u5e93\u4e0b\u6709\u4e00\u4e2a <code>sleep.yaml</code> \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u76f4\u63a5\u521b\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f deployment/sleep.yaml\nError from server (required labels are not set): error when creating \"deployment/sleep.yaml\": admission webhook \"required-labels.qikqiak.com\" denied the request: required labels are not set\n</code></pre> <p>\u6b63\u5e38\u60c5\u51b5\u4e0b\u521b\u5efa\u7684\u65f6\u5019\u4f1a\u51fa\u73b0\u4e0a\u9762\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u7136\u540e\u90e8\u7f72\u53e6\u5916\u4e00\u4e2a </p> <pre><code>sleep-with-labels.yaml\n</code></pre> <p>\u7684\u8d44\u6e90\u6e05\u5355\uff1a</p> <pre><code>$ kubectl apply -f deployment/sleep-with-labels.yaml\ndeployment.apps \"sleep\" created\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u53ef\u4ee5\u6b63\u5e38\u90e8\u7f72\uff0c\u7136\u540e\u6211\u4eec\u5c06\u4e0a\u9762\u7684 deployment \u5220\u9664\uff0c\u7136\u540e\u90e8\u7f72\u53e6\u5916\u4e00\u4e2a </p> <pre><code>sleep-no-validation.yaml\n</code></pre> <p>\u8d44\u6e90\u6e05\u5355\uff0c\u8be5\u6e05\u5355\u4e2d\u4e0d\u5b58\u5728\u6240\u9700\u7684\u6807\u7b7e\uff0c\u4f46\u662f\u914d\u7f6e\u4e86 </p> <pre><code>admission-webhook-example.qikqiak.com/validate=false\n</code></pre> <p>\u8fd9\u6837\u7684 annotation\uff0c\u6240\u4ee5\u6b63\u5e38\u4e5f\u662f\u53ef\u4ee5\u6b63\u5e38\u521b\u5efa\u7684\uff1a</p> <pre><code>$ kubectl delete deployment sleep\n$ kubectl apply -f deployment/sleep-no-validation.yaml\ndeployment.apps \"sleep\" created\n</code></pre>"},{"location":"kubernetes_security/admission/#mutating_webhook","title":"\u90e8\u7f72 mutating webhook","text":"<p>\u9996\u5148\uff0c\u6211\u4eec\u5c06\u4e0a\u9762\u7684 <code>validating webhook</code> \u5220\u9664\uff0c\u9632\u6b62\u5bf9 mutating \u4ea7\u751f\u5e72\u6270\uff0c\u7136\u540e\u90e8\u7f72\u65b0\u7684\u914d\u7f6e\u3002 <code>mutating webhook</code> \u4e0e <code>validating webhook</code> \u914d\u7f6e\u57fa\u672c\u76f8\u540c\uff0c\u4f46\u662f webook server \u7684\u8def\u5f84\u662f <code>/mutate</code>\uff0c\u540c\u6837\u7684\u6211\u4eec\u4e5f\u9700\u8981\u5148\u586b\u5145\u4e0a <code>CA_BUNDLE</code> \u8fd9\u4e2a\u5360\u4f4d\u7b26\u3002</p> <pre><code>$ kubectl delete validatingwebhookconfiguration validation-webhook-example-cfg\nvalidatingwebhookconfiguration.admissionregistration.k8s.io \"validation-webhook-example-cfg\" deleted\n$ cat ./deployment/mutatingwebhook.yaml | ./deployment/webhook-patch-ca-bundle.sh &gt; ./deployment/mutatingwebhook-ca-bundle.yaml\n$ kubectl apply -f deployment/mutatingwebhook-ca-bundle.yaml\nmutatingwebhookconfiguration.admissionregistration.k8s.io \"mutating-webhook-example-cfg\" created\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u518d\u6b21\u90e8\u7f72\u4e0a\u9762\u7684 sleep \u5e94\u7528\u7a0b\u5e8f\uff0c\u7136\u540e\u67e5\u770b\u662f\u5426\u6b63\u786e\u6dfb\u52a0 label \u6807\u7b7e\uff1a</p> <pre><code>$ kubectl apply -f deployment/sleep.yaml\ndeployment.apps \"sleep\" created\n$ kubectl get deploy sleep -o yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  annotations:\n    admission-webhook-example.qikqiak.com/status: mutated\n    deployment.kubernetes.io/revision: \"1\"\n  creationTimestamp: \"2020-06-01T08:10:04Z\"\n  generation: 1\n  labels:\n    app.kubernetes.io/component: not_available\n    app.kubernetes.io/instance: not_available\n    app.kubernetes.io/managed-by: not_available\n    app.kubernetes.io/name: not_available\n    app.kubernetes.io/part-of: not_available\n    app.kubernetes.io/version: not_available\n  name: sleep\n  namespace: default\n...\n</code></pre> <p>\u6700\u540e\uff0c\u6211\u4eec\u91cd\u65b0\u521b\u5efa <code>validating webhook</code>\uff0c\u6765\u4e00\u8d77\u6d4b\u8bd5\u3002\u73b0\u5728\uff0c\u5c1d\u8bd5\u518d\u6b21\u521b\u5efa sleep \u5e94\u7528\u3002\u6b63\u5e38\u662f\u53ef\u4ee5\u521b\u5efa\u6210\u529f\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e0b admission-controllers \u7684\u6587\u6863\u3002</p> <p>\u51c6\u5165\u63a7\u5236\u5206\u4e24\u4e2a\u9636\u6bb5\u8fdb\u884c\uff0c\u7b2c\u4e00\u9636\u6bb5\uff0c\u8fd0\u884c <code>mutating admission</code> \u63a7\u5236\u5668\uff0c\u7b2c\u4e8c\u9636\u6bb5\u8fd0\u884c <code>validating admission</code> \u63a7\u5236\u5668\u3002</p> <p>\u6240\u4ee5 <code>mutating webhook</code> \u5728\u7b2c\u4e00\u9636\u6bb5\u6dfb\u52a0\u4e0a\u7f3a\u5931\u7684 labels \u6807\u7b7e\uff0c\u7136\u540e <code>validating webhook</code> \u5728\u7b2c\u4e8c\u9636\u6bb5\u5c31\u4e0d\u4f1a\u62d2\u7edd\u8fd9\u4e2a deployment \u4e86\uff0c\u56e0\u4e3a\u6807\u7b7e\u5df2\u7ecf\u5b58\u5728\u4e86\uff0c\u7528 <code>not_available</code> \u8bbe\u7f6e\u4ed6\u4eec\u7684\u503c\u3002</p> <pre><code>$ kubectl apply -f deployment/validatingwebhook-ca-bundle.yaml\nvalidatingwebhookconfiguration.admissionregistration.k8s.io \"validation-webhook-example-cfg\" created\n$ kubectl apply -f deployment/sleep.yaml\ndeployment.apps \"sleep\" created\n</code></pre>"},{"location":"kubernetes_security/rbac/","title":"RBAC","text":""},{"location":"kubernetes_security/rbac/#rbac","title":"RBAC \u6743\u9650\u63a7\u5236","text":"<p>\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u4e00\u4e9b\u5e38\u7528\u7684\u8d44\u6e90\u5bf9\u8c61\u7684\u4f7f\u7528\uff0c\u6211\u4eec\u77e5\u9053\u5bf9\u4e8e\u8d44\u6e90\u5bf9\u8c61\u7684\u64cd\u4f5c\u90fd\u662f\u901a\u8fc7 APIServer \u8fdb\u884c\u7684\uff0c\u90a3\u4e48\u96c6\u7fa4\u662f\u600e\u6837\u77e5\u9053\u6211\u4eec\u7684\u8bf7\u6c42\u5c31\u662f\u5408\u6cd5\u7684\u8bf7\u6c42\u5462\uff1f\u8fd9\u4e2a\u5c31\u9700\u8981\u4e86\u89e3 Kubernetes \u4e2d\u53e6\u5916\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u77e5\u8bc6\u70b9\u4e86\uff1a<code>RBAC</code>\uff08\u57fa\u4e8e\u89d2\u8272\u7684\u6743\u9650\u63a7\u5236\uff09\u3002</p> <p>\u7ba1\u7406\u5458\u53ef\u4ee5\u901a\u8fc7 Kubernetes API \u52a8\u6001\u914d\u7f6e\u7b56\u7565\u6765\u542f\u7528<code>RBAC</code>\uff0c\u9700\u8981\u5728 kube-apiserver \u4e2d\u6dfb\u52a0\u53c2\u6570</p> <pre><code>--authorization-mode=RBAC\n</code></pre> <p>\uff0c\u5982\u679c\u4f7f\u7528\u7684kubeadm \u5b89\u88c5\u7684\u96c6\u7fa4\u90a3\u4e48\u662f\u9ed8\u8ba4\u5f00\u542f\u4e86 <code>RBAC</code> \u7684\uff0c\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b Master \u8282\u70b9\u4e0a apiserver \u7684\u9759\u6001 Pod \u5b9a\u4e49\u6587\u4ef6\uff1a</p> <pre><code>$ cat /etc/kubernetes/manifests/kube-apiserver.yaml \n...\n    - --authorization-mode=Node,RBAC\n...\n</code></pre> <p>\u5982\u679c\u662f\u4e8c\u8fdb\u5236\u7684\u65b9\u5f0f\u642d\u5efa\u7684\u96c6\u7fa4\uff0c\u6dfb\u52a0\u8fd9\u4e2a\u53c2\u6570\u8fc7\u540e\uff0c\u8bb0\u5f97\u8981\u91cd\u542f kube-apiserver \u670d\u52a1\u3002</p>"},{"location":"kubernetes_security/rbac/#api","title":"API \u5bf9\u8c61","text":"<p>\u5728\u5b66\u4e60 <code>RBAC</code> \u4e4b\u524d\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u518d\u53bb\u7406\u89e3\u4e0b Kubernetes \u96c6\u7fa4\u4e2d\u7684\u5bf9\u8c61\uff0c\u6211\u4eec\u77e5\u9053\uff0c\u5728 Kubernetes \u96c6\u7fa4\u4e2d\uff0cKubernetes \u5bf9\u8c61\u662f\u6211\u4eec\u6301\u4e45\u5316\u7684\u5b9e\u4f53\uff0c\u5c31\u662f\u6700\u7ec8\u5b58\u5165 etcd \u4e2d\u7684\u6570\u636e\uff0c\u96c6\u7fa4\u4e2d\u901a\u8fc7\u8fd9\u4e9b\u5b9e\u4f53\u6765\u8868\u793a\u6574\u4e2a\u96c6\u7fa4\u7684\u72b6\u6001\u3002\u524d\u9762\u6211\u4eec\u90fd\u76f4\u63a5\u7f16\u5199\u7684 YAML \u6587\u4ef6\uff0c\u901a\u8fc7 kubectl \u6765\u63d0\u4ea4\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u7136\u540e\u521b\u5efa\u7684\u5bf9\u5e94\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u90a3\u4e48\u5b83\u7a76\u7adf\u662f\u5982\u4f55\u5c06\u6211\u4eec\u7684 YAML \u6587\u4ef6\u8f6c\u6362\u6210\u96c6\u7fa4\u4e2d\u7684\u4e00\u4e2a API \u5bf9\u8c61\u7684\u5462\uff1f</p> <p>\u8fd9\u4e2a\u5c31\u9700\u8981\u53bb\u4e86\u89e3\u4e0b<code>\u58f0\u660e\u5f0f API</code>\u7684\u8bbe\u8ba1\uff0cKubernetes API \u662f\u4e00\u4e2a\u4ee5 JSON \u4e3a\u4e3b\u8981\u5e8f\u5217\u5316\u65b9\u5f0f\u7684 HTTP \u670d\u52a1\uff0c\u9664\u6b64\u4e4b\u5916\u4e5f\u652f\u6301 Protocol Buffers \u5e8f\u5217\u5316\u65b9\u5f0f\uff0c\u4e3b\u8981\u7528\u4e8e\u96c6\u7fa4\u5185\u90e8\u7ec4\u4ef6\u95f4\u7684\u901a\u4fe1\u3002\u4e3a\u4e86\u53ef\u6269\u5c55\u6027\uff0cKubernetes \u5728\u4e0d\u540c\u7684 API \u8def\u5f84\uff08\u6bd4\u5982<code>/api/v1</code> \u6216\u8005 <code>/apis/batch</code>\uff09\u4e0b\u9762\u652f\u6301\u4e86\u591a\u4e2a API \u7248\u672c\uff0c\u4e0d\u540c\u7684 API \u7248\u672c\u610f\u5473\u7740\u4e0d\u540c\u7ea7\u522b\u7684\u7a33\u5b9a\u6027\u548c\u652f\u6301\uff1a</p> <ul> <li>Alpha \u7ea7\u522b\uff0c\u4f8b\u5982 <code>v1alpha1</code> \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u88ab\u7981\u7528\u7684\uff0c\u53ef\u4ee5\u968f\u65f6\u5220\u9664\u5bf9\u529f\u80fd\u7684\u652f\u6301\uff0c\u6240\u4ee5\u8981\u614e\u7528</li> <li>Beta \u7ea7\u522b\uff0c\u4f8b\u5982 <code>v2beta1</code> \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u542f\u7528\u7684\uff0c\u8868\u793a\u4ee3\u7801\u5df2\u7ecf\u7ecf\u8fc7\u4e86\u5f88\u597d\u7684\u6d4b\u8bd5\uff0c\u4f46\u662f\u5bf9\u8c61\u7684\u8bed\u4e49\u53ef\u80fd\u4f1a\u5728\u968f\u540e\u7684\u7248\u672c\u4e2d\u4ee5\u4e0d\u517c\u5bb9\u7684\u65b9\u5f0f\u66f4\u6539</li> <li>\u7a33\u5b9a\u7ea7\u522b\uff0c\u6bd4\u5982 <code>v1</code> \u8868\u793a\u5df2\u7ecf\u662f\u7a33\u5b9a\u7248\u672c\u4e86\uff0c\u4e5f\u4f1a\u51fa\u73b0\u5728\u540e\u7eed\u7684\u5f88\u591a\u7248\u672c\u4e2d\u3002</li> </ul> <p>\u5728 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u4e00\u4e2a API \u5bf9\u8c61\u5728 Etcd \u91cc\u7684\u5b8c\u6574\u8d44\u6e90\u8def\u5f84\uff0c\u662f\u7531\uff1a<code>Group\uff08API \u7ec4\uff09</code>\u3001<code>Version\uff08API \u7248\u672c\uff09</code>\u548c <code>Resource\uff08API \u8d44\u6e90\u7c7b\u578b\uff09</code>\u4e09\u4e2a\u90e8\u5206\u7ec4\u6210\u7684\u3002\u901a\u8fc7\u8fd9\u6837\u7684\u7ed3\u6784\uff0c\u6574\u4e2a Kubernetes \u91cc\u7684\u6240\u6709 API \u5bf9\u8c61\uff0c\u5b9e\u9645\u4e0a\u5c31\u53ef\u4ee5\u7528\u5982\u4e0b\u7684\u6811\u5f62\u7ed3\u6784\u8868\u793a\u51fa\u6765\uff1a</p> <p></p> <p>\u4ece\u4e0a\u56fe\u4e2d\u6211\u4eec\u4e5f\u53ef\u4ee5\u770b\u51fa Kubernetes \u7684 API \u5bf9\u8c61\u7684\u7ec4\u7ec7\u65b9\u5f0f\uff0c\u5728\u9876\u5c42\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a\u6838\u5fc3\u7ec4\uff08\u7531\u4e8e\u5386\u53f2\u539f\u56e0\uff0c\u662f <code>/api/v1</code> \u4e0b\u7684\u6240\u6709\u5185\u5bb9\u800c\u4e0d\u662f\u5728 <code>/apis/core/v1</code> \u4e0b\u9762\uff09\u548c\u547d\u540d\u7ec4\uff08\u8def\u5f84 <code>/apis/$NAME/$VERSION</code>\uff09\u548c\u7cfb\u7edf\u8303\u56f4\u5185\u7684\u5b9e\u4f53\uff0c\u6bd4\u5982 <code>/metrics</code>\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b\u96c6\u7fa4\u4e2d\u7684 API \u7ec4\u7ec7\u5f62\u5f0f\uff1a</p> <pre><code>$ kubectl get --raw /\n{\n  \"paths\": [\n    \"/api\",\n    \"/api/v1\",\n    \"/apis\",\n    \"/apis/\",\n    ......\n    \"/version\"\n  ]\n}\n</code></pre> <p>\u6bd4\u5982\u6211\u4eec\u6765\u67e5\u770b\u6279\u5904\u7406\u8fd9\u4e2a\u64cd\u4f5c\uff0c\u5728\u6211\u4eec\u5f53\u524d\u8fd9\u4e2a\u7248\u672c\u4e2d\u5b58\u5728\u4e24\u4e2a\u7248\u672c\u7684\u64cd\u4f5c\uff1a<code>/apis/batch/v1</code> \u548c <code>/apis/batch/v1beta1</code>\uff0c\u5206\u522b\u66b4\u9732\u4e86\u53ef\u4ee5\u67e5\u8be2\u548c\u64cd\u4f5c\u7684\u4e0d\u540c\u5b9e\u4f53\u96c6\u5408\uff0c\u540c\u6837\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u901a\u8fc7 kubectl \u6765\u67e5\u8be2\u5bf9\u5e94\u5bf9\u8c61\u4e0b\u9762\u7684\u6570\u636e\uff1a</p> <pre><code>$ kubectl get --raw /apis/batch/v1 | python -m json.tool\n{\n    \"apiVersion\": \"v1\",\n    \"groupVersion\": \"batch/v1\",\n    \"kind\": \"APIResourceList\",\n    \"resources\": [\n        {\n            \"categories\": [\n                \"all\"\n            ],\n            \"kind\": \"Job\",\n            \"name\": \"jobs\",\n            \"namespaced\": true,\n            \"singularName\": \"\",\n            \"storageVersionHash\": \"mudhfqk/qZY=\",\n            \"verbs\": [\n                \"create\",\n                \"delete\",\n                \"deletecollection\",\n                \"get\",\n                \"list\",\n                \"patch\",\n                \"update\",\n                \"watch\"\n            ]\n        },\n        {\n            \"kind\": \"Job\",\n            \"name\": \"jobs/status\",\n            \"namespaced\": true,\n            \"singularName\": \"\",\n            \"verbs\": [\n                \"get\",\n                \"patch\",\n                \"update\"\n            ]\n        }\n    ]\n}\n</code></pre> <p>\u4f46\u662f\u8fd9\u4e2a\u64cd\u4f5c\u548c\u6211\u4eec\u5e73\u65f6\u64cd\u4f5c HTTP \u670d\u52a1\u7684\u65b9\u5f0f\u4e0d\u592a\u4e00\u6837\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>kubectl proxy</code> \u547d\u4ee4\u6765\u5f00\u542f\u5bf9 apiserver \u7684\u8bbf\u95ee\uff1a</p> <pre><code>$ kubectl proxy\nStarting to serve on 11:8001\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u5f00\u542f\u4e00\u4e2a\u65b0\u7684\u7ec8\u7aef\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u65b9\u5f0f\u6765\u8bbf\u95ee\u6279\u5904\u7406\u7684 API \u670d\u52a1\uff1a</p> <pre><code>$ curl http://11:8001/apis/batch/v1\n{\n  \"kind\": \"APIResourceList\",\n  \"apiVersion\": \"v1\",\n  \"groupVersion\": \"batch/v1\",\n  \"resources\": [\n    {\n      \"name\": \"jobs\",\n      \"singularName\": \"\",\n      \"namespaced\": true,\n      \"kind\": \"Job\",\n      \"verbs\": [\n        \"create\",\n        \"delete\",\n        \"deletecollection\",\n        \"get\",\n        \"list\",\n        \"patch\",\n        \"update\",\n        \"watch\"\n      ],\n      \"categories\": [\n        \"all\"\n      ],\n      \"storageVersionHash\": \"mudhfqk/qZY=\"\n    },\n    {\n      \"name\": \"jobs/status\",\n      \"singularName\": \"\",\n      \"namespaced\": true,\n      \"kind\": \"Job\",\n      \"verbs\": [\n        \"get\",\n        \"patch\",\n        \"update\"\n      ]\n    }\n  ]\n}\n</code></pre> <p>\u540c\u6837\u4e5f\u53ef\u4ee5\u53bb\u8bbf\u95ee\u53e6\u5916\u4e00\u4e2a\u7248\u672c\u7684\u5bf9\u8c61\u6570\u636e\uff1a</p> <pre><code>$ curl http://11:8001/apis/batch/v1beta1\n......\n</code></pre> <p>\u901a\u5e38\uff0cKubernetes API \u652f\u6301\u901a\u8fc7\u6807\u51c6 HTTP <code>POST</code>\u3001<code>PUT</code>\u3001<code>DELETE</code> \u548c <code>GET</code> \u5728\u6307\u5b9a PATH \u8def\u5f84\u4e0a\u521b\u5efa\u3001\u66f4\u65b0\u3001\u5220\u9664\u548c\u68c0\u7d22\u64cd\u4f5c\uff0c\u5e76\u4f7f\u7528 JSON \u4f5c\u4e3a\u9ed8\u8ba4\u7684\u6570\u636e\u4ea4\u4e92\u683c\u5f0f\u3002</p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u8981\u521b\u5efa\u4e00\u4e2a Deployment \u5bf9\u8c61\uff0c\u90a3\u4e48\u6211\u4eec\u7684 YAML \u6587\u4ef6\u7684\u58f0\u660e\u5c31\u9700\u8981\u600e\u4e48\u5199\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\n</code></pre> <p>\u5176\u4e2d <code>Deployment</code> \u5c31\u662f\u8fd9\u4e2a API \u5bf9\u8c61\u7684\u8d44\u6e90\u7c7b\u578b\uff08Resource\uff09\uff0c<code>apps</code> \u5c31\u662f\u5b83\u7684\u7ec4\uff08Group\uff09\uff0c<code>v1</code> \u5c31\u662f\u5b83\u7684\u7248\u672c\uff08Version\uff09\u3002API Group\u3001Version \u548c \u8d44\u6e90\u5c31\u552f\u4e00\u5b9a\u4e49\u4e86\u4e00\u4e2a HTTP \u8def\u5f84\uff0c\u7136\u540e\u5728 kube-apiserver \u7aef\u5bf9\u8fd9\u4e2a url \u8fdb\u884c\u4e86\u76d1\u542c\uff0c\u7136\u540e\u628a\u5bf9\u5e94\u7684\u8bf7\u6c42\u4f20\u9012\u7ed9\u4e86\u5bf9\u5e94\u7684\u63a7\u5236\u5668\u8fdb\u884c\u5904\u7406\u800c\u5df2\uff0c\u5f53\u7136\u5728 Kuberentes \u4e2d\u7684\u5b9e\u73b0\u8fc7\u7a0b\u662f\u975e\u5e38\u590d\u6742\u7684\u3002</p>"},{"location":"kubernetes_security/rbac/#rbac_1","title":"RBAC","text":"<p>\u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86 Kubernetes \u6240\u6709\u8d44\u6e90\u5bf9\u8c61\u90fd\u662f\u6a21\u578b\u5316\u7684 API \u5bf9\u8c61\uff0c\u5141\u8bb8\u6267\u884c </p> <pre><code>CRUD(Create\u3001Read\u3001Update\u3001Delete)\n</code></pre> <p>\u64cd\u4f5c(\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\u589e\u3001\u5220\u3001\u6539\u3001\u67e5\u64cd\u4f5c)\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u8fd9\u4e9b\u8d44\u6e90\uff1a</p> <ul> <li>Pods</li> <li>ConfigMaps</li> <li>Deployments</li> <li>Nodes</li> <li>Secrets</li> <li>Namespaces</li> <li>......</li> </ul> <p>\u5bf9\u4e8e\u4e0a\u9762\u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u7684\u53ef\u80fd\u5b58\u5728\u7684\u64cd\u4f5c\u6709\uff1a</p> <ul> <li>create</li> <li>get</li> <li>delete</li> <li>list</li> <li>update</li> <li>edit</li> <li>watch</li> <li>exec</li> <li>patch</li> </ul> <p>\u5728\u66f4\u4e0a\u5c42\uff0c\u8fd9\u4e9b\u8d44\u6e90\u548c API Group \u8fdb\u884c\u5173\u8054\uff0c\u6bd4\u5982 Pods \u5c5e\u4e8e Core API Group\uff0c\u800c Deployements \u5c5e\u4e8e apps API Group\uff0c\u73b0\u5728\u6211\u4eec\u8981\u5728 Kubernetes \u4e2d\u901a\u8fc7 RBAC \u6765\u5bf9\u8d44\u6e90\u8fdb\u884c\u6743\u9650\u7ba1\u7406\uff0c\u9664\u4e86\u4e0a\u9762\u7684\u8fd9\u4e9b\u8d44\u6e90\u548c\u64cd\u4f5c\u4ee5\u5916\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u4e86\u89e3\u53e6\u5916\u51e0\u4e2a\u6982\u5ff5\uff1a</p> <ul> <li><code>Rule</code>\uff1a\u89c4\u5219\uff0c\u89c4\u5219\u662f\u4e00\u7ec4\u5c5e\u4e8e\u4e0d\u540c API Group \u8d44\u6e90\u4e0a\u7684\u4e00\u7ec4\u64cd\u4f5c\u7684\u96c6\u5408</li> <li><code>Role</code> \u548c <code>ClusterRole</code>\uff1a\u89d2\u8272\u548c\u96c6\u7fa4\u89d2\u8272\uff0c\u8fd9\u4e24\u4e2a\u5bf9\u8c61\u90fd\u5305\u542b\u4e0a\u9762\u7684 Rules \u5143\u7d20\uff0c\u4e8c\u8005\u7684\u533a\u522b\u5728\u4e8e\uff0c\u5728 Role \u4e2d\uff0c\u5b9a\u4e49\u7684\u89c4\u5219\u53ea\u9002\u7528\u4e8e\u5355\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u4e5f\u5c31\u662f\u548c namespace \u5173\u8054\u7684\uff0c\u800c ClusterRole \u662f\u96c6\u7fa4\u8303\u56f4\u5185\u7684\uff0c\u56e0\u6b64\u5b9a\u4e49\u7684\u89c4\u5219\u4e0d\u53d7\u547d\u540d\u7a7a\u95f4\u7684\u7ea6\u675f\u3002\u53e6\u5916 Role \u548c ClusterRole \u5728Kubernetes \u4e2d\u90fd\u88ab\u5b9a\u4e49\u4e3a\u96c6\u7fa4\u5185\u90e8\u7684 API \u8d44\u6e90\uff0c\u548c\u6211\u4eec\u524d\u9762\u5b66\u4e60\u8fc7\u7684 Pod\u3001Deployment \u8fd9\u4e9b\u5bf9\u8c61\u7c7b\u4f3c\uff0c\u90fd\u662f\u6211\u4eec\u96c6\u7fa4\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6240\u4ee5\u540c\u6837\u7684\u53ef\u4ee5\u4f7f\u7528 YAML \u6587\u4ef6\u6765\u63cf\u8ff0\uff0c\u7528 kubectl \u5de5\u5177\u6765\u7ba1\u7406</li> <li> <p><code>Subject</code>\uff1a\u4e3b\u9898\uff0c\u5bf9\u5e94\u96c6\u7fa4\u4e2d\u5c1d\u8bd5\u64cd\u4f5c\u7684\u5bf9\u8c61\uff0c\u96c6\u7fa4\u4e2d\u5b9a\u4e49\u4e863\u79cd\u7c7b\u578b\u7684\u4e3b\u9898\u8d44\u6e90\uff1a</p> <ul> <li><code>User Account</code>\uff1a\u7528\u6237\uff0c\u8fd9\u662f\u6709\u5916\u90e8\u72ec\u7acb\u670d\u52a1\u8fdb\u884c\u7ba1\u7406\u7684\uff0c\u7ba1\u7406\u5458\u8fdb\u884c\u79c1\u94a5\u7684\u5206\u914d\uff0c\u7528\u6237\u53ef\u4ee5\u4f7f\u7528 KeyStone \u6216\u8005 Goolge \u5e10\u53f7\uff0c\u751a\u81f3\u4e00\u4e2a\u7528\u6237\u540d\u548c\u5bc6\u7801\u7684\u6587\u4ef6\u5217\u8868\u4e5f\u53ef\u4ee5\u3002\u5bf9\u4e8e\u7528\u6237\u7684\u7ba1\u7406\u96c6\u7fa4\u5185\u90e8\u6ca1\u6709\u4e00\u4e2a\u5173\u8054\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6240\u4ee5\u7528\u6237\u4e0d\u80fd\u901a\u8fc7\u96c6\u7fa4\u5185\u90e8\u7684 API \u6765\u8fdb\u884c\u7ba1\u7406</li> <li><code>Group</code>\uff1a\u7ec4\uff0c\u8fd9\u662f\u7528\u6765\u5173\u8054\u591a\u4e2a\u8d26\u6237\u7684\uff0c\u96c6\u7fa4\u4e2d\u6709\u4e00\u4e9b\u9ed8\u8ba4\u521b\u5efa\u7684\u7ec4\uff0c\u6bd4\u5982 cluster-admin</li> <li><code>Service Account</code>\uff1a\u670d\u52a1\u5e10\u53f7\uff0c\u901a\u8fc7 Kubernetes API \u6765\u7ba1\u7406\u7684\u4e00\u4e9b\u7528\u6237\u5e10\u53f7\uff0c\u548c namespace \u8fdb\u884c\u5173\u8054\u7684\uff0c\u9002\u7528\u4e8e\u96c6\u7fa4\u5185\u90e8\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u9700\u8981\u901a\u8fc7 API \u6765\u5b8c\u6210\u6743\u9650\u8ba4\u8bc1\uff0c\u6240\u4ee5\u5728\u96c6\u7fa4\u5185\u90e8\u8fdb\u884c\u6743\u9650\u64cd\u4f5c\uff0c\u6211\u4eec\u90fd\u9700\u8981\u4f7f\u7528\u5230 ServiceAccount\uff0c\u8fd9\u4e5f\u662f\u6211\u4eec\u8fd9\u8282\u8bfe\u7684\u91cd\u70b9</li> <li> <p><code>RoleBinding</code> \u548c <code>ClusterRoleBinding</code>\uff1a\u89d2\u8272\u7ed1\u5b9a\u548c\u96c6\u7fa4\u89d2\u8272\u7ed1\u5b9a\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u628a\u58f0\u660e\u7684 Subject \u548c\u6211\u4eec\u7684 Role \u8fdb\u884c\u7ed1\u5b9a\u7684\u8fc7\u7a0b\uff08\u7ed9\u67d0\u4e2a\u7528\u6237\u7ed1\u5b9a\u4e0a\u64cd\u4f5c\u7684\u6743\u9650\uff09\uff0c\u4e8c\u8005\u7684\u533a\u522b\u4e5f\u662f\u4f5c\u7528\u8303\u56f4\u7684\u533a\u522b\uff1aRoleBinding \u53ea\u4f1a\u5f71\u54cd\u5230\u5f53\u524d namespace \u4e0b\u9762\u7684\u8d44\u6e90\u64cd\u4f5c\u6743\u9650\uff0c\u800c ClusterRoleBinding \u4f1a\u5f71\u54cd\u5230\u6240\u6709\u7684 namespace\u3002</p> </li> </ul> </li> </ul> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u901a\u8fc7\u51e0\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\uff0c\u6765\u5b66\u4e60\u4e0b\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5982\u4f55\u4f7f\u7528 <code>RBAC</code>\u3002</p>"},{"location":"kubernetes_security/rbac/#namespace","title":"\u53ea\u80fd\u8bbf\u95ee\u67d0\u4e2a namespace \u7684\u666e\u901a\u7528\u6237","text":"<p>\u6211\u4eec\u60f3\u8981\u521b\u5efa\u4e00\u4e2a User Account\uff0c\u53ea\u80fd\u8bbf\u95ee kube-system \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u5bf9\u5e94\u7684\u7528\u6237\u4fe1\u606f\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>username: cnych\ngroup: youdianzhishi\n</code></pre>"},{"location":"kubernetes_security/rbac/#_1","title":"\u521b\u5efa\u7528\u6237\u51ed\u8bc1","text":"<p>\u6211\u4eec\u524d\u9762\u5df2\u7ecf\u63d0\u5230\u8fc7\uff0cKubernetes \u6ca1\u6709 User Account \u7684 API \u5bf9\u8c61\uff0c\u4e0d\u8fc7\u8981\u521b\u5efa\u4e00\u4e2a\u7528\u6237\u5e10\u53f7\u7684\u8bdd\u4e5f\u662f\u633a\u7b80\u5355\u7684\uff0c\u5229\u7528\u7ba1\u7406\u5458\u5206\u914d\u7ed9\u4f60\u7684\u4e00\u4e2a\u79c1\u94a5\u5c31\u53ef\u4ee5\u521b\u5efa\u4e86\uff0c\u8fd9\u4e2a\u6211\u4eec\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863\u4e2d\u7684\u65b9\u6cd5\uff0c\u8fd9\u91cc\u6211\u4eec\u6765\u4f7f\u7528 <code>OpenSSL</code> \u8bc1\u4e66\u6765\u521b\u5efa\u4e00\u4e2a User\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528\u66f4\u7b80\u5355\u7684 <code>cfssl</code>\u5de5\u5177\u6765\u521b\u5efa\uff1a</p> <p>\u7ed9\u7528\u6237 cnych \u521b\u5efa\u4e00\u4e2a\u79c1\u94a5\uff0c\u547d\u540d\u6210 <code>cnych.key</code>\uff1a</p> <pre><code>$ openssl genrsa -out cnych.key 2048\nGenerating RSA private key, 2048 bit long modulus\n..............................................................................+++\n..............................................................................................................................................+++\ne is 65537 (0x10001)\n</code></pre> <p>\u4f7f\u7528\u6211\u4eec\u521a\u521a\u521b\u5efa\u7684\u79c1\u94a5\u521b\u5efa\u4e00\u4e2a\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\u6587\u4ef6\uff1a<code>cnych.csr</code>\uff0c\u8981\u6ce8\u610f\u9700\u8981\u786e\u4fdd\u5728<code>-subj</code>\u53c2\u6570\u4e2d\u6307\u5b9a\u7528\u6237\u540d\u548c\u7ec4(CN\u8868\u793a\u7528\u6237\u540d\uff0cO\u8868\u793a\u7ec4)\uff1a</p> <pre><code>$ openssl req -new -key cnych.key -out cnych.csr -subj \"/CN=cnych/O=youdianzhishi\"\n</code></pre> <p>\u7136\u540e\u627e\u5230\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\u7684 <code>CA</code> \u8bc1\u4e66\uff0c\u6211\u4eec\u4f7f\u7528\u7684\u662f kubeadm \u5b89\u88c5\u7684\u96c6\u7fa4\uff0cCA \u76f8\u5173\u8bc1\u4e66\u4f4d\u4e8e <code>/etc/kubernetes/pki/</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u5982\u679c\u4f60\u662f\u4e8c\u8fdb\u5236\u65b9\u5f0f\u642d\u5efa\u7684\uff0c\u4f60\u5e94\u8be5\u5728\u6700\u5f00\u59cb\u642d\u5efa\u96c6\u7fa4\u7684\u65f6\u5019\u5c31\u5df2\u7ecf\u6307\u5b9a\u597d\u4e86 CA \u7684\u76ee\u5f55\uff0c\u6211\u4eec\u4f1a\u5229\u7528\u8be5\u76ee\u5f55\u4e0b\u9762\u7684 <code>ca.crt</code> \u548c <code>ca.key</code>\u4e24\u4e2a\u6587\u4ef6\u6765\u6279\u51c6\u4e0a\u9762\u7684\u8bc1\u4e66\u8bf7\u6c42\u3002\u751f\u6210\u6700\u7ec8\u7684\u8bc1\u4e66\u6587\u4ef6\uff0c\u6211\u4eec\u8fd9\u91cc\u8bbe\u7f6e\u8bc1\u4e66\u7684\u6709\u6548\u671f\u4e3a 500 \u5929\uff1a</p> <pre><code>$ openssl x509 -req -in cnych.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out cnych.crt -days 500\nSignature ok\nsubject=/CN=cnych/O=youdianzhishi\nGetting CA Private Key\n</code></pre> <p>\u73b0\u5728\u67e5\u770b\u6211\u4eec\u5f53\u524d\u6587\u4ef6\u5939\u4e0b\u9762\u662f\u5426\u751f\u6210\u4e86\u4e00\u4e2a\u8bc1\u4e66\u6587\u4ef6\uff1a</p> <pre><code>$ ls\ncnych.crt  cnych.csr  cnych.key\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u521a\u521a\u521b\u5efa\u7684\u8bc1\u4e66\u6587\u4ef6\u548c\u79c1\u94a5\u6587\u4ef6\u5728\u96c6\u7fa4\u4e2d\u521b\u5efa\u65b0\u7684\u51ed\u8bc1\u548c\u4e0a\u4e0b\u6587(Context):</p> <pre><code>$ kubectl config set-credentials cnych --client-certificate=cnych.crt --client-key=cnych.key\nUser \"cnych\" set.\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e00\u4e2a\u7528\u6237 <code>cnych</code> \u521b\u5efa\u4e86\uff0c\u7136\u540e\u4e3a\u8fd9\u4e2a\u7528\u6237\u8bbe\u7f6e\u65b0\u7684 Context\uff0c\u6211\u4eec\u8fd9\u91cc\u6307\u5b9a\u7279\u5b9a\u7684\u4e00\u4e2a namespace\uff1a</p> <pre><code>$ kubectl config set-context cnych-context --cluster=kubernetes --namespace=kube-system --user=cnych\nContext \"cnych-context\" created.\n</code></pre> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u7684\u7528\u6237 <code>cnych</code> \u5c31\u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u73b0\u5728\u6211\u4eec\u4f7f\u7528\u5f53\u524d\u7684\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\u6765\u64cd\u4f5c kubectl \u547d\u4ee4\u7684\u65f6\u5019\uff0c\u5e94\u8be5\u4f1a\u51fa\u73b0\u9519\u8bef\uff0c\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u4e3a\u8be5\u7528\u6237\u5b9a\u4e49\u4efb\u4f55\u64cd\u4f5c\u7684\u6743\u9650\u5462\uff1a</p> <pre><code>$ kubectl get pods --context=cnych-context\nError from server (Forbidden): pods is forbidden: User \"cnych\" cannot list resource \"pods\" in API group \"\" in the namespace \"kube-system\"\n</code></pre>"},{"location":"kubernetes_security/rbac/#_2","title":"\u521b\u5efa\u89d2\u8272","text":"<p>\u7528\u6237\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u63a5\u4e0b\u6765\u5c31\u9700\u8981\u7ed9\u8be5\u7528\u6237\u6dfb\u52a0\u64cd\u4f5c\u6743\u9650\uff0c\u6211\u4eec\u6765\u5b9a\u4e49\u4e00\u4e2a YAML \u6587\u4ef6\uff0c\u521b\u5efa\u4e00\u4e2a\u5141\u8bb8\u7528\u6237\u64cd\u4f5c Deployment\u3001Pod\u3001ReplicaSets \u7684\u89d2\u8272\uff0c\u5982\u4e0b\u5b9a\u4e49\uff1a(cnych-role.yaml)</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: cnych-role\n  namespace: kube-system\nrules:\n- apiGroups: [\"\", \"apps\"]\n  resources: [\"deployments\", \"replicasets\", \"pods\"]\n  verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\", \"delete\"] # \u4e5f\u53ef\u4ee5\u4f7f\u7528['*']\n</code></pre> <p>\u5176\u4e2d Pod \u5c5e\u4e8e <code>core</code> \u8fd9\u4e2a API Group\uff0c\u5728 YAML \u4e2d\u7528\u7a7a\u5b57\u7b26\u5c31\u53ef\u4ee5\uff0c\u800c Deployment \u548c ReplicaSet \u73b0\u5728\u90fd\u5c5e\u4e8e <code>apps</code> \u8fd9\u4e2a API Group\uff08\u5982\u679c\u4e0d\u77e5\u9053\u5219\u53ef\u4ee5\u7528 <code>kubectl explain</code> \u547d\u4ee4\u67e5\u770b\uff09\uff0c\u6240\u4ee5 <code>rules</code> \u4e0b\u9762\u7684 <code>apiGroups</code> \u5c31\u7efc\u5408\u4e86\u8fd9\u51e0\u4e2a\u8d44\u6e90\u7684 API Group\uff1a[\"\", \"apps\"]\uff0c\u5176\u4e2d<code>verbs</code> \u5c31\u662f\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u7684\u53ef\u4ee5\u5bf9\u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u6267\u884c\u7684\u64cd\u4f5c\uff0c\u6211\u4eec\u8fd9\u91cc\u9700\u8981\u6240\u6709\u7684\u64cd\u4f5c\u65b9\u6cd5\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528[*]\u6765\u4ee3\u66ff\u3002\u7136\u540e\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Role\uff1a</p> <pre><code>$ kubectl create -f cnych-role.yaml\nrole.rbac.authorization.k8s.io/cnych-role created\n</code></pre> <p>\u6ce8\u610f\u8fd9\u91cc\u6211\u4eec\u6ca1\u6709\u4f7f\u7528\u4e0a\u9762\u7684 <code>cnych-context</code> \u8fd9\u4e2a\u4e0a\u4e0b\u6587\uff0c\u56e0\u4e3a\u6682\u65f6\u8fd8\u6728\u6709\u6743\u9650\u3002</p>"},{"location":"kubernetes_security/rbac/#_3","title":"\u521b\u5efa\u89d2\u8272\u6743\u9650\u7ed1\u5b9a","text":"<p>Role \u521b\u5efa\u5b8c\u6210\u4e86\uff0c\u4f46\u662f\u5f88\u660e\u663e\u73b0\u5728\u6211\u4eec\u8fd9\u4e2a <code>Role</code> \u548c\u6211\u4eec\u7684\u7528\u6237 <code>cnych</code> \u8fd8\u6ca1\u6709\u4efb\u4f55\u5173\u7cfb\uff0c\u5bf9\u5427\uff1f\u8fd9\u91cc\u5c31\u9700\u8981\u521b\u5efa\u4e00\u4e2a <code>RoleBinding</code> \u5bf9\u8c61\uff0c\u5728 kube-system \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u5c06\u4e0a\u9762\u7684 <code>cnych-role</code> \u89d2\u8272\u548c\u7528\u6237 <code>cnych</code> \u8fdb\u884c\u7ed1\u5b9a\uff1a\uff08cnych-rolebinding.yaml\uff09</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: cnych-rolebinding\n  namespace: kube-system\nsubjects:\n- kind: User\n  name: cnych\n  apiGroup: \"\"\nroleRef:\n  kind: Role\n  name: cnych-role\n  apiGroup: rbac.authorization.k8s.io  # \u7559\u7a7a\u5b57\u7b26\u4e32\u4e5f\u53ef\u4ee5\uff0c\u5219\u4f7f\u7528\u5f53\u524d\u7684apiGroup\n</code></pre> <p>\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u4e2d\u6211\u4eec\u770b\u5230\u4e86 <code>subjects</code> \u5b57\u6bb5\uff0c\u8fd9\u91cc\u5c31\u662f\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u7684\u7528\u6765\u5c1d\u8bd5\u64cd\u4f5c\u96c6\u7fa4\u7684\u5bf9\u8c61\uff0c\u8fd9\u91cc\u5bf9\u5e94\u4e0a\u9762\u7684 <code>User</code> \u5e10\u53f7 <code>cnych</code>\uff0c\u4f7f\u7528kubectl \u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f cnych-rolebinding.yaml\nrolebinding.rbac.authorization.k8s.io/cnych-rolebinding created\n</code></pre>"},{"location":"kubernetes_security/rbac/#_4","title":"\u6d4b\u8bd5","text":"<p>\u73b0\u5728\u6211\u4eec\u5e94\u8be5\u53ef\u4ee5\u4e0a\u9762\u7684 <code>cnych-context</code> \u4e0a\u4e0b\u6587\u6765\u64cd\u4f5c\u96c6\u7fa4\u4e86\uff1a</p> <pre><code>$ kubectl get pods --context=cnych-context\nkubectl get pods --context=cnych-context\nNAME                                         READY   STATUS    RESTARTS   AGE\ncoredns-667f964f9b-pr44s                     1/1     Running   0          13d\ncoredns-667f964f9b-vh55b                     1/1     Running   1          13d\netcd-ydzs-master                             1/1     Running   0          13d\nkube-apiserver-ydzs-master                   1/1     Running   1          6d5h\nkube-controller-manager-ydzs-master          1/1     Running   3          13d\n......\n$ kubectl --context=cnych-context get rs,deploy\nNAME                                                    DESIRED   CURRENT   READY   AGE\nreplicaset.apps/coredns-667f964f9b                      2         2         2       13d\nreplicaset.apps/metrics-server-5d4dbb78bb               1         1         1       2d21h\nreplicaset.apps/metrics-server-6886856d7c               0         0         0       2d21h\nreplicaset.apps/metrics-server-6dcfdf89b5               0         0         0       2d21h\nreplicaset.apps/traefik-ingress-controller-54f665bb97   0         0         0       47h\n\nNAME                                         READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/coredns                      2/2     2            2           13d\ndeployment.apps/metrics-server               1/1     1            1           2d21h\ndeployment.apps/traefik-ingress-controller   1/1     1            1           2d6h\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u4f7f\u7528 kubectl \u7684\u4f7f\u7528\u5e76\u6ca1\u6709\u6307\u5b9a namespace\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u6211\u4eec\u4e0a\u9762\u521b\u5efa\u8fd9\u4e2a Context \u7684\u65f6\u5019\u5c31\u7ed1\u5b9a\u5728\u4e86 kube-system \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\uff0c\u5982\u679c\u6211\u4eec\u5728\u540e\u9762\u52a0\u4e0a\u4e00\u4e2a<code>-n default</code>\u8bd5\u770b\u770b\u5462\uff1f</p> <pre><code>$ kubectl --context=cnych-context get pods --namespace=default\nError from server (Forbidden): pods is forbidden: User \"cnych\" cannot list resource \"pods\" in API group \"\" in the namespace \"default\"\n</code></pre> <p>\u5982\u679c\u53bb\u83b7\u53d6\u5176\u4ed6\u7684\u8d44\u6e90\u5bf9\u8c61\u5462\uff1a</p> <pre><code>$ kubectl --context=cnych-context get svc\nError from server (Forbidden): services is forbidden: User \"cnych\" cannot list resource \"services\" in API group \"\" in the namespace \"kube-system\"\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6ca1\u6709\u6743\u9650\u83b7\u53d6\uff0c\u56e0\u4e3a\u6211\u4eec\u5e76\u6ca1\u6709\u4e3a\u5f53\u524d\u64cd\u4f5c\u7528\u6237\u6307\u5b9a\u5176\u4ed6\u5bf9\u8c61\u8d44\u6e90\u7684\u8bbf\u95ee\u6743\u9650\uff0c\u662f\u7b26\u5408\u6211\u4eec\u7684\u9884\u671f\u7684\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u521b\u5efa\u4e86\u4e00\u4e2a\u53ea\u6709\u5355\u4e2a\u547d\u540d\u7a7a\u95f4\u8bbf\u95ee\u6743\u9650\u7684\u666e\u901a User \u3002</p>"},{"location":"kubernetes_security/rbac/#namespace_serviceaccount","title":"\u53ea\u80fd\u8bbf\u95ee\u67d0\u4e2a namespace \u7684 ServiceAccount","text":"<p>\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u53ea\u80fd\u8bbf\u95ee\u67d0\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684<code>\u666e\u901a\u7528\u6237</code>\uff0c\u6211\u4eec\u524d\u9762\u4e5f\u63d0\u5230\u8fc7 <code>subjects</code> \u4e0b\u9762\u8fd8\u6709\u4e00\u79cd\u7c7b\u578b\u7684\u4e3b\u9898\u8d44\u6e90\uff1a<code>ServiceAccount</code>\uff0c\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a\u96c6\u7fa4\u5185\u90e8\u7684\u7528\u6237\u53ea\u80fd\u64cd\u4f5c kube-system \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684 pods \u548c deployments\uff0c\u9996\u5148\u6765\u521b\u5efa\u4e00\u4e2a <code>ServiceAccount</code> \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create sa cnych-sa -n kube-system\n</code></pre> <p>\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u5b9a\u4e49\u6210 YAML \u6587\u4ef6\u7684\u5f62\u5f0f\u6765\u521b\u5efa\uff1a</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: cnych-sa\n  namespace: kube-system\n</code></pre> <p>\u7136\u540e\u65b0\u5efa\u4e00\u4e2a Role \u5bf9\u8c61\uff1a(cnych-sa-role.yaml)</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: cnych-sa-role\n  namespace: kube-system\nrules:\n- apiGroups: [\"\"]\n  resources: [\"pods\"]\n  verbs: [\"get\", \"watch\", \"list\"]\n- apiGroups: [\"apps\"]\n  resources: [\"deployments\"]\n  verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\", \"delete\"]\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u7684\u89d2\u8272\u6ca1\u6709<code>\u521b\u5efa\u3001\u5220\u9664\u3001\u66f4\u65b0</code> Pod \u7684\u6743\u9650\uff0c\u5f85\u4f1a\u6211\u4eec\u53ef\u4ee5\u91cd\u70b9\u6d4b\u8bd5\u4e00\u4e0b\uff0c\u521b\u5efa\u8be5 Role \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f cnych-sa-role.yaml\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a <code>RoleBinding</code> \u5bf9\u8c61\uff0c\u5c06\u4e0a\u9762\u7684 <code>cnych-sa</code> \u548c\u89d2\u8272 haimaxy-sa-role \u8fdb\u884c\u7ed1\u5b9a\uff1a(haimaxy-sa-rolebinding.yaml)</p> <pre><code>kind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: cnych-sa-rolebinding\n  namespace: kube-system\nsubjects:\n- kind: ServiceAccount\n  name: cnych-sa\n  namespace: kube-system\nroleRef:\n  kind: Role\n  name: cnych-sa-role\n  apiGroup: rbac.authorization.k8s.io\n</code></pre> <p>\u6dfb\u52a0\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f cnych-sa-rolebinding.yaml\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u600e\u4e48\u53bb\u9a8c\u8bc1\u8fd9\u4e2a ServiceAccount \u5462\uff1f\u6211\u4eec\u524d\u9762\u7684\u8bfe\u7a0b\u4e2d\u662f\u4e0d\u662f\u63d0\u5230\u8fc7\u4e00\u4e2a ServiceAccount \u4f1a\u751f\u6210\u4e00\u4e2a Secret \u5bf9\u8c61\u548c\u5b83\u8fdb\u884c\u6620\u5c04\uff0c\u8fd9\u4e2a Secret \u91cc\u9762\u5305\u542b\u4e00\u4e2a token\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u8fd9\u4e2a token \u53bb\u767b\u5f55 Dashboard\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 Dashboard \u4e2d\u6765\u9a8c\u8bc1\u6211\u4eec\u7684\u529f\u80fd\u662f\u5426\u7b26\u5408\u9884\u671f\u4e86\uff1a</p> <pre><code>$ kubectl get secret -n kube-system |grep cnych-sa\ncnych-sa-token-nxgqx                  kubernetes.io/service-account-token   3         47m\n$ kubectl get secret cnych-sa-token-nxgqx -o jsonpath={.data.token} -n kube-system |base64 -d\n# \u4f1a\u751f\u6210\u4e00\u4e32\u5f88\u957f\u7684base64\u540e\u7684\u5b57\u7b26\u4e32\n</code></pre> <p>\u4f7f\u7528\u8fd9\u91cc\u7684 token \u53bb Dashboard \u9875\u9762\u8fdb\u884c\u767b\u5f55\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u63d0\u793a\u4fe1\u606f\u8bf4\u6211\u4eec\u73b0\u5728\u4f7f\u7528\u7684\u8fd9\u4e2a ServiceAccount \u6ca1\u6709\u6743\u9650\u83b7\u53d6\u5f53\u524d\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u767b\u5f55\u8fdb\u6765\u540e\u9ed8\u8ba4\u8df3\u8f6c\u5230 default \u547d\u540d\u7a7a\u95f4\uff0c\u6211\u4eec\u5207\u6362\u5230 kube-system \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u5c31\u53ef\u4ee5\u4e86\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u53ef\u4ee5\u8bbf\u95ee pod \u5217\u8868\u4e86\uff0c\u4f46\u662f\u4e5f\u4f1a\u6709\u4e00\u4e9b\u5176\u4ed6\u989d\u5916\u7684\u63d0\u793a\uff1a</p> <pre><code>events is forbidden: User system:serviceaccount:kube-system:cnych-sa cannot list events in the namespace kube-system\n</code></pre> <p>\uff0c\u8fd9\u662f\u56e0\u4e3a\u5f53\u524d\u767b\u5f55\u7528\u53ea\u88ab\u6388\u6743\u4e86\u8bbf\u95ee pod \u548c deployment \u7684\u6743\u9650\uff0c\u540c\u6837\u7684\uff0c\u8bbf\u95ee\u4e0bdeployment\u770b\u770b\u53ef\u4ee5\u4e86\u5417\uff1f</p> <p>\u540c\u6837\u7684\uff0c\u4f60\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u6765\u5bf9\u8bbf\u95ee\u7528\u6237\u7684\u6743\u9650\u8fdb\u884c\u9650\u5236\uff0c\u53ef\u4ee5\u81ea\u5df1\u901a\u8fc7 Role \u5b9a\u4e49\u66f4\u52a0\u7ec6\u7c92\u5ea6\u7684\u6743\u9650\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u7cfb\u7edf\u5185\u7f6e\u7684\u4e00\u4e9b\u6743\u9650\u2026\u2026</p>"},{"location":"kubernetes_security/rbac/#serviceaccount","title":"\u53ef\u4ee5\u5168\u5c40\u8bbf\u95ee\u7684 ServiceAccount","text":"<p>\u521a\u521a\u6211\u4eec\u521b\u5efa\u7684 cnych-sa \u8fd9\u4e2a <code>ServiceAccount</code> \u548c\u4e00\u4e2a <code>Role</code> \u89d2\u8272\u8fdb\u884c\u7ed1\u5b9a\u7684\uff0c\u5982\u679c\u6211\u4eec\u73b0\u5728\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 ServiceAccount\uff0c\u9700\u8981\u4ed6\u64cd\u4f5c\u7684\u6743\u9650\u4f5c\u7528\u4e8e\u6240\u6709\u7684 namespace\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528\u5230 <code>ClusterRole</code> \u548c <code>ClusterRoleBinding</code> \u8fd9\u4e24\u79cd\u8d44\u6e90\u5bf9\u8c61\u4e86\u3002\u540c\u6837\uff0c\u9996\u5148\u65b0\u5efa\u4e00\u4e2a ServiceAcount \u5bf9\u8c61\uff1a(cnych-sa2.yaml)</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: cnych-sa2\n  namespace: kube-system\n</code></pre> <p>\u521b\u5efa\uff1a</p> <pre><code>$ kubectl create -f cnych-sayaml\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a ClusterRoleBinding \u5bf9\u8c61\uff08cnych-clusterolebinding.yaml\uff09:</p> <pre><code>kind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: cnych-sa2-clusterrolebinding\nsubjects:\n- kind: ServiceAccount\n  name: cnych-sa2\n  namespace: kube-system\nroleRef:\n  kind: ClusterRole\n  name: cluster-admin\n  apiGroup: rbac.authorization.k8s.io\n</code></pre> <p>\u4ece\u4e0a\u9762\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u6ca1\u6709\u4e3a\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u58f0\u660e namespace\uff0c\u56e0\u4e3a\u8fd9\u662f\u4e00\u4e2a ClusterRoleBinding \u8d44\u6e90\u5bf9\u8c61\uff0c\u662f\u4f5c\u7528\u4e8e\u6574\u4e2a\u96c6\u7fa4\u7684\uff0c\u6211\u4eec\u4e5f\u6ca1\u6709\u5355\u72ec\u65b0\u5efa\u4e00\u4e2a ClusterRole \u5bf9\u8c61\uff0c\u800c\u662f\u4f7f\u7528\u7684 <code>cluster-admin</code> \u8fd9\u4e2a\u5bf9\u8c61\uff0c\u8fd9\u662f Kubernetes \u96c6\u7fa4\u5185\u7f6e\u7684 ClusterRole \u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 </p> <pre><code>kubectl get clusterrole\n</code></pre> <p>\u548c </p> <pre><code>kubectl get clusterrolebinding\n</code></pre> <p>\u67e5\u770b\u7cfb\u7edf\u5185\u7f6e\u7684\u4e00\u4e9b\u96c6\u7fa4\u89d2\u8272\u548c\u96c6\u7fa4\u89d2\u8272\u7ed1\u5b9a\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684 <code>cluster-admin</code> \u8fd9\u4e2a\u96c6\u7fa4\u89d2\u8272\u662f\u62e5\u6709\u6700\u9ad8\u6743\u9650\u7684\u96c6\u7fa4\u89d2\u8272\uff0c\u6240\u4ee5\u4e00\u822c\u9700\u8981\u8c28\u614e\u4f7f\u7528\u8be5\u96c6\u7fa4\u89d2\u8272\u3002</p> <p>\u521b\u5efa\u4e0a\u9762\u96c6\u7fa4\u89d2\u8272\u7ed1\u5b9a\u8d44\u6e90\u5bf9\u8c61\uff0c\u521b\u5efa\u5b8c\u6210\u540e\u540c\u6837\u4f7f\u7528 ServiceAccount \u5bf9\u5e94\u7684 token \u53bb\u767b\u5f55 Dashboard \u9a8c\u8bc1\u4e0b\uff1a</p> <pre><code>$ kubectl create -f cnych-clusterolebinding.yaml\n$ kubectl get secret -n kube-system |grep cnych-sa2\ncnych-sa2-token-nxgqx                  kubernetes.io/service-account-token   3         47m\n$ kubectl get secret cnych-sa2-token-nxgqx -o jsonpath={.data.token} -n kube-system |base64 -d\n# \u4f1a\u751f\u6210\u4e00\u4e32\u5f88\u957f\u7684base64\u540e\u7684\u5b57\u7b26\u4e32\n</code></pre> <p></p> <p>\u6211\u4eec\u5728\u6700\u5f00\u59cb\u63a5\u89e6\u5230 RBAC \u8ba4\u8bc1\u7684\u65f6\u5019\uff0c\u53ef\u80fd\u4e0d\u592a\u719f\u6089\uff0c\u7279\u522b\u662f\u4e0d\u77e5\u9053\u5e94\u8be5\u600e\u4e48\u53bb\u7f16\u5199 rules \u89c4\u5219\uff0c\u5927\u5bb6\u53ef\u4ee5\u53bb\u5206\u6790\u7cfb\u7edf\u81ea\u5e26\u7684 <code>clusterrole</code>\u3001<code>clusterrolebinding</code> \u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u7684\u7f16\u5199\u65b9\u6cd5\uff0c\u600e\u4e48\u5206\u6790\uff1f\u8fd8\u662f\u5229\u7528 kubectl \u7684 get\u3001describe\u3001 <code>-o yaml</code> \u8fd9\u4e9b\u64cd\u4f5c\uff0c\u6240\u4ee5 kubectl \u6700\u57fa\u672c\u7684\u64cd\u4f5c\u7528\u6237\u4e00\u5b9a\u8981\u638c\u63e1\u597d\u3002</p>"},{"location":"kubernetes_security/security_context/","title":"Security Context","text":""},{"location":"kubernetes_security/security_context/#security_context","title":"Security Context","text":"<p>Kubernetes Pod/\u5bb9\u5668\u7684\u5b89\u5168\u7ba1\u63a7</p> <p></p> <p>\u6211\u4eec\u6709\u65f6\u5019\u5728\u8fd0\u884c\u4e00\u4e2a\u5bb9\u5668\u7684\u65f6\u5019\uff0c\u53ef\u80fd\u9700\u8981\u4f7f\u7528 <code>sysctl</code> \u547d\u4ee4\u6765\u4fee\u6539\u5185\u6838\u53c2\u6570\uff0c\u6bd4\u5982 <code>net</code>\u3001<code>vm</code>\u3001<code>kernel</code> \u7b49\u53c2\u6570\uff0c\u4f46\u662f <code>systcl</code> \u9700\u8981\u5bb9\u5668\u62e5\u6709\u8d85\u7ea7\u6743\u9650\uff0c\u624d\u53ef\u4ee5\u4f7f\u7528\uff0c\u5728 Docker \u5bb9\u5668\u542f\u52a8\u7684\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u52a0\u4e0a <code>--privileged</code> \u53c2\u6570\u6765\u4f7f\u7528\u7279\u6743\u6a21\u5f0f\u3002\u90a3\u4e48\u5728 Kubernetes \u4e2d\u5e94\u8be5\u5982\u4f55\u6765\u4f7f\u7528\u5462\uff1f</p> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528\u5230 Kubernetes \u4e2d\u7684 <code>Security Context</code>\uff0c\u4e5f\u5c31\u662f\u5e38\u8bf4\u7684\u5b89\u5168\u4e0a\u4e0b\u6587\uff0c\u4e3b\u8981\u662f\u6765\u9650\u5236\u5bb9\u5668\u975e\u6cd5\u64cd\u4f5c\u5bbf\u4e3b\u8282\u70b9\u7684\u7cfb\u7edf\u7ea7\u522b\u7684\u5185\u5bb9\uff0c\u4f7f\u5f97\u8282\u70b9\u7684\u7cfb\u7edf\u6216\u8005\u8282\u70b9\u4e0a\u5176\u4ed6\u5bb9\u5668\u7ec4\u53d7\u5230\u5f71\u54cd\u3002Kubernetes \u63d0\u4f9b\u4e86\u4e09\u79cd\u914d\u7f6e\u5b89\u5168\u4e0a\u4e0b\u6587\u7ea7\u522b\u7684\u65b9\u6cd5\uff1a</p> <ul> <li>Container-level Security Context\uff1a\u4ec5\u5e94\u7528\u5230\u6307\u5b9a\u7684\u5bb9\u5668</li> <li>Pod-level Security Context\uff1a\u5e94\u7528\u5230 Pod \u5185\u6240\u6709\u5bb9\u5668\u4ee5\u53ca Volume</li> <li>Pod Security Policies\uff08PSP\uff09\uff1a\u5e94\u7528\u5230\u96c6\u7fa4\u5185\u90e8\u6240\u6709 Pod \u4ee5\u53ca Volume</li> </ul> <p>\u6211\u4eec\u53ef\u4ee5\u7528\u5982\u4e0b\u51e0\u79cd\u65b9\u5f0f\u6765\u8bbe\u7f6e <code>Security Context</code>\uff1a</p> <ul> <li>\u8bbf\u95ee\u6743\u9650\u63a7\u5236\uff1a\u6839\u636e\u7528\u6237 ID\uff08UID\uff09\u548c\u7ec4 ID\uff08GID\uff09\u6765\u9650\u5236\u5bf9\u8d44\u6e90\uff08\u6bd4\u5982\uff1a\u6587\u4ef6\uff09\u7684\u8bbf\u95ee\u6743\u9650</li> <li>Security Enhanced Linux (SELinux)\uff1a\u4e3a\u5bf9\u8c61\u5206\u914d <code>SELinux</code> \u6807\u7b7e</li> <li>\u4ee5 privileged\uff08\u7279\u6743\uff09\u6a21\u5f0f\u8fd0\u884c</li> <li>Linux Capabilities\uff1a\u7ed9\u67d0\u4e2a\u7279\u5b9a\u7684\u8fdb\u7a0b\u8d85\u7ea7\u6743\u9650\uff0c\u800c\u4e0d\u7528\u7ed9 root \u7528\u6237\u6240\u6709\u7684 privileged \u6743\u9650</li> <li>AppArmor\uff1a\u4f7f\u7528\u7a0b\u5e8f\u6587\u4ef6\u6765\u9650\u5236\u5355\u4e2a\u7a0b\u5e8f\u7684\u6743\u9650</li> <li>Seccomp\uff1a\u8fc7\u6ee4\u5bb9\u5668\u4e2d\u8fdb\u7a0b\u7684\u7cfb\u7edf\u8c03\u7528\uff08system call\uff09</li> <li> <p>AllowPrivilegeEscalation\uff08\u5141\u8bb8\u7279\u6743\u6269\u5927\uff09\uff1a\u6b64\u9879\u914d\u7f6e\u662f\u4e00\u4e2a\u5e03\u5c14\u503c\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8fdb\u7a0b\u662f\u5426\u53ef\u4ee5\u6bd4\u5176\u7236\u8fdb\u7a0b\u83b7\u5f97\u66f4\u591a\u7684\u7279\u6743\uff0c\u76f4\u63a5\u6548\u679c\u662f\uff0c\u5bb9\u5668\u7684\u8fdb\u7a0b\u4e0a\u662f\u5426\u88ab\u8bbe\u7f6e no_new_privs \u6807\u8bb0\u3002\u5f53\u51fa\u73b0\u5982\u4e0b\u60c5\u51b5\u65f6\uff0cAllowPrivilegeEscalation \u7684\u503c\u59cb\u7ec8\u4e3a true\uff1a</p> <ul> <li>\u5bb9\u5668\u4ee5 <code>privileged</code> \u6a21\u5f0f\u8fd0\u884c</li> <li>\u5bb9\u5668\u62e5\u6709 <code>CAP_SYS_ADMIN</code> \u7684 Linux Capability</li> </ul> </li> </ul>"},{"location":"kubernetes_security/security_context/#pod_security_context","title":"\u4e3a Pod \u8bbe\u7f6e Security Context","text":"<p>\u6211\u4eec\u53ea\u9700\u8981\u5728 Pod \u5b9a\u4e49\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e2d\u6dfb\u52a0 <code>securityContext</code> \u5b57\u6bb5\uff0c\u5c31\u53ef\u4ee5\u4e3a Pod \u6307\u5b9a\u5b89\u5168\u4e0a\u4e0b\u6587\u76f8\u5173\u7684\u8bbe\u5b9a\uff0c\u901a\u8fc7\u8be5\u5b57\u6bb5\u6307\u5b9a\u7684\u5185\u5bb9\u5c06\u4f1a\u5bf9\u5f53\u524d Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u751f\u6548\u3002</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: security-context-pod-demo\nspec:\n  volumes:\n  - name: sec-ctx-vol\n    emptyDir: {}\n  securityContext:\n    runAsUser: 1000\n    runAsGroup: 3000\n    fsGroup: 2000\n  containers:\n  - name: sec-ctx-demo\n    image: busybox\n    command: [\"sh\", \"-c\", \"sleep 60m\"]\n    volumeMounts:\n    - name: sec-ctx-vol\n      mountPath: /pod/demo\n    securityContext:\n      allowPrivilegeEscalation: false\n</code></pre> <p>\u5728\u5f53\u524d\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e2d\u6211\u4eec\u5728 Pod \u4e0b\u9762\u6dfb\u52a0\u4e86 <code>securityContext</code> \u5b57\u6bb5\uff0c\u5176\u4e2d\uff1a</p> <ul> <li> <p><code>runAsUser</code> \u5b57\u6bb5\u6307\u5b9a\u4e86\u8be5 Pod \u4e2d\u6240\u6709\u5bb9\u5668\u7684\u8fdb\u7a0b\u90fd\u4ee5 UID 1000 \u7684\u8eab\u4efd\u8fd0\u884c\uff0c<code>runAsGroup</code> \u5b57\u6bb5\u6307\u5b9a\u4e86\u8be5 Pod \u4e2d\u6240\u6709\u5bb9\u5668\u7684\u8fdb\u7a0b\u90fd\u4ee5 GID 3000 \u7684\u8eab\u4efd\u8fd0\u884c</p> <ul> <li>\u5982\u679c\u7701\u7565\u8be5\u5b57\u6bb5\uff0c\u5bb9\u5668\u8fdb\u7a0b\u7684 GID \u4e3a <code>root(0)</code></li> <li>\u5bb9\u5668\u4e2d\u521b\u5efa\u7684\u6587\u4ef6\uff0c\u5176\u6240\u6709\u8005\u4e3a userID 1000\uff0cgroupID 3000</li> <li> <p><code>fsGroup</code> \u5b57\u6bb5\u6307\u5b9a\u4e86\u8be5 Pod \u7684 fsGroup \u4e3a 2000</p> </li> <li> <p>\u6570\u636e\u5377 \uff08\u5bf9\u5e94\u6302\u8f7d\u70b9 <code>/pod/demo</code> \u7684\u6570\u636e\u5377\u4e3a <code>sec-ctx-demo</code>\uff09 \u7684\u6240\u6709\u8005\u4ee5\u53ca\u5728\u8be5\u6570\u636e\u5377\u4e0b\u521b\u5efa\u7684\u4efb\u4f55\u6587\u4ef6\uff0c\u5176 GID \u90fd\u4e3a 2000</p> </li> </ul> </li> </ul> <p>\u4e0b\u8868\u662f\u6211\u4eec\u5e38\u7528\u7684\u4e00\u4e9b <code>securityContext</code> \u5b57\u6bb5\u8bbe\u7f6e\u5185\u5bb9\u4ecb\u7ecd\uff1a</p> <p></p> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f https:/www.qikqiak.com/k8strain/security/manifests/security-context-pod-demo-yaml\n$ kubectl get pods\nNAME                        READY   STATUS    RESTARTS   AGE\nsecurity-context-pod-demo   1/1     Running   0          6m45s\n</code></pre> <p>\u8fd0\u884c\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u9a8c\u8bc1\u4e0b\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0b\u8fd0\u884c\u7684 ownership\uff1a</p> <pre><code>$ kubectl exec security-context-pod-demo top\nMem: 7586020K used, 422948K free, 298660K shrd, 1247656K buff, 3867660K cached\nCPU:  1% usr  0% sys  0% nic 3% idle  2% io  0% irq  0% sirq\nLoad average: 30 35 35 1/956 50\n  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND\n   46     0 1000     R     1292  0   0  0 top\n    1     0 1000     S     1280  0   0  0 sleep 60m\n</code></pre> <p>\u6211\u4eec\u76f4\u63a5\u8fd0\u884c\u4e00\u4e2a <code>top</code> \u8fdb\u7a0b\uff0c\u67e5\u770b\u5bb9\u5668\u4e2d\u7684\u6240\u6709\u6b63\u5728\u6267\u884c\u7684\u8fdb\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 USER ID \u90fd\u4e3a 1000\uff08<code>runAsUser</code> \u6307\u5b9a\u7684\uff09\uff0c\u7136\u540e\u67e5\u770b\u4e0b\u6302\u8f7d\u7684\u6570\u636e\u5377\u7684 ownership\uff1a</p> <pre><code>$ kubectl exec security-context-pod-demo -- ls -la /pod\ntotal 8\ndrwxr-xr-x    3 root     root          4096 Nov 26 15:44 .\ndrwxr-xr-x    1 root     root          4096 Nov 26 15:44 ..\ndrwxrwsrwx    2 root     2000             6 Nov 26 15:43 demo\n</code></pre> <p>\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u6307\u5b9a\u4e86 <code>fsGroup=2000</code>\uff0c\u6240\u4ee5\u58f0\u660e\u6302\u8f7d\u7684\u6570\u636e\u5377 <code>/pod/demo</code> \u7684 GID \u4e5f\u53d8\u6210\u4e86 2000\u3002\u76f4\u63a5\u8c03\u7528\u5bb9\u5668\u4e2d\u7684 id \u547d\u4ee4\uff1a</p> <pre><code>$ kubectl exec security-context-pod-demo id\nuid=1000 gid=3000 groups=2000\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 gid \u4e3a 3000\uff0c\u4e0e <code>runAsGroup</code> \u5b57\u6bb5\u6240\u6307\u5b9a\u7684\u4e00\u81f4\uff0c\u5982\u679c <code>runAsGroup</code> \u5b57\u6bb5\u88ab\u7701\u7565\uff0c\u5219 gid \u53d6\u503c\u4e3a 0\uff08\u5373 root\uff09\uff0c\u6b64\u65f6\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0b\u5c06\u53ef\u4ee5\u64cd\u4f5c root Group \u7684\u6587\u4ef6\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u73b0\u5728\u60f3\u8981\u53bb\u5220\u9664\u5bb9\u5668\u4e2d\u7684 <code>/tmp</code> \u76ee\u5f55\u5c31\u6ca1\u6709\u6743\u9650\u4e86\uff0c\u56e0\u4e3a\u8be5\u76ee\u5f55\u7684\u7528\u6237\u548c\u7ec4\u90fd\u662f root\uff0c\u800c\u6211\u4eec\u5f53\u524d\u8981\u53bb\u5220\u9664\u4f7f\u7528\u7684\u8fdb\u7a0b\u7684 ID \u53f7\u5c31\u53d8\u6210\u4e86 1000:3000\uff0c\u6240\u4ee5\u6ca1\u6709\u6743\u9650\u64cd\u4f5c\uff1a</p> <pre><code>$ kubectl exec security-context-pod-demo -- ls -la /tmp\ntotal 8\ndrwxrwxrwt    2 root     root          4096 Oct 29 02:40 .\ndrwxr-xr-x    1 root     root          4096 Nov 26 15:44 ..\n$ kubectl exec security-context-pod-demo -- rm -rf /tmp\nrm: can't remove '/tmp': Permission denied\n</code></pre>"},{"location":"kubernetes_security/security_context/#security_context_1","title":"\u4e3a\u5bb9\u5668\u8bbe\u7f6e Security Context","text":"<p>\u9664\u4e86\u5728 Pod \u4e2d\u53ef\u4ee5\u8bbe\u7f6e\u5b89\u5168\u4e0a\u4e0b\u6587\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u5355\u72ec\u4e3a\u67d0\u4e2a\u5bb9\u5668\u8bbe\u7f6e\u5b89\u5168\u4e0a\u4e0b\u6587\uff0c\u540c\u6837\u4e5f\u662f\u901a\u8fc7 <code>securityContext</code> \u5b57\u6bb5\u8bbe\u7f6e\uff0c\u5f53\u8be5\u5b57\u6bb5\u7684\u914d\u7f6e\u4e0e Pod \u7ea7\u522b\u7684 securityContext \u914d\u7f6e\u76f8\u51b2\u7a81\u65f6\uff0c\u5bb9\u5668\u7ea7\u522b\u7684\u914d\u7f6e\u5c06\u8986\u76d6 Pod \u7ea7\u522b\u7684\u914d\u7f6e\u3002\u5bb9\u5668\u7ea7\u522b\u7684 securityContext \u4e0d\u5f71\u54cd Pod \u4e2d\u7684\u6570\u636e\u5377\u3002\u5982\u4e0b\u8d44\u6e90\u6e05\u5355\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: security-context-container-demo\nspec:\n  securityContext:\n    runAsUser: 1000\n  containers:\n  - name: sec-ctx-demo\n    image: busybox\n    command: [ \"sh\", \"-c\", \"sleep 60m\" ]\n    securityContext:\n      runAsUser: 2000\n      allowPrivilegeEscalation: false\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f https:/www.qikqiak.com/k8strain/security/manifests/security-context-pod-demo-yaml\n$ kubectl get pods\nNAME                              READY   STATUS              RESTARTS   AGE\nsecurity-context-container-demo   1/1     Running             0          5s\n</code></pre> <p>\u540c\u6837\u6211\u4eec\u76f4\u63a5\u6267\u884c\u5bb9\u5668\u4e2d\u7684 <code>top</code> \u547d\u4ee4\uff1a</p> <pre><code>$ kubectl exec security-context-container-demo top\nMem: 4991896K used, 3016924K free, 52308K shrd, 158364K buff, 3282996K cached\nCPU:  6% usr  8% sys  6% nic 8% idle  0% io  0% irq  0% sirq\nLoad average: 12 09 12 1/848 10\n  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND\n    6     0 2000     R     1292  0   1  0 top\n    1     0 2000     S     1280  0   3  0 sleep 60m\n</code></pre> <p>\u5bb9\u5668\u7684\u8fdb\u7a0b\u4ee5 UID 2000 \u7684\u8eab\u4efd\u8fd0\u884c\uff0c\u8be5\u53d6\u503c\u7531 </p> <pre><code>spec.containers[*].securityContext.runAsUser\n</code></pre> <p>\u5bb9\u5668\u7ec4\u4e2d\u7684\u5b57\u6bb5\u5b9a\u4e49\u3002Pod \u4e2d\u5b9a\u4e49\u7684 </p> <pre><code>spec.securityContext.runAsUser\n</code></pre> <p>\u53d6\u503c 1000 \u88ab\u8986\u76d6\u3002</p>"},{"location":"kubernetes_security/security_context/#linux_capabilities","title":"\u8bbe\u7f6e Linux Capabilities","text":"<p>\u6211\u4eec\u4f7f\u7528 <code>docker run</code> \u7684\u65f6\u5019\u53ef\u4ee5\u901a\u8fc7 <code>--cap-add</code> \u548c <code>--cap-drop</code> \u547d\u4ee4\u6765\u7ed9\u5bb9\u5668\u6dfb\u52a0 <code>Linux Capabilities</code>\u3002\u90a3\u4e48\u5728 Kubernetes \u4e0b\u9762\u5982\u4f55\u6765\u8bbe\u7f6e\u5462\uff1f\u8981\u4e86\u89e3\u5982\u4f55\u8bbe\u7f6e\uff0c\u9996\u5148\u6211\u4eec\u8fd8\u662f\u9700\u8981\u4e86\u89e3\u4e0b <code>Linux Capabilities</code> \u662f\u4ec0\u4e48\uff1f</p>"},{"location":"kubernetes_security/security_context/#linux_capabilities_1","title":"Linux Capabilities","text":"<p>\u8981\u4e86\u89e3 <code>Linux Capabilities</code>\uff0c\u8fd9\u5c31\u5f97\u4ece Linux \u7684\u6743\u9650\u63a7\u5236\u53d1\u5c55\u6765\u8bf4\u660e\u3002\u5728 Linux 2.2 \u7248\u672c\u4e4b\u524d\uff0c\u5f53\u5185\u6838\u5bf9\u8fdb\u7a0b\u8fdb\u884c\u6743\u9650\u9a8c\u8bc1\u7684\u65f6\u5019\uff0cLinux \u5c06\u8fdb\u7a0b\u5212\u5206\u4e3a\u4e24\u7c7b\uff1a\u7279\u6743\u8fdb\u7a0b\uff08UID=0\uff0c\u4e5f\u5c31\u662f\u8d85\u7ea7\u7528\u6237\uff09\u548c\u975e\u7279\u6743\u8fdb\u7a0b\uff08UID!=0\uff09\uff0c\u7279\u6743\u8fdb\u7a0b\u62e5\u6709\u6240\u6709\u7684\u5185\u6838\u6743\u9650\uff0c\u800c\u975e\u7279\u6743\u8fdb\u7a0b\u5219\u6839\u636e\u8fdb\u7a0b\u51ed\u8bc1\uff08effective UID, effective GID\uff0csupplementary group \u7b49\uff09\u8fdb\u884c\u6743\u9650\u68c0\u67e5\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u4ee5\u5e38\u7528\u7684 <code>passwd</code> \u547d\u4ee4\u4e3a\u4f8b\uff0c\u4fee\u6539\u7528\u6237\u5bc6\u7801\u9700\u8981\u5177\u6709 root \u6743\u9650\uff0c\u800c\u666e\u901a\u7528\u6237\u662f\u6ca1\u6709\u8fd9\u4e2a\u6743\u9650\u7684\u3002\u4f46\u662f\u5b9e\u9645\u4e0a\u666e\u901a\u7528\u6237\u53c8\u53ef\u4ee5\u4fee\u6539\u81ea\u5df1\u7684\u5bc6\u7801\uff0c\u8fd9\u662f\u600e\u4e48\u56de\u4e8b\u5462\uff1f\u5728 Linux \u7684\u6743\u9650\u63a7\u5236\u673a\u5236\u4e2d\uff0c\u6709\u4e00\u7c7b\u6bd4\u8f83\u7279\u6b8a\u7684\u6743\u9650\u8bbe\u7f6e\uff0c\u6bd4\u5982 SUID(Set User ID on execution)\uff0c\u5141\u8bb8\u7528\u6237\u4ee5\u53ef\u6267\u884c\u6587\u4ef6\u7684 owner \u7684\u6743\u9650\u6765\u8fd0\u884c\u53ef\u6267\u884c\u6587\u4ef6\u3002\u56e0\u4e3a\u7a0b\u5e8f\u6587\u4ef6 <code>/bin/passwd</code> \u88ab\u8bbe\u7f6e\u4e86 <code>SUID</code> \u6807\u8bc6\uff0c\u6240\u4ee5\u666e\u901a\u7528\u6237\u5728\u6267\u884c passwd \u547d\u4ee4\u65f6\uff0c\u8fdb\u7a0b\u662f\u4ee5 passwd \u7684\u6240\u6709\u8005\uff0c\u4e5f\u5c31\u662f root \u7528\u6237\u7684\u8eab\u4efd\u8fd0\u884c\uff0c\u4ece\u800c\u5c31\u53ef\u4ee5\u4fee\u6539\u5bc6\u7801\u4e86\u3002</p> <p>\u4f46\u662f\u4f7f\u7528 <code>SUID</code> \u5374\u5e26\u6765\u4e86\u65b0\u7684\u5b89\u5168\u9690\u60a3\uff0c\u5f53\u6211\u4eec\u8fd0\u884c\u8bbe\u7f6e\u4e86 <code>SUID</code> \u7684\u547d\u4ee4\u65f6\uff0c\u901a\u5e38\u53ea\u662f\u9700\u8981\u5f88\u5c0f\u4e00\u90e8\u5206\u7684\u7279\u6743\uff0c\u4f46\u662f <code>SUID</code> \u5374\u7ed9\u4e86\u5b83 root \u5177\u6709\u7684\u5168\u90e8\u6743\u9650\uff0c\u4e00\u65e6 \u88ab\u8bbe\u7f6e\u4e86 <code>SUID</code> \u7684\u547d\u4ee4\u51fa\u73b0\u6f0f\u6d1e\uff0c\u662f\u4e0d\u662f\u5c31\u5f88\u5bb9\u6613\u88ab\u5229\u7528\u4e86\u3002</p> <p>\u4e3a\u6b64 Linux \u5f15\u5165\u4e86 <code>Capabilities</code> \u673a\u5236\u6765\u5bf9 root \u6743\u9650\u8fdb\u884c\u4e86\u66f4\u52a0\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\uff0c\u5b9e\u73b0\u6309\u9700\u8fdb\u884c\u6388\u6743\uff0c\u8fd9\u6837\u5c31\u5927\u5927\u51cf\u5c0f\u4e86\u7cfb\u7edf\u7684\u5b89\u5168\u9690\u60a3\u3002</p>"},{"location":"kubernetes_security/security_context/#capabilities","title":"\u4ec0\u4e48\u662f Capabilities","text":"<p>\u4ece\u5185\u6838 2.2 \u5f00\u59cb\uff0cLinux \u5c06\u4f20\u7edf\u4e0a\u4e0e\u8d85\u7ea7\u7528\u6237 root \u5173\u8054\u7684\u7279\u6743\u5212\u5206\u4e3a\u4e0d\u540c\u7684\u5355\u5143\uff0c\u79f0\u4e3a <code>capabilites</code>\u3002<code>Capabilites</code> \u6bcf\u4e2a\u5355\u5143\u90fd\u53ef\u4ee5\u72ec\u7acb\u542f\u7528\u548c\u7981\u7528\u3002\u8fd9\u6837\u5f53\u7cfb\u7edf\u5728\u4f5c\u6743\u9650\u68c0\u67e5\u7684\u65f6\u5019\u5c31\u53d8\u6210\u4e86\uff1a<code>\u5728\u6267\u884c\u7279\u6743\u64cd\u4f5c\u65f6\uff0c\u5982\u679c\u8fdb\u7a0b\u7684\u6709\u6548\u8eab\u4efd\u4e0d\u662f root\uff0c\u5c31\u53bb\u68c0\u67e5\u662f\u5426\u5177\u6709\u8be5\u7279\u6743\u64cd\u4f5c\u6240\u5bf9\u5e94\u7684 capabilites\uff0c\u5e76\u4ee5\u6b64\u51b3\u5b9a\u662f\u5426\u53ef\u4ee5\u8fdb\u884c\u8be5\u7279\u6743\u64cd\u4f5c</code>\u3002\u6bd4\u5982\u5982\u679c\u6211\u4eec\u8981\u8bbe\u7f6e\u7cfb\u7edf\u65f6\u95f4\uff0c\u5c31\u5f97\u5177\u6709 <code>CAP_SYS_TIME</code> \u8fd9\u4e2a capabilites\u3002\u4e0b\u9762\u662f\u4ece capabilities man page \u4e2d\u6458\u53d6\u7684 capabilites \u5217\u8868\uff1a</p> <p></p>"},{"location":"kubernetes_security/security_context/#capabilities_1","title":"\u5982\u4f55\u4f7f\u7528 Capabilities","text":"<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>getcap</code> \u548c <code>setcap</code> \u4e24\u6761\u547d\u4ee4\u6765\u5206\u522b\u67e5\u770b\u548c\u8bbe\u7f6e\u7a0b\u5e8f\u6587\u4ef6\u7684 <code>capabilities</code> \u5c5e\u6027\u3002\u6bd4\u5982\u5f53\u524d\u6211\u4eec\u662f<code>zuiapp</code> \u8fd9\u4e2a\u7528\u6237\uff0c\u4f7f\u7528 <code>getcap</code> \u547d\u4ee4\u67e5\u770b <code>ping</code> \u547d\u4ee4\u76ee\u524d\u5177\u6709\u7684 <code>capabilities</code>\uff1a</p> <pre><code>$ ll /bin/ping\n-rwxr-xr-x. 1 root root 62088 Nov  7  2016 /bin/ping\n$ getcap /bin/ping\n/bin/ping = cap_net_admin,cap_net_raw+p\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5177\u6709 <code>cap_net_admin</code> \u8fd9\u4e2a\u5c5e\u6027\uff0c\u6240\u4ee5\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u6267\u884c <code>ping</code> \u547d\u4ee4\uff1a</p> <pre><code>$ ping www.qikqiak.com\nPING www.qikqiak.com.w.kunlungr.com (12186) 56(84) bytes of data.\n64 bytes from 12186 (12186): icmp_seq=1 ttl=54 time=87 ms\n64 bytes from 12186 (12186): icmp_seq=2 ttl=54 time=85 ms\n</code></pre> <p>\u4f46\u662f\u5982\u679c\u6211\u4eec\u628a\u547d\u4ee4\u7684 <code>capabilities</code> \u5c5e\u6027\u79fb\u9664\u6389\uff1a</p> <pre><code>$ sudo setcap cap_net_admin,cap_net_raw-p /bin/ping\n$ getcap /bin/ping\n/bin/ping =\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u6267\u884c <code>ping</code> \u547d\u4ee4\u53ef\u4ee5\u53d1\u73b0\u5df2\u7ecf\u6ca1\u6709\u6743\u9650\u4e86\uff1a</p> <pre><code>$ ping www.qikqiak.com\nping: socket: Operation not permitted\n</code></pre> <p>\u56e0\u4e3a ping \u547d\u4ee4\u5728\u6267\u884c\u65f6\u9700\u8981\u8bbf\u95ee\u7f51\u7edc\uff0c\u6240\u9700\u7684 <code>capabilities</code> \u4e3a <code>cap_net_admin</code> \u548c <code>cap_net_raw</code>\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>setcap</code> \u547d\u4ee4\u53ef\u6765\u6dfb\u52a0\u5b83\u4eec\uff1a</p> <pre><code>$ sudo setcap cap_net_admin,cap_net_raw+p /bin/ping\n$ getcap /bin/ping\n/bin/ping = cap_net_admin,cap_net_raw+p\n$ ping www.qikqiak.com\nPING www.qikqiak.com.w.kunlungr.com (12188) 56(84) bytes of data.\n64 bytes from 12188 (12188): icmp_seq=1 ttl=54 time=39 ms\n</code></pre> <p>\u547d\u4ee4\u4e2d\u7684 <code>p</code> \u8868\u793a <code>Permitted</code> \u96c6\u5408(\u63a5\u4e0b\u6765\u4f1a\u4ecb\u7ecd)\uff0c<code>+</code> \u53f7\u8868\u793a\u628a\u6307\u5b9a\u7684<code>capabilities</code> \u6dfb\u52a0\u5230\u8fd9\u4e9b\u96c6\u5408\u4e2d\uff0c<code>-</code> \u53f7\u8868\u793a\u4ece\u96c6\u5408\u4e2d\u79fb\u9664\u3002</p> <p>\u5bf9\u4e8e\u53ef\u6267\u884c\u6587\u4ef6\u7684\u5c5e\u6027\u4e2d\u6709\u4e09\u4e2a\u96c6\u5408\u6765\u4fdd\u5b58\u4e09\u7c7b <code>capabilities</code>\uff0c\u5b83\u4eec\u5206\u522b\u662f\uff1a</p> <ul> <li>Permitted\uff1a\u5728\u8fdb\u7a0b\u6267\u884c\u65f6\uff0cPermitted \u96c6\u5408\u4e2d\u7684 capabilites \u81ea\u52a8\u88ab\u52a0\u5165\u5230\u8fdb\u7a0b\u7684 Permitted \u96c6\u5408\u4e2d\u3002</li> <li>Inheritable\uff1aInheritable \u96c6\u5408\u4e2d\u7684 capabilites \u4f1a\u4e0e\u8fdb\u7a0b\u7684 Inheritable \u96c6\u5408\u6267\u884c\u4e0e\u64cd\u4f5c\uff0c\u4ee5\u786e\u5b9a\u8fdb\u7a0b\u5728\u6267\u884c execve \u51fd\u6570\u540e\u54ea\u4e9b capabilites \u88ab\u7ee7\u627f\u3002</li> <li>Effective\uff1aEffective \u53ea\u662f\u4e00\u4e2a bit\u3002\u5982\u679c\u8bbe\u7f6e\u4e3a\u5f00\u542f\uff0c\u90a3\u4e48\u5728\u6267\u884c execve \u51fd\u6570\u540e\uff0cPermitted \u96c6\u5408\u4e2d\u65b0\u589e\u7684 capabilities \u4f1a\u81ea\u52a8\u51fa\u73b0\u5728\u8fdb\u7a0b\u7684 Effective \u96c6\u5408\u4e2d\u3002</li> </ul> <p>\u5bf9\u4e8e\u8fdb\u7a0b\u4e2d\u6709\u4e94\u79cd <code>capabilities</code> \u96c6\u5408\u7c7b\u578b\uff0c\u76f8\u6bd4\u6587\u4ef6\u7684 <code>capabilites</code>\uff0c\u8fdb\u7a0b\u7684 <code>capabilities</code> \u591a\u4e86\u4e24\u4e2a\u96c6\u5408\uff0c\u5206\u522b\u662f <code>Bounding</code> \u548c <code>Ambient</code>\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u540d\u6765\u67e5\u770b\u5f53\u524d\u8fdb\u7a0b\u7684 <code>capabilities</code> \u4fe1\u606f\uff1a</p> <pre><code>$ cat /proc/7029/status | grep 'Cap'  #7029\u4e3aPID\nCapInh: 0000000000000000\nCapPrm: 0000000000000000\nCapEff: 0000000000000000\nCapBnd: 0000001fffffffff\nCapAmb: 0000000000000000\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>capsh</code> \u547d\u4ee4\u628a\u5b83\u4eec\u8f6c\u4e49\u4e3a\u53ef\u8bfb\u7684\u683c\u5f0f\uff0c\u8fd9\u6837\u57fa\u672c\u53ef\u4ee5\u770b\u51fa\u8fdb\u7a0b\u5177\u6709\u7684 <code>capabilities</code> \u4e86\uff1a</p> <pre><code>$ capsh --decode=0000001fffffffff\n0x0000001fffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,35,36\n</code></pre>"},{"location":"kubernetes_security/security_context/#docker_container_capabilities","title":"Docker Container Capabilities","text":"<p>\u6211\u4eec\u8bf4 Docker \u5bb9\u5668\u672c\u8d28\u4e0a\u5c31\u662f\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u6240\u4ee5\u7406\u8bba\u4e0a\u5bb9\u5668\u5c31\u4f1a\u548c\u8fdb\u7a0b\u4e00\u6837\u4f1a\u6709\u4e00\u4e9b\u9ed8\u8ba4\u7684\u5f00\u653e\u6743\u9650\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b Docker \u4f1a\u5220\u9664\u5fc5\u987b\u7684 <code>capabilities</code> \u4e4b\u5916\u7684\u6240\u6709 <code>capabilities</code>\uff0c\u56e0\u4e3a\u5728\u5bb9\u5668\u4e2d\u6211\u4eec\u7ecf\u5e38\u4f1a\u4ee5 root \u7528\u6237\u6765\u8fd0\u884c\uff0c\u4f7f\u7528 <code>capabilities</code> \u73b0\u5728\u540e\uff0c\u5bb9\u5668\u4e2d\u7684\u4f7f\u7528\u7684 root \u7528\u6237\u6743\u9650\u5c31\u6bd4\u6211\u4eec\u5e73\u65f6\u5728\u5bbf\u4e3b\u673a\u4e0a\u4f7f\u7528\u7684 root \u7528\u6237\u6743\u9650\u8981\u5c11\u5f88\u591a\u4e86\uff0c\u8fd9\u6837\u5373\u4f7f\u51fa\u73b0\u4e86\u5b89\u5168\u6f0f\u6d1e\uff0c\u4e5f\u5f88\u96be\u7834\u574f\u6216\u8005\u83b7\u53d6\u5bbf\u4e3b\u673a\u7684 root \u6743\u9650\uff0c\u6240\u4ee5 Docker \u652f\u6301 <code>Capabilities</code> \u5bf9\u4e8e\u5bb9\u5668\u7684\u5b89\u5168\u6027\u6765\u8bf4\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\u3002</p> <p>\u4e0d\u8fc7\u6211\u4eec\u5728\u8fd0\u884c\u5bb9\u5668\u7684\u65f6\u5019\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a <code>--privileded</code> \u53c2\u6570\u6765\u5f00\u542f\u5bb9\u5668\u7684\u8d85\u7ea7\u6743\u9650\uff0c\u8fd9\u4e2a\u53c2\u6570\u4e00\u5b9a\u8981\u614e\u7528\uff0c\u56e0\u4e3a\u4ed6\u4f1a\u83b7\u53d6\u7cfb\u7edf root \u7528\u6237\u6240\u6709\u80fd\u529b\u8d4b\u503c\u7ed9\u5bb9\u5668\uff0c\u5e76\u4e14\u4f1a\u626b\u63cf\u5bbf\u4e3b\u673a\u7684\u6240\u6709\u8bbe\u5907\u6587\u4ef6\u6302\u8f7d\u5230\u5bb9\u5668\u5185\u90e8\uff0c\u6240\u4ee5\u662f\u975e\u5e38\u5371\u9669\u7684\u64cd\u4f5c\u3002</p> <p>\u4f46\u662f\u5982\u679c\u4f60\u786e\u5b9e\u9700\u8981\u4e00\u4e9b\u7279\u6b8a\u7684\u6743\u9650\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>--cap-add</code> \u548c <code>--cap-drop</code> \u8fd9\u4e24\u4e2a\u53c2\u6570\u6765\u52a8\u6001\u8c03\u6574\uff0c\u53ef\u4ee5\u6700\u5927\u9650\u5ea6\u5730\u4fdd\u8bc1\u5bb9\u5668\u7684\u4f7f\u7528\u5b89\u5168\u3002\u4e0b\u9762\u8868\u683c\u4e2d\u5217\u51fa\u7684 <code>Capabilities</code> \u662f Docker \u9ed8\u8ba4\u7ed9\u5bb9\u5668\u6dfb\u52a0\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>--cap-drop</code> \u53bb\u9664\u5176\u4e2d\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\uff1a</p> <p></p> <p>\u4e0b\u9762\u8868\u683c\u4e2d\u5217\u51fa\u7684 <code>Capabilities</code> \u662f Docker \u9ed8\u8ba4\u5220\u9664\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>--cap-add</code>\u6dfb\u52a0\u5176\u4e2d\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\uff1a</p> <p></p> <p><code>--cap-add</code>\u548c<code>--cap-drop</code> \u8fd9\u4e24\u53c2\u6570\u90fd\u652f\u6301<code>ALL</code>\u503c\uff0c\u6bd4\u5982\u5982\u679c\u4f60\u60f3\u8ba9\u67d0\u4e2a\u5bb9\u5668\u62e5\u6709\u9664\u4e86<code>MKNOD</code>\u4e4b\u5916\u7684\u6240\u6709\u5185\u6838\u6743\u9650\uff0c\u90a3\u4e48\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a </p> <pre><code>$ sudo docker run --cap-add=ALL --cap-drop=MKNOD ...\n</code></pre> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u9700\u8981\u4fee\u6539\u7f51\u7edc\u63a5\u53e3\u6570\u636e\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u6ca1\u6709\u6743\u9650\u7684\uff0c\u56e0\u4e3a\u9700\u8981\u7684 <code>NET_ADMIN</code> \u8fd9\u4e2a <code>Capabilities</code> \u9ed8\u8ba4\u88ab\u79fb\u9664\u4e86\uff1a</p> <pre><code>$ docker run -it --rm busybox /bin/sh\n/ # ip link add dummy0 type dummy\nip: RTNETLINK answers: Operation not permitted\n/ #\n</code></pre> <p>\u6240\u4ee5\u5728\u4e0d\u4f7f\u7528 <code>--privileged</code> \u7684\u60c5\u51b5\u4e0b\uff08\u4e0d\u5efa\u8bae\uff09\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>--cap-add=NET_ADMIN</code> \u5c06\u8fd9\u4e2a <code>Capabilities</code> \u6dfb\u52a0\u56de\u6765\uff1a</p> <pre><code>$ docker run -it --rm --cap-add=NET_ADMIN busybox /bin/sh\n/ # ip link add dummy0 type dummy\n/ #\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf OK \u4e86\u3002</p>"},{"location":"kubernetes_security/security_context/#kubernetes_capabilities","title":"Kubernetes \u914d\u7f6e Capabilities","text":"<p>\u4e0a\u9762\u6211\u4ecb\u7ecd\u4e86\u5728 Docker \u5bb9\u5668\u4e0b\u5982\u4f55\u6765\u914d\u7f6e <code>Capabilities</code>\uff0c\u5728 Kubernetes \u4e2d\u4e5f\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u6765\u5b9a\u4e49\uff0c\u6211\u4eec\u53ea\u9700\u8981\u6dfb\u52a0\u5230 Pod \u5b9a\u4e49\u7684 </p> <pre><code>spec.containers.sercurityContext.capabilities\n</code></pre> <p>\u4e2d\u5373\u53ef\uff0c\u4e5f\u53ef\u4ee5\u8fdb\u884c <code>add</code> \u548c <code>drop</code> \u914d\u7f6e\uff0c\u540c\u6837\u4e0a\u9762\u7684\u793a\u4f8b\uff0c\u6211\u4eec\u8981\u7ed9 busybox \u5bb9\u5668\u6dfb\u52a0 <code>NET_ADMIN</code> \u8fd9\u4e2a <code>Capabilities</code>\uff0c\u5bf9\u5e94\u7684 YAML \u6587\u4ef6\u53ef\u4ee5\u8fd9\u6837\u5b9a\u4e49\uff1a(cpb-demo.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: cpb-demo\nspec:\n  containers:\n  - name: cpb\n    image: busybox\n    args:\n    - sleep\n    - \"3600\"\n    securityContext:\n      capabilities:\n        add: # \u6dfb\u52a0\n        - NET_ADMIN\n        drop:  # \u5220\u9664\n        - KILL\n</code></pre> <p>\u6211\u4eec\u5728 <code>securityContext</code> \u4e0b\u9762\u6dfb\u52a0\u4e86 <code>capabilities</code> \u5b57\u6bb5\uff0c\u5176\u4e2d\u6dfb\u52a0\u4e86 <code>NET_ADMIN</code> \u5e76\u4e14\u5220\u9664\u4e86 <code>KILL</code> \u8fd9\u4e2a\u9ed8\u8ba4\u7684\u5bb9\u5668 <code>Capabilities</code>\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 Pod \u4e2d\u4fee\u6539\u7f51\u7edc\u63a5\u53e3\u6570\u636e\u4e86\uff1a</p> <pre><code>$ kubectl apply -f cpb-demo.yaml\n$ kubectl get pods\nNAME                      READY   STATUS    RESTARTS   AGE\ncpb-demo                  1/1     Running   0          2m9s\n$ kubectl exec -it cpb-demo /bin/sh\n/ # ip link add dummy0 type dummy\n/ #\n</code></pre> <p>\u5728 Kubernetes \u4e2d\u901a\u8fc7 </p> <pre><code>sercurityContext.capabilities\n</code></pre> <p>\u8fdb\u884c\u914d\u7f6e\u5bb9\u5668\u7684 <code>Capabilities</code>\uff0c\u5f53\u7136\u6700\u7ec8\u8fd8\u662f\u901a\u8fc7 Docker \u7684 <code>libcontainer</code> \u53bb\u501f\u52a9 </p> <pre><code>Linux kernel capabilities\n</code></pre> <p>\u5b9e\u73b0\u7684\u6743\u9650\u7ba1\u7406\u3002</p>"},{"location":"kubernetes_security/security_context/#selinux","title":"\u4e3a\u5bb9\u5668\u8bbe\u7f6e <code>SELinux</code> \u6807\u7b7e","text":"<p><code>SELinux</code> (Security-Enhanced Linux) \u662f\u4e00\u79cd\u5f3a\u5236\u8bbf\u95ee\u63a7\u5236\uff08mandatory access control\uff09\u7684\u5b9e\u73b0\u3002\u5b83\u7684\u4f5c\u6cd5\u662f\u4ee5\u6700\u5c0f\u6743\u9650\u539f\u5219\uff08principle of least privilege\uff09\u4e3a\u57fa\u7840\uff0c\u5728 Linux \u6838\u5fc3\u4e2d\u4f7f\u7528 Linux \u5b89\u5168\u6a21\u5757\uff08Linux Security Modules\uff09\u3002Pod \u6216\u5bb9\u5668\u5b9a\u4e49\u7684 securityContext \u4e2d <code>seLinuxOptions</code> \u5b57\u6bb5\u662f\u4e00\u4e2a SELinuxOptions \u5bf9\u8c61\uff0c\u8be5\u5b57\u6bb5\u53ef\u7528\u4e8e\u4e3a\u5bb9\u5668\u6307\u5b9a <code>SELinux</code> \u6807\u7b7e\u3002</p> <pre><code>securityContext:\n  seLinuxOptions:\n    level: \"s0:c123,c456\"\n</code></pre>"},{"location":"kubernetes_security/security_context/#apparmor","title":"AppArmor","text":"<p>TODO</p>"},{"location":"kubernetes_security/security_context/#seccomp","title":"Seccomp","text":"<p>TODO</p> <p>\u9664\u4e86\u8fd9\u4e9b\u9488\u5bf9\u5bb9\u5668\u548c Pod \u7684\u4e00\u4e9b\u5b89\u5168\u7ba1\u63a7\u4e4b\u5916\uff0c\u8fd8\u6709\u96c6\u7fa4\u7ea7\u522b\u7684\u5b89\u5168\u7b56\u7565\u8bbe\u7f6e Pod Security Policies\uff08PSP\uff09\uff0c\u53ef\u4ee5\u81ea\u52a8\u4e3a\u96c6\u7fa4\u5185\u7684 Pod \u548c Volume \u8bbe\u7f6e Security Context\u3002</p>"},{"location":"kubernetes_service_mesh/cert_manager/","title":"CertManager","text":""},{"location":"kubernetes_service_mesh/cert_manager/#certmanager_https","title":"CertManager \u81ea\u52a8 HTTPS","text":"<p>cert-manager \u662f\u4e00\u79cd\u81ea\u52a8\u6267\u884c\u8bc1\u4e66\u7ba1\u7406\u7684\u5de5\u5177\uff0c\u5b83\u53ef\u4ee5\u4e0e Istio Gateway \u96c6\u6210\u4ee5\u7ba1\u7406 TLS \u8bc1\u4e66\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u5f88\u65b9\u4fbf\u5730\u548c\u524d\u9762\u6211\u4eec\u914d\u7f6e\u7684 ingress-nginx \u6216\u8005 traefik \u914d\u5408\u4f7f\u7528\u3002\u5bf9\u4e8e\u548c Istio \u7684\u96c6\u6210\u4f7f\u7528\uff0c\u65e0\u9700\u7279\u6b8a\u914d\u7f6e\u5373\u53ef\u3002</p> <p>\u6ce8\u610f</p> <p>\u5728\u8fdb\u884c\u672c\u8282\u5b9e\u9a8c\u4e4b\u524d\u8bb0\u5f97\u5c06\u524d\u9762\u7ae0\u8282\u7684\u5b9e\u9a8c\u5185\u5bb9\u8fdb\u884c\u6e05\u7a7a\u3002</p>"},{"location":"kubernetes_service_mesh/cert_manager/#_1","title":"\u5b89\u88c5","text":"<p>\u8981\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88c5 cert-manager \u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u5b98\u65b9\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5355\u4e00\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u5305\u542b\u4e86\u6240\u6709\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6240\u4ee5\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a</p> <pre><code># Kubernetes 15+\n$ kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v1/cert-manager.yaml\n# Kubernetes &lt;15\n$ kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v1/cert-manager-legacy.yaml\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a cert-manager \u7684\u547d\u540d\u7a7a\u95f4\uff0c\u5b89\u88c5\u5927\u91cf\u7684 CRD \u4ee5\u53ca AdmissionWebhook \u5bf9\u8c61\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u6765\u67e5\u770b\u662f\u5426\u5b89\u88c5\u6210\u529f\uff1a</p> <pre><code>$ kubectl get pods --namespace cert-manager\nNAME                                       READY   STATUS    RESTARTS   AGE\ncert-manager-7ddc5b4db-56nln               1/1     Running   0          4m46s\ncert-manager-cainjector-6644dc4975-zthcj   1/1     Running   0          4m47s\ncert-manager-webhook-7b887475fb-9fbp4      1/1     Running   0          4m45s\n</code></pre> <p>\u6b63\u5e38\u60c5\u51b5\u4e0b\u53ef\u4ee5\u770b\u5230 cert-manager\u3001cert-manager-cainjector \u4ee5\u53ca cert-manager-webhook \u8fd9\u51e0\u4e2a Pod \u5904\u4e8e Running \u72b6\u6001\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u6d4b\u8bd5\u6765\u9a8c\u8bc1\u4e0b\u662f\u5426\u53ef\u4ee5\u7b7e\u53d1\u57fa\u672c\u7684\u8bc1\u4e66\u7c7b\u578b\uff0c\u521b\u5efa\u4e00\u4e2a Issuer \u8d44\u6e90\u5bf9\u8c61\u6765\u6d4b\u8bd5 webhook \u5de5\u4f5c\u662f\u5426\u6b63\u5e38(\u5728\u5f00\u59cb\u7b7e\u53d1\u8bc1\u4e66\u4e4b\u524d\uff0c\u5fc5\u987b\u5728\u7fa4\u96c6\u4e2d\u81f3\u5c11\u914d\u7f6e\u4e00\u4e2a Issuer \u6216 ClusterIssuer \u8d44\u6e90)\uff1a</p> <pre><code>$ cat &lt;&lt;EOF &gt; test-resources.yaml\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: cert-manager-test\n---\napiVersion: cert-manager.io/v1alpha2\nkind: Issuer\nmetadata:\n  name: test-selfsigned\n  namespace: cert-manager-test\nspec:\n  selfSigned: {}  # \u914d\u7f6e\u81ea\u7b7e\u540d\u7684\u8bc1\u4e66\u673a\u6784\u7c7b\u578b\n---\napiVersion: cert-manager.io/v1alpha2\nkind: Certificate\nmetadata:\n  name: selfsigned-cert\n  namespace: cert-manager-test\nspec:\n  dnsNames:\n  - example.com\n  secretName: selfsigned-cert-tls\n  issuerRef:\n    name: test-selfsigned\nEOF\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u540d\u4e3a <code>cert-manager-test</code> \u7684\u547d\u540d\u7a7a\u95f4\uff0c\u521b\u5efa\u4e86\u4e00\u4e2a Issuer \u7684\u8bc1\u4e66\u9881\u53d1\u673a\u6784\uff0c\u7136\u540e\u4f7f\u7528\u8fd9\u4e2a Issuer \u6765\u521b\u5efa\u4e00\u4e2a\u8bc1\u4e66 Certificate \u5bf9\u8c61\uff0c\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f test-resources.yaml \nnamespace/cert-manager-test created\nissuer.cert-manager.io/test-selfsigned created\ncertificate.cert-manager.io/selfsigned-cert created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u53ef\u4ee5\u68c0\u67e5\u65b0\u521b\u5efa\u7684\u8bc1\u4e66\u72b6\u6001\uff0c\u5728 cert-manager \u5904\u7406\u8bc1\u4e66\u8bf7\u6c42\u4e4b\u524d\uff0c\u53ef\u80fd\u9700\u8981\u7a0d\u5fae\u7b49\u51e0\u79d2\uff1a</p> <pre><code>$ kubectl describe certificate -n cert-manager-test\nName:         selfsigned-cert\nNamespace:    cert-manager-test\n......\nSpec:\n  Dns Names:\n    example.com\n  Issuer Ref:\n    Name:       test-selfsigned\n  Secret Name:  selfsigned-cert-tls\nStatus:\n  Conditions:\n    Last Transition Time:  2020-08-16T01:50:40Z\n    Message:               Certificate is up to date and has not expired\n    Reason:                Ready\n    Status:                True\n    Type:                  Ready\n  Not After:               2020-11-14T01:50:39Z\n  Not Before:              2020-08-16T01:50:39Z\n  Renewal Time:            2020-10-15T01:50:39Z\n  Revision:                1\nEvents:\n  Type    Reason     Age   From          Message\n  ----    ------     ----  ----          -------\n  Normal  Issuing    64s   cert-manager  Issuing certificate as Secret does not exist\n  Normal  Generated  64s   cert-manager  Stored new private key in temporary Secret resource \"selfsigned-cert-25ftw\"\n  Normal  Requested  64s   cert-manager  Created new CertificateRequest resource \"selfsigned-cert-p2sbx\"\n  Normal  Issuing    63s   cert-manager  The certificate has been successfully issued\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684 Events \u4e8b\u4ef6\u4e2d\u6211\u4eec\u53ef\u4ee5\u8bc1\u4e66\u5df2\u7ecf\u6210\u529f\u7b7e\u53d1\u4e86\uff0c\u5230\u8fd9\u91cc\u8bc1\u660e\u6211\u4eec\u7684 cert-manager \u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\u3002\u800c\u4e14\u6211\u4eec\u9700\u8981\u6ce8\u610f\u7684\u662f cert-manager \u7684\u529f\u80fd\u975e\u5e38\u5f3a\u5927\uff0c\u4e0d\u53ea\u662f\u53ef\u4ee5\u652f\u6301 ACME \u7c7b\u578b\u7684\u8bc1\u4e66\u7b7e\u53d1\uff0c\u8fd8\u652f\u6301\u5176\u4ed6\u4f17\u591a\u7684\u7c7b\u578b\uff0c\u6bd4\u5982 SelfSigned(\u81ea\u7b7e\u540d)\u3001CA\u3001Vault\u3001Venafi\u3001External\u3001ACME\uff0c\u53ea\u662f\u6211\u4eec\u4e00\u822c\u4e3b\u8981\u662f\u4f7f\u7528 ACME \u6765\u5e2e\u6211\u4eec\u751f\u6210\u81ea\u52a8\u5316\u7684\u8bc1\u4e66\u3002</p>"},{"location":"kubernetes_service_mesh/cert_manager/#_2","title":"\u73af\u5883\u914d\u7f6e","text":"<p>\u7531\u4e8e\u901a\u8fc7 ACME \u505a\u81ea\u52a8\u5316\u8bc1\u4e66\u7684\u65f6\u5019\uff0c\u9700\u8981\u66b4\u9732 80 \u548c 443 \u7aef\u53e3\uff0c\u5f53\u7136\u5982\u679c\u6211\u4eec\u4f7f\u7528 DNS \u6821\u9a8c\u65b9\u5f0f\u4e5f\u53ef\u4ee5\uff0c\u4f46\u662f\u6709\u65f6\u5019\u6211\u4eec\u6839\u672c\u5c31\u6ca1\u6709\u57df\u540d\u7684\u60c5\u51b5\u4e0b\u60f3\u8981\u5b9e\u73b0\u81ea\u52a8\u5316\u8bc1\u4e66\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>xip.io</code> \u8fd9\u7c7b\u7684\u670d\u52a1\u6765\u5b9e\u73b0\u3002\u524d\u9762\u6211\u4eec\u90e8\u7f72 istio-ingressgateway \u7684\u65f6\u5019\u662f\u901a\u8fc7 NodePort \u7c7b\u66b4\u9732\u7684\u670d\u52a1\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5728\u524d\u9762\u52a0\u4e00\u4e2a LB \u6765\u8f6c\u53d1\u4e0b\u8bf7\u6c42\u3002\u8fd9\u91cc\u4e3a\u4e86\u7b80\u5355\uff0c\u6211\u76f4\u63a5\u4f7f\u7528 haproxy \u6765\u76d1\u542c\u8282\u70b9\u7684 80 \u548c 443 \u7aef\u53e3\uff0c\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u540e\u7aef\u7684 NodePort \u7aef\u53e3\u3002</p> <p>\u9996\u5148\u5b89\u88c5 haproxy:</p> <pre><code>$ yum install -y haproxy\n</code></pre> <p>\u7136\u540e\u914d\u7f6e haproxy\uff0c\u914d\u7f6e\u6587\u4ef6 </p> <pre><code>/etc/haproxy/haproxy.cfg\n</code></pre> <p>\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>listen stats\n  bind    *:9000\n  mode    http\n  stats   enable\n  stats   hide-version\n  stats   uri       /stats\n  stats   refresh   30s\n  stats   realm     Haproxy\\\\ Statistics\n  stats   auth      Admin:Password\n\nfrontend istio-https\n    bind *:443\n    mode tcp\n    option tcplog\n    tcp-request inspect-delay 5s\n    tcp-request content accept if { req.ssl_hello_type 1 }\n    default_backend istio-https-svc\n\nbackend istio-https-svc\n    mode tcp\n    option tcplog\n    option tcp-check\n    balance roundrobin\n    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100\n    server istio-http-svc-1 11:30951 check\n\nfrontend istio-http\n    bind *:80\n    mode tcp\n    option tcplog\n    default_backend istio-http-svc\n\nbackend istio-http-svc\n    mode tcp\n    option tcplog\n    option tcp-check\n    balance roundrobin\n    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100\n    server istio-http-svc-1 11:32193 check\n</code></pre> <p>\u5176\u4e2d\u7684 32193 \u4e0e 30951 \u7aef\u53e3\u662f istio-ingressgateway \u7684 NodePort \u7aef\u53e3\uff1a</p> <pre><code>$ kubectl get svc istio-ingressgateway -n istio-system\nNAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                      AGE\nistio-ingressgateway   NodePort   11128   &lt;none&gt;        15020:31093/TCP,80:32193/TCP,443:30951/TCP,31400:31871/TCP,15443:31367/TCP   68d\n</code></pre> <p>\u914d\u7f6e\u5b8c\u6210\u540e\u76f4\u63a5\u542f\u52a8 haproxy \u5373\u53ef\uff1a</p> <pre><code>$ sudo systemctl start haproxy\n$ sudo systemctl enable haproxy\n$ sudo systemctl status haproxy\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762 9000 \u7aef\u53e3\u76d1\u63a7\u6211\u4eec\u7684 haproxy \u7684\u8fd0\u884c\u72b6\u6001:</p> <p></p>"},{"location":"kubernetes_service_mesh/cert_manager/#istio","title":"\u4e0e Istio \u96c6\u6210","text":"<p>\u8fd9\u91cc\u6211\u4eec\u6765\u901a\u8fc7 cert-manager \u4e3a\u524d\u9762\u7684 httpbin \u5e94\u7528\u914d\u7f6e\u81ea\u52a8\u7684 HTTPS\uff0c\u9996\u5148\u5355\u72ec\u521b\u5efa\u4e00\u4e2a\u7528\u6237 cert-manager \u7684\u81ea\u5b9a\u4e49\u7684 Gateay\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: acme-gateway\n  labels:\n    app: ingressgateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n  - hosts:\n    - \"*.xip.io\"\n    port:\n      number: 80\n      name: http\n      protocol: HTTP\n    # tls:\n    #   httpsRedirect: true\n  - hosts:\n    - \"*.xip.io\"\n    port:\n      name: https\n      number: 443\n      protocol: HTTPS\n    tls:\n      mode: SIMPLE\n      credentialName: \"xip-cert\"\n---\nEOF\ngateway.networking.istio.io/acme-gateway created\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u914d\u7f6e Gateway \u7684\u65f6\u5019 tls \u7684 credentialName \u4ee3\u8868\u7684\u662f cert-manager \u81ea\u52a8\u751f\u6210\u7684\u8bc1\u4e66\u540d\u79f0\u3002</p> <p>\u63a5\u4e0b\u6765\u521b\u5efa VirtulService \u5bf9\u8c61\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 https \u65b9\u5f0f\u7684 ACME \u8bc1\u4e66\u6821\u9a8c\u65b9\u5f0f\uff0c\u9664\u4e86 http \u65b9\u5f0f\u4e4b\u5916\u8fd8\u6709 tls \u4e0e dns \u65b9\u5f0f\u7684\u6821\u9a8c\uff0cdns \u65b9\u5f0f\u7684\u8bc1\u4e66\u6821\u9a8c\u652f\u6301\u901a\u914d\u7b26\u7684\u57df\u540d\u3002\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e3a <code>/.well-known/</code> \u8fd9\u4e2a PATH \u8def\u5f84\u505a\u4e00\u4e2a\u6b63\u786e\u7684\u914d\u7f6e\uff0c\u65b9\u4fbf\u8fdb\u884c http \u6821\u9a8c\uff1a</p> <pre><code>$ cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: httpbin\nspec:\n  gateways:\n  - acme-gateway\n  hosts:\n  - httpbin.11xip.io\n  http:\n  - route:\n    - destination:\n        host: httpbin\n        port:\n          number: 8000\nEOF\nvirtualservice.networking.istio.io/httpbin created\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbf\u95ee </p> <pre><code>http://httpbin.11xip.io\n</code></pre> <p>\u6765\u9a8c\u8bc1\u662f\u5426\u5df2\u7ecf\u90e8\u7f72\u6210\u529f\uff1a</p> <p></p> <p>\u63a5\u4e0b\u6765\u521b\u4e24\u4e2a ClusterIssuer\uff0c\u4e00\u4e2a\u7528\u4e8e\u6d4b\u8bd5\uff0c\u4e00\u4e2a\u7528\u4e8e\u6b63\u5f0f\u4f7f\u7528\uff1a</p> <pre><code>$ cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: cert-manager.io/v1alpha2\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-staging\nspec:\n  acme:\n    server: https://acme-staging-vapi.letsencrypt.org/directory\n    email: icnych@xxx.com\n    privateKeySecretRef:\n      name: letsencrypt-staging\n    solvers:\n    - http01:\n        ingress:\n          class: istio  \nEOF\nclusterissuer.cert-manager.io/letsencrypt-staging created\n$ cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: cert-manager.io/v1beta1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-prod\nspec:\n  acme:\n    server: https://acme-vapi.letsencrypt.org/directory\n    email: icnych@xxx.com\n    privateKeySecretRef:\n      name: letsencrypt-prod\n    solvers:\n    - http01:\n        ingress:\n          class: istio  \nEOF\nclusterissuer.cert-manager.io/letsencrypt-prod created\n$ kubectl describe clusterissuer                \n......\nStatus:\n  Acme:\n    Last Registered Email:  icnych@xxx.com\n    Uri:                    https://acme-vapi.letsencrypt.org/acme/acct/94057742\n  Conditions:\n    Last Transition Time:  2020-08-16T07:37:40Z\n    Message:               The ACME account was registered with the ACME server\n    Reason:                ACMEAccountRegistered\n    Status:                True\n    Type:                  Ready\nEvents:                    &lt;none&gt;\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a Certificate \u5bf9\u8c61\u6765\u83b7\u53d6\u8bc1\u4e66\uff0c\u7531\u4e8e Istio \u9700\u8981\u5728\u5b83\u7684\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u6709\u8bc1\u4e66\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5728 istio-system \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u521b\u5efa:</p> <pre><code>$ cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: cert-manager.io/v1beta1\nkind: Certificate\nmetadata:\n  name: httpbin-cert\n  namespace: istio-system  # \u8fd9\u91cc\u5fc5\u987b\u662f istio-system \u7a7a\u95f4\nspec:\n  secretName: xip-cert  # \u8fd9\u4e2a\u5c31\u662f\u4e0a\u9762 gateway \u6240\u914d\u7f6e\u7684\u8bc1\u4e66\u540d\u79f0\n  issuerRef:\n    kind: ClusterIssuer\n    name: letsencrypt-staging\n  commonName: httpbin.11xip.io\n  dnsNames:\n  - httpbin.11xip.io\nEOF\ncertificate.cert-manager.io/httpbin-cert created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u8fd9\u65f6\u5019\u67e5\u770b istio-system \u7a7a\u95f4\u5e94\u8be5\u4f1a\u6709\u4e00\u4e2a <code>cm-acme-http-solver-</code> \u8fd9\u4e2a\u5f00\u5934\u7684 Pod\u3001Servie\u3001Ingress \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get pods -n istio-system\nNAME                                    READY   STATUS    RESTARTS   AGE\ncm-acme-http-solver-8tpbn               1/1     Running   0          16s\n$ kubectl get svc -n istio-system\nNAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                      AGE\ncm-acme-http-solver-w6sf7   NodePort    1120    &lt;none&gt;        8089:32135/TCP\n$ kubectl get ingress -n istio-system\nNAME                        HOSTS                          ADDRESS   PORTS   AGE\ncm-acme-http-solver-jkrs2   httpbin.11xip.io             80      45s\n</code></pre> <p>\u9694\u4e00\u5c0f\u4f1a\u513f\u53bb\u67e5\u770b\u4e0a\u9762\u90e8\u7f72\u7684 Certificate \u5bf9\u8c61\u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl describe certificate httpbin-cert -n istio-system\n......\nEvents:\n  Type    Reason     Age    From          Message\n  ----    ------     ----   ----          -------\n  Normal  Issuing    13m    cert-manager  Issuing certificate as Secret does not exist\n  Normal  Generated  13m    cert-manager  Stored new private key in temporary Secret resource \"http-cert-6cml8\"\n  Normal  Requested  13m    cert-manager  Created new CertificateRequest resource \"http-cert-9wcg2\"\n  Normal  Issuing    6m17s  cert-manager  The certificate has been successfully issued\n</code></pre> <p>\u770b\u5230\u6700\u540e\u7684\u4fe1\u606f </p> <pre><code>The certificate has been successfully issued\n</code></pre> <p>\u8bc1\u660e\u6211\u4eec\u7684\u8bc1\u4e66\u83b7\u53d6\u6210\u529f\u4e86\uff0c\u4f46\u662f\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u6211\u4eec\u901a\u8fc7 https \u53bb\u8bbf\u95ee\u7684\u8bdd\u8fd8\u662f\u4f1a\u63d0\u793a\u8bc1\u4e66\u9519\u8bef\u7684\uff0c\u56e0\u4e3a\u6211\u4eec\u83b7\u53d6\u7684\u662f staging \u73af\u5883\u7684\u8bc1\u4e66\uff1a</p> <p></p> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u91cd\u65b0\u66f4\u65b0 httpbin-cert \u8fd9\u4e2a Certificate \u5bf9\u8c61\u4e2d\u5f15\u7528\u7684 issuer\uff0c\u66f4\u6539\u4e3a\u6b63\u5f0f\u73af\u5883\u7684 issuer\uff0c\u6216\u8005\u4f7f\u7528\u6b63\u5f0f\u7684\u7b7e\u540d\u673a\u6784\u65b0\u5efa\u4e00\u4e2a\u8bc1\u4e66\u5bf9\u8c61\uff0c\u6b63\u5e38\u5c31\u53ef\u4ee5\u83b7\u5f97\u7ebf\u4e0a\u73af\u5883\u7684\u8bc1\u4e66\u4e86\u3002</p>"},{"location":"kubernetes_service_mesh/istio/","title":"Istio","text":""},{"location":"kubernetes_service_mesh/istio/#istio","title":"Istio","text":"<p>\u73b0\u5728\u6700\u706b\u7684\u540e\u7aef\u67b6\u6784\u65e0\u7591\u662f<code>\u5fae\u670d\u52a1</code>\u4e86\uff0c\u5fae\u670d\u52a1\u5c06\u4e4b\u524d\u7684\u5355\u4f53\u5e94\u7528\u62c6\u5206\u6210\u4e86\u8bb8\u591a\u72ec\u7acb\u7684\u670d\u52a1\uff0c\u597d\u5904\u81ea\u7136\u5f88\u591a\uff0c\u4f46\u662f\u968f\u7740\u5e94\u7528\u7684\u8d8a\u6765\u8d8a\u5927\uff0c\u5fae\u670d\u52a1\u66b4\u9732\u51fa\u6765\u7684\u95ee\u9898\u4e5f\u5c31\u968f\u4e4b\u800c\u6765\u4e86\uff0c\u5fae\u670d\u52a1\u8d8a\u6765\u8d8a\u591a\uff0c\u7ba1\u7406\u8d8a\u6765\u8d8a\u9ebb\u70e6\uff0c\u7279\u522b\u662f\u8981\u4f60\u90e8\u7f72\u4e00\u5957\u65b0\u73af\u5883\u7684\u65f6\u5019\uff0c\u4f60\u5c31\u80fd\u4f53\u4f1a\u5230\u8fd9\u79cd\u75db\u82e6\u4e86\uff0c\u968f\u4e4b\u800c\u6765\u7684<code>\u670d\u52a1\u53d1\u73b0\u3001\u8d1f\u8f7d\u5747\u8861\u3001Trace\u8ddf\u8e2a\u3001\u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u8ba4\u8bc1\u7b49\u7b49</code>\u95ee\u9898\u3002\u5982\u679c\u4ece\u5934\u5230\u5c3e\u5b8c\u6210\u8fc7\u4e00\u5957\u5fae\u670d\u52a1\u6846\u67b6\u7684\u8bdd\uff0c\u4f60\u5c31\u4f1a\u77e5\u9053\u8fd9\u91cc\u9762\u6d89\u53ca\u5230\u7684\u4e1c\u897f\u771f\u7684\u975e\u5e38\u591a\u3002\u5bf9\u4e8e Java \u9886\u57df\u6765\u8bf4\u8fd8\u6709 Spring Cloud \u8fd9\u79cd\u5b8c\u6574\u7684\u5fae\u670d\u52a1\u6846\u67b6\uff0c\u4f46\u662f\u4e5f\u4ec5\u4ec5\u5c40\u9650\u4e8e Java \u8bed\u8a00\u3002\u5f53\u7136\u968f\u7740\u5fae\u670d\u52a1\u7684\u4e0d\u65ad\u53d1\u5c55\uff0c\u5fae\u670d\u52a1\u7684\u751f\u6001\u4e5f\u4e0d\u65ad\u5b8c\u5584\uff0c\u6700\u8fd1\u5c31\u53d1\u73b0\u65b0\u4e00\u4ee3\u7684\u5fae\u670d\u52a1\u5f00\u53d1\u5c31\u6084\u7136\u5174\u8d77\u4e86\uff0c\u90a3\u5c31\u662f Service Mesh\uff08\u670d\u52a1\u7f51\u683c\uff09\u3002</p> <p>\u800c istio \u662f\u73b0\u5728\u6700\u70ed\u95e8\u7684 Service Mesh \u5de5\u5177\uff0cistio \u662f\u7531 Google\u3001IBM\u3001Lyft \u7b49\u5171\u540c\u5f00\u6e90\u7684 Service Mesh\uff08\u670d\u52a1\u7f51\u683c\uff09\u6846\u67b6\uff0c\u4e8e2017\u5e74\u521d\u5f00\u59cb\u8fdb\u5165\u5927\u4f17\u89c6\u91ce\u3002Kubernetes \u89e3\u51b3\u4e86\u4e91\u539f\u751f\u5e94\u7528\u7684\u90e8\u7f72\u95ee\u9898\uff0cistio \u89e3\u51b3\u7684\u662f\u5e94\u7528\u7684\u670d\u52a1\uff08\u6d41\u91cf\uff09\u6cbb\u7406\u95ee\u9898\u3002\u73b0\u5728\u6700\u65b0\u7684\u7248\u672c1.6\u7248\u672c\u5df2\u7ecf\u5c06\u4e4b\u524d\u7684\u67b6\u6784\u6539\u6210\u4e86\u5355\u4f53\u5e94\u7528\uff0c\u6027\u80fd\u4e5f\u5df2\u7ecf\u5927\u5e45\u5ea6\u63d0\u5347\uff0c\u6240\u4ee5\u6211\u4eec\u5b8c\u5168\u6709\u5fc5\u8981\u53bb\u5b66\u4e60\u4e86\u89e3 istio\uff0c\u56e0\u4e3a\u8fd9\u5c31\u662f\u5fae\u670d\u52a1\u9886\u57df\u7684\u4e0b\u4e00\u4e2a\u6807\u51c6\u3002</p>"},{"location":"kubernetes_service_mesh/istio/#_1","title":"\u5b89\u88c5","text":"<pre><code>$ export ISTIO_VERSION=1\n$ curl -L https://istio.io/downloadIstio | sh -\n</code></pre> <p>\u5982\u679c\u5b89\u88c5\u5931\u8d25\uff0c\u53ef\u4ee5\u7528\u624b\u52a8\u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\uff0c\u5728 GitHub Release \u9875\u9762\u83b7\u53d6\u5bf9\u5e94\u7cfb\u7edf\u7684\u4e0b\u8f7d\u5730\u5740\uff1a</p> <pre><code>$ wget https://github.com/istio/istio/releases/download/1/istio-1-linux-amdtar.gz\n$ tar -xzf istioctl-1-linux-amdtar.gz\n$ cp istio-1/bin/istioctl /usr/local/bin/\n# \u8fdb\u5165\u5230 istio \u89e3\u538b\u7684\u76ee\u5f55\n$ cd istio-1 &amp;&amp; ls -la\ntotal 32\ndrwxr-x---   6 root root   108 Jun  5 00:05 .\ndr-xr-x---. 19 root root  4096 Jun  8 18:32 ..\ndrwxr-x---   2 root root    21 Jun  5 00:05 bin\n-rw-r--r--   1 root root 11348 Jun  5 00:05 LICENSE\ndrwxr-xr-x   7 root root   104 Jun  5 00:05 manifests\n-rw-r-----   1 root root   786 Jun  5 00:05 manifest.yaml\n-rw-r--r--   1 root root  6121 Jun  5 00:05 README.md\ndrwxr-xr-x  20 root root  4096 Jun  5 00:05 samples\ndrwxr-x---   3 root root   128 Jun  5 00:05 tools\n</code></pre> <p>\u5b89\u88c5 istio \u7684\u5de5\u5177\u548c\u6587\u4ef6\u51c6\u5907\u597d\u8fc7\u540e\uff0c\u76f4\u63a5\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u5b89\u88c5\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ istioctl manifest apply --set profile=demo\n\u2714 Istio core installed                                            \n\u2714 Istiod installed                                                \n- Processing resources for Addons, Egress gateways, Ingress gat...\n\u2714 Ingress gateways installed                                      \n\u2714 Egress gateways installed                                       \n- Processing resources for Addons. Waiting for Deployment/istio...\n\u2718 Addons encountered an error: failed to wait for resource: resources not ready after 5m0s: timed out waiting for the condition\nDeployment/istio-system/kiali\nDeployment/istio-system/prometheus\n# \u5982\u679c\u51fa\u73b0\u4e86\u9519\u8bef\u53ef\u4ee5\u91cd\u65b0\u6267\u884c\u4e00\u6b21\n$ istioctl manifest apply --set profile=demo\n\u2714 Istio core installed                                                                               \n\u2714 Istiod installed                                                                                   \n\u2714 Egress gateways installed                                                                          \n\u2714 Ingress gateways installed                                                                         \n\u2714 Addons installed                                                                                   \n\u2714 Installation complete\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u67e5\u770b istio-system \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684 Pod \u8fd0\u884c\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods -n istio-system\nNAME                                    READY   STATUS    RESTARTS   AGE\ngrafana-74dc798895-mns2v                1/1     Running   0          9m51s\nistio-egressgateway-7c4f7c7b8c-wjq68    1/1     Running   0          9m54s\nistio-ingressgateway-56d5c6d74c-bbtgs   1/1     Running   0          9m54s\nistio-tracing-8584b4d7f9-vmcdx          1/1     Running   0          9m51s\nistiod-5f47bf5895-pnrsz                 1/1     Running   0          13m\nkiali-6f457f5964-8p8gr                  1/1     Running   0          9m51s\nprometheus-6dd77d88cf-nmsl7             2/2     Running   0          9m50s\n</code></pre> <p>\u5982\u679c\u90fd\u662f Running \u72b6\u6001\u8bc1\u660e istio \u5c31\u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\u3002</p>"},{"location":"kubernetes_service_mesh/istio/#_2","title":"\u793a\u4f8b\u5b89\u88c5","text":"<p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u6765\u5b89\u88c5\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u975e\u5e38\u7ecf\u5178\u7684 Bookinfo \u5e94\u7528\u793a\u4f8b\uff0c\u8fd9\u4e2a\u793a\u4f8b\u90e8\u7f72\u4e86\u4e00\u4e2a\u7528\u4e8e\u6f14\u793a\u591a\u79cd Istio \u7279\u6027\u7684\u5e94\u7528\uff0c\u8be5\u5e94\u7528\u7531\u56db\u4e2a\u5355\u72ec\u7684\u5fae\u670d\u52a1\u6784\u6210\u3002 \u8fd9\u4e2a\u5e94\u7528\u6a21\u4eff\u5728\u7ebf\u4e66\u5e97\u7684\u4e00\u4e2a\u5206\u7c7b\uff0c\u663e\u793a\u4e00\u672c\u4e66\u7684\u4fe1\u606f\u3002\u9875\u9762\u4e0a\u4f1a\u663e\u793a\u4e00\u672c\u4e66\u7684\u63cf\u8ff0\uff0c\u4e66\u7c4d\u7684\u7ec6\u8282\uff08ISBN\u3001\u9875\u6570\u7b49\uff09\uff0c\u4ee5\u53ca\u5173\u4e8e\u8fd9\u672c\u4e66\u7684\u4e00\u4e9b\u8bc4\u8bba\u3002</p> <p>Bookinfo \u5e94\u7528\u5206\u4e3a\u56db\u4e2a\u5355\u72ec\u7684\u5fae\u670d\u52a1\uff1a</p> <ul> <li>productpage\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4f1a\u8c03\u7528 details \u548c reviews \u4e24\u4e2a\u5fae\u670d\u52a1\uff0c\u7528\u6765\u751f\u6210\u9875\u9762\u3002</li> <li>details\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4e2d\u5305\u542b\u4e86\u4e66\u7c4d\u7684\u4fe1\u606f\u3002</li> <li>reviews\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4e2d\u5305\u542b\u4e86\u4e66\u7c4d\u76f8\u5173\u7684\u8bc4\u8bba\uff0c\u5b83\u8fd8\u4f1a\u8c03\u7528 ratings \u5fae\u670d\u52a1\u3002</li> <li>ratings\uff1a\u8fd9\u4e2a\u5fae\u670d\u52a1\u4e2d\u5305\u542b\u4e86\u7531\u4e66\u7c4d\u8bc4\u4ef7\u7ec4\u6210\u7684\u8bc4\u7ea7\u4fe1\u606f\u3002</li> </ul> <p>reviews \u5fae\u670d\u52a1\u6709 3 \u4e2a\u7248\u672c\uff1a</p> <ul> <li>v1 \u7248\u672c\u4e0d\u4f1a\u8c03\u7528 ratings \u670d\u52a1\u3002</li> <li>v2 \u7248\u672c\u4f1a\u8c03\u7528 ratings \u670d\u52a1\uff0c\u5e76\u4f7f\u7528 1 \u5230 5 \u4e2a\u9ed1\u8272\u661f\u5f62\u56fe\u6807\u6765\u663e\u793a\u8bc4\u5206\u4fe1\u606f\u3002</li> <li>v3 \u7248\u672c\u4f1a\u8c03\u7528 ratings \u670d\u52a1\uff0c\u5e76\u4f7f\u7528 1 \u5230 5 \u4e2a\u7ea2\u8272\u661f\u5f62\u56fe\u6807\u6765\u663e\u793a\u8bc4\u5206\u4fe1\u606f\u3002</li> </ul> <p></p> <p>\u4e0a\u56fe\u5c55\u793a\u4e86\u4f7f\u7528 istio \u540e\uff0c\u6574\u4e2a\u5e94\u7528\u5b9e\u9645\u7684\u7ed3\u6784\u3002\u6240\u6709\u7684\u5fae\u670d\u52a1\u90fd\u548c\u4e00\u4e2a <code>Envoy sidecar</code> \u5c01\u88c5\u5230\u4e00\u8d77\uff0csidecar \u62e6\u622a\u6240\u6709\u5230\u8fbe\u548c\u79bb\u5f00\u670d\u52a1\u7684\u8bf7\u6c42\u3002</p> <p>\u8fdb\u5165\u89e3\u538b\u7684 istio \u76ee\u5f55\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl apply -f &lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)\nservice/details created\nserviceaccount/bookinfo-details created\ndeployment.apps/details-v1 created\nservice/ratings created\nserviceaccount/bookinfo-ratings created\ndeployment.apps/ratings-v1 created\nservice/reviews created\nserviceaccount/bookinfo-reviews created\ndeployment.apps/reviews-v1 created\ndeployment.apps/reviews-v2 created\ndeployment.apps/reviews-v3 created\nservice/productpage created\nserviceaccount/bookinfo-productpage created\ndeployment.apps/productpage-v1 created\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u90e8\u7f72\u7684 <code>bookinfo.yaml</code> \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5c31\u662f\u666e\u901a\u7684 Kubernetes \u7684 Deployment \u548c Service \u7684 yaml \u6587\u4ef6\uff0c\u800c <code>istioctl kube-inject</code> \u4f1a\u5728\u8fd9\u4e2a\u6587\u4ef6\u7684\u57fa\u7840\u4e0a\u5411\u5176\u4e2d\u7684 Deployment \u8ffd\u52a0\u4e00\u4e2a\u955c\u50cf\u4e3a </p> <pre><code>docker.io/istio/proxyv2:1\n</code></pre> <p>\u7684 sidecar \u5bb9\u5668\u3002</p> <p>\u8fc7\u4e00\u4f1a\u513f\u5c31\u53ef\u4ee5\u770b\u5230\u5982\u4e0b service \u548c pod \u542f\u52a8:</p> <pre><code>$ kubectl get po\nNAME                              READY     STATUS    RESTARTS   AGE\ndetails-v1-6c77545767-dj2k5       2/2       Running   1          4h\nproductpage-v1-79bd99d8c5-v95wf   2/2       Running   1          4h\nratings-v1-6df6bcf5ff-8ktgb       2/2       Running   1          4h\nreviews-v1-84648f754c-wwkdg       2/2       Running   1          4h\nreviews-v2-878d96859-cw6p5        2/2       Running   1          4h\nreviews-v3-6c4489748c-pfwxk       2/2       Running   1          4h\n$ kubectl get svc\nNAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\ndetails       ClusterIP   1128    &lt;none&gt;        9080/TCP   5h\nkubernetes    ClusterIP   1        &lt;none&gt;        443/TCP    21h\nproductpage   ClusterIP   11117   &lt;none&gt;        9080/TCP   5h\nratings       ClusterIP   1115    &lt;none&gt;        9080/TCP   5h\nreviews       ClusterIP   1121    &lt;none&gt;        9080/TCP   5h\n</code></pre> <p>\u73b0\u5728\u5e94\u7528\u7684\u670d\u52a1\u90fd\u90e8\u7f72\u6210\u529f\u5e76\u542f\u52a8\u4e86\uff0c\u5982\u679c\u6211\u4eec\u9700\u8981\u5728\u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee\uff0c\u5c31\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a istio gateway\u3002gateway \u76f8\u5f53\u4e8e k8s \u7684 ingress controller \u548c ingress\u3002\u5b83\u4e3a HTTP/TCP \u6d41\u91cf\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\uff0c\u901a\u5e38\u5728\u670d\u52a1\u7f51\u683c\u8fb9\u7f18\u4f5c\u4e3a\u5e94\u7528\u7684 ingress \u6d41\u91cf\u7ba1\u7406\u3002</p> <p>\u521b\u5efa\u4e00\u4e2a gateway:</p> <pre><code>$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml\ngateway.networking.istio.io/bookinfo-gateway created\nvirtualservice.networking.istio.io/bookinfo created\n</code></pre> <p>\u9a8c\u8bc1 gateway \u662f\u5426\u542f\u52a8\u6210\u529f:</p> <pre><code>$ kubectl get gateway\nNAME               AGE\nbookinfo-gateway   4h\n</code></pre> <p>\u8981\u60f3\u53d6\u8bbf\u95ee\u8fd9\u4e2a\u5e94\u7528\uff0c\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u66f4\u6539\u4e0b istio \u63d0\u4f9b\u7684 istio-ingressgateway \u8fd9\u4e2a Service \u5bf9\u8c61\uff0c\u9ed8\u8ba4\u662f LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\uff1a</p> <pre><code>$ kubectl get svc -n istio-systemNAME                        TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                      AGE\nistio-ingressgateway        LoadBalancer   11128   &lt;pending&gt;     15020:30844/TCP,80:31585/TCP,443:32239/TCP,31400:30183/TCP,15443:31664/TCP   23m\n......\n</code></pre> <p>LoadBalancer \u7c7b\u578b\u7684\u670d\u52a1\uff0c\u5b9e\u9645\u4e0a\u662f\u7528\u6765\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684\uff0c\u5982\u679c\u6211\u4eec\u6ca1\u6709\u5bf9\u63a5\u4e91\u670d\u52a1\u5382\u5546\u7684\u8bdd\uff0c\u53ef\u4ee5\u5c06\u8fd9\u91cc\u7c7b\u578b\u6539\u6210 <code>NodePort</code>\uff0c\u4f46\u662f\u8fd9\u6837\u5f53\u8bbf\u95ee\u6211\u4eec\u7684\u670d\u52a1\u7684\u65f6\u5019\u5c31\u9700\u8981\u52a0\u4e0a nodePort \u7aef\u53e3\u4e86\uff1a</p> <pre><code>$ kubectl edit svc istio-ingressgateway -n istio-system\n......\ntype: NodePort  # \u4fee\u6539\u6210 NodePort \u7c7b\u578b\nstatus:\n  loadBalancer: {}\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>http://&lt;NodeIP&gt;:&lt;nodePort&gt;/productpage\n</code></pre> <p>\u8bbf\u95ee\u5e94\u7528\u4e86\uff1a</p> <p></p> <p>\u5237\u65b0\u9875\u9762\u53ef\u4ee5\u770b\u5230 Book Reviews \u53d1\u751f\u4e86\u6539\u53d8\uff0c\u56e0\u4e3a\u6bcf\u6b21\u8bf7\u6c42\u4f1a\u88ab\u8def\u7531\u5230\u5230\u4e86\u4e0d\u540c\u7684 Reviews \u670d\u52a1\u7248\u672c\u53bb\uff1a</p> <p></p> <p>\u81f3\u6b64\uff0c\u6574\u4e2a istio \u5c31\u5b89\u88c5\u5e76\u9a8c\u8bc1\u6210\u529f\u4e86\uff0c\u540e\u9762\u5c06\u8fdb\u4e00\u6b65\u5206\u6790 Bookinfo \u5e94\u7528\u6765\u5b66\u4e60 istio \u7684\u57fa\u672c\u4f7f\u7528\u65b9\u5f0f\u3002</p>"},{"location":"kubernetes_service_mesh/observability/","title":"\u53ef\u89c2\u6d4b\u6027","text":""},{"location":"kubernetes_service_mesh/observability/#_1","title":"\u53ef\u89c2\u6d4b\u6027","text":"<p>\u524d\u9762\u6211\u4eec\u5b66\u4e60\u4e86 Istio \u4e2d\u7684\u6d41\u91cf\u7ba1\u7406\u529f\u80fd\uff0c\u672c\u8282\u6211\u4eec\u6765\u5b66\u4e60\u5982\u4f55\u914d\u7f6e Istio \u6765\u81ea\u52a8\u6536\u96c6\u7f51\u683c\u4e2d\u7684\u670d\u52a1\u9065\u6d4b\uff0c\u901a\u8fc7\u76d1\u63a7\u6307\u6807\u3001\u65e5\u5fd7\u3001\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7b49\u65b9\u5f0f\u6765\u5b9e\u73b0\u5e94\u7528\u7684\u53ef\u89c2\u6d4b\u6027\u3002</p> <p></p>"},{"location":"kubernetes_service_mesh/observability/#kiali","title":"\u4f7f\u7528 Kiali \u89c2\u6d4b\u5fae\u670d\u52a1","text":"<p>\u7531\u4e8e\u5fae\u670d\u52a1\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u9519\u7efc\u590d\u6742\uff0c\u6392\u67e5\u95ee\u9898\u5c31\u66f4\u52a0\u56f0\u96be\u4e86\uff0c\u4e3a\u4e86\u4f7f\u670d\u52a1\u4e4b\u95f4\u7684\u5173\u7cfb\u66f4\u52a0\u6e05\u6670\u660e\u4e86\uff0c\u4e86\u89e3\u5e94\u7528\u7684\u884c\u4e3a\u548c\u72b6\u6001\uff0c\u6211\u4eec\u6709\u5fc5\u8981\u4f7f\u7528\u4e00\u4e9b\u53ef\u89c6\u5316\u7684\u65b9\u6848\u6765\u89c2\u6d4b\u6211\u4eec\u7684\u5fae\u670d\u52a1\u5e94\u7528\uff0c\u5176\u4e2d Kiali \u5c31\u662f\u8fd9\u6837\u7684\u4e00\u4e2a\u5de5\u5177\u3002</p> <p>Kiali \u662f Istio \u7684\u4e00\u4e2a\u53ef\u89c2\u6d4b\u5de5\u5177\uff0c\u63d0\u4f9b\u670d\u52a1\u62d3\u6251\u5c55\u793a\u670d\u52a1\u7f51\u683c\u7684\u7ed3\u6784\uff0c\u63d0\u4f9b\u7f51\u683c\u7684\u5065\u5eb7\u72b6\u6001\u89c6\u56fe\uff0c\u914d\u7f6e\u4fe1\u606f\u9a8c\u8bc1\u529f\u80fd\uff0c\u6b64\u5916\u8fd8\u5177\u6709\u670d\u52a1\u7f51\u683c\u914d\u7f6e\u7684\u529f\u80fd\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cKiali \u670d\u52a1\u5df2\u7ecf\u5b89\u88c5\u4e86\uff0c\u53ef\u4ee5\u901a\u8fc7 istioctl \u547d\u4ee4\u6765\u8bbf\u95ee\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u6765\u6253\u5f00 kiali \u7684 web UI\uff1a</p> <pre><code>$ istioctl dashboard kiali --address=0\nhttp://localhost:44759/kiali\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>44759</code> \u7aef\u53e3\u8bbf\u95ee\u5230 kiali \u670d\u52a1\u4e86\u3002\u6b64\u5916\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 Kiali \u7684\u670d\u52a1\u4e3a NodePort \u7c7b\u578b\u6765\u8bbf\u95ee\uff1a</p> <pre><code>$ kubectl get pods -n istio-system -l app=kiali\nNAME                     READY   STATUS    RESTARTS   AGE\nkiali-6f457f5964-8p8gr   1/1     Running   0          32d\n$ kubectl get svc -n istio-system -l app=kiali\nNAME    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)     AGE\nkiali   ClusterIP   178   &lt;none&gt;        20001/TCP   32d\n$ kubectl edit svc kiali -n istio-system\n......\nspec:\n  clusterIP: 178\n  ports:\n  - name: http-kiali\n    port: 20001\n    protocol: TCP\n    targetPort: 20001\n  selector:\n    app: kiali\n  sessionAffinity: None\n  type: NodePort\n......\n$ kubectl get svc -n istio-system -l app=kiali\nNAME    TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)           AGE\nkiali   NodePort   178   &lt;none&gt;        20001:31098/TCP   32d\n</code></pre> <p></p> <p>\u9ed8\u8ba4\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\u5b58\u50a8\u5728\u540d\u4e3a kiali \u7684 Secret \u5bf9\u8c61\u4e4b\u4e2d\uff0c\u9700\u8981\u5c06\u5176\u4e2d\u7684 username \u4e0e passphrase \u505a base64 \u89e3\u7801\u83b7\u5f97\u7528\u6237\u540d\u548c\u5bc6\u7801\uff1a</p> <pre><code>$ kubectl get secret -n istio-system kiali -o yaml\napiVersion: v1\ndata:\n  passphrase: YWRtaW4=\n  username: YWRtaW4=\nkind: Secret\n......\n</code></pre> <p></p> <p>\u9ed8\u8ba4\u4f1a\u5b89\u88c5\u547d\u540d\u7a7a\u95f4\u8fdb\u884c\u5206\u7c7b\uff0c\u6211\u4eec\u7684 BookInfo \u5e94\u7528\u90e8\u7f72\u5728 default \u547d\u540d\u7a7a\u95f4\u4e4b\u4e0b\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u70b9\u51fb default \u547d\u540d\u7a7a\u95f4\u4e4b\u4e0b\u7684\u5e94\u7528\uff1a</p> <p></p> <p>\u8fd8\u5207\u6362\u5230 Graph \u9875\u9762\u4e0b\u9762\u67e5\u770b\u5fae\u670d\u52a1\u5e94\u7528\u7684\u6574\u4e2a\u8c03\u7528\u94fe\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u56fe\u975e\u5e38\u6e05\u6670\u7684\u628a BookInfo \u5e94\u7528\u7684\u8c03\u7528\u94fe\u7ed9\u5c55\u793a\u51fa\u6765\u4e86\uff0c\u8fd9\u5bf9\u4e8e\u6211\u4eec\u4e86\u89e3\u6211\u4eec\u7684\u5e94\u7528\u662f\u975e\u5e38\u6709\u5e2e\u52a9\u7684\u3002\u8fd8\u53ef\u4ee5\u67e5\u770b\u670d\u52a1\u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <p></p> <p>\u5728\u8be5\u9875\u9762\u4e4b\u4e2d\u8fd8\u53ef\u4ee5\u67e5\u770b\u5e94\u7528\u7684\u6307\u6807\u3001\u94fe\u8def\u8ffd\u8e2a\u7b49\u4fe1\u606f\u3002\u6b64\u5916\u5728 <code>Istio Config</code> \u8def\u5f84\u4e0b\u9762\u8fd8\u53ef\u4ee5\u67e5\u770b\u6574\u4e2a\u7f51\u683c\u4e2d\u7684\u914d\u7f6e\u6821\u9a8c\u60c5\u51b5\uff1a</p> <p></p> <p>\u7ea2\u8272\u6807\u8bb0\u7684\u8868\u793a\u9a8c\u8bc1\u672a\u901a\u8fc7\u7684\u914d\u7f6e\uff0c\u53ef\u4ee5\u70b9\u51fb\u8fdb\u53bb\u7f16\u8f91\u9519\u8bef\u7684\u914d\u7f6e\uff0c\u6b64\u5916\u8fd8\u53ef\u4ee5\u5728\u9875\u9762\u4e0a\u65b0\u5efa Istio \u7684\u914d\u7f6e\uff1a</p> <p></p>"},{"location":"kubernetes_service_mesh/observability/#_2","title":"\u76d1\u63a7\u6307\u6807","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b Istio \u5c31\u90e8\u7f72\u4e86\u7528\u4e8e\u6536\u96c6\u76d1\u63a7\u6307\u6807\u7684 Prometheus \u5e94\u7528:</p> <pre><code>$ kubectl get pods -n istio-system -l app=prometheus\nNAME                          READY   STATUS    RESTARTS   AGE\nprometheus-6dd77d88cf-nmsl7   2/2     Running   0          32d\n$ kubectl get svc -n istio-system -l app=prometheus\nNAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nprometheus   ClusterIP   1202   &lt;none&gt;        9090/TCP   32d\n</code></pre> <p>\u4e3a\u4e86\u6d4b\u8bd5\u65b9\u4fbf\u6211\u4eec\u53ef\u4ee5\u5c06 Prometheus \u7684 Service \u66f4\u6539\u4e3a NodePort \u7c7b\u578b\uff1a</p> <pre><code>$ kubectl edit svc prometheus -n istio-system\n......\nspec:\n  type: NodePort\n......\n$ kubectl get svc -n istio-system -l app=prometheus\nNAME         TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE\nprometheus   NodePort   1202   &lt;none&gt;        9090:31128/TCP   32d\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>http://&lt;NodeIP&gt;:31128\n</code></pre> <p>\u8bbf\u95ee Prometheus \u9875\u9762\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5c31\u5df2\u7ecf\u6709\u4e86\u5f88\u591a\u6293\u53d6\u4efb\u52a1\u4e86\uff1a</p> <p></p> <p>\u9ed8\u8ba4\u5c31\u5df2\u7ecf\u6536\u96c6\u4e86\u5f88\u591a\u7f51\u683c\u7684\u6307\u6807\uff0c\u5305\u62ec\u670d\u52a1\u7ea7\u522b\u548c\u4ee3\u7406\u7ea7\u522b\uff08sidecar\uff09\u7684\u6570\u636e\uff0c\u81ea Istio 1.5 \u8d77\uff0cIstio \u6807\u51c6\u6307\u6807\u7531 Envoy \u4ee3\u7406\u76f4\u63a5\u83b7\u53d6\uff0c\u4e4b\u524d\u662f\u901a\u8fc7 Mixer \u7ec4\u4ef6\u751f\u6210\u7684\u3002</p> <p></p> <p>\u4ece\u4e0a\u56fe\u53ef\u4ee5\u770b\u51fa\u73b0\u5728\u7684\u67b6\u6784\u4e0d\u9700\u8981 Mixer \u8fd9\u6837\u7684\u7ec4\u4ef6\u6765\u5b8c\u6210\u4e86\uff0c\u5728\u6027\u80fd\u4e0a\u5f97\u5230\u4e86\u5927\u5e45\u5ea6\u7684\u63d0\u5347\uff0c\u4f46\u662f\u6570\u636e\u90fd\u9700\u8981\u901a\u8fc7 Envoy \u4ee3\u7406\u6765\u81ea\u5df1\u4e0a\u4f20\uff0c\u6269\u5c55\u8d77\u6765\u4e0d\u662f\u5f88\u65b9\u4fbf\uff0c\u73b0\u5728\u662f\u901a\u8fc7 <code>STATS</code> \u548c <code>METADATA EXCHANGE</code> \u8fd9\u4e24\u4e2a\u63d2\u4ef6\u6765\u5b8c\u6210\u7684\uff0c\u4f46\u662f\u6269\u5c55\u6027\u6ca1\u6709\u4ee5\u524d\u7684 Mixer \u7ec4\u4ef6\u5f3a\u5927\u4e86\uff0c\u540e\u7eed\u6216\u8bb8\u4f1a\u4f7f\u7528 WebAssembly \u8fd9\u6837\u7684\u6280\u672f\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>\u5bf9\u4e8e HTTP\uff0cHTTP/2 \u548c GRPC \u6d41\u91cf\uff0cIstio \u751f\u6210\u4ee5\u4e0b\u6307\u6807\uff1a</p> <ul> <li>\u8bf7\u6c42\u6570\uff08istio_requests_total\uff09\uff1a\u8fd9\u662f\u4e00\u4e2a\u7528\u4e8e\u7d2f\u52a0\u6bcf\u4e2a\u7531 Istio \u4ee3\u7406\u6240\u5904\u7406\u8bf7\u6c42\u7684 COUNTER \u6307\u6807\u3002</li> <li>\u8bf7\u6c42\u65f6\u957f\uff08istio_request_duration_seconds\uff09\uff1a\u8fd9\u662f\u4e00\u4e2a\u7528\u4e8e\u6d4b\u91cf\u8bf7\u6c42\u7684\u6301\u7eed\u65f6\u95f4\u7684\u6307\u6807\u3002</li> <li>\u8bf7\u6c42\u5927\u5c0f\uff08istio_request_bytes\uff09\uff1a\u8fd9\u662f\u4e00\u4e2a\u7528\u4e8e\u6d4b\u91cf HTTP \u8bf7\u6c42 body \u5927\u5c0f\u7684\u6307\u6807\u3002</li> <li>\u54cd\u5e94\u5927\u5c0f\uff08istio_response_bytes\uff09\uff1a\u8fd9\u662f\u4e00\u4e2a\u7528\u4e8e\u6d4b\u91cf HTTP \u54cd\u5e94 body \u5927\u5c0f\u7684\u6307\u6807\u3002</li> </ul> <p>\u5bf9\u4e8e TCP \u6d41\u91cf\uff0cIstio \u751f\u6210\u4ee5\u4e0b\u6307\u6807\uff1a * TCP \u53d1\u9001\u5b57\u8282\u6570\uff08istio_tcp_sent_bytes_total\uff09\uff1a\u8fd9\u662f\u4e00\u4e2a\u7528\u4e8e\u6d4b\u91cf\u5728 TCP \u8fde\u63a5\u4e0b\u54cd\u5e94\u671f\u95f4\u53d1\u9001\u7684\u603b\u5b57\u8282\u6570\u7684 COUNTER \u6307\u6807\u3002 * TCP \u63a5\u6536\u5b57\u8282\u6570\uff08istio_tcp_received_bytes_total\uff09\uff1a\u8fd9\u662f\u4e00\u4e2a\u7528\u4e8e\u6d4b\u91cf\u5728 TCP \u8fde\u63a5\u4e0b\u8bf7\u6c42\u671f\u95f4\u63a5\u6536\u7684\u603b\u5b57\u8282\u6570\u7684 COUNTER \u6307\u6807\u3002 * TCP \u6253\u5f00\u8fde\u63a5\u6570\uff08istio_tcp_connections_opened_total\uff09\uff1a\u8fd9\u662f\u4e00\u4e2a\u7528\u4e8e\u7d2f\u52a0\u6bcf\u4e2a\u6253\u5f00\u8fde\u63a5\u7684 COUNTER \u6307\u6807\u3002 * TCP \u5173\u95ed\u8fde\u63a5\u6570 (istio_tcp_connections_closed_total) : \u8fd9\u662f\u4e00\u4e2a\u7528\u4e8e\u7d2f\u52a0\u6bcf\u4e2a\u5173\u95ed\u8fde\u63a5\u7684 COUNTER \u6307\u6807\u3002</p>"},{"location":"kubernetes_service_mesh/observability/#grafana","title":"\u4f7f\u7528 Grafana \u53ef\u89c6\u5316\u7cfb\u7edf\u76d1\u63a7","text":"<p>\u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u5230\u4e86 Istio \u7f51\u683c\u4e2d\u9ed8\u8ba4\u901a\u8fc7 Prometheus \u6536\u96c6\u4e86\u5f88\u591a\u670d\u52a1\u548c\u4ee3\u7406\u76f8\u5173\u7684\u6307\u6807\u6570\u636e\uff0c\u6b64\u5916 Istio \u8fd8\u9ed8\u8ba4\u5f00\u542f\u4e86 Grafana \u5de5\u5177\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Grafana \u6765\u53ef\u89c6\u5316\u67e5\u770b\u7f51\u683c\u7684\u76d1\u63a7\u72b6\u6001\u3002</p> <pre><code>$ kubectl get pods -n istio-system -l app=grafana\nNAME                       READY   STATUS    RESTARTS   AGE\ngrafana-74dc798895-mns2v   1/1     Running   0          32d\n$ kubectl get svc -n istio-system -l app=grafana\nNAME      TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE\ngrafana   ClusterIP   254   &lt;none&gt;        3000/TCP   32d\n</code></pre> <p>\u540c\u6837\u6211\u4eec\u8fd9\u91cc\u5c06 grafana \u7684 Service \u5bf9\u8c61\u4fee\u6539\u4e3a NodePort \u7c7b\u578b\u7684\u670d\u52a1\uff1a</p> <pre><code>$ kubectl edit svc grafana -n istio-system\n......\nspec:\n  type: NodePort\n......\n$ kubectl get svc -n istio-system -l app=grafana\nNAME      TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE\ngrafana   NodePort   254   &lt;none&gt;        3000:30692/TCP   32d\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>http://&lt;NodeIP&gt;:30692\n</code></pre> <p>\u8bbf\u95ee Grafana \u5e94\u7528\u4e86\uff1a</p> <p></p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b Grafana \u4e2d\u5c31\u5df2\u7ecf\u5bfc\u5165\u4e86 Istio \u7684\u51e0\u4e2a Dashboard\uff1a * Mesh Dashboard\uff1a\u4e3b\u8981\u662f\u67e5\u770b\u5e94\u7528\u7684\u6570\u636e\uff0c\u5305\u62ec\u7f51\u683c\u6570\u636e\u603b\u89c8\u3001\u670d\u52a1\u89c6\u56fe\u3001\u5de5\u4f5c\u8d1f\u8f7d\u89c6\u56fe\u7b49 * Performance Dashboard\uff1a\u4e3b\u8981\u662f\u7528\u4e8e\u67e5\u770b Istio \u672c\u8eab\u7684\u76d1\u63a7\u6570\u636e\u3002</p> <p></p>"},{"location":"kubernetes_service_mesh/observability/#_3","title":"\u8bbf\u95ee\u65e5\u5fd7","text":"<p>\u65e5\u5fd7\u4e5f\u662f\u5e94\u7528\u53ef\u89c2\u6d4b\u6027\u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u65b9\u5f0f\uff0c\u4e5f\u662f\u6211\u4eec\u4f20\u7edf\u8c03\u8bd5\u5e94\u7528\u975e\u5e38\u91cd\u8981\u7684\u624b\u6bb5\uff0c\u5728 Istio \u4e2d\u4f7f\u7528 Sidecar \u5bb9\u5668\u5bf9\u8bf7\u6c42\u8fdb\u884c\u4e86\u62e6\u622a\uff0c\u65e0\u7591\u4e5f\u589e\u5927\u4e86\u8c03\u8bd5\u96be\u5ea6\uff0c\u4f46\u662f\u540c\u65f6 Istio \u4e5f\u53ef\u4ee5\u76d1\u6d4b\u5230\u7f51\u683c\u5185\u7684\u670d\u52a1\u901a\u4fe1\u7684\u6d41\u8f6c\u60c5\u51b5\uff0c\u5e76\u751f\u6210\u8be6\u7ec6\u7684\u9065\u6d4b\u65e5\u5fd7\u6570\u636e\uff0c\u4efb\u4f55\u8bf7\u6c42\u4e0e\u4e8b\u4ef6\u7684\u5143\u4fe1\u606f\u90fd\u53ef\u4ee5\u83b7\u53d6\u5230\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u975e\u5e38\u6709\u5fc5\u8981\u6765\u67e5\u770b\u4e0b Istio \u4e2d\u7684\u4ee3\u7406\u65e5\u5fd7\u6570\u636e\u3002Istio \u6700\u7b80\u5355\u7684\u65e5\u5fd7\u7c7b\u578b\u662f <code>Envoy \u7684\u8bbf\u95ee\u65e5\u5fd7</code>\uff0cEnvoy \u4ee3\u7406\u6253\u5370\u8bbf\u95ee\u65e5\u5fd7\u4fe1\u606f\u5230\u6807\u51c6\u8f93\u51fa\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>kubectl logs</code> \u547d\u4ee4\u6253\u5370\u51fa\u6765\u67e5\u770b\u4e86\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b Istio \u5df2\u7ecf\u5f00\u542f\u4e86 Envoy \u8bbf\u95ee\u65e5\u5fd7\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 Istio \u7684 ConfigMap \u914d\u7f6e\u6765\u4fee\u6539\u65e5\u5fd7\u7684\u683c\u5f0f\uff1a</p> <pre><code>$ kubectl edit cm istio -n istio-system \napiVersion: v1\ndata:\n  mesh: |-\n    accessLogEncoding: JSON\n    accessLogFile: /dev/stdout\n    accessLogFormat: \"\"\n    outboundTrafficPolicy:  \n      mode: REGISTRY_ONLY\n    defaultConfig:\n......\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u65e5\u5fd7\u5c31\u662f\u8f93\u51fa\u5230 stdout \u4e0a\u7684 TEXT \u6587\u672c\u683c\u5f0f\uff0c\u4e3a\u4e86\u65b9\u4fbf\u663e\u793a\uff0c\u8fd9\u91cc\u6211\u4eec\u5c06\u5176\u8bbe\u7f6e\u4e3a JSON \u683c\u5f0f\uff0c\u5982\u679c\u8981\u60f3\u4fee\u6539\u8bbf\u95ee\u65e5\u5fd7\u7684\u683c\u5f0f\u53ef\u4ee5\u8bbe\u7f6e <code>accessLogFormat</code> \u5c5e\u6027\uff0c\u5177\u4f53\u7684\u8bbf\u95ee\u65e5\u5fd7\u683c\u5f0f\u53ef\u4ee5\u67e5\u770b Envoy \u5b98\u65b9\u6587\u6863\u4e86\u89e3\u914d\u7f6e\u89c4\u5219\u3002</p> <p></p> <p>\u73b0\u5728\u6211\u4eec\u53bb\u8bbf\u95ee BookInfo \u670d\u52a1\uff0c\u540c\u65f6\u6765\u67e5\u770b productpage \u7684 sidecar \u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl get pods -l app=productpage\nNAME                              READY   STATUS    RESTARTS   AGE\nproductpage-v1-5f96867467-nsclh   2/2     Running   0          8d\n$ kubectl logs -f productpage-v1-5f96867467-nsclh -c istio-proxy\n{\"user_agent\":\"Mozilla/0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/536 (KHTML, like Gecko) Chrome/41116 Safari/536\",\"response_code\":\"200\",\"response_flags\":\"-\",\"start_time\":\"2020-07-19T06:48:074Z\",\"method\":\"GET\",\"request_id\":\"6df02877-0e8d-99f4-a9ee-0f9479d648dd\",\"upstream_host\":\"2180:9080\",\"x_forwarded_for\":\"-\",\"requested_server_name\":\"-\",\"bytes_received\":\"0\",\"istio_policy_status\":\"-\",\"bytes_sent\":\"178\",\"upstream_cluster\":\"outbound|9080||details.default.svc.cluster.local\",\"downstream_remote_address\":\"2227:47244\",\"authority\":\"details:9080\",\"path\":\"/details/0\",\"protocol\":\"HTTP/1\",\"upstream_service_time\":\"17\",\"upstream_local_address\":\"2227:42248\",\"duration\":\"18\",\"upstream_transport_failure_reason\":\"-\",\"route_name\":\"default\",\"downstream_local_address\":\"11166:9080\"}\n{\"user_agent\":\"Mozilla/0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/536 (KHTML, like Gecko) Chrome/41116 Safari/536\",\"response_code\":\"200\",\"response_flags\":\"-\",\"start_time\":\"2020-07-19T06:48:104Z\",\"method\":\"GET\",\"request_id\":\"6df02877-0e8d-99f4-a9ee-0f9479d648dd\",\"upstream_host\":\"2182:9080\",\"x_forwarded_for\":\"-\",\"requested_server_name\":\"-\",\"bytes_received\":\"0\",\"istio_policy_status\":\"-\",\"bytes_sent\":\"295\",\"upstream_cluster\":\"outbound|9080||reviews.default.svc.cluster.local\",\"downstream_remote_address\":\"2227:36718\",\"authority\":\"reviews:9080\",\"path\":\"/reviews/0\",\"protocol\":\"HTTP/1\",\"upstream_service_time\":\"20\",\"upstream_local_address\":\"2227:42884\",\"duration\":\"21\",\"upstream_transport_failure_reason\":\"-\",\"route_name\":\"default\",\"downstream_local_address\":\"144:9080\"}\n{\"bytes_sent\":\"4183\",\"upstream_cluster\":\"inbound|9080|http|productpage.default.svc.cluster.local\",\"downstream_remote_address\":\"20:0\",\"authority\":\"k8s.qikqiak.com:32193\",\"path\":\"/productpage\",\"protocol\":\"HTTP/1\",\"upstream_service_time\":\"70\",\"upstream_local_address\":\"11:36436\",\"duration\":\"71\",\"upstream_transport_failure_reason\":\"-\",\"route_name\":\"default\",\"downstream_local_address\":\"2227:9080\",\"user_agent\":\"Mozilla/0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/536 (KHTML, like Gecko) Chrome/41116 Safari/536\",\"response_code\":\"200\",\"response_flags\":\"-\",\"start_time\":\"2020-07-19T06:48:061Z\",\"method\":\"GET\",\"request_id\":\"6df02877-0e8d-99f4-a9ee-0f9479d648dd\",\"upstream_host\":\"11:9080\",\"x_forwarded_for\":\"20\",\"requested_server_name\":\"outbound_.9080_._.productpage.default.svc.cluster.local\",\"bytes_received\":\"0\",\"istio_policy_status\":\"-\"}\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u67e5\u8be2\u7684\u5bb9\u5668\u540d <code>istio-proxy</code> \u5176\u5b9e\u5c31\u662f Envoy sidecar \u4ee3\u7406\uff0cEnvoy \u5c06\u8bf7\u6c42\u548c\u54cd\u5e94\u65e5\u5fd7\u90fd\u8fdb\u884c\u4e86\u6253\u5370\u5e76\u8f93\u51fa\u81f3 stdout \uff0c\u6240\u4ee5\u53ef\u4ee5\u901a\u8fc7 <code>kubectl logs</code> \u67e5\u8be2\u3002</p> <p>\u6b63\u5e38\u5c31\u4f1a\u6536\u52303\u6761 JSON \u683c\u5f0f\u7684\u65e5\u5fd7\uff0cproductpage \u670d\u52a1\u4f1a\u8c03\u7528 details \u4e0e reviews \u670d\u52a1\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e00\u6761\u8bbf\u95ee <code>/reviews/0</code> \u4e0e <code>/details/0</code> \u7684 <code>outbound</code> \u8bf7\u6c42\uff0c\u548c\u6700\u7ec8\u7684 <code>/productpage</code> \u7684 <code>inbound</code> \u8bf7\u6c42\u8bb0\u5f55\u3002</p> <p>\u4e3a\u4e86\u65b9\u4fbf\u67e5\u770b\uff0c\u8fd9\u91cc\u6211\u4eec\u5c06\u7b2c\u4e00\u6761\u65e5\u5fd7\u8fdb\u884c\u683c\u5f0f\u5316\uff0c\u5982\u4e0b\u6240\u793a\uff1a </p> <p>\u8fd9\u91cc\u9762\u7684\u65e5\u5fd7\u4fe1\u606f\u5176\u5b9e\u662f\u4e00\u4e2a\u6807\u51c6\u7684 Envoy \u6d41\u91cf\u6a21\u578b\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u8981\u6df1\u5165\u7814\u7a76 Istio\uff0c\u5bf9\u5e94 Envoy \u7684\u4e86\u89e3\u662f\u5fc5\u4e0d\u53ef\u5c11\u7684\uff0c\u5176\u4e2d\u6700\u91cd\u8981\u7684\u51e0\u4e2a\u5b57\u6bb5\u5c31\u662f Envoy \u6d41\u91cf\u4e94\u5143\u7ec4\u4e2d\u7684\u51e0\u4e2a\u4fe1\u606f\u3002</p> <p>\u5728 Envoy \u4e2d\u63a5\u53d7\u8bf7\u6c42\u6d41\u91cf\u53eb\u505a <code>Downstream\uff08\u4e0b\u6e38\uff09</code>\uff0cEnvoy \u53d1\u51fa\u8bf7\u6c42\u6d41\u91cf\u53eb\u505a <code>Upstream\uff08\u4e0a\u6e38\uff09</code>\uff0c\u5728\u5904\u7406 <code>Downstream</code> \u548c <code>Upstream</code> \u8fc7\u7a0b\u4e2d\uff0c\u5206\u522b\u4f1a\u6d89\u53ca2\u4e2a\u6d41\u91cf\u7aef\u70b9\uff0c\u5373\u8bf7\u6c42\u7684\u53d1\u8d77\u7aef\u548c\u63a5\u6536\u7aef\uff1a</p> <p></p> <p>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0cEnvoy \u4f1a\u6839\u636e\u7528\u6237\u89c4\u5219\uff0c\u8ba1\u7b97\u51fa\u7b26\u5408\u6761\u4ef6\u7684\u8f6c\u53d1\u76ee\u7684\u4e3b\u673a\u96c6\u5408\uff0c\u8fd9\u4e2a\u96c6\u5408\u53eb\u505a <code>UPSTREAM_CLUSTER</code>, \u5e76\u6839\u636e\u8d1f\u8f7d\u5747\u8861\u89c4\u5219\uff0c\u4ece\u8fd9\u4e2a\u96c6\u5408\u4e2d\u9009\u62e9\u4e00\u4e2a host \u4f5c\u4e3a\u6d41\u91cf\u8f6c\u53d1\u7684\u63a5\u6536\u7aef\u70b9\uff0c\u8fd9\u4e2a host \u5c31\u662f <code>UPSTREAM_HOST</code>\u3002\u8fd9\u5c31\u662f Envoy \u8bf7\u6c42\u5904\u7406\u7684<code>\u6d41\u91cf\u4e94\u5143\u7ec4</code>\u4fe1\u606f\uff0c\u8fd9\u662f Envoy \u65e5\u5fd7\u91cc\u6700\u91cd\u8981\u7684\u90e8\u5206\uff0c\u901a\u8fc7\u8fd9\u4e2a\u4e94\u5143\u7ec4\u6211\u4eec\u53ef\u4ee5\u51c6\u786e\u7684\u89c2\u6d4b\u6d41\u91cf<code>\u300c\u4ece\u54ea\u91cc\u6765\u300d\u548c\u300c\u5230\u54ea\u91cc\u53bb\u300d</code>\uff1a</p> <ul> <li>downstream_remote_address</li> <li>downstream_local_address</li> <li>upstream_local_address</li> <li>upstream_host</li> <li>upstream_cluster</li> </ul> <p>\u9664\u4e86\u4e94\u5143\u7ec4\u4fe1\u606f\u4e4b\u5916\uff0c\u8fd8\u6709 <code>request_id</code> \u5c5e\u6027\uff0c\u8be5\u5c5e\u6027\u4e3b\u8981\u7528\u4e8e\u94fe\u8def\u8ffd\u8e2a\uff0c\u53ef\u4ee5\u5c06\u4e00\u6761\u8bf7\u6c42\u5728\u4e0d\u540c\u7684\u670d\u52a1\u4e2d\u7684\u8c03\u7528\u4e32\u8054\u8d77\u6765\u3002</p> <p>\u8fd8\u6709\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u5c5e\u6027 <code>response_flags</code>\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5\u5c5e\u6027\u6765\u67e5\u770b\u5f53\u524d\u8bf7\u6c42\u7684\u72b6\u6001\uff0c\u7528\u4e8e\u8c03\u8bd5\u8bf7\u6c42\u7684\u65f6\u5019\u975e\u5e38\u6709\u7528\uff1a </p> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5f53 Pod \u88ab\u9500\u6bc1\u540e\uff0c\u65e7\u7684\u65e5\u5fd7\u5c06\u4e0d\u590d\u5b58\u5728\uff0c\u4e5f\u65e0\u6cd5\u901a\u8fc7 <code>kubectl logs</code> \u5c31\u884c\u67e5\u770b\u4e86\u3002\u6240\u4ee5\u5982\u679c\u8981\u67e5\u770b\u5386\u53f2\u7684\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>EFK</code> \u65b9\u6848\u5c06\u65e5\u5fd7\u8fdb\u884c\u6536\u96c6\uff0c\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u4ed4\u7ec6\u8bb2\u89e3\u8fc7\u4e86\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u8d58\u8ff0\u4e86\u3002</p>"},{"location":"kubernetes_service_mesh/observability/#_4","title":"\u5206\u5e03\u5f0f\u8ffd\u8e2a","text":"<p>\u76f8\u6bd4\u4f20\u7edf\u7684\u5355\u4f53\u5e94\u7528\uff0c\u5fae\u670d\u52a1\u7684\u4e00\u4e2a\u4e3b\u8981\u53d8\u5316\u662f\u5c06\u5e94\u7528\u4e2d\u7684\u4e0d\u540c\u6a21\u5757\u62c6\u5206\u4e3a\u4e86\u72ec\u7acb\u7684\u670d\u52a1\uff0c\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e0b\uff0c\u539f\u6765\u8fdb\u7a0b\u5185\u7684\u65b9\u6cd5\u8c03\u7528\u6210\u4e3a\u4e86\u8de8\u8fdb\u7a0b\u7684\u8fdc\u7a0b\u65b9\u6cd5\u8c03\u7528\u3002\u76f8\u5bf9\u4e8e\u5355\u4e00\u8fdb\u7a0b\u5185\u7684\u65b9\u6cd5\u8c03\u7528\u800c\u8a00\uff0c\u8de8\u8fdb\u7a0b\u8c03\u7528\u7684\u8c03\u8bd5\u548c\u6545\u969c\u5206\u6790\u662f\u975e\u5e38\u56f0\u96be\u7684\uff0c\u96be\u4ee5\u4f7f\u7528\u4f20\u7edf\u7684\u4ee3\u7801\u8c03\u8bd5\u7a0b\u5e8f\u6216\u8005\u65e5\u5fd7\u6253\u5370\u6765\u5bf9\u5206\u5e03\u5f0f\u7684\u8c03\u7528\u8fc7\u7a0b\u8fdb\u884c\u67e5\u770b\u548c\u5206\u6790\u3002\u4e00\u4e2a\u6765\u81ea\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u5728\u5176\u4e1a\u52a1\u5904\u7406\u8fc7\u7a0b\u4e2d\u5f88\u6709\u53ef\u80fd\u9700\u8981\u7ecf\u8fc7\u591a\u4e2a\u5fae\u670d\u52a1\uff0c\u6211\u4eec\u5982\u679c\u60f3\u8981\u5bf9\u8be5\u8bf7\u6c42\u7684\u7aef\u5230\u7aef\u8c03\u7528\u8fc7\u7a0b\u8fdb\u884c\u5b8c\u6574\u7684\u5206\u6790\uff0c\u5219\u5fc5\u987b\u5c06\u8be5\u8bf7\u6c42\u7ecf\u8fc7\u7684\u6240\u6709\u8fdb\u7a0b\u7684\u76f8\u5173\u4fe1\u606f\u90fd\u6536\u96c6\u8d77\u6765\u5e76\u5173\u8054\u5728\u4e00\u8d77\uff0c\u8fd9\u5c31\u662f<code>\u5206\u5e03\u5f0f\u8ffd\u8e2a</code>\uff0c\u4e5f\u662f\u5e94\u7528\u53ef\u89c2\u6d4b\u6027\u4e2d\u975e\u5e38\u91cd\u8981\u7684\u624b\u6bb5\u3002</p> <p>\u5728 Istio \u4e2d\u901a\u8fc7\u5206\u5e03\u5f0f\u8ffd\u8e2a\u6211\u4eec\u53ef\u4ee5\u8ba9\u7528\u6237\u5bf9\u8de8\u591a\u4e2a\u5206\u5e03\u5f0f\u670d\u52a1\u7f51\u683c\u7684\u4e00\u4e2a\u8bf7\u6c42\u8fdb\u884c\u8ffd\u8e2a\u5206\u6790\uff0c\u8fdb\u800c\u53ef\u4ee5\u901a\u8fc7\u53ef\u89c6\u5316\u7684\u65b9\u5f0f\u66f4\u52a0\u6df1\u5165\u5730\u4e86\u89e3\u8bf7\u6c42\u7684<code>\u5ef6\u8fdf\u3001\u5e8f\u5217\u5316\u548c\u5e76\u884c\u5ea6</code>\u7b49\u3002</p> <p>Istio \u5229\u7528 Envoy \u7684\u5206\u5e03\u5f0f\u8ffd\u8e2a\u529f\u80fd\u63d0\u4f9b\u4e86\u5f00\u7bb1\u5373\u7528\u7684\u8ffd\u8e2a\u96c6\u6210\uff0c\u9ed8\u8ba4 Istio \u63d0\u4f9b\u4e86\u96c6\u6210\u5404\u79cd\u8ffd\u8e2a\u540e\u7aef\u670d\u52a1\u7684\u9009\u9879\uff0c\u5e76\u4e14\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u4ee3\u7406\u6765\u81ea\u52a8\u53d1\u9001\u8ffd\u8e2a <code>span</code> \u5230\u8ffd\u8e2a\u540e\u7aef\u670d\u52a1\u3002</p> <p>\u5728\u4f7f\u7528 Istio \u7684\u5206\u5e03\u5f0f\u8ffd\u8e2a\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u4e86\u89e3\u4e24\u4e2a\u91cd\u8981\u7684\u6982\u5ff5\uff1a<code>Span</code> \u4e0e <code>Trace</code>\u3002</p> <p></p> <ul> <li>Span\uff1a\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7684\u57fa\u672c\u7ec4\u6210\u5355\u5143\uff0c\u8868\u793a\u4e00\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u7684\u5355\u72ec\u7684\u5de5\u4f5c\u5355\u5143\uff0c\u6bcf\u4e00\u4e2a Span \u53ef\u4ee5\u5305\u542b\u5176\u5b83 Span \u7684\u5f15\u7528\u3002\u591a\u4e2a Span \u5728\u4e00\u8d77\u6784\u6210\u4e86 Trace\u3002</li> <li>Trace\uff1a\u5fae\u670d\u52a1\u4e2d\u8bb0\u5f55\u7684\u5b8c\u6574\u7684\u8bf7\u6c42\u6267\u884c\u8fc7\u7a0b\uff0c\u4e00\u4e2a\u5b8c\u6574\u7684 Trace \u7531\u4e00\u4e2a\u6216\u591a\u4e2a Span \u7ec4\u6210\u3002</li> </ul> <p>\u968f\u7740\u5206\u5e03\u5f0f\u8ffd\u8e2a\u6280\u672f\u7684\u53d1\u5c55\uff0c\u793e\u533a\u63a8\u51fa\u4e86 OpenTracing \u8fd9\u4e2a\u89c4\u8303\uff0c\u63d0\u4f9b\u4e86\u6807\u51c6\u7684 API \u89c4\u8303\u3001\u6846\u67b6\u4ee5\u53ca\u4e00\u4e9b\u516c\u5171\u7684\u5e93\u3002\u76ee\u524d\u6bd4\u8f83\u77e5\u540d\u7684\u8ffd\u8e2a\u5de5\u5177\u57fa\u672c\u4e0a\u90fd\u901a\u8fc7 OpenTracing \u8fdb\u884c\u5b9e\u73b0\uff0c\u6bd4\u5982 Jaeger\u3001Zipkin \u7b49\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u4e3b\u8981\u6765\u7ed9\u5927\u5bb6\u4ecb\u7ecd\u6bd4\u8f83\u6d41\u884c\u7684 Jaeger\u3002 <code>Jaeger</code> \u662f\u7531 Uber \u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf\uff0c\u91c7\u7528 Go \u8bed\u8a00\u7f16\u5199\uff0c\u4e3b\u8981\u501f\u9274\u4e86 <code>Google Dapper</code> \u8bba\u6587\u548c <code>Zipkin</code> \u7684\u8bbe\u8ba1\uff0c\u517c\u5bb9 OpenTracing \u4ee5\u53ca Zipkin \u8ffd\u8e2a\u683c\u5f0f\uff0c\u76ee\u524d\u5df2\u6210\u4e3a CNCF \u57fa\u91d1\u4f1a\u7684\u5f00\u6e90\u9879\u76ee\u3002</p> <p></p> <p>\u6211\u4eec\u8fd9\u91cc\u5b89\u88c5 Istio \u7684\u65f6\u5019\u4f7f\u7528\u7684\u662f demo \u8fd9\u4e2a profile\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5df2\u7ecf\u5b89\u88c5\u4e86 Jaeger\uff0c\u5982\u679c\u6ca1\u6709\u5b89\u88c5\u53ef\u4ee5\u5728\u4f7f\u7528 istioctl \u547d\u4ee4\u521d\u59cb\u5316\u7684\u65f6\u5019\u6dfb\u52a0 </p> <pre><code>--set values.tracing.enabled=true\n</code></pre> <p>\u53c2\u6570\u8fdb\u884c\u5f00\u542f\uff1a</p> <pre><code>$ istioctl manifest apply --set values.tracing.enabled=true\n</code></pre> <p>\u5982\u679c\u96c6\u7fa4\u4e2d\u5df2\u7ecf\u6709\u4e00\u4e2a\u53ef\u4ee5\u4f7f\u7528\u7684 Jaeger \u670d\u52a1\u7684\u8bdd\uff0c\u8fd9\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c\u5173\u8054\uff1a</p> <pre><code>$ istioctl manifest apply --set values.global.tracer.zipkin.address=&lt;jaeger-collector-service&gt;.&lt;jaeger-collector-namespace&gt;:9411\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u9ed8\u8ba4\u5df2\u7ecf\u5b89\u88c5\u7684 Jaeger \u670d\u52a1\uff1a</p> <pre><code>kubectl get pods -l app=jaeger -n istio-system\nNAME                             READY   STATUS    RESTARTS   AGE\nistio-tracing-8584b4d7f9-vmcdx   1/1     Running   0          40d\n$ kubectl get svc -l app=jaeger -n istio-system\nNAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                         AGE\njaeger-agent                ClusterIP   None             &lt;none&gt;        5775/UDP,6831/UDP,6832/UDP      40d\njaeger-collector            ClusterIP   74       &lt;none&gt;        14267/TCP,14268/TCP,14250/TCP   40d\njaeger-collector-headless   ClusterIP   None             &lt;none&gt;        14250/TCP                       40d\njaeger-query                ClusterIP   1127    &lt;none&gt;        16686/TCP                       40d\ntracing                     ClusterIP   11125   &lt;none&gt;        80/TCP                          40d\nzipkin                      ClusterIP   1119    &lt;none&gt;        9411/TCP                        40d\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>tracing</code> \u8fd9\u4e2a Service \u6765\u8bbf\u95ee Jaeger \u7684 Dashboard \u9875\u9762\uff0c\u540c\u6837\u4e3a\u4e86\u65b9\u4fbf\u6d4b\u8bd5\u5c06\u5176\u4fee\u6539\u4e3a NodePort \u7c7b\u578b\uff1a</p> <pre><code>$ kubectl edit svc tracing -n istio-system\n......\nspec:\n  type: NodePort\n......\nservice/tracing edited\n$ kubectl get svc tracing -n istio-system\nNAME      TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\ntracing   NodePort   11125   &lt;none&gt;        80:31755/TCP   40d\n</code></pre> <p>\u4fee\u6539\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u901a\u8fc7 </p> <pre><code>http://&lt;NodeIP&gt;:31755\n</code></pre> <p>\u8bbf\u95ee Jaeger \u7684 Dashboard \u9875\u9762\u4e86\uff1a</p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u91cd\u65b0\u8bbf\u95ee BookInfo \u5e94\u7528\u4ea7\u751f\u6d41\u91cf\u8bf7\u6c42\u751f\u6210\u8ffd\u8e2a\u6570\u636e\u3002\u8bf7\u6c42\u5b8c\u6210\u540e\u56de\u5230 Jaeger \u9875\u9762\uff0c\u5728\u5de6\u4fa7 Servcie \u533a\u57df\u9009\u62e9\u4e00\u4e2a\u6211\u4eec\u8981\u8ffd\u8e2a\u7684\u670d\u52a1\uff0c\u6bd4\u5982 <code>details.default</code>\uff0c\u70b9\u51fb <code>\"Find Traces\"</code> \u6309\u94ae\u67e5\u770b\u8ffd\u8e2a\u7ed3\u679c\u3002</p> <p></p> <p>\u70b9\u51fb\u5217\u8868\u9879\u76ee\u8fd8\u53ef\u4ee5\u67e5\u770b\u8ffd\u8e2a\u8be6\u7ec6\u4fe1\u606f\uff0c\u8bb0\u5f55\u4e86\u4e00\u6b21\u8bf7\u6c42\u6d89\u53ca\u5230\u7684 Services\u3001\u6df1\u5ea6\u3001Span \u603b\u6570\u3001\u8bf7\u6c42\u603b\u65f6\u957f\u7b49\u4fe1\u606f\uff0c\u4e5f\u53ef\u4ee5\u5bf9\u4e0b\u65b9\u7684\u5355\u9879\u670d\u52a1\u5c55\u5f00\uff0c\u89c2\u5bdf\u6bcf\u4e00\u4e2a\u670d\u52a1\u7684\u8bf7\u6c42\u8017\u65f6\u548c\u8be6\u60c5\u3002</p> <p></p> <p>\u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u5207\u6362 Trace \u7684\u663e\u793a\u65b9\u5f0f\u4e3a Graph\uff0c\u5728\u53f3\u4e0a\u89d2\u70b9\u51fb <code>Trace Timeline</code> \u5207\u6362\u4e3a <code>Trace Graph</code> \u6a21\u5f0f\uff0c\u8be5\u6a21\u5f0f\u4e0b\u53ef\u4ee5\u66f4\u52a0\u6e05\u6670\u67e5\u770b\u5230\u6bcf\u4e00\u4e2a\u8c03\u7528\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <p></p> <p>\u6b64\u5916\uff0cJaeger \u8fd8\u53ef\u4ee5\u5c55\u793a\u670d\u52a1\u4f9d\u8d56\uff0c\u70b9\u51fb\u9876\u90e8\u7684 <code>Dependencies</code> \u83dc\u5355\u67e5\u770b\uff0c\u8be5\u9875\u9762\u53ef\u4ee5\u67e5\u770b\u670d\u52a1\u7684\u5b8c\u6574\u4f9d\u8d56\u8c03\u7528\u5173\u7cfb\uff1a</p> <p></p> <p>\u6b64\u5916\u8fd8\u53ef\u4ee5\u5bf9\u6bd4\u4e24\u4e2a Trace\uff0c\u5728\u9876\u90e8 <code>Compare</code> \u83dc\u5355\u4e2d\uff0c\u8f93\u5165\u4e24\u4e2a\u4e0d\u540c\u7684 <code>Trace ID</code> \u5373\u53ef\u8fdb\u884c\u5bf9\u6bd4\uff0c\u8fd9\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u53d1\u73b0\u4e0d\u540c Trace \u4e4b\u95f4\u7684\u5dee\u5f02\uff1a</p> <p></p> <p>\u8fd9\u5c31\u662f Jaeger \u7684\u57fa\u672c\u4f7f\u7528\uff0c\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f Istio \u9ed8\u8ba4\u63d0\u4f9b\u7684 Jaeger \u91c7\u7528\u5185\u5b58\u7684\u5b58\u50a8\u65b9\u5f0f\uff0cPod \u88ab\u9500\u6bc1\u540e\u6570\u636e\u4e5f\u5c31\u4e22\u5931\u4e86\u3002\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u9700\u8981\u5355\u72ec\u914d\u7f6e\u6301\u4e45\u5316\u5b58\u50a8\u6570\u636e\u5e93\uff0c\u5177\u4f53\u53ef\u67e5\u770b Jaeger \u5b98\u65b9\u6587\u6863\u3002</p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86 Istio \u4e2d\u53ef\u89c2\u6d4b\u6027\u7684\u5b9e\u9a8c\uff1a\u6307\u6807\u3001\u65e5\u5fd7\u3001\u8ffd\u8e2a\uff0c\u5bf9\u4e8e\u5fae\u670d\u52a1\u5e94\u7528\u53ef\u89c2\u6d4b\u6027\u5bf9\u4e8e\u6211\u4eec\u76d1\u63a7\u548c\u8c03\u8bd5\u5e94\u7528\u662f\u975e\u5e38\u91cd\u8981\u7684\u624b\u6bb5\uff0c\u6211\u4eec\u975e\u5e38\u6709\u5fc5\u8981\u638c\u63e1\u8fd9\u4e9b\u65b9\u5f0f\u3002</p>"},{"location":"kubernetes_service_mesh/security/","title":"\u5b89\u5168\u7ba1\u63a7","text":""},{"location":"kubernetes_service_mesh/security/#_1","title":"\u5b89\u5168","text":"<p>\u9664\u4e86\u6d41\u91cf\u7ba1\u7406\u3001\u53ef\u89c2\u6d4b\u6027\u4e4b\u5916\uff0cIstio \u670d\u52a1\u7f51\u683c\u4e2d\u8fd8\u53ef\u4ee5\u5bf9\u7f51\u683c\u8fdb\u884c\u5b89\u5168\u7ba1\u63a7\u3002Istio \u7684\u5b89\u5168\u529f\u80fd\u4e3b\u8981\u5206\u4e3a\u4e09\u4e2a\u90e8\u5206\u7684\u5b9e\u73b0\uff1a</p> <ul> <li>\u53cc\u5411 TLS \u652f\u6301</li> <li>\u57fa\u4e8e\u9ed1\u767d\u540d\u5355\u7684\u8bbf\u95ee\u63a7\u5236</li> <li>\u57fa\u4e8e\u89d2\u8272\u7684\u8bbf\u95ee\u63a7\u5236</li> <li>JWT \u8ba4\u8bc1\u652f\u6301</li> </ul>"},{"location":"kubernetes_service_mesh/security/#_2","title":"\u5b89\u5168\u7f51\u5173","text":"<p>Istio \u7684\u8eab\u4efd\u548c\u8bc1\u4e66\u7ba1\u7406\u662f\u901a\u8fc7 <code>SDS\uff08\u5b89\u5168\u53d1\u73b0\u670d\u52a1\uff09</code>\u6765\u5b9e\u73b0\u7684\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u5176\u6267\u884c\u7684\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li>\u9996\u5148 Istio \u63d0\u4f9b\u4e00\u4e2a gRPC \u670d\u52a1\u6765\u63a5\u53d7\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\uff08CSRs\uff09</li> <li>Envoy \u901a\u8fc7 SDS API \u53d1\u9001\u8bc1\u4e66\u548c\u5bc6\u94a5\u8bf7\u6c42</li> <li>\u5728\u6536\u5230 SDS \u8bf7\u6c42\u540e\uff0c<code>istio-agent</code> \u521b\u5efa\u79c1\u94a5\u548c CSR\uff0c\u7136\u540e\u5c06 CSR \u53ca\u5176\u51ed\u636e\u53d1\u9001\u5230 Istiod \u4e2d\u7684 CA \u670d\u52a1\u8fdb\u884c\u7b7e\u540d</li> <li>CA \u9a8c\u8bc1 CSR \u4e2d\u643a\u5e26\u7684\u51ed\u636e\u5e76\u7b7e\u7f72 CSR \u4ee5\u751f\u6210\u8bc1\u4e66</li> <li><code>istio-agent</code> \u901a\u8fc7 Envoy SDS API \u5c06\u79c1\u94a5\u4e0e\u4ece Istio CA \u6536\u5230\u7684\u8bc1\u4e66\u53d1\u9001\u7ed9 Envoy</li> <li>\u4e0a\u8ff0 CSR \u8fc7\u7a0b\u4f1a\u5468\u671f\u6027\u5730\u91cd\u590d\uff0c\u4ee5\u5904\u7406\u8bc1\u4e66\u548c\u5bc6\u94a5\u8f6e\u6362</li> </ul> <p>\u6ce8\u610f</p> <p>\u8fd9\u7684 <code>istio-agent</code> \u5e76\u4e0d\u662f\u6307\u7684\u5355\u72ec\u7684\u4e00\u4e2a\u5bb9\u5668\uff0c\u800c\u662f\u6307 <code>sidecar</code> \u5bb9\u5668\u4e2d\u7684 <code>pilot-agent</code> \u8fdb\u7a0b\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 SDS \u6765\u4e3a Istio Ingress Gateway \u914d\u7f6e TLS \u5b89\u5168\u8ba4\u8bc1\uff0c\u914d\u7f6e TLS Ingress Gateway\uff0c\u8ba9\u5b83\u4ece Ingress Gateway \u4ee3\u7406\u901a\u8fc7 SDS \u83b7\u53d6\u51ed\u636e\u3002Ingress Gateway \u4ee3\u7406\u548c Ingress Gateway \u5728\u540c\u4e00\u4e2a Pod \u4e2d\u8fd0\u884c\uff0c\u76d1\u542c Ingress Gateway \u6240\u5728\u547d\u540d\u7a7a\u95f4\u4e2d\u65b0\u5efa\u7684 Secret\u3002\u5728 Ingress Gateway \u4e2d\u542f\u7528 SDS \u5177\u6709\u5982\u4e0b\u597d\u5904\uff1a</p> <ul> <li>Ingress Gateway \u65e0\u9700\u91cd\u542f\uff0c\u5c31\u53ef\u4ee5\u52a8\u6001\u7684\u65b0\u589e\u3001\u5220\u9664\u6216\u8005\u66f4\u65b0\u5bc6\u94a5/\u8bc1\u4e66\u5bf9\u4ee5\u53ca\u6839\u8bc1\u4e66\u3002</li> <li>\u65e0\u9700\u6302\u8f7d Secret \u5377\uff0c\u521b\u5efa\u4e86 kubernetes Secret \u4e4b\u540e\uff0c\u8fd9\u4e2a Secret \u5c31\u4f1a\u88ab Gateway \u4ee3\u7406\u6355\u83b7\uff0c\u5e76\u4ee5\u5bc6\u94a5/\u8bc1\u4e66\u5bf9\u548c\u6839\u8bc1\u4e66\u7684\u5f62\u5f0f\u53d1\u9001\u7ed9 Ingress Gateway\u3002</li> <li>Gateway \u4ee3\u7406\u80fd\u591f\u76d1\u89c6\u591a\u4e2a\u5bc6\u94a5/\u8bc1\u4e66\u5bf9\uff0c\u53ea\u9700\u8981\u4e3a\u6bcf\u4e2a\u4e3b\u673a\u540d\u521b\u5efa Secret \u5e76\u66f4\u65b0 Gateway \u5b9a\u4e49\u5c31\u53ef\u4ee5\u4e86\u3002</li> </ul> <p>\u4e0b\u9762\u6211\u4eec\u901a\u8fc7\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\u6765\u8bf4\u660e\u5982\u4f55\u542f\u7528 Istio Ingress Gateway \u7684 TLS \u8ba4\u8bc1\u3002</p>"},{"location":"kubernetes_service_mesh/security/#_3","title":"\u5355\u4e00\u4e3b\u673a","text":"<p>\u9996\u5148\u4f7f\u7528 OpenSSL \u751f\u6210\u8bc1\u4e66\u548c\u5bc6\u94a5\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u521b\u5efa\u6839\u8bc1\u4e66\u548c\u79c1\u94a5\u6765\u4e3a\u4f60\u7684\u670d\u52a1\u7b7e\u540d\u8bc1\u4e66\uff1a</p> <pre><code>$ openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -subj '/O=example Inc./CN=example.com' -keyout example.com.key -out example.com.crt\n</code></pre> <p>\u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684\u6839\u8bc1\u4e66\u548c\u79c1\u94a5\u4e3a <code>httpbin.example.com</code> \u57df\u540d\u8fdb\u884c\u7b7e\u540d\uff0c\u9996\u5148\u751f\u6210\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\uff1a</p> <pre><code>$ openssl req -out httpbin.example.com.csr -newkey rsa:2048 -nodes -keyout httpbin.example.com.key -subj \"/CN=httpbin.example.com/O=some organization\"\n</code></pre> <p>\u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\u6765\u8bf7\u6c42\u7b7e\u53d1\u8bc1\u4e66\uff1a</p> <pre><code>$ openssl x509 -req -days 365 -CA example.com.crt -CAkey example.com.key -set_serial 0 -in httpbin.example.com.csr -out httpbin.example.com.crt\nSignature ok\nsubject=CN = httpbin.example.com, O = some organization\nGetting CA Private Key\n</code></pre> <p>\u7b7e\u540d\u6210\u529f\u540e\u4f1a\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u51e0\u4e2a\u8bc1\u4e66\u548c\u5bc6\u94a5\uff1a</p> <pre><code>$ ls -la\ntotal 56\ndrwxr-xr-x  9 ych  staff   288 Jul 25 15:51 .\ndrwxr-xr-x  7 ych  staff   224 Jul 25 15:18 ..\n-rw-r--r--  1 ych  staff  1180 Jul 25 15:50 example.com.crt\n-rw-------  1 ych  staff  1708 Jul 25 15:50 example.com.key\n-rw-r--r--  1 ych  staff  1050 Jul 25 15:51 httpbin.example.com.crt\n-rw-r--r--  1 ych  staff   944 Jul 25 15:50 httpbin.example.com.csr\n-rw-------  1 ych  staff  1704 Jul 25 15:50 httpbin.example.com.key\n</code></pre> <p>\u7531\u4e8e Ingress Gateway \u662f\u901a\u8fc7\u76d1\u542c\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684 Secret \u5bf9\u8c61\u6765\u8fdb\u884c\u5b89\u5168\u670d\u52a1\u53d1\u73b0\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5c06\u4e0a\u9762\u751f\u6210\u7684\u8bc1\u4e66\u521b\u5efa\u5728 istio-system \u547d\u540d\u7a7a\u95f4\u4e4b\u4e0b\uff1a</p> <pre><code>$ kubectl create secret tls httpbin-tls --cert=httpbin.example.com.crt --key=httpbin.example.com.key -n istio-system\nsecret/httpbin-tls created\n</code></pre> <p>\u7136\u540e\u521b\u5efa httpbin \u793a\u4f8b\u5e94\u7528\uff0c\u5e94\u7528\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># httpbin.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: httpbin\n  labels:\n    app: httpbin\nspec:\n  ports:\n  - name: http\n    port: 8000\n  selector:\n    app: httpbin\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: httpbin\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: httpbin\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: httpbin\n        version: v1\n    spec:\n      containers:\n      - image: docker.io/citizenstig/httpbin\n        imagePullPolicy: IfNotPresent\n        name: httpbin\n        ports:\n        - containerPort: 8000\n</code></pre> <p>\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u547d\u4ee4\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f &lt;(istioctl kube-inject -f httpbin.yaml)\nservice/httpbin created\ndeployment.apps/httpbin created\n$ kubectl get pods -l app=httpbin\nNAME                       READY   STATUS            RESTARTS   AGE\nhttpbin-56db79f4f5-b2vp9   2/2     Running           0          8m35s\n$ kubectl get svc -l app=httpbin\nNAME      TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE\nhttpbin   ClusterIP   114   &lt;none&gt;        8000/TCP   8m47s\n</code></pre> <p>\u7136\u540e\u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a Gateway\uff0c\u5176 <code>servers</code> \u5b57\u6bb5\u7684\u7aef\u53e3\u4e3a 443\uff0c\u8bbe\u7f6e <code>credentialName</code> \u7684\u503c\u4e3a\u4e0a\u9762\u521b\u5efa\u7684 Secret \u5bf9\u8c61 <code>httpbin-tls</code>\uff0c\u5e76\u5c06 TLS \u6a21\u5f0f\u8bbe\u7f6e\u4e3a <code>SIMPLE</code>\u3002</p> <pre><code>$ cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: networking.istio.io/v1beta1\nkind: Gateway\nmetadata:\n  name: mygateway\nspec:\n  selector:\n    istio: ingressgateway # \u4f7f\u7528\u9ed8\u8ba4\u7684 ingress gatewaygateway\n  servers:\n  - port:\n      number: 443\n      name: https\n      protocol: HTTPS\n    tls:\n      mode: SIMPLE\n      credentialName: \"httpbin-tls\" # \u5fc5\u987b\u4f7f\u7528\u4e0a\u9762\u521b\u5efa\u7684\u540c\u540d\u7684Secret\u5bf9\u8c61\n    hosts:\n    - \"httpbin.example.com\"\nEOF\n</code></pre> <p>\u8fd9\u6837\u5c31\u6210\u529f\u521b\u5efa\u4e86\u4e00\u4e2a TLS \u7684\u5b89\u5168\u7f51\u5173\uff0c\u63a5\u4e0b\u6765\u4e3a httpbin \u5e94\u7528\u914d\u7f6e\u8def\u7531\u89c4\u5219\uff0c\u521b\u5efa\u4e00\u4e2a VirtualService \u5bf9\u8c61\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: httpbin\nspec:\n  hosts:\n  - \"httpbin.example.com\"\n  gateways:\n  - mygateway\n  http:\n  - match:\n    - uri:\n        prefix: /status\n    - uri:\n        prefix: /delay\n    route:\n    - destination:\n        port:\n          number: 8000\n        host: httpbin\nEOF\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 HTTPS \u534f\u8bae\u5b89\u5168\u7684\u8bbf\u95ee httpbin \u5e94\u7528\u4e86\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u7684 Istio Ingressgateway \u662f\u901a\u8fc7 NodePort \u66b4\u9732\u7684\u670d\u52a1\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u6d4b\u8bd5\u7684\u65f6\u5019\u5e94\u8be5\u4f7f\u7528 443 \u7aef\u53e3\u5bf9\u5e94\u7684 nodePort \u7aef\u53e3\uff1a</p> <pre><code>$ kubectl get svc -n istio-system -l istio=ingressgateway\nNAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                      AGE\nistio-ingressgateway   NodePort   11128   &lt;none&gt;        15020:31093/TCP,80:32193/TCP,443:30951/TCP,31400:31871/TCP,15443:31367/TCP   46d\n</code></pre> <p>\u4ece\u4e0a\u9762\u53ef\u4ee5\u770b\u51fa\u6211\u4eec\u7684\u7f51\u5173\u5b89\u5168\u8bbf\u95ee\u7aef\u53e3\u662f 30951\uff0c\u7f51\u5173\u5730\u5740\u662f\u4efb\u610f\u7684\u4e00\u4e2a\u8282\u70b9 IP\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 master \u8282\u70b9\u7684\u5730\u5740 <code>k8s.qikqiak.com</code>\uff0c\u5f53\u7136\u8fd8\u8981\u8bb0\u5f97\u5c06\u57df\u540d <code>httpbin.example.com</code> \u4e5f\u8981\u89e3\u6790\u5230\u7f51\u5173\u7684\u8282\u70b9\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ curl -v -HHost:httpbin.example.com --cacert example.com.crt https://httpbin.example.com:30951/status/418\n*   Trying 11..\n* TCP_NODELAY set\n* Connected to httpbin.example.com (1112) port 30951 (#0)\n* ALPN, offering h2\n* ALPN, offering http/1\n* successfully set certificate verify locations:\n*   CAfile: example.com.crt\n  CApath: none\n* TLSv2 (OUT), TLS handshake, Client hello (1):\n* TLSv2 (IN), TLS handshake, Server hello (2):\n* TLSv2 (IN), TLS handshake, Certificate (11):\n* TLSv2 (IN), TLS handshake, Server key exchange (12):\n* TLSv2 (IN), TLS handshake, Server finished (14):\n* TLSv2 (OUT), TLS handshake, Client key exchange (16):\n* TLSv2 (OUT), TLS change cipher, Change cipher spec (1):\n* TLSv2 (OUT), TLS handshake, Finished (20):\n* TLSv2 (IN), TLS change cipher, Change cipher spec (1):\n* TLSv2 (IN), TLS handshake, Finished (20):\n* SSL connection using TLSv2 / ECDHE-RSA-CHACHA20-POLY1305\n* ALPN, server accepted to use h2\n* Server certificate:\n*  subject: CN=httpbin.example.com; O=some organization\n*  start date: Jul 25 07:51:14 2020 GMT\n*  expire date: Jul 25 07:51:14 2021 GMT\n*  common name: httpbin.example.com (matched)\n*  issuer: O=example Inc.; CN=example.com\n*  SSL certificate verify ok.\n* Using HTTP2, server supports multi-use\n* Connection state changed (HTTP/2 confirmed)\n* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0\n* Using Stream ID: 1 (easy handle 0x7feb00008a00)\n&gt; GET /status/418 HTTP/2\n&gt; Host:httpbin.example.com\n&gt; User-Agent: curl/1\n&gt; Accept: */*\n&gt; \n* Connection state changed (MAX_CONCURRENT_STREAMS == 2147483647)!\n&lt; HTTP/2 418 \n&lt; server: istio-envoy\n&lt; date: Sat, 25 Jul 2020 08:46:02 GMT\n&lt; access-control-allow-credentials: true\n&lt; access-control-allow-origin: *\n&lt; x-more-info: http://tools.ietf.org/html/rfc2324\n&lt; content-length: 135\n&lt; x-envoy-upstream-service-time: 10\n&lt; \n\n    -=[ teapot ]=-\n\n       _...._\n     .'  _ _ `.\n    | .\"` ^ `\". _,\n    \\\\_;`\"---\"`|//\n      |       ;/\n      \\\\_     _/\n        `\"\"\"`\n* Connection #0 to host httpbin.example.com left intact\n* Closing connection 0\n</code></pre> <p>\u901a\u8fc7\u4e0a\u9762\u7684\u4fe1\u606f\u53ef\u4ee5\u770b\u5230\u8f93\u51fa\u4e86\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u901a\u8fc7 <code>-v</code> \u53c2\u6570\u8fd8\u53ef\u4ee5\u770b\u5230 TLS \u63e1\u624b\u5efa\u7acb\u8fde\u63a5\u7684\u5b8c\u6574\u8fc7\u7a0b\u3002</p>"},{"location":"kubernetes_service_mesh/security/#_4","title":"\u591a\u4e2a\u4e3b\u673a","text":"<p>\u4e0a\u9762\u662f\u5c06\u5355\u4e2a\u4e3b\u673a\u914d\u7f6e\u5230\u4e00\u4e2a Ingress Gateway \u4e2d\uff0c\u540c\u6837\u6211\u4eec\u8fd8\u53ef\u4ee5\u628a\u591a\u4e2a\u4e3b\u673a\u540d\u914d\u7f6e\u5230\u540c\u4e00\u4e2a Ingress Gateway \u4e0a\uff0c\u4f8b\u5982 <code>httpbin.example.com</code> \u548c <code>hello.example.com</code> \u4e24\u4e2a\u4e3b\u673a\u540d\u914d\u7f6e\u5230\u540c\u4e00\u4e2a\u7f51\u5173\u4e0a\uff0cIngress Gateway \u4f1a\u4e3a\u6bcf\u4e2a <code>credentialName</code> \u83b7\u53d6\u4e00\u4e2a\u552f\u4e00\u7684\u51ed\u636e\u3002</p> <p>\u540c\u6837\u5148\u90e8\u7f72 helloworld \u793a\u4f8b\u5e94\u7528\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># helloworld-vyaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: helloworld-v1\n  labels:\n    app: helloworld-v1\nspec:\n  ports:\n  - name: http\n    port: 5000\n  selector:\n    app: helloworld-v1\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: helloworld-v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: helloworld-v1\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: helloworld-v1\n        version: v1\n    spec:\n      containers:\n      - name: helloworld\n        image: istio/examples-helloworld-v1\n        resources:\n          requests:\n            cpu: \"100m\"\n        imagePullPolicy: IfNotPresent #Always\n        ports:\n        - containerPort: 5000\n</code></pre> <p>\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u547d\u4ee4\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f &lt;(istioctl kube-inject -f helloworld-vyaml)\nservice/helloworld-v1 created\ndeployment.apps/helloworld-v1 created\n$ kubectl get pods -l app=helloworld-v1\nNAME                       READY   STATUS            RESTARTS   AGE\nhttpbin-56db79f4f5-b2vp9   2/2     Running           0          8m35s\n$ kubectl get svc -l app=helloworld-v1\nNAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE\nhelloworld-v1   ClusterIP   171   &lt;none&gt;        5000/TCP   30s\n</code></pre> <p>\u7136\u540e\u540c\u6837\u4f7f\u7528\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684\u6839\u8bc1\u4e66\u6765\u5bf9\u57df\u540d <code>hello.example.com</code> \u8fdb\u884c\u7b7e\u540d\uff0c\u9996\u5148\u751f\u6210\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\uff1a</p> <pre><code>$ openssl req -out hello.example.com.csr -newkey rsa:2048 -nodes -keyout hello.example.com.key -subj \"/CN=hello.example.com/O=some organization\"\n</code></pre> <p>\u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\u6765\u8bf7\u6c42\u7b7e\u53d1\u8bc1\u4e66\uff1a</p> <pre><code>$ openssl x509 -req -days 365 -CA example.com.crt -CAkey example.com.key -set_serial 0 -in hello.example.com.csr -out hello.example.com.crt\nSignature ok\nsubject=CN = hello.example.com, O = some organization\nGetting CA Private Key\n</code></pre> <p>\u540c\u6837\u4f7f\u7528\u4e0a\u9762\u751f\u6210\u7684\u8bc1\u4e66\u548c\u5bc6\u94a5\u5728 istio-system \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u4e3a Ingress Gateway \u65b0\u5efa\u4e00\u4e2a Secret \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create secret tls hello-tls --cert=hello.example.com.crt --key=hello.example.com.key -n istio-system\nsecret/hello-tls created\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u5b9a\u4e49\u4e0a\u9762\u7684 Gateway \u7f51\u5173\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u4e24\u4e2a server\uff0c\u90fd\u5f00\u653e\u4e86 443 \u7aef\u53e3\u3002\u4e24\u4e2a <code>credentialName</code> \u5b57\u6bb5\u5206\u522b\u8d4b\u503c\u4e3a <code>httpbin-tls</code> \u548c <code>hello-tls</code>\uff0c\u8bbe\u7f6e TLS \u7684 mode \u4e3a <code>SIMPLE</code> \u3002</p> <pre><code>$ cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: networking.istio.io/v1beta1\nkind: Gateway\nmetadata:\n  name: mygateway\nspec:\n  selector:\n    istio: ingressgateway # \u4f7f\u7528 istio \u9ed8\u8ba4\u7684 ingress gateway\n  servers:\n  - port:\n      number: 443\n      name: https-httpbin\n      protocol: HTTPS\n    tls:\n      mode: SIMPLE\n      credentialName: \"httpbin-tls\"\n    hosts:\n    - \"httpbin.example.com\"\n  - port:\n      number: 443\n      name: https-hello\n      protocol: HTTPS\n    tls:\n      mode: SIMPLE\n      credentialName: \"hello-tls\"\n    hosts:\n    - \"hello.example.com\"\nEOF\n</code></pre> <p>\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u4e3a httpbin \u5e94\u7528\u914d\u7f6e\u4e86\u8def\u7531\u89c4\u5219\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u53ea\u9700\u8981\u4e3a helloworld \u5e94\u7528\u914d\u7f6e\u6d41\u91cf\u8def\u7531\u5373\u53ef\uff1a</p> <pre><code>$ cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: hello\nspec:\n  hosts:\n  - \"hello.example.com\"\n  gateways:\n  - mygateway\n  http:\n  - match:\n    - uri:\n        exact: /hello\n    route:\n    - destination:\n        host: helloworld-v1\n        port:\n          number: 5000\nEOF\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u5c06\u57df\u540d <code>hello.example.com</code> \u89e3\u6790\u5230\u7f51\u5173\u7684\u5730\u5740\uff0c\u7136\u540e\u5bf9\u5176\u53d1\u9001 HTTPS \u8bf7\u6c42\uff1a</p> <pre><code>$ curl -v -HHost:hello.example.com --cacert example.com.crt https://hello.example.com:30951/hello\n......\n&lt; HTTP/2 200 \n&lt; content-type: text/html; charset=utf-8\n&lt; content-length: 59\n&lt; server: istio-envoy\n&lt; date: Sat, 25 Jul 2020 08:49:42 GMT\n&lt; x-envoy-upstream-service-time: 313\n&lt; \n......\n</code></pre> <p>\u540c\u6837\u53d1\u9001 HTTPS \u8bf7\u6c42\u5230 <code>httpbin.example.com</code>\uff0c\u8fd8\u662f\u4f1a\u770b\u5230\u6b63\u786e\u7684\u7ed3\u679c\uff1a</p> <pre><code>$ curl -v -HHost:httpbin.example.com --cacert example.com.crt https://httpbin.example.com:30951/status/418\n......\n&lt; HTTP/2 418 \n&lt; server: istio-envoy\n&lt; date: Sat, 25 Jul 2020 08:50:53 GMT\n&lt; access-control-allow-credentials: true\n&lt; access-control-allow-origin: *\n&lt; x-more-info: http://tools.ietf.org/html/rfc2324\n&lt; content-length: 135\n&lt; x-envoy-upstream-service-time: 5\n&lt; \n\n    -=[ teapot ]=-\n\n       _...._\n     .'  _ _ `.\n    | .\"` ^ `\". _,\n    \\\\_;`\"---\"`|//\n      |       ;/\n      \\\\_     _/\n        `\"\"\"`\n* Connection #0 to host httpbin.example.com left intact\n* Closing connection 0\n</code></pre>"},{"location":"kubernetes_service_mesh/security/#mtls","title":"mTLS \u8ba4\u8bc1","text":"<p>\u5728 Istio \u4e2d\u4e3b\u8981\u6709\u4e24\u79cd\u7c7b\u578b\u7684\u8ba4\u8bc1\uff1a</p> <ul> <li>\u5bf9\u7b49\u8ba4\u8bc1\uff08PeerAuthentication\uff09\uff1a\u7528\u4e8e\u670d\u52a1\u5230\u670d\u52a1\u7684\u8ba4\u8bc1\uff0c\u4ee5\u9a8c\u8bc1\u8fdb\u884c\u8fde\u63a5\u7684\u5ba2\u6237\u7aef\uff0cIstio \u63d0\u4f9b\u53cc\u5411 TLS \u4f5c\u4e3a\u4f20\u8f93\u8ba4\u8bc1\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u65e0\u9700\u66f4\u6539\u670d\u52a1\u4ee3\u7801\u5c31\u53ef\u4ee5\u542f\u7528\u5b83\u3002</li> <li>\u8bf7\u6c42\u8ba4\u8bc1\uff08RequestAuthentication\uff09\uff1a\u7528\u4e8e\u6700\u7ec8\u7528\u6237\u8ba4\u8bc1\uff0c\u4ee5\u9a8c\u8bc1\u9644\u52a0\u5230\u8bf7\u6c42\u7684\u51ed\u636e\uff0cIstio \u4f7f\u7528 JSON Web Token\uff08JWT\uff09\u9a8c\u8bc1\u542f\u7528\u8bf7\u6c42\u7ea7\u8ba4\u8bc1\u3002</li> </ul> <p>Istio \u4e2d\u7684\u8ba4\u8bc1\u7b56\u7565\u8303\u56f4\u4e3b\u8981\u5305\u62ec\u5982\u4e0b\u4e09\u4e2a\u65b9\u9762\uff1a</p> <ul> <li>\u7f51\u683c</li> <li>\u547d\u540d\u7a7a\u95f4</li> <li>\u7279\u5b9a\u670d\u52a1</li> </ul> <p>\u6b64\u5916\uff0cIstio \u7684\u8ba4\u8bc1\u673a\u5236\u652f\u6301\u517c\u5bb9\u6a21\u5f0f\uff08permissive mode\uff09\uff0c\u4ee5\u5e2e\u52a9\u6211\u4eec\u4e86\u89e3\u5b89\u5168\u7b56\u7565\u6216\u8005\u670d\u52a1\u8fc1\u79fb\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4e3a\u670d\u52a1\u7f51\u683c\u5185\u90e8\u7684\u670d\u52a1\u5f00\u542f\u81ea\u52a8 mTLS\uff08\u53cc\u5411TLS\u8ba4\u8bc1\uff09\uff0c\u5b9e\u73b0\u5ba2\u6237\u7aef\u3001\u670d\u52a1\u7aef\u90fd\u9a8c\u8bc1\u53cc\u65b9\u8eab\u4efd\u3002\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u5728 default \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u90e8\u7f72\u4e86 httpbin \u5e94\u7528\uff1a</p> <pre><code>$ kubectl get pods -l app=httpbin\nNAME                       READY   STATUS    RESTARTS   AGE\nhttpbin-68dbf6ccd9-npn6w   2/2     Running   0          11d\n$ kubectl get svc -l app=httpbin\nNAME      TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE\nhttpbin   ClusterIP   114   &lt;none&gt;        8000/TCP   11d\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6765\u6d4b\u8bd5\u4e0b\u547d\u540d\u7a7a\u95f4\u8303\u56f4\u5185\u7684\u8ba4\u8bc1\uff0c\u90e8\u7f72 sleep \u5e94\u7528\u5230 mtls \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\uff1a</p> <pre><code>$ kubectl create ns mtls\nnamespace/mtls created\n$ kubectl apply -f samples/sleep/sleep.yaml -n mtls\nserviceaccount/sleep created\nservice/sleep created\ndeployment.apps/sleep created\n$ kubectl get pods -n mtls\nNAME                    READY   STATUS    RESTARTS   AGE\nsleep-f8cbf5b76-kfqzv   1/1     Running   0          95s\n</code></pre> <p>\u5f53\u5e94\u7528\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u4ee5 sleep \u5e94\u7528\u4e3a\u5ba2\u6237\u7aef\u6765\u8bbf\u95ee default \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684 httpbin \u5e94\u7528\uff0c\u547d\u4ee4\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ kubectl exec -it sleep-f8cbf5b76-kfqzv -n mtls -- curl http://httpbin.default:8000/ip\n{\n  \"origin\": \"11\"\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u80fd\u591f\u6b63\u5e38\u8bbf\u95ee\uff0c\u8fd9\u662f\u56e0\u4e3a\u901a\u4fe1\u7684\u53cc\u65b9\u6ca1\u6709\u4efb\u4f55\u7684 TLS \u8ba4\u8bc1\u65b9\u5f0f\uff0c\u6240\u4ee5\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u53ef\u4ee5\u8bbf\u95ee\u7684\u3002\u7136\u540e\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u5bf9\u7b49\u8ba4\u8bc1\u7684\u7b56\u7565\uff1a</p> <pre><code># mtls-demo.yaml\napiVersion: security.istio.io/v1beta1\nkind: PeerAuthentication\nmetadata:\n  name: mtls-demo\n  namespace: default  # \u53bb\u6389namespace\u5c31\u662f\u5168\u5c40\u7684\uff0c\u52a0\u4e0a\u5c31\u662f\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u7684\nspec:\n  selector:  # \u5982\u679c\u914d\u7f6e\u4e86selector\uff0c\u5219\u53ea\u4f1a\u5bf9\u4e0b\u9762\u5339\u914d\u7684\u670d\u52a1\u751f\u6548\uff08\u9488\u5bf9\u7279\u5b9a\u7684\u670d\u52a1\uff09\uff0c\u5982\u679c\u60a8\u6ca1\u6709\u4e3a selector \u5b57\u6bb5\u63d0\u4f9b\u503c\uff0c\u5219 Istio \u4f1a\u5c06\u7b56\u7565\u4e0e\u7b56\u7565\u5b58\u50a8\u8303\u56f4\u5185\u7684\u6240\u6709\u5de5\u4f5c\u8d1f\u8f7d\u8fdb\u884c\u5339\u914d\n    matchLabels:\n      app: httpbin\n  mtls:\n    mode: PERMISSIVE  # \u517c\u5bb9\u6a21\u5f0f\uff1a\u53ef\u4ee5\u540c\u65f6\u4f7f\u7528\u660e\u6587\u548c\u52a0\u5bc6\u7684\u65b9\u5f0f\u8bbf\u95ee\n    # mode: STRICT   # \u4e25\u683c\u6a21\u5f0f\uff1a\u53cc\u65b9\u5fc5\u987b\u4f7f\u7528 mTLS \u53bb\u8bbf\u95ee \n    # DISABLE\uff1a\u7981\u7528\u53cc\u5411 TLS\uff0c\u4ece\u5b89\u5168\u89d2\u5ea6\u6765\u770b\uff0c\u9664\u975e\u60a8\u63d0\u4f9b\u81ea\u5df1\u7684\u5b89\u5168\u89e3\u51b3\u65b9\u6848\uff0c\u5426\u5219\u8bf7\u52ff\u4f7f\u7528\u6b64\u6a21\u5f0f\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u57fa\u4e8e default \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u7684\u5bf9\u7b49\u8ba4\u8bc1\u7b56\u7565\uff0c\u901a\u8fc7\u914d\u7f6e <code>mode: PERMISSIVE</code> \u6307\u5b9a\u4f7f\u7528\u517c\u5bb9\u6a21\u5f0f\u8fdb\u884c\u8ba4\u8bc1\uff0c\u8be5\u6a21\u5f0f\u4e0b\u9762\u53ef\u4ee5\u540c\u65f6\u4f7f\u7528\u660e\u6587\u548c\u52a0\u5bc6\u7684\u65b9\u5f0f\u8bbf\u95ee\u670d\u52a1\uff0c\u6b64\u5916\u8fd8\u53ef\u4ee5\u901a\u8fc7 labelSelector \u53bb\u9488\u5bf9\u7279\u5b9a\u7684\u670d\u52a1\u751f\u6548\u3002\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f mtls-demo.yaml\npeerauthentication.security.istio.io/mtls-demo created\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u91cd\u65b0\u8bbf\u95ee httpbin \u5e94\u7528\u53ef\u4ee5\u770b\u5230\u4ecd\u7136\u53ef\u4ee5\u8bbf\u95ee\uff0c\u56e0\u4e3a\u6211\u4eec\u914d\u7f6e\u7684\u662f\u517c\u5bb9\u7684\u5bbd\u677e\u6a21\u5f0f\uff1a</p> <pre><code>$ kubectl exec -it sleep-f8cbf5b76-kfqzv -n mtls -- curl http://httpbin.default:8000/ip\n{\n  \"origin\": \"11\"\n}\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u4e0a\u9762\u7684 mode \u6539\u6210\u4e25\u683c\u6a21\u5f0f <code>STRICT</code>\uff0c\u91cd\u65b0\u66f4\u65b0\u540e\uff0c\u518d\u6b21\u8bbf\u95ee httpbin \u5e94\u7528\uff1a</p> <pre><code>$ kubectl exec -it sleep-f8cbf5b76-kfqzv -n mtls -- curl http://httpbin.default:8000/ip\ncurl: (56) Recv failure: Connection reset by peer\ncommand terminated with exit code 56\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8bf7\u6c42\u5931\u8d25\u4e86\uff0c\u8bc1\u660e\u6211\u4eec\u914d\u7f6e\u7684\u4e25\u683c\u6a21\u5f0f\u751f\u6548\u4e86\u3002\u90a3\u4e48\u6b63\u786e\u8bbf\u95ee httpbin \u670d\u52a1\u7684\u65b9\u5f0f\u662f\u600e\u6837\u7684\u5462\uff1f\u5176\u5b9e\u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5c06\u6211\u4eec\u7684\u5ba2\u6237\u7aef sleep \u5e94\u7528\u52a0\u5165\u5230\u7f51\u683c\u4e2d\u6765\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f &lt;(istioctl kube-inject -f samples/sleep/sleep.yaml) -n mtls\nserviceaccount/sleep unchanged\nservice/sleep unchanged\ndeployment.apps/sleep configured\n$ kubectl get pods -n mtls\nNAME                     READY   STATUS     RESTARTS   AGE\nsleep-776fd7c979-jvpbt   2/2     Running    0          15s\n$ kubectl exec -it sleep-776fd7c979-jvpbt -c sleep -n mtls -- curl http://httpbin.default:8000/ip\n{\n  \"origin\": \"11\"\n}\n</code></pre> <p>\u6211\u4eec\u53ea\u662f\u5728\u7f51\u683c\u4e2d\u521b\u5efa\u4e86\u4e00\u4e2a\u5bf9\u7b49\u8ba4\u8bc1\u7b56\u7565\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u5c31\u5b8c\u6210\u4e86 mTLS \u8ba4\u8bc1\uff0c\u8fd9\u662f\u56e0\u4e3a Istio \u5df2\u7ecf\u5b9e\u73b0\u4e86\u81ea\u52a8\u7684 mTLS\uff0c\u4f1a\u5e2e\u6211\u4eec\u81ea\u52a8\u5b8c\u6210\u8bc1\u4e66\u548c\u5bc6\u94a5\u7684\u7ba1\u7406\uff0c\u76f4\u63a5\u6ce8\u5165\u5373\u53ef\u3002</p>"},{"location":"kubernetes_service_mesh/security/#jwt","title":"\u57fa\u4e8e JWT \u7684\u8ba4\u8bc1\u548c\u6388\u6743","text":"<p>JWT\uff08JSON Web Token\uff09\u662f\u4e00\u79cd\u591a\u65b9\u4f20\u9012\u53ef\u4fe1 JSON \u6570\u636e\u7684\u65b9\u6848\uff0c\u4e00\u4e2a JWT token \u7531<code>.</code>\u5206\u9694\u7684\u4e09\u90e8\u5206\u7ec4\u6210\uff1a</p> <pre><code>{Header}.{Payload}.{Signature}\n</code></pre> <p>\uff0c\u5176\u4e2d Header \u662f Base64 \u7f16\u7801\u7684 JSON \u6570\u636e\uff0c\u5305\u542b\u4ee4\u724c\u7c7b\u578b\u3001\u7b7e\u540d\u7b97\u6cd5\u4ee5\u53ca\u79d8\u94a5 ID \u7b49\u4fe1\u606f\uff1bPayload \u662f\u9700\u8981\u4f20\u9012\u7684 claims \u6570\u636e\uff0c\u4e5f\u662f Base64 \u7f16\u7801\u7684 JSON \u6570\u636e\uff0c\u5176\u4e2d\u6709\u4e9b\u5b57\u6bb5\u662f JWT \u6807\u51c6\u5df2\u6709\u7684\u5b57\u6bb5\u5982\uff1aexp\u3001iat\u3001iss\u3001sub \u7b49\uff0c\u4e5f\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u6dfb\u52a0\u81ea\u5b9a\u4e49\u5b57\u6bb5\uff1bSignature \u662f\u5bf9\u524d\u4e24\u90e8\u5206\u7684\u7b7e\u540d\uff0c\u9632\u6b62\u6570\u636e\u88ab\u7be1\u6539\uff0c\u4ee5\u6b64\u786e\u4fdd token \u4fe1\u606f\u662f\u53ef\u4fe1\u7684\u3002</p> <p></p> <p>Istio \u4e2d\u9a8c\u7b7e\u6240\u9700\u516c\u94a5\u7531 </p> <pre><code>RequestAuthentication\n</code></pre> <p>\u8bf7\u6c42\u8ba4\u8bc1\u8d44\u6e90\u7684 jwks \u914d\u7f6e\u63d0\u4f9b\u3002JWT \u6388\u6743\u5219\u662f\u5bf9\u7ec8\u7aef\u7528\u6237\u7684\u8bbf\u95ee\u63a7\u5236\uff0c\u6bd4\u5982\u67d0\u4e2a\u5185\u90e8\u670d\u52a1\u9700\u8981\u7ba1\u7406\u5458\u624d\u80fd\u591f\u8bbf\u95ee\uff0c\u8fd9\u65f6\u5019\u5c31\u9700\u8981\u9a8c\u8bc1\u7ec8\u7aef\u7528\u6237\u7684\u89d2\u8272\u662f\u5426\u4e3a\u7ba1\u7406\u5458\uff0c\u53ef\u4ee5\u5728 JWT claims \u4e2d\u5e26\u6709\u7ba1\u7406\u5458\u89d2\u8272\u4fe1\u606f\uff0c\u7136\u540e\u5728\u6388\u6743\u7b56\u7565\u4e2d\u5bf9\u8be5\u89d2\u8272\u8fdb\u884c\u6388\u6743\u3002</p> <p>\u8981\u4f7f\u7528 JWT \u6388\u6743\u7684\u5f53\u7136\u5c31\u9700\u8981\u6709\u6548\u7684 JWT \u7ec8\u7aef\u8eab\u4efd\u8ba4\u8bc1\uff0c\u6240\u4ee5\u5728\u4f7f\u7528 JWT \u6388\u6743\u524d\u9996\u5148\u8981\u4e3a\u670d\u52a1\u6dfb\u52a0\u7ec8\u7aef\u8eab\u4efd\u8ba4\u8bc1\u5373 </p> <pre><code>RequestAuthentication\n</code></pre> <p>\u3002</p> <p>Request \u8ba4\u8bc1\u7b56\u7565\u6307\u5b9a\u9a8c\u8bc1 JWT \u6240\u9700\u7684\u503c\uff0c\u8fd9\u4e9b\u503c\u5305\u62ec\uff1a</p> <ul> <li>token \u5728\u8bf7\u6c42\u4e2d\u7684\u4f4d\u7f6e</li> <li>\u8bf7\u6c42\u7684 issuer</li> <li>\u516c\u5171 JSON Web Key Set\uff08JWKS\uff09</li> </ul> <p>Istio \u4f1a\u6839\u636e request \u8ba4\u8bc1\u7b56\u7565\u4e2d\u7684\u89c4\u5219\u68c0\u67e5\u63d0\u4f9b\u7684\u4ee4\u724c\uff08\u5982\u679c\u5df2\u63d0\u4f9b\uff09\uff0c\u5e76\u62d2\u7edd\u4ee4\u724c\u65e0\u6548\u7684\u8bf7\u6c42\u3002\u5f53\u8bf7\u6c42\u4e0d\u5e26\u6709\u4ee4\u724c\u65f6\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5c06\u63a5\u53d7\u5b83\u4eec\u3002\u8981\u62d2\u7edd\u6ca1\u6709\u4ee4\u724c\u7684\u8bf7\u6c42\uff0c\u8bf7\u63d0\u4f9b\u6388\u6743\u89c4\u5219\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6765\u9a8c\u8bc1\u57fa\u4e8e JWT \u7684\u8ba4\u8bc1\u529f\u80fd\uff0c\u540c\u6837\u4f7f\u7528 sleep \u548c httpbin \u5e94\u7528\u4e3a\u4f8b\uff0c\u5c06 sleep \u90e8\u7f72\u5230\u540d\u4e3a jwtest \u7684\u547d\u540d\u7a7a\u95f4\uff1a</p> <pre><code>$ kubectl create ns jwtest\nnamespace/jwtest created\n$ kubectl apply -f &lt;(istioctl kube-inject -f samples/sleep/sleep.yaml) -n jwtest\nserviceaccount/sleep created\nservice/sleep created\ndeployment.apps/sleep created\n$ kubectl get pods -n jwtest\nNAME                     READY   STATUS    RESTARTS   AGE\nsleep-776fd7c979-7jrv2   2/2     Running   0          76s\n</code></pre> <p>\u73b0\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6211\u4eec\u662f\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee httpbin \u5e94\u7528\u7684\uff1a</p> <pre><code>$ kubectl exec -it sleep-776fd7c979-7jrv2 -c sleep -n jwtest -- curl http://httpbin.default:8000/ip\n{\n  \"origin\": \"11\"\n}\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u8bf7\u6c42\u8ba4\u8bc1\u5bf9\u8c61\uff1a</p> <pre><code># jwt-demo.yaml\napiVersion: security.istio.io/v1beta1\nkind: RequestAuthentication  # \u8bf7\u6c42\u8ba4\u8bc1\nmetadata:\n  name: jwt-demo\n  namespace: default\nspec:\n  selector:  # \u9488\u5bf9\u7279\u5b9a\u7684\u670d\u52a1\n    matchLabels:\n      app: httpbin\n  jwtRules:\n  - issuer: \"testing@secure.istio.io\"\n    jwksUri: \"https://raw.githubusercontent.com/istio/istio/release-6/security/tools/jwt/samples/jwks.json\"\n    # jwks\n    # fromHeaders\n    # fromParams\n</code></pre> <p>\u5176\u4e2d\u6700\u91cd\u8981\u7684\u5c31\u662f <code>jwtRules</code> \u5c5e\u6027\u4e0b\u9762\u7684\u914d\u7f6e\uff0c\u6211\u4eec\u8fd9\u91cc\u901a\u8fc7 <code>jwksUri</code> \u6765\u6307\u5b9a\u6240\u9700\u7684\u8ba4\u8bc1\u4fe1\u606f\uff0c\u76f4\u63a5\u521b\u5efa\uff1a</p> <pre><code>$ kubectl apply -f jwt-demo.yaml\nrequestauthentication.security.istio.io/jwt-demo created\n</code></pre> <p>\u8fd9\u4e2a\u8bf7\u6c42\u8ba4\u8bc1\u7b56\u7565\u4f7f\u5f97 httpbin \u5e94\u7528\u63a5\u6536 <code>Issuer</code> \u4e3a </p> <pre><code>testing@secure.istio.io\n</code></pre> <p>\u7684 JWT \u4ee4\u724c\u3002\u6bd4\u5982\u6211\u4eec\u901a\u8fc7\u4e00\u4e2a\u65e0\u6548\u7684 Token \u6765\u8bbf\u95ee\u5e94\u7528\uff1a</p> <pre><code>$ kubectl exec -it sleep-776fd7c979-7jrv2 -c sleep -n jwtest -- curl http://httpbin.default:8000/headers -s -o /dev/null -H \"Authorization: Bearer invalidToken\" -w \"%{http_code}\\\\n\"\n401\n</code></pre> <p>\u56e0\u4e3a\u6211\u4eec\u6307\u5b9a\u4e86 Token\uff0c\u6240\u4ee5\u5c31\u9700\u8981\u4f7f\u7528\u6211\u4eec\u914d\u7f6e\u7684 JWT Token \u6765\u8fdb\u884c\u8ba4\u8bc1\u3002\u5982\u679c\u6211\u4eec\u4e0d\u5e26\u4e0a Token\uff0c\u5219\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u5e76\u6ca1\u6709\u914d\u7f6e\u4efb\u4f55\u6388\u6743\u7b56\u7565\uff1a</p> <pre><code>$ kubectl exec -it sleep-776fd7c979-7jrv2 -c sleep -n jwtest -- curl http://httpbin.default:8000/headers -s -o /dev/null -w \"%{http_code}\\\\n\"\n200\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u9488\u5bf9 httpbin \u5e94\u7528\u914d\u7f6e\u4e00\u4e2a\u6388\u6743\u7b56\u7565\uff0c\u8981\u6c42\u6240\u6709\u53d1\u5f80 httpbin \u5e94\u7528\u7684\u8bf7\u6c42\u90fd\u8981\u5305\u542b\u4e00\u4e2a\u5c06 <code>requestPrincipal</code> \u8bbe\u7f6e\u4e3a </p> <pre><code>testing@secure.istio.io/testing@secure.istio.io\n</code></pre> <p>\u7684\u6709\u6548 JWT\u3002</p> <pre><code>apiVersion: security.istio.io/v1beta1\nkind: AuthorizationPolicy  # \u6388\u6743\u7b56\u7565\nmetadata:\n  name: auth-policy-demo\n  namespace: default\nspec:\n  selector:\n    matchLabels:\n      app: httpbin\n  action: ALLOW  # ALLOW\u3001DENY\n  rules:\n  - from:\n    - source:\n        requestPrincipals: [\"testing@secure.istio.io/testing@secure.istio.io\"]\n</code></pre> <p>Istio \u4f1a\u4f7f\u7528 <code>/</code> \u8fde\u63a5 JWT \u7684 <code>iss</code> \u548c <code>sub</code> \u6765\u7ec4\u6210 <code>requestPrincipal</code> \u5b57\u6bb5\uff0c\u6bd4\u5982\u6211\u8fd9\u91cc\u7684 iss \u548c sub \u90fd\u4e3a </p> <pre><code>testing@secure.istio.io\n</code></pre> <p>\uff0c\u8fd9\u6837 Istio \u751f\u6210\u7684 <code>requestPrincipal</code> \u5c5e\u6027\u503c\u4e3a </p> <pre><code>testing@secure.istio.io/testing@secure.istio.io\n</code></pre> <p>\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u83b7\u53d6\u6d4b\u8bd5\u7684 Token \u4ee5\u53ca JSON \u4fe1\u606f\uff1a</p> <pre><code>$ JWT_JSON=$(curl https://raw.githubusercontent.com/istio/istio/release-6/security/tools/jwt/samples/demo.jwt -s) &amp;&amp; echo $JWT_JSON | cut -d '.' -f2 - | base64 --decode -\n{\"exp\":4685989700,\"foo\":\"bar\",\"iat\":1532389700,\"iss\":\"testing@secure.istio.io\",\"sub\":\"testing@secure.istio.io\"}\n$ TOKEN=$(curl https://raw.githubusercontent.com/istio/istio/release-6/security/tools/jwt/samples/demo.jwt -s)\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8ba4\u8bc1\u7b56\u7565\uff1a</p> <pre><code>$ kubectl apply -f auth-policy-demo.yaml\nauthorizationpolicy.security.istio.io/auth-policy-demo created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u4f7f\u7528\u4e0a\u9762\u7684\u6709\u6548\u7684 TOKEN \u6765\u8bbf\u95ee httpbin \u5e94\u7528\uff1a</p> <pre><code>$ kubectl exec -it sleep-776fd7c979-7jrv2 -c sleep -n jwtest -- curl \"http://httpbin.default:8000/headers\" -s -o /dev/null -H \"Authorization: Bearer $TOKEN\" -w \"%{http_code}\\\\n\"\n200\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\uff0c\u6211\u4eec\u91cd\u65b0\u4f7f\u7528\u6ca1\u6709 JWT Token \u7684 Header \u6765\u8bf7\u6c42 httpbin \u5e94\u7528\uff1a</p> <pre><code>istio-1]# kubectl exec -it sleep-776fd7c979-7jrv2 -c sleep -n jwtest -- curl \"http://httpbin.default:8000/headers\" -s -o /dev/null -w \"%{http_code}\\\\n\"\n403\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u662f 403 \u9519\u8bef\uff0c\u8fd9\u662f\u56e0\u4e3a\u5f53\u524d\u7684\u8bf7\u6c42\u4e0d\u7b26\u5408\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u7684\u6388\u6743\u7b56\u7565\u3002\u5173\u4e8e\u5b89\u5168\u76f8\u5173\u7684\u66f4\u591a\u4fe1\u606f\u6216\u8005\u8d44\u6e90\u5bf9\u8c61\u5c5e\u6027\u5b57\u6bb5\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863\uff1ahttps://istio.io/latest/zh/docs/concepts/security/\u3002</p>"},{"location":"kubernetes_service_mesh/traffic/","title":"\u6d41\u91cf\u7ba1\u7406","text":""},{"location":"kubernetes_service_mesh/traffic/#_1","title":"\u6d41\u91cf\u7ba1\u7406","text":"<p>\u5728\u524d\u9762\u6211\u4eec\u6210\u529f\u642d\u5efa\u5e76\u90e8\u7f72\u4e86 Istio \u53ca\u5176\u5176 Bookinfo \u793a\u4f8b\u5e94\u7528\uff1a</p> <p></p> <p>\u76ee\u524d\u642d\u5efa Bookinfo \u5e94\u7528\u6211\u4eec\u53ea\u7528\u5230\u4e86\u4e0b\u9762\u4e24\u4e2a\u8d44\u6e90\u6587\u4ef6\uff1a</p> <pre><code>samples/bookinfo/platform/kube/bookinfo.yaml\nsamples/bookinfo/networking/bookinfo-gateway.yaml\n</code></pre> <p>\u524d\u8005\u5c31\u662f\u901a\u5e38\u7684 Kubernetes \u5b9a\u4e49\u7684 Deployment \u548c Service \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u53ea\u662f\u5728\u90e8\u7f72\u65f6\u4f7f\u7528 <code>istioctl kube-inject</code> \u5bf9\u8fd9\u4e2a\u6587\u4ef6\u5b9a\u4e49\u7684 Pod \u6ce8\u5165\u4e86 sidecar \u4ee3\u7406\uff0c\u540e\u8005\u5b9a\u4e49\u4e86\u8fd9\u4e2a\u5e94\u7528\u7684\u5916\u90e8\u8bbf\u95ee\u5165\u53e3gateway\uff0c\u4ee5\u53ca\u5e94\u7528\u5185\u90e8 productpage \u670d\u52a1\u7684 <code>VirtualService</code> \u89c4\u5219\uff0c\u800c\u5176\u4ed6\u5185\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u8fd8\u6ca1\u6709\u88ab\u5b9a\u4e49\u3002</p> <p>\u73b0\u5728\u8bbf\u95ee\u5e94\u7528\u754c\u9762\u5e76\u5237\u65b0\uff0c\u4f1a\u770b\u5230 Reviews \u6709\u65f6\u4e0d\u4f1a\u663e\u793a\u8bc4\u5206\uff0c\u6709\u65f6\u5019\u4f1a\u663e\u793a\u4e0d\u540c\u6837\u5f0f\u7684\u8bc4\u5206\uff0c\u8fd9\u662f\u56e0\u4e3a\u540e\u9762\u67093\u4e2a\u4e0d\u540c\u7684 Reviews \u670d\u52a1\u7248\u672c\uff0c\u800c\u6ca1\u6709\u914d\u7f6e\u8be5\u670d\u52a1\u7684\u8def\u7531\u89c4\u5219 <code>route rule</code> \u7684\u60c5\u51b5\u4e0b\uff0c\u8be5\u670d\u52a1\u7684\u51e0\u4e2a\u5b9e\u4f8b\u4f1a\u88ab\u968f\u673a\u8bbf\u95ee\u5230\uff0c\u6709\u7684\u7248\u672c\u670d\u52a1\u4f1a\u8fdb\u4e00\u6b65\u8c03\u7528 Ratings \u670d\u52a1\uff0c\u6709\u7684\u4e0d\u4f1a\u3002</p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5df2\u7ecf\u63a5\u89e6\u5230\u4e86 Istio \u4e2d\u4e24\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u6d41\u91cf\u7ba1\u7406\u7684\u8d44\u6e90\u5bf9\u8c61\u4e86\uff1a</p> <ul> <li>VirtualService \u662f\u7528\u6765\u5728 Istio \u4e2d\u5b9a\u4e49\u8def\u7531\u89c4\u5219\uff0c\u63a7\u5236\u6d41\u91cf\u8def\u7531\u5230\u670d\u52a1\u4e0a\u7684\u5404\u79cd\u884c\u4e3a\u3002</li> <li>Gateway \u6211\u4e3a HTTP/TCP \u6d41\u91cf\u914d\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u3002</li> </ul> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u5bf9 Bookinfo \u670d\u52a1\u7684\u8bbf\u95ee\u89c4\u5219\u8fdb\u884c\u4fee\u6539\u3002</p>"},{"location":"kubernetes_service_mesh/traffic/#_2","title":"\u4e0d\u540c\u670d\u52a1\u7248\u672c\u8bbf\u95ee\u89c4\u5219","text":"<p>\u5bf9 Reviews \u670d\u52a1\u6dfb\u52a0\u4e00\u6761\u8def\u7531\u89c4\u5219\uff0c\u542f\u7528 </p> <pre><code>samples/bookinfo/networking/virtual-service-reviews-vyaml\n</code></pre> <p>\u5b9a\u4e49\u7684 VirtualService \u89c4\u5219\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n  - reviews\n  http:\n  - route:\n    - destination:\n        host: reviews\n        subset: v3\n</code></pre> <p>\u8fd9\u6837\uff0c\u6240\u6709\u8bbf\u95ee reviews \u670d\u52a1\u7684\u6d41\u91cf\u5c31\u4f1a\u88ab\u5f15\u5bfc\u5230 reviews \u670d\u52a1\u5bf9\u5e94\u7684 subset \u4e3a v3 \u7684 Pod \u4e2d\u3002\u542f\u7528\u8fd9\u6761\u89c4\u5219\uff1a</p> <pre><code>$ kubectl apply -f  samples/bookinfo/networking/virtual-service-reviews-vyaml\nvirtualservice.networking.istio.io/reviews created\n</code></pre> <p>\u7136\u540e\u67e5\u770b\u6240\u6709\u7684\u8def\u7531\u89c4\u5219\uff1a</p> <pre><code>$ kubectl get virtualservices\nNAME       GATEWAYS             HOSTS       AGE\nbookinfo   [bookinfo-gateway]   [*]         158d\nreviews                         [reviews]   20s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 reviews \u7684 <code>VirtualService</code> \u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u6b64\u65f6\u6211\u4eec\u53bb\u5237\u65b0\u5e94\u7528\u7684\u9875\u9762\uff0c\u53d1\u73b0\u8bbf\u95ee Reviews \u5931\u8d25\u4e86\uff1a</p> <p></p> <p>\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u521b\u5efa DestinationRule \u5bf9\u8c61\uff0cDestinationRule \u5bf9\u8c61\u662f VirtualService \u8def\u7531\u751f\u6548\u540e\uff0c\u914d\u7f6e\u5e94\u7528\u4e0e\u8bf7\u6c42\u7684\u7b56\u7565\u96c6\uff0c\u7528\u6765\u5c06 VirtualService \u4e2d\u6307\u5b9a\u7684 subset \u4e0e\u5bf9\u5e94\u7684 Pod \u5173\u8054\u8d77\u6765\u3002</p> <p>\u5728 </p> <pre><code>samples/bookinfo/networking/destination-rule-all.yaml\n</code></pre> <p>\u6587\u4ef6\u4e2d\u6709\u5b9a\u4e49\u6240\u6709\u8be5\u5e94\u7528\u4e2d\u8981\u7528\u5230\u7684\u6240\u6709 DestinationRule \u8d44\u6e90\u5bf9\u8c61\uff0c\u5176\u4e2d\u6709\u4e00\u6bb5\u5c31\u662f\u5bf9 Reviews \u76f8\u5173\u7684 DestinationRule \u7684\u5b9a\u4e49:</p> <pre><code>---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: reviews\nspec:\n  host: reviews\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n  - name: v2\n    labels:\n      version: v2\n  - name: v3\n    labels:\n      version: v3\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 DestinationRule \u4e2d\u5b9a\u4e49\u4e86 <code>subsets</code> \u96c6\u5408\uff0c\u5176\u4e2d labels \u5c31\u548c\u6211\u4eec\u4e4b\u524d Service \u7684 <code>labelselector</code> \u4e00\u6837\u662f\u53bb\u5339\u914d Pod \u7684 labels \u6807\u7b7e\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc subsets \u4e2d\u5c31\u5305\u542b\u4e00\u4e2a\u540d\u4e3a v3 \u7684 subset\uff0c\u800c\u8fd9\u4e2a subset \u5339\u914d\u7684\u5c31\u662f\u5177\u6709 <code>version=v3</code> \u8fd9\u4e2a label \u6807\u7b7e\u7684 Pod \u96c6\u5408\uff0c\u518d\u56de\u5230\u4e4b\u524d\u7684 </p> <pre><code>samples/bookinfo/platform/kube/bookinfo.yaml\n</code></pre> <p>\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 reviews \u7684 Deployment \u786e\u5b9e\u6709\u58f0\u660e\u4e0d\u540c\u7684 <code>labels-&gt;version</code>:</p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: reviews-v3\n  labels:\n    app: reviews\n    version: v3\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: reviews\n      version: v3  \n  template:\n    metadata:\n      labels:\n        app: reviews\n        version: v3 # \u58f0\u660eversion=v3\u7684\u6807\u7b7e\n    spec:\n      serviceAccountName: bookinfo-reviews\n      containers:\n      - name: reviews\n        image: docker.io/istio/examples-bookinfo-reviews-v3:1\n        imagePullPolicy: IfNotPresent\n        env:\n        - name: LOG_DIR\n          value: \"/tmp/logs\"\n        ports:\n        - containerPort: 9080\n        volumeMounts:\n        - name: tmp\n          mountPath: /tmp\n        - name: wlp-output\n          mountPath: /opt/ibm/wlp/output\n      volumes:\n      - name: wlp-output\n        emptyDir: {}\n      - name: tmp\n        emptyDir: {}\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u901a\u8fc7 DestinationRule \u5c06 VirtualService \u4e0e Service \u4e0d\u540c\u7684\u7248\u672c\u5173\u8054\u8d77\u6765\u4e86\u3002\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u521b\u5efa DestinationRule \u8d44\u6e90\uff1a</p> <pre><code>$ kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml\ndestinationrule.networking.istio.io/productpage created\ndestinationrule.networking.istio.io/reviews created\ndestinationrule.networking.istio.io/ratings created\ndestinationrule.networking.istio.io/details created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u76ee\u524d\u6211\u4eec\u7f51\u683c\u4e2d\u7684 DestinationRules:</p> <pre><code>$ kubectl get destinationrule\nNAME          HOST          AGE\ndetails       details       18s\nproductpage   productpage   18s\nratings       ratings       18s\nreviews       reviews       18s\n</code></pre> <p>\u6b64\u65f6\u518d\u8bbf\u95ee\u5e94\u7528\u5c31\u6210\u529f\u4e86\uff0c\u591a\u6b21\u5237\u65b0\u9875\u9762\u53d1\u73b0 Reviews \u90fd\u5c55\u793a\u7684\u662f v3 \u7248\u672c\u5e26\u7ea2\u8272\u661f\u7684 Ratings\uff0c\u8bf4\u660e\u6211\u4eecVirtualService \u7684\u914d\u7f6e\u6210\u529f\u4e86\u3002</p> <p></p>"},{"location":"kubernetes_service_mesh/traffic/#_3","title":"\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219","text":"<p>\u521a\u521a\u6211\u4eec\u6f14\u793a\u7684\u57fa\u4e8e\u4e0d\u540c\u670d\u52a1\u7248\u672c\u7684\u670d\u52a1\u7f51\u683c\u7684\u63a7\u5236\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u6f14\u793a\u4e0b\u57fa\u4e8e\u6743\u91cd\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219\u7684\u4f7f\u7528\u3002</p> <p>\u9996\u5148\u79fb\u9664\u521a\u521a\u521b\u5efa\u7684 VirtualService \u5bf9\u8c61\uff0c\u6392\u9664\u5bf9\u73af\u5883\u7684\u5f71\u54cd\uff1a</p> <pre><code>$ kubectl delete virtualservice reviews\nvirtualservice.networking.istio.io \"reviews\" deleted\n$ kubectl get virtualservice\nNAME       GATEWAYS             HOSTS   AGE\nbookinfo   [bookinfo-gateway]   [*]     11m\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u518d\u53bb\u8bbf\u95ee Bookinfo \u5e94\u7528\u53c8\u56de\u5230\u6700\u521d\u968f\u673a\u8bbf\u95ee Reviews \u7684\u60c5\u51b5\u4e86\u3002\u73b0\u5728\u6211\u4eec\u67e5\u770b\u6587\u4ef6 </p> <pre><code>samples/bookinfo/networking/virtual-service-reviews-80-yaml\n</code></pre> <p>\u7684\u5b9a\u4e49\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n  - reviews\n  http:\n  - route:\n    - destination:\n        host: reviews\n        subset: v1\n      weight: 80\n    - destination:\n        host: reviews\n        subset: v2\n      weight: 20\n</code></pre> <p>\u8fd9\u4e2a\u89c4\u5219\u5b9a\u4e49\u4e86 80% \u7684\u5bf9 Reviews \u7684\u6d41\u91cf\u4f1a\u843d\u5165 v1 \u8fd9\u4e2a subset\uff0c\u5c31\u662f\u6ca1\u6709 Ratings \u7684\u8fd9\u4e2a\u670d\u52a1\uff0c20% \u4f1a\u843d\u5165 v2 \u5e26\u9ed1\u8272 Ratings \u7684\u8fd9\u4e2a\u670d\u52a1\uff0c\u7136\u540e\u6211\u4eec\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-80-yaml\nvirtualservice.networking.istio.io/reviews created\n$ kubectl get virtualservice\nNAME       GATEWAYS             HOSTS       AGE\nbookinfo   [bookinfo-gateway]   [*]         12m\nreviews                         [reviews]   13s\n</code></pre> <p>\u6211\u4eec\u67e5\u770b\u5f53\u524d\u7f51\u683c\u4e2d\u7684 VirtualService \u5bf9\u8c61\uff0c\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6709 reviews \u4e86\uff0c\u8bc1\u660e\u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u5c06\u5e94\u7528\u4e2d\u6240\u6709\u7684 DestinationRules \u90fd\u5df2\u7ecf\u521b\u5efa\u8fc7\u4e86\uff0c\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u8bbf\u95ee\u5e94\u7528\u5c31\u53ef\u4ee5\u4e86\uff0c\u6211\u4eec\u591a\u6b21\u5237\u65b0\uff0c\u53ef\u4ee5\u53d1\u73b0\u6ca1\u6709\u51fa\u73b0 Ratings \u7684\u6b21\u6570\u4e0e\u51fa\u73b0\u9ed1\u8272\u661f Ratings \u7684\u6bd4\u4f8b\u5927\u6982\u5728<code>4:1</code>\u5de6\u53f3\uff0c\u5e76\u4e14\u6ca1\u6709\u7ea2\u8272\u661f\u7684 Ratings \u7684\u60c5\u51b5\u51fa\u73b0\uff0c\u8bf4\u660e\u6211\u4eec\u914d\u7f6e\u7684\u57fa\u4e8e\u6743\u91cd\u7684 VirtualService \u8bbf\u95ee\u89c4\u5219\u914d\u7f6e\u751f\u6548\u4e86\u3002</p>"},{"location":"kubernetes_service_mesh/traffic/#_4","title":"\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u7684\u670d\u52a1\u8bbf\u95ee\u89c4\u5219","text":"<p>\u9664\u4e86\u4e0a\u9762\u57fa\u4e8e\u670d\u52a1\u7248\u672c\u548c\u670d\u52a1\u6743\u91cd\u7684\u65b9\u5f0f\u63a7\u5236\u670d\u52a1\u8bbf\u95ee\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u57fa\u4e8e\u8bf7\u6c42\u5185\u5bb9\u6765\u8fdb\u884c\u8bbf\u95ee\u63a7\u5236\u3002</p> <p>\u540c\u6837\uff0c\u5c06\u4e0a\u9762\u521b\u5efa\u7684 VirtualService \u5bf9\u8c61\u5220\u9664\uff1a</p> <pre><code>$ kubectl delete virtualservice reviews\nvirtualservice.networking.istio.io \"reviews\" deleted\n$ kubectl get virtualservice\nNAME       GATEWAYS             HOSTS   AGE\nbookinfo   [bookinfo-gateway]   [*]     14m\n</code></pre> <p>\u67e5\u770b\u6587\u4ef6 </p> <pre><code>samples/bookinfo/networking/virtual-service-reviews-jason-v2-vyaml\n</code></pre> <p>\u7684\u5b9a\u4e49\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n  - reviews\n  http:\n  - match:\n    - headers:\n        end-user:\n          exact: jason\n    route:\n    - destination:\n        host: reviews\n        subset: v2\n  - route:\n    - destination:\n        host: reviews\n        subset: v3\n</code></pre> <p>\u8fd9\u4e2a VirtualService \u5bf9\u8c61\u5b9a\u4e49\u4e86\u5bf9 reviews \u670d\u52a1\u8bbf\u95ee\u7684 <code>match</code> \u89c4\u5219\u3002\u610f\u601d\u662f\u5982\u679c\u5f53\u524d\u8bf7\u6c42\u7684 header \u4e2d\u5305\u542b jason \u8fd9\u4e2a\u7528\u6237\u4fe1\u606f\uff0c\u5219\u53ea\u4f1a\u8bbf\u95ee\u5230 v2 \u7684 reviews \u8fd9\u4e2a\u670d\u52a1\u7248\u672c\uff0c\u5373\u90fd\u5e26\u9ed1\u661f\u7684\u6837\u5f0f\uff0c\u5982\u679c\u4e0d\u5305\u542b\u8be5\u7528\u6237\u4fe1\u606f\uff0c\u5219\u90fd\u76f4\u63a5\u5c06\u6d41\u91cf\u8f6c\u53d1\u7ed9 v3 \u8fd9\u4e2a reviews \u7684\u670d\u52a1\u3002</p> <p>\u6211\u4eec\u5148\u4e0d\u542f\u7528\u8fd9\u4e2a VirtualService\uff0c\u5148\u53bb\u8bbf\u95ee\u4e0b Bookinfo \u8fd9\u4e2a\u5e94\u7528\uff1a </p> <p>\u53f3\u4e0a\u89d2\u6709\u767b\u5f55\u6309\u94ae\uff0c\u5728\u6ca1\u6709\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u5237\u65b0\u9875\u9762\uff0creviews \u670d\u52a1\u662f\u88ab\u968f\u673a\u8bbf\u95ee\u7684\uff0c\u53ef\u4ee5\u770b\u5230\u6709\u5e26\u661f\u4e0d\u5e26\u661f\u7684\u6837\u5f0f\uff0c\u70b9\u51fb\u767b\u5f55\uff0c\u5728\u5f39\u7a97\u4e2d User Name \u8f93\u5165 jason\uff0cPassword \u4e3a\u7a7a\uff0c\u767b\u5f55\uff1a</p> <p></p> <p>\u518d\u5237\u65b0\u9875\u9762\uff0c\u53ef\u4ee5\u770b\u5230\u8ddf\u672a\u767b\u5f55\u524d\u7684\u8bbf\u95ee\u89c4\u5219\u4e00\u6837\uff0c\u4e5f\u662f\u968f\u673a\u7684\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e0a\u9762\u7684 VirtualService \u8fd9\u4e2a\u5bf9\u8c61:</p> <pre><code>$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-jason-v2-vyaml\nvirtualservice.networking.istio.io/reviews created\n$ kubectl get virtualservice\nNAME       GATEWAYS             HOSTS       AGE\nbookinfo   [bookinfo-gateway]   [*]         22m\nreviews                         [reviews]   12s\n</code></pre> <p>\u6b64\u65f6\u518d\u56de\u53bb\u5237\u65b0\u9875\u9762\uff0c\u53d1\u73b0\u4e00\u76f4\u90fd\u662f\u9ed1\u661f\u7684 Reviews \u7248\u672c(v2)\u88ab\u8bbf\u95ee\u5230\u4e86\u3002\u6ce8\u9500\u9000\u51fa\u540e\u518d\u8bbf\u95ee\uff0c\u6b64\u65f6\u53c8\u4e00\u76f4\u662f\u7ea2\u661f\u7684\u7248\u672c(v3)\u88ab\u8bbf\u95ee\u4e86\u3002</p> <p>\u8bf4\u660e\u6211\u4eec\u57fa\u4e8e </p> <pre><code>headers-&gt;end-user-&gt;exact:jason\n</code></pre> <p>\u7684\u63a7\u5236\u89c4\u5219\u751f\u6548\u4e86\u3002\u5728 productpage \u670d\u52a1\u8c03\u7528 reviews \u670d\u52a1\u65f6\uff0c\u767b\u5f55\u7684\u60c5\u51b5\u4e0b\u4f1a\u5728 header \u4e2d\u5e26\u4e0a\u7528\u6237\u4fe1\u606f\uff0c\u901a\u8fc7 <code>exact</code> \u89c4\u5219\u5339\u914d\u5230\u76f8\u5173\u4fe1\u606f\u540e\uff0c\u6d41\u91cf\u88ab\u5f15\u5411\u4e86\u4e0a\u9762\u914d\u7f6e\u7684 v2 \u7248\u672c\u4e2d\u3002</p> <p>\u8fd9\u91cc\u8981\u8bf4\u660e\u4e00\u4e0b match \u7684\u5339\u914d\u89c4\u5219\uff1a</p> <pre><code>All conditions inside a single match block have AND semantics, while the list of match blocks have OR semantics. The rule is matched if any one of the match blocks succeed.\n</code></pre> <p>\u610f\u601d\u662f\u4e00\u4e2a <code>match</code> \u5757\u91cc\u7684\u6761\u4ef6\u662f\u9700\u8981\u540c\u65f6\u6ee1\u8db3\u624d\u7b97\u5339\u914d\u6210\u529f\u7684\uff0c\u5982\u4e0b\u9762\u662f url \u524d\u7f00\u548c\u7aef\u53e3\u90fd\u5fc5\u987b\u90fd\u6ee1\u8db3\u624d\u7b97\u6210\u529f\uff1a</p> <pre><code>- match:\n    - uri:\n        prefix: \"/wpcatalog\"\n      port: 443\n</code></pre> <p>\u591a\u4e2a match \u5757\u4e4b\u95f4\u662f\u53ea\u8981\u6709\u4e00\u4e2a match \u5339\u914d\u6210\u529f\u4e86\uff0c\u5c31\u4f1a\u88ab\u8def\u7531\u5230\u5b83\u6307\u5b9a\u7684\u670d\u52a1\u7248\u672c\u53bb\uff0c\u800c\u5ffd\u7565\u5176\u4ed6\u7684\u3002\u6211\u4eec\u7684\u793a\u4f8b\u4e2d\u5728\u767b\u5f55\u7684\u6761\u4ef6\u4e0b\uff0c\u6ee1\u8db3\u7b2c\u4e00\u4e2a match\uff0c\u6240\u4ee5\u670d\u52a1\u4e00\u76f4\u4f1a\u8bbf\u95ee\u5230 v2 \u7248\u672c\u3002\u9000\u51fa\u767b\u5f55\u540e\uff0c\u6ca1\u6709 match \u89c4\u5219\u6ee1\u8db3\u5339\u914d\uff0c\u6240\u4ee5\u5c31\u8d70\u6700\u540e\u4e00\u4e2a route \u89c4\u5219\uff0c\u5373 v3 \u7248\u672c\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u5c31\u548c\u5927\u5bb6\u4e00\u8d77\u5b66\u4e60\u4e86\u57fa\u4e8e\u4e0d\u540c\u670d\u52a1\u7248\u672c\u3001\u6743\u91cd\u4ee5\u53ca\u8bf7\u6c42\u5185\u5bb9\u6765\u63a7\u5236\u670d\u52a1\u6d41\u91cf\u7684\u914d\u7f6e\u3002</p>"},{"location":"kubernetes_service_mesh/traffic/#_5","title":"\u5ef6\u8fdf\u8bbf\u95ee\u6545\u969c\u6ce8\u5165","text":"<p>\u9996\u5148\u79fb\u9664\u4e4b\u524d\u521b\u5efa\u7684 VirtualService:</p> <pre><code>$ kubectl delete virtualservice reviews\nvirtualservice.networking.istio.io \"reviews\" deleted\n$ kubectl get virtualservice\nNAME       GATEWAYS             HOSTS   AGE\nbookinfo   [bookinfo-gateway]   [*]     16d\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u67e5\u770b istio \u6837\u4f8b\u6587\u4ef6\u5939\u4e0b\u9762\u7684\u6587\u4ef6 </p> <pre><code>samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml\n</code></pre> <p>\u5185\u5bb9\uff1a</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: ratings\nspec:\n  hosts:\n  - ratings\n  http:\n  - match:\n    - headers:\n        end-user:\n          exact: jason\n    fault:\n      delay:\n        percentage:\n          value: 10\n        fixedDelay: 7s\n    route:\n    - destination:\n        host: ratings\n        subset: v1\n  - route:\n    - destination:\n        host: ratings\n        subset: v1\n</code></pre> <p>\u8fd9\u4e2a VirtualService \u5b9a\u4e49\u4e86\u4e00\u4e2a\u5728 jason \u767b\u5f55\u7684\u60c5\u51b5\u4e0b\uff0c\u8bbf\u95ee ratings \u670d\u52a1\u7684 100% \u7684 7s \u8bbf\u95ee\u5ef6\u8fdf\u3002\u524d\u9762\u6211\u4eec\u77e5\u9053\uff0cBookinfo \u8fd9\u4e2a\u793a\u4f8b productpage \u670d\u52a1\u8c03\u7528 reviews\uff0creviews \u7684\u4e0d\u540c\u7248\u672c\u4f1a\u5bf9 ratings \u8fdb\u884c\u4e0d\u540c\u7684\u8c03\u7528\uff0c\u5176\u4e2d reviews-v1 \u4e0d\u8c03\u7528 ratings\uff0creviews-v2 \u548c reviews-v3 \u4f1a\u8c03\u7528 ratings\uff0c\u5e76\u505a\u4e0d\u540c\u6837\u5f0f\u7684\u6e32\u67d3\u3002\u5e76\u4e14\u5728 productpage \u8bbf\u95ee reviews \u65f6\uff0c\u4ee3\u7801\u4e2d\u6709\u786c\u7f16\u7801 6s \u4e2d\u7684\u8bbf\u95ee\u8d85\u65f6\u9650\u5236\uff0c\u800c reviews \u8bbf\u95ee ratings \u7f16\u7801\u4e86 10s \u7684\u8bbf\u95ee\u8d85\u65f6\u9650\u5236\u3002</p> <p>\u4e86\u89e3\u8fd9\u4e00\u70b9\u540e\uff0c\u6211\u4eec\u73b0\u5728\u6765\u521b\u5efa\u8fd9\u4e2a VirtualService \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml\nvirtualservice.networking.istio.io/ratings created\n$ kubectl get virtualservice\nNAME       GATEWAYS             HOSTS       AGE\nbookinfo   [bookinfo-gateway]   [*]         16d\nratings                         [ratings]   13s\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u524d\u5f80 Bookinfo \u5e94\u7528\uff0c\u767b\u5f55 jason\uff0c\u6253\u5f00\u6d4f\u89c8\u5668\u7684 Network\uff0c\u5237\u65b0\u9875\u9762\uff0c\u53d1\u73b0\u8bf7\u6c42\u52a0\u8f7d\u5f88\u6162\uff0c\u5927\u7ea6 6s \u540e\uff0c\u51fa\u73b0\u5982\u4e0b\u754c\u9762\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230 Ratings \u670d\u52a1\u51fa\u73b0\u4e86 <code>unavailable</code> \u7684\u63d0\u793a\u4fe1\u606f\uff0c\u8fd9\u662f\u56e0\u4e3a\u6b64\u65f6 reviews \u8bf7\u6c42 ratings \u7684\u8bbf\u95ee\u8d85\u8fc7\u4e86 6s \u8fd8\u6ca1\u6709\u54cd\u5e94\uff0c\u4f7f\u5f97 productpage \u4e2d\u7684\u786c\u7f16\u7801\u7684\u8d85\u65f6\u8bbe\u7f6e\u751f\u6548\u4e86\u3002</p> <p>\u5f53\u7136\u6709\u7684\u65f6\u5019\u6211\u4eec\u4e5f\u80fd\u6210\u529f\u8bbf\u95ee\u5230 reviews-v1 \u7248\u672c\uff0c\u56e0\u4e3a\u6b64\u65f6\u5e76\u6ca1\u6709\u8fdb\u4e00\u6b65\u8bbf\u95ee ratings \u670d\u52a1\uff0c\u6240\u4ee5\u4e00\u5207\u90fd\u662f\u6b63\u5e38\u7684\uff0c\u4f1a\u663e\u793a\u4e0d\u5e26\u661f\u7684\u754c\u9762\uff1a</p> <p></p> <p>\u901a\u8fc7\u8fd9\u79cd\u8d85\u65f6\u6545\u969c\u6ce8\u5165\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u65b9\u4fbf\u5730\u53d1\u73b0\u670d\u52a1\u95f4\u76f8\u4e92\u8bbf\u95ee\u4e2d\u5b58\u5728\u7684\u6f5c\u5728\u95ee\u9898\u3002</p>"},{"location":"kubernetes_service_mesh/traffic/#_6","title":"\u4e2d\u65ad\u8bbf\u95ee\u6545\u969c\u6ce8\u5165","text":"<p>\u9996\u5148\u79fb\u9664\u4e4b\u524d\u521b\u5efa\u7684 VirtualService:</p> <pre><code>$ kubectl delete virtualservice ratings\nvirtualservice.networking.istio.io \"ratings\" deleted\n$ kubectl get virtualservice\nNAME       GATEWAYS             HOSTS   AGE\nbookinfo   [bookinfo-gateway]   [*]     16d\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u67e5\u770b istio \u6837\u4f8b\u6587\u4ef6\u5939\u4e0b\u9762\u7684\u6587\u4ef6 </p> <pre><code>samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml\n</code></pre> <p>\u7684\u5185\u5bb9:</p> <pre><code>apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: ratings\nspec:\n  hosts:\n  - ratings\n  http:\n  - match:\n    - headers:\n        end-user:\n          exact: jason\n    fault:\n      abort:\n        percentage:\n          value: 10\n        httpStatus: 500\n    route:\n    - destination:\n        host: ratings\n        subset: v1\n  - route:\n    - destination:\n        host: ratings\n        subset: v1\n</code></pre> <p>\u901a\u8fc7\u4e0a\u9762\u7684\u8fd9\u4e2a yaml \u6587\u4ef6\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u8fd9\u4e2a VirtualService \u8d44\u6e90\u5bf9\u8c61\u914d\u7f6e\u4e86\u5728 jason \u767b\u5f55\u65f6\uff0creviews \u5bf9 ratings \u8bbf\u95ee\u65f6 100% \u7684\u8fd4\u56de\u4e00\u4e2a500\u9519\u8bef\u54cd\u5e94\u3002</p> <p>\u7136\u540e\u540c\u6837\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml\nvirtualservice.networking.istio.io/ratings created\n$ kubectl get virtualservice\nNAME       GATEWAYS             HOSTS       AGE\nbookinfo   [bookinfo-gateway]   [*]         16d\nratings                         [ratings]   34s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u56de\u5230 BookInfo \u5e94\u7528\uff0c\u767b\u5f55 jason\uff0c\u5237\u65b0\u9875\u9762\uff0c\u6709\u65f6\u5019\u53ef\u4ee5\u5f88\u5feb\u5c31\u770b\u5230 Rating \u670d\u52a1\u4e0d\u53ef\u7528\u7684\u63d0\u793a\u4fe1\u606f\uff1a</p> <p></p>"},{"location":"kubernetes_service_mesh/traffic/#_7","title":"\u670d\u52a1\u7f51\u683c\u5916\u7684\u6d41\u91cf\u7ba1\u7406","text":"<p>\u4e3a\u4e86\u63a7\u5236\u670d\u52a1\u7f51\u683c\u5916\u7684\u670d\u52a1\u7684\u6d41\u91cf\u8bbf\u95ee\uff0c\u5916\u90e8\u7684\u670d\u52a1\u5fc5\u987b\u9996\u5148\u4f7f\u7528\u4e00\u4e2a <code>ServiceEntry</code> \u5bf9\u8c61\u52a0\u5165\u5230 istio \u7684\u5185\u90e8 <code>service registry</code> \u4e2d\uff0c\u670d\u52a1\u7f51\u683c\u624d\u4f1a\u77e5\u9053\u5982\u4f55\u5bfc\u5411\u8fd9\u4e9b\u5916\u90e8\u670d\u52a1\u7684\u6d41\u91cf\u3002</p> <p>\u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e2a\u529f\u80fd\uff0c\u6211\u4eec\u4f7f\u7528 istio \u6837\u4f8b\u4e2d\u7684 sleep \u5e94\u7528\u6765\u9a8c\u8bc1\u6539\u529f\u80fd\uff0c\u67e5\u770b </p> <pre><code>samples/sleep/sleep.yaml\n</code></pre> <p>\u6587\u4ef6\u5185\u5bb9\uff1a</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: sleep\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: sleep\n  labels:\n    app: sleep\nspec:\n  ports:\n  - port: 80\n    name: http\n  selector:\n    app: sleep\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: sleep\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: sleep\n  template:\n    metadata:\n      labels:\n        app: sleep\n    spec:\n      serviceAccountName: sleep\n      containers:\n      - name: sleep\n        image: governmentpaas/curl-ssl\n        command: [\"/bin/sleep\", \"3650d\"]\n        imagePullPolicy: IfNotPresent\n        volumeMounts:\n        - mountPath: /etc/sleep/tls\n          name: secret-volume\n      volumes:\n      - name: secret-volume\n        secret:\n          secretName: sleep-secret\n          optional: true\n---\n</code></pre> <p>\u8fd9\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u5e94\u7528\uff0c\u901a\u8fc7 Deployment \u8fdb\u884c\u63a7\u5236\uff0c\u901a\u8fc7 Service \u66b4\u9732\u670d\u52a1\uff0c\u73b0\u5728\u6211\u4eec\u6765\u90e8\u7f72\u8be5\u5e94\u7528\uff1a</p> <pre><code>$ kubectl apply -f &lt;(istioctl kube-inject -f samples/sleep/sleep.yaml)\nserviceaccount/sleep created\nservice/sleep created\ndeployment.apps/sleep created\n</code></pre> <p>Istio \u6709\u4e00\u4e2a\u5b89\u88c5\u9009\u9879\uff0c</p> <pre><code>global.outboundTrafficPolicy.mode\n</code></pre> <p>\uff0c\u5b83\u914d\u7f6e sidecar \u5bf9\u5916\u90e8\u670d\u52a1\uff08\u90a3\u4e9b\u6ca1\u6709\u5728 Istio \u7684\u5185\u90e8\u670d\u52a1\u6ce8\u518c\u4e2d\u5b9a\u4e49\u7684\u670d\u52a1\uff09\u7684\u5904\u7406\u65b9\u5f0f\u3002\u5982\u679c\u8fd9\u4e2a\u9009\u9879\u8bbe\u7f6e\u4e3a <code>ALLOW_ANY</code>\uff0cIstio \u4ee3\u7406\u5141\u8bb8\u8c03\u7528\u672a\u77e5\u7684\u670d\u52a1\u3002\u5982\u679c\u8fd9\u4e2a\u9009\u9879\u8bbe\u7f6e\u4e3a <code>REGISTRY_ONLY</code>\uff0c\u90a3\u4e48 Istio \u4ee3\u7406\u4f1a\u963b\u6b62\u4efb\u4f55\u6ca1\u6709\u5728\u7f51\u683c\u4e2d\u5b9a\u4e49\u7684 HTTP \u670d\u52a1\u6216 <code>service entry</code> \u7684\u4e3b\u673a\u3002<code>ALLOW_ANY</code> \u662f\u9ed8\u8ba4\u503c\uff0c\u4e0d\u63a7\u5236\u5bf9\u5916\u90e8\u670d\u52a1\u7684\u8bbf\u95ee\u3002\u4f46\u662f\u8fd9\u79cd\u65b9\u5f0f\u6709\u4e00\u4e2a\u7f3a\u70b9\uff0c\u5373\u4e22\u5931\u4e86\u5bf9\u5916\u90e8\u670d\u52a1\u6d41\u91cf\u7684 Istio \u76d1\u63a7\u548c\u63a7\u5236\uff0c\u6bd4\u5982\uff0c\u5916\u90e8\u670d\u52a1\u7684\u8c03\u7528\u6ca1\u6709\u8bb0\u5f55\u5230 Mixer \u7684\u65e5\u5fd7\u4e2d\u3002</p> <p>\u8fd9\u91cc\u4e3a\u4e86\u6d4b\u8bd5 ServiceEntry \u529f\u80fd\uff0c\u6211\u4eec\u5c06\u5176\u66f4\u6539\u4e3a <code>REGISTRY_ONLY</code> \u6a21\u5f0f\uff1a</p> <pre><code>$ kubectl edit configmap istio -n istio-system \n.......\napiVersion: v1\ndata:\n  mesh: |-\n    accessLogEncoding: TEXT\n    accessLogFile: /dev/stdout\n    accessLogFormat: \"\"\n    outboundTrafficPolicy:  # \u4fee\u6539\u4e3aREGISTRY_ONLY\u6a21\u5f0f\n      mode: REGISTRY_ONLY\n    defaultConfig:\n      concurrency: 2\n      configPath: ./etc/istio/proxy\n      connectTimeout: 10s\n......\n</code></pre> <p>ConfigMap \u4fee\u6539\u5b8c\u6210\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u63a5\u7ba1\u5916\u90e8 URL \u7684\u6d41\u91cf\u4e86\u3002\u73b0\u5728\u6211\u4eec\u8fdb\u5165\u4e0a\u9762\u521b\u5efa\u7684 sleep \u5e94\u7528\u5bb9\u5668\u5185\u90e8\u6267\u884c\u4e00\u4e9b\u6d4b\u8bd5\u64cd\u4f5c\uff1a</p> <pre><code>$ export SLEEP_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name})\n$ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - http://edition.cnn.com/politics\nHTTP/1 502 Bad Gateway\ndate: Sun, 28 Jun 2020 08:46:26 GMT\nserver: envoy\ncontent-length: 0\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u4f1a\u8fd4\u56de 502 \u4fe1\u606f\uff0c\u56e0\u4e3a\u8be5\u57df\u540d\u4e0d\u5728\u5f53\u524d\u7684\u670d\u52a1\u7f51\u683c\u4e2d\uff0c\u56e0\u4e3a\u73b0\u5728\u6211\u4eec\u4e0d\u5141\u8bb8\u8bbf\u95ee\u670d\u52a1\u7f51\u683c\u5916\u90e8\u7684 URL\uff0c\u670d\u52a1\u7f51\u683c\u4e2d\u5bf9\u672a\u77e5\u7684\u670d\u52a1\u8bf7\u6c42\u4f1a\u4e22\u5f03\u3002\u8fd9\u5c31\u9700\u8981\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a <code>ServiceEntry</code> \u5bf9\u8c61\uff0c\u5c06\u5916\u90e8\u7684\u8bbf\u95ee\u670d\u52a1\u5f15\u5165\u5230\u670d\u52a1\u7f51\u683c\u4e2d\u6765\u3002</p> <p>\u4f8b\u5982\u4e0b\u9762\u7684\u89c4\u5219\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8bbf\u95ee <code>edition.cnn.com</code> \u7684\u670d\u52a1\u7684 <code>ServiceEntry</code>:</p> <pre><code># cnn-service-entry.yaml\napiVersion: networking.istio.io/v1alpha3\nkind: ServiceEntry\nmetadata:\n  name: cnn\nspec:\n  hosts:\n  - edition.cnn.com\n  ports:\n  - number: 80\n    name: http-port\n    protocol: HTTP\n  - number: 443\n    name: https\n    protocol: HTTPS\n  resolution: DNS\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6765\u90e8\u7f72\u4e0a\u9762\u7684 ServiceEntry \u8d44\u6e90\uff1a</p> <pre><code>$ kubectl apply -f cnn-service-entry.yaml\nserviceentry.networking.istio.io/cnn created\n$ kubectl get serviceentry\nNAME   HOSTS               LOCATION   RESOLUTION   AGE\ncnn    [edition.cnn.com]              DNS          27s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u518d\u53bb\u4e0a\u9762\u7684 sleep \u5bb9\u5668\u4e2d\u6267\u884c\u4e0a\u9762\u7684\u6d4b\u8bd5\u8bf7\u6c42\uff1a</p> <pre><code>$ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - http://edition.cnn.com/politics\nHTTP/1 301 Moved Permanently\nserver: envoy\nretry-after: 0\ncontent-length: 0\ncache-control: public, max-age=600\nlocation: https://edition.cnn.com/politics\n......\n\nHTTP/2 200\n......\nvary: x-fastab-0, Accept-Encoding\ncontent-length: 1291663\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53d1\u73b0\u53ef\u4ee5\u6b63\u5e38\u8fd4\u56de\u5185\u5bb9\u4e86\uff0c\u8fd4\u56de200\uff0c\u8bc1\u660e\u8bf7\u6c42\u6210\u529f\u4e86\u3002</p> <p>\u8bf4\u660e</p> <p><code>-L</code> \u53c2\u6570\u8ba9 curl \u8ddf\u968f\u8fde\u63a5\u8fdb\u884c\u91cd\u5b9a\u5411\u3002\u8fd9\u91cc\u670d\u52a1\u5668\u76f4\u63a5\u8fd4\u56de\u7684 301 \u91cd\u5b9a\u5411\u54cd\u5e94\uff0c\u8981\u6c42\u5ba2\u6237\u7aef\u518d\u4f7f\u7528 HTTPS \u7684\u65b9\u5f0f\u5bf9 </p> <pre><code>https://edition.cnn.com/politics\n</code></pre> <p>\u5730\u5740\u8fdb\u884c\u8bbf\u95ee\uff0c\u7b2c\u4e8c\u6b21\u8bbf\u95ee\u624d\u8fd4\u56de\u4e86200\u7684\u6210\u529f\u7801\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u8fdb\u4e00\u6b65\u914d\u7f6e<code>egress gateway</code>\uff0c\u4f7f\u8fd9\u4e9b\u5bf9\u5916\u90e8\u7684\u6d41\u91cf\u8bbf\u95ee\u7ecf\u7531 <code>egress</code> \u53bb\u5230\u5916\u90e8\u3002</p> <p>\u73b0\u5728\u4e3a <code>edition.cnn.com</code> \u7aef\u53e3 80 \u521b\u5efa <code>egress Gateway</code>\u3002\u5e76\u4e3a\u6307\u5411 <code>egress gateway</code> \u7684\u6d41\u91cf\u521b\u5efa\u4e00\u4e2a <code>destination rule</code>:</p> <pre><code># cnn-egress-gateway.yaml\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: istio-egressgateway\nspec:\n  selector:\n    istio: egressgateway\n  servers:\n  - port:\n      number: 80\n      name: http\n      protocol: HTTP\n    hosts:\n    - edition.cnn.com\n---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: egressgateway-for-cnn\nspec:\n  host: istio-egressgateway.istio-system.svc.cluster.local\n  subsets:\n  - name: cnn\n</code></pre> <p>\u9664\u4e86\u4e0a\u9762\u7684 <code>engress gateway</code> \u5bf9\u8c61\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u521b\u5efa VirtualService \u8d44\u6e90\u5bf9\u8c61\uff0c\u5c06\u6d41\u91cf\u4ece sidecar \u5f15\u5bfc\u81f3 egress gateway\uff0c\u518d\u4ece egress gateway \u5f15\u5bfc\u81f3\u5916\u90e8\u670d\u52a1\uff1a</p> <pre><code># cnn-virtual.yaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: direct-cnn-through-egress-gateway\nspec:\n  hosts:\n  - edition.cnn.com\n  gateways:\n  - istio-egressgateway\n  - mesh  # mesh \u8868\u793a\u7f51\u683c\u4e2d\u7684\u6240\u6709 Sidecar\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a gateways\uff0c\u5219\u9ed8\u8ba4\u4e3a mesh\n  http:\n  - match:\n    - gateways:\n      - mesh\n      port: 80\n    route:\n    - destination:  # \u5c06\u670d\u52a1\u8def\u7531\u5230\u4ec0\u4e48\u5730\u65b9\u53bb\n        host: istio-egressgateway.istio-system.svc.cluster.local\n        subset: cnn  # subset \u914d\u7f6e\u6d41\u91cf\u76ee\u7684\u5730\u7684\u5b50\u96c6\n        port:\n          number: 80\n      weight: 100\n  - match:\n    - gateways:\n      - istio-egressgateway\n      port: 80\n    route:\n    - destination:\n        host: edition.cnn.com\n        port:\n          number: 80\n      weight: 100\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e0a\u97623\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f cnn-virtual.yaml\nvirtualservice.networking.istio.io/direct-cnn-through-egress-gateway created\n$ kubectl apply -f cnn-egress-gateway.yaml\ngateway.networking.istio.io/istio-egressgateway created\ndestinationrule.networking.istio.io/egressgateway-for-cnn created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u73b0\u5728\u6211\u4eec\u518d\u53bb sleep \u5bb9\u5668\u6267\u884c\u4e0b\u4e0a\u9762\u7684\u8bf7\u6c42\uff1a</p> <pre><code>$ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - http://edition.cnn.com/politics\nHTTP/1 301 Moved Permanently\nserver: envoy\nretry-after: 0\ncontent-length: 0\ncache-control: public, max-age=600\nlocation: https://edition.cnn.com/politics\n......\n\nHTTP/2 200\n......\nvary: x-fastab-0, Accept-Encoding\ncontent-length: 1291663\n</code></pre> <p>\u6b63\u5e38\u8f93\u51fa\u7ed3\u679c\u548c\u4e0a\u9762\u4e00\u6b21\u8bbf\u95ee\u662f\u4e00\u6837\u7684\u3002\u8fd9\u65f6\u6211\u4eec\u53bb\u67e5\u770b egressgateway \u7684 Pod \u4e2d\u7684\u5bb9\u5668\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs $(kubectl get pod -l istio=egressgateway -n istio-system -o jsonpath='{.items[0].metadata.name}') -n istio-system | tail\n......\n[2018-10-15T17:33:261Z] \"GET /politics HTTP/2\" 301 - 0 0 437 429 \"2206\" \"curl/0\" \"6d4f2ac3-0957-97a5-961a-241c7fd72536\" \"edition.cnn.com\" \"11167:80\"\n......\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u6761\u4e0a\u9762\u7684 <code>GET /politics</code> \u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u8bf4\u660e\u8bbf\u95ee\u7ecf\u8fc7\u4e86 egress gateway \u51fa\u53bb\u4e86\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u53ea\u5b9a\u4e49\u4e86 egress gateway \u7684 80 \u7aef\u53e3\u6d41\u91cf\uff0c\u5982\u679c\u6211\u4eec\u901a\u8fc7\u8bbf\u95ee HTTPS \u5219\u4f1a\u76f4\u63a5\u8df3\u8f6c\u5230 <code>edition.cnn.com</code>\u3002</p>"},{"location":"kubernetes_service_mesh/traffic/#egress_gateway_https","title":"\u7528 Egress Gateway \u5904\u7406 HTTPS \u8bf7\u6c42","text":"<p>\u63a5\u4e0b\u6765\u5c1d\u8bd5\u4f7f\u7528 Egress Gateway \u53d1\u8d77 HTTPS \u8bf7\u6c42\u3002\u6211\u4eec\u9700\u8981\u5728\u76f8\u5e94\u7684 ServiceEntry\u3001Egress Gateway \u548c VirtualService \u4e2d\u6307\u5b9a TLS \u534f\u8bae\u7684\u7aef\u53e3 443\u3002</p> <p>\u9996\u5148\u5148\u6e05\u7406\u524d\u9762\u5b9a\u4e49\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl delete gateway istio-egressgateway\n$ kubectl delete serviceentry cnn\n$ kubectl delete virtualservice direct-cnn-through-egress-gateway\n$ kubectl delete destinationrule egressgateway-for-cnn\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u6211\u4eec\u53bb\u8bbf\u95ee https \u7684\u5730\u5740\u662f\u4e0d\u88ab\u5141\u8bb8\u7684\uff1a</p> <pre><code>$ export SLEEP_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name})\n$ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - https://edition.cnn.com/politics\ncommand terminated with exit code 35\n</code></pre> <p>\u56e0\u4e3a\u8fd8\u6ca1\u6709\u5b9a\u4e49 ServiceEntry \u5bf9\u8c61\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u9700\u8981\u521b\u5efa\u4e00\u4e2a HTTPS \u7248\u672c\u7684 ServiceEntry \u5bf9\u8c61\uff1a</p> <pre><code># cnn-https-service-entry.yaml\napiVersion: networking.istio.io/v1alpha3\nkind: ServiceEntry\nmetadata:\n  name: cnn\nspec:\n  hosts:\n  - edition.cnn.com\n  ports:\n  - number: 443\n    name: tls\n    protocol: TLS\n  resolution: DNS\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f cnn-https-service-entry.yaml\nserviceentry.networking.istio.io/cnn created\n$ kubectl get serviceentry\nNAME        HOSTS               LOCATION   RESOLUTION   AGE\ncnn   [edition.cnn.com]              DNS          37s\n</code></pre> <p>\u7136\u540e\u540c\u6837\u4f7f\u7528\u4e0a\u9762\u521b\u5efa\u7684 sleep \u5bb9\u5668\u6765\u6d4b\u8bd5\u8bbf\u95ee https \u5730\u5740\uff1a</p> <pre><code>$ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - https://edition.cnn.com/politics\nHTTP/2 200\n......\ncontent-length: 1291663\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u76f4\u63a5\u8bbf\u95ee https \u5730\u5740\u53ef\u4ee5\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c\u4e86\u3002\u7136\u540e\u540c\u6837\u4e3a <code>edition.cnn.com</code> \u521b\u5efa\u4e00\u4e2a egress Gateway\u3002\u9664\u6b64\u4e4b\u5916\u8fd8\u9700\u8981\u521b\u5efa\u4e00\u4e2a destination rule \u548c\u4e00\u4e2a virtual service\uff0c\u7528\u6765\u5f15\u5bfc\u6d41\u91cf\u901a\u8fc7 egress gateway\uff0c\u5e76\u901a\u8fc7 egress gateway \u4e0e\u5916\u90e8\u670d\u52a1\u901a\u4fe1\u3002</p> <pre><code># cnn-https-service-rule.yaml\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: istio-egressgateway\nspec:\n  selector:\n    istio: egressgateway\n  servers:\n  - port:\n      number: 443\n      name: tls\n      protocol: TLS\n    hosts:\n    - edition.cnn.com\n    tls:  # PASSTHROUGH \u8868\u793a gateway \u6309\u539f\u6837\u901a\u8fc7\u5165\u53e3\u6d41\u91cf\uff0c\u800c\u4e0d\u7ec8\u6b62 TLS\n      mode: PASSTHROUGH\n---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: egressgateway-for-cnn\nspec:\n  host: istio-egressgateway.istio-system.svc.cluster.local\n  subsets:\n  - name: cnn\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: direct-cnn-through-egress-gateway\nspec:\n  hosts:\n  - edition.cnn.com\n  gateways:\n  - mesh \n  - istio-egressgateway\n  tls:\n  - match:\n    - gateways:\n      - mesh\n      port: 443\n      sniHosts:\n      - edition.cnn.com\n    route:\n    - destination:\n        host: istio-egressgateway.istio-system.svc.cluster.local\n        subset: cnn\n        port:\n          number: 443\n  - match:\n    - gateways:\n      - istio-egressgateway\n      port: 443\n      sniHosts:\n      - edition.cnn.com\n    route:\n    - destination:\n        host: edition.cnn.com\n        port:\n          number: 443\n      weight: 100\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u76843\u4e2a\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f cnn-https-service-rule.yaml\ngateway.networking.istio.io/istio-egressgateway created\ndestinationrule.networking.istio.io/egressgateway-for-cnn created\nvirtualservice.networking.istio.io/direct-cnn-through-egress-gateway created\n</code></pre> <p>\u73b0\u5728\u518d\u4f7f\u7528\u4e0a\u9762\u521b\u5efa\u7684 sleep \u5bb9\u5668\u6765\u6d4b\u8bd5\u8bbf\u95ee https \u5730\u5740\uff1a</p> <pre><code>$ kubectl exec -it $SLEEP_POD -c sleep -- curl -sL -o /dev/null -D - https://edition.cnn.com/politics\nHTTP/2 200\n......\ncontent-length: 1291663\n</code></pre> <p>\u6b63\u5e38\u548c\u4e0a\u9762\u8fd4\u56de\u7684\u5185\u5bb9\u662f\u4e00\u6837\u7684\uff0c\u4f46\u662f\u8fd9\u4e2a\u65f6\u5019\u8fd9\u65f6\u6211\u4eec\u53bb\u67e5\u770b egressgateway \u7684 Pod \u4e2d\u7684\u5bb9\u5668\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs $(kubectl get pod -l istio=egressgateway -n istio-system -o jsonpath='{.items[0].metadata.name}') -n istio-system | tail\n......\n[2020-06-28T11:12:064Z] \"- - -\" 0 - \"-\" \"-\" 875 758858 76501 - \"-\" \"-\" \"-\" \"-\" \"1167:443\" outbound|443||edition.cnn.com 2175:50194 2175:8443 287:56520 edition.cnn.com -\n</code></pre> <p>\u5c31\u53ef\u4ee5\u770b\u5230 </p> <pre><code>https://edition.cnn.com\n</code></pre> <p>\u7684\u8bf7\u6c42\u65e5\u5fd7\u4e86\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\uff0cIstio \u4e2d\u5b9a\u4e49\u7684 Egress Gateway \u672c\u8eab\u5e76\u6ca1\u6709\u4e3a\u5176\u6240\u5728\u7684\u8282\u70b9\u63d0\u4f9b\u4efb\u4f55\u7279\u6b8a\u5904\u7406\u3002\u96c6\u7fa4\u7ba1\u7406\u5458\u6216\u4e91\u63d0\u4f9b\u5546\u53ef\u4ee5\u5728\u4e13\u7528\u8282\u70b9\u4e0a\u90e8\u7f72 Egress gateway\uff0c\u5e76\u5f15\u5165\u989d\u5916\u7684\u5b89\u5168\u63aa\u65bd\uff0c\u4ece\u800c\u4f7f\u8fd9\u4e9b\u8282\u70b9\u6bd4\u7f51\u683c\u4e2d\u7684\u5176\u4ed6\u8282\u70b9\u66f4\u5b89\u5168\u3002</p> <p>\u7531\u4e8e Istio \u65e0\u6cd5\u5f3a\u5236\u8ba9\u6240\u6709\u51fa\u7ad9\u6d41\u91cf\u90fd\u7ecf\u8fc7 egress gateway\uff0cIstio \u53ea\u662f\u901a\u8fc7 <code>sidecar</code> \u4ee3\u7406\u5b9e\u73b0\u4e86\u8fd9\u79cd\u6d41\u5411\u3002\u653b\u51fb\u8005\u53ea\u8981\u7ed5\u8fc7 sidecar \u4ee3\u7406\uff0c\u5c31\u53ef\u4ee5\u4e0d\u7ecf egress gateway \u76f4\u63a5\u4e0e\u7f51\u683c\u5916\u7684\u670d\u52a1\u8fdb\u884c\u901a\u4fe1\uff0c\u4ece\u800c\u907f\u5f00\u4e86 Istio \u7684\u63a7\u5236\u548c\u76d1\u63a7\u3002\u51fa\u4e8e\u5b89\u5168\u8003\u8651\uff0c\u96c6\u7fa4\u7ba1\u7406\u5458\u548c\u4e91\u4f9b\u5e94\u5546\u5fc5\u987b\u786e\u4fdd\u7f51\u683c\u6240\u6709\u7684\u51fa\u7ad9\u6d41\u91cf\u90fd\u8981\u7ecf\u8fc7 egress gateway\u3002\u8fd9\u9700\u8981\u901a\u8fc7 Istio \u4e4b\u5916\u7684\u673a\u5236\u6765\u6ee1\u8db3\u8fd9\u4e00\u8981\u6c42\u3002\u4f8b\u5982\uff0c\u96c6\u7fa4\u7ba1\u7406\u5458\u53ef\u4ee5\u914d\u7f6e\u9632\u706b\u5899\uff0c\u62d2\u7edd egress gateway \u4ee5\u5916\u7684\u6240\u6709\u6d41\u91cf\u3002Kubernetes <code>\u7f51\u7edc\u7b56\u7565</code>\u4e5f\u80fd\u7981\u6b62\u6240\u6709\u4e0d\u662f\u4ece egress gateway \u53d1\u8d77\u7684\u51fa\u7ad9\u6d41\u91cf\u3002\u6b64\u5916\uff0c\u96c6\u7fa4\u7ba1\u7406\u5458\u548c\u4e91\u4f9b\u5e94\u5546\u8fd8\u53ef\u4ee5\u5bf9\u7f51\u7edc\u8fdb\u884c\u9650\u5236\uff0c\u8ba9\u8fd0\u884c\u5e94\u7528\u7684\u8282\u70b9\u53ea\u80fd\u901a\u8fc7 gateway \u6765\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u3002\u8981\u5b9e\u73b0\u8fd9\u4e00\u9650\u5236\uff0c\u53ef\u4ee5\u53ea\u7ed9 gateway Pod \u5206\u914d\u516c\u7f51 IP\uff0c\u5e76\u4e14\u53ef\u4ee5\u914d\u7f6e NAT \u8bbe\u5907\uff0c\u4e22\u5f03\u6765\u81ea egress gateway pod \u4e4b\u5916\u7684\u6240\u6709\u6d41\u91cf\u3002</p>"},{"location":"kubernetes_service_mesh/traffic/#tcp","title":"TCP \u6d41\u91cf\u8f6c\u79fb","text":"<p>\u4e0a\u9762\u5c55\u793a\u4e86\u591a\u79cd\u6d41\u91cf\u7ba1\u7406\u7684\u65b9\u5f0f\uff0c\u8be5\u90e8\u5206\u4e3b\u8981\u8bb2\u89e3\u5728 Istio \u4e2d\u5982\u4f55\u5c06 TCP \u6d41\u91cf\u4ece\u4e00\u4e2a\u7248\u672c\u8fc1\u79fb\u5230\u53e6\u4e00\u4e2a\u7248\u672c\u3002\u5728 Istio \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u89c4\u5219\u6765\u5b9e\u73b0\u8be5\u529f\u80fd\uff0c\u53ef\u4ee5\u6309\u6307\u5b9a\u7684\u767e\u5206\u6bd4\u5c06\u6d41\u91cf\u8def\u7531\u5230\u4e0d\u540c\u7684\u670d\u52a1\u3002\u548c\u524d\u9762\u6211\u4eec\u4f7f\u7528\u7684 HTTP \u670d\u52a1\u975e\u5e38\u7c7b\u4f3c\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u5148\u5c06\u6240\u6709\u7684 TCP \u8bf7\u6c42\u8def\u7531\u5230 <code>tcp-echo:v1</code> \u8fd9\u4e2a\u670d\u52a1\uff0c\u7136\u540e\u5728\u901a\u8fc7\u914d\u7f6e Istio \u7684\u8def\u7531\u6743\u91cd\u628a 20% \u7684\u6d41\u91cf\u5206\u914d\u5230 <code>tcp-echo:v2</code> \u8fd9\u4e2a\u7248\u672c\u7684\u670d\u52a1\u4e0a\u3002</p> <p>\u9996\u5148\uff0c\u90e8\u7f72\u5fae\u670d\u52a1 tcp-echo \u7684 v1 \u7248\u672c\uff0c\u540c\u6837\u76f4\u63a5\u4f7f\u7528\u793a\u4f8b </p> <pre><code>samples/tcp-echo/tcp-echo-services.yaml\n</code></pre> <p>\uff1a</p> <pre><code># samples/tcp-echo/tcp-echo-services.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: tcp-echo\n  labels:\n    app: tcp-echo\nspec:\n  ports:\n  - name: tcp\n    port: 9000\n  - name: tcp-other\n    port: 9001\n  # Port 9002 is omitted intentionally for testing the pass through filter chain.\n  selector:\n    app: tcp-echo\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: tcp-echo-v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: tcp-echo\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: tcp-echo\n        version: v1\n    spec:\n      containers:\n      - name: tcp-echo\n        image: docker.io/istio/tcp-echo-server:2\n        imagePullPolicy: IfNotPresent\n        args: [ \"9000,9001,9002\", \"one\" ]\n        ports:\n        - containerPort: 9000\n        - containerPort: 9001\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: tcp-echo-v2\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: tcp-echo\n      version: v2\n  template:\n    metadata:\n      labels:\n        app: tcp-echo\n        version: v2\n    spec:\n      containers:\n      - name: tcp-echo\n        image: docker.io/istio/tcp-echo-server:2\n        imagePullPolicy: IfNotPresent\n        args: [ \"9000,9001,9002\", \"two\" ]\n        ports:\n        - containerPort: 9000\n        - containerPort: 9001\n</code></pre> <p>\u4e0a\u9762\u90e8\u7f72\u4e86\u4e24\u4e2a\u7248\u672c\u7684 tcp-echo \u670d\u52a1\uff0c\u8981\u6ce8\u610f\u7684\u662f Service \u5bf9\u8c61\u4e2d\u7684 Label Selector \u662f <code>app=tcp-echo</code>\uff0c\u8fd9\u6837\u8be5\u5bf9\u8c61\u5c31\u4f1a\u5339\u914d\u5230\u4e0a\u9762\u7684\u4e24\u4e2a\u7248\u672c\u7684\u5bf9\u8c61\u3002\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u5b89\u88c5\uff1a</p> <pre><code>$ kubectl apply -f &lt;(istioctl kube-inject -f samples/tcp-echo/tcp-echo-services.yaml) service/tcp-echo created\ndeployment.apps/tcp-echo-v1 created\ndeployment.apps/tcp-echo-v2 created\n$ kubectl get pods -l app=tcp-echo\nNAME                          READY   STATUS    RESTARTS   AGE\ntcp-echo-v1-fcfbd5dd5-p9tlw   2/2     Running   0          3m41s\ntcp-echo-v2-6c6d456db-mtdxp   2/2     Running   0          3m41s\n</code></pre> <p><code>istioctl kube-inject</code> \u547d\u4ee4\u7528\u4e8e\u5728\u521b\u5efa Deployments \u4e4b\u524d\u6ce8\u5165 Istio \u7684 Sidecar \u5bb9\u5668\uff0c\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5c06\u5f53\u524d\u7684\u547d\u540d\u7a7a\u95f4\u6253\u4e0a\u4e00\u4e2a </p> <pre><code>istio-injection=enabled\n</code></pre> <p>\u7684 Label \u6807\u7b7e\uff0c\u8fd9\u6837\u8be5\u547d\u540d\u7a7a\u95f4\u5c31\u5f00\u542f\u4e86 Sidecar \u5bb9\u5668\u81ea\u52a8\u6ce8\u5165\u529f\u80fd\u3002</p> <p>\u63a5\u4e0b\u6765, \u5c06\u5fae\u670d\u52a1 <code>tcp-echo</code> \u7684 TCP \u6d41\u91cf\u5168\u90e8\u8def\u7531\u5230 v1 \u7248\u672c\u4e0a\uff0c\u76f4\u63a5\u4f7f\u7528 </p> <pre><code>samples/tcp-echo/tcp-echo-all-vyaml\n</code></pre> <p>\u8fd9\u4e2a\u793a\u4f8b\u6587\u4ef6\u4e2d\u7684\u5bf9\u8c61\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># samples/tcp-echo/tcp-echo-all-vyaml\napiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: tcp-echo-gateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n  - port:\n      number: 31400\n      name: tcp\n      protocol: TCP\n    hosts:\n    - \"*\"\n---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: tcp-echo-destination\nspec:\n  host: tcp-echo\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n  - name: v2\n    labels:\n      version: v2\n---\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: tcp-echo\nspec:\n  hosts:\n  - \"*\"\n  gateways:\n  - tcp-echo-gateway\n  tcp:\n  - match:\n    - port: 31400\n    route:\n    - destination:\n        host: tcp-echo\n        port:\n          number: 9000\n        subset: v1\n</code></pre> <p>\u8fd9\u91cc\u521b\u5efa\u4e86\u4e00\u4e2a <code>Gateway</code> \u5bf9\u8c61\uff0c\u7528\u6765\u8def\u7531 TCP \u7684\u8bf7\u6c42\uff0c\u8981\u6ce8\u610f\u8fd9\u91cc\u5339\u914d\u7684\u662f <code>istio=ingressgateway</code> \u8fd9\u4e2a Service \u5bf9\u8c61\u7684 <code>31400</code> \u8fd9\u4e2a TCP \u7aef\u53e3\uff1a</p> <pre><code>$ kubectl get svc -n istio-system -l istio=ingressgateway -o yaml\n......\n- name: tcp\n  nodePort: 31871\n  port: 31400\n  protocol: TCP\n  targetPort: 31400\n......\n</code></pre> <p>\u7136\u540e\u5728 <code>DestinationRule</code> \u5bf9\u8c61\u4e2d\u58f0\u660e\u4e86 <code>v1</code> \u548c <code>v2</code> \u4e24\u4e2a\u5b50\u96c6\u670d\u52a1\uff0c\u5728 <code>VirtualService</code> \u5bf9\u8c61\u4e2d\u58f0\u660e\u5177\u4f53\u7684\u8def\u7531\u89c4\u5219\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u662f\u76f4\u63a5\u5168\u90fd\u8def\u7531\u5230\u4e86 <code>v1</code> \u8fd9\u4e2a\u5b50\u96c6\u4e2d\u53bb\uff0c\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f samples/tcp-echo/tcp-echo-all-vyaml\ngateway.networking.istio.io/tcp-echo-gateway created\ndestinationrule.networking.istio.io/tcp-echo-destination created\nvirtualservice.networking.istio.io/tcp-echo created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 istio-ingressgateway \u53bb\u8bbf\u95ee\u4e0a\u9762\u7684 TCP \u670d\u52a1\u4e86\uff0c\u8981\u5728\u5916\u90e8\u8bbf\u95ee\u8be5\u670d\u52a1\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>istio-ingressgateway</code> \u7684 NodePort \u6765\u8bbf\u95ee\uff0c\u8fd9\u91cc\u7684 TCP \u5bf9\u5e94\u7684 nodePort \u7aef\u53e3\u662f 31871\uff0c\u8fd9\u91cc\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u6765\u6d4b\u8bd5\uff1a</p> <pre><code>$ export INGRESS_PORT=31871  # TCP \u670d\u52a1\u7684 nodePort \u7aef\u53e3\n$ export INGRESS_HOST=k8s.qikqiak.com  # \u4efb\u610f\u4e00\u4e2a\u8282\u70b9\u7684 IP\n</code></pre> <p>\u7136\u540e\u5411\u5fae\u670d\u52a1 tcp-echo \u53d1\u9001\u4e00\u4e9b TCP \u8bf7\u6c42\uff1a</p> <pre><code>$ for i in {.10}; do \\\\\n&gt; docker run -e INGRESS_HOST=$INGRESS_HOST -e INGRESS_PORT=$INGRESS_PORT -it --rm busybox sh -c \"(date; sleep 1) | nc $INGRESS_HOST $INGRESS_PORT\"; \\\\\n&gt; done\none Thu Jul  2 07:20:20 UTC 2020\none Thu Jul  2 07:20:24 UTC 2020\none Thu Jul  2 07:20:27 UTC 2020\none Thu Jul  2 07:20:31 UTC 2020\none Thu Jul  2 07:20:34 UTC 2020\none Thu Jul  2 07:20:37 UTC 2020\none Thu Jul  2 07:20:41 UTC 2020\none Thu Jul  2 07:20:44 UTC 2020\none Thu Jul  2 07:20:47 UTC 2020\none Thu Jul  2 07:20:50 UTC 2020\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u65e5\u5fd7\u53ef\u4ee5\u770b\u51fa\uff0c\u6240\u6709\u65f6\u95f4\u6233\u7684\u524d\u7f00\u90fd\u662f <code>one</code>\uff0c\u8fd9\u610f\u5473\u7740\u6240\u6709\u6d41\u91cf\u90fd\u88ab\u8def\u7531\u5230\u4e86 <code>tcp-echo</code> \u670d\u52a1\u7684 <code>v1</code> \u7248\u672c\u4e2d\u3002</p> <p>\u7136\u540e\u4f7f\u7528\u65b0\u7684\u8def\u7531\u89c4\u5219\u5c06 20% \u7684\u6d41\u91cf\u4ece tcp-echo:v1 \u8f6c\u79fb\u5230 tcp-echo:v2\uff0c\u5bf9\u5e94\u7684\u793a\u4f8b\u6587\u4ef6\u4e3a </p> <pre><code>samples/tcp-echo/tcp-echo-20-vyaml\n</code></pre> <p>\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># samples/tcp-echo/tcp-echo-20-vyaml\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: tcp-echo\nspec:\n  hosts:\n  - \"*\"\n  gateways:\n  - tcp-echo-gateway\n  tcp:\n  - match:\n    - port: 31400\n    route:\n    - destination:\n        host: tcp-echo\n        port:\n          number: 9000\n        subset: v1\n      weight: 80\n    - destination:\n        host: tcp-echo\n        port:\n          number: 9000\n        subset: v2\n      weight: 20\n</code></pre> <p>\u4e0a\u9762\u7684 <code>VirtualService</code> \u5bf9\u8c61\u4e5f\u5f88\u7b80\u5355\uff0c\u7ed9 <code>v1</code> \u5b50\u96c6\u670d\u52a1\u52a0\u4e86 80% \u7684\u6743\u91cd\uff0c\u53e6\u5916\u6709 20% \u7684\u6743\u91cd\u88ab\u8def\u7531\u5230\u4e86 <code>v2</code> \u8fd9\u4e2a\u5b50\u96c6\u670d\u52a1\u4e2d\u53bb\u4e86\uff0c\u540c\u6837\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u66f4\u65b0\u8def\u7531\u89c4\u5219\uff1a</p> <pre><code>$ kubectl apply -f samples/tcp-echo/tcp-echo-20-vyaml\nvirtualservice.networking.istio.io/tcp-echo configured\n</code></pre> <p>\u7b49\u5f85\u51e0\u79d2\u949f\uff0c\u8ba9\u65b0\u7684\u8def\u7531\u89c4\u5219\u751f\u6548\u3002\u7136\u540e\u540c\u6837\u7528\u4e0a\u9762\u7684\u6d4b\u8bd5\u547d\u4ee4\u5411 tcp-echo \u670d\u52a1\u53d1\u9001 TCP \u8bf7\u6c42\uff1a</p> <pre><code>$ $ for i in {.10}; do \\\\\n&gt; docker run -e INGRESS_HOST=$INGRESS_HOST -e INGRESS_PORT=$INGRESS_PORT -it --rm busybox sh -c \"(date; sleep 1) | nc $INGRESS_HOST $INGRESS_PORT\"; \\\\\n&gt; done\ntwo Thu Jul  2 07:27:03 UTC 2020\none Thu Jul  2 07:27:09 UTC 2020\none Thu Jul  2 07:27:13 UTC 2020\none Thu Jul  2 07:27:16 UTC 2020\none Thu Jul  2 07:27:21 UTC 2020\ntwo Thu Jul  2 07:27:24 UTC 2020\none Thu Jul  2 07:27:27 UTC 2020\none Thu Jul  2 07:27:32 UTC 2020\ntwo Thu Jul  2 07:27:36 UTC 2020\none Thu Jul  2 07:27:39 UTC 2020\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\uff0c\u6709\u5927\u7ea6 20% \u7684\u6d41\u91cf\u65f6\u95f4\u6233\u524d\u7f00\u662f <code>two</code> \uff0c\u8fd9\u610f\u5473\u7740\u6709 80% \u7684 TCP \u6d41\u91cf\u8def\u7531\u5230\u4e86 tcp-echo \u670d\u52a1\u7684 v1 \u7248\u672c\uff0c\u4e0e\u6b64\u540c\u65f6\u6709 20% \u6d41\u91cf\u8def\u7531\u5230\u4e86 v2 \u7248\u672c\u3002</p> <p>\u8fd9\u6837\u6211\u4eec\u5b9e\u73b0\u4e86\u5bf9 TCP \u6d41\u91cf\u7684\u8f6c\u79fb\uff0c\u548c\u524d\u9762\u6211\u4eec\u4f7f\u7528\u7684 HTTP \u670d\u52a1\u975e\u5e38\u7c7b\u4f3c\u3002</p>"},{"location":"kubernetes_service_mesh/traffic/#_8","title":"\u7194\u65ad","text":"<p><code>\u7194\u65ad</code>\u662f\u521b\u5efa\u5f39\u6027\u5fae\u670d\u52a1\u5e94\u7528\u7a0b\u5e8f\u7684\u91cd\u8981\u6a21\u5f0f\uff0c\u7194\u65ad\u80fd\u591f\u4f7f\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u5177\u5907\u5e94\u5bf9\u6765\u81ea\u6545\u969c\u3001\u6f5c\u5728\u5cf0\u503c\u548c\u5176\u4ed6\u672a\u77e5\u7f51\u7edc\u56e0\u7d20\u5f71\u54cd\u7684\u80fd\u529b\uff0c\u7194\u65ad\u5728\u5fae\u670d\u52a1\u6846\u67b6\u4e2d\u4e5f\u662f\u5fc5\u5907\u7684\u4e00\u4e2a\u529f\u80fd\u3002</p> <p>\u540c\u6837\u5728 Istio \u4e2d\u4e5f\u662f\u539f\u751f\u5c31\u652f\u6301\u7194\u65ad\u529f\u80fd\u7684\uff0c\u9996\u5148\u90e8\u7f72\u793a\u4f8b\u670d\u52a1 </p> <pre><code>samples/httpbin/httpbin.yaml\n</code></pre> <p>\uff1a</p> <pre><code># samples/httpbin/httpbin.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: httpbin\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: httpbin\n  labels:\n    app: httpbin\nspec:\n  ports:\n  - name: http\n    port: 8000\n    targetPort: 80\n  selector:\n    app: httpbin\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: httpbin\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: httpbin\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: httpbin\n        version: v1\n    spec:\n      serviceAccountName: httpbin\n      containers:\n      - image: docker.io/kennethreitz/httpbin\n        imagePullPolicy: IfNotPresent\n        name: httpbin\n        ports:\n        - containerPort: 80\n</code></pre> <p>\u8be5\u5e94\u7528\u4e5f\u5f88\u7b80\u5355\uff0c\u76f4\u63a5\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u547d\u4ee4\u90e8\u7f72\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f &lt;(istioctl kube-inject -f samples/httpbin/httpbin.yaml)\nserviceaccount/httpbin created\nservice/httpbin created\ndeployment.apps/httpbin created\n$ kubectl get pods -l app=httpbin\nNAME                       READY   STATUS    RESTARTS   AGE\nhttpbin-7b7585564c-bt9kp   2/2     Running   0          16m\n</code></pre> <p>\u5e94\u7528\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u63a5\u7740\u521b\u5efa\u4e00\u4e2a\u76ee\u6807\u89c4\u5219\uff0c\u5728\u8c03\u7528 httpbin \u670d\u52a1\u65f6\u914d\u7f6e\u7194\u65ad\u8bbe\u7f6e\u3002\u8fd9\u91cc\u901a\u8fc7\u4e00\u4e2a <code>DestinationRule</code> \u5bf9\u8c61\u6765\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: httpbin\nspec:\n  host: httpbin\n  trafficPolicy:  \n    connectionPool:\n      tcp:\n        maxConnections: 1  # \u6700\u5927\u8fde\u63a5\u6570\u4e3a1\n      http:\n        http1MaxPendingRequests: 1  # \u6700\u5927\u8bf7\u6c42\u6570\u4e3a1\n        maxRequestsPerConnection: 1\n    outlierDetection:\n      consecutiveErrors: 1\n      interval: 1s\n      baseEjectionTime: 3m\n      maxEjectionPercent: 100\nEOF\n</code></pre> <p>\u76ee\u6807\u89c4\u5219\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u63a5\u7740\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a\u5ba2\u6237\u7aef\u5e94\u7528\u6765\u53d1\u9001\u6d41\u91cf\u8bf7\u6c42\u5230 <code>httpbin</code> \u670d\u52a1\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a Fortio \u7684\u6d4b\u8bd5\u5ba2\u6237\u7aef\u5e94\u7528\uff0c\u8be5\u5e94\u7528\u53ef\u4ee5\u63a7\u5236\u8fde\u63a5\u6570\u3001\u5e76\u53d1\u6570\u53ca\u53d1\u9001 HTTP \u8bf7\u6c42\u7684\u5ef6\u8fdf\uff0c\u901a\u8fc7 Fortio \u80fd\u591f\u6709\u6548\u7684\u89e6\u53d1\u524d\u9762\u5728 <code>DestinationRule</code> \u4e2d\u8bbe\u7f6e\u7684\u7194\u65ad\u7b56\u7565\u3002</p> <p>\u5ba2\u6237\u7aef\u5e94\u7528\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4f4d\u4e8e </p> <pre><code>samples/httpbin/sample-client/fortio-deploy.yaml\n</code></pre> <p>\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># samples/httpbin/sample-client/fortio-deploy.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: fortio\n  labels:\n    app: fortio\nspec:\n  ports:\n  - port: 8080\n    name: http\n  selector:\n    app: fortio\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: fortio-deploy\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: fortio\n  template:\n    metadata:\n      annotations:\n        # This annotation causes Envoy to serve cluster.outbound statistics via 15000/stats\n        # in addition to the stats normally served by Istio.  The Circuit Breaking example task\n        # gives an example of inspecting Envoy stats.\n        sidecar.istio.io/statsInclusionPrefixes: cluster.outbound,cluster_manager,listener_manager,http_mixer_filter,tcp_mixer_filter,server,cluster.xds-grpc\n      labels:\n        app: fortio\n    spec:\n      containers:\n      - name: fortio\n        image: fortio/fortio:latest_release\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 8080\n          name: http-fortio\n        - containerPort: 8079\n          name: grpc-ping\n</code></pre> <p>\u76f4\u63a5\u90e8\u7f72\u4e0a\u9762\u7684\u5ba2\u6237\u7aef\u5e94\u7528\uff0c\u8bb0\u5f97\u6ce8\u5165 Istio Sidecar \u4ee3\u7406\uff0c\u4ee5\u4fbf Istio \u5bf9\u5176\u7f51\u7edc\u4ea4\u4e92\u8fdb\u884c\u7ba1\u7406\uff1a</p> <pre><code>$ kubectl apply -f &lt;(istioctl kube-inject -f samples/httpbin/sample-client/fortio-deploy.yaml)\nservice/fortio created\ndeployment.apps/fortio-deploy created\n$ kubectl get pods -l app=fortio\nNAME                             READY   STATUS    RESTARTS   AGE\nfortio-deploy-5cddbb9586-wrm6f   2/2     Running   0          6m23s\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u8fdb\u5165\u5230\u5ba2\u6237\u7aef\u5e94\u7528\u4e2d\u4f7f\u7528 <code>Fortio</code> \u5de5\u5177\u8c03\u7528 <code>httpbin</code> \u670d\u52a1\u3002<code>-curl</code> \u53c2\u6570\u8868\u660e\u53d1\u9001\u4e00\u6b21\u8c03\u7528\uff1a</p> <pre><code>$ FORTIO_POD=$(kubectl get pod | grep fortio | awk '{ print $1 }')\n$ kubectl exec -it $FORTIO_POD  -c fortio -- /usr/bin/fortio load -curl  http://httpbin:8000/get\nHTTP/1 200 OK\nserver: envoy\ndate: Thu, 02 Jul 2020 07:58:53 GMT\ncontent-type: application/json\ncontent-length: 621\naccess-control-allow-origin: *\naccess-control-allow-credentials: true\nx-envoy-upstream-service-time: 49\n\n{\n  \"args\": {},\n  \"headers\": {\n    \"Content-Length\": \"0\",\n    \"Host\": \"httpbin:8000\",\n    \"User-Agent\": \"fortio.org/fortio-1\",\n    \"X-B3-Parentspanid\": \"4b6b58f3e7f6fbef\",\n    \"X-B3-Sampled\": \"1\",\n    \"X-B3-Spanid\": \"65503dee233ed2e8\",\n    \"X-B3-Traceid\": \"ae79fbcbcc1d58244b6b58f3e7f6fbef\",\n    \"X-Envoy-Attempt-Count\": \"1\",\n    \"X-Forwarded-Client-Cert\": \"By=spiffe://cluster.local/ns/default/sa/httpbin;Hash=9df7ef19dd6325879dcaa5cef793f936931624bded10a063dd7a927afb77adb5;Subject=\\\\\"\\\\\";URI=spiffe://cluster.local/ns/default/sa/default\"\n  },\n  \"origin\": \"11\",\n  \"url\": \"http://httpbin:8000/get\"\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8c03\u7528\u540e\u7aef\u670d\u52a1\u7684\u8bf7\u6c42\u662f\u6210\u529f\u7684\uff0c\u7136\u540e\u6211\u4eec\u6765\u6d4b\u8bd5\u4e0b\u7194\u65ad\u3002\u5728 <code>DestinationRule</code> \u914d\u7f6e\u4e2d\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86 <code>maxConnections: 1</code> \u548c </p> <pre><code>http1MaxPendingRequests: 1\n</code></pre> <p>\uff0c\u8868\u793a\u5982\u679c\u5e76\u53d1\u7684\u8fde\u63a5\u548c\u8bf7\u6c42\u6570\u8d85\u8fc7\u4e00\u4e2a\uff0c\u5219\u5728 <code>istio-proxy</code> \u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u8bf7\u6c42\u548c\u8fde\u63a5\u65f6\uff0c\u540e\u7eed\u7684\u8bf7\u6c42\u6216\u8fde\u63a5\u5c06\u88ab\u963b\u6b62\u3002</p> <p>\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u53d1\u9001\u5e76\u53d1\u6570\u4e3a 2 \u7684\u8fde\u63a5\uff08-c 2\uff09\uff0c\u8bf7\u6c42 20 \u6b21\uff08-n 20\uff09\u6765\u89c2\u5bdf\u4e0b\u73b0\u8c61\uff1a</p> <pre><code>$ kubectl exec -it $FORTIO_POD  -c fortio /usr/bin/fortio -- load -c 2 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get\n15:59:27 I logger.go:97&gt; Log level is now 3 Warning (was 2 Info)\nFortio 1 running at 0 queries per second, 4-&gt;4 procs, for 20 calls: http://httpbin:8000/get\nStarting at max qps with 2 thread(s) [gomax 4] for exactly 20 calls (10 per thread + 0)\n15:59:27 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n15:59:27 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n15:59:27 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n15:59:27 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n15:59:27 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\nEnded after 1547078ms : 20 calls. qps=155\nAggregated Function Time : count 20 avg 01428141 +/- 0143 min 000651885 max 061146337 sum 285628198\n# range, mid point, percentile, count\n&gt;= 000651885 &lt;= 001 , 000825943 , 00, 1\n&gt; 002 &lt;= 003 , 0025 , 00, 1\n&gt; 003 &lt;= 004 , 0035 , 00, 1\n&gt; 005 &lt;= 006 , 0055 , 00, 3\n&gt; 006 &lt;= 007 , 0065 , 00, 4\n&gt; 008 &lt;= 009 , 0085 , 00, 1\n&gt; 011 &lt;= 012 , 0115 , 00, 1\n&gt; 012 &lt;= 014 , 013 , 00, 2\n&gt; 016 &lt;= 018 , 017 , 00, 1\n&gt; 018 &lt;= 02 , 019 , 00, 1\n&gt; 025 &lt;= 03 , 0275 , 00, 2\n&gt; 035 &lt;= 04 , 0375 , 00, 1\n&gt; 06 &lt;= 0611463 , 0605732 , 100, 1\n# target 50% 007\n# target 75% 018\n# target 90% 03\n# target 99% 0609171\n# target 9% 0611234\nSockets used: 7 (for perfect keepalive, would be 2)\nCode 200 : 15 (0 %)\nCode 503 : 5 (0 %)\nResponse Header Sizes : count 20 avg 185 +/- 8 min 0 max 231 sum 3457\nResponse Body/Total Sizes : count 20 avg 685 +/- 23 min 241 max 852 sum 13977\nAll done 20 calls (plus 0 warmup) 281 ms avg, 15 qps\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5927\u90e8\u5206\u8bf7\u6c42\u8fd8\u662f\u90fd\u5b8c\u6210\u4e86\uff0c\u4f46\u662f\u5e76\u4e0d\u662f\u4e00\u534a\u7684\u8bf7\u6c42\u5931\u8d25\uff0c\u8fd9\u662f\u56e0\u4e3a <code>istio-proxy</code> \u5e76\u4e0d\u662f100%\u51c6\u786e\u7684\uff1a</p> <pre><code>Code 200 : 15 (0 %)\nCode 503 : 5 (0 %)\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c06\u5e76\u53d1\u8fde\u63a5\u6570\u63d0\u9ad8\u5230 3 \u4e2a\uff1a</p> <pre><code>$ kubectl exec -it $FORTIO_POD  -c fortio /usr/bin/fortio -- load -c 3 -qps 0 -n 30 -loglevel Warning http://httpbin:8000/get\n16:04:52 I logger.go:97&gt; Log level is now 3 Warning (was 2 Info)\nFortio 1 running at 0 queries per second, 4-&gt;4 procs, for 30 calls: http://httpbin:8000/get\nStarting at max qps with 3 thread(s) [gomax 4] for exactly 30 calls (10 per thread + 0)\n16:04:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n16:04:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n16:04:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n16:04:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n16:04:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n16:04:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n16:04:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n16:04:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n16:04:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n16:04:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n16:04:52 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\n16:04:53 W http_client.go:679&gt; Parsed non ok code 503 (HTTP/1 503)\nEnded after 1870596ms : 30 calls. qps=238\nAggregated Function Time : count 30 avg 007441411 +/- 006978 min 001160642 max 036414088 sum 223242331\n# range, mid point, percentile, count\n&gt;= 00116064 &lt;= 002 , 00158032 , 33, 7\n&gt; 002 &lt;= 003 , 0025 , 00, 5\n&gt; 007 &lt;= 008 , 0075 , 67, 5\n&gt; 008 &lt;= 009 , 0085 , 00, 4\n&gt; 009 &lt;= 01 , 0095 , 00, 3\n&gt; 01 &lt;= 011 , 0105 , 33, 1\n&gt; 011 &lt;= 012 , 0115 , 00, 2\n&gt; 012 &lt;= 014 , 013 , 33, 1\n&gt; 018 &lt;= 02 , 019 , 67, 1\n&gt; 035 &lt;= 0364141 , 035707 , 100, 1\n# target 50% 0076\n# target 75% 0095\n# target 90% 012\n# target 99% 0359899\n# target 9% 0363717\nSockets used: 14 (for perfect keepalive, would be 3)\nCode 200 : 18 (0 %)\nCode 503 : 12 (0 %)\nResponse Header Sizes : count 30 avg 106667 +/- 17 min 0 max 231 sum 4142\nResponse Body/Total Sizes : count 30 avg 606667 +/- 29 min 241 max 852 sum 18212\nAll done 30 calls (plus 0 warmup) 441 ms avg, 24 qps\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5927\u90e8\u5206\u7684\u8bf7\u6c42\u90fd\u88ab\u7194\u65ad\u5668\u62e6\u622a\uff1a</p> <pre><code>Code 200 : 18 (0 %)\nCode 503 : 12 (0 %)\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>istio-proxy</code> \u72b6\u6001\u6765\u4e86\u89e3\u66f4\u591a\u5173\u4e8e\u7194\u65ad\u7684\u8be6\u60c5\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u67e5\u770b\uff1a</p> <pre><code>$ kubectl exec $FORTIO_POD -c istio-proxy -- pilot-agent request GET stats | grep httpbin | grep pending\ncluster.outbound|8000||httpbin.default.svc.cluster.local.circuit_breakers.default.rq_pending_open: 0\ncluster.outbound|8000||httpbin.default.svc.cluster.local.circuit_breakers.high.rq_pending_open: 0\ncluster.outbound|8000||httpbin.default.svc.cluster.local.upstream_rq_pending_active: 0\ncluster.outbound|8000||httpbin.default.svc.cluster.local.upstream_rq_pending_failure_eject: 0\ncluster.outbound|8000||httpbin.default.svc.cluster.local.upstream_rq_pending_overflow: 17\ncluster.outbound|8000||httpbin.default.svc.cluster.local.upstream_rq_pending_total: 37\n</code></pre> <p>\u5176\u4e2d </p> <pre><code>upstream_rq_pending_overflow\n</code></pre> <p>\u503c\u4e3a17\uff0c\u8fd9\u8868\u793a\u76ee\u524d\u4e3a\u6b62\u5df2\u670917\u4e2a\u8c03\u7528\u88ab\u6807\u8bb0\u4e3a\u7194\u65ad\u4e86\u3002</p>"},{"location":"kubernetes_service_mesh/traffic/#_9","title":"\u6d41\u91cf\u955c\u50cf","text":"<p><code>\u6d41\u91cf\u955c\u50cf</code>\u4e5f\u79f0\u4e3a\u5f71\u5b50\u6d41\u91cf\uff0c\u662f\u4e00\u4e2a\u4ee5\u5c3d\u53ef\u80fd\u4f4e\u7684\u98ce\u9669\u4e3a\u751f\u4ea7\u5e26\u6765\u53d8\u5316\u7684\u5f3a\u5927\u7684\u529f\u80fd\uff0c\u955c\u50cf\u4f1a\u5c06\u5b9e\u65f6\u6d41\u91cf\u7684\u526f\u672c\u53d1\u9001\u5230\u955c\u50cf\u670d\u52a1\u3002\u524d\u9762\u6211\u4eec\u5728\u5b66\u4e60 Traefik \u7684\u65f6\u5019\u5c31\u6d4b\u8bd5\u8fc7\u7c7b\u4f3c\u7684\u529f\u80fd\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u5148\u628a\u6d41\u91cf\u5168\u90e8\u8def\u7531\u5230 v1 \u7248\u672c\u7684\u6d4b\u8bd5\u670d\u52a1\u4e2d\uff0c\u7136\u540e\u6dfb\u52a0\u8def\u7531\u89c4\u5219\u5c06\u4e00\u90e8\u5206\u6d41\u91cf\u955c\u50cf\u5230 v2 \u7248\u672c\u4e2d\u53bb\uff0c\u6765\u6d4b\u8bd5\u6d41\u91cf\u955c\u50cf\u529f\u80fd\u3002</p> <p>\u9996\u5148\u90e8\u7f72 <code>v1</code> \u7248\u672c\u7684 httpbin \u670d\u52a1\uff1a</p> <pre><code>$ cat &lt;&lt;EOF | istioctl kube-inject -f - | kubectl apply -f -\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: httpbin-v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: httpbin\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: httpbin\n        version: v1\n    spec:\n      containers:\n      - image: docker.io/kennethreitz/httpbin\n        imagePullPolicy: IfNotPresent\n        name: httpbin\n        command: [\"gunicorn\", \"--access-logfile\", \"-\", \"-b\", \"0:80\", \"httpbin:app\"]\n        ports:\n        - containerPort: 80\nEOF\n</code></pre> <p>\u7136\u540e\u90e8\u7f72 <code>v2</code> \u7248\u672c\u7684 httpbin \u670d\u52a1\uff1a</p> <pre><code>$ cat &lt;&lt;EOF | istioctl kube-inject -f - | kubectl apply -f -\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: httpbin-v2\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: httpbin\n      version: v2\n  template:\n    metadata:\n      labels:\n        app: httpbin\n        version: v2\n    spec:\n      containers:\n      - image: docker.io/kennethreitz/httpbin\n        imagePullPolicy: IfNotPresent\n        name: httpbin\n        command: [\"gunicorn\", \"--access-logfile\", \"-\", \"-b\", \"0:80\", \"httpbin:app\"]\n        ports:\n        - containerPort: 80\nEOF\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a httpbin \u7684 Service \u5bf9\u8c61\uff0c\u5173\u8054\u4e0a\u9762\u7684\u4e24\u4e2a\u7248\u672c\u670d\u52a1\uff1a</p> <pre><code>$ kubectl apply -f - &lt;&lt;EOF\napiVersion: v1\nkind: Service\nmetadata:\n  name: httpbin\n  labels:\n    app: httpbin\nspec:\n  ports:\n  - name: http\n    port: 8000\n    targetPort: 80\n  selector:\n    app: httpbin\nEOF\n</code></pre> <p>\u7136\u540e\u5728\u4e0d\u662f\u4e00\u4e2a sleep \u670d\u52a1\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>curl</code> \u6765\u63d0\u4f9b\u8d1f\u8f7d\u4e86\uff1a</p> <pre><code>$ cat &lt;&lt;EOF | istioctl kube-inject -f - | kubectl create -f -\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: sleep\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: sleep\n  template:\n    metadata:\n      labels:\n        app: sleep\n    spec:\n      containers:\n      - name: sleep\n        image: tutum/curl\n        command: [\"/bin/sleep\",\"infinity\"]\n        imagePullPolicy: IfNotPresent\nEOF\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cKubernetes \u5728 httpbin \u670d\u52a1\u7684\u4e24\u4e2a\u7248\u672c\u4e4b\u95f4\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\u3002\u8fd9\u91cc\u6211\u4eec\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u9ed8\u8ba4\u8def\u7531\u89c4\u5219\uff0c\u5c06\u6240\u6709\u6d41\u91cf\u8def\u7531\u5230\u670d\u52a1\u7684 <code>v1</code> \u7248\u672c\u4e2d\u53bb\uff1a</p> <pre><code>$ kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: httpbin\nspec:\n  hosts:\n  - httpbin\n  http:\n  - route:\n    - destination:\n        host: httpbin\n        subset: v1\n      weight: 100\n---\napiVersion: networking.istio.io/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: httpbin\nspec:\n  host: httpbin\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n  - name: v2\n    labels:\n      version: v2\nEOF\n</code></pre> <p>\u4e0a\u9762\u5bf9\u8c61\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6240\u6709\u6d41\u91cf\u90fd\u4f1a\u8f6c\u5230 <code>httpbin:v1</code> \u670d\u52a1\u4e0b\u9762\u53bb\uff0c\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u6765\u6d4b\u8bd5\u4ee5\u4e0b\uff1a</p> <pre><code>$ export SLEEP_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name})\n$ kubectl exec -it $SLEEP_POD -c sleep -- sh -c 'curl  http://httpbin:8000/headers' | python -m json.tool\n{\n    \"headers\": {\n        \"Accept\": \"*/*\",\n        \"Content-Length\": \"0\",\n        \"Host\": \"httpbin:8000\",\n        \"User-Agent\": \"curl/0\",\n        \"X-B3-Parentspanid\": \"2f5164f4206f2958\",\n        \"X-B3-Sampled\": \"1\",\n        \"X-B3-Spanid\": \"233ea866989fc458\",\n        \"X-B3-Traceid\": \"336d07e6e360544d2f5164f4206f2958\",\n        \"X-Envoy-Attempt-Count\": \"1\",\n        \"X-Forwarded-Client-Cert\": \"By=spiffe://cluster.local/ns/default/sa/default;Hash=af8a4f153a257b346fcf8e88418d21781f145305c8ad98943ef43134ed147b57;Subject=\\\\\"\\\\\";URI=spiffe://cluster.local/ns/default/sa/default\"\n    }\n}\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u5206\u522b\u67e5\u770b httpbin \u670d\u52a1 <code>v1</code> \u548c <code>v2</code> \u4e24\u4e2a Pods \u7684\u65e5\u5fd7\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\u53ea\u4f1a\u770b\u5230 <code>v1</code> \u4f1a\u4ea7\u751f\u65e5\u5fd7\uff0c<code>v1</code> \u4e2d\u6ca1\u6709\uff1a</p> <pre><code>$ export V1_POD=$(kubectl get pod -l app=httpbin,version=v1 -o jsonpath={.items..metadata.name})\n$ kubectl logs -f $V1_POD -c httpbin\n11 - - [02/Jul/2020:16:27:47 +0800] \"GET /headers HTTP/1\" 200 553 \"-\" \"curl/0\"\n$ export V2_POD=$(kubectl get pod -l app=httpbin,version=v2 -o jsonpath={.items..metadata.name})\n$ kubectl logs -f $V2_POD -c httpbin\n</code></pre> <p>\u8fd9\u662f\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684\u8def\u7531\u89c4\u5219\u662f\u5c06\u6240\u6709\u7684\u8bf7\u6c42\u90fd\u8def\u7531\u5230\u4e86 <code>v1</code> \u8fd9\u4e2a\u7248\u672c\u7684\u670d\u52a1\u4e2d\u53bb\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u66f4\u6539\u4e0b\u6d41\u91cf\u89c4\u5219\uff0c\u5c06\u6d41\u91cf\u955c\u50cf\u5230 <code>v2</code> \u7248\u672c\u7684\u670d\u52a1\u4e2d\u53bb\uff1a</p> <pre><code>$ kubectl apply -f - &lt;&lt;EOF\napiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: httpbin\nspec:\n  hosts:\n  - httpbin\n  http:\n  - route:\n    - destination:\n        host: httpbin\n        subset: v1\n      weight: 100\n    mirror:\n      host: httpbin\n      subset: v2\n    mirror_percent: 100\nEOF\n</code></pre> <p>\u8fd9\u4e2a\u8def\u7531\u89c4\u5219\u4f1a\u53d1\u9001 100% \u6d41\u91cf\u5230 <code>v1</code> \u8fd9\u4e2a\u5b50\u96c6\u670d\u52a1\uff0c\u7136\u540e\u901a\u8fc7 <code>mirror</code> \u5c5e\u6027\u914d\u7f6e\u4e86\u5c06\u6d41\u91cf\u4e5f 100% \u955c\u50cf\u5230\u4e86 <code>httpbin:v2</code> \u670d\u52a1\u3002\u5f53\u6d41\u91cf\u88ab\u955c\u50cf\u65f6\uff0c\u8bf7\u6c42\u5c06\u53d1\u9001\u5230\u955c\u50cf\u670d\u52a1\u4e2d\uff0c\u5e76\u5728 headers \u4e2d\u7684 <code>Host/Authority</code> \u5c5e\u6027\u503c\u4e0a\u8ffd\u52a0 <code>-shadow</code>\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u8fd9\u4e9b\u88ab\u955c\u50cf\u7684\u6d41\u91cf\u662f<code>\u300e \u5373\u53d1\u5373\u5f03\u300f</code>\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u955c\u50cf\u8bf7\u6c42\u7684\u54cd\u5e94\u4f1a\u88ab\u4e22\u5f03\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u5728\u7528\u4e0a\u9762\u7684\u547d\u4ee4\u6765\u6d4b\u8bd5\u53d1\u9001\u4e00\u6b21\u8bf7\u6c42\uff1a</p> <pre><code>$ kubectl exec -it $SLEEP_POD -c sleep -- sh -c 'curl  http://httpbin:8000/headers' | python -m json.tool\n</code></pre> <p>\u73b0\u5728\u5c31\u53ef\u4ee5\u770b\u5230 <code>v1</code> \u548c <code>v2</code> \u4e2d\u90fd\u6709\u4e86\u8bbf\u95ee\u65e5\u5fd7\uff0c<code>v2</code> \u4e2d\u7684\u8bbf\u95ee\u65e5\u5fd7\u5c31\u662f\u7531\u955c\u50cf\u6d41\u91cf\u4ea7\u751f\u7684\uff0c\u8fd9\u4e9b\u8bf7\u6c42\u7684\u5b9e\u9645\u76ee\u6807\u662f <code>v1</code>\u3002</p> <pre><code>$ kubectl logs -f $V1_POD -c httpbin\n11 - - [02/Jul/2020:16:27:47 +0800] \"GET /headers HTTP/1\" 200 553 \"-\" \"curl/0\"\n11 - - [02/Jul/2020:16:32:06 +0800] \"GET /headers HTTP/1\" 200 553 \"-\" \"curl/0\"\n$ kubectl logs -f $V2_POD -c httpbin\n11 - - [02/Jul/2020:16:32:06 +0800] \"GET /headers HTTP/1\" 200 593 \"-\" \"curl/0\"\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b9e\u73b0\u4e86\u6d41\u91cf\u955c\u50cf\u7684\u529f\u80fd\u3002</p>"},{"location":"kubernetes_stroage/ceph/","title":"Ceph \u5b58\u50a8","text":""},{"location":"kubernetes_stroage/ceph/#ceph","title":"Ceph","text":"<p>Ceph \u662f\u4e00\u4e2a\u7edf\u4e00\u7684\u5206\u5e03\u5f0f\u5b58\u50a8\u7cfb\u7edf\uff0c\u63d0\u4f9b\u8f83\u597d\u7684\u6027\u80fd\u3001\u53ef\u9760\u6027\u548c\u53ef\u6269\u5c55\u6027\u3002\u6700\u65e9\u8d77\u6e90\u4e8e Sage \u535a\u58eb\u671f\u95f4\u7684\u5de5\u4f5c\uff0c\u968f\u540e\u8d21\u732e\u7ed9\u5f00\u6e90\u793e\u533a\u3002</p>"},{"location":"kubernetes_stroage/ceph/#_1","title":"\u7b80\u4ecb","text":"<p><code>\u9ad8\u6027\u80fd</code></p> <ul> <li>\u629b\u5f03\u4e86\u4f20\u7edf\u7684\u96c6\u4e2d\u5f0f\u5b58\u50a8\u8fd0\u8f93\u5c40\u5bfb\u5740\u7684\u65b9\u6848\uff0c\u91c7\u7528 <code>CRUSH</code> \u7b97\u6cd5\uff0c\u6570\u636e\u5206\u5e03\u5747\u8861\uff0c\u5e76\u884c\u5ea6\u9ad8\u3002</li> <li>\u8003\u8651\u4e86\u5bb9\u707e\u57df\u7684\u9694\u79bb\uff0c\u80fd\u591f\u5b9e\u73b0\u5404\u7c7b\u8d1f\u8f7d\u7684\u526f\u672c\u8bbe\u7f6e\u89c4\u5219\uff0c\u4f8b\u5982\u8de8\u673a\u623f\u3001\u673a\u67b6\u611f\u77e5\u7b49\u3002</li> <li>\u80fd\u591f\u652f\u6301\u4e0a\u5343\u4e2a\u5b58\u50a8\u8282\u70b9\u7684\u89c4\u6a21\uff0c\u652f\u6301 TB \u5230 PB \u7ea7\u7684\u6570\u636e\u3002</li> </ul> <p><code>\u9ad8\u53ef\u7528\u6027</code></p> <ul> <li>\u526f\u672c\u6570\u53ef\u4ee5\u7075\u6d3b\u63a7\u5236</li> <li>\u652f\u6301\u6545\u969c\u57df\u5206\u79bb\uff0c\u6570\u636e\u5f3a\u4e00\u81f4\u6027</li> <li>\u591a\u79cd\u6545\u969c\u573a\u666f\u81ea\u52a8\u8fdb\u884c\u4fee\u590d\u81ea\u6108</li> <li>\u6ca1\u6709\u5355\u70b9\u6545\u969c\uff0c\u81ea\u52a8\u7ba1\u7406~~</li> </ul> <p><code>\u9ad8\u53ef\u6269\u5c55\u6027</code></p> <ul> <li>\u53bb\u4e2d\u5fc3\u5316</li> <li>\u6269\u5c55\u7075\u6d3b</li> <li>\u968f\u7740\u8282\u70b9\u589e\u52a0\u800c\u7ebf\u6027\u589e\u957f</li> </ul> <p><code>\u7279\u6027\u4e30\u5bcc</code></p> <ul> <li>\u652f\u6301\u4e09\u79cd\u5b58\u50a8\u63a5\u53e3\uff1a\u5757\u5b58\u50a8\u3001\u6587\u4ef6\u5b58\u50a8\u3001\u5bf9\u8c61\u5b58\u50a8</li> <li>\u652f\u6301\u81ea\u5b9a\u4e49\u63a5\u53e3\uff0c\u652f\u6301\u591a\u79cd\u8bed\u8a00\u9a71\u52a8</li> </ul>"},{"location":"kubernetes_stroage/ceph/#_2","title":"\u67b6\u6784","text":"<p><code>\u652f\u6301\u4e09\u79cd\u63a5\u53e3</code></p> <ul> <li>Object\uff1a\u6709\u539f\u751f API\uff0c\u800c\u4e14\u4e5f\u517c\u5bb9 Swift \u548c S3 \u7684 API</li> <li>Block\uff1a\u652f\u6301\u7cbe\u7b80\u914d\u7f6e\u3001\u5feb\u7167\u3001\u514b\u9686</li> <li>File\uff1aPosix \u63a5\u53e3\uff0c\u652f\u6301\u5feb\u7167</li> </ul> <p></p>"},{"location":"kubernetes_stroage/ceph/#_3","title":"\u7ec4\u4ef6","text":"<p><code>Monitor</code>\uff1a\u4e00\u4e2a Ceph \u96c6\u7fa4\u9700\u8981\u591a\u4e2a Monitor \u7ec4\u6210\u7684\u5c0f\u96c6\u7fa4\uff0c\u5b83\u4eec\u901a\u8fc7 Paxos \u540c\u6b65\u6570\u636e\uff0c\u7528\u6765\u4fdd\u5b58 OSD \u7684\u5143\u6570\u636e\u3002</p> <p><code>OSD</code>\uff1a\u5168\u79f0 </p> <pre><code>Object Storage Device\n</code></pre> <p>\uff0c\u4e5f\u5c31\u662f\u8d1f\u8d23\u54cd\u5e94\u5ba2\u6237\u7aef\u8bf7\u6c42\u8fd4\u56de\u5177\u4f53\u6570\u636e\u7684\u8fdb\u7a0b\uff0c\u4e00\u4e2a Ceph \u96c6\u7fa4\u4e00\u822c\u90fd\u6709\u5f88\u591a\u4e2a OSD\u3002\u4e3b\u8981\u529f\u80fd\u7528\u4e8e\u6570\u636e\u7684\u5b58\u50a8\uff0c\u5f53\u76f4\u63a5\u4f7f\u7528\u786c\u76d8\u4f5c\u4e3a\u5b58\u50a8\u76ee\u6807\u65f6\uff0c\u4e00\u5757\u786c\u76d8\u79f0\u4e4b\u4e3a <code>OSD</code>\uff0c\u5f53\u4f7f\u7528\u4e00\u4e2a\u76ee\u5f55\u4f5c\u4e3a\u5b58\u50a8\u76ee\u6807\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u76ee\u5f55\u4e5f\u88ab\u79f0\u4e3a <code>OSD</code>\u3002</p> <p><code>MDS</code>\uff1a\u5168\u79f0 <code>Ceph Metadata Server</code>\uff0c\u662f CephFS \u670d\u52a1\u4f9d\u8d56\u7684\u5143\u6570\u636e\u670d\u52a1\uff0c\u5bf9\u8c61\u5b58\u50a8\u548c\u5757\u8bbe\u5907\u5b58\u50a8\u4e0d\u9700\u8981\u8be5\u670d\u52a1\u3002</p> <p><code>Object</code>\uff1aCeph \u6700\u5e95\u5c42\u7684\u5b58\u50a8\u5355\u5143\u662f Object \u5bf9\u8c61\uff0c\u4e00\u6761\u6570\u636e\u3001\u4e00\u4e2a\u914d\u7f6e\u90fd\u662f\u4e00\u4e2a\u5bf9\u8c61\uff0c\u6bcf\u4e2a Object \u5305\u542b ID\u3001\u5143\u6570\u636e\u548c\u539f\u59cb\u6570\u636e\u3002</p> <p><code>Pool</code>\uff1aPool \u662f\u4e00\u4e2a\u5b58\u50a8\u5bf9\u8c61\u7684\u903b\u8f91\u5206\u533a\uff0c\u5b83\u901a\u5e38\u89c4\u5b9a\u4e86\u6570\u636e\u5197\u4f59\u7684\u7c7b\u578b\u4e0e\u526f\u672c\u6570\uff0c\u9ed8\u8ba4\u4e3a3\u526f\u672c\u3002\u5bf9\u4e8e\u4e0d\u540c\u7c7b\u578b\u7684\u5b58\u50a8\uff0c\u9700\u8981\u5355\u72ec\u7684 Pool\uff0c\u5982 RBD\u3002</p> <p><code>PG</code>\uff1a\u5168\u79f0 <code>Placement Grouops</code>\uff0c\u662f\u4e00\u4e2a\u903b\u8f91\u6982\u5ff5\uff0c\u4e00\u4e2a OSD \u5305\u542b\u591a\u4e2a PG\u3002\u5f15\u5165 PG \u8fd9\u4e00\u5c42\u5176\u5b9e\u662f\u4e3a\u4e86\u66f4\u597d\u7684\u5206\u914d\u6570\u636e\u548c\u5b9a\u4f4d\u6570\u636e\u3002\u6bcf\u4e2a <code>Pool</code> \u5185\u5305\u542b\u5f88\u591a\u4e2a PG\uff0c\u5b83\u662f\u4e00\u4e2a\u5bf9\u8c61\u7684\u96c6\u5408\uff0c\u670d\u52a1\u7aef\u6570\u636e\u5747\u8861\u548c\u6062\u590d\u7684\u6700\u5c0f\u5355\u4f4d\u5c31\u662f PG\u3002</p> <p></p> <ul> <li>pool \u662f ceph \u5b58\u50a8\u6570\u636e\u65f6\u7684\u903b\u8f91\u5206\u533a\uff0c\u5b83\u8d77\u5230 namespace \u7684\u4f5c\u7528</li> <li>\u6bcf\u4e2a pool \u5305\u542b\u4e00\u5b9a\u6570\u91cf(\u53ef\u914d\u7f6e)\u7684 PG</li> <li>PG \u91cc\u7684\u5bf9\u8c61\u88ab\u6620\u5c04\u5230\u4e0d\u540c\u7684 Object \u4e0a</li> <li>pool \u662f\u5206\u5e03\u5230\u6574\u4e2a\u96c6\u7fa4\u7684</li> </ul> <p><code>FileStore\u4e0eBlueStore</code>\uff1aFileStore \u662f\u8001\u7248\u672c\u9ed8\u8ba4\u4f7f\u7528\u7684\u540e\u7aef\u5b58\u50a8\u5f15\u64ce\uff0c\u5982\u679c\u4f7f\u7528 FileStore\uff0c\u5efa\u8bae\u4f7f\u7528 <code>xfs</code> \u6587\u4ef6\u7cfb\u7edf\u3002BlueStore \u662f\u4e00\u4e2a\u65b0\u7684\u540e\u7aef\u5b58\u50a8\u5f15\u64ce\uff0c\u53ef\u4ee5\u76f4\u63a5\u7ba1\u7406\u88f8\u786c\u76d8\uff0c\u629b\u5f03\u4e86 ext4 \u4e0e xfs \u7b49\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u3002\u53ef\u4ee5\u76f4\u63a5\u5bf9\u7269\u7406\u786c\u76d8\u8fdb\u884c\u64cd\u4f5c\uff0c\u540c\u65f6\u6548\u7387\u4e5f\u9ad8\u51fa\u5f88\u591a\u3002</p> <p><code>RADOS</code>\uff1a\u5168\u79f0 </p> <pre><code>Reliable Autonomic Distributed Object Store\n</code></pre> <p>\uff0c\u662f Ceph \u96c6\u7fa4\u7684\u7cbe\u534e\uff0c\u7528\u4e8e\u5b9e\u73b0\u6570\u636e\u5206\u914d\u3001Failover \u7b49\u96c6\u7fa4\u64cd\u4f5c\u3002</p> <p><code>Librados</code>\uff1a<code>Librados</code> \u662f Rados \u63d0\u4f9b\u5e93\uff0c\u56e0\u4e3a RADOS \u662f\u534f\u8bae\u5f88\u96be\u76f4\u63a5\u8bbf\u95ee\uff0c\u56e0\u6b64\u4e0a\u5c42\u7684 RBD\u3001RGW \u548c CephFS \u90fd\u662f\u901a\u8fc7 librados \u8bbf\u95ee\u7684\uff0c\u76ee\u524d\u63d0\u4f9b PHP\u3001Ruby\u3001Java\u3001Python\u3001C \u548c C++ \u652f\u6301\u3002</p> <p><code>CRUSH</code>\uff1a<code>CRUSH</code> \u662f Ceph \u4f7f\u7528\u7684\u6570\u636e\u5206\u5e03\u7b97\u6cd5\uff0c\u7c7b\u4f3c\u4e00\u81f4\u6027\u54c8\u5e0c\uff0c\u8ba9\u6570\u636e\u5206\u914d\u5230\u9884\u671f\u7684\u5730\u65b9\u3002</p> <p><code>RBD</code>\uff1a\u5168\u79f0 <code>RADOS Block Device</code>\uff0c\u662f Ceph \u5bf9\u5916\u63d0\u4f9b\u7684\u5757\u8bbe\u5907\u670d\u52a1\uff0c\u5982\u865a\u62df\u673a\u786c\u76d8\uff0c\u652f\u6301\u5feb\u7167\u529f\u80fd\u3002</p> <p><code>RGW</code>\uff1a\u5168\u79f0\u662f <code>RADOS Gateway</code>\uff0c\u662f Ceph \u5bf9\u5916\u63d0\u4f9b\u7684\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\uff0c\u63a5\u53e3\u4e0e S3 \u548c Swift \u517c\u5bb9\u3002</p> <p><code>CephFS</code>\uff1a\u5168\u79f0 <code>Ceph File System</code>\uff0c\u662f Ceph \u5bf9\u5916\u63d0\u4f9b\u7684\u6587\u4ef6\u7cfb\u7edf\u670d\u52a1\u3002</p>"},{"location":"kubernetes_stroage/ceph/#_4","title":"\u5757\u5b58\u50a8","text":"<p><code>\u5178\u578b\u8bbe\u5907</code></p> <p>\u78c1\u76d8\u9635\u5217\uff0c\u786c\u76d8\uff0c\u4e3b\u8981\u662f\u5c06\u88f8\u78c1\u76d8\u7a7a\u95f4\u6620\u5c04\u7ed9\u4e3b\u673a\u4f7f\u7528\u7684\u3002</p> <p><code>\u4f18\u70b9</code></p> <ul> <li>\u901a\u8fc7 Raid \u4e0e LVM \u7b49\u624b\u6bb5\uff0c\u5bf9\u6570\u636e\u63d0\u4f9b\u4e86\u4fdd\u62a4\u3002</li> <li>\u591a\u5757\u5ec9\u4ef7\u7684\u786c\u76d8\u7ec4\u5408\u8d77\u6765\uff0c\u63d0\u9ad8\u5bb9\u91cf\u3002</li> <li>\u591a\u5757\u78c1\u76d8\u7ec4\u5408\u51fa\u6765\u7684\u903b\u8f91\u76d8\uff0c\u63d0\u5347\u8bfb\u5199\u6548\u7387\u3002</li> </ul> <p><code>\u7f3a\u70b9</code></p> <ul> <li>\u91c7\u7528 SAN \u67b6\u6784\u7ec4\u7f51\u65f6\uff0c\u5149\u7ea4\u4ea4\u6362\u673a\uff0c\u9020\u4ef7\u6210\u672c\u9ad8\u3002</li> <li>\u4e3b\u673a\u4e4b\u95f4\u65e0\u6cd5\u5171\u4eab\u6570\u636e\u3002</li> </ul> <p><code>\u4f7f\u7528\u573a\u666f</code></p> <ul> <li>Docker \u5bb9\u5668\u3001\u865a\u62df\u673a\u78c1\u76d8\u5b58\u50a8\u5206\u914d\u3002</li> <li>\u65e5\u5fd7\u5b58\u50a8</li> <li>\u6587\u4ef6\u5b58\u50a8</li> <li>...</li> </ul>"},{"location":"kubernetes_stroage/ceph/#_5","title":"\u6587\u4ef6\u5b58\u50a8","text":"<p><code>\u5178\u578b\u8bbe\u5907</code> FTP\u3001NFS \u670d\u52a1\u5668\uff0c\u4e3a\u4e86\u514b\u670d\u5757\u5b58\u50a8\u6587\u4ef6\u65e0\u6cd5\u5171\u4eab\u7684\u95ee\u9898\uff0c\u6240\u4ee5\u6709\u4e86\u6587\u4ef6\u5b58\u50a8\uff0c\u5728\u670d\u52a1\u5668\u4e0a\u67b6\u8bbe FTP \u4e0e NFS \u670d\u52a1\u5668\uff0c\u5c31\u662f\u6587\u4ef6\u5b58\u50a8\u3002</p> <p><code>\u4f18\u70b9</code></p> <ul> <li>\u9020\u4ef7\u4f4e\uff0c\u968f\u4fbf\u4e00\u53f0\u673a\u5668\u5c31\u53ef\u4ee5\u4e86</li> <li>\u65b9\u4fbf\u6587\u4ef6\u53ef\u4ee5\u5171\u4eab</li> </ul> <p><code>\u7f3a\u70b9</code></p> <ul> <li>\u8bfb\u5199\u901f\u7387\u4f4e</li> <li>\u4f20\u8f93\u901f\u7387\u6162</li> </ul> <p><code>\u4f7f\u7528\u573a\u666f</code></p> <ul> <li>\u65e5\u5fd7\u5b58\u50a8</li> <li>\u6709\u76ee\u5f55\u7ed3\u6784\u7684\u6587\u4ef6\u5b58\u50a8</li> <li>...</li> </ul>"},{"location":"kubernetes_stroage/ceph/#_6","title":"\u5bf9\u8c61\u5b58\u50a8","text":"<p><code>\u5178\u578b\u8bbe\u5907</code></p> <p>\u5185\u7f6e\u5927\u5bb9\u91cf\u786c\u76d8\u7684\u5206\u5e03\u5f0f\u670d\u52a1\u5668(swift, s3)\uff1b\u591a\u53f0\u670d\u52a1\u5668\u5185\u7f6e\u5927\u5bb9\u91cf\u786c\u76d8\uff0c\u5b89\u88c5\u4e0a\u5bf9\u8c61\u5b58\u50a8\u7ba1\u7406\u8f6f\u4ef6\uff0c\u5bf9\u5916\u63d0\u4f9b\u8bfb\u5199\u8bbf\u95ee\u529f\u80fd\u3002</p> <p><code>\u4f18\u70b9</code></p> <ul> <li>\u5177\u5907\u5757\u5b58\u50a8\u7684\u8bfb\u5199\u9ad8\u901f\u3002</li> <li>\u5177\u5907\u6587\u4ef6\u5b58\u50a8\u7684\u5171\u4eab\u7b49\u7279\u6027</li> </ul> <p><code>\u4f7f\u7528\u573a\u666f</code>\uff1a(\u9002\u5408\u66f4\u65b0\u53d8\u52a8\u8f83\u5c11\u7684\u6570\u636e)</p> <ul> <li>\u56fe\u7247\u5b58\u50a8</li> <li>\u89c6\u9891\u5b58\u50a8</li> <li>...</li> </ul>"},{"location":"kubernetes_stroage/ceph/#_7","title":"\u90e8\u7f72","text":"<p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u4f7f\u7528\uff0c\u4e5f\u4e3a\u4e86\u65b9\u4fbf\u7ba1\u7406\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 Rook \u6765\u90e8\u7f72 Ceph \u96c6\u7fa4\uff0cRook \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u4e91\u539f\u751f\u5b58\u50a8\u7f16\u6392\u5de5\u5177\uff0c\u63d0\u4f9b\u5e73\u53f0\u3001\u6846\u67b6\u548c\u5bf9\u5404\u79cd\u5b58\u50a8\u89e3\u51b3\u65b9\u6848\u7684\u652f\u6301\uff0c\u4ee5\u548c\u4e91\u539f\u751f\u73af\u5883\u8fdb\u884c\u672c\u5730\u96c6\u6210\u3002</p> <p>Rook \u5c06\u5b58\u50a8\u8f6f\u4ef6\u8f6c\u53d8\u6210\u81ea\u6211\u7ba1\u7406\u3001\u81ea\u6211\u6269\u5c55\u548c\u81ea\u6211\u4fee\u590d\u7684\u5b58\u50a8\u670d\u52a1\uff0c\u901a\u8fc7\u81ea\u52a8\u5316\u90e8\u7f72\u3001\u542f\u52a8\u3001\u914d\u7f6e\u3001\u4f9b\u5e94\u3001\u6269\u5c55\u3001\u5347\u7ea7\u3001\u8fc1\u79fb\u3001\u707e\u96be\u6062\u590d\u3001\u76d1\u63a7\u548c\u8d44\u6e90\u7ba1\u7406\u6765\u5b9e\u73b0\u3002Rook \u5e95\u5c42\u4f7f\u7528\u4e91\u539f\u751f\u5bb9\u5668\u7ba1\u7406\u3001\u8c03\u5ea6\u548c\u7f16\u6392\u5e73\u53f0\u63d0\u4f9b\u7684\u80fd\u529b\u6765\u63d0\u4f9b\u8fd9\u4e9b\u529f\u80fd\uff0c\u5176\u5b9e\u5c31\u662f\u6211\u4eec\u5e73\u5e38\u8bf4\u7684 Operator\u3002Rook \u5229\u7528\u6269\u5c55\u529f\u80fd\u5c06\u5176\u6df1\u5ea6\u96c6\u6210\u5230\u4e91\u539f\u751f\u73af\u5883\u4e2d\uff0c\u5e76\u4e3a\u8c03\u5ea6\u3001\u751f\u547d\u5468\u671f\u7ba1\u7406\u3001\u8d44\u6e90\u7ba1\u7406\u3001\u5b89\u5168\u6027\u3001\u76d1\u63a7\u7b49\u63d0\u4f9b\u4e86\u65e0\u7f1d\u7684\u4f53\u9a8c\u3002\u6709\u5173 Rook \u5f53\u524d\u652f\u6301\u7684\u5b58\u50a8\u89e3\u51b3\u65b9\u6848\u7684\u72b6\u6001\u7684\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\uff0c\u53ef\u4ee5\u53c2\u8003 Rook \u4ed3\u5e93 \u7684\u9879\u76ee\u4ecb\u7ecd\u3002</p> <p></p> <p>Rook \u5305\u542b\u591a\u4e2a\u7ec4\u4ef6\uff1a</p> <ul> <li>Rook Operator\uff1aRook \u7684\u6838\u5fc3\u7ec4\u4ef6\uff0cRook Operator \u662f\u4e00\u4e2a\u7b80\u5355\u7684\u5bb9\u5668\uff0c\u81ea\u52a8\u542f\u52a8\u5b58\u50a8\u96c6\u7fa4\uff0c\u5e76\u76d1\u63a7\u5b58\u50a8\u5b88\u62a4\u8fdb\u7a0b\uff0c\u6765\u786e\u4fdd\u5b58\u50a8\u96c6\u7fa4\u7684\u5065\u5eb7\u3002</li> <li>Rook Agent\uff1a\u5728\u6bcf\u4e2a\u5b58\u50a8\u8282\u70b9\u4e0a\u8fd0\u884c\uff0c\u5e76\u914d\u7f6e\u4e00\u4e2a FlexVolume \u6216\u8005 CSI \u63d2\u4ef6\uff0c\u548c Kubernetes \u7684\u5b58\u50a8\u5377\u63a7\u5236\u6846\u67b6\u8fdb\u884c\u96c6\u6210\u3002Agent \u5904\u7406\u6240\u6709\u7684\u5b58\u50a8\u64cd\u4f5c\uff0c\u4f8b\u5982\u6302\u63a5\u7f51\u7edc\u5b58\u50a8\u8bbe\u5907\u3001\u5728\u4e3b\u673a\u4e0a\u52a0\u8f7d\u5b58\u50a8\u5377\u4ee5\u53ca\u683c\u5f0f\u5316\u6587\u4ef6\u7cfb\u7edf\u7b49\u3002</li> <li>Rook Discovers\uff1a\u68c0\u6d4b\u6302\u63a5\u5230\u5b58\u50a8\u8282\u70b9\u4e0a\u7684\u5b58\u50a8\u8bbe\u5907\u3002</li> </ul> <p>Rook \u8fd8\u4f1a\u7528 Kubernetes Pod \u7684\u5f62\u5f0f\uff0c\u90e8\u7f72 Ceph \u7684 MON\u3001OSD \u4ee5\u53ca MGR \u5b88\u62a4\u8fdb\u7a0b\u3002Rook Operator \u8ba9\u7528\u6237\u53ef\u4ee5\u901a\u8fc7 CRD \u6765\u521b\u5efa\u548c\u7ba1\u7406\u5b58\u50a8\u96c6\u7fa4\u3002\u6bcf\u79cd\u8d44\u6e90\u90fd\u5b9a\u4e49\u4e86\u81ea\u5df1\u7684 CRD\uff1a</p> <ul> <li>RookCluster\uff1a\u63d0\u4f9b\u4e86\u5bf9\u5b58\u50a8\u673a\u7fa4\u7684\u914d\u7f6e\u80fd\u529b\uff0c\u7528\u6765\u63d0\u4f9b\u5757\u5b58\u50a8\u3001\u5bf9\u8c61\u5b58\u50a8\u4ee5\u53ca\u5171\u4eab\u6587\u4ef6\u7cfb\u7edf\u3002\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u591a\u4e2a Pool\u3002</li> <li>Pool\uff1a\u4e3a\u5757\u5b58\u50a8\u63d0\u4f9b\u652f\u6301\uff0cPool \u4e5f\u662f\u7ed9\u6587\u4ef6\u548c\u5bf9\u8c61\u5b58\u50a8\u63d0\u4f9b\u5185\u90e8\u652f\u6301\u3002</li> <li>Object Store\uff1a\u7528 S3 \u517c\u5bb9\u63a5\u53e3\u5f00\u653e\u5b58\u50a8\u670d\u52a1\u3002</li> <li>File System\uff1a\u4e3a\u591a\u4e2a Kubernetes Pod \u63d0\u4f9b\u5171\u4eab\u5b58\u50a8\u3002</li> </ul>"},{"location":"kubernetes_stroage/ceph/#_8","title":"\u73af\u5883","text":"<p>Rook Ceph \u9700\u8981\u4f7f\u7528 RBD \u5185\u6838\u6a21\u5757\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c <code>modprobe rbd</code> \u6765\u6d4b\u8bd5 Kubernetes \u8282\u70b9\u662f\u5426\u6709\u8be5\u6a21\u5757\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5219\u9700\u8981\u66f4\u65b0\u4e0b\u5185\u6838\u7248\u672c\u3002</p> <p>\u53e6\u5916\u9700\u8981\u5728\u8282\u70b9\u4e0a\u5b89\u88c5 <code>lvm2</code> \u8f6f\u4ef6\u5305\uff1a</p> <pre><code># Centos\nsudo yum install -y lvm2\n# Ubuntu\nsudo apt-get install -y lvm2\n</code></pre>"},{"location":"kubernetes_stroage/ceph/#_9","title":"\u5b89\u88c5","text":"<p>\u6211\u4eec\u8fd9\u91cc\u90e8\u7f72\u6700\u65b0\u7684 release-1.2 \u7248\u672c\u7684 Rook\uff0c\u90e8\u7f72\u6e05\u5355\u6587\u4ef6\u5730\u5740\uff1ahttps://github.com/rook/rook/tree/release-1.2/cluster/examples/kubernetes/ceph\u3002</p> <p>\u4ece\u4e0a\u9762\u94fe\u63a5\u4e2d\u4e0b\u8f7d common.yaml \u4e0e operator.yaml \u4e24\u4e2a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a</p> <pre><code># \u4f1a\u5b89\u88c5crd\u3001rbac\u76f8\u5173\u8d44\u6e90\u5bf9\u8c61\n$ kubectl apply -f common.yaml\n# \u5b89\u88c5 rook operator\n$ kubectl apply -f operator.yaml\n</code></pre> <p>\u5728\u7ee7\u7eed\u64cd\u4f5c\u4e4b\u524d\uff0c\u9a8c\u8bc1 <code>rook-ceph-operator</code> \u662f\u5426\u5904\u4e8e<code>Running</code>\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods -n rook-ceph\nNAME                                  READY   STATUS    RESTARTS   AGE\nrook-ceph-operator-6d8fb9498b-jxdwx   1/1     Running   0          34s\nrook-discover-7wpsl                   1/1     Running   0          32s\nrook-discover-8t8lv                   1/1     Running   0          32s\nrook-discover-9t497                   1/1     Running   0          32s\nrook-discover-v57rd                   1/1     Running   0          32s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Operator \u8fd0\u884c\u6210\u529f\u540e\uff0c\u8fd8\u4f1a\u6709\u4e00\u4e2a DaemonSet \u63a7\u5236\u5668\u8fd0\u884c\u5f97 rook-discover \u5e94\u7528\uff0c\u5f53 <code>Rook Operator</code> \u5904\u4e8e Running \u72b6\u6001\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u521b\u5efa Ceph \u96c6\u7fa4\u4e86\u3002\u4e3a\u4e86\u4f7f\u96c6\u7fa4\u5728\u91cd\u542f\u540e\u4e0d\u53d7\u5f71\u54cd\uff0c\u8bf7\u786e\u4fdd\u8bbe\u7f6e\u7684 <code>dataDirHostPath</code> \u5c5e\u6027\u503c\u4e3a\u6709\u6548\u5f97\u4e3b\u673a\u8def\u5f84\u3002\u66f4\u591a\u76f8\u5173\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u67e5\u770b\u96c6\u7fa4\u914d\u7f6e\u76f8\u5173\u6587\u6863\u3002</p> <p>\u521b\u5efa\u5982\u4e0b\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a(cluster.yaml)</p> <pre><code>apiVersion: ceph.rook.io/v1\nkind: CephCluster\nmetadata:\n  name: rook-ceph\n  namespace: rook-ceph\nspec:\n  cephVersion:\n    # \u6700\u65b0\u5f97 ceph \u955c\u50cf, \u53ef\u4ee5\u67e5\u770b https://hub.docker.com/r/ceph/ceph/tags\n    image: ceph/ceph:v5\n  dataDirHostPath: /var/lib/rook  # \u4e3b\u673a\u6709\u6548\u76ee\u5f55\n  mon:\n    count: 3\n  dashboard:\n    enabled: true\n  storage:\n    useAllNodes: true\n    useAllDevices: false\n    # \u91cd\u8981: Directories \u5e94\u8be5\u53ea\u5728\u9884\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\n    directories:\n    - path: /data/rook\n</code></pre> <p>\u5176\u4e2d\u6709\u51e0\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u5b57\u6bb5\uff1a</p> <ul> <li><code>dataDirHostPath</code>\uff1a\u5bbf\u4e3b\u673a\u4e0a\u7684\u76ee\u5f55\uff0c\u7528\u4e8e\u6bcf\u4e2a\u670d\u52a1\u5b58\u50a8\u914d\u7f6e\u548c\u6570\u636e\u3002\u5982\u679c\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u4f1a\u81ea\u52a8\u521b\u5efa\u8be5\u76ee\u5f55\u3002\u7531\u4e8e\u6b64\u76ee\u5f55\u5728\u4e3b\u673a\u4e0a\u4fdd\u7559\uff0c\u56e0\u6b64\u5728\u5220\u9664 Pod \u540e\u5c06\u4fdd\u7559\u8be5\u76ee\u5f55\uff0c\u53e6\u5916\u4e0d\u5f97\u4f7f\u7528\u4ee5\u4e0b\u8def\u5f84\u53ca\u5176\u4efb\u4f55\u5b50\u8def\u5f84\uff1a<code>/etc/ceph</code>\u3001<code>/rook</code> \u6216 <code>/var/log/ceph</code>\u3002</li> <li><code>useAllNodes</code>\uff1a\u7528\u4e8e\u8868\u793a\u662f\u5426\u4f7f\u7528\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u8282\u70b9\u8fdb\u884c\u5b58\u50a8\uff0c\u5982\u679c\u5728 <code>nodes</code> \u5b57\u6bb5\u4e0b\u6307\u5b9a\u4e86\u5404\u4e2a\u8282\u70b9\uff0c\u5219\u5fc5\u987b\u5c06<code>useAllNodes</code>\u8bbe\u7f6e\u4e3a false\u3002</li> <li><code>useAllDevices</code>\uff1a\u8868\u793a OSD \u662f\u5426\u81ea\u52a8\u4f7f\u7528\u8282\u70b9\u4e0a\u7684\u6240\u6709\u8bbe\u5907\uff0c\u4e00\u822c\u8bbe\u7f6e\u4e3a false\uff0c\u8fd9\u6837\u53ef\u63a7\u6027\u8f83\u9ad8</li> <li><code>directories</code>\uff1a\u4e00\u822c\u6765\u8bf4\u5e94\u8be5\u4f7f\u7528\u4e00\u5757\u88f8\u76d8\u6765\u505a\u5b58\u50a8\uff0c\u6709\u65f6\u4e3a\u4e86\u6d4b\u8bd5\u65b9\u4fbf\uff0c\u4f7f\u7528\u4e00\u4e2a\u76ee\u5f55\u4e5f\u662f\u53ef\u4ee5\u7684\uff0c\u5f53\u7136\u751f\u6210\u73af\u5883\u4e0d\u63a8\u8350\u4f7f\u7528\u76ee\u5f55\u3002</li> </ul> <p>\u9664\u4e86\u4e0a\u9762\u8fd9\u4e9b\u5b57\u6bb5\u5c5e\u6027\u4e4b\u5916\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u53ef\u4ee5\u7ec6\u7c92\u5ea6\u63a7\u5236\u5f97\u53c2\u6570\uff0c\u53ef\u4ee5\u67e5\u770b\u96c6\u7fa4\u914d\u7f6e\u76f8\u5173\u6587\u6863\u3002</p> <p>\u73b0\u5728\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 <code>CephCluster</code> \u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f cluster.yaml \ncephcluster.ceph.rook.io/rook-ceph created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0cRook Operator \u5c31\u4f1a\u6839\u636e\u6211\u4eec\u7684\u63cf\u8ff0\u4fe1\u606f\u53bb\u81ea\u52a8\u521b\u5efa Ceph \u96c6\u7fa4\u4e86\u3002</p>"},{"location":"kubernetes_stroage/ceph/#_10","title":"\u9a8c\u8bc1","text":"<p>\u8981\u9a8c\u8bc1\u96c6\u7fa4\u662f\u5426\u5904\u4e8e\u6b63\u5e38\u72b6\u6001\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Rook \u5de5\u5177\u7bb1 \u6765\u8fd0\u884c <code>ceph status</code> \u547d\u4ee4\u67e5\u770b\u3002</p> <p>Rook \u5de5\u5177\u7bb1\u662f\u4e00\u4e2a\u7528\u4e8e\u8c03\u8bd5\u548c\u6d4b\u8bd5 Rook \u7684\u5e38\u7528\u5de5\u5177\u5bb9\u5668\uff0c\u8be5\u5de5\u5177\u57fa\u4e8e CentOS \u955c\u50cf\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528 yum \u6765\u8f7b\u677e\u5b89\u88c5\u66f4\u591a\u7684\u5de5\u5177\u5305\u3002\u6211\u4eec\u8fd9\u91cc\u7528 Deployment \u63a7\u5236\u5668\u6765\u90e8\u7f72 Rook \u5de5\u5177\u7bb1\uff0c\u90e8\u7f72\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a\uff08toolbox.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: rook-ceph-tools\n  namespace: rook-ceph\n  labels:\n    app: rook-ceph-tools\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: rook-ceph-tools\n  template:\n    metadata:\n      labels:\n        app: rook-ceph-tools\n    spec:\n      dnsPolicy: ClusterFirstWithHostNet\n      containers:\n      - name: rook-ceph-tools\n        image: rook/ceph:v1\n        command: [\"/tini\"]\n        args: [\"-g\", \"--\", \"/usr/local/bin/toolbox.sh\"]\n        imagePullPolicy: IfNotPresent\n        env:\n          - name: ROOK_ADMIN_SECRET\n            valueFrom:\n              secretKeyRef:\n                name: rook-ceph-mon\n                key: admin-secret\n        securityContext:\n          privileged: true\n        volumeMounts:\n          - mountPath: /dev\n            name: dev\n          - mountPath: /sys/bus\n            name: sysbus\n          - mountPath: /lib/modules\n            name: libmodules\n          - name: mon-endpoint-volume\n            mountPath: /etc/rook\n      # \u5982\u679c\u8bbe\u7f6e hostNetwork: false,  \"rbd map\" \u547d\u4ee4\u4f1a\u88ab hang \u4f4f, \u53c2\u8003 https://github.com/rook/rook/issues/2021\n      hostNetwork: true\n      volumes:\n        - name: dev\n          hostPath:\n            path: /dev\n        - name: sysbus\n          hostPath:\n            path: /sys/bus\n        - name: libmodules\n          hostPath:\n            path: /lib/modules\n        - name: mon-endpoint-volume\n          configMap:\n            name: rook-ceph-mon-endpoints\n            items:\n            - key: data\n              path: mon-endpoints\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl apply -f toolbox.yaml\ndeployment.apps/rook-ceph-tools created\n</code></pre> <p>\u4e00\u65e6 toolbox \u7684 Pod \u8fd0\u884c\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u5165\u5230\u5de5\u5177\u7bb1\u5185\u90e8\u8fdb\u884c\u64cd\u4f5c\uff1a</p> <pre><code>$ kubectl -n rook-ceph exec -it $(kubectl -n rook-ceph get pod -l \"app=rook-ceph-tools\" -o jsonpath='{.items[0].metadata.name}') bash\n</code></pre> <p>\u5de5\u5177\u7bb1\u4e2d\u7684\u6240\u6709\u53ef\u7528\u5de5\u5177\u547d\u4ee4\u5747\u5df2\u51c6\u5907\u5c31\u7eea\uff0c\u53ef\u6ee1\u8db3\u60a8\u7684\u6545\u969c\u6392\u9664\u9700\u6c42\u3002\u4f8b\u5982\uff1a</p> <pre><code>ceph status\nceph osd status\nceph df\nrados df\n</code></pre> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u8981\u67e5\u770b\u96c6\u7fa4\u7684\u72b6\u6001\uff0c\u9700\u8981\u6ee1\u8db3\u4e0b\u9762\u7684\u6761\u4ef6\u624d\u8ba4\u4e3a\u662f\u5065\u5eb7\u7684\uff1a</p> <ul> <li>\u6240\u6709 mons \u5e94\u8be5\u8fbe\u5230\u6cd5\u5b9a\u6570\u91cf</li> <li>mgr \u5e94\u8be5\u662f\u6fc0\u6d3b\u72b6\u6001</li> <li>\u81f3\u5c11\u6709\u4e00\u4e2a OSD \u5904\u4e8e\u6fc0\u6d3b\u72b6\u6001</li> <li>\u5982\u679c\u4e0d\u662f HEALTH_OK \u72b6\u6001\uff0c\u5219\u5e94\u8be5\u67e5\u770b\u544a\u8b66\u6216\u8005\u9519\u8bef\u4fe1\u606f</li> </ul> <pre><code>$ ceph status\nceph status\n  cluster:\n    id:     dae083e6-8487-447b-b6ae-9eb321818439\n    health: HEALTH_OK\n\n  services:\n    mon: 3 daemons, quorum a,b,c (age 15m)\n    mgr: a(active, since 2m)\n    osd: 31 osds: 2 up (since 6m), 2 in (since 6m)\n\n  data:\n    pools:   0 pools, 0 pgs\n    objects: 0 objects, 0 B\n    usage:   79 GiB used, 314 GiB / 393 GiB avail\n    pgs:\n</code></pre> <p>\u5982\u679c\u7fa4\u96c6\u8fd0\u884c\u4e0d\u6b63\u5e38\uff0c\u53ef\u4ee5\u67e5\u770b Ceph \u5e38\u89c1\u95ee\u9898\u4ee5\u4e86\u89e3\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\u548c\u53ef\u80fd\u7684\u89e3\u51b3\u65b9\u6848\u3002</p>"},{"location":"kubernetes_stroage/ceph/#dashboard","title":"Dashboard","text":"<p>Ceph \u6709\u4e00\u4e2a Dashboard \u5de5\u5177\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u4e0a\u9762\u67e5\u770b\u96c6\u7fa4\u7684\u72b6\u6001\uff0c\u5305\u62ec\u603b\u4f53\u8fd0\u884c\u72b6\u6001\uff0cmgr\u3001osd \u548c\u5176\u4ed6 Ceph \u8fdb\u7a0b\u7684\u72b6\u6001\uff0c\u67e5\u770b\u6c60\u548c PG \u72b6\u6001\uff0c\u4ee5\u53ca\u663e\u793a\u5b88\u62a4\u8fdb\u7a0b\u7684\u65e5\u5fd7\u7b49\u7b49\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u4e0a\u9762\u7684 cluster CRD \u5bf9\u8c61\u4e2d\u5f00\u542f dashboard\uff0c\u8bbe\u7f6e</p> <pre><code>dashboard.enable=true\n</code></pre> <p>\u5373\u53ef\uff0c\u8fd9\u6837 Rook Operator \u5c31\u4f1a\u542f\u7528 ceph-mgr dashboard \u6a21\u5757\uff0c\u5e76\u5c06\u521b\u5efa\u4e00\u4e2a Kubernetes Service \u6765\u66b4\u9732\u8be5\u670d\u52a1\uff0c\u5c06\u542f\u7528\u7aef\u53e3 7000 \u8fdb\u884c https \u8bbf\u95ee\uff0c\u5982\u679c Ceph \u96c6\u7fa4\u90e8\u7f72\u6210\u529f\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b Dashboard \u7684 Service\uff1a</p> <pre><code>$ kubectl get svc -n rook-ceph\nNAME                         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nrook-ceph-mgr              ClusterIP   1       &lt;none&gt;        9283/TCP            3m6s\nrook-ceph-mgr-dashboard    ClusterIP   11180   &lt;none&gt;        7000/TCP            3m29s\n</code></pre> <p>\u8fd9\u91cc\u7684 rook-ceph-mgr \u670d\u52a1\u7528\u4e8e\u62a5\u544a Prometheus metrics \u6307\u6807\u6570\u636e\u7684\uff0c\u800c\u540e\u9762\u7684\u7684 rook-ceph-mgr-dashboard \u670d\u52a1\u5c31\u662f\u6211\u4eec\u7684 Dashboard \u670d\u52a1\uff0c\u5982\u679c\u5728\u96c6\u7fa4\u5185\u90e8\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 DNS \u540d\u79f0 </p> <pre><code>http://rook-ceph-mgr-dashboard.rook-ceph:7000\n</code></pre> <p>\u6216\u8005 CluterIP </p> <pre><code>http://11180:7000\n</code></pre> <p>\u6765\u8fdb\u884c\u8bbf\u95ee\uff0c\u4f46\u662f\u5982\u679c\u8981\u5728\u96c6\u7fa4\u5916\u90e8\u8fdb\u884c\u8bbf\u95ee\u7684\u8bdd\uff0c\u6211\u4eec\u5c31\u9700\u8981\u901a\u8fc7 Ingress \u6216\u8005 NodePort \u7c7b\u578b\u7684 Service \u6765\u66b4\u9732\u4e86\uff0c\u4e3a\u4e86\u65b9\u4fbf\u6d4b\u8bd5\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 NodePort \u7c7b\u578b\u7684\u670d\u52a1\u6765\u8bbf\u95ee Dashboard\uff0c\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a\uff08dashboard-external.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: rook-ceph-mgr-dashboard-external\n  namespace: rook-ceph\n  labels:\n    app: rook-ceph-mgr\n    rook_cluster: rook-ceph\nspec:\n  ports:\n  - name: dashboard\n    port: 7000\n    protocol: TCP\n    targetPort: 7000\n  selector:\n    app: rook-ceph-mgr\n    rook_cluster: rook-ceph\n  type: NodePort\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f dashboard-external.yaml\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5230\u65b0\u521b\u5efa\u7684 rook-ceph-mgr-dashboard-external \u8fd9\u4e2a Service \u670d\u52a1\uff1a</p> <pre><code>$ kubectl get svc -n rook-ceph \nNAME                                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nrook-ceph-mgr                           ClusterIP   29     &lt;none&gt;        9283/TCP            23m\nrook-ceph-mgr-dashboard                 ClusterIP   198     &lt;none&gt;        7000/TCP            23m\nrook-ceph-mgr-dashboard-external   NodePort    1223    &lt;none&gt;        7000:31361/TCP      14s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u9700\u8981\u901a\u8fc7 </p> <pre><code>http://&lt;NodeIp&gt;:31361\n</code></pre> <p>\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230 Dashboard \u4e86\u3002</p> <p></p> <p>\u4f46\u662f\u5728\u8bbf\u95ee\u7684\u65f6\u5019\u9700\u8981\u6211\u4eec\u767b\u5f55\u624d\u80fd\u591f\u8bbf\u95ee\uff0cRook \u521b\u5efa\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u7684\u7528\u6237 admin\uff0c\u5e76\u5728\u8fd0\u884c Rook \u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u751f\u6210\u4e86\u4e00\u4e2a\u540d\u4e3a </p> <pre><code>rook-ceph-dashboard-admin-password\n</code></pre> <p>\u7684 Secret\uff0c\u8981\u83b7\u53d6\u5bc6\u7801\uff0c\u53ef\u4ee5\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath=\"{['data']['password']}\" | base64 --decode &amp;&amp; echo\nxxxx\uff08\u767b\u5f55\u5bc6\u7801\uff09\n</code></pre> <p>\u7528\u4e0a\u9762\u83b7\u5f97\u7684\u5bc6\u7801\u548c\u7528\u6237\u540d admin \u5c31\u53ef\u4ee5\u767b\u5f55 Dashboard \u4e86\uff0c\u5728 Dashboard \u4e0a\u9762\u53ef\u4ee5\u67e5\u770b\u5230\u6574\u4e2a\u96c6\u7fa4\u7684\u72b6\u6001\uff1a</p> <p></p>"},{"location":"kubernetes_stroage/ceph/#_11","title":"\u4f7f\u7528","text":"<p>\u73b0\u5728\u6211\u4eec\u7684 Ceph \u96c6\u7fa4\u642d\u5efa\u6210\u529f\u4e86\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u6765\u4f7f\u7528\u5b58\u50a8\u4e86\u3002\u9996\u5148\u6211\u4eec\u9700\u8981\u521b\u5efa\u5b58\u50a8\u6c60\uff0c\u53ef\u4ee5\u7528 CRD \u6765\u5b9a\u4e49 Pool\u3002Rook \u63d0\u4f9b\u4e86\u4e24\u79cd\u673a\u5236\u6765\u7ef4\u6301 OSD\uff1a</p> <ul> <li>\u526f\u672c\uff1a\u7f3a\u7701\u9009\u9879\uff0c\u6bcf\u4e2a\u5bf9\u8c61\u90fd\u4f1a\u6839\u636e <code>spec.replicated.size</code> \u5728\u591a\u4e2a\u78c1\u76d8\u4e0a\u8fdb\u884c\u590d\u5236\u3002\u5efa\u8bae\u975e\u751f\u4ea7\u73af\u5883\u81f3\u5c11 2 \u4e2a\u526f\u672c\uff0c\u751f\u4ea7\u73af\u5883\u81f3\u5c11 3 \u4e2a\u3002</li> <li> <p>Erasure Code\uff1a\u662f\u4e00\u79cd\u8f83\u4e3a\u8282\u7ea6\u7684\u65b9\u5f0f\u3002EC \u628a\u6570\u636e\u62c6\u5206 n \u6bb5\uff08</p> <pre><code>spec.erasureCoded.dataChunks\n</code></pre> <p>\uff09\uff0c\u518d\u52a0\u5165 k \u4e2a\u4ee3\u7801\u6bb5\uff08</p> <pre><code>spec.erasureCoded.codingChunks\n</code></pre> <p>\uff09\uff0c\u7528\u5206\u5e03\u7684\u65b9\u5f0f\u628a <code>n+k</code> \u6bb5\u6570\u636e\u4fdd\u5b58\u5728\u78c1\u76d8\u4e0a\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b Ceph \u80fd\u591f\u9694\u79bb k \u4e2a OSD \u7684\u635f\u5931\u3002</p> </li> </ul> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u526f\u672c\u7684\u65b9\u5f0f\uff0c\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684 RBD \u7c7b\u578b\u7684\u5b58\u50a8\u6c60\uff1a(pool.yaml)</p> <pre><code>apiVersion: ceph.rook.io/v1\nkind: CephBlockPool\nmetadata:\n  name: k8s-test-pool   # operator\u4f1a\u76d1\u542c\u5e76\u521b\u5efa\u4e00\u4e2apool\uff0c\u6267\u884c\u5b8c\u540e\u754c\u9762\u4e0a\u4e5f\u80fd\u770b\u5230\u5bf9\u5e94\u7684pool\n  namespace: rook-ceph\nspec:\n  failureDomain: host  # \u6570\u636e\u5757\u7684\u6545\u969c\u57df: \u503c\u4e3ahost\u65f6\uff0c\u6bcf\u4e2a\u6570\u636e\u5757\u5c06\u653e\u7f6e\u5728\u4e0d\u540c\u7684\u4e3b\u673a\u4e0a;\u503c\u4e3aosd\u65f6\uff0c\u6bcf\u4e2a\u6570\u636e\u5757\u5c06\u653e\u7f6e\u5728\u4e0d\u540c\u7684osd\u4e0a\n  replicated:\n    size: 3   # \u6c60\u4e2d\u6570\u636e\u7684\u526f\u672c\u6570,1\u5c31\u662f\u4e0d\u4fdd\u5b58\u4efb\u4f55\u526f\u672c\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pool.yaml \ncephblockpool.ceph.rook.io/k8s-test-pool created\n</code></pre> <p>\u5b58\u50a8\u6c60\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u5728 Dashboard \u4e0a\u9762\u7684\u786e\u53ef\u4ee5\u770b\u5230\u65b0\u589e\u4e86\u4e00\u4e2a pool\uff0c\u4f46\u662f\u4f1a\u53d1\u73b0\u96c6\u7fa4\u5065\u5eb7\u72b6\u6001\u53d8\u6210\u4e86 <code>WARN</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5230\u6709\u5982\u4e0b\u65e5\u5fd7\u51fa\u73b0\uff1a</p> <pre><code>Health check update: too few PGs per OSD (6 &lt; min 30) (TOO_FEW_PGS)\n</code></pre> <p>\u8fd9\u662f\u56e0\u4e3a\u6bcf\u4e2a osd \u4e0a\u7684 pg \u6570\u91cf\u5c0f\u4e8e\u6700\u5c0f\u7684\u6570\u76ee30\u4e2a\u3002pgs \u4e3a8\uff0c\u56e0\u4e3a\u662f3\u526f\u672c\u7684\u914d\u7f6e\uff0c\u6240\u4ee5\u5f53\u67094\u4e2a osd \u7684\u65f6\u5019\uff0c\u6bcf\u4e2a osd \u4e0a\u5747\u5206\u4e868/4 *3=6\u4e2apgs\uff0c\u4e5f\u5c31\u662f\u51fa\u73b0\u4e86\u5982\u4e0a\u7684\u9519\u8bef\u5c0f\u4e8e\u6700\u5c0f\u914d\u7f6e30\u4e2a\uff0c\u96c6\u7fa4\u8fd9\u79cd\u72b6\u6001\u5982\u679c\u8fdb\u884c\u6570\u636e\u7684\u5b58\u50a8\u548c\u64cd\u4f5c\uff0c\u96c6\u7fa4\u4f1a\u5361\u6b7b\uff0c\u65e0\u6cd5\u54cd\u5e94io\uff0c\u540c\u65f6\u4f1a\u5bfc\u81f4\u5927\u9762\u79ef\u7684 osd down\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u8fdb\u5165 toolbox \u7684\u5bb9\u5668\u4e2d\u67e5\u770b\u4e0a\u9762\u5b58\u50a8\u7684 pg \u6570\u91cf\uff1a</p> <pre><code>$ ceph osd pool get k8s-test-pool pg_num\npg_num: 8\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u589e\u52a0 pg_num \u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff1a</p> <pre><code>$ ceph osd pool set k8s-test-pool pg_num 64\nset pool 1 pg_num to 64\n$ ceph -s\n  cluster:\n    id:     7851387c-5d18-489a-8c04-b699fb9764c0\n    health: HEALTH_OK\n\n  services:\n    mon: 3 daemons, quorum a,b,c (age 33m)\n    mgr: a(active, since 32m)\n    osd: 4 osds: 4 up (since 32m), 4 in (since 32m)\n\n  data:\n    pools:   1 pools, 64 pgs\n    objects: 0 objects, 0 B\n    usage:   182 GiB used, 605 GiB / 787 GiB avail\n    pgs:     64 active+clean\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u67e5\u770b\u5c31\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u5c31\u662f\u5065\u5eb7\u72b6\u6001\u4e86\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u7684 pool \u4e0a\u6ca1\u6709\u6570\u636e\uff0c\u6240\u4ee5\u4fee\u6539 pg \u5f71\u54cd\u5e76\u4e0d\u5927\uff0c\u4f46\u662f\u5982\u679c\u662f\u751f\u4ea7\u73af\u5883\u91cd\u65b0\u4fee\u6539 pg \u6570\uff0c\u4f1a\u5bf9\u751f\u4ea7\u73af\u5883\u4ea7\u751f\u8f83\u5927\u5f71\u54cd\u3002\u56e0\u4e3a pg \u6570\u53d8\u4e86\uff0c\u5c31\u4f1a\u5bfc\u81f4\u6574\u4e2a\u96c6\u7fa4\u7684\u6570\u636e\u91cd\u65b0\u5747\u8861\u548c\u8fc1\u79fb\uff0c\u6570\u636e\u8d8a\u5927\u54cd\u5e94 io \u7684\u65f6\u95f4\u4f1a\u8d8a\u957f\u3002\u6240\u4ee5\uff0c\u6700\u597d\u5728\u4e00\u5f00\u59cb\u5c31\u8bbe\u7f6e\u597d pg \u6570\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a StorageClass \u6765\u8fdb\u884c\u52a8\u6001\u5b58\u50a8\u914d\u7f6e\uff0c\u5982\u4e0b\u6240\u793a\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a Ceph \u7684\u5757\u5b58\u50a8\u7684 StorageClass\uff1a(storageclass.yaml)</p> <pre><code>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: rook-ceph-block\nprovisioner: rook-ceph.rbd.csi.ceph.com\nparameters:\n  # clusterID \u662f rook \u96c6\u7fa4\u8fd0\u884c\u7684\u547d\u540d\u7a7a\u95f4\n  clusterID: rook-ceph\n\n  # \u6307\u5b9a\u5b58\u50a8\u6c60\n  pool: k8s-test-pool\n\n  # RBD image (\u5b9e\u9645\u7684\u5b58\u50a8\u4ecb\u8d28) \u683c\u5f0f. \u9ed8\u8ba4\u4e3a \"2\".\n  imageFormat: \"2\"\n\n  # RBD image \u7279\u6027. CSI RBD \u73b0\u5728\u53ea\u652f\u6301 `layering` .\n  imageFeatures: layering\n\n  # Ceph \u7ba1\u7406\u5458\u8ba4\u8bc1\u4fe1\u606f\uff0c\u8fd9\u4e9b\u90fd\u662f\u5728 clusterID \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u81ea\u52a8\u751f\u6210\u7684\n  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner\n  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph\n  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node\n  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph\n  # \u6307\u5b9a volume \u7684\u6587\u4ef6\u7cfb\u7edf\u683c\u5f0f\uff0c\u5982\u679c\u4e0d\u6307\u5b9a, csi-provisioner \u4f1a\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a `ext4`\n  csi.storage.k8s.io/fstype: ext4\n# uncomment the following to use rbd-nbd as mounter on supported nodes\n# **IMPORTANT**: If you are using rbd-nbd as the mounter, during upgrade you will be hit a ceph-csi\n# issue that causes the mount to be disconnected. You will need to follow special upgrade steps\n# to restart your application pods. Therefore, this option is not recommended.\n#mounter: rbd-nbd\nreclaimPolicy: Delete\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 StorageClass \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f storageclass.yaml \nstorageclass.storage.k8s.io/rook-ceph-block created\n$ kubectl get storageclass\nNAME              PROVISIONER                    AGE\nrook-ceph-block   rook-ceph.rbd.csi.ceph.com     35s\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a PVC \u6765\u4f7f\u7528\u4e0a\u9762\u7684 StorageClass \u5bf9\u8c61\uff1a(pvc.yaml)</p> <pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: mysql-pv-claim\n  labels:\n    app: wordpress\nspec:\n  storageClassName: rook-ceph-block\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 20Gi\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 PVC \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pvc.yaml \npersistentvolumeclaim/mysql-pv-claim created\n$ kubectl get pvc -l app=wordpress\nNAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE\nmysql-pv-claim   Bound    pvc-1eab82e3-d214-4d8e-8fcc-ed379c24e0e3   20Gi       RWO            rook-ceph-block   32m\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u7684 PVC \u5bf9\u8c61\u5df2\u7ecf\u662f Bound \u72b6\u6001\u4e86\uff0c\u81ea\u52a8\u521b\u5efa\u4e86\u5bf9\u5e94\u7684 PV\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a PVC \u5bf9\u8c61\u6765\u505a\u6570\u636e\u6301\u4e45\u5316\u64cd\u4f5c\u4e86\u3002</p> <p>\u8fd9\u4e2a\u65f6\u5019\u53ef\u80fd\u96c6\u7fa4\u8fd8\u4f1a\u51fa\u73b0\u5982\u4e0b\u7684\u5065\u5eb7\u63d0\u793a\uff1a</p> <pre><code>$ ceph health detail\nHEALTH_WARN application not enabled on 1 pool(s)\nPOOL_APP_NOT_ENABLED application not enabled on 1 pool(s)\n    application not enabled on pool 'k8s-test-pool'\n    use 'ceph osd pool application enable &lt;pool-name&gt; &lt;app-name&gt;', where &lt;app-name&gt; is 'cephfs', 'rbd', 'rgw', or freeform for custom applications.\n$ ceph osd pool application enable k8s-test-pool k8srbd\nenabled application 'k8srbd' on pool 'k8s-test-pool'\n</code></pre> <p>\u6839\u636e\u63d0\u793a\u542f\u7528\u4e00\u4e2a application \u5373\u53ef\u3002</p> <p>\u5728\u5b98\u65b9\u4ed3\u5e93 cluster/examples/kubernetes \u76ee\u5f55\u4e0b\uff0c\u5b98\u65b9\u7ed9\u4e86\u4e2a wordpress \u7684\u4f8b\u5b50\uff0c\u53ef\u4ee5\u76f4\u63a5\u8fd0\u884c\u6d4b\u8bd5\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f mysql.yaml\n$ kubectl apply -f wordpress.yaml\n</code></pre> <p>\u5b98\u65b9\u7684\u8fd9\u4e2a\u793a\u4f8b\u91cc\u9762\u7684 wordpress \u7528\u7684 Loadbalancer \u7c7b\u578b\uff0c\u6211\u4eec\u53ef\u4ee5\u6539\u6210 NodePort\uff1a</p> <pre><code>$ kubectl get pvc -l app=wordpress\nNAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE\nmysql-pv-claim   Bound    pvc-1eab82e3-d214-4d8e-8fcc-ed379c24e0e3   20Gi       RWO            rook-ceph-block   12h\nwp-pv-claim      Bound    pvc-237932ed-5ca7-468c-bd16-220ebb2a1ce3   20Gi       RWO            rook-ceph-block   25s\n$ kubectl get pods -l app=wordpress               \nNAME                              READY   STATUS    RESTARTS   AGE\nwordpress-5b886cf59b-4xwn8        1/1     Running   0          24m\nwordpress-mysql-b9ddd6d4c-qhjd4   1/1     Running   0          24m\n$ kubectl get svc -l app=wordpress\nNAME              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\nwordpress         NodePort    12225   &lt;none&gt;        80:30307/TCP   80s\nwordpress-mysql   ClusterIP   None             &lt;none&gt;        3306/TCP       87s\n</code></pre> <p>\u5f53\u5e94\u7528\u90fd\u5904\u4e8e Running \u72b6\u6001\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>http://&lt;\u4efb\u610f\u8282\u70b9IP&gt;:30307\n</code></pre> <p>\u53bb\u8bbf\u95ee wordpress \u5e94\u7528\uff1a</p> <p></p> <p>\u6bd4\u5982\u6211\u4eec\u5728\u7b2c\u4e00\u7bc7\u6587\u7ae0\u4e2d\u66f4\u6539\u4e0b\u5185\u5bb9\uff0c\u7136\u540e\u6211\u4eec\u5c06\u5e94\u7528 Pod \u5168\u90e8\u5220\u9664\u91cd\u5efa\uff1a</p> <pre><code>$ kubectl delete pod wordpress-mysql-b9ddd6d4c-qhjd4 wordpress-5b886cf59b-4xwn8\npod \"wordpress-mysql-b9ddd6d4c-qhjd4\" deleted\npod \"wordpress-5b886cf59b-4xwn8\" deleted\n$ kubectl get pods -l app=wordpress                                            \nNAME                              READY   STATUS    RESTARTS   AGE\nwordpress-5b886cf59b-kwxk4        1/1     Running   0          2m52s\nwordpress-mysql-b9ddd6d4c-kkcr7   1/1     Running   0          2m52s\n</code></pre> <p>\u5f53 Pod \u91cd\u5efa\u5b8c\u6210\u540e\u518d\u6b21\u8bbf\u95ee wordpress \u5e94\u7528\u7684\u4e3b\u9875\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u4e4b\u524d\u6211\u4eec\u6dfb\u52a0\u7684\u6570\u636e\u4ecd\u7136\u5b58\u5728\uff0c\u8fd9\u5c31\u8bc1\u660e\u6211\u4eec\u7684\u6570\u636e\u6301\u4e45\u5316\u662f\u6b63\u786e\u7684\u3002</p>"},{"location":"kubernetes_stroage/csi/","title":"\u5b58\u50a8\u539f\u7406","text":""},{"location":"kubernetes_stroage/csi/#_1","title":"\u5b58\u50a8\u539f\u7406","text":"<p>\u524d\u9762\u7684\u7ae0\u8282\u4e2d\u6211\u4eec\u4ecb\u7ecd\u4e86\u5728 Kubernetes \u4e2d\u7684\u6301\u4e45\u5316\u5b58\u50a8\u7684\u4f7f\u7528\uff0c\u4e86\u89e3\u4e86 PV\u3001PVC \u4ee5\u53ca StorageClass \u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u4ece\u672c\u5730\u5b58\u50a8\u5230 Ceph \u5171\u4eab\u5b58\u50a8\u90fd\u6709\u5b66\u4e60\uff0c\u5230\u8fd9\u91cc\u6211\u4eec\u5176\u5b9e\u5df2\u7ecf\u53ef\u4ee5\u5b8c\u6210\u5e94\u7528\u5404\u79cd\u573a\u666f\u7684\u6570\u636e\u6301\u4e45\u5316\u4e86\uff0c\u4f46\u662f\u96be\u514d\u5728\u5b9e\u9645\u7684\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u4f1a\u9047\u5230\u5404\u79cd\u5404\u6837\u7684\u95ee\u9898\uff0c\u8981\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\u6700\u597d\u7684\u65b9\u5f0f\u5c31\u662f\u6765\u4e86\u89e3\u4e0b Kubernetes \u4e2d\u5b58\u50a8\u7684\u5b9e\u73b0\u539f\u7406\u3002</p> <p>Kubernetes \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5c31\u63d0\u4f9b\u4e86\u4e3b\u6d41\u7684\u5b58\u50a8\u5377\u63a5\u5165\u65b9\u6848\uff0c\u6211\u4eec\u53ef\u4ee5\u6267\u884c\u547d\u4ee4 </p> <pre><code>kubectl explain pod.spec.volumes\n</code></pre> <p>\u67e5\u770b\u5230\u652f\u6301\u7684\u5404\u79cd\u5b58\u50a8\u5377\uff0c\u53e6\u5916\u4e5f\u63d0\u4f9b\u4e86\u63d2\u4ef6\u673a\u5236\uff0c\u5141\u8bb8\u5176\u4ed6\u7c7b\u578b\u7684\u5b58\u50a8\u670d\u52a1\u63a5\u5165\u5230 Kubernetes \u7cfb\u7edf\u4e2d\u6765\uff0c\u5728 Kubernetes \u4e2d\u5c31\u5bf9\u5e94 <code>In-Tree</code> \u548c <code>Out-Of-Tree</code> \u4e24\u79cd\u65b9\u5f0f\uff0c<code>In-Tree</code> \u5c31\u662f\u5728 Kubernetes \u6e90\u7801\u5185\u90e8\u5b9e\u73b0\u7684\uff0c\u548c Kubernetes \u4e00\u8d77\u53d1\u5e03\u3001\u7ba1\u7406\u7684\uff0c\u4f46\u662f\u66f4\u65b0\u8fed\u4ee3\u6162\u3001\u7075\u6d3b\u6027\u6bd4\u8f83\u5dee\uff0c<code>Out-Of-Tree</code> \u662f\u72ec\u7acb\u4e8e Kubernetes \u7684\uff0c\u76ee\u524d\u4e3b\u8981\u6709 <code>CSI</code> \u548c <code>FlexVolume</code> \u4e24\u79cd\u673a\u5236\uff0c\u5f00\u53d1\u8005\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u5b58\u50a8\u7c7b\u578b\u5b9e\u73b0\u4e0d\u540c\u7684\u5b58\u50a8\u63d2\u4ef6\u63a5\u5165\u5230 Kubernetes \u4e2d\u53bb\uff0c\u5176\u4e2d <code>CSI</code> \u662f\u73b0\u5728\u4e5f\u662f\u4ee5\u540e\u4e3b\u6d41\u7684\u65b9\u5f0f\uff0c\u6240\u4ee5\u5f53\u7136\u6211\u4eec\u7684\u91cd\u70b9\u4e5f\u4f1a\u662f <code>CSI</code> \u7684\u4f7f\u7528\u4ecb\u7ecd\u3002</p>"},{"location":"kubernetes_stroage/csi/#_2","title":"\u5b58\u50a8\u67b6\u6784","text":"<p>\u524d\u9762\u6211\u4eec\u4e86\u89e3\u5230\u4e86 PV\u3001PVC\u3001StorgeClass \u7684\u4f7f\u7528\uff0c\u4f46\u662f\u4ed6\u4eec\u662f\u5982\u4f55\u548c\u6211\u4eec\u7684 Pod \u5173\u8054\u8d77\u6765\u4f7f\u7528\u7684\u5462\uff1f\u8fd9\u5c31\u9700\u8981\u4ece Volume \u7684\u5904\u7406\u6d41\u7a0b\u548c\u539f\u7406\u8bf4\u8d77\u4e86\u3002</p> <p>\u5982\u4e0b\u6240\u793a\uff0c\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a nfs \u7c7b\u578b\u7684 PV \u8d44\u6e90\u5bf9\u8c61\uff1a\uff08volume.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: nfs-pv\nspec:\n  storageClassName: manual\n  capacity: \n    storage: 1Gi\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Retain\n  nfs:\n    path: /data/k8s  # \u6307\u5b9anfs\u7684\u6302\u8f7d\u70b9\n    server: 111  # \u6307\u5b9anfs\u670d\u52a1\u5730\u5740\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: nfs-pvc\nspec:\n  storageClassName: manual\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 1Gi\n</code></pre> <p>\u6211\u4eec\u77e5\u9053\u7528\u6237\u771f\u6b63\u4f7f\u7528\u7684\u662f PVC\uff0c\u800c\u8981\u4f7f\u7528 PVC \u7684\u524d\u63d0\u5c31\u662f\u5fc5\u987b\u8981\u5148\u548c\u67d0\u4e2a\u7b26\u5408\u6761\u4ef6\u7684 PV \u8fdb\u884c\u4e00\u4e00\u7ed1\u5b9a\uff0c\u6bd4\u5982\u5b58\u50a8\u5bb9\u5668\u3001\u8bbf\u95ee\u6a21\u5f0f\uff0c\u4ee5\u53ca PV \u548c PVC \u7684 storageClassName \u5b57\u6bb5\u5fc5\u987b\u4e00\u6837\uff0c\u8fd9\u6837\u624d\u80fd\u591f\u8fdb\u884c\u7ed1\u5b9a\uff0c\u5f53 PVC \u548c PV \u7ed1\u5b9a\u6210\u529f\u540e\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a PVC \u5bf9\u8c61\u4e86\uff1a(pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: test-volumes\nspec:\n  volumes:\n  - name: nfs\n    persistentVolumeClaim:\n      claimName: nfs-pvc\n  containers:\n  - name: web\n    image: nginx\n    ports:\n    - name: web\n      containerPort: 80\n    volumeMounts:\n    - name: nfs\n      subPath: test-volumes\n      mountPath: \"/usr/share/nginx/html\"\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f volume.yaml\n$ kubectl apply -f pod.yaml\n</code></pre> <p>\u6211\u4eec\u53ea\u662f\u5728 volumes \u4e2d\u6307\u5b9a\u4e86\u6211\u4eec\u4e0a\u9762\u521b\u5efa\u7684 PVC \u5bf9\u8c61\uff0c\u5f53\u8fd9\u4e2a Pod \u88ab\u521b\u5efa\u4e4b\u540e\uff0c kubelet \u5c31\u4f1a\u628a\u8fd9\u4e2a PVC \u5bf9\u5e94\u7684\u8fd9\u4e2a NFS \u7c7b\u578b\u7684 Volume\uff08PV\uff09\u6302\u8f7d\u5230\u8fd9\u4e2a Pod \u5bb9\u5668\u4e2d\u7684\u76ee\u5f55\u4e2d\u53bb\u3002\u524d\u9762\u6211\u4eec\u4e5f\u63d0\u5230\u4e86\u8fd9\u6837\u7684\u8bdd\u5bf9\u4e8e\u666e\u901a\u7528\u6237\u6765\u8bf4\u5b8c\u5168\u5c31\u4e0d\u7528\u5173\u5fc3\u540e\u9762\u7684\u5177\u4f53\u5b58\u50a8\u5728 NFS \u8fd8\u662f Ceph \u6216\u8005\u5176\u4ed6\u4e86\uff0c\u53ea\u9700\u8981\u76f4\u63a5\u4f7f\u7528 PVC \u5c31\u53ef\u4ee5\u4e86\uff0c\u56e0\u4e3a\u771f\u6b63\u7684\u5b58\u50a8\u662f\u9700\u8981\u5f88\u591a\u76f8\u5173\u7684\u4e13\u4e1a\u77e5\u8bc6\u7684\uff0c\u8fd9\u6837\u5c31\u5b8c\u5168\u804c\u8d23\u5206\u79bb\u89e3\u8026\u4e86\u3002</p> <p>\u666e\u901a\u7528\u6237\u76f4\u63a5\u4f7f\u7528 PVC \u6ca1\u6709\u95ee\u9898\uff0c\u4f46\u662f\u4e5f\u4f1a\u51fa\u73b0\u4e00\u4e2a\u95ee\u9898\uff0c\u90a3\u5c31\u662f\u5f53\u666e\u901a\u7528\u6237\u521b\u5efa\u4e00\u4e2a PVC \u5bf9\u8c61\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u65f6\u5019\u7cfb\u7edf\u91cc\u9762\u5e76\u6ca1\u6709\u5408\u9002\u7684 PV \u6765\u548c\u5b83\u8fdb\u884c\u7ed1\u5b9a\uff0c\u56e0\u4e3a PV \u5927\u591a\u6570\u60c5\u51b5\u4e0b\u662f\u7ba1\u7406\u5458\u7ed9\u6211\u4eec\u521b\u5efa\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u542f\u52a8 Pod \u80af\u5b9a\u5c31\u4f1a\u5931\u8d25\u4e86\uff0c\u5982\u679c\u73b0\u5728\u7ba1\u7406\u5458\u5982\u679c\u53bb\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 PV \u7684\u8bdd\uff0cPVC \u548c PV \u5f53\u7136\u5c31\u53ef\u4ee5\u7ed1\u5b9a\u4e86\uff0c\u7136\u540e Pod \u4e5f\u4f1a\u81ea\u52a8\u7684\u542f\u52a8\u6210\u529f\uff0c\u8fd9\u662f\u56e0\u4e3a\u5728 Kubernetes \u4e2d\u6709\u4e00\u4e2a\u4e13\u95e8\u5904\u7406\u6301\u4e45\u5316\u5b58\u50a8\u7684\u63a7\u5236\u5668 Volume Controller\uff0c\u8fd9\u4e2a\u63a7\u5236\u5668\u4e0b\u9762\u6709\u5f88\u591a\u4e2a\u63a7\u5236\u5faa\u73af\uff0c\u5176\u4e2d\u4e00\u4e2a\u5c31\u662f\u7528\u4e8e PV \u548c PVC \u7ed1\u5b9a\u7684 PersistentVolumeController\u3002</p> <p>PersistentVolumeController \u4f1a\u4e0d\u65ad\u5730\u5faa\u73af\u53bb\u67e5\u770b\u6bcf\u4e00\u4e2a PVC\uff0c\u662f\u4e0d\u662f\u5df2\u7ecf\u5904\u4e8e Bound\uff08\u5df2\u7ed1\u5b9a\uff09\u72b6\u6001\u3002\u5982\u679c\u4e0d\u662f\uff0c\u90a3\u5b83\u5c31\u4f1a\u904d\u5386\u6240\u6709\u7684\u3001\u53ef\u7528\u7684 PV\uff0c\u5e76\u5c1d\u8bd5\u5c06\u5176\u4e0e\u672a\u7ed1\u5b9a\u7684 PVC \u8fdb\u884c\u7ed1\u5b9a\uff0c\u8fd9\u6837\uff0cKubernetes \u5c31\u53ef\u4ee5\u4fdd\u8bc1\u7528\u6237\u63d0\u4ea4\u7684\u6bcf\u4e00\u4e2a PVC\uff0c\u53ea\u8981\u6709\u5408\u9002\u7684 PV \u51fa\u73b0\uff0c\u5b83\u5c31\u80fd\u591f\u5f88\u5feb\u8fdb\u5165\u7ed1\u5b9a\u72b6\u6001\u3002\u800c\u6240\u8c13\u5c06\u4e00\u4e2a PV \u4e0e PVC \u8fdb\u884c<code>\u7ed1\u5b9a</code>\uff0c\u5176\u5b9e\u5c31\u662f\u5c06\u8fd9\u4e2a PV \u5bf9\u8c61\u7684\u540d\u5b57\uff0c\u586b\u5728\u4e86 PVC \u5bf9\u8c61\u7684 <code>spec.volumeName</code> \u5b57\u6bb5\u4e0a\u3002</p> <p>PV \u548c PVC \u7ed1\u5b9a\u4e0a\u4e86\uff0c\u90a3\u4e48\u53c8\u662f\u5982\u4f55\u5c06\u5bb9\u5668\u91cc\u9762\u7684\u6570\u636e\u8fdb\u884c\u6301\u4e45\u5316\u7684\u5462\uff0c\u524d\u9762\u6211\u4eec\u5b66\u4e60\u8fc7 Docker \u7684 Volume \u6302\u8f7d\uff0c\u5176\u5b9e\u5c31\u662f<code>\u5c06\u4e00\u4e2a\u5bbf\u4e3b\u673a\u4e0a\u7684\u76ee\u5f55\u548c\u4e00\u4e2a\u5bb9\u5668\u91cc\u7684\u76ee\u5f55\u7ed1\u5b9a\u6302\u8f7d\u5728\u4e86\u4e00\u8d77</code>\uff0c\u5177\u6709\u6301\u4e45\u5316\u529f\u80fd\u5f53\u7136\u5c31\u662f\u6307\u7684\u5bbf\u4e3b\u673a\u4e0a\u9762\u7684\u8fd9\u4e2a\u76ee\u5f55\u4e86\uff0c\u5f53\u5bb9\u5668\u88ab\u5220\u9664\u6216\u8005\u5728\u5176\u4ed6\u8282\u70b9\u4e0a\u91cd\u5efa\u51fa\u6765\u4ee5\u540e\uff0c\u8fd9\u4e2a\u76ee\u5f55\u91cc\u9762\u7684\u5185\u5bb9\u4f9d\u7136\u5b58\u5728\uff0c\u6240\u4ee5\u4e00\u822c\u60c5\u51b5\u4e0b\u5b9e\u73b0\u6301\u4e45\u5316\u662f\u9700\u8981\u4e00\u4e2a\u8fdc\u7a0b\u5b58\u50a8\u7684\uff0c\u6bd4\u5982 NFS\u3001Ceph \u6216\u8005\u4e91\u5382\u5546\u63d0\u4f9b\u7684\u78c1\u76d8\u7b49\u7b49\u3002\u6240\u4ee5\u63a5\u4e0b\u6765\u9700\u8981\u505a\u7684\u5c31\u662f\u6301\u4e45\u5316\u5bbf\u4e3b\u673a\u76ee\u5f55\u8fd9\u4e2a\u8fc7\u7a0b\u3002</p> <p>\u5f53 Pod \u88ab\u8c03\u5ea6\u5230\u4e00\u4e2a\u8282\u70b9\u4e0a\u540e\uff0c\u8282\u70b9\u4e0a\u7684 kubelet \u7ec4\u4ef6\u5c31\u4f1a\u4e3a\u8fd9\u4e2a Pod \u521b\u5efa\u5b83\u7684 Volume \u76ee\u5f55\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b kubelet \u4e3a Volume \u521b\u5efa\u7684\u76ee\u5f55\u5728 kubelet \u5de5\u4f5c\u76ee\u5f55\u4e0b\u9762\uff1a</p> <pre><code>/var/lib/kubelet/pods/&lt;Pod\u7684ID&gt;/volumes/kubernetes.io~&lt;Volume\u7c7b\u578b&gt;/&lt;Volume\u540d\u5b57&gt;\n</code></pre> <p>\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684 Pod \u5bf9\u5e94\u7684 Volume \u76ee\u5f55\u5b8c\u6574\u8def\u5f84\u4e3a\uff1a</p> <pre><code>/var/lib/kubelet/pods/d4fcdb11-baf7-43d9-8d7d-3ede24118e08/volumes/kubernetes.io~nfs/nfs-pv\n</code></pre> <p>\u63d0\u793a</p> <p>\u8981\u83b7\u53d6 Pod \u7684\u552f\u4e00\u6807\u8bc6 uid\uff0c\u53ef\u901a\u8fc7\u547d\u4ee4 </p> <pre><code>kubectl get pod pod\u540d -o jsonpath={.metadata.uid}\n</code></pre> <p>\u83b7\u53d6\u3002</p> <p>\u7136\u540e\u5c31\u9700\u8981\u6839\u636e\u6211\u4eec\u7684 Volume \u7c7b\u578b\u6765\u51b3\u5b9a\u9700\u8981\u505a\u4ec0\u4e48\u64cd\u4f5c\u4e86\uff0c\u6bd4\u5982\u4e0a\u8282\u8bfe\u6211\u4eec\u7528\u7684 Ceph RBD\uff0c\u90a3\u4e48 kubelet \u5c31\u9700\u8981\u5148\u5c06 Ceph \u63d0\u4f9b\u7684 RBD \u6302\u8f7d\u5230 Pod \u6240\u5728\u7684\u5bbf\u4e3b\u673a\u4e0a\u9762\uff0c\u8fd9\u4e2a\u9636\u6bb5\u5728 Kubernetes \u4e2d\u88ab\u79f0\u4e3a Attach \u9636\u6bb5\u3002Attach \u9636\u6bb5\u5b8c\u6210\u540e\uff0c\u4e3a\u4e86\u80fd\u591f\u4f7f\u7528\u8fd9\u4e2a\u5757\u8bbe\u5907\uff0ckubelet \u8fd8\u8981\u8fdb\u884c\u7b2c\u4e8c\u4e2a\u64cd\u4f5c\uff0c\u5373\uff1a\u683c\u5f0f\u5316\u8fd9\u4e2a\u5757\u8bbe\u5907\uff0c\u7136\u540e\u5c06\u5b83\u6302\u8f7d\u5230\u5bbf\u4e3b\u673a\u6307\u5b9a\u7684\u6302\u8f7d\u70b9\u4e0a\u3002\u8fd9\u4e2a\u6302\u8f7d\u70b9\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u6211\u4eec\u63d0\u5230\u7684 Volume \u7684\u5bbf\u4e3b\u673a\u7684\u76ee\u5f55\u3002\u5c06\u5757\u8bbe\u5907\u683c\u5f0f\u5316\u5e76\u6302\u8f7d\u5230 Volume \u5bbf\u4e3b\u673a\u76ee\u5f55\u7684\u64cd\u4f5c\uff0c\u5728 Kubernetes \u4e2d\u88ab\u79f0\u4e3a Mount \u9636\u6bb5\u3002\u4e0a\u8282\u8bfe\u6211\u4eec\u4f7f\u7528 Ceph RBD \u6301\u4e45\u5316\u7684 Wordpress \u7684 MySQL \u6570\u636e\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5bf9\u5e94\u7684 Volume \u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pods -o wide -l app=wordpress\nNAME                              READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES\nwordpress-5b886cf59b-dv2zt        1/1     Running   0          20d   2158   ydzs-node1   &lt;none&gt;           &lt;none&gt;\nwordpress-mysql-b9ddd6d4c-pjhbt   1/1     Running   0          20d   270    ydzs-node4   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 MySQL \u8fd0\u884c\u5728 node4 \u8282\u70b9\u4e0a\uff0c\u7136\u540e\u53ef\u4ee5\u5728\u8be5\u8282\u70b9\u4e0a\u67e5\u770b Volume \u4fe1\u606f\uff0cPod \u5bf9\u5e94\u7684 uid \u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u83b7\u53d6\uff1a</p> <pre><code>$ kubectl get pod wordpress-mysql-b9ddd6d4c-pjhbt -o jsonpath={.metadata.uid}\n3f84af87-9f58-4c69-9e38-5ef234498133\n$ ls /var/lib/kubelet/pods/3f84af87-9f58-4c69-9e38-5ef234498133/volumes/kubernetes.io~csi/pvc-c8861c23-c03d-47aa-96f6-73c4d4093109/\nmount  vol_data.json\n</code></pre> <p>\u7136\u540e\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u53ef\u4ee5\u67e5\u770b Volume \u7684\u6301\u4e45\u5316\u4fe1\u606f\uff1a</p> <pre><code>$ findmnt /var/lib/kubelet/pods/3f84af87-9f58-4c69-9e38-5ef234498133/volumes/kubernetes.io~csi/pvc-c8861c23-c03d-47aa-96f6-73c4d4093109/mount\nTARGET                                                                                            SOURCE    FSTYPE OPTIONS\n/var/lib/kubelet/pods/3f84af87-9f58-4c69-9e38-5ef234498133/volumes/kubernetes.io~csi/pvc-c8861c23-c03d-47aa-96f6-73c4d4093109/mount    /dev/rbd0 ext4   rw,relatime,\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u7684 Volume \u662f\u6302\u8f7d\u5230 <code>/dev/rbd0</code> \u8fd9\u4e2a\u8bbe\u5907\u4e0a\u9762\u7684\uff0c\u901a\u8fc7 <code>df</code> \u547d\u4ee4\u4e5f\u662f\u53ef\u4ee5\u770b\u5230\u7684\uff1a</p> <pre><code>$ df -h |grep dev\ndevtmpfs        9G     0  9G   0% /dev\ntmpfs           9G     0  9G   0% /dev/shm\n/dev/vda3        18G  7G   13G  27% /\n/dev/vda1       497M  158M  340M  32% /boot\n/dev/vdb1       197G   24G  164G  13% /data\n/dev/rbd0        20G  160M   20G   1% /var/lib/kubelet/pods/3f84af87-9f58-4c69-9e38-5ef234498133/volumes/kubernetes.io~csi/pvc-c8861c23-c03d-47aa-96f6-73c4d4093109/mount\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5c31\u7ecf\u8fc7\u4e86 <code>Attach</code> \u548c <code>Mount</code> \u4e24\u4e2a\u9636\u6bb5\u5b8c\u6210\u4e86 Volume \u7684\u6301\u4e45\u5316\u3002\u4f46\u662f\u5bf9\u4e8e\u4e0a\u9762\u6211\u4eec\u4f7f\u7528\u7684 NFS \u5c31\u66f4\u52a0\u7b80\u5355\u4e86\uff0c \u56e0\u4e3a NFS \u5b58\u50a8\u5e76\u6ca1\u6709\u4e00\u4e2a\u8bbe\u5907\u9700\u8981\u6302\u8f7d\u5230\u5bbf\u4e3b\u673a\u4e0a\u9762\uff0c\u6240\u4ee5\u8fd9\u4e2a\u65f6\u5019 kubelet \u5c31\u4f1a\u76f4\u63a5\u8fdb\u5165\u7b2c\u4e8c\u4e2a <code>Mount</code> \u9636\u6bb5\uff0c\u76f8\u5f53\u4e8e\u76f4\u63a5\u5728\u5bbf\u4e3b\u673a\u4e0a\u9762\u6267\u884c\u5982\u4e0b\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ mount -t nfs 111:/data/k8s /var/lib/kubelet/pods/d4fcdb11-baf7-43d9-8d7d-3ede24118e08/volumes/kubernetes.io~nfs/nfs-pv\n</code></pre> <p>\u540c\u6837\u53ef\u4ee5\u5728\u6d4b\u8bd5\u7684 Pod \u6240\u5728\u8282\u70b9\u67e5\u770b Volume \u7684\u6302\u8f7d\u4fe1\u606f\uff1a</p> <pre><code>$ findmnt /var/lib/kubelet/pods/d4fcdb11-baf7-43d9-8d7d-3ede24118e08/volumes/kubernetes.io~nfs/nfs-pv\nTARGET                                                                               SOURCE                 FSTYPE OPTIONS\n/var/lib/kubelet/pods/d4fcdb11-baf7-43d9-8d7d-3ede24118e08/volumes/kubernetes.io~nfs/nfs-pv\n                                                                                     111:/data/k8s nfs4   rw,relatime,\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a Volume \u88ab\u6302\u8f7d\u5230\u4e86 NFS\uff0810.151.30.11:/data/k8s\uff09\u4e0b\u9762\uff0c\u4ee5\u540e\u6211\u4eec\u5728\u8fd9\u4e2a\u76ee\u5f55\u91cc\u5199\u5165\u7684\u6240\u6709\u6587\u4ef6\uff0c\u90fd\u4f1a\u88ab\u4fdd\u5b58\u5728\u8fdc\u7a0b NFS \u670d\u52a1\u5668\u4e0a\u3002</p> <p>\u8fd9\u6837\u5728\u7ecf\u8fc7\u4e86\u4e0a\u9762\u7684\u4e24\u4e2a\u9636\u6bb5\u8fc7\u540e\uff0c\u6211\u4eec\u5c31\u5f97\u5230\u4e86\u4e00\u4e2a\u6301\u4e45\u5316\u7684\u5bbf\u4e3b\u673a\u4e0a\u9762\u7684 Volume \u76ee\u5f55\u4e86\uff0c\u63a5\u4e0b\u6765 kubelet \u53ea\u9700\u8981\u628a\u8fd9\u4e2a Volume \u76ee\u5f55\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u5bf9\u5e94\u7684\u76ee\u5f55\u5373\u53ef\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4e3a Pod \u91cc\u7684\u5bb9\u5668\u6302\u8f7d\u8fd9\u4e2a\u6301\u4e45\u5316\u7684 Volume \u4e86\uff0c\u8fd9\u4e00\u6b65\u5176\u5b9e\u4e5f\u5c31\u76f8\u5f53\u4e8e\u6267\u884c\u4e86\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ docker run -v /var/lib/kubelet/pods/&lt;Pod\u7684ID&gt;/volumes/kubernetes.io~&lt;Volume\u7c7b\u578b&gt;/&lt;Volume\u540d\u5b57&gt;:/&lt;\u5bb9\u5668\u5185\u7684\u76ee\u6807\u76ee\u5f55&gt; \u6211\u7684\u955c\u50cf ...\n</code></pre> <p>\u6574\u4e2a\u5b58\u50a8\u7684\u67b6\u6784\u53ef\u4ee5\u7528\u4e0b\u56fe\u6765\u8bf4\u660e\uff1a </p> <ul> <li>PV Controller\uff1a\u8d1f\u8d23 PV/PVC \u7684\u7ed1\u5b9a\uff0c\u5e76\u6839\u636e\u9700\u6c42\u8fdb\u884c\u6570\u636e\u5377\u7684 Provision/Delete \u64cd\u4f5c</li> <li>AD Controller\uff1a\u8d1f\u8d23\u5b58\u50a8\u8bbe\u5907\u7684 Attach/Detach \u64cd\u4f5c\uff0c\u5c06\u8bbe\u5907\u6302\u8f7d\u5230\u76ee\u6807\u8282\u70b9</li> <li>Volume Manager\uff1a\u7ba1\u7406\u5377\u7684 Mount/Unmount \u64cd\u4f5c\u3001\u5377\u8bbe\u5907\u7684\u683c\u5f0f\u5316\u7b49\u64cd\u4f5c</li> <li>Volume Plugin\uff1a\u6269\u5c55\u5404\u79cd\u5b58\u50a8\u7c7b\u578b\u7684\u5377\u7ba1\u7406\u80fd\u529b\uff0c\u5b9e\u73b0\u7b2c\u4e09\u65b9\u5b58\u50a8\u7684\u5404\u79cd\u64cd\u4f5c\u80fd\u529b\u548c Kubernetes \u5b58\u50a8\u7cfb\u7edf\u7ed3\u5408</li> </ul> <p>\u6211\u4eec\u4e0a\u9762\u4f7f\u7528\u7684 NFS \u5c31\u5c5e\u4e8e In-Tree \u8fd9\u79cd\u65b9\u5f0f\uff0c\u800c\u4e0a\u8282\u8bfe\u4f7f\u7528\u7684 Ceph RBD \u5c31\u662f Out-Of-Tree \u7684\u65b9\u5f0f\uff0c\u800c\u4e14\u662f\u4f7f\u7528\u7684\u662f CSI \u63d2\u4ef6\u3002\u4e0b\u9762\u6211\u4eec\u518d\u6765\u4e86\u89e3\u4e0b <code>FlexVolume</code> \u548c <code>CSI</code> \u4e24\u79cd\u63d2\u4ef6\u65b9\u5f0f\u3002</p>"},{"location":"kubernetes_stroage/csi/#flexvolume","title":"FlexVolume","text":"<p>FlexVolume \u63d0\u4f9b\u4e86\u4e00\u79cd\u6269\u5c55 Kubernetes \u5b58\u50a8\u63d2\u4ef6\u7684\u65b9\u5f0f\uff0c\u7528\u6237\u53ef\u4ee5\u81ea\u5b9a\u4e49\u81ea\u5df1\u7684\u5b58\u50a8\u63d2\u4ef6\u3002\u8981\u4f7f\u7528 FlexVolume \u9700\u8981\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u5b89\u88c5\u5b58\u50a8\u63d2\u4ef6\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u8be5\u4e8c\u8fdb\u5236\u9700\u8981\u5b9e\u73b0 FlexVolume \u7684\u76f8\u5173\u63a5\u53e3\uff0c\u9ed8\u8ba4\u5b58\u50a8\u63d2\u4ef6\u7684\u5b58\u653e\u8def\u5f84\u4e3a</p> <pre><code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec/&lt;vendor~driver&gt;/&lt;driver&gt;\n</code></pre> <p>\uff0c<code>VolumePlugins</code> \u7ec4\u4ef6\u4f1a\u4e0d\u65ad watch \u8fd9\u4e2a\u76ee\u5f55\u6765\u5b9e\u73b0\u63d2\u4ef6\u7684\u6dfb\u52a0\u3001\u5220\u9664\u7b49\u529f\u80fd\u3002</p> <p>\u5176\u4e2d <code>vendor~driver</code> \u7684\u540d\u5b57\u9700\u8981\u548c Pod \u4e2d<code>flexVolume.driver</code> \u7684\u5b57\u6bb5\u540d\u5b57\u5339\u914d\uff0c\u4f8b\u5982\uff1a</p> <pre><code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec/foo~cifs/cifs\n</code></pre> <p>\u5bf9\u5e94\u7684 Pod \u4e2d\u7684 <code>flexVolume.driver</code> \u5c5e\u6027\u4e3a\uff1a<code>foo/cifs</code>\u3002</p> <p>\u5728\u6211\u4eec\u5b9e\u73b0\u81ea\u5b9a\u4e49\u5b58\u50a8\u63d2\u4ef6\u7684\u65f6\u5019\uff0c\u9700\u8981\u5b9e\u73b0 FlexVolume \u7684\u90e8\u5206\u63a5\u53e3\uff0c\u56e0\u4e3a\u8981\u770b\u5b9e\u9645\u9700\u6c42\uff0c\u5e76\u4e0d\u4e00\u5b9a\u6240\u6709\u63a5\u53e3\u90fd\u9700\u8981\u5b9e\u73b0\u3002\u6bd4\u5982\u5bf9\u4e8e\u7c7b\u4f3c\u4e8e NFS \u8fd9\u6837\u7684\u5b58\u50a8\u5c31\u6ca1\u5fc5\u8981\u5b9e\u73b0 <code>attach/detach</code> \u8fd9\u4e9b\u63a5\u53e3\u4e86\uff0c\u56e0\u4e3a\u4e0d\u9700\u8981\uff0c\u53ea\u9700\u8981\u5b9e\u73b0 <code>init/mount/umount</code> 3\u4e2a\u63a5\u53e3\u5373\u53ef\u3002</p> <ul> <li> <p>init: </p> <pre><code>&lt;driver executable&gt; init\n</code></pre> <ul> <li>kubelet/kube-controller-manager \u521d\u59cb\u5316\u5b58\u50a8\u63d2\u4ef6\u65f6\u8c03\u7528\uff0c\u63d2\u4ef6\u9700\u8981\u8fd4\u56de\u662f\u5426\u9700\u8981\u8981 attach \u548c detach \u64cd\u4f5c</li> <li>attach: </li> </ul> <pre><code>&lt;driver executable&gt; attach &lt;json options&gt; &lt;node name&gt;\n</code></pre> <ul> <li>\u5c06\u5b58\u50a8\u5377\u6302\u8f7d\u5230 Node \u8282\u70b9\u4e0a</li> <li>detach: </li> </ul> <pre><code>&lt;driver executable&gt; detach &lt;mount device&gt; &lt;node name&gt;\n</code></pre> <ul> <li>\u5c06\u5b58\u50a8\u5377\u4ece Node \u4e0a\u5378\u8f7d</li> <li>waitforattach: </li> </ul> <pre><code>&lt;driver executable&gt; waitforattach &lt;mount device&gt; &lt;json options&gt;\n</code></pre> <ul> <li>\u7b49\u5f85 attach \u64cd\u4f5c\u6210\u529f\uff08\u8d85\u65f6\u65f6\u95f4\u4e3a 10 \u5206\u949f\uff09</li> <li>isattached: </li> </ul> <pre><code>&lt;driver executable&gt; isattached &lt;json options&gt; &lt;node name&gt;\n</code></pre> <ul> <li>\u68c0\u67e5\u5b58\u50a8\u5377\u662f\u5426\u5df2\u7ecf\u6302\u8f7d</li> <li>mountdevice: </li> </ul> <pre><code>&lt;driver executable&gt; mountdevice &lt;mount dir&gt; &lt;mount device&gt; &lt;json options&gt;\n</code></pre> <ul> <li>\u5c06\u8bbe\u5907\u6302\u8f7d\u5230\u6307\u5b9a\u76ee\u5f55\u4e2d\u4ee5\u4fbf\u540e\u7eed bind mount \u4f7f\u7528</li> <li>unmountdevice: </li> </ul> <pre><code>&lt;driver executable&gt; unmountdevice &lt;mount device&gt;\n</code></pre> <ul> <li>\u5c06\u8bbe\u5907\u53d6\u6d88\u6302\u8f7d</li> <li>mount: </li> </ul> <pre><code>&lt;driver executable&gt; mount &lt;mount dir&gt; &lt;json options&gt;\n</code></pre> <ul> <li>\u5c06\u5b58\u50a8\u5377\u6302\u8f7d\u5230\u6307\u5b9a\u76ee\u5f55\u4e2d</li> <li>unmount: </li> </ul> <pre><code>&lt;driver executable&gt; unmount &lt;mount dir&gt;\n</code></pre> <ul> <li>\u5c06\u5b58\u50a8\u5377\u53d6\u6d88\u6302\u8f7d</li> </ul> </li> </ul> <p>\u5b9e\u73b0\u4e0a\u9762\u7684\u8fd9\u4e9b\u63a5\u53e3\u9700\u8981\u8fd4\u56de\u5982\u4e0b\u6240\u793a\u7684 JSON \u683c\u5f0f\u7684\u6570\u636e\uff1a</p> <pre><code>{\n    \"status\": \"&lt;Success/Failure/Not supported&gt;\",\n    \"message\": \"&lt;Reason for success/failure&gt;\",\n    \"device\": \"&lt;Path to the device attached. This field is valid only for attach &amp; waitforattach call-outs&gt;\"\n    \"volumeName\": \"&lt;Cluster wide unique name of the volume. Valid only for getvolumename call-out&gt;\"\n    \"attached\": &lt;True/False (Return true if volume is attached on the node. Valid only for isattached call-out)&gt;\n    \"capabilities\": &lt;Only included as part of the Init response&gt;\n    {\n        \"attach\": &lt;True/False (Return true if the driver implements attach and detach)&gt;\n    }\n}\n</code></pre> <p>\u6bd4\u5982\u6211\u4eec\u6765\u5b9e\u73b0\u4e00\u4e2a NFS \u7684 FlexVolume \u63d2\u4ef6\uff0c\u6700\u7b80\u5355\u7684\u65b9\u5f0f\u5c31\u662f\u5199\u4e00\u4e2a\u811a\u672c\uff0c\u7136\u540e\u5b9e\u73b0 init\u3001mount\u3001unmount 3\u4e2a\u547d\u4ee4\u5373\u53ef\uff0c\u7136\u540e\u6309\u7167\u4e0a\u9762\u7684 JSON \u683c\u5f0f\u8fd4\u56de\u6570\u636e\uff0c\u6700\u540e\u628a\u8fd9\u4e2a\u811a\u672c\u653e\u5728\u8282\u70b9\u7684 FlexVolume \u63d2\u4ef6\u76ee\u5f55\u4e0b\u9762\u5373\u53ef\u3002</p> <p>\u4e0b\u9762\u5c31\u662f\u5b98\u65b9\u7ed9\u51fa\u7684\u4e00\u4e2a NFS \u7684 FlexVolume \u63d2\u4ef6\u793a\u4f8b\uff0c\u53ef\u4ee5\u4ece https://github.com/kubernetes/examples/blob/master/staging/volumes/flexvolume/nfs \u83b7\u53d6\u811a\u672c\uff1a</p> <pre><code>#!/bin/bash\n# \u6ce8\u610f:\n#  - \u5728\u4f7f\u7528\u63d2\u4ef6\u4e4b\u524d\u9700\u8981\u5148\u5b89\u88c5 jq\u3002\nusage() {\n    err \"Invalid usage. Usage: \"\n    err \"\\\\t$0 init\"\n    err \"\\\\t$0 mount &lt;mount dir&gt; &lt;json params&gt;\"\n    err \"\\\\t$0 unmount &lt;mount dir&gt;\"\n    exit 1\n}\n\nerr() {\n    echo -ne $* 1&gt;&amp;2\n}\n\nlog() {\n    echo -ne $* &gt;&amp;1\n}\n\nismounted() {\n    MOUNT=`findmnt -n ${MNTPATH} 2&gt;/dev/null | cut -d' ' -f1`\n    if [ \"${MOUNT}\" == \"${MNTPATH}\" ]; then\n        echo \"1\"\n    else\n        echo \"0\"\n    fi\n}\n\ndomount() {\n    MNTPATH=$1\n\n    NFS_SERVER=$(echo $2 | jq -r '.server')\n    SHARE=$(echo $2 | jq -r '.share')\n\n    if [ $(ismounted) -eq 1 ] ; then\n        log '{\"status\": \"Success\"}'\n        exit 0\n    fi\n\n    mkdir -p ${MNTPATH} &amp;&gt; /dev/null\n\n    mount -t nfs ${NFS_SERVER}:/${SHARE} ${MNTPATH} &amp;&gt; /dev/null\n    if [ $? -ne 0 ]; then\n        err \"{ \\\\\"status\\\\\": \\\\\"Failure\\\\\", \\\\\"message\\\\\": \\\\\"Failed to mount ${NFS_SERVER}:${SHARE} at ${MNTPATH}\\\\\"}\"\n        exit 1\n    fi\n    log '{\"status\": \"Success\"}'\n    exit 0\n}\n\nunmount() {\n    MNTPATH=$1\n    if [ $(ismounted) -eq 0 ] ; then\n        log '{\"status\": \"Success\"}'\n        exit 0\n    fi\n\n    umount ${MNTPATH} &amp;&gt; /dev/null\n    if [ $? -ne 0 ]; then\n        err \"{ \\\\\"status\\\\\": \\\\\"Failed\\\\\", \\\\\"message\\\\\": \\\\\"Failed to unmount volume at ${MNTPATH}\\\\\"}\"\n        exit 1\n    fi\n\n    log '{\"status\": \"Success\"}'\n    exit 0\n}\n\nop=$1\n\nif ! command -v jq &gt;/dev/null 2&gt;&amp;1; then\n    err \"{ \\\\\"status\\\\\": \\\\\"Failure\\\\\", \\\\\"message\\\\\": \\\\\"'jq' binary not found. Please install jq package before using this driver\\\\\"}\"\n    exit 1\nfi\n\nif [ \"$op\" = \"init\" ]; then\n    log '{\"status\": \"Success\", \"capabilities\": {\"attach\": false}}'\n    exit 0\nfi\n\nif [ $# -lt 2 ]; then\n    usage\nfi\n\nshift\n\ncase \"$op\" in\n    mount)\n        domount $*\n        ;;\n    unmount)\n        unmount $*\n        ;;\n    *)\n        log '{\"status\": \"Not supported\"}'\n        exit 0\nesac\n\nexit 1\n</code></pre> <p>\u5c06\u4e0a\u9762\u811a\u672c\u547d\u540d\u6210 nfs\uff0c\u653e\u7f6e\u5230 node1 \u8282\u70b9\u5bf9\u5e94\u7684\u63d2\u4ef6\u4e0b\u9762\uff1a </p> <pre><code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec/ydzs~nfs/nfs\n</code></pre> <p>\uff0c\u5e76\u8bbe\u7f6e\u6743\u9650\u4e3a 700\uff1a</p> <pre><code>$ chmod 700 /usr/libexec/kubernetes/kubelet-plugins/volume/exec/ydzs~nfs/nfs\n# \u5b89\u88c5 jq \u5de5\u5177\n$ yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-noarch.rpm\n$ yum install jq -y\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a\u5e94\u7528\u5230 node1 \u8282\u70b9\u4e0a\uff0c\u5e76\u7528 <code>flexVolume</code> \u6765\u6301\u4e45\u5316\u5bb9\u5668\u4e2d\u7684\u6570\u636e\uff08\u5f53\u7136\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5b9a\u4e49 flexvolume \u7c7b\u578b\u7684 PV\u3001PVC \u6765\u4f7f\u7528\uff09\uff0c\u5982\u4e0b\u6240\u793a\uff1a(test-flexvolume.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: test-flexvolume\nspec:\n  nodeSelector:\n    kubernetes.io/hostname: ydzs-node1\n  volumes:\n  - name: test\n    flexVolume:\n      driver: \"ydzs/nfs\"  # \u5b9a\u4e49\u63d2\u4ef6\u7c7b\u578b\uff0c\u6839\u636e\u8fd9\u4e2a\u53c2\u6570\u5728\u5bf9\u5e94\u7684\u76ee\u5f55\u4e0b\u9762\u627e\u5230\u63d2\u4ef6\u7684\u53ef\u6267\u884c\u6587\u4ef6\n      fsType: \"nfs\"  # \u5b9a\u4e49\u5b58\u50a8\u5377\u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b\n      options:  # \u5b9a\u4e49\u6240\u6709\u4e0e\u5b58\u50a8\u76f8\u5173\u7684\u4e00\u4e9b\u5177\u4f53\u53c2\u6570\n        server: \"111\"\n        share: \"data/k8s\"\n  containers:\n  - name: web\n    image: nginx\n    ports:\n    - containerPort: 80\n    volumeMounts:\n    - name: test\n      subPath: testflexvolume\n      mountPath: /usr/share/nginx/html\n</code></pre> <p>\u5176\u4e2d <code>flexVolume.driver</code> \u5c31\u662f\u63d2\u4ef6\u76ee\u5f55 <code>ydzs~nfs</code> \u5bf9\u5e94\u7684 <code>ydzs/nfs</code> \u540d\u79f0\uff0c<code>flexVolume.options</code> \u4e2d\u6839\u636e\u4e0a\u9762\u7684 nfs \u811a\u672c\u53ef\u4ee5\u5f97\u77e5\u91cc\u9762\u914d\u7f6e\u7684\u662f NFS \u7684 Server \u5730\u5740\u548c\u6302\u8f7d\u76ee\u5f55\u8def\u5f84\uff0c\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f test-flexvolume.yaml\n$ kubectl get pods \nNAME                                      READY   STATUS    RESTARTS   AGE\ntest-flexvolume                           1/1     Running   0          13h\n......\n$ kubectl exec -it test-flexvolume mount |grep test\n111:/data/k8s/testflexvolume on /usr/share/nginx/html type nfs4 (rw,relatime,vers=1,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=122,local_lock=none,addr=111)\n$ mount |grep test\n111:/data/k8s on /var/lib/kubelet/pods/a376832a-7638-4faf-b1a0-404956e8e60a/volumes/ydzs~nfs/test type nfs4 (rw,relatime,vers=1,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=122,local_lock=none,addr=111)\n111:/data/k8s/testflexvolume on /var/lib/kubelet/pods/a376832a-7638-4faf-b1a0-404956e8e60a/volume-subpaths/test/web/0 type nfs4 (rw,relatime,vers=1,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=122,local_lock=none,addr=111)\n</code></pre> <p>\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5230 Pod \u7684\u672c\u5730\u6301\u4e45\u5316\u76ee\u5f55\u662f\u88ab mount \u5230\u4e86 NFS \u4e0a\u9762\uff0c\u8bc1\u660e\u4e0a\u9762\u6211\u4eec\u7684 FlexVolume \u63d2\u4ef6\u662f\u6b63\u5e38\u7684\u3002</p> <p>\u8c03\u7528</p> <p>\u5f53\u6211\u4eec\u8981\u53bb\u771f\u6b63\u7684 mount NFS \u7684\u65f6\u5019\uff0c\u5c31\u662f\u901a\u8fc7 kubelet \u8c03\u7528 VolumePlugin\uff0c\u7136\u540e\u76f4\u63a5\u6267\u884c\u547d\u4ee4</p> <pre><code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec/ydzs~nfs/nfs mount &lt;mount dir&gt; &lt;json param&gt;\n</code></pre> <p>\u6765\u5b8c\u6210\u7684\uff0c\u5c31\u76f8\u5f53\u4e8e\u5e73\u65f6\u6211\u4eec\u5728\u5bbf\u4e3b\u673a\u4e0a\u9762\u624b\u52a8\u6302\u8f7d NFS \u7684\u65b9\u5f0f\u4e00\u6837\u7684\uff0c\u6240\u4ee5\u5b58\u50a8\u63d2\u4ef6 nfs \u662f\u4e00\u4e2a\u53ef\u6267\u884c\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u6216\u8005 shell \u811a\u672c\u90fd\u662f\u53ef\u4ee5\u7684\u3002</p>"},{"location":"kubernetes_stroage/csi/#csi","title":"CSI","text":"<p>\u65e2\u7136\u5df2\u7ecf\u6709\u4e86 FlexVolume \u63d2\u4ef6\u4e86\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981 CSI \u63d2\u4ef6\u5462\uff1f\u4e0a\u9762\u6211\u4eec\u4f7f\u7528 FlexVolume \u63d2\u4ef6\u7684\u65f6\u5019\u53ef\u4ee5\u770b\u51fa FlexVolume \u63d2\u4ef6\u5b9e\u9645\u4e0a\u76f8\u5f53\u4e8e\u5c31\u662f\u4e00\u4e2a\u666e\u901a\u7684 shell \u547d\u4ee4\uff0c\u7c7b\u4f3c\u4e8e\u5e73\u65f6\u6211\u4eec\u5728 Linux \u4e0b\u9762\u6267\u884c\u7684 <code>ls</code> \u547d\u4ee4\u4e00\u6837\uff0c\u53ea\u662f\u8fd4\u56de\u7684\u4fe1\u606f\u662f JSON \u683c\u5f0f\u7684\u6570\u636e\uff0c\u5e76\u4e0d\u662f\u6211\u4eec\u901a\u5e38\u8ba4\u4e3a\u7684\u4e00\u4e2a\u5e38\u9a7b\u5185\u5b58\u7684\u8fdb\u7a0b\uff0c\u800c CSI \u662f\u4e00\u4e2a\u66f4\u52a0\u5b8c\u5584\u3001\u7f16\u7801\u66f4\u52a0\u65b9\u4fbf\u53cb\u597d\u7684\u4e00\u79cd\u5b58\u50a8\u63d2\u4ef6\u6269\u5c55\u65b9\u5f0f\u3002</p> <p>CSI \u662f\u7531\u6765\u81ea Kubernetes\u3001Mesos\u3001 Cloud Foundry \u7b49\u793e\u533a\u6210\u5458\u8054\u5408\u5236\u5b9a\u7684\u4e00\u4e2a\u884c\u4e1a\u6807\u51c6\u63a5\u53e3\u89c4\u8303\uff0c\u65e8\u5728\u5c06\u4efb\u610f\u5b58\u50a8\u7cfb\u7edf\u66b4\u9732\u7ed9\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\u3002CSI \u89c4\u8303\u5b9a\u4e49\u4e86\u5b58\u50a8\u63d0\u4f9b\u5546\u5b9e\u73b0 CSI \u517c\u5bb9\u63d2\u4ef6\u7684\u6700\u5c0f\u64cd\u4f5c\u96c6\u5408\u548c\u90e8\u7f72\u5efa\u8bae\uff0cCSI \u89c4\u8303\u7684\u4e3b\u8981\u7126\u70b9\u662f\u58f0\u660e\u63d2\u4ef6\u5fc5\u987b\u5b9e\u73b0\u7684\u63a5\u53e3\u3002</p> <p>\u5728 Kubernetes \u4e0a\u6574\u5408 CSI \u63d2\u4ef6\u7684\u6574\u4f53\u67b6\u6784\u5982\u4e0b\u56fe\u6240\u793a\uff1a </p> <p>Kubernetes CSI \u5b58\u50a8\u4f53\u7cfb\u4e3b\u8981\u7531\u4e24\u90e8\u5206\u7ec4\u6210\uff1a</p> <ul> <li> <p>Kubernetes \u5916\u90e8\u7ec4\u4ef6\uff1a\u5305\u542b Driver registrar\u3001External provisioner\u3001External attacher \u4e09\u90e8\u5206\uff0c\u8fd9\u4e09\u4e2a\u7ec4\u4ef6\u662f\u4ece Kubernetes \u539f\u672c\u7684 in-tree \u5b58\u50a8\u4f53\u7cfb\u4e2d\u5265\u79bb\u51fa\u6765\u7684\u5b58\u50a8\u7ba1\u7406\u529f\u80fd\uff0c\u5b9e\u9645\u4e0a\u662f Kubernetes \u4e2d\u7684\u4e00\u79cd\u5916\u90e8 controller \uff0c\u5b83\u4eec watch kubernetes \u7684 API \u8d44\u6e90\u5bf9\u8c61\uff0c\u6839\u636e watch \u5230\u7684\u72b6\u6001\u6765\u8c03\u7528\u4e0b\u9762\u63d0\u5230\u7684\u7b2c\u4e8c\u90e8\u5206\u7684 CSI \u63d2\u4ef6\u6765\u5b9e\u73b0\u5b58\u50a8\u7684\u7ba1\u7406\u548c\u64cd\u4f5c\u3002\u8fd9\u90e8\u5206\u662f Kubernetes \u56e2\u961f\u7ef4\u62a4\u7684\uff0c\u63d2\u4ef6\u5f00\u53d1\u8005\u5b8c\u5168\u4e0d\u5fc5\u5173\u5fc3\u5176\u5b9e\u73b0\u7ec6\u8282\u3002</p> <ul> <li>Driver registra\uff1a\u7528\u4e8e\u5c06\u63d2\u4ef6\u6ce8\u518c\u5230 kubelet \u7684 sidecar \u5bb9\u5668\uff0c\u5e76\u5c06\u9a71\u52a8\u7a0b\u5e8f\u81ea\u5b9a\u4e49\u7684 NodeId \u6dfb\u52a0\u5230\u8282\u70b9\u7684 Annotations \u4e0a\uff0c\u901a\u8fc7\u4e0e CSI \u4e0a\u9762\u7684 Identity \u670d\u52a1\u8fdb\u884c\u901a\u4fe1\u8c03\u7528 CSI \u7684 GetNodeId \u65b9\u6cd5\u6765\u5b8c\u6210\u8be5\u64cd\u4f5c\u3002</li> <li>External provisioner\uff1a\u7528\u4e8e watch Kubernetes \u7684 PVC \u5bf9\u8c61\u5e76\u8c03\u7528 CSI \u7684 CreateVolume \u548c DeleteVolume \u64cd\u4f5c\u3002</li> <li>External attacher\uff1a\u7528\u4e8e Attach/Detach \u9636\u6bb5\uff0c\u901a\u8fc7 watch Kubernetes \u7684 VolumeAttachment \u5bf9\u8c61\u5e76\u8c03\u7528 CSI \u7684 ControllerPublish \u548c ControllerUnpublish \u64cd\u4f5c\u6765\u5b8c\u6210\u5bf9\u5e94\u7684 Volume \u7684 Attach/Detach\u3002\u800c Volume \u7684 Mount/Unmount \u9636\u6bb5\u5e76\u4e0d\u5c5e\u4e8e\u5916\u90e8\u7ec4\u4ef6\uff0c\u5f53\u771f\u6b63\u9700\u8981\u6267\u884c Mount \u64cd\u4f5c\u7684\u65f6\u5019\uff0ckubelet \u4f1a\u53bb\u76f4\u63a5\u8c03\u7528\u4e0b\u9762\u7684 CSI Node \u670d\u52a1\u6765\u5b8c\u6210 Volume \u7684 Mount/UnMount \u64cd\u4f5c\u3002</li> <li> <p>CSI \u5b58\u50a8\u63d2\u4ef6: \u8fd9\u90e8\u5206\u6b63\u662f\u5f00\u53d1\u8005\u9700\u8981\u5b9e\u73b0\u7684 CSI \u63d2\u4ef6\u90e8\u5206\uff0c\u90fd\u662f\u901a\u8fc7 gRPC \u5b9e\u73b0\u7684\u670d\u52a1\uff0c\u4e00\u822c\u4f1a\u7528\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u4e3b\u8981\u5305\u542b\u4e09\u90e8\u5206\uff1aCSI Identity\u3001CSI Controller\u3001CSI Node\u3002</p> </li> <li> <p>CSI Identity \u2014 \u4e3b\u8981\u7528\u4e8e\u8d1f\u8d23\u5bf9\u5916\u66b4\u9732\u8fd9\u4e2a\u63d2\u4ef6\u672c\u8eab\u7684\u4fe1\u606f\uff0c\u786e\u4fdd\u63d2\u4ef6\u7684\u5065\u5eb7\u72b6\u6001\u3002</p> <pre><code>service Identity {\n    // \u8fd4\u56de\u63d2\u4ef6\u7684\u540d\u79f0\u548c\u7248\u672c\n    rpc GetPluginInfo(GetPluginInfoRequest)\n        returns (GetPluginInfoResponse) {}\n    // \u8fd4\u56de\u8fd9\u4e2a\u63d2\u4ef6\u7684\u5305\u542b\u7684\u529f\u80fd\uff0c\u6bd4\u5982\u975e\u5757\u5b58\u50a8\u7c7b\u578b\u7684 CSI \u63d2\u4ef6\u4e0d\u9700\u8981\u5b9e\u73b0 Attach \u529f\u80fd\uff0cGetPluginCapabilities \u5c31\u53ef\u4ee5\u5728\u8fd4\u56de\u4e2d\u6807\u6ce8\u8fd9\u4e2a CSI \u63d2\u4ef6\u4e0d\u5305\u542b Attach \u529f\u80fd\n    rpc GetPluginCapabilities(GetPluginCapabilitiesRequest)\n        returns (GetPluginCapabilitiesResponse) {}\n    // \u63d2\u4ef6\u63d2\u4ef6\u662f\u5426\u6b63\u5728\u8fd0\u884c\n    rpc Probe (ProbeRequest)\n        returns (ProbeResponse) {}\n}\n</code></pre> </li> <li> <p>CSI Controller - \u4e3b\u8981\u5b9e\u73b0 Volume \u7ba1\u7406\u6d41\u7a0b\u5f53\u4e2d\u7684 Provision \u548c Attach \u9636\u6bb5\uff0cProvision \u9636\u6bb5\u662f\u6307\u521b\u5efa\u548c\u5220\u9664 Volume \u7684\u6d41\u7a0b\uff0c\u800c Attach \u9636\u6bb5\u662f\u6307\u628a\u5b58\u50a8\u5377\u9644\u7740\u5728\u67d0\u4e2a\u8282\u70b9\u6216\u8131\u79bb\u67d0\u4e2a\u8282\u70b9\u7684\u6d41\u7a0b\uff0c\u53e6\u5916\u53ea\u6709\u5757\u5b58\u50a8\u7c7b\u578b\u7684 CSI \u63d2\u4ef6\u624d\u9700\u8981 Attach \u529f\u80fd\u3002</p> <pre><code>service Controller {\n    // \u521b\u5efa\u5b58\u50a8\u5377\uff0c\u5305\u62ec\u4e91\u7aef\u5b58\u50a8\u4ecb\u8d28\u4ee5\u53caPV\u5bf9\u8c61\n    rpc CreateVolume (CreateVolumeRequest)\n        returns (CreateVolumeResponse) {}\n\n    //  \u5220\u9664\u5b58\u50a8\u5377\n    rpc DeleteVolume (DeleteVolumeRequest)\n        returns (DeleteVolumeResponse) {}\n\n    // \u6302\u8f7d\u5b58\u50a8\u5377\uff0c\u5c06\u5b58\u50a8\u4ecb\u8d28\u6302\u8f7d\u5230\u76ee\u6807\u8282\u70b9\n    rpc ControllerPublishVolume (ControllerPublishVolumeRequest)\n        returns (ControllerPublishVolumeResponse) {}\n\n    // \u5378\u8f7d\u5b58\u50a8\u5377\n    rpc ControllerUnpublishVolume (ControllerUnpublishVolumeRequest)\n        returns (ControllerUnpublishVolumeResponse) {}\n\n    // \u4f8b\u5982\uff1a\u662f\u5426\u53ef\u4ee5\u540c\u65f6\u7528\u4e8e\u591a\u4e2a\u8282\u70b9\u7684\u8bfb/\u5199\n    rpc ValidateVolumeCapabilities (ValidateVolumeCapabilitiesRequest)\n        returns (ValidateVolumeCapabilitiesResponse) {}\n\n    // \u8fd4\u56de\u6240\u6709\u53ef\u7528\u7684 volumes\n    rpc ListVolumes (ListVolumesRequest)\n        returns (ListVolumesResponse) {}\n\n    // \u53ef\u7528\u5b58\u50a8\u6c60\u7684\u603b\u5bb9\u91cf\n    rpc GetCapacity (GetCapacityRequest)\n        returns (GetCapacityResponse) {}\n\n    // \u4f8b\u5982. \u63d2\u4ef6\u53ef\u80fd\u672a\u5b9e\u73b0 GetCapacity\u3001Snapshotting\n    rpc ControllerGetCapabilities (ControllerGetCapabilitiesRequest)\n        returns (ControllerGetCapabilitiesResponse) {}\n\n    // \u521b\u5efa\u5feb\u7167\n    rpc CreateSnapshot (CreateSnapshotRequest)\n        returns (CreateSnapshotResponse) {}\n\n    // \u5220\u9664\u6307\u5b9a\u7684\u5feb\u7167\n    rpc DeleteSnapshot (DeleteSnapshotRequest)\n        returns (DeleteSnapshotResponse) {}\n\n    // \u83b7\u53d6\u6240\u6709\u7684\u5feb\u7167\n    rpc ListSnapshots (ListSnapshotsRequest)\n        returns (ListSnapshotsResponse) {}\n}\n</code></pre> </li> <li> <p>CSI Node \u2014 \u8d1f\u8d23\u63a7\u5236 Kubernetes \u8282\u70b9\u4e0a\u7684 Volume \u64cd\u4f5c\u3002\u5176\u4e2d Volume \u7684\u6302\u8f7d\u88ab\u5206\u6210\u4e86 NodeStageVolume \u548c NodePublishVolume \u4e24\u4e2a\u9636\u6bb5\u3002NodeStageVolume \u63a5\u53e3\u4e3b\u8981\u662f\u9488\u5bf9\u5757\u5b58\u50a8\u7c7b\u578b\u7684 CSI \u63d2\u4ef6\u800c\u63d0\u4f9b\u7684\uff0c\u5757\u8bbe\u5907\u5728 \"Attach\" \u9636\u6bb5\u88ab\u9644\u7740\u5728 Node \u4e0a\u540e\uff0c\u9700\u8981\u6302\u8f7d\u81f3 Pod \u5bf9\u5e94\u76ee\u5f55\u4e0a\uff0c\u4f46\u56e0\u4e3a\u5757\u8bbe\u5907\u5728 linux \u4e0a\u53ea\u80fd mount \u4e00\u6b21\uff0c\u800c\u5728 kubernetes volume \u7684\u4f7f\u7528\u573a\u666f\u4e2d\uff0c\u4e00\u4e2a volume \u53ef\u80fd\u88ab\u6302\u8f7d\u8fdb\u540c\u4e00\u4e2a Node \u4e0a\u7684\u591a\u4e2a Pod \u5b9e\u4f8b\u4e2d\uff0c\u6240\u4ee5\u8fd9\u91cc\u63d0\u4f9b\u4e86 NodeStageVolume \u8fd9\u4e2a\u63a5\u53e3\uff0c\u4f7f\u7528\u8fd9\u4e2a\u63a5\u53e3\u628a\u5757\u8bbe\u5907\u683c\u5f0f\u5316\u540e\u5148\u6302\u8f7d\u81f3 Node \u4e0a\u7684\u4e00\u4e2a\u4e34\u65f6\u5168\u5c40\u76ee\u5f55\uff0c\u7136\u540e\u518d\u8c03\u7528 NodePublishVolume \u4f7f\u7528 linux \u4e2d\u7684 <code>bind mount</code> \u6280\u672f\u628a\u8fd9\u4e2a\u5168\u5c40\u76ee\u5f55\u6302\u8f7d\u8fdb Pod \u4e2d\u5bf9\u5e94\u7684\u76ee\u5f55\u4e0a\u3002</p> <pre><code>service Node {\n    // \u5728\u8282\u70b9\u4e0a\u521d\u59cb\u5316\u5b58\u50a8\u5377\uff08\u683c\u5f0f\u5316\uff09\uff0c\u5e76\u6267\u884c\u6302\u8f7d\u5230Global\u76ee\u5f55\n    rpc NodeStageVolume (NodeStageVolumeRequest)\n        returns (NodeStageVolumeResponse) {}\n\n    // umount \u5b58\u50a8\u5377\u5728\u8282\u70b9\u4e0a\u7684 Global \u76ee\u5f55\n    rpc NodeUnstageVolume (NodeUnstageVolumeRequest)\n        returns (NodeUnstageVolumeResponse) {}\n\n    // \u5728\u8282\u70b9\u4e0a\u5c06\u5b58\u50a8\u5377\u7684 Global \u76ee\u5f55\u6302\u8f7d\u5230 Pod \u7684\u5b9e\u9645\u6302\u8f7d\u76ee\u5f55\n    rpc NodePublishVolume (NodePublishVolumeRequest)\n        returns (NodePublishVolumeResponse) {}\n\n    // unmount \u5b58\u50a8\u5377\u5728\u8282\u70b9\u4e0a\u7684 Pod \u6302\u8f7d\u76ee\u5f55\n    rpc NodeUnpublishVolume (NodeUnpublishVolumeRequest)\n        returns (NodeUnpublishVolumeResponse) {}\n\n    // \u83b7\u53d6\u8282\u70b9\u4e0aVolume\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf\u7edf\u8ba1\u4fe1\u606f\uff08\u603b\u7a7a\u95f4\u3001\u53ef\u7528\u7a7a\u95f4\u7b49\uff09\n    rpc NodeGetVolumeStats (NodeGetVolumeStatsRequest)\n        returns (NodeGetVolumeStatsResponse) {}\n\n    // \u83b7\u53d6\u8282\u70b9\u7684\u552f\u4e00 ID\n    rpc NodeGetId (NodeGetIdRequest)\n        returns (NodeGetIdResponse) {\n        option deprecated = true;\n    }\n\n    // \u8fd4\u56de\u8282\u70b9\u63d2\u4ef6\u7684\u80fd\u529b\n    rpc NodeGetCapabilities (NodeGetCapabilitiesRequest)\n        returns (NodeGetCapabilitiesResponse) {}\n\n    // \u83b7\u53d6\u8282\u70b9\u7684\u4e00\u4e9b\u4fe1\u606f\n    rpc NodeGetInfo (NodeGetInfoRequest)\n        returns (NodeGetInfoResponse) {}\n}\n</code></pre> </li> </ul> </li> </ul> <p>\u53ea\u9700\u8981\u5b9e\u73b0\u4e0a\u9762\u7684\u63a5\u53e3\u5c31\u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e2a CSI \u63d2\u4ef6\u4e86\u3002\u867d\u7136 Kubernetes \u5e76\u672a\u89c4\u5b9a CSI \u63d2\u4ef6\u7684\u6253\u5305\u5b89\u88c5\uff0c\u4f46\u662f\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u5efa\u8bae\u6765\u7b80\u5316\u6211\u4eec\u5728 Kubernetes \u4e0a\u5bb9\u5668\u5316 CSI Volume \u9a71\u52a8\u7a0b\u5e8f\u7684\u90e8\u7f72\u65b9\u6848\uff0c\u5177\u4f53\u7684\u65b9\u6848\u4ecb\u7ecd\u53ef\u4ee5\u67e5\u770b CSI \u89c4\u8303\u4ecb\u7ecd\u6587\u6863 https://github.com/kubernetes/community</p> <p></p> <p>\u6309\u7167\u4e0a\u56fe\u7684\u63a8\u8350\u65b9\u6848\uff0cCSI Controller \u90e8\u5206\u4ee5 StatefulSet \u6216\u8005 Deployment \u65b9\u5f0f\u90e8\u7f72\uff0cCSI Node \u90e8\u5206\u4ee5 DaemonSet \u65b9\u5f0f\u90e8\u7f72\u3002\u56e0\u4e3a\u8fd9\u4e24\u90e8\u5206\u5b9e\u73b0\u5728\u540c\u4e00\u4e2a CSI \u63d2\u4ef6\u7a0b\u5e8f\u4e2d\uff0c\u56e0\u6b64\u53ea\u9700\u8981\u628a\u8fd9\u4e2a CSI \u63d2\u4ef6\u4e0e External Components \u4ee5\u5bb9\u5668\u65b9\u5f0f\u90e8\u7f72\u5728\u540c\u4e00\u4e2a Pod\u4e2d\uff0c\u628a\u8fd9\u4e2a CSI \u63d2\u4ef6\u4e0e Driver registrar \u4ee5\u5bb9\u5668\u65b9\u5f0f\u90e8\u7f72\u5728 DaemonSet \u7684 Pod \u4e2d\uff0c\u5373\u53ef\u5b8c\u6210 CSI \u7684\u90e8\u7f72\u3002</p> <p>\u524d\u9762\u6211\u4eec\u4f7f\u7528\u7684 Rook \u90e8\u7f72\u7684 Ceph \u96c6\u7fa4\u5c31\u662f\u5b9e\u73b0\u4e86 CSI \u63d2\u4ef6\u7684:</p> <pre><code>$ kubectl get pods -n rook-ceph |grep plugin\ncsi-cephfsplugin-2s9d5                                 3/3     Running     0          21d\ncsi-cephfsplugin-fgp4v                                 3/3     Running     0          17d\ncsi-cephfsplugin-fv5nx                                 3/3     Running     0          21d\ncsi-cephfsplugin-mn8q4                                 3/3     Running     0          17d\ncsi-cephfsplugin-nf6h8                                 3/3     Running     0          21d\ncsi-cephfsplugin-provisioner-56c8b7ddf4-68h6d          4/4     Running     0          21d\ncsi-cephfsplugin-provisioner-56c8b7ddf4-rq4t6          4/4     Running     0          21d\ncsi-cephfsplugin-xwnl4                                 3/3     Running     0          21d\ncsi-rbdplugin-7r88w                                    3/3     Running     0          21d\ncsi-rbdplugin-95g5j                                    3/3     Running     0          21d\ncsi-rbdplugin-bnzpr                                    3/3     Running     0          21d\ncsi-rbdplugin-dvftb                                    3/3     Running     0          21d\ncsi-rbdplugin-jzmj2                                    3/3     Running     0          17d\ncsi-rbdplugin-provisioner-6ff4dd4b94-bvtss             5/5     Running     0          21d\ncsi-rbdplugin-provisioner-6ff4dd4b94-lfn68             5/5     Running     0          21d\ncsi-rbdplugin-trxb4                                    3/3     Running     0          17d\n</code></pre> <p>\u8fd9\u91cc\u5176\u5b9e\u662f\u5b9e\u73b0\u4e86 RBD \u548c CephFS \u4e24\u79cd CSI\uff0c\u7528 DaemonSet \u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e86\u4e00\u4e2a\u5305\u542b <code>Driver registra</code> \u5bb9\u5668\u7684 Pod\uff0c\u5f53\u7136\u548c\u8282\u70b9\u76f8\u5173\u7684\u64cd\u4f5c\u6bd4\u5982 Mount/Unmount \u4e5f\u662f\u5728\u8fd9\u4e2a Pod \u91cc\u9762\u6267\u884c\u7684\uff0c\u5176\u4ed6\u7684\u6bd4\u5982 Provision\u3001Attach \u90fd\u662f\u5728\u53e6\u5916\u7684 </p> <pre><code>csi-rbdplugin-provisioner-xxx\n</code></pre> <p>Pod \u4e2d\u6267\u884c\u7684\u3002</p>"},{"location":"kubernetes_stroage/local/","title":"Local \u672c\u5730\u5b58\u50a8","text":""},{"location":"kubernetes_stroage/local/#local","title":"Local \u5b58\u50a8","text":"<p>\u524d\u9762\u6211\u4eec\u6709\u901a\u8fc7 <code>hostPath</code> \u6216\u8005 <code>emptyDir</code> \u7684\u65b9\u5f0f\u6765\u6301\u4e45\u5316\u6211\u4eec\u7684\u6570\u636e\uff0c\u4f46\u662f\u663e\u7136\u6211\u4eec\u8fd8\u9700\u8981\u66f4\u52a0\u53ef\u9760\u7684\u5b58\u50a8\u6765\u4fdd\u5b58\u5e94\u7528\u7684\u6301\u4e45\u5316\u6570\u636e\uff0c\u8fd9\u6837\u5bb9\u5668\u5728\u91cd\u5efa\u540e\uff0c\u4f9d\u7136\u53ef\u4ee5\u4f7f\u7528\u4e4b\u524d\u7684\u6570\u636e\u3002\u4f46\u662f\u5b58\u50a8\u8d44\u6e90\u548c CPU \u8d44\u6e90\u4ee5\u53ca\u5185\u5b58\u8d44\u6e90\u6709\u5f88\u5927\u4e0d\u540c\uff0c\u4e3a\u4e86\u5c4f\u853d\u5e95\u5c42\u7684\u6280\u672f\u5b9e\u73b0\u7ec6\u8282\uff0c\u8ba9\u7528\u6237\u66f4\u52a0\u65b9\u4fbf\u7684\u4f7f\u7528\uff0cKubernetes \u4fbf\u5f15\u5165\u4e86 <code>PV</code> \u548c <code>PVC</code> \u4e24\u4e2a\u91cd\u8981\u7684\u8d44\u6e90\u5bf9\u8c61\u6765\u5b9e\u73b0\u5bf9\u5b58\u50a8\u7684\u7ba1\u7406\u3002</p>"},{"location":"kubernetes_stroage/local/#_1","title":"\u6982\u5ff5","text":"<p><code>PV</code> \u7684\u5168\u79f0\u662f\uff1a<code>PersistentVolume</code>\uff08\u6301\u4e45\u5316\u5377\uff09\uff0c\u662f\u5bf9\u5e95\u5c42\u5171\u4eab\u5b58\u50a8\u7684\u4e00\u79cd\u62bd\u8c61\uff0cPV \u7531\u7ba1\u7406\u5458\u8fdb\u884c\u521b\u5efa\u548c\u914d\u7f6e\uff0c\u5b83\u548c\u5177\u4f53\u7684\u5e95\u5c42\u7684\u5171\u4eab\u5b58\u50a8\u6280\u672f\u7684\u5b9e\u73b0\u65b9\u5f0f\u6709\u5173\uff0c\u6bd4\u5982 <code>Ceph</code>\u3001<code>GlusterFS</code>\u3001<code>NFS</code>\u3001<code>hostPath</code> \u7b49\uff0c\u90fd\u662f\u901a\u8fc7\u63d2\u4ef6\u673a\u5236\u5b8c\u6210\u4e0e\u5171\u4eab\u5b58\u50a8\u7684\u5bf9\u63a5\u3002</p> <p><code>PVC</code> \u7684\u5168\u79f0\u662f\uff1a</p> <pre><code>PersistentVolumeClaim\n</code></pre> <p>\uff08\u6301\u4e45\u5316\u5377\u58f0\u660e\uff09\uff0cPVC \u662f\u7528\u6237\u5b58\u50a8\u7684\u4e00\u79cd\u58f0\u660e\uff0cPVC \u548c Pod \u6bd4\u8f83\u7c7b\u4f3c\uff0cPod \u6d88\u8017\u7684\u662f\u8282\u70b9\uff0cPVC \u6d88\u8017\u7684\u662f PV \u8d44\u6e90\uff0cPod \u53ef\u4ee5\u8bf7\u6c42 CPU \u548c\u5185\u5b58\uff0c\u800c PVC \u53ef\u4ee5\u8bf7\u6c42\u7279\u5b9a\u7684\u5b58\u50a8\u7a7a\u95f4\u548c\u8bbf\u95ee\u6a21\u5f0f\u3002\u5bf9\u4e8e\u771f\u6b63\u4f7f\u7528\u5b58\u50a8\u7684\u7528\u6237\u4e0d\u9700\u8981\u5173\u5fc3\u5e95\u5c42\u7684\u5b58\u50a8\u5b9e\u73b0\u7ec6\u8282\uff0c\u53ea\u9700\u8981\u76f4\u63a5\u4f7f\u7528 PVC \u5373\u53ef\u3002</p> <p>\u4f46\u662f\u901a\u8fc7 PVC \u8bf7\u6c42\u5230\u4e00\u5b9a\u7684\u5b58\u50a8\u7a7a\u95f4\u4e5f\u5f88\u6709\u53ef\u80fd\u4e0d\u8db3\u4ee5\u6ee1\u8db3\u5e94\u7528\u5bf9\u4e8e\u5b58\u50a8\u8bbe\u5907\u7684\u5404\u79cd\u9700\u6c42\uff0c\u800c\u4e14\u4e0d\u540c\u7684\u5e94\u7528\u7a0b\u5e8f\u5bf9\u4e8e\u5b58\u50a8\u6027\u80fd\u7684\u8981\u6c42\u53ef\u80fd\u4e5f\u4e0d\u5c3d\u76f8\u540c\uff0c\u6bd4\u5982\u8bfb\u5199\u901f\u5ea6\u3001\u5e76\u53d1\u6027\u80fd\u7b49\uff0c\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\uff0cKubernetes \u53c8\u4e3a\u6211\u4eec\u5f15\u5165\u4e86\u4e00\u4e2a\u65b0\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a<code>StorageClass</code>\uff0c\u901a\u8fc7 <code>StorageClass</code> \u7684\u5b9a\u4e49\uff0c\u7ba1\u7406\u5458\u53ef\u4ee5\u5c06\u5b58\u50a8\u8d44\u6e90\u5b9a\u4e49\u4e3a\u67d0\u79cd\u7c7b\u578b\u7684\u8d44\u6e90\uff0c\u6bd4\u5982\u5feb\u901f\u5b58\u50a8\u3001\u6162\u901f\u5b58\u50a8\u7b49\uff0c\u7528\u6237\u6839\u636e StorageClass \u7684\u63cf\u8ff0\u5c31\u53ef\u4ee5\u975e\u5e38\u76f4\u89c2\u7684\u77e5\u9053\u5404\u79cd\u5b58\u50a8\u8d44\u6e90\u7684\u5177\u4f53\u7279\u6027\u4e86\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u6839\u636e\u5e94\u7528\u7684\u7279\u6027\u53bb\u7533\u8bf7\u5408\u9002\u7684\u5b58\u50a8\u8d44\u6e90\u4e86\uff0c\u6b64\u5916 <code>StorageClass</code> \u8fd8\u53ef\u4ee5\u4e3a\u6211\u4eec\u81ea\u52a8\u751f\u6210 PV\uff0c\u514d\u53bb\u4e86\u6bcf\u6b21\u624b\u52a8\u521b\u5efa\u7684\u9ebb\u70e6\u3002</p>"},{"location":"kubernetes_stroage/local/#hostpath","title":"hostPath","text":"<p>\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u4e86 PV \u662f\u5bf9\u5e95\u5c42\u5b58\u50a8\u6280\u672f\u7684\u4e00\u79cd\u62bd\u8c61\uff0cPV \u4e00\u822c\u90fd\u662f\u7531\u7ba1\u7406\u5458\u6765\u521b\u5efa\u548c\u914d\u7f6e\u7684\uff0c\u6211\u4eec\u9996\u5148\u6765\u521b\u5efa\u4e00\u4e2a <code>hostPath</code> \u7c7b\u578b\u7684 <code>PersistentVolume</code>\u3002Kubernetes \u652f\u6301 hostPath \u7c7b\u578b\u7684 PersistentVolume \u4f7f\u7528\u8282\u70b9\u4e0a\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u6765\u6a21\u62df\u9644\u5e26\u7f51\u7edc\u7684\u5b58\u50a8\uff0c\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u751f\u4ea7\u96c6\u7fa4\u4e2d\uff0c\u6211\u4eec\u4e0d\u4f1a\u4f7f\u7528 hostPath\uff0c\u96c6\u7fa4\u7ba1\u7406\u5458\u4f1a\u63d0\u4f9b\u7f51\u7edc\u5b58\u50a8\u8d44\u6e90\uff0c\u6bd4\u5982 NFS \u5171\u4eab\u5377\u6216 Ceph \u5b58\u50a8\u5377\uff0c\u96c6\u7fa4\u7ba1\u7406\u5458\u8fd8\u53ef\u4ee5\u4f7f\u7528 <code>StorageClasses</code> \u6765\u8bbe\u7f6e\u52a8\u6001\u63d0\u4f9b\u5b58\u50a8\u3002\u56e0\u4e3a Pod \u5e76\u4e0d\u662f\u59cb\u7ec8\u56fa\u5b9a\u5728\u67d0\u4e2a\u8282\u70b9\u4e0a\u9762\u7684\uff0c\u6240\u4ee5\u8981\u4f7f\u7528 hostPath \u7684\u8bdd\u6211\u4eec\u5c31\u9700\u8981\u5c06 Pod \u56fa\u5b9a\u5728\u67d0\u4e2a\u8282\u70b9\u4e0a\uff0c\u8fd9\u6837\u663e\u7136\u5c31\u5927\u5927\u964d\u4f4e\u4e86\u5e94\u7528\u7684\u5bb9\u9519\u6027\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5c06\u6d4b\u8bd5\u7684\u5e94\u7528\u56fa\u5b9a\u5728\u8282\u70b9 ydzs-node1 \u4e0a\u9762\uff0c\u9996\u5148\u5728\u8be5\u8282\u70b9\u4e0a\u9762\u521b\u5efa\u4e00\u4e2a </p> <pre><code>/data/k8s/test/hostpath\n</code></pre> <p>\u7684\u76ee\u5f55\uff0c\u7136\u540e\u5728\u8be5\u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a <code>index.html</code> \u7684\u6587\u4ef6\uff1a</p> <pre><code>$ echo 'Hello from Kubernetes hostpath storage' &gt; /data/k8s/test/hostpath/index.html\n</code></pre> <p>\u7136\u540e\u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a hostPath \u7c7b\u578b\u7684 PV \u8d44\u6e90\u5bf9\u8c61\uff1a\uff08pv-hostpath.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: pv-hostpath\n  labels:\n    type: local\nspec:\n  storageClassName: manual\n  capacity:\n    storage: 10Gi\n  accessModes:\n    - ReadWriteOnce\n  hostPath:\n    path: \"/data/k8s/test/hostpath\"\n</code></pre> <p>\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\u4e86\u8be5\u5377\u4f4d\u4e8e\u96c6\u7fa4\u8282\u70b9\u4e0a\u7684 </p> <pre><code>/data/k8s/test/hostpath\n</code></pre> <p>\u76ee\u5f55\uff0c\u8fd8\u6307\u5b9a\u4e86 10G \u5927\u5c0f\u7684\u7a7a\u95f4\u548c <code>ReadWriteOnce</code> \u7684\u8bbf\u95ee\u6a21\u5f0f\uff0c\u8fd9\u610f\u5473\u7740\u8be5\u5377\u53ef\u4ee5\u5728\u5355\u4e2a\u8282\u70b9\u4e0a\u4ee5\u8bfb\u5199\u65b9\u5f0f\u6302\u8f7d\uff0c\u53e6\u5916\u8fd8\u5b9a\u4e49\u4e86\u540d\u79f0\u4e3a <code>manual</code> \u7684 <code>StorageClass</code>\uff0c\u8be5\u540d\u79f0\u7528\u6765\u5c06 </p> <pre><code>PersistentVolumeClaim\n</code></pre> <p>\u8bf7\u6c42\u7ed1\u5b9a\u5230\u8be5 <code>PersistentVolum</code>\u3002\u4e0b\u9762\u662f\u5173\u4e8e PV \u7684\u8fd9\u4e9b\u914d\u7f6e\u5c5e\u6027\u7684\u4e00\u4e9b\u8bf4\u660e\uff1a</p> <ul> <li> <p>Capacity\uff08\u5b58\u50a8\u80fd\u529b\uff09\uff1a\u4e00\u822c\u6765\u8bf4\uff0c\u4e00\u4e2a PV \u5bf9\u8c61\u90fd\u8981\u6307\u5b9a\u4e00\u4e2a\u5b58\u50a8\u80fd\u529b\uff0c\u901a\u8fc7 PV \u7684 <code>capacity</code> \u5c5e\u6027\u6765\u8bbe\u7f6e\u7684\uff0c\u76ee\u524d\u53ea\u652f\u6301\u5b58\u50a8\u7a7a\u95f4\u7684\u8bbe\u7f6e\uff0c\u5c31\u662f\u6211\u4eec\u8fd9\u91cc\u7684 <code>storage=10Gi</code>\uff0c\u4e0d\u8fc7\u672a\u6765\u53ef\u80fd\u4f1a\u52a0\u5165 <code>IOPS</code>\u3001\u541e\u5410\u91cf\u7b49\u6307\u6807\u7684\u914d\u7f6e\u3002</p> </li> <li> <p>AccessModes\uff08\u8bbf\u95ee\u6a21\u5f0f\uff09\uff1a\u7528\u6765\u5bf9 PV \u8fdb\u884c\u8bbf\u95ee\u6a21\u5f0f\u7684\u8bbe\u7f6e\uff0c\u7528\u4e8e\u63cf\u8ff0\u7528\u6237\u5e94\u7528\u5bf9\u5b58\u50a8\u8d44\u6e90\u7684\u8bbf\u95ee\u6743\u9650\uff0c\u8bbf\u95ee\u6743\u9650\u5305\u62ec\u4e0b\u9762\u51e0\u79cd\u65b9\u5f0f\uff1a</p> <ul> <li>ReadWriteOnce\uff08RWO\uff09\uff1a\u8bfb\u5199\u6743\u9650\uff0c\u4f46\u662f\u53ea\u80fd\u88ab\u5355\u4e2a\u8282\u70b9\u6302\u8f7d</li> <li>ReadOnlyMany\uff08ROX\uff09\uff1a\u53ea\u8bfb\u6743\u9650\uff0c\u53ef\u4ee5\u88ab\u591a\u4e2a\u8282\u70b9\u6302\u8f7d</li> <li>ReadWriteMany\uff08RWX\uff09\uff1a\u8bfb\u5199\u6743\u9650\uff0c\u53ef\u4ee5\u88ab\u591a\u4e2a\u8282\u70b9\u6302\u8f7d</li> </ul> <p>\u6ce8\u610f</p> <p>\u4e00\u4e9b PV \u53ef\u80fd\u652f\u6301\u591a\u79cd\u8bbf\u95ee\u6a21\u5f0f\uff0c\u4f46\u662f\u5728\u6302\u8f7d\u7684\u65f6\u5019\u53ea\u80fd\u4f7f\u7528\u4e00\u79cd\u8bbf\u95ee\u6a21\u5f0f\uff0c\u591a\u79cd\u8bbf\u95ee\u6a21\u5f0f\u662f\u4e0d\u4f1a\u751f\u6548\u7684\u3002</p> <p>\u4e0b\u56fe\u662f\u4e00\u4e9b\u5e38\u7528\u7684 Volume \u63d2\u4ef6\u652f\u6301\u7684\u8bbf\u95ee\u6a21\u5f0f\uff1a </p> </li> </ul> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pv-hostpath.yaml\npersistentvolume/pv-hostpath created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u67e5\u770b PersistentVolume \u7684\u4fe1\u606f\uff0c\u8f93\u51fa\u7ed3\u679c\u663e\u793a\u8be5 <code>PersistentVolume</code> \u7684\u72b6\u6001\uff08STATUS\uff09 \u4e3a <code>Available</code>\u3002 \u8fd9\u610f\u5473\u7740\u5b83\u8fd8\u6ca1\u6709\u88ab\u7ed1\u5b9a\u7ed9 </p> <pre><code>PersistentVolumeClaim\n</code></pre> <p>\uff1a</p> <pre><code>$ kubectl get pv pv-hostpath\nNAME          CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE\npv-hostpath   10Gi       RWO            Retain           Available           manual                  58s\n</code></pre> <p>\u5176\u4e2d\u6709\u4e00\u9879 <code>RECLAIM POLICY</code> \u7684\u914d\u7f6e\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 PV \u7684 </p> <pre><code>persistentVolumeReclaimPolicy\n</code></pre> <p>\uff08\u56de\u6536\u7b56\u7565\uff09\u5c5e\u6027\u6765\u8fdb\u884c\u914d\u7f6e\uff0c\u76ee\u524d PV \u652f\u6301\u7684\u7b56\u7565\u6709\u4e09\u79cd\uff1a</p> <ul> <li>Retain\uff08\u4fdd\u7559\uff09\uff1a\u4fdd\u7559\u6570\u636e\uff0c\u9700\u8981\u7ba1\u7406\u5458\u624b\u5de5\u6e05\u7406\u6570\u636e</li> <li>Recycle\uff08\u56de\u6536\uff09\uff1a\u6e05\u9664 PV \u4e2d\u7684\u6570\u636e\uff0c\u6548\u679c\u76f8\u5f53\u4e8e\u6267\u884c <code>rm -rf /thevoluem/*</code></li> <li>Delete\uff08\u5220\u9664\uff09\uff1a\u4e0e PV \u76f8\u8fde\u7684\u540e\u7aef\u5b58\u50a8\u5b8c\u6210 volume \u7684\u5220\u9664\u64cd\u4f5c\uff0c\u5f53\u7136\u8fd9\u5e38\u89c1\u4e8e\u4e91\u670d\u52a1\u5546\u7684\u5b58\u50a8\u670d\u52a1\uff0c\u6bd4\u5982 ASW EBS\u3002</li> </ul> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u76ee\u524d\u53ea\u6709 <code>NFS</code> \u548c <code>HostPath</code> \u4e24\u79cd\u7c7b\u578b\u652f\u6301\u56de\u6536\u7b56\u7565\uff0c\u5f53\u7136\u4e00\u822c\u6765\u8bf4\u8fd8\u662f\u8bbe\u7f6e\u4e3a <code>Retain</code> \u8fd9\u79cd\u7b56\u7565\u4fdd\u9669\u4e00\u70b9\u3002</p> <p>\u6ce8\u610f</p> <p><code>Recycle</code> \u7b56\u7565\u4f1a\u901a\u8fc7\u8fd0\u884c\u4e00\u4e2a busybox \u5bb9\u5668\u6765\u6267\u884c\u6570\u636e\u5220\u9664\u547d\u4ee4\uff0c\u9ed8\u8ba4\u5b9a\u4e49\u7684 busybox \u955c\u50cf\u662f\uff1a</p> <pre><code>gcr.io/google_containers/busybox:latest\n</code></pre> <p>\uff0c\u5e76\u4e14 </p> <pre><code>imagePullPolicy: Always\n</code></pre> <p>\uff0c\u5982\u679c\u9700\u8981\u8c03\u6574\u914d\u7f6e\uff0c\u9700\u8981\u589e\u52a0</p> <pre><code>kube-controller-manager\n</code></pre> <p>\u542f\u52a8\u53c2\u6570\uff1a</p> <pre><code>--pv-recycler-pod-template-filepath-hostpath\n</code></pre> <p>\u6765\u8fdb\u884c\u914d\u7f6e\u3002</p> <p>\u5173\u4e8e PV \u7684\u72b6\u6001\uff0c\u5b9e\u9645\u4e0a\u63cf\u8ff0\u7684\u662f PV \u7684\u751f\u547d\u5468\u671f\u7684\u67d0\u4e2a\u9636\u6bb5\uff0c\u4e00\u4e2a PV \u7684\u751f\u547d\u5468\u671f\u4e2d\uff0c\u53ef\u80fd\u4f1a\u5904\u4e8e4\u79cd\u4e0d\u540c\u7684\u9636\u6bb5\uff1a</p> <ul> <li>Available\uff08\u53ef\u7528\uff09\uff1a\u8868\u793a\u53ef\u7528\u72b6\u6001\uff0c\u8fd8\u672a\u88ab\u4efb\u4f55 PVC \u7ed1\u5b9a</li> <li>Bound\uff08\u5df2\u7ed1\u5b9a\uff09\uff1a\u8868\u793a PVC \u5df2\u7ecf\u88ab PVC \u7ed1\u5b9a</li> <li>Released\uff08\u5df2\u91ca\u653e\uff09\uff1aPVC \u88ab\u5220\u9664\uff0c\u4f46\u662f\u8d44\u6e90\u8fd8\u672a\u88ab\u96c6\u7fa4\u91cd\u65b0\u58f0\u660e</li> <li>Failed\uff08\u5931\u8d25\uff09\uff1a \u8868\u793a\u8be5 PV \u7684\u81ea\u52a8\u56de\u6536\u5931\u8d25</li> </ul> <p>\u73b0\u5728\u6211\u4eec\u521b\u5efa\u5b8c\u6210\u4e86 PV\uff0c\u5982\u679c\u6211\u4eec\u9700\u8981\u4f7f\u7528\u8fd9\u4e2a PV \u7684\u8bdd\uff0c\u5c31\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 PVC \u6765\u548c\u4ed6\u8fdb\u884c\u7ed1\u5b9a\u4e86\uff0c\u5c31\u7c7b\u4f3c\u4e8e\u6211\u4eec\u7684\u670d\u52a1\u662f\u901a\u8fc7 Pod \u6765\u8fd0\u884c\u7684\uff0c\u800c\u4e0d\u662f Node\uff0c\u53ea\u662f Pod \u8dd1\u5728 Node \u4e0a\u800c\u5df2\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a </p> <pre><code>PersistentVolumeClaim\n</code></pre> <p>\uff0cPod \u4f7f\u7528 PVC \u6765\u8bf7\u6c42\u7269\u7406\u5b58\u50a8\uff0c\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u7684 PVC \u8bf7\u6c42\u81f3\u5c11 3G \u5bb9\u91cf\u7684\u5377\uff0c\u8be5\u5377\u81f3\u5c11\u53ef\u4ee5\u4e3a\u4e00\u4e2a\u8282\u70b9\u63d0\u4f9b\u8bfb\u5199\u8bbf\u95ee\uff0c\u4e0b\u9762\u662f PVC \u7684\u914d\u7f6e\u6587\u4ef6\uff1a(pvc-hostpath.yaml)</p> <pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: pvc-hostpath\nspec:\n  storageClassName: manual\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 3Gi\n</code></pre> <p>\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a PVC \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f pvc-hostpath.yaml\npersistentvolumeclaim/pvc-hostpath created\n</code></pre> <p>\u521b\u5efa PVC \u4e4b\u540e\uff0cKubernetes \u5c31\u4f1a\u53bb\u67e5\u627e\u6ee1\u8db3\u6211\u4eec\u58f0\u660e\u8981\u6c42\u7684 PV\uff0c\u6bd4\u5982 <code>storageClassName</code>\u3001<code>accessModes</code> \u4ee5\u53ca\u5bb9\u91cf\u8fd9\u4e9b\u662f\u5426\u6ee1\u8db3\u8981\u6c42\uff0c\u5982\u679c\u6ee1\u8db3\u8981\u6c42\u5c31\u4f1a\u5c06 PV \u548c PVC \u7ed1\u5b9a\u5728\u4e00\u8d77\u3002</p> <p>\u6ce8\u610f</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u76ee\u524d PV \u548c PVC \u4e4b\u95f4\u662f\u4e00\u5bf9\u4e00\u7ed1\u5b9a\u7684\u5173\u7cfb\uff0c\u4e5f\u5c31\u662f\u8bf4\u4e00\u4e2a PV \u53ea\u80fd\u88ab\u4e00\u4e2a PVC \u7ed1\u5b9a\u3002</p> <p>\u6211\u4eec\u73b0\u5728\u518d\u6b21\u67e5\u770b PV \u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pv -l type=local\nNAME          CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                  STORAGECLASS   REASON   AGE\npv-hostpath   10Gi       RWO            Retain           Bound    default/pvc-hostpath   manual                  81m\n</code></pre> <p>\u73b0\u5728\u8f93\u51fa\u7684 STATUS \u4e3a <code>Bound</code>\uff0c\u67e5\u770b PVC \u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pvc pvc-hostpath\nNAME           STATUS   VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS   AGE\npvc-hostpath   Bound    pv-hostpath   10Gi       RWO            manual         6m47s\n</code></pre> <p>\u8f93\u51fa\u7ed3\u679c\u8868\u660e\u8be5 PVC \u7ed1\u5b9a\u4e86\u5230\u4e86\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684 <code>pv-hostpath</code> \u8fd9\u4e2a PV \u4e0a\u9762\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u867d\u7136\u58f0\u660e\u76843G\u7684\u5bb9\u91cf\uff0c\u4f46\u662f\u7531\u4e8e PV \u91cc\u9762\u662f 10G\uff0c\u6240\u4ee5\u663e\u7136\u4e5f\u662f\u6ee1\u8db3\u8981\u6c42\u7684\u3002</p> <p>PVC \u51c6\u5907\u597d\u8fc7\u540e\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u53ef\u4ee5\u6765\u521b\u5efa Pod \u4e86\uff0c\u8be5 Pod \u4f7f\u7528\u4e0a\u9762\u6211\u4eec\u58f0\u660e\u7684 PVC \u4f5c\u4e3a\u5b58\u50a8\u5377\uff1a(pv-hostpath-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: pv-hostpath-pod\nspec:\n  volumes:\n  - name: pv-hostpath\n    persistentVolumeClaim:\n      claimName: pvc-hostpath\n  nodeSelector:\n    kubernetes.io/hostname: ydzs-node1\n  containers:\n  - name: task-pv-container\n    image: nginx\n    ports:\n    - containerPort: 80\n    volumeMounts:\n    - mountPath: \"/usr/share/nginx/html\"\n      name: pv-hostpath\n</code></pre> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u7531\u4e8e\u6211\u4eec\u521b\u5efa\u7684 PV \u771f\u6b63\u7684\u5b58\u50a8\u5728\u8282\u70b9 ydzs-node1 \u4e0a\u9762\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u5fc5\u987b\u628a Pod \u56fa\u5b9a\u5728\u8fd9\u4e2a\u8282\u70b9\u4e0b\u9762\uff0c\u53e6\u5916\u53ef\u4ee5\u6ce8\u610f\u5230 Pod \u7684\u914d\u7f6e\u6587\u4ef6\u6307\u5b9a\u4e86 </p> <pre><code>PersistentVolumeClaim\n</code></pre> <p>\uff0c\u4f46\u6ca1\u6709\u6307\u5b9a <code>PersistentVolume</code>\uff0c\u5bf9 Pod \u800c\u8a00\uff0c<code>PVC</code> \u5c31\u662f\u4e00\u4e2a\u5b58\u50a8\u5377\u3002\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Pod \u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl create -f pv-hostpath-pod.yaml\npod/pv-hostpath-pod created\n$ kubectl get pod pv-hostpath-pod\nNAME              READY   STATUS    RESTARTS   AGE\npv-hostpath-pod   1/1     Running   0          105s\n</code></pre> <p>\u8fd0\u884c\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6253\u5f00\u4e00\u4e2a shell \u8bbf\u95ee Pod \u4e2d\u7684\u5bb9\u5668\uff1a</p> <pre><code>$ kubectl exec -it pv-hostpath-pod -- /bin/bash\n</code></pre> <p>\u5728 shell \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u9a8c\u8bc1 nginx \u7684\u6570\u636e \u662f\u5426\u6b63\u5728\u4ece hostPath \u5377\u63d0\u4f9b index.html \u6587\u4ef6\uff1a</p> <pre><code>root@pv-hostpath-pod:/# apt-get update\nroot@pv-hostpath-pod:/# apt-get install curl -y\nroot@pv-hostpath-pod:/# curl localhost\nHello from Kubernetes hostpath storage\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8f93\u51fa\u7ed3\u679c\u662f\u6211\u4eec\u524d\u9762\u5199\u5230 hostPath \u5377\u79cd\u7684 index.html \u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u628a Pod \u5220\u9664\uff0c\u7136\u540e\u518d\u6b21\u91cd\u5efa\u518d\u6d4b\u8bd5\u4e00\u6b21\uff0c\u53ef\u4ee5\u53d1\u73b0\u5185\u5bb9\u8fd8\u662f\u6211\u4eec\u5728 hostPath \u79cd\u8bbe\u7f6e\u7684\u5185\u5bb9\u3002</p> <p>\u6211\u4eec\u5728\u6301\u4e45\u5316\u5bb9\u5668\u6570\u636e\u7684\u65f6\u5019\u4f7f\u7528 PV/PVC \u6709\u4ec0\u4e48\u597d\u5904\u5462\uff1f\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4e4b\u524d\u76f4\u63a5\u5728 Pod \u4e0b\u9762\u4e5f\u53ef\u4ee5\u4f7f\u7528 hostPath \u6765\u6301\u4e45\u5316\u6570\u636e\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u8981\u8d39\u52b2\u53bb\u521b\u5efa PV\u3001PVC \u5bf9\u8c61\u6765\u5f15\u7528\u5462\uff1fPVC \u548c PV \u7684\u8bbe\u8ba1\uff0c\u5176\u5b9e\u8ddf<code>\u9762\u5411\u5bf9\u8c61</code>\u7684\u601d\u60f3\u5b8c\u5168\u4e00\u81f4\uff0cPVC \u53ef\u4ee5\u7406\u89e3\u4e3a\u6301\u4e45\u5316\u5b58\u50a8\u7684\u63a5\u53e3\uff0c\u5b83\u63d0\u4f9b\u4e86\u5bf9\u67d0\u79cd\u6301\u4e45\u5316\u5b58\u50a8\u7684\u63cf\u8ff0\uff0c\u4f46\u4e0d\u63d0\u4f9b\u5177\u4f53\u7684\u5b9e\u73b0\uff1b\u800c\u8fd9\u4e2a\u6301\u4e45\u5316\u5b58\u50a8\u7684\u5b9e\u73b0\u90e8\u5206\u5219\u7531 PV \u8d1f\u8d23\u5b8c\u6210\u3002\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\uff0c\u4f5c\u4e3a\u5e94\u7528\u5f00\u53d1\u8005\uff0c\u6211\u4eec\u53ea\u9700\u8981\u8ddf PVC \u8fd9\u4e2a\u63a5\u53e3\u6253\u4ea4\u9053\uff0c\u800c\u4e0d\u5fc5\u5173\u5fc3\u5177\u4f53\u7684\u5b9e\u73b0\u662f hostPath\u3001NFS \u8fd8\u662f Ceph\u3002\u6bd5\u7adf\u8fd9\u4e9b\u5b58\u50a8\u76f8\u5173\u7684\u77e5\u8bc6\u592a\u4e13\u4e1a\u4e86\uff0c\u5e94\u8be5\u4ea4\u7ed9\u4e13\u4e1a\u7684\u4eba\u53bb\u505a\uff0c\u8fd9\u6837\u5bf9\u4e8e\u6211\u4eec\u7684 Pod \u6765\u8bf4\u5c31\u4e0d\u7528\u7ba1\u5177\u4f53\u7684\u7ec6\u8282\u4e86\uff0c\u4f60\u53ea\u9700\u8981\u7ed9\u6211\u4e00\u4e2a\u53ef\u7528\u7684 PVC \u5373\u53ef\u4e86\uff0c\u8fd9\u6837\u662f\u4e0d\u662f\u5c31\u5b8c\u5168\u5c4f\u853d\u4e86\u7ec6\u8282\u548c\u89e3\u8026\u4e86\u554a\uff0c\u6240\u4ee5\u6211\u4eec\u66f4\u5e94\u8be5\u4f7f\u7528 PV\u3001PVC \u8fd9\u79cd\u65b9\u5f0f\u3002</p>"},{"location":"kubernetes_stroage/local/#local_pv","title":"Local PV","text":"<p>\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u4e86\u540e\u7aef\u662f hostPath \u7c7b\u578b\u7684 PV \u8d44\u6e90\u5bf9\u8c61\uff0c\u6211\u4eec\u4e5f\u63d0\u5230\u4e86\uff0c\u4f7f\u7528 hostPath \u6709\u4e00\u4e2a\u5c40\u9650\u6027\u5c31\u662f\uff0c\u6211\u4eec\u7684 Pod \u4e0d\u80fd\u968f\u4fbf\u6f02\u79fb\uff0c\u9700\u8981\u56fa\u5b9a\u5230\u4e00\u4e2a\u8282\u70b9\u4e0a\uff0c\u56e0\u4e3a\u4e00\u65e6\u6f02\u79fb\u5230\u5176\u4ed6\u8282\u70b9\u4e0a\u53bb\u4e86\u5bbf\u4e3b\u673a\u4e0a\u9762\u5c31\u6ca1\u6709\u5bf9\u5e94\u7684\u6570\u636e\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u4f7f\u7528 hostPath \u7684\u65f6\u5019\u90fd\u4f1a\u642d\u914d nodeSelector \u6765\u8fdb\u884c\u4f7f\u7528\u3002\u4f46\u662f\u4f7f\u7528 hostPath \u660e\u663e\u4e5f\u6709\u4e00\u4e9b\u597d\u5904\u7684\uff0c\u56e0\u4e3a PV \u76f4\u63a5\u4f7f\u7528\u7684\u662f\u672c\u5730\u78c1\u76d8\uff0c\u5c24\u5176\u662f SSD \u76d8\uff0c\u5b83\u7684\u8bfb\u5199\u6027\u80fd\u76f8\u6bd4\u4e8e\u5927\u591a\u6570\u8fdc\u7a0b\u5b58\u50a8\u6765\u8bf4\uff0c\u8981\u597d\u5f97\u591a\uff0c\u6240\u4ee5\u5bf9\u4e8e\u4e00\u4e9b\u5bf9\u78c1\u76d8 IO \u8981\u6c42\u6bd4\u8f83\u9ad8\u7684\u5e94\u7528\u6bd4\u5982 etcd \u5c31\u975e\u5e38\u5b9e\u7528\u4e86\u3002\u4e0d\u8fc7\u5462\uff0c\u76f8\u6bd4\u4e8e\u6b63\u5e38\u7684 PV \u6765\u8bf4\uff0c\u4f7f\u7528\u4e86 hostPath \u7684\u8fd9\u4e9b\u8282\u70b9\u4e00\u65e6\u5b95\u673a\u6570\u636e\u5c31\u53ef\u80fd\u4e22\u5931\uff0c\u6240\u4ee5\u8fd9\u5c31\u8981\u6c42\u4f7f\u7528 hostPath \u7684\u5e94\u7528\u5fc5\u987b\u5177\u5907\u6570\u636e\u5907\u4efd\u548c\u6062\u590d\u7684\u80fd\u529b\uff0c\u5141\u8bb8\u4f60\u628a\u8fd9\u4e9b\u6570\u636e\u5b9a\u65f6\u5907\u4efd\u5728\u5176\u4ed6\u4f4d\u7f6e\u3002</p> <p>\u6240\u4ee5\u5728 hostPath \u7684\u57fa\u7840\u4e0a\uff0cKubernetes \u4f9d\u9760 PV\u3001PVC \u5b9e\u73b0\u4e86\u4e00\u4e2a\u65b0\u7684\u7279\u6027\uff0c\u8fd9\u4e2a\u7279\u6027\u7684\u540d\u5b57\u53eb\u4f5c\uff1a</p> <pre><code>Local Persistent Volume\n</code></pre> <p>\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u8bf4\u7684 <code>Local PV</code>\u3002</p> <p>\u5176\u5b9e <code>Local PV</code> \u5b9e\u73b0\u7684\u529f\u80fd\u5c31\u975e\u5e38\u7c7b\u4f3c\u4e8e <code>hostPath</code> \u52a0\u4e0a <code>nodeAffinity</code>\uff0c\u6bd4\u5982\uff0c\u4e00\u4e2a Pod \u53ef\u4ee5\u58f0\u660e\u4f7f\u7528\u7c7b\u578b\u4e3a Local \u7684 PV\uff0c\u800c\u8fd9\u4e2a PV \u5176\u5b9e\u5c31\u662f\u4e00\u4e2a hostPath \u7c7b\u578b\u7684 Volume\u3002\u5982\u679c\u8fd9\u4e2a hostPath \u5bf9\u5e94\u7684\u76ee\u5f55\uff0c\u5df2\u7ecf\u5728\u8282\u70b9 A \u4e0a\u88ab\u4e8b\u5148\u521b\u5efa\u597d\u4e86\uff0c\u90a3\u4e48\uff0c\u6211\u53ea\u9700\u8981\u518d\u7ed9\u8fd9\u4e2a Pod \u52a0\u4e0a\u4e00\u4e2a <code>nodeAffinity=nodeA</code>\uff0c\u4e0d\u5c31\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a Volume \u4e86\u5417\uff1f\u7406\u8bba\u4e0a\u786e\u5b9e\u662f\u53ef\u884c\u7684\uff0c\u4f46\u662f\u4e8b\u5b9e\u4e0a\uff0c\u6211\u4eec\u7edd\u4e0d\u5e94\u8be5\u628a\u4e00\u4e2a\u5bbf\u4e3b\u673a\u4e0a\u7684\u76ee\u5f55\u5f53\u4f5c PV \u6765\u4f7f\u7528\uff0c\u56e0\u4e3a\u672c\u5730\u76ee\u5f55\u7684\u5b58\u50a8\u884c\u4e3a\u662f\u5b8c\u5168\u4e0d\u53ef\u63a7\uff0c\u5b83\u6240\u5728\u7684\u78c1\u76d8\u968f\u65f6\u90fd\u53ef\u80fd\u88ab\u5e94\u7528\u5199\u6ee1\uff0c\u751a\u81f3\u9020\u6210\u6574\u4e2a\u5bbf\u4e3b\u673a\u5b95\u673a\u3002\u6240\u4ee5\uff0c\u4e00\u822c\u6765\u8bf4 <code>Local PV</code> \u5bf9\u5e94\u7684\u5b58\u50a8\u4ecb\u8d28\u662f\u4e00\u5757\u989d\u5916\u6302\u8f7d\u5728\u5bbf\u4e3b\u673a\u7684\u78c1\u76d8\u6216\u8005\u5757\u8bbe\u5907\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3a\u5c31\u662f<code>\u4e00\u4e2a PV \u4e00\u5757\u76d8</code>\u3002</p> <p>\u53e6\u5916\u4e00\u4e2a <code>Local PV</code> \u548c\u666e\u901a\u7684 PV \u6709\u4e00\u4e2a\u5f88\u5927\u7684\u4e0d\u540c\u5728\u4e8e <code>Local PV</code> \u53ef\u4ee5\u4fdd\u8bc1 Pod \u59cb\u7ec8\u80fd\u591f\u88ab\u6b63\u786e\u5730\u8c03\u5ea6\u5230\u5b83\u6240\u8bf7\u6c42\u7684 <code>Local PV</code> \u6240\u5728\u7684\u8282\u70b9\u4e0a\u9762\uff0c\u5bf9\u4e8e\u666e\u901a\u7684 PV \u6765\u8bf4\uff0cKubernetes \u90fd\u662f\u5148\u8c03\u5ea6 Pod \u5230\u67d0\u4e2a\u8282\u70b9\u4e0a\uff0c\u7136\u540e\u518d\u6301\u4e45\u5316\u8282\u70b9\u4e0a\u7684 Volume \u76ee\u5f55\uff0c\u8fdb\u800c\u5b8c\u6210 Volume \u76ee\u5f55\u4e0e\u5bb9\u5668\u7684\u7ed1\u5b9a\u6302\u8f7d\uff0c\u4f46\u662f\u5bf9\u4e8e <code>Local PV</code> \u6765\u8bf4\uff0c\u8282\u70b9\u4e0a\u53ef\u4f9b\u4f7f\u7528\u7684\u78c1\u76d8\u5fc5\u987b\u662f\u63d0\u524d\u51c6\u5907\u597d\u7684\uff0c\u56e0\u4e3a\u5b83\u4eec\u5728\u4e0d\u540c\u8282\u70b9\u4e0a\u7684\u6302\u8f7d\u60c5\u51b5\u53ef\u80fd\u5b8c\u5168\u4e0d\u540c\uff0c\u751a\u81f3\u6709\u7684\u8282\u70b9\u53ef\u4ee5\u6ca1\u8fd9\u79cd\u78c1\u76d8\uff0c\u6240\u4ee5\uff0c\u8fd9\u65f6\u5019\uff0c\u8c03\u5ea6\u5668\u5c31\u5fc5\u987b\u80fd\u591f\u77e5\u9053\u6240\u6709\u8282\u70b9\u4e0e <code>Local PV</code> \u5bf9\u5e94\u7684\u78c1\u76d8\u7684\u5173\u8054\u5173\u7cfb\uff0c\u7136\u540e\u6839\u636e\u8fd9\u4e2a\u4fe1\u606f\u6765\u8c03\u5ea6 Pod\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u5728\u8c03\u5ea6\u7684\u65f6\u5019\u8003\u8651 Volume \u7684\u5206\u5e03\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u6d4b\u8bd5\u4e0b <code>Local PV</code> \u7684\u4f7f\u7528\uff0c\u5f53\u7136\u6309\u7167\u4e0a\u9762\u6211\u4eec\u7684\u5206\u6790\u6211\u4eec\u5e94\u8be5\u7ed9\u5bbf\u4e3b\u673a\u6302\u8f7d\u5e76\u683c\u5f0f\u5316\u4e00\u4e2a\u53ef\u7528\u7684\u78c1\u76d8\uff0c\u6211\u4eec\u8fd9\u91cc\u5c31\u6682\u65f6\u5c06 ydzs-node1 \u8282\u70b9\u4e0a\u7684 <code>/data/k8s/localpv</code> \u8fd9\u4e2a\u76ee\u5f55\u770b\u6210\u662f\u6302\u8f7d\u7684\u4e00\u4e2a\u72ec\u7acb\u7684\u78c1\u76d8\u3002\u73b0\u5728\u6211\u4eec\u6765\u58f0\u660e\u4e00\u4e2a <code>Local PV</code> \u7c7b\u578b\u7684 PV\uff0c\u5982\u4e0b\u6240\u793a\uff1a(pv-local.yaml)</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: pv-local\nspec:\n  capacity:\n    storage: 5Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/k8s/localpv  # ydzs-node1\u8282\u70b9\u4e0a\u7684\u76ee\u5f55\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - ydzs-node1\n</code></pre> <p>\u548c\u524d\u9762\u6211\u4eec\u5b9a\u4e49\u7684 PV \u4e0d\u540c\uff0c\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a <code>local</code> \u5b57\u6bb5\uff0c\u8868\u660e\u5b83\u662f\u4e00\u4e2a <code>Local PV</code>\uff0c\u800c path \u5b57\u6bb5\uff0c\u6307\u5b9a\u7684\u6b63\u662f\u8fd9\u4e2a PV \u5bf9\u5e94\u7684\u672c\u5730\u78c1\u76d8\u7684\u8def\u5f84\uff0c\u5373\uff1a<code>/data/k8s/localpv</code>\uff0c\u8fd9\u4e5f\u5c31\u610f\u5473\u7740\u5982\u679c Pod \u8981\u60f3\u4f7f\u7528\u8fd9\u4e2a PV\uff0c\u90a3\u5b83\u5c31\u5fc5\u987b\u8fd0\u884c\u5728 ydzs-node1 \u8282\u70b9\u4e0a\u3002\u6240\u4ee5\uff0c\u5728\u8fd9\u4e2a PV \u7684\u5b9a\u4e49\u91cc\uff0c\u6dfb\u52a0\u4e86\u4e00\u4e2a\u8282\u70b9\u4eb2\u548c\u6027 <code>nodeAffinity</code> \u5b57\u6bb5\u6307\u5b9a ydzs-node1 \u8fd9\u4e2a\u8282\u70b9\u3002\u8fd9\u6837\uff0c\u8c03\u5ea6\u5668\u5728\u8c03\u5ea6 Pod \u7684\u65f6\u5019\uff0c\u5c31\u80fd\u591f\u77e5\u9053\u4e00\u4e2a PV \u4e0e\u8282\u70b9\u7684\u5bf9\u5e94\u5173\u7cfb\uff0c\u4ece\u800c\u505a\u51fa\u6b63\u786e\u7684\u9009\u62e9\u3002</p> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pv-local.yaml \npersistentvolume/pv-local created\n$ kubectl get pv\nNAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS  CLAIM      STORAGECLASS      REASON   AGE\npv-local  5Gi        RWO            Delete           Available          local-storage              24s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a PV \u521b\u5efa\u540e\uff0c\u8fdb\u5165\u4e86 <code>Available</code>\uff08\u53ef\u7528\uff09\u72b6\u6001\u3002\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u6309\u7167\u524d\u9762\u63d0\u5230\u7684\uff0c\u6211\u4eec\u8981\u4f7f\u7528\u8fd9\u4e2a <code>Local PV</code> \u7684\u8bdd\u5c31\u9700\u8981\u53bb\u521b\u5efa\u4e00\u4e2a PVC \u548c\u4ed6\u8fdb\u884c\u7ed1\u5b9a\uff1a(pvc-local.yaml)</p> <pre><code>kind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\n  name: pvc-local\nspec:\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 5Gi\n  storageClassName: local-storage\n</code></pre> <p>\u540c\u6837\u8981\u6ce8\u610f\u58f0\u660e\u7684\u8fd9\u4e9b\u5c5e\u6027\u9700\u8981\u548c\u4e0a\u9762\u7684 PV \u5bf9\u5e94\uff0c\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pvc-local.yaml \npersistentvolumeclaim/pvc-local created\n$ kubectl get pvc\nNAME           STATUS   VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS    AGE\npvc-local      Bound    pv-local      5Gi        RWO            local-storage   38s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u73b0\u5728 PVC \u548c PV \u5df2\u7ecf\u5904\u4e8e <code>Bound</code> \u7ed1\u5b9a\u72b6\u6001\u4e86\u3002\u4f46\u5b9e\u9645\u4e0a\u8fd9\u662f\u4e0d\u7b26\u5408\u6211\u4eec\u7684\u9700\u6c42\u7684\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u7684 Pod \u58f0\u660e\u4f7f\u7528\u8fd9\u4e2a pvc-local\uff0c\u5e76\u4e14\u6211\u4eec\u4e5f\u660e\u786e\u89c4\u5b9a\uff0c\u8fd9\u4e2a Pod \u53ea\u80fd\u8fd0\u884c\u5728 ydzs-node2 \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff0c\u5982\u679c\u6309\u7167\u4e0a\u9762\u6211\u4eec\u8fd9\u91cc\u7684\u64cd\u4f5c\uff0c\u8fd9\u4e2a pvc-local \u662f\u4e0d\u662f\u5c31\u548c\u6211\u4eec\u8fd9\u91cc\u7684 pv-local \u8fd9\u4e2a <code>Local PV</code> \u7ed1\u5b9a\u5728\u4e00\u8d77\u4e86\uff0c\u4f46\u662f\u8fd9\u4e2a PV \u7684\u5b58\u50a8\u5238\u53c8\u5728 ydzs-node1 \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff0c\u663e\u7136\u5c31\u4f1a\u51fa\u73b0\u51b2\u7a81\u4e86\uff0c\u90a3\u4e48\u8fd9\u4e2a Pod \u7684\u8c03\u5ea6\u80af\u5b9a\u5c31\u4f1a\u5931\u8d25\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u4f7f\u7528 <code>Local PV</code> \u7684\u65f6\u5019\uff0c\u5fc5\u987b\u60f3\u529e\u6cd5\u5ef6\u8fdf\u8fd9\u4e2a<code>\u7ed1\u5b9a</code>\u64cd\u4f5c\u3002</p> <p>\u8981\u600e\u4e48\u6765\u5b9e\u73b0\u8fd9\u4e2a\u5ef6\u8fdf\u7ed1\u5b9a\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa <code>StorageClass</code> \u6765\u6307\u5b9a\u8fd9\u4e2a\u52a8\u4f5c\uff0c\u5728 StorageClass \u79cd\u6709\u4e00\u4e2a </p> <pre><code>volumeBindingMode=WaitForFirstConsumer\n</code></pre> <p>\u7684\u5c5e\u6027\uff0c\u5c31\u662f\u544a\u8bc9 Kubernetes \u5728\u53d1\u73b0\u8fd9\u4e2a StorageClass \u5173\u8054\u7684 PVC \u4e0e PV \u53ef\u4ee5\u7ed1\u5b9a\u5728\u4e00\u8d77\uff0c\u4f46\u4e0d\u8981\u73b0\u5728\u5c31\u7acb\u523b\u6267\u884c\u7ed1\u5b9a\u64cd\u4f5c\uff08\u5373\uff1a\u8bbe\u7f6e PVC \u7684 VolumeName \u5b57\u6bb5\uff09\uff0c\u800c\u662f\u8981\u7b49\u5230\u7b2c\u4e00\u4e2a\u58f0\u660e\u4f7f\u7528\u8be5 PVC \u7684 Pod \u51fa\u73b0\u5728\u8c03\u5ea6\u5668\u4e4b\u540e\uff0c\u8c03\u5ea6\u5668\u518d\u7efc\u5408\u8003\u8651\u6240\u6709\u7684\u8c03\u5ea6\u89c4\u5219\uff0c\u5f53\u7136\u4e5f\u5305\u62ec\u6bcf\u4e2a PV \u6240\u5728\u7684\u8282\u70b9\u4f4d\u7f6e\uff0c\u6765\u7edf\u4e00\u51b3\u5b9a\uff0c\u8fd9\u4e2a Pod \u58f0\u660e\u7684 PVC\uff0c\u5230\u5e95\u5e94\u8be5\u8ddf\u54ea\u4e2a PV \u8fdb\u884c\u7ed1\u5b9a\u3002\u901a\u8fc7\u8fd9\u4e2a\u5ef6\u8fdf\u7ed1\u5b9a\u673a\u5236\uff0c\u539f\u672c\u5b9e\u65f6\u53d1\u751f\u7684 PVC \u548c PV \u7684\u7ed1\u5b9a\u8fc7\u7a0b\uff0c\u5c31\u88ab\u5ef6\u8fdf\u5230\u4e86 Pod \u7b2c\u4e00\u6b21\u8c03\u5ea6\u7684\u65f6\u5019\u5728\u8c03\u5ea6\u5668\u4e2d\u8fdb\u884c\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e86\u8fd9\u4e2a\u7ed1\u5b9a\u7ed3\u679c\u4e0d\u4f1a\u5f71\u54cd Pod \u7684\u6b63\u5e38\u8c03\u5ea6\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u9700\u8981\u521b\u5efa\u5bf9\u5e94\u7684 <code>StorageClass</code> \u5bf9\u8c61\uff1a\uff08local-storageclass.yaml\uff09</p> <pre><code>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: local-storage\nprovisioner: kubernetes.io/no-provisioner\nvolumeBindingMode: WaitForFirstConsumer\n</code></pre> <p>\u8fd9\u4e2a <code>StorageClass</code> \u7684\u540d\u5b57\uff0c\u53eb\u4f5c local-storage\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5728 PV \u4e2d\u58f0\u660e\u7684\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u5b83\u7684 <code>provisioner</code> \u5b57\u6bb5\uff0c\u6211\u4eec\u6307\u5b9a\u7684\u662f <code>no-provisioner</code>\u3002\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u662f\u624b\u52a8\u521b\u5efa\u7684 PV\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u52a8\u6001\u6765\u751f\u6210 PV\uff0c\u53e6\u5916\u8fd9\u4e2a StorageClass \u8fd8\u5b9a\u4e49\u4e86\u4e00\u4e2a </p> <pre><code>volumeBindingMode=WaitForFirstConsumer\n</code></pre> <p>\u7684\u5c5e\u6027\uff0c\u5b83\u662f <code>Local PV</code> \u91cc\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7279\u6027\uff0c\u5373\uff1a<code>\u5ef6\u8fdf\u7ed1\u5b9a</code>\u3002\u901a\u8fc7\u8fd9\u4e2a\u5ef6\u8fdf\u7ed1\u5b9a\u673a\u5236\uff0c\u539f\u672c\u5b9e\u65f6\u53d1\u751f\u7684 PVC \u548c PV \u7684\u7ed1\u5b9a\u8fc7\u7a0b\uff0c\u5c31\u88ab\u5ef6\u8fdf\u5230\u4e86 Pod \u7b2c\u4e00\u6b21\u8c03\u5ea6\u7684\u65f6\u5019\u5728\u8c03\u5ea6\u5668\u4e2d\u8fdb\u884c\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e86\u8fd9\u4e2a\u7ed1\u5b9a\u7ed3\u679c\u4e0d\u4f1a\u5f71\u54cd Pod \u7684\u6b63\u5e38\u8c03\u5ea6\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u8fd9\u4e2a StorageClass \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f local-storageclass.yaml \nstorageclass.storage.k8s.io/local-storage created\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u5220\u9664\u4e0a\u9762\u58f0\u660e\u7684 PVC \u5bf9\u8c61\uff0c\u91cd\u65b0\u521b\u5efa\uff1a</p> <pre><code>$ kubectl delete -f pvc-local.yaml \npersistentvolumeclaim \"pvc-local\" deleted\n$ kubectl create -f pvc-local.yaml\npersistentvolumeclaim/pvc-local created\n$ kubectl get pvc\nNAME           STATUS    VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS    AGE\npvc-local      Pending                                           local-storage   3s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u8fd9\u4e2a\u65f6\u5019\uff0c\u96c6\u7fa4\u4e2d\u5373\u4f7f\u5df2\u7ecf\u5b58\u5728\u4e86\u4e00\u4e2a\u53ef\u4ee5\u4e0e PVC \u5339\u914d\u7684 PV \u4e86\uff0c\u4f46\u8fd9\u4e2a PVC \u4f9d\u7136\u5904\u4e8e <code>Pending</code> \u72b6\u6001\uff0c\u4e5f\u5c31\u662f\u7b49\u5f85\u7ed1\u5b9a\u7684\u72b6\u6001\uff0c\u8fd9\u5c31\u662f\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u7684\u662f\u5ef6\u8fdf\u7ed1\u5b9a\uff0c\u9700\u8981\u5728\u771f\u6b63\u7684 Pod \u4f7f\u7528\u7684\u65f6\u5019\u624d\u4f1a\u6765\u505a\u7ed1\u5b9a\u3002</p> <p>\u540c\u6837\u6211\u4eec\u58f0\u660e\u4e00\u4e2a Pod \u6765\u4f7f\u7528\u8fd9\u91cc\u7684 pvc-local \u8fd9\u4e2a PVC\uff0c\u8d44\u6e90\u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a(pv-local-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: pv-local-pod\nspec:\n  volumes:\n  - name: example-pv-local\n    persistentVolumeClaim:\n      claimName: pvc-local\n  containers:\n  - name: example-pv-local\n    image: nginx\n    ports:\n    - containerPort: 80\n    volumeMounts:\n    - mountPath: /usr/share/nginx/html\n      name: example-pv-local\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl apply -f pv-local-pod.yaml \npod/pv-local-pod created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u8fd9\u4e2a\u65f6\u5019\u53bb\u67e5\u770b\u524d\u9762\u6211\u4eec\u58f0\u660e\u7684 PVC\uff0c\u4f1a\u7acb\u523b\u53d8\u6210 <code>Bound</code> \u72b6\u6001\uff0c\u4e0e\u524d\u9762\u5b9a\u4e49\u7684 PV \u7ed1\u5b9a\u5728\u4e86\u4e00\u8d77\uff1a</p> <pre><code>$ kubectl get pvc\nNAME           STATUS   VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS    AGE\npvc-local      Bound    pv-local      5Gi        RWO            local-storage   4m59s\n</code></pre> <p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u5728\u8fd9\u4e2a Pod \u7684 Volume \u76ee\u5f55\u91cc\uff0c\u521b\u5efa\u4e00\u4e2a\u6d4b\u8bd5\u6587\u4ef6\uff0c\u6bd4\u5982\uff1a</p> <pre><code>$ kubectl exec -it pv-local-pod /bin/sh\n# cd /usr/share/nginx/html\n# echo \"Hello from Kubernetes local pv storage\" &gt; test.txt  \n#\n</code></pre> <p>\u7136\u540e\uff0c\u767b\u5f55\u5230 ydzs-node1 \u8fd9\u53f0\u673a\u5668\u4e0a\uff0c\u67e5\u770b\u4e00\u4e0b\u5b83\u7684 <code>/data/k8s/localpv</code> \u76ee\u5f55\u4e0b\u7684\u5185\u5bb9\uff0c\u4f60\u5c31\u53ef\u4ee5\u770b\u5230\u521a\u521a\u521b\u5efa\u7684\u8fd9\u4e2a\u6587\u4ef6\uff1a</p> <pre><code># \u5728ydzs-node1\u8282\u70b9\u4e0a\n$ ls /data/k8s/localpv\ntest.txt\n$ cat /data/k8s/localpv/test.txt \nHello from Kubernetes local pv storage\n</code></pre> <p>\u5982\u679c\u91cd\u65b0\u521b\u5efa\u8fd9\u4e2a Pod \u7684\u8bdd\uff0c\u5c31\u4f1a\u53d1\u73b0\uff0c\u6211\u4eec\u4e4b\u524d\u521b\u5efa\u7684\u6d4b\u8bd5\u6587\u4ef6\uff0c\u4f9d\u7136\u88ab\u4fdd\u5b58\u5728\u8fd9\u4e2a\u6301\u4e45\u5316 Volume \u5f53\u4e2d\uff1a</p> <pre><code>$ kubectl delete -f pv-local-pod.yaml  \n$ kubectl apply -f pv-local-pod.yaml \n$ kubectl exec -it pv-local-pod /bin/sh\n# ls /usr/share/nginx/html\ntest.txt\n# cat /usr/share/nginx/html/test.txt\nHello from Kubernetes local pv storage\n#\n</code></pre> <p>\u5230\u8fd9\u91cc\u5c31\u8bf4\u660e\u57fa\u4e8e\u672c\u5730\u5b58\u50a8\u7684 Volume \u662f\u5b8c\u5168\u53ef\u4ee5\u63d0\u4f9b\u5bb9\u5668\u6301\u4e45\u5316\u5b58\u50a8\u529f\u80fd\u7684\uff0c\u5bf9\u4e8e StatefulSet \u8fd9\u6837\u7684\u6709\u72b6\u6001\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u4e5f\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7\u58f0\u660e Local \u7c7b\u578b\u7684 PV \u548c PVC\uff0c\u6765\u7ba1\u7406\u5e94\u7528\u7684\u5b58\u50a8\u72b6\u6001\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6211\u4eec\u4e0a\u9762\u624b\u52a8\u521b\u5efa PV \u7684\u65b9\u5f0f\uff0c\u5373\u9759\u6001\u7684 PV \u7ba1\u7406\u65b9\u5f0f\uff0c\u5728\u5220\u9664 PV \u65f6\u9700\u8981\u6309\u5982\u4e0b\u6d41\u7a0b\u6267\u884c\u64cd\u4f5c\uff1a</p> <ul> <li>\u5220\u9664\u4f7f\u7528\u8fd9\u4e2a PV \u7684 Pod</li> <li>\u4ece\u5bbf\u4e3b\u673a\u79fb\u9664\u672c\u5730\u78c1\u76d8</li> <li>\u5220\u9664 PVC</li> <li>\u5220\u9664 PV</li> </ul> <p>\u5982\u679c\u4e0d\u6309\u7167\u8fd9\u4e2a\u6d41\u7a0b\u7684\u8bdd\uff0c\u8fd9\u4e2a PV \u7684\u5220\u9664\u5c31\u4f1a\u5931\u8d25\u3002</p>"},{"location":"kubernetes_tenant/psp/","title":"Pod \u5b89\u5168\u7b56\u7565","text":""},{"location":"kubernetes_tenant/psp/#pod","title":"Pod \u5b89\u5168\u7b56\u7565","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cKubernetes \u5141\u8bb8\u521b\u5efa\u4e00\u4e2a\u6709\u7279\u6743\u5bb9\u5668\u7684 Pod\uff0c\u8fd9\u4e9b\u5bb9\u5668\u5f88\u53ef\u80fd\u4f1a\u5371\u673a\u7cfb\u7edf\u5b89\u5168\uff0c\u800c Pod \u5b89\u5168\u7b56\u7565\uff08PSP\uff09\u5219\u901a\u8fc7\u786e\u4fdd\u8bf7\u6c42\u8005\u6709\u6743\u9650\u6309\u914d\u7f6e\u6765\u521b\u5efa Pod\uff0c\u4ece\u800c\u6765\u4fdd\u62a4\u96c6\u7fa4\u514d\u53d7\u7279\u6743 Pod \u7684\u5f71\u54cd\u3002</p> <p><code>PodSecurityPolicy</code> \u662f Kubernetes API \u5bf9\u8c61\uff0c\u4f60\u53ef\u4ee5\u5728\u4e0d\u5bf9 Kubernetes \u8fdb\u884c\u4efb\u4f55\u4fee\u6539\u7684\u60c5\u51b5\u4e0b\u521b\u5efa\u5b83\u4eec\uff0c\u4f46\u662f\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4e0d\u4f1a\u5f3a\u5236\u6267\u884c\u6211\u4eec\u521b\u5efa\u7684\u4e00\u4e9b\u7b56\u7565\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u51c6\u5165\u63a7\u5236\u5668\u3001kube-controller-manager \u914d\u7f6e\u4ee5\u53ca RBAC \u6743\u9650\u914d\u7f6e\uff0c\u4e0b\u9762\u6211\u4eec\u5c31\u6765\u5bf9\u8fd9\u4e9b\u914d\u7f6e\u8fdb\u884c\u4e00\u4e00\u8bf4\u660e\u3002</p>"},{"location":"kubernetes_tenant/psp/#admission_controller","title":"Admission Controller","text":"<p>Admission Controller\uff08\u51c6\u5165\u63a7\u5236\u5668\uff09\u62e6\u622a\u5bf9 kube-apiserver \u7684\u8bf7\u6c42\uff0c\u62e6\u622a\u53d1\u751f\u5728\u8bf7\u6c42\u7684\u5bf9\u8c61\u88ab\u6301\u4e45\u5316\u4e4b\u524d\uff0c\u4f46\u662f\u5728\u8bf7\u6c42\u88ab\u9a8c\u8bc1\u548c\u6388\u6743\u4e4b\u540e\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u8bf7\u6c42\u5bf9\u8c61\u7684\u6765\u6e90\uff0c\u5e76\u9a8c\u8bc1\u9700\u8981\u7684\u5185\u5bb9\u662f\u5426\u6b63\u786e\u3002\u901a\u8fc7\u5c06\u5b83\u4eec\u6dfb\u52a0\u5230 kube-apiserver \u7684 </p> <pre><code>--enable-admission-plugins\n</code></pre> <p>\u53c2\u6570\u4e2d\u6765\u542f\u7528\u51c6\u5165\u63a7\u5236\u5668\u3002\u57281.10\u7248\u672c\u4e4b\u524d\uff0c\u4f7f\u7528\u73b0\u5728\u5df2\u7ecf\u5f03\u7528\u7684 <code>--admision-control</code> \u53c2\u6570\uff0c\u53e6\u5916\u9700\u8981\u6ce8\u610f\u51c6\u5165\u63a7\u5236\u5668\u7684\u987a\u5e8f\u5f88\u91cd\u8981\u3002</p> <p>\u5c06 <code>PodSecurityPolicy</code> \u6dfb\u52a0\u5230 kube-apiserver \u4e0a\u7684 </p> <pre><code>--enabled-admission-plugins\n</code></pre> <p>\u53c2\u6570\u4e2d\uff0c\u7136\u540e\u91cd\u542f kube-apiserver\uff1a</p> <pre><code>--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,PodSecurityPolicy\n</code></pre> <p>\u5176\u4ed6\u63d2\u4ef6\u6765\u81ea Kubernetes \u6587\u6863\u4e2d\u63a8\u8350\u7684\u4e00\u4e9b\u63d2\u4ef6\u5217\u8868\u3002</p> <p><code>PodSecurityPolicy</code> \u5df2\u7ecf\u6dfb\u52a0\u5230\u4e0a\u9762\u7684\u5217\u8868\u4e2d\u4e86\uff0c\u73b0\u5728 PSP \u7684\u63a7\u5236\u5668\u5df2\u7ecf\u542f\u7528\u4e86\uff0c\u4f46\u662f\u6211\u4eec\u96c6\u7fa4\u4e2d\u73b0\u5728\u7f3a\u5c11\u4e00\u4e9b\u5b89\u5168\u7b56\u7565\uff0c\u90a3\u4e48\u65b0\u7684 Pod \u521b\u5efa\u5c31\u4f1a\u5931\u8d25\u3002</p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u521b\u5efa\u4e00\u4e2a Nginx \u7684 Deployment\uff0cYAML \u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a\uff08nginx.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-deploy\n  namespace: default\n  labels:\n    app: nginx\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Deployment\uff1a</p> <pre><code>$ kubectl apply -f nginx.yaml\ndeployment.apps/nginx-deploy created\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Deployment \u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u73b0\u5728\u68c0\u67e5\u4e0b default \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684 pod\u3001replicaset\u3001deployment\uff1a</p> <pre><code>$ kubectl get po,rs,deploy -l app=nginx\n\nNAME                                       READY   STATUS      RESTARTS   AGE\n\nNAME                                            DESIRED   CURRENT   READY   AGE\nreplicaset.extensions/nginx-deploy-77f7d4c6b4   1         0         0       40s\n\nNAME                                 READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.extensions/nginx-deploy   0/1     0            0           40s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 replicaset \u548c deployment \u90fd\u521b\u5efa\u6210\u529f\u4e86\uff0c\u4f46\u662f replicaset \u63a7\u5236\u5668\u5374\u5e76\u6ca1\u6709\u521b\u5efa Pod\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u4f7f\u7528 PodSecurityPolicy \u5bf9\u8c61\u548c ServiceAccount \u4e86\u3002</p>"},{"location":"kubernetes_tenant/psp/#_1","title":"\u7b56\u7565","text":"<p>PodSecurityPolicy \u5bf9\u8c61\u63d0\u4f9b\u4e86\u4e00\u79cd\u58f0\u660e\u5f0f\u7684\u65b9\u5f0f\uff0c\u7528\u4e8e\u8868\u8fbe\u6211\u4eec\u8fd0\u884c\u7528\u6237\u548c ServiceAccount \u5728\u6211\u4eec\u7684\u96c6\u7fa4\u4e2d\u521b\u5efa\u7684\u5185\u5bb9\u3002\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u7b56\u7565\u6587\u6863\u6765\u4e86\u89e3\u5982\u4f55\u8bbe\u7f6e\u3002\u5728\u6211\u4eec\u5f53\u524d\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u6765\u521b\u5efa\u4e24\u4e2a\u7b56\u7565\uff0c\u7b2c\u4e00\u4e2a\u662f\u63d0\u4f9b\u9650\u5236\u8bbf\u95ee\u7684\u9ed8\u8ba4\u7b56\u7565\uff0c\u4fdd\u8bc1\u4f7f\u7528\u7279\u6743\u8bbe\u7f6e\uff08\u4f8b\u5982\u4f7f\u7528 hostNetwork\uff09\u65e0\u6cd5\u521b\u5efa Pod\u3002\u7b2c\u4e8c\u79cd\u662f\u4e00\u4e2a\u63d0\u5347\u7684\u8bb8\u53ef\u7b56\u7565\uff0c\u5141\u8bb8\u5c06\u7279\u6743\u8bbe\u7f6e\u7528\u4e8e\u67d0\u4e9b Pod\uff0c\u4f8b\u5982\u5728 kube-system \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u521b\u5efa\u7684 Pod \u6709\u6743\u9650\u3002</p> <p>\u9996\u5148\uff0c\u521b\u5efa\u4e00\u4e2a\u9650\u5236\u6027\u7684\u7b56\u7565\uff0c\u4f5c\u4e3a\u9ed8\u8ba4\u7b56\u7565\uff1a(psp-restrictive.yaml)</p> <pre><code>apiVersion: policy/v1beta1\nkind: PodSecurityPolicy\nmetadata:\n  name: restrictive\nspec:\n  privileged: false\n  hostNetwork: false\n  allowPrivilegeEscalation: false\n  defaultAllowPrivilegeEscalation: false\n  hostPID: false\n  hostIPC: false\n  runAsUser:\n    rule: RunAsAny\n  fsGroup:\n    rule: RunAsAny\n  seLinux:\n    rule: RunAsAny\n  supplementalGroups:\n    rule: RunAsAny\n  volumes:\n  - 'configMap'\n  - 'downwardAPI'\n  - 'emptyDir'\n  - 'persistentVolumeClaim'\n  - 'secret'\n  - 'projected'\n  allowedCapabilities:\n  - '*'\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 psp \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f psp-restrictive.yaml\npodsecuritypolicy.policy/restrictive configured\n</code></pre> <p>\u867d\u7136\u9650\u5236\u6027\u7684\u8bbf\u95ee\u5bf9\u4e8e\u5927\u591a\u6570 Pod \u521b\u5efa\u662f\u8db3\u591f\u7684\u4e86\uff0c\u4f46\u662f\u5bf9\u4e8e\u9700\u8981\u63d0\u5347\u8bbf\u95ee\u6743\u9650\u7684 Pod \u6765\u8bf4\uff0c\u5c31\u9700\u8981\u4e00\u4e9b\u5141\u8bb8\u7b56\u7565\u4e86\uff0c\u4f8b\u5982\uff0ckube-proxy \u5c31\u9700\u8981\u542f\u7528 hostNetwork:</p> <pre><code>$ kubectl get pods -n kube-system -l k8s-app=kube-proxy\nNAME               READY   STATUS    RESTARTS   AGE\nkube-proxy-4z4vf   1/1     Running   0          18d\n$ kubectl get pods -n kube-system kube-proxy-4z4vf -o yaml |grep hostNetwork\n  hostNetwork: true\n</code></pre> <p>\u8fd9\u5c31\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u7528\u4e8e\u63d0\u5347\u521b\u5efa\u6743\u9650\u7684\u8bb8\u53ef\u7b56\u7565\u4e86\uff1a(psp-permissive.yaml)</p> <pre><code>apiVersion: policy/v1beta1\nkind: PodSecurityPolicy\nmetadata:\n  name: permissive\nspec:\n  privileged: true\n  hostNetwork: true\n  hostIPC: true\n  hostPID: true\n  seLinux:\n    rule: RunAsAny\n  supplementalGroups:\n    rule: RunAsAny\n  runAsUser:\n    rule: RunAsAny\n  fsGroup:\n    rule: RunAsAny\n  hostPorts:\n  - min: 0\n    max: 65535\n  volumes:\n  - '*'\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 psp \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f psp-permissive.yaml\npodsecuritypolicy.policy/permissive configured\n$ kubectl get psp\nNAME               PRIV    CAPS   SELINUX    RUNASUSER   FSGROUP     SUPGROUP    READONLYROOTFS   VOLUMES\npermissive         true           RunAsAny   RunAsAny    RunAsAny    RunAsAny    false            *\nrestrictive        false   *      RunAsAny   RunAsAny    RunAsAny    RunAsAny    false            configMap,downwardAPI,emptyDir,persistentVolumeClaim,secret,projected\n</code></pre> <p>\u73b0\u5728\u914d\u7f6e\u90fd\u5df2\u7ecf\u5c31\u7eea\u4e86\uff0c\u4f46\u662f\u6211\u4eec\u9700\u8981\u5f15\u5165\u5230 Kubernetes \u6388\u6743\uff0c\u8fd9\u6837\u624d\u53ef\u4ee5\u786e\u5b9a\u8bf7\u6c42 Pod \u521b\u5efa\u7684\u7528\u6237\u6216\u8005 ServiceAccount \u662f\u5426\u89e3\u51b3\u4e86\u9650\u5236\u6027\u6216\u8bb8\u53ef\u6027\u7b56\u7565\uff0c\u8fd9\u5c31\u9700\u8981\u7528\u5230 RBAC \u4e86\u3002</p>"},{"location":"kubernetes_tenant/psp/#rbac","title":"RBAC","text":"<p>\u5728\u6211\u4eec\u542f\u7528 Pod \u5b89\u5168\u7b56\u7565\u7684\u65f6\u5019\uff0c\u53ef\u80fd\u4f1a\u5bf9 RBAC \u5f15\u8d77\u6df7\u6dc6\uff0c\u5b83\u786e\u5b9a\u4e86\u4e00\u4e2a\u8d26\u6237\u53ef\u4ee5\u4f7f\u7528\u7684\u7b56\u7565\uff0c\u4f7f\u7528\u96c6\u7fa4\u8303\u56f4\u7684 ClusterRoleBinding \u53ef\u4ee5\u4e3a ServiceAccount\uff08\u4f8b\u5982 replicaset-controller\uff09\u63d0\u4f9b\u5bf9\u9650\u5236\u6027\u7b56\u7565\u7684\u8bbf\u95ee\u6743\u9650\u3002\u4f7f\u7528\u547d\u540d\u7a7a\u95f4\u8303\u56f4\u7684 RoleBinding\uff0c\u53ef\u4ee5\u542f\u7528\u5bf9\u8bb8\u53ef\u7b56\u7565\u7684\u8bbf\u95ee\uff0c\u8fd9\u6837\u53ef\u4ee5\u5728\u7279\u5b9a\u7684\u547d\u540d\u7a7a\u95f4\uff08\u5982 kube-system\uff09\u4e2d\u8fdb\u884c\u64cd\u4f5c\u3002</p> <p>\u6211\u4eec\u9996\u5148\u521b\u5efa\u5141\u8bb8\u4f7f\u7528 restrictive \u7b56\u7565\u7684 ClusterRole\u3002\u7136\u540e\u521b\u5efa\u4e00\u4e2a ClusterRoleBinding\uff0c\u5c06 restrictive \u7b56\u7565\u548c\u7cfb\u7edf\u4e2d\u6240\u6709\u7684\u63a7\u5236\u5668 ServiceAccount \u8fdb\u884c\u7ed1\u5b9a:(psp-restrictive-rbac.yaml)</p> <pre><code>kind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: psp-restrictive\nrules:\n- apiGroups:\n  - extensions\n  resources:\n  - podsecuritypolicies\n  resourceNames:\n  - restrictive\n  verbs:\n  - use\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: psp-default\nsubjects:\n- kind: Group\n  name: system:serviceaccounts\n  namespace: kube-system\nroleRef:\n  kind: ClusterRole\n  name: psp-restrictive\n  apiGroup: rbac.authorization.k8s.io\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 RBAC \u76f8\u5173\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f psp-restrictive-rbac.yaml\nclusterrole.rbac.authorization.k8s.io/psp-restrictive created\nclusterrolebinding.rbac.authorization.k8s.io/psp-default created\n</code></pre> <p>\u7136\u540e\u73b0\u5728\u6211\u4eec\u518d\u91cd\u65b0\u521b\u5efa\u4e0a\u9762\u6211\u4eec\u7684\u5b9a\u4e49\u7684 Deployment\uff1a</p> <pre><code>$ kubectl delete -f nginx.yaml\ndeployment.apps \"nginx-deploy\" deleted\n$ kubectl apply -f nginx.yaml\ndeployment.apps/nginx-deploy created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u540c\u6837\u67e5\u770b\u4e0b default \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u6211\u4eec\u521b\u5efa\u7684\u4e00\u4e9b\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get po,rs,deploy -l app=nginx\nNAME                                       READY   STATUS      RESTARTS   AGE\npod/nginx-deploy-77f7d4c6b4-njfdl          1/1     Running     0          13s\n\nNAME                                            DESIRED   CURRENT   READY   AGE\nreplicaset.extensions/nginx-deploy-77f7d4c6b4   1         1         1       13s\n\nNAME                                 READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.extensions/nginx-deploy   1/1     1            1           13s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pods \u88ab\u6210\u529f\u521b\u5efa\u4e86\uff0c\u4f46\u662f\uff0c\u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u505a\u4e00\u4e9b\u7b56\u7565\u4e0d\u5141\u8bb8\u7684\u4e8b\u60c5\uff0c\u6b63\u5e38\u6765\u8bf4\u5c31\u5e94\u8be5\u88ab\u62d2\u7edd\u4e86\u3002\u9996\u5148\u5220\u9664\u4e0a\u9762\u7684\u8fd9\u4e2a Deployment\uff1a</p> <pre><code>$ kubectl delete -f nginx.yaml\ndeployment.apps \"nginx-deploy\" deleted\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5728 nginx-deploy \u57fa\u7840\u4e0a\u6dfb\u52a0 <code>hostNetwork: true</code> \u6765\u4f7f\u7528 hostNetwork \u8fd9\u4e2a\u7279\u6743\uff1a\uff08nginx-hostnetwork.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-hostnetwork-deploy\n  namespace: default\n  labels:\n    app: nginx\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n      hostNetwork: true  # \u6ce8\u610f\u6dfb\u52a0hostNetwork\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Deployment \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f nginx-hostnetwork.yaml\ndeployment.apps/nginx-hostnetwork-deploy created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u540c\u6837\u67e5\u770b default \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u4e00\u4e9b\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get po,rs,deploy -l app=nginx\n\nNAME                                       READY   STATUS      RESTARTS   AGE\n\nNAME                                                        DESIRED   CURRENT   READY   AGE\nreplicaset.extensions/nginx-hostnetwork-deploy-74c8fbd687   1         0         0       44s\n\nNAME                                             READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.extensions/nginx-hostnetwork-deploy   0/1     0            0           44s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53d1\u73b0 ReplicaSet \u53c8\u6ca1\u6709\u521b\u5efa Pod \u4e86\uff0c\u53ef\u4ee5\u4f7f\u7528<code>kubectl describe</code>\u547d\u4ee4\u53bb\u67e5\u770b\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u7684 ReplicaSet \u8d44\u6e90\u5bf9\u8c61\u6765\u4e86\u89e3\u66f4\u591a\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe rs nginx-hostnetwork-deploy-74c8fbd687\nName:           nginx-hostnetwork-deploy-74c8fbd687\n......\nEvents:\n  Type     Reason        Age                   From                   Message\n  ----     ------        ----                  ----                   -------\n  Warning  FailedCreate  80s (x15 over 2m42s)  replicaset-controller  Error creating: pods \"nginx-hostnetwork-deploy-74c8fbd687-\" is forbidden: unable to validate against any pod security policy: [spec.securityContext.hostNetwork: Invalid value: true: Host network is not allowed to be used]\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5f88\u660e\u663e Hostnetwork \u4e0d\u88ab\u5141\u8bb8\u4f7f\u7528\uff0c\u4f46\u662f\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u7684\u786e\u6709\u5728\u67d0\u4e2a\u547d\u540d\u7a7a\u95f4\uff08\u6bd4\u5982 kube-system\uff09\u4e0b\u9762\u521b\u5efa\u4f7f\u7528 hostNetwork \u7684 Pod\uff0c\u8fd9\u91cc\u5c31\u9700\u8981\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u5141\u8bb8\u6267\u884c\u7684 ClusterRole\uff0c\u7136\u540e\u4e3a\u7279\u5b9a\u7684\u547d\u540d\u7a7a\u95f4\u521b\u5efa\u4e00\u4e2a RoleBinding\uff0c\u5c06\u8fd9\u91cc\u7684 ClusterRole \u548c\u76f8\u5173\u7684\u63a7\u5236\u5668 ServiceAccount \u8fdb\u884c\u7ed1\u5b9a:(psp-permissive-rbac.yaml)</p> <pre><code>kind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: psp-permissive\nrules:\n- apiGroups:\n  - extensions\n  resources:\n  - podsecuritypolicies\n  resourceNames:\n  - permissive\n  verbs:\n  - use\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: RoleBinding\nmetadata:\n  name: psp-permissive\n  namespace: kube-system\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: psp-permissive\nsubjects:\n- kind: ServiceAccount\n  name: daemon-set-controller\n  namespace: kube-system\n- kind: ServiceAccount\n  name: replicaset-controller\n  namespace: kube-system\n- kind: ServiceAccount\n  name: job-controller\n  namespace: kube-system\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 RBAC \u76f8\u5173\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f psp-permissive-rbac.yaml\nclusterrole.rbac.authorization.k8s.io/psp-permissive created\nrolebinding.rbac.authorization.k8s.io/psp-permissive created\n</code></pre> <p>\u73b0\u5728\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 kube-system \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u4f7f\u7528 hostNetwork \u6765\u521b\u5efa Pod \u4e86\uff0c\u5c06\u4e0a\u9762\u7684 nginx \u8d44\u6e90\u6e05\u5355\u66f4\u6539\u6210 kube-system \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-hostnetwork-deploy\n  namespace: kube-system\n  labels:\n    app: nginx\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:4\n      hostNetwork: true\n</code></pre> <p>\u91cd\u65b0\u521b\u5efa\u8fd9\u4e2a Deployment\uff1a</p> <pre><code>$ kubectl apply -f nginx-hostnetwork.yaml\ndeployment.apps/nginx-hostnetwork-deploy created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u540c\u6837\u67e5\u770b\u4e0b\u5bf9\u5e94\u7684\u8d44\u6e90\u5bf9\u8c61\u521b\u5efa\u60c5\u51b5\uff1a</p> <pre><code>$ kubectl get po,rs,deploy -n kube-system -l app=nginx\nNAME                                            READY   STATUS    RESTARTS   AGE\npod/nginx-hostnetwork-deploy-74c8fbd687-7x8px   1/1     Running   0          2m1s\n\nNAME                                                        DESIRED   CURRENT   READY   AGE\nreplicaset.extensions/nginx-hostnetwork-deploy-74c8fbd687   1         1         1       2m1s\n\nNAME                                             READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.extensions/nginx-hostnetwork-deploy   1/1     1            1           2m1s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pod \u5728 kube-system \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u521b\u5efa\u6210\u529f\u4e86\u3002</p> <p>\u5982\u679c\u6211\u4eec\u73b0\u5728\u6709\u8fd9\u6837\u7684\u4e00\u4e2a\u9700\u6c42\uff0c\u5728\u67d0\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u8981\u5f3a\u5236\u6267\u884c\u6211\u4eec\u521b\u5efa\u7684 restrictive\uff08\u9650\u5236\u6027\uff09\u7b56\u7565\uff0c\u4f46\u662f\u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u67d0\u4e2a\u5e94\u7528\u9700\u8981\u4f7f\u7528 permissive\uff08\u8bb8\u53ef\uff09\u7b56\u7565\uff0c\u90a3\u4e48\u5e94\u8be5\u600e\u4e48\u529e\u5462\uff1f\u5728\u5f53\u524d\u6a21\u578b\u4e2d\uff0c\u6211\u4eec\u53ea\u6709\u96c6\u7fa4\u7ea7\u522b\u548c\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u7684\u914d\u7f6e\u3002\u4e3a\u4e86\u7ed9\u67d0\u4e2a\u5e94\u7528\u63d0\u4f9b\u5355\u72ec\u7684\u8bb8\u53ef\u7b56\u7565\uff0c\u6211\u4eec\u53ef\u4ee5\u4e3a\u5e94\u7528\u7684 ServiceAccount \u63d0\u4f9b\u4f7f\u7528 permissive \u8fd9\u4e2a ClusterRole \u7684\u80fd\u529b\u3002</p> <p>\u6bd4\u5982\uff0c\u8fd8\u662f\u5728\u9ed8\u8ba4\u7684\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a specialsa \u7684 ServiceAccount:</p> <pre><code>$ kubectl create serviceaccount specialsa\nserviceaccount/specialsa created\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a RoleBinding \u5c06 specialsa \u7ed1\u5b9a\u5230\u4e0a\u9762\u7684 psp-permissive \u8fd9\u4e2a CluterRole \u4e0a:(specialsa-psp.yaml)</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1beta1\nkind: RoleBinding\nmetadata:\n  name: specialsa-psp-permissive\n  namespace: default\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: psp-permissive\nsubjects:\n- kind: ServiceAccount\n  name: specialsa\n  namespace: default\n</code></pre> <p>\u521b\u5efa\u4e0a\u9762\u7684 RoleBinding \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f specialsa-psp.yaml\nrolebinding.rbac.authorization.k8s.io/specialsa-psp-permissive created\n</code></pre> <p>\u7136\u540e\u4e3a\u6211\u4eec\u4e0a\u9762\u7684 Deployment \u6dfb\u52a0\u4e0a serviceAccount \u5c5e\u6027:(nginx-hostnetwork-sa.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-hostnetwork-deploy\n  namespace: default\n  labels:\n    app: nginx\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n      hostNetwork: true\n      serviceAccount: specialsa  # \u6ce8\u610f\u8fd9\u91cc\u4f7f\u7528\u7684sa\u7684\u6743\u9650\u7ed1\u5b9a\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u5373\u53ef:</p> <pre><code>$ kubectl apply -f nginx-hostnetwork-sa.yaml\ndeployment.apps/nginx-hostnetwork-deploy configured\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u67e5\u770b default \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u5e26\u6709 hostNetwork \u7684 Pod \u4e5f\u521b\u5efa\u6210\u529f\u4e86:</p> <pre><code>$ kubectl get po,rs,deploy -l app=nginx\nNAME                                            READY   STATUS    RESTARTS   AGE\npod/nginx-hostnetwork-deploy-6c85dfbf95-hqt8j   1/1     Running   0          65s\n\nNAME                                                        DESIRED   CURRENT   READY   AGE\nreplicaset.extensions/nginx-hostnetwork-deploy-6c85dfbf95   1         1         1       65s\nreplicaset.extensions/nginx-hostnetwork-deploy-74c8fbd687   0         0         0       31m\n\nNAME                                             READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.extensions/nginx-hostnetwork-deploy   1/1     1            1           31m\n</code></pre> <p>Pod \u5b89\u5168\u7b56\u7565\u662f\u4e00\u79cd\u901a\u8fc7\u4f7f\u7528 PSP \u6388\u6743\u7b56\u7565\u6765\u4fdd\u62a4 Kubernetes \u96c6\u7fa4\u4e2d\u7684 Pod \u7684\u521b\u5efa\u8fc7\u7a0b\u7684\u65b9\u6cd5\u3002</p>"},{"location":"kubernetes_tenant/quota/","title":"\u8d44\u6e90\u914d\u989d","text":""},{"location":"kubernetes_tenant/quota/#_1","title":"\u8d44\u6e90\u914d\u989d","text":"<p>\u8d44\u6e90\u914d\u989d\u7528\u4e8e\u7ba1\u7406\u547d\u540d\u7a7a\u95f4\u4e2d\u5bf9\u8c61\u4f7f\u7528\u7684\u8d44\u6e90\u91cf\uff0c\u6211\u4eec\u53ef\u4ee5\u6309 CPU \u548c\u5185\u5b58\u7528\u91cf\u6216\u5bf9\u8c61\u6570\u91cf\u6765\u8bbe\u7f6e\u914d\u989d\u3002\u901a\u8fc7\u8d44\u6e90\u914d\u989d\uff0c\u53ef\u4ee5\u786e\u4fdd\u79df\u6237\u4e0d\u4f1a\u4f7f\u7528\u8d85\u8fc7\u5176\u5206\u914d\u4efd\u989d\u7684\u96c6\u7fa4\u8d44\u6e90\u3002</p> <p>\u8d44\u6e90\u914d\u989d\u662f\u901a\u8fc7 <code>ResourceQuota</code> \u8d44\u6e90\u5bf9\u8c61\u6765\u5b9a\u4e49\u7684\uff0c\u53ef\u4ee5\u5bf9\u6bcf\u4e2a namespace \u7684\u8d44\u6e90\u6d88\u8017\u603b\u91cf\u63d0\u4f9b\u9650\u5236\u3002\u5b83\u53ef\u4ee5\u6309\u7c7b\u578b\u9650\u5236 namespace \u4e0b\u53ef\u4ee5\u521b\u5efa\u7684\u5bf9\u8c61\u7684\u6570\u91cf\uff0c\u4e5f\u53ef\u4ee5\u9650\u5236\u53ef\u88ab\u8be5\u9879\u76ee\u4ee5\u8d44\u6e90\u5f62\u5f0f\u6d88\u8017\u7684\u8ba1\u7b97\u8d44\u6e90\u7684\u603b\u91cf\u3002</p> <p>\u8d44\u6e90\u914d\u989d\u7684\u5de5\u4f5c\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <ul> <li>\u7ba1\u7406\u5458\u4e3a\u6bcf\u4e2a namespace \u521b\u5efa\u4e00\u4e2a\u6216\u591a\u4e2a\u8d44\u6e90\u914d\u989d\u5bf9\u8c61</li> <li>\u7528\u6237\u5728 namespace \u4e0b\u521b\u5efa\u8d44\u6e90 (pods\u3001 services \u7b49)\uff0c\u540c\u65f6\u914d\u989d\u7cfb\u7edf\u4f1a\u8ddf\u8e2a\u4f7f\u7528\u60c5\u51b5\uff0c\u6765\u786e\u4fdd\u5176\u4e0d\u8d85\u8fc7\u8d44\u6e90\u914d\u989d\u4e2d\u5b9a\u4e49\u7684\u786c\u6027\u8d44\u6e90\u9650\u989d</li> <li>\u5982\u679c\u8d44\u6e90\u7684\u521b\u5efa\u6216\u66f4\u65b0\u8fdd\u53cd\u4e86\u914d\u989d\u7ea6\u675f\uff0c\u5219\u8bf7\u6c42\u4f1a\u5931\u8d25\uff0c\u5e76\u8fd4\u56de HTTP \u72b6\u6001\u7801 <code>403 FORBIDDEN</code>\uff0c\u4ee5\u53ca\u8bf4\u660e\u8fdd\u53cd\u914d\u989d\u7ea6\u675f\u7684\u4fe1\u606f</li> <li>\u5982\u679c namespace \u4e0b\u7684\u8ba1\u7b97\u8d44\u6e90\uff08\u5982 cpu \u548c memory\uff09\u7684\u914d\u989d\u88ab\u542f\u7528\uff0c\u5219\u7528\u6237\u5fc5\u987b\u4e3a\u8fd9\u4e9b\u8d44\u6e90\u8bbe\u5b9a\u8bf7\u6c42\u503c\uff08request\uff09 \u548c\u7ea6\u675f\u503c\uff08limit\uff09\uff0c\u5426\u5219\u914d\u989d\u7cfb\u7edf\u5c06\u62d2\u7edd Pod \u7684\u521b\u5efa\u3002</li> </ul> <p>\u63d0\u793a</p> <p>\u53ef\u4f7f\u7528 <code>LimitRange</code> \u51c6\u5165\u63a7\u5236\u5668\u6765\u4e3a\u6ca1\u6709\u8bbe\u7f6e\u8ba1\u7b97\u8d44\u6e90\u9700\u6c42\u7684Pod\u8bbe\u7f6e\u9ed8\u8ba4\u503c\u3002</p> <p>Kubernetes \u4e2d\u4e3b\u8981\u67093\u4e2a\u5c42\u7ea7\u7684\u8d44\u6e90\u914d\u989d\u63a7\u5236\uff1a</p> <ul> <li>\u5bb9\u5668\uff1a\u53ef\u4ee5\u5bf9 CPU \u548c Memory \u8fdb\u884c\u9650\u5236</li> <li>POD\uff1a\u53ef\u4ee5\u5bf9\u4e00\u4e2a Pod \u5185\u6240\u6709\u5bb9\u5668\u7684\u7684\u8d44\u6e90\u8fdb\u884c\u9650\u5236</li> <li>Namespace\uff1a\u4e3a\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u7684\u8d44\u6e90\u8fdb\u884c\u9650\u5236</li> </ul> <p>\u5176\u4e2d\u5bb9\u5668\u5c42\u6b21\u4e3b\u8981\u5229\u7528\u5bb9\u5668\u672c\u8eab\u7684\u652f\u6301\uff0c\u6bd4\u5982 Docker \u5bf9 CPU\u3001\u5185\u5b58\u7b49\u7684\u652f\u6301\uff1bPod \u65b9\u9762\u53ef\u4ee5\u9650\u5236\u7cfb\u7edf\u5185\u521b\u5efa Pod \u7684\u8d44\u6e90\u8303\u56f4\uff0c\u6bd4\u5982\u6700\u5927\u6216\u8005\u6700\u5c0f\u7684 CPU\u3001memory \u9700\u6c42\uff1bNamespace \u5c42\u6b21\u5c31\u662f\u5bf9\u7528\u6237\u7ea7\u522b\u7684\u8d44\u6e90\u9650\u989d\u4e86\uff0c\u5305\u62ec CPU\u3001\u5185\u5b58\uff0c\u8fd8\u53ef\u4ee5\u9650\u5b9a Pod\u3001RC\u3001Service \u7684\u6570\u91cf\u3002</p> <p>\u8981\u4f7f\u7528\u8d44\u6e90\u914d\u989d\u7684\u8bdd\u9700\u8981\u786e\u4fdd <code>apiserver</code>\u7684 </p> <pre><code>--enable-admission-plugins=\n</code></pre> <p>\u53c2\u6570\u4e2d\u5305\u542b <code>ResourceQuota</code>\uff0c\u5f53 namespace \u4e2d\u5b58\u5728\u4e00\u4e2a <code>ResourceQuota</code> \u5bf9\u8c61\u65f6\uff0c\u8be5 namespace \u5373\u5f00\u59cb\u5b9e\u65bd\u8d44\u6e90\u914d\u989d\u7684\u7ba1\u7406\u5de5\u4f5c\u4e86\uff0c\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e00\u4e2a namespace \u4e2d\u6700\u591a\u53ea\u5e94\u5b58\u5728\u4e00\u4e2a <code>ResourceQuota</code> \u5bf9\u8c61\u3002</p> <p>\u8d44\u6e90\u914d\u989d\u63a7\u5236\u5668\u652f\u6301\u7684\u914d\u989d\u63a7\u5236\u8d44\u6e90\u4e3b\u8981\u5305\u62ec\uff1a\u8ba1\u7b97\u8d44\u6e90\u914d\u989d\u3001\u5b58\u50a8\u8d44\u6e90\u914d\u989d\u3001\u5bf9\u8c61\u6570\u91cf\u8d44\u6e90\u914d\u989d\u4ee5\u53ca\u914d\u989d\u4f5c\u7528\u57df\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u5206\u522b\u770b\u770b\u8fd9\u4e9b\u8d44\u6e90\u7684\u5177\u4f53\u4fe1\u606f\uff1a</p>"},{"location":"kubernetes_tenant/quota/#_2","title":"\u8ba1\u7b97\u8d44\u6e90\u914d\u989d","text":"<p>\u7528\u6237\u53ef\u4ee5\u5bf9\u7ed9\u5b9a namespace \u4e0b\u7684\u8ba1\u7b97\u8d44\u6e90\u603b\u91cf\u8fdb\u884c\u9650\u5236\uff0c\u652f\u6301\u7684\u8d44\u6e90\u7c7b\u578b\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u6bd4\u5982\u6211\u4eec\u73b0\u5728\u6765\u4e3a\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u521b\u5efa\u5185\u5b58\u548c CPU \u914d\u989d\uff0c\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u6d4b\u8bd5\u7528\u7684\u547d\u540d\u7a7a\u95f4\uff1a</p> <pre><code>$ kubectl create namespace quota-mem-cpu-example\n</code></pre> <p>\u7136\u540e\u5b9a\u4e49\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u914d\u989d\u8d44\u6e90\u5bf9\u8c61\uff1a\uff08quota-mem-cpu.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: ResourceQuota\nmetadata:\n  name: mem-cpu-demo\n  namespace: quota-mem-cpu-example\nspec:\n  hard:\n    requests.cpu: \"1\"\n    requests.memory: 1Gi\n    limits.cpu: \"2\"\n    limits.memory: 2Gi\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f quota-mem-cpu.yaml\nresourcequota/mem-cpu-demo created\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u67e5\u770b\u4e0b\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684 <code>ResourceQuota</code> \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl describe quota mem-cpu-demo -n quota-mem-cpu-example\nName:            mem-cpu-demo\nNamespace:       quota-mem-cpu-example\nResource         Used  Hard\n--------         ----  ----\nlimits.cpu       0     2\nlimits.memory    0     2Gi\nrequests.cpu     0     1\nrequests.memory  0     1Gi\n</code></pre> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 Pod\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: quota-mem-cpu-demo\n  namespace: quota-mem-cpu-example\nspec:\n  containers:\n  - name: quota-mem-cpu-demo-ctr\n    image: nginx\n    resources:\n      limits:\n        memory: \"800Mi\"\n        cpu: \"800m\" \n      requests:\n        memory: \"600Mi\"\n        cpu: \"400m\"\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl apply -f quota-mem-cpu-pod.yaml\n$ kubectl get pods -n quota-mem-cpu-example\nNAME                 READY   STATUS    RESTARTS   AGE\nquota-mem-cpu-demo   1/1     Running   0          32s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a Pod \u5df2\u7ecf\u6b63\u5e38\u8fd0\u884c\u8d77\u6765\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u770b\u4e00\u6b21\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u7684\u8d44\u6e90\u914d\u989d\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl describe quota mem-cpu-demo -n quota-mem-cpu-example\nName:            mem-cpu-demo\nNamespace:       quota-mem-cpu-example\nResource         Used   Hard\n--------         ----   ----\nlimits.cpu       800m   2\nlimits.memory    800Mi  2Gi\nrequests.cpu     400m   1\nrequests.memory  600Mi  1Gi\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u660e\u786e\u544a\u8bc9\u6211\u4eec\u5df2\u7ecf\u4f7f\u7528\u4e86\u591a\u5c11\u8ba1\u7b97\u8d44\u6e90\u4e86\uff0c\u6bd4\u5982\u5185\u5b58\u7684\u8bf7\u6c42\u503c\u53ea\u5269 400Mi\uff081Gi-600Mi\uff09\u8d44\u6e90\u4e86\uff0c\u6211\u4eec\u73b0\u5728\u6765\u521b\u5efa\u4e00\u4e2a\u5927\u4e8e 400Mi \u8bf7\u6c42\u5185\u5b58\u7684\u8d44\u6e90\u6d4b\u8bd5\u4e0b\uff1a(quota-mem-cpu-pod-2.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: quota-mem-cpu-demo-2\n  namespace: quota-mem-cpu-example\nspec:\n  containers:\n  - name: quota-mem-cpu-demo-2-ctr\n    image: redis\n    resources:\n      limits:\n        memory: \"1Gi\"\n        cpu: \"800m\"      \n      requests:\n        memory: \"700Mi\"\n        cpu: \"400m\"\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u6765\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f quota-mem-cpu-pod-yaml \nError from server (Forbidden): error when creating \"quota-mem-cpu-pod-yaml\": pods \"quota-mem-cpu-demo-2\" is forbidden: exceeded quota: mem-cpu-demo, requested: requests.memory=700Mi, used: requests.memory=600Mi, limited: requests.memory=1Gi\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u88ab\u62d2\u7edd\u4e86\uff0c\u56e0\u4e3a <code>requests.memory</code> \u5df2\u7ecf\u8d85\u8fc7\u4e86\u6211\u4eec\u7684\u8d44\u6e90\u914d\u989d\u7684\u9650\u5236\u4e86\u3002</p> <p>\u4ece\u4e0a\u9762\u7684\u7ec3\u4e60\u6765\u770b\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>ResourceQuota</code> \u6765\u9650\u5236\u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c\u7684\u6240\u6709\u5bb9\u5668\u7684 CPU \u548c \u5185\u5b58\u7684\u8d44\u6e90\u914d\u989d\u603b\u6570\uff0c\u5982\u679c\u9650\u5236\u5355\u4e2a\u5bb9\u5668\u800c\u4e0d\u662f\u6240\u6709\u5bb9\u5668\u7684\u603b\u6570\uff0c\u5c31\u9700\u8981\u4f7f\u7528 <code>LimitRange</code> \u8d44\u6e90\u5bf9\u8c61\u4e86\u3002\u53e6\u5916\u5982\u679c\u5728\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u8ba1\u7b97\u8d44\u6e90\uff08\u5982 CPU \u548c\u5185\u5b58\uff09\u7684\u914d\u989d\u88ab\u542f\u7528\u4e86\uff0c\u5219\u7528\u6237\u5fc5\u987b\u4e3a\u8fd9\u4e9b\u8d44\u6e90\u8bbe\u7f6e\u8bf7\u6c42\u503c\uff08request\uff09\u548c\u7ea6\u675f\u503c\uff08limit\uff09\uff0c\u5426\u5219\u914d\u989d\u7cfb\u7edf\u5c06\u62d2\u7edd Pod \u7684\u521b\u5efa\uff0c\u9664\u975e\u6211\u4eec\u914d\u7f6e\u4e86 <code>LimitRange</code> \u8d44\u6e90\u5bf9\u8c61\u3002</p> <p>\u8981\u4f7f\u7528 <code>LimitRange</code> \u540c\u6837\u9700\u8981\u5728 </p> <pre><code>--enable-admission-plugins=\n</code></pre> <p>\u53c2\u6570\u4e2d\u5f00\u542f <code>LimitRanger</code>\u3002\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6765\u914d\u7f6e\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u5bb9\u5668\u7684\u6700\u5c0f\u548c\u6700\u5927\u7684\u5185\u5b58\u9650\u5236\uff0c\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u6765\u8fdb\u884c\u914d\u7f6e\uff1a</p> <pre><code>$ kubectl create namespace constraints-mem-example\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a LimitRange \u7684\u914d\u7f6e\u8d44\u6e90\u6587\u4ef6\uff1a(memory-constraints.yaml)</p> <pre><code>apiVersion: v1\nkind: LimitRange\nmetadata:\n  name: mem-min-max-demo-lr\n  namespace: constraints-mem-example\nspec:\n  limits:\n  - max:\n      memory: 1Gi\n    min:\n      memory: 500Mi\n    type: Container\n</code></pre> <p>\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f memory-constraints.yaml\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u67e5\u770b LimitRange \u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get limitrange mem-min-max-demo-lr --namespace=constraints-mem-example --output=yaml\n......\n  limits:\n  - default:\n      memory: 1Gi\n    defaultRequest:\n      memory: 1Gi\n    max:\n      memory: 1Gi\n    min:\n      memory: 500Mi\n    type: Container\n</code></pre> <p>\u4e0a\u9762\u8f93\u51fa\u663e\u793a\u4e86\u6700\u5c0f\u548c\u6700\u5927\u7684\u5185\u5b58\u7ea6\u675f\uff0c\u4f46\u662f\u8981\u6ce8\u610f\u5373\u4f7f\u6211\u4eec\u6ca1\u6709\u6307\u5b9a\u9ed8\u8ba4\u503c\uff0c\u4ed6\u4eec\u4e5f\u4f1a\u81ea\u52a8\u521b\u5efa\u7684\u3002\u73b0\u5728\uff0c\u53ea\u8981\u5728 </p> <pre><code>constraints-mem-example\n</code></pre> <p>\u547d\u540d\u7a7a\u95f4\u4e2d\u521b\u5efa\u5bb9\u5668\uff0cKubernetes \u5c31\u4f1a\u6267\u884c\u4e0b\u9762\u7684\u6b65\u9aa4\uff1a</p> <ul> <li>\u5982\u679c Container \u672a\u6307\u5b9a\u81ea\u5df1\u7684\u5185\u5b58\u8bf7\u6c42\u548c\u9650\u5236\uff0c\u5c06\u4e3a\u5b83\u6307\u5b9a\u9ed8\u8ba4\u7684\u5185\u5b58\u8bf7\u6c42\u548c\u9650\u5236</li> <li>\u9a8c\u8bc1 Container \u7684\u5185\u5b58\u8bf7\u6c42\u662f\u5426\u5927\u4e8e\u6216\u7b49\u4e8e 500 MiB</li> <li>\u9a8c\u8bc1 Container \u7684\u5185\u5b58\u9650\u5236\u662f\u5426\u5c0f\u4e8e\u6216\u7b49\u4e8e1 GiB</li> </ul> <p>\u4e0b\u9762\u6211\u4eec\u8fd9\u91cc\u6765\u521b\u5efa\u4e00\u4e2a Pod\uff0c\u5176\u4e2d\u5bb9\u5668\u58f0\u660e\u4e86 600 MiB \u7684\u5185\u5b58\u8bf7\u6c42\u548c 800 MiB \u7684\u5185\u5b58\u9650\u5236\uff0c\u8fd9\u4e9b\u6ee1\u8db3\u4e86 LimitRange \u7684\u6700\u5c0f\u548c\u6700\u5927\u5185\u5b58\u7ea6\u675f\uff1a(memory-constraints-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: constraints-mem-demo\n  namespace: constraints-mem-example\nspec:\n  containers:\n  - name: constraints-mem-demo-ctr\n    image: nginx\n    resources:\n      limits:\n        memory: \"800Mi\"\n      requests:\n        memory: \"600Mi\"\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ kubectl create -f memory-constraints-pod.yaml \n$ kubectl get pods -n constraints-mem-example\nNAME                   READY   STATUS    RESTARTS   AGE\nconstraints-mem-demo   1/1     Running   0          2m5s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u662f\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\u7684\u3002</p> <p>\u7136\u540e\u6211\u4eec\u518d\u521b\u5efa\u4e00\u4e2a\u8d85\u8fc7\u6700\u5927\u5185\u5b58\u9650\u5236\u7684 Pod \u6d4b\u8bd5\u4e0b\uff1a(memory-constraints-pod2.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: constraints-mem-demo-2\n  namespace: constraints-mem-example\nspec:\n  containers:\n  - name: constraints-mem-demo-2-ctr\n    image: nginx\n    resources:\n      limits:\n        memory: \"5Gi\"\n      requests:\n        memory: \"800Mi\"\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e0b\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f memory-constraints-podyaml \nError from server (Forbidden): error when creating \"memory-constraints-podyaml\": pods \"constraints-mem-demo-2\" is forbidden: maximum memory usage per Container is 1Gi, but limit is 1536Mi\n</code></pre> <p>\u8f93\u51fa\u7ed3\u679c\u663e\u793a Pod \u6ca1\u6709\u521b\u5efa\u6210\u529f\uff0c\u56e0\u4e3a\u5bb9\u5668\u58f0\u660e\u7684\u5185\u5b58\u9650\u5236\u592a\u5927\u4e86\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u53bb\u5c1d\u8bd5\u4e0b\u521b\u5efa\u4e00\u4e2a\u5c0f\u4e8e\u6700\u5c0f\u5185\u5b58\u9650\u5236\u7684 Pod \u6216\u6ca1\u6709\u58f0\u660e\u5185\u5b58\u8bf7\u6c42\u548c\u9650\u5236\u7684 Pod\u3002</p>"},{"location":"kubernetes_tenant/quota/#_3","title":"\u5b58\u50a8\u8d44\u6e90\u914d\u989d","text":"<p>\u7528\u6237\u53ef\u4ee5\u5bf9\u7ed9\u5b9a namespace \u4e0b\u7684\u5b58\u50a8\u8d44\u6e90\u603b\u91cf\u8fdb\u884c\u9650\u5236\uff0c\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u6839\u636e\u76f8\u5173\u7684\u5b58\u50a8\u7c7b\uff08Storage Class\uff09\u6765\u9650\u5236\u5b58\u50a8\u8d44\u6e90\u7684\u6d88\u8017\u3002</p> <p></p>"},{"location":"kubernetes_tenant/quota/#_4","title":"\u5bf9\u8c61\u6570\u91cf\u914d\u989d","text":"<p>\u7ed9\u5b9a\u7c7b\u578b\u7684\u5bf9\u8c61\u6570\u91cf\u53ef\u4ee5\u88ab\u9650\u5236\u3002 \u652f\u6301\u4ee5\u4e0b\u7c7b\u578b\uff1a</p> <p></p>"},{"location":"kubernetes_tenant/quota/#qos","title":"Qos \u670d\u52a1\u8d28\u91cf","text":"<p>https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/</p>"},{"location":"kubernetes_tenant/tenant/","title":"\u591a\u79df\u6237\u4ecb\u7ecd","text":""},{"location":"kubernetes_tenant/tenant/#_1","title":"\u591a\u79df\u6237","text":"<p>\u591a\u79df\u6237\u96c6\u7fa4\u7531\u591a\u4e2a\u7528\u6237\u548c/\u6216\u5de5\u4f5c\u8d1f\u8f7d\u5171\u4eab\uff0c\u8fd9\u4e9b\u7528\u6237\u548c/\u6216\u5de5\u4f5c\u8d1f\u8f7d\u88ab\u79f0\u4e3a\u79df\u6237\u3002\u591a\u79df\u6237\u96c6\u7fa4\u7684\u8fd0\u8425\u65b9\u5fc5\u987b\u5c06\u79df\u6237\u5f7c\u6b64\u9694\u79bb\uff0c\u4ee5\u6700\u5927\u9650\u5ea6\u5730\u51cf\u5c11\u88ab\u76d7\u7528\u7684\u79df\u6237\u6216\u6076\u610f\u79df\u6237\u53ef\u80fd\u5bf9\u96c6\u7fa4\u548c\u5176\u4ed6\u79df\u6237\u9020\u6210\u7684\u635f\u5bb3\u3002\u6b64\u5916\uff0c\u5fc5\u987b\u5728\u79df\u6237\u4e4b\u95f4\u516c\u5e73\u5730\u5206\u914d\u96c6\u7fa4\u8d44\u6e90\u3002</p> <p>\u5728\u89c4\u5212\u591a\u79df\u6237\u67b6\u6784\u65f6\uff0c\u60a8\u5e94\u8be5\u8003\u8651 Kubernetes \u4e2d\u7684\u8d44\u6e90\u9694\u79bb\u5c42\uff1a\u96c6\u7fa4\u3001\u547d\u540d\u7a7a\u95f4\u3001\u8282\u70b9\u3001Pod \u548c\u5bb9\u5668\u3002\u60a8\u8fd8\u5e94\u8be5\u8003\u8651\u5728\u79df\u6237\u4e4b\u95f4\u5171\u4eab\u4e0d\u540c\u7c7b\u578b\u8d44\u6e90\u7684\u5b89\u5168\u9690\u60a3\u3002\u4f8b\u5982\uff0c\u5c06\u6765\u81ea\u4e0d\u540c\u79df\u6237\u7684 Pod \u8c03\u5ea6\u5230\u540c\u4e00\u8282\u70b9\u4e0a\u53ef\u4ee5\u51cf\u5c11\u96c6\u7fa4\u4e2d\u6240\u9700\u7684\u673a\u5668\u6570\u91cf\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u963b\u6b62\u67d0\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u5171\u7f6e\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u80fd\u4e0d\u5141\u8bb8\u6765\u81ea\u7ec4\u7ec7\u5916\u90e8\u7684\u4e0d\u53d7\u4fe1\u4efb\u7684\u4ee3\u7801\u4e0e\u5904\u7406\u654f\u611f\u4fe1\u606f\u7684\u5bb9\u5668\u5728\u540c\u4e00\u8282\u70b9\u4e0a\u8fd0\u884c\u3002</p> <p>\u867d\u7136 Kubernetes \u4e0d\u80fd\u4fdd\u8bc1\u79df\u6237\u4e4b\u95f4\u5b8c\u5168\u5b89\u5168\u5730\u9694\u79bb\uff0c\u4f46\u5b83\u4e3a\u7279\u5b9a\u4f7f\u7528\u573a\u666f\u63d0\u4f9b\u4e86\u8db3\u591f\u7684\u76f8\u5173\u529f\u80fd\u3002\u60a8\u53ef\u4ee5\u5c06\u6bcf\u4e2a\u79df\u6237\u53ca\u5176 Kubernetes \u8d44\u6e90\u5206\u9694\u5230\u5404\u81ea\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u3002\u7136\u540e\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e9b\u9650\u5236\u7b56\u7565\u6765\u5f3a\u5236\u6267\u884c\u79df\u6237\u9694\u79bb\u3002\u73b0\u5728\u7b56\u7565\u901a\u5e38\u6309\u547d\u540d\u7a7a\u95f4\u5212\u5206\uff0c\u53ef\u7528\u4e8e\u9650\u5236 API \u8bbf\u95ee\u3001\u8d44\u6e90\u4f7f\u7528\u4ee5\u53ca\u5141\u8bb8\u5bb9\u5668\u6267\u884c\u7684\u64cd\u4f5c\u3002</p> <p>\u591a\u79df\u6237\u96c6\u7fa4\u7684\u79df\u6237\u5171\u4eab\u4ee5\u4e0b\u8d44\u6e90\uff1a</p> <ul> <li>\u6269\u5c55\u7a0b\u5e8f\u3001\u63a7\u5236\u5668\u3001\u63d2\u4ef6\u548c\u81ea\u5b9a\u4e49\u8d44\u6e90\u5b9a\u4e49 (CRD)\u3002</li> <li>\u96c6\u7fa4\u63a7\u5236\u5e73\u9762\u3002\u8fd9\u610f\u5473\u7740\u96c6\u7fa4\u64cd\u4f5c\u3001\u5b89\u5168\u6027\u548c\u5ba1\u6838\u662f\u96c6\u4e2d\u7ba1\u7406\u7684\u3002</li> </ul> <p>\u4e0e\u8fd0\u8425\u591a\u4e2a\u5355\u79df\u6237\u96c6\u7fa4\u76f8\u6bd4\uff0c\u8fd0\u8425\u591a\u79df\u6237\u96c6\u7fa4\u6709\u51e0\u4e2a\u4f18\u70b9\uff1a</p> <ul> <li>\u51cf\u5c11\u7ba1\u7406\u5f00\u9500</li> <li>\u51cf\u5c11\u8d44\u6e90\u788e\u7247</li> <li>\u65b0\u79df\u6237\u65e0\u9700\u7b49\u5f85\u96c6\u7fa4\u521b\u5efa</li> </ul>"},{"location":"kubernetes_tenant/tenant/#_2","title":"\u591a\u79df\u6237\u4f7f\u7528\u7528\u4f8b","text":"<p>\u672c\u90e8\u5206\u4ecb\u7ecd\u5982\u4f55\u4e3a\u5404\u79cd\u591a\u79df\u6237\u4f7f\u7528\u7528\u4f8b\u914d\u7f6e\u96c6\u7fa4\u3002</p>"},{"location":"kubernetes_tenant/tenant/#_3","title":"\u4f01\u4e1a\u591a\u79df\u6237","text":"<p>\u5728\u4f01\u4e1a\u73af\u5883\u4e2d\uff0c\u96c6\u7fa4\u7684\u79df\u6237\u662f\u7ec4\u7ec7\u5185\u7684\u4e0d\u540c\u56e2\u961f\u3002\u901a\u5e38\uff0c\u6bcf\u4e2a\u79df\u6237\u5bf9\u5e94\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u540c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u5185\u7684\u7f51\u7edc\u6d41\u91cf\u4e0d\u53d7\u9650\u5236\uff0c\u4f46\u4e0d\u540c\u547d\u540d\u7a7a\u95f4\u4e4b\u95f4\u7684\u7f51\u7edc\u6d41\u91cf\u5fc5\u987b\u660e\u786e\u5217\u5165\u767d\u540d\u5355\u3002\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u7f51\u7edc\u7b56\u7565\u6765\u5b9e\u73b0\u8fd9\u4e9b\u9694\u79bb\u3002</p> <p>\u96c6\u7fa4\u7684\u7528\u6237\u6839\u636e\u5176\u6743\u9650\u5206\u4e3a\u4e09\u79cd\u4e0d\u540c\u7684\u89d2\u8272\uff1a</p> <ul> <li>\u96c6\u7fa4\u7ba1\u7406\u5458\uff1a\u6b64\u89d2\u8272\u9002\u7528\u4e8e\u5728\u6574\u4e2a\u96c6\u7fa4\u4e2d\u7ba1\u7406\u6240\u6709\u79df\u6237\u7684\u7ba1\u7406\u5458\u3002\u96c6\u7fa4\u7ba1\u7406\u5458\u53ef\u4ee5\u521b\u5efa\u3001\u8bfb\u53d6\u3001\u66f4\u65b0\u548c\u5220\u9664\u4efb\u4f55\u7b56\u7565\u5bf9\u8c61\u3002\u4ed6\u4eec\u53ef\u4ee5\u521b\u5efa\u547d\u540d\u7a7a\u95f4\u5e76\u5c06\u5176\u5206\u914d\u7ed9\u547d\u540d\u7a7a\u95f4\u7ba1\u7406\u5458\u3002</li> <li>\u547d\u540d\u7a7a\u95f4\u7ba1\u7406\u5458\uff1a\u6b64\u89d2\u8272\u9002\u7528\u4e8e\u7279\u5b9a\u5355\u4e00\u79df\u6237\u7684\u7ba1\u7406\u5458\uff0c\u547d\u540d\u7a7a\u95f4\u7ba1\u7406\u5458\u53ef\u4ee5\u7ba1\u7406\u5176\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u7528\u6237\u3002</li> <li>\u5f00\u53d1\u8005\uff1a\u6b64\u89d2\u8272\u7684\u6210\u5458\u53ef\u4ee5\u521b\u5efa\u3001\u8bfb\u53d6\u3001\u66f4\u65b0\u548c\u5220\u9664\u547d\u540d\u7a7a\u95f4\u5185\u7684\u975e\u7b56\u7565\u5bf9\u8c61\uff0c\u5982 Pod\u3001Job \u548c Ingress\u3002\u5f00\u53d1\u8005\u53ea\u5728\u4ed6\u4eec\u6709\u6743\u8bbf\u95ee\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u62e5\u6709\u8fd9\u4e9b\u6743\u9650\u3002</li> </ul> <p></p>"},{"location":"kubernetes_tenant/tenant/#saas","title":"SaaS \u63d0\u4f9b\u5546\u591a\u79df\u6237","text":"<p>SaaS \u63d0\u4f9b\u5546\u96c6\u7fa4\u7684\u79df\u6237\u662f\u5e94\u7528\u7684\u5404\u4e2a\u5ba2\u6237\u4e13\u7528\u5b9e\u4f8b\uff0c\u4ee5\u53ca SaaS \u7684\u63a7\u5236\u5e73\u9762\u3002\u8981\u5145\u5206\u5229\u7528\u6309\u547d\u540d\u7a7a\u95f4\u5212\u5206\u7684\u653f\u7b56\uff0c\u5e94\u5c06\u5404\u4e2a\u5e94\u7528\u5b9e\u4f8b\u5b89\u6392\u5230\u5176\u5404\u81ea\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\uff0cSaaS \u63a7\u5236\u5e73\u9762\u7684\u7ec4\u4ef6\u4e5f\u5e94\u5982\u6b64\u3002\u6700\u7ec8\u7528\u6237\u65e0\u6cd5\u76f4\u63a5\u4e0e Kubernetes \u63a7\u5236\u5e73\u9762\u4ea4\u4e92\uff0c\u800c\u662f\u4f7f\u7528 SaaS \u7684\u754c\u9762\uff0c\u7531\u540e\u8005\u4e0e Kubernetes \u63a7\u5236\u5e73\u9762\u8fdb\u884c\u4ea4\u4e92\u3002</p> <p>\u4f8b\u5982\uff0c\u535a\u5ba2\u5e73\u53f0\u53ef\u4ee5\u5728\u591a\u79df\u6237\u96c6\u7fa4\u4e0a\u8fd0\u884c\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u79df\u6237\u662f\u6bcf\u4e2a\u5ba2\u6237\u7684\u535a\u5ba2\u5b9e\u4f8b\u548c\u5e73\u53f0\u81ea\u5df1\u7684\u63a7\u5236\u5e73\u9762\u3002\u5e73\u53f0\u7684\u63a7\u5236\u5e73\u9762\u548c\u6bcf\u4e2a\u6258\u7ba1\u535a\u5ba2\u90fd\u5c06\u5728\u4e0d\u540c\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c\u3002\u5ba2\u6237\u5c06\u901a\u8fc7\u5e73\u53f0\u7684\u754c\u9762\u6765\u521b\u5efa\u548c\u5220\u9664\u535a\u5ba2\u3001\u66f4\u65b0\u535a\u5ba2\u8f6f\u4ef6\u7248\u672c\uff0c\u4f46\u65e0\u6cd5\u4e86\u89e3\u96c6\u7fa4\u7684\u8fd0\u4f5c\u65b9\u5f0f\u3002</p> <p></p>"},{"location":"kubernetes_tenant/tenant/#_4","title":"\u591a\u79df\u6237\u7b56\u7565","text":"<p>\u5728 Kubernetes \u4e2d\u63d0\u4f9b\u4e86\u51e0\u9879\u53ef\u7528\u4e8e\u7ba1\u7406\u591a\u79df\u6237\u96c6\u7fa4\u7684\u529f\u80fd\u3002\u4e0b\u9762\u6211\u4eec\u6765\u5206\u522b\u4ecb\u7ecd\u4e0b\u8fd9\u4e9b\u529f\u80fd\u3002</p>"},{"location":"kubernetes_tenant/tenant/#_5","title":"\u547d\u540d\u7a7a\u95f4","text":"<p>Kubernetes \u4e2d\u7684\u591a\u79df\u6237\u90fd\u662f\u6839\u636e Namespace \u6765\u8fdb\u884c\u5212\u5206\u7684\uff0cNamespace \u662f\u4e00\u7ec4\u903b\u8f91\u7684\u96c6\u7fa4\uff0c\u53ef\u4ee5\u5927\u6982\u7c7b\u4f3c\u4e8e\u79df\u6237\u7684\u6982\u5ff5\uff0c\u53ef\u4ee5\u505a\u5230\u4e00\u5b9a\u7a0b\u5ea6\u7684\u8d44\u6e90\u9694\u79bb\u3001Quota\u3002</p> <p>\u5982\u4e0b\u9762\u7684\u4e24\u6761\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl \u2013namespace=abc run nginx \u2013image=nginx\n$ kubectl run nginx \u2013image=nginx\n</code></pre> <p>\u8fd9\u4e24\u6761\u547d\u4ee4\u867d\u7136\u90fd\u662f run \u8d77\u6765\u4e00\u4e2a nginx\uff0c\u4f46\u662f\u4f5c\u7528\u57df\u5374\u4e0d\u4e00\u6837\u3002\u7b2c\u4e00\u6761\u547d\u4ee4\u662f\u5728\u4e00\u4e2a\u53eb abc \u7684 namespace \u91cc\u8fd0\u884cnginx\uff0c\u7b2c\u4e8c\u6761\u547d\u4ee4\u5219\u662f\u5728 Default \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u3002</p>"},{"location":"kubernetes_tenant/tenant/#_6","title":"\u8bbf\u95ee\u6743\u9650\u63a7\u5236","text":"<p>\u5bf9\u4e8e\u591a\u79df\u6237\u6765\u8bf4\uff0c\u8bbf\u95ee\u6743\u9650\u63a7\u5236\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u5185\u7f6e\u7684 RBAC \u6765\u8fdb\u884c\u6743\u9650\u63a7\u5236\uff0c\u53ef\u4ee5\u4e3a\u96c6\u7fa4\u4e2d\u7684\u7279\u5b9a\u8d44\u6e90\u548c\u64cd\u4f5c\u6388\u4e88\u7ec6\u5316\u7684\u6743\u9650\u3002</p> <p>\u5bf9\u4e8e RBAC \u7684\u8be6\u7ec6\u4f7f\u7528\u53ef\u4ee5\u53c2\u8003 RBAC \u7ae0\u8282\u3002</p>"},{"location":"kubernetes_tenant/tenant/#_7","title":"\u7f51\u7edc\u7b56\u7565","text":"<p>\u901a\u8fc7\u96c6\u7fa4\u7f51\u7edc\u7b56\u7565\uff0c\u6211\u4eec\u53ef\u4ee5\u63a7\u5236\u96c6\u7fa4\u7684 Pod \u4e4b\u95f4\u7684\u901a\u4fe1\uff0c\u7b56\u7565\u53ef\u4ee5\u6307\u5b9a Pod \u53ef\u4ee5\u4e0e\u54ea\u4e9b\u547d\u540d\u7a7a\u95f4\u3001\u6807\u7b7e\u548c IP \u5730\u5740\u8303\u56f4\u8fdb\u884c\u901a\u4fe1\u3002</p> <p>\u5bf9\u4e8e\u7f51\u7edc\u7b56\u7565\u7684\u8be6\u7ec6\u4f7f\u7528\u53ef\u4ee5\u53c2\u8003 \u7f51\u7edc\u7b56\u7565 \u7ae0\u8282\u3002</p>"},{"location":"kubernetes_tenant/tenant/#_8","title":"\u8d44\u6e90\u914d\u989d","text":"<p>\u8d44\u6e90\u914d\u989d\u7528\u4e8e\u7ba1\u7406\u547d\u540d\u7a7a\u95f4\u4e2d\u5bf9\u8c61\u4f7f\u7528\u7684\u8d44\u6e90\u91cf\uff0c\u6211\u4eec\u53ef\u4ee5\u6309 CPU \u548c\u5185\u5b58\u7528\u91cf\u6216\u5bf9\u8c61\u6570\u91cf\u6765\u8bbe\u7f6e\u914d\u989d\u3002\u901a\u8fc7\u8d44\u6e90\u914d\u989d\uff0c\u53ef\u4ee5\u786e\u4fdd\u79df\u6237\u4e0d\u4f1a\u4f7f\u7528\u8d85\u8fc7\u5176\u5206\u914d\u4efd\u989d\u7684\u96c6\u7fa4\u8d44\u6e90\u3002</p> <p>\u5bf9\u4e8e\u8d44\u6e90\u914d\u989d\u7684\u4f7f\u7528\u53ef\u4ee5\u53c2\u8003 \u8d44\u6e90\u914d\u989d \u7ae0\u8282</p>"},{"location":"kubernetes_tenant/tenant/#pod","title":"Pod \u5b89\u5168\u7b56\u7565","text":"<p><code>PodSecurityPolicies</code> \u662f\u4e00\u79cd Kubernetes API \u7c7b\u578b\uff0c\u7528\u4e8e\u9a8c\u8bc1\u521b\u5efa\u548c\u66f4\u65b0 Pod \u7684\u8bf7\u6c42\u3002PodSecurityPolicies \u5b9a\u4e49 Pod \u89c4\u8303\u4e2d\u7684\u5b89\u5168\u654f\u611f\u5b57\u6bb5\u7684\u9ed8\u8ba4\u503c\u548c\u8981\u6c42\u3002\u60a8\u53ef\u4ee5\u521b\u5efa\u7b56\u7565\u6765\u9650\u5236\u90e8\u7f72\u90a3\u4e9b\u4f1a\u8bbf\u95ee\u4e3b\u673a\u6587\u4ef6\u7cfb\u7edf\u3001\u7f51\u7edc\u3001PID \u547d\u540d\u7a7a\u95f4\u3001\u5377\u7b49\u8d44\u6e90\u7684 Pod\u3002</p> <p>\u4e86\u89e3 PSP \u66f4\u591a\u4fe1\u606f\uff0c\u67e5\u770b Pod \u5b89\u5168\u7b56\u7565 \u7ae0\u8282</p>"},{"location":"kubernetes_tenant/tenant/#pod_1","title":"Pod \u53cd\u4eb2\u548c\u6027","text":"<p>\u6ce8\u610f\uff1a\u6076\u610f\u79df\u6237\u53ef\u4ee5\u89c4\u907f Pod \u53cd\u4eb2\u548c\u6027\u89c4\u5219\u3002\u4ee5\u4e0b\u793a\u4f8b\u5e94\u4ec5\u7528\u4e8e\u5177\u6709\u53d7\u4fe1\u4efb\u79df\u6237\u7684\u96c6\u7fa4\uff0c\u6216\u79df\u6237\u65e0\u6cd5\u76f4\u63a5\u8bbf\u95ee Kubernetes \u63a7\u5236\u5e73\u9762\u7684\u96c6\u7fa4\u3002 \u6211\u4eec\u53ef\u4ee5\u5229\u7528 Pod \u53cd\u4eb2\u548c\u6027\u6765\u9632\u6b62\u4e0d\u540c\u79df\u6237\u7684 Pod \u88ab\u8c03\u5ea6\u5230\u540c\u4e00\u8282\u70b9\u4e0a\u3002\u4f8b\u5982\uff0c\u4e0b\u9762\u7684 Pod \u89c4\u8303\u63cf\u8ff0\u4e86\u4e00\u4e2a\u6807\u7b7e\u4e3a <code>team: billing</code> \u7684 Pod\uff0c\u4ee5\u53ca\u963b\u6b62\u8be5 Pod \u4e0e\u6ca1\u6709\u8be5\u6807\u7b7e\u7684 Pod \u8c03\u5ea6\u5230\u4e00\u8d77\u7684\u53cd\u4eb2\u548c\u6027\u89c4\u5219\u3002</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: bar\n  labels:\n    team: \"billing\"\nspec:\n  affinity:\n    podAntiAffinity:\n      requiredDuringSchedulingIgnoredDuringExecution:  # \u786c\u7b56\u7565\n      - topologyKey: \"kubernetes.io/hostname\"\n        labelSelector:\n          matchExpressions:\n          - key: \"team\"\n            operator: NotIn\n            values: [\"billing\"]\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a\u8d44\u6e90\u6e05\u5355\u7684\u610f\u601d\u5c31\u662f <code>bar</code> \u8fd9\u4e2a Pod \u4e0d\u80fd\u8c03\u5ea6\u5230\u4e0d\u5177\u6709 <code>team: billing</code> \u8fd9\u6837\u7684\u6807\u7b7e\u7684 Pod \u6240\u5728\u7684\u8282\u70b9\uff0c\u4e0d\u8fc7\u8fd9\u79cd\u505a\u6cd5\u7684\u7f3a\u70b9\u662f\u6076\u610f\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u5c06 <code>team: billing</code> \u6807\u7b7e\u6dfb\u52a0\u5230\u4efb\u610f Pod \u6765\u89c4\u907f\u89c4\u5219\uff0c\u4ec5\u4f7f\u7528 Pod \u53cd\u4eb2\u548c\u6027\u673a\u5236\u4e0d\u8db3\u4ee5\u5728\u5177\u6709\u4e0d\u53d7\u4fe1\u4efb\u7684\u79df\u6237\u7684\u96c6\u7fa4\u4e0a\u5b89\u5168\u5730\u5f3a\u5236\u6267\u884c\u653f\u7b56\u3002</p>"},{"location":"kubernetes_tenant/tenant/#_9","title":"\u6c61\u70b9\u548c\u5bb9\u5fcd","text":"<p>\u6ce8\u610f\uff1a\u6076\u610f\u79df\u6237\u53ef\u4ee5\u89c4\u907f\u7531\u8282\u70b9\u6c61\u70b9\u548c\u5bb9\u5fcd\u673a\u5236\u5f3a\u5236\u6267\u884c\u7684\u653f\u7b56\u3002\u4ee5\u4e0b\u793a\u4f8b\u5e94\u4ec5\u7528\u4e8e\u5177\u6709\u53d7\u4fe1\u4efb\u79df\u6237\u7684\u96c6\u7fa4\uff0c\u6216\u79df\u6237\u65e0\u6cd5\u76f4\u63a5\u8bbf\u95ee Kubernetes \u63a7\u5236\u5e73\u9762\u7684\u96c6\u7fa4\u3002</p> <p>\u8282\u70b9\u6c61\u70b9\u662f\u63a7\u5236\u5de5\u4f5c\u8d1f\u8f7d\u8c03\u5ea6\u7684\u53e6\u4e00\u79cd\u65b9\u6cd5\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u8282\u70b9\u6c61\u70b9\u6765\u5c06\u4e13\u7528\u8282\u70b9\u7559\u7ed9\u67d0\u4e9b\u79df\u6237\u4f7f\u7528\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u5c06\u914d\u5907 GPU \u7684\u8282\u70b9\u4e13\u95e8\u7559\u7ed9\u90a3\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u9700\u8981 GPU \u7684\u7279\u5b9a\u79df\u6237\u3002\u8981\u5c06\u67d0\u4e2a\u8282\u70b9\u6c60\u4e13\u95e8\u7559\u7ed9\u67d0\u4e2a\u79df\u6237\uff0c\u8bf7\u5c06\u5177\u6709 <code>effect: \"NoSchedule\"</code> \u7684\u6c61\u70b9\u5e94\u7528\u4e8e\u8be5\u8282\u70b9\u6c60\uff0c\u7136\u540e\uff0c\u53ea\u6709\u5177\u5907\u76f8\u5e94\u5bb9\u5fcd\u8bbe\u7f6e\u7684 Pod \u53ef\u4ee5\u88ab\u8c03\u5ea6\u5230\u8be5\u8282\u70b9\u6c60\u4e2d\u7684\u8282\u70b9\u3002</p> <p>\u8fd9\u79cd\u505a\u6cd5\u7684\u7f3a\u70b9\u662f\u6076\u610f\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u4e3a\u5176 Pod \u6dfb\u52a0\u76f8\u5e94\u5bb9\u5fcd\u8bbe\u7f6e\u6765\u8bbf\u95ee\u4e13\u7528\u8282\u70b9\u6c60\uff0c\u6240\u4ee5\u4ec5\u4f7f\u7528\u8282\u70b9\u6c61\u70b9\u548c\u5bb9\u5fcd\u673a\u5236\u4e0d\u8db3\u4ee5\u5728\u5177\u6709\u4e0d\u53d7\u4fe1\u4efb\u7684\u79df\u6237\u7684\u96c6\u7fa4\u4e0a\u5b89\u5168\u5730\u5f3a\u5236\u6267\u884c\u653f\u7b56\u3002</p> <p>\u5982\u679c\u4e00\u4e2a\u8282\u70b9\u6807\u8bb0\u4e3a\u6c61\u70b9\uff08Taints\uff09\uff0c\u9664\u975e Pod \u4e5f\u88ab\u6807\u8bc6\u4e3a\u53ef\u4ee5\u5bb9\u5fcd\u6c61\u70b9\u8282\u70b9\uff0c\u5426\u5219\u8be5 Taints \u8282\u70b9\u4e0d\u4f1a\u88ab\u8c03\u5ea6 pod\u3002</p> <p>\u6bd4\u5982\u7528\u6237\u5e0c\u671b\u628a Master \u8282\u70b9\u4fdd\u7559\u7ed9 Kubernetes \u7cfb\u7edf\u7ec4\u4ef6\u4f7f\u7528\uff0c\u6216\u8005\u628a\u4e00\u7ec4\u5177\u6709\u7279\u6b8a\u8d44\u6e90\u9884\u7559\u7ed9\u67d0\u4e9b Pod\uff0c\u5219\u6c61\u70b9\u5c31\u5f88\u6709\u7528\u4e86\uff0cPod \u4e0d\u4f1a\u518d\u88ab\u8c03\u5ea6\u5230 taint \u6807\u8bb0\u8fc7\u7684\u8282\u70b9\u3002\u6211\u4eec\u4f7f\u7528 kubeadm \u642d\u5efa\u7684\u96c6\u7fa4\u9ed8\u8ba4\u5c31\u7ed9 master \u8282\u70b9\u6dfb\u52a0\u4e86\u4e00\u4e2a\u6c61\u70b9\u6807\u8bb0\uff0c\u6240\u4ee5\u6211\u4eec\u770b\u5230\u6211\u4eec\u7684\u666e\u901a Pod \u90fd\u6ca1\u6709\u88ab\u8c03\u5ea6\u5230 master \u4e0a\u53bb\uff1a</p> <pre><code>$ kubectl describe node master\nName:               master\nRoles:              master\nLabels:             beta.kubernetes.io/arch=amd64\n                    beta.kubernetes.io/os=linux\n                    kubernetes.io/hostname=master\n                    node-role.kubernetes.io/master=\n......\nTaints:             node-role.kubernetes.io/master:NoSchedule\nUnschedulable:      false\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684\u547d\u4ee4\u67e5\u770b master \u8282\u70b9\u7684\u4fe1\u606f\uff0c\u5176\u4e2d\u6709\u4e00\u6761\u5173\u4e8e Taints \u7684\u4fe1\u606f\uff1a</p> <pre><code>node-role.kubernetes.io/master:NoSchedule\n</code></pre> <p>\uff0c\u5c31\u8868\u793a\u7ed9 master \u8282\u70b9\u6253\u4e86\u4e00\u4e2a\u6c61\u70b9\u7684\u6807\u8bb0\uff0c\u5176\u4e2d\u5f71\u54cd\u7684\u53c2\u6570\u662f<code>NoSchedule</code>\uff0c\u8868\u793a Pod \u4e0d\u4f1a\u88ab\u8c03\u5ea6\u5230\u6807\u8bb0\u4e3a taints \u7684\u8282\u70b9\uff0c\u9664\u4e86 <code>NoSchedule</code> \u5916\uff0c\u8fd8\u6709\u53e6\u5916\u4e24\u4e2a\u9009\u9879\uff1a</p> <ul> <li><code>PreferNoSchedule</code>\uff1aNoSchedule \u7684\u8f6f\u7b56\u7565\u7248\u672c\uff0c\u8868\u793a\u5c3d\u91cf\u4e0d\u8c03\u5ea6\u5230\u6c61\u70b9\u8282\u70b9\u4e0a\u53bb</li> <li><code>NoExecute</code>\uff1a\u8be5\u9009\u9879\u610f\u5473\u7740\u4e00\u65e6 Taint \u751f\u6548\uff0c\u5982\u8be5\u8282\u70b9\u5185\u6b63\u5728\u8fd0\u884c\u7684 Pod \u6ca1\u6709\u5bf9\u5e94 Tolerate \u8bbe\u7f6e\uff0c\u4f1a\u76f4\u63a5\u88ab\u9010\u51fa</li> </ul> <p>\u6c61\u70b9 taint \u6807\u8bb0\u8282\u70b9\u7684\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl taint nodes node02 test=node02:NoSchedule\nnode \"node02\" tainted\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u540d\u5c06 node02 \u8282\u70b9\u6807\u8bb0\u4e3a\u4e86\u6c61\u70b9\uff0c\u5f71\u54cd\u7b56\u7565\u662f <code>NoSchedule</code>\uff0c\u53ea\u4f1a\u5f71\u54cd\u65b0\u7684 Pod \u8c03\u5ea6\uff0c\u5982\u679c\u4ecd\u7136\u5e0c\u671b\u67d0\u4e2a Pod \u8c03\u5ea6\u5230 taint \u8282\u70b9\u4e0a\uff0c\u5219\u5fc5\u987b\u5728 Spec \u4e2d\u505a\u51fa <code>Toleration</code> \u5b9a\u4e49\uff0c\u624d\u80fd\u8c03\u5ea6\u5230\u8be5\u8282\u70b9\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u60f3\u8981\u5c06\u4e00\u4e2a Pod \u8c03\u5ea6\u5230 master \u8282\u70b9\uff1a(taint-demo.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: taint\n  labels:\n    app: taint\nspec:\n  selector:\n    matchLabels:\n      app: taint\n  replicas: 2\n  template:\n    metadata:\n      labels:\n        app: taint\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - name: http\n          containerPort: 80\n      tolerations:\n      - key: \"node-role.kubernetes.io/master\"\n        operator: \"Exists\"\n        effect: \"NoSchedule\"\n</code></pre> <p>\u7531\u4e8e master \u8282\u70b9\u88ab\u6807\u8bb0\u4e3a\u4e86\u6c61\u70b9\u8282\u70b9\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u8981\u60f3 Pod \u80fd\u591f\u8c03\u5ea6\u5230 master \u8282\u70b9\u53bb\uff0c\u5c31\u9700\u8981\u589e\u52a0\u5bb9\u5fcd\u7684\u58f0\u660e\uff1a</p> <pre><code>tolerations:\n- key: \"node-role.kubernetes.io/master\"\n  operator: \"Exists\"\n  effect: \"NoSchedule\"\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\uff0c\u67e5\u770b\u7ed3\u679c\uff1a</p> <pre><code>$ kubectl create -f taint-demo.yaml\ndeployment.apps \"taint\" created\n$ kubectl get pods -o wide\nNAME                                      READY     STATUS             RESTARTS   AGE       IP             NODE\n......\ntaint-845d8bb4fb-57mhm                    1/1       Running            0          1m        2247   node02\ntaint-845d8bb4fb-bbvmp                    1/1       Running            0          1m        233    master\ntaint-845d8bb4fb-zb78x                    1/1       Running            0          1m        2246   node02\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a Pod \u526f\u672c\u88ab\u8c03\u5ea6\u5230\u4e86 master \u8282\u70b9\uff0c\u8fd9\u5c31\u662f\u5bb9\u5fcd\u7684\u4f7f\u7528\u65b9\u6cd5\u3002</p> <p>\u5bf9\u4e8e <code>tolerations</code> \u5c5e\u6027\u7684\u5199\u6cd5\uff0c\u5176\u4e2d\u7684 key\u3001value\u3001effect \u4e0e\u8282\u70b9\u7684 Taint \u8bbe\u7f6e\u9700\u4fdd\u6301\u4e00\u81f4\uff0c \u8fd8\u6709\u4ee5\u4e0b\u51e0\u70b9\u8bf4\u660e\uff1a</p> <ol> <li>\u5982\u679c operator \u7684\u503c\u662f <code>Exists</code>\uff0c\u5219 value \u5c5e\u6027\u53ef\u7701\u7565</li> <li>\u5982\u679c operator \u7684\u503c\u662f <code>Equal</code>\uff0c\u5219\u8868\u793a\u5176 key \u4e0e value \u4e4b\u95f4\u7684\u5173\u7cfb\u662f equal(\u7b49\u4e8e)</li> <li>\u5982\u679c\u4e0d\u6307\u5b9a operator \u5c5e\u6027\uff0c\u5219\u9ed8\u8ba4\u503c\u4e3a <code>Equal</code></li> </ol> <p>\u53e6\u5916\uff0c\u8fd8\u6709\u4e24\u4e2a\u7279\u6b8a\u503c\uff1a</p> <ol> <li>\u7a7a\u7684 key \u5982\u679c\u518d\u914d\u5408 Exists \u5c31\u80fd\u5339\u914d\u6240\u6709\u7684 key \u4e0e value\uff0c\u4e5f\u5c31\u662f\u80fd\u5bb9\u5fcd\u6240\u6709\u8282\u70b9\u7684\u6240\u6709 Taints</li> <li>\u7a7a\u7684 effect \u5339\u914d\u6240\u6709\u7684 effect</li> </ol> <p>\u6700\u540e\uff0c\u5982\u679c\u6211\u4eec\u8981\u53d6\u6d88\u8282\u70b9\u7684\u6c61\u70b9\u6807\u8bb0\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl taint nodes node02 test-\nnode \"node02\" untainted\n</code></pre>"},{"location":"kubernetes_tenant/tenant/#_10","title":"\u53c2\u8003\u8d44\u6599","text":"<p>Google Cloud Next 18 \u7684 Kubernetes \u591a\u79df\u6237\u8bb2\u5ea7</p>"}]}